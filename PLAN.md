# Пошаговый план разработки: Дневник подопечного

## Общая структура плана

План разделён на этапы от нуля до работающей версии. Сначала фронтенд, затем бэкенд интеграция.

---

## ЭТАП 1: Подготовка и настройка проекта

### Шаг 1.1: Получение дизайна и иконок
- [x] **Получен дизайн веб-сайта** ✅
  - Дизайн находится в папке `Дизайн приложения/`
  - Все основные экраны предоставлены
  - **Важно: дизайн только для мобильной версии** - десктопная будет адаптацией
- [x] **Создана папка для иконок** (`public/icons/`) ✅
- [x] **Получены иконки от пользователя** ✅
  - Иконки находятся в папке `public/icons/`
- [ ] Использовать полученные иконки в проекте (не использовать библиотеки иконок)
- [ ] **Дизайн-система:**
  - Шрифты: Fira Sans (основной), Manrope (второй)
  - Цвета: Белый (#FFFFFF), #4A4A4A, #55ACBF (и их вариации из дизайна)

### Шаг 1.2: Инициализация проекта
- [x] Создать React проект с TypeScript и Vite ✅
  ```bash
  npm create vite@latest diary-app -- --template react-ts
  ```
- [x] Настроить структуру папок проекта ✅
  ```
  diary-app/
    ├── public/
    │   ├── icons/          # Иконки для веб-сайта
    │   └── index.html      # Базовый HTML файл (точка входа)
    ├── src/
    │   ├── components/     # Переиспользуемые компоненты (.tsx файлы)
    │   │   ├── ui/         # UI компоненты (Button, Input, Modal и т.д.)
    │   │   └── layout/     # Layout компоненты (Header, Footer и т.д.)
    │   ├── pages/          # Страницы веб-сайта (.tsx файлы)
    │   ├── hooks/          # Кастомные хуки (.ts файлы)
    │   ├── lib/            # Утилиты и конфигурация (.ts файлы)
    │   │   ├── supabase.ts # Конфигурация Supabase
    │   │   └── utils.ts    # Вспомогательные функции
    │   ├── store/          # Состояние (Zustand) (.ts файлы)
    │   ├── types/          # TypeScript типы (.ts файлы)
    │   ├── styles/         # Глобальные стили
    │   │   └── index.css   # Глобальный CSS файл
    │   ├── constants/      # Константы (.ts файлы)
    │   ├── App.tsx         # Главный компонент приложения
    │   └── main.tsx        # Точка входа (рендерит App)
    ├── .env                # Переменные окружения
    ├── .env.local          # Локальные переменные окружения
    ├── vite.config.ts      # Конфигурация Vite
    ├── tsconfig.json       # Конфигурация TypeScript
    └── package.json        # Зависимости проекта
  ```
- [x] Настроить ESLint и Prettier ✅
- [x] Настроить пути импорта (@/components, @/lib и т.д.) в `tsconfig.json` и `vite.config.ts` ✅
- [x] **Важно: это веб-сайт, а не приложение** - все термины и структура должны отражать это ✅

**Структура файлов в React:**
- **HTML**: `public/index.html` - базовый HTML файл, в него встраивается React приложение
  - В этом файле есть `<div id="root"></div>` - куда монтируется всё React приложение
  - React заменяет этот div на всё приложение
- **TypeScript/JSX**: Компоненты создаются как `.tsx` файлы (TypeScript + JSX синтаксис)
  - Пример: `src/components/ui/Button.tsx` - компонент кнопки с разметкой и логикой
  - JSX позволяет писать HTML-подобный синтаксис внутри TypeScript
- **CSS**: Стили можно писать несколькими способами:
  - Глобальные стили в `src/styles/index.css` (подключаются один раз в `main.tsx`)
  - Tailwind CSS классы прямо в JSX (рекомендуется): `<div className="bg-blue-500 p-4">`
  - CSS модули для изолированных стилей компонентов (если нужны)
- **TypeScript**: Типы и утилиты в `.ts` файлах
  - Типы для данных: `src/types/diary.ts`
  - Вспомогательные функции: `src/lib/utils.ts`

**Интеграция между файлами:**
1. **main.tsx** → рендерит **App.tsx** → содержит все роуты
2. **Страницы** (`src/pages/*.tsx`) → используют **Layout компоненты** → используют **UI компоненты**
3. **UI компоненты** (`src/components/ui/*.tsx`) → импортируются в страницы и другие компоненты
4. **Хуки** (`src/hooks/*.ts`) → используются в компонентах для логики
5. **Store** (`src/store/*.ts`) → Zustand хранилища для глобального состояния
6. **Lib** (`src/lib/*.ts`) → утилиты и конфигурация (Supabase, вспомогательные функции)
7. **Все импорты через `import`**: `import { Button } from '@/components/ui'`

### Шаг 1.3: Установка основных зависимостей
- [x] Установить React Router для маршрутизации ✅
  ```bash
  npm install react-router-dom
  ```
- [x] Установить Zustand для управления состоянием ✅
  ```bash
  npm install zustand
  ```
- [x] Установить TanStack Query (React Query) для работы с серверными данными ✅
  ```bash
  npm install @tanstack/react-query
  ```
- [x] Установить React Hook Form и Zod для форм и валидации ✅
  ```bash
  npm install react-hook-form zod @hookform/resolvers
  ```
- [x] Установить Tailwind CSS или другое решение для стилей (согласно дизайну) ✅
  ```bash
  npm install -D tailwindcss postcss autoprefixer
  npx tailwindcss init -p
  ```
- [x] Установить дата-утилиты (date-fns или dayjs) ✅
  ```bash
  npm install date-fns
  # или
  npm install dayjs
  ```
- [ ] Установить иконки (react-icons или другая библиотека, если нужны) - используем иконки из public/icons/
- [x] Настроить Tailwind CSS в `tailwind.config.js` ✅
- [x] Подключить Tailwind CSS в `src/styles/index.css` ✅
  ```css
  @tailwind base;
  @tailwind components;
  @tailwind utilities;
  ```
- [x] Проверить что все зависимости установлены корректно ✅

### Шаг 1.4: Настройка Supabase клиента
- [ ] Создать проект в Supabase (или получить данные существующего)
- [x] Установить @supabase/supabase-js ✅
  ```bash
  npm install @supabase/supabase-js
  ```
- [x] Создать файл конфигурации Supabase клиента: `src/lib/supabase.ts` ✅
  ```typescript
  import { createClient } from '@supabase/supabase-js'
  
  const supabaseUrl = import.meta.env.VITE_SUPABASE_URL
  const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY
  
  export const supabase = createClient(supabaseUrl, supabaseAnonKey)
  ```
- [ ] Создать файл `.env.local` с переменными окружения:
  ```
  VITE_SUPABASE_URL=your_supabase_url
  VITE_SUPABASE_ANON_KEY=your_supabase_anon_key
  ```
- [x] Добавить `.env.local` в `.gitignore` (чтобы не коммитить секреты) ✅
- [x] Создать папку `src/types/` и файл `src/types/supabase.ts` для типов (пока заглушки) ✅
- [ ] Проверить что Supabase клиент инициализируется корректно

---

## ЭТАП 2: Базовые компоненты и Layout

**Важно:** UI компоненты создаются **по мере необходимости**, а не все сразу. Каждый компонент создается в том этапе, где он впервые используется.

### Шаг 2.1: Создание Layout компонентов
- [x] Создать папку `src/components/layout/` для layout компонентов ✅
- [x] Создать компонент Header: `src/components/layout/Header.tsx` ✅
  - JSX разметка шапки сайта
  - Навигационные элементы
  - Интеграция с React Router для навигации
- [ ] Создать компонент Sidebar: `src/components/layout/Sidebar.tsx` (если есть в дизайне)
  - Боковое меню
  - Навигационные ссылки
  - Адаптивность (скрытие на мобильных)
- [ ] Создать компонент Footer: `src/components/layout/Footer.tsx` (если нужен)
  - Подвал сайта
  - Контактная информация или ссылки
- [x] Создать компонент MainLayout: `src/components/layout/MainLayout.tsx` ✅
  - Обертка для основных страниц
  - Включает Header, Sidebar (если есть), Footer (если есть)
  - Использует React Router `<Outlet />` для отображения дочерних страниц
  ```typescript
  export const MainLayout = () => {
    return (
      <div>
        <Header />
        <main>
          <Outlet />
        </main>
        <Footer />
      </div>
    )
  }
  ```
- [x] Создать компонент AuthLayout: `src/components/layout/AuthLayout.tsx` ✅
  - Layout для страниц авторизации/регистрации
  - Без Header/Footer (или минимальный вариант)
  - Центрирование контента
- [x] Создать файл `src/components/layout/index.ts` для экспорта ✅
- [ ] **Протестировать все layout компоненты** - проверить что они правильно оборачивают контент

### Шаг 2.3: Настройка темизации и глобальных стилей
- [x] Настроить цветовую палитру в `tailwind.config.js` (согласно дизайну) ✅
  ```javascript
  theme: {
    extend: {
      colors: {
        white: '#FFFFFF',
        gray: {
          dark: '#4A4A4A',
          // Дополнительные оттенки из дизайна
        },
        blue: {
          primary: '#55ACBF',
          // Дополнительные оттенки из дизайна
        },
        // Дополнительные цвета из дизайна
      }
    }
  }
  ```
- [x] Настроить типографику в `tailwind.config.js` ✅
  - Основной шрифт: Fira Sans
  - Второй шрифт: Manrope
  - Размеры шрифтов (font-size) - согласно дизайну
  - Высоты строк (line-height) - согласно дизайну
- [x] Подключить шрифты (Google Fonts или локальные файлы) ✅
  - Fira Sans
  - Manrope
- [x] Настроить breakpoints для адаптивности в `tailwind.config.js` ✅
  ```javascript
  screens: {
    'sm': '640px',
    'md': '768px',
    'lg': '1024px',
    'xl': '1280px',
  }
  ```
- [x] Настроить глобальные стили в `src/styles/index.css` ✅
  - Сброс стилей (reset)
  - Глобальные стили для body, html
  - Кастомные CSS переменные (если нужны)
- [x] Подключить глобальные стили в `src/main.tsx` ✅
  ```typescript
  import './styles/index.css'
  ```
- [ ] **Mobile-first подход** - сначала верстать под мобильные устройства согласно дизайну
- [ ] Адаптировать для десктопных разрешений (дизайна нет, только адаптация)
- [ ] Создать темы для темного/светлого режима (если есть в дизайне):
  - Настроить dark mode в `tailwind.config.js`
  - Использовать `dark:` префиксы для стилей темной темы
- [ ] **Протестировать все компоненты** на мобильных устройствах и убедиться что соответствуют дизайну
- [ ] Проверить что все стили применяются корректно

---

## ЭТАП 3: Система аутентификации (Frontend)

### Шаг 3.1: Страница регистрации по пригласительной ссылке
- [x] **Создать UI компоненты по мере необходимости:** ✅
  - `Button` - для кнопки отправки формы
  - `Input` - для полей ввода (email, password)
  - Создать папку `src/components/ui/` и файл `src/components/ui/index.ts` для экспорта
- [x] Создать страницу: `src/pages/RegisterPage.tsx` ✅
- [x] Настроить роут в `src/App.tsx` ✅
  ```typescript
  <Route path="/register" element={<RegisterPage />} />
  ```
- [x] Реализовать получение токена из URL параметров ✅
  ```typescript
  const [searchParams] = useSearchParams()
  const token = searchParams.get('token')
  ```
- [x] Реализовать валидацию токена приглашения (запрос к Supabase) ✅
- [x] Создать форму выбора типа организации (Пансионат/Патронажное агентство/Сиделка) ✅
  - Использовать React Hook Form
  - Радио-кнопки или карточки для выбора
- [x] Создать форму регистрации (email, password, подтверждение пароля) ✅
  - Использовать компонент Input из UI Kit
  - Использовать компонент Button для отправки
  - Использовать React Hook Form для управления формой
- [x] Реализовать валидацию формы (Zod) ✅
  - Создать Zod схему для валидации
  - Подключить через @hookform/resolvers
- [x] Реализовать регистрацию через Supabase Auth ✅
  ```typescript
  const { data, error } = await supabase.auth.signUp({
    email,
    password,
  })
  ```
- [x] Реализовать обработку ошибок и показ понятных сообщений ✅ - используются текстовые сообщения об ошибках
- [x] Реализовать редирект после успешной регистрации ✅
  ```typescript
  navigate('/profile/setup')
  ```
- [ ] **Протестировать страницу регистрации** - проверить валидацию, регистрацию, обработку ошибок (после настройки Supabase)

### Шаг 3.2: Страница входа
- [x] Создать страницу: `src/pages/LoginPage.tsx` ✅
- [x] Настроить роут в `src/App.tsx` ✅
  ```typescript
  <Route path="/login" element={<LoginPage />} />
  ```
- [x] Создать форму входа (email, password) ✅
  - Использовать компоненты Input и Button (уже созданные)
  - Использовать React Hook Form для управления формой
- [x] **Обновлена форма входа:** ✅
  - Поддержка входа по email (для организаций и сиделок)
  - Поддержка входа по телефону (для сотрудников)
  - Определение типа входа автоматически (email или телефон)
- [x] Реализована валидация формы (Zod) ✅
- [x] **Обновлен вход через Supabase Auth:** ✅
  - Для email: `signInWithPassword({ email, password })`
  - Для телефона: `signInWithPassword({ email: employee_xxx@temp.local, password })` (временное решение)
- [ ] Реализовать "Забыли пароль?" (если нужно) - TODO позже
- [x] Реализовать обработку ошибок и показ понятных сообщений ✅
- [x] Реализовать редирект после успешного входа ✅
  ```typescript
  navigate('/dashboard')
  ```
- [ ] **Протестировать страницу входа** - проверить валидацию, вход, обработку ошибок (после настройки Supabase)

### Шаг 3.3: Система управления сессией
- [x] Создать хук: `src/hooks/useAuth.ts` ✅
  - Функции: login, logout, register, checkSession
  - Возвращает: user, loading, error, и функции для работы с авторизацией
- [x] Реализовать проверку текущей сессии ✅
  ```typescript
  const { data: { session } } = await supabase.auth.getSession()
  ```
- [x] Реализовать автоматический редирект неавторизованных пользователей ✅
- [x] Создать компонент: `src/components/ProtectedRoute.tsx` ✅
  - Проверяет авторизацию пользователя
  - Если не авторизован - редирект на /login
  - Если авторизован - отображает дочерний компонент
- [x] Реализовать выход из системы (logout) ✅
  ```typescript
  await supabase.auth.signOut()
  ```
- [ ] **Протестировать систему управления сессией** - проверить проверку сессии, редиректы, logout (после настройки Supabase)

### Шаг 3.4: Контекст авторизации
- [x] Создать Zustand store: `src/store/authStore.ts` ✅
  - Состояние: user, isAuthenticated, loading
  - Actions: setUser, logout, checkAuth
- [ ] Создать AuthProvider: `src/components/AuthProvider.tsx` (опционально, если нужен Context API) - используем Zustand
- [x] Реализовать хранение состояния пользователя в Zustand store ✅
- [x] Реализовать автоматическое обновление сессии ✅
  ```typescript
  supabase.auth.onAuthStateChange((event, session) => {
    // Обновление состояния при изменении авторизации
  })
  ```
- [ ] Подключить AuthProvider в `src/App.tsx` (если используется) - не требуется, используем хуки
- [ ] **Протестировать контекст авторизации** - проверить что состояние обновляется корректно (после настройки Supabase)

### Шаг 3.5: Настройка главного файла приложения и маршрутизации
- [x] Настроить `src/main.tsx` (точка входа) ✅
  ```typescript
  import React from 'react'
  import ReactDOM from 'react-dom/client'
  import { BrowserRouter } from 'react-router-dom'
  import { QueryClient, QueryClientProvider } from '@tanstack/react-query'
  import App from './App'
  import './styles/index.css'

  const queryClient = new QueryClient()

  ReactDOM.createRoot(document.getElementById('root')!).render(
    <React.StrictMode>
      <BrowserRouter>
        <QueryClientProvider client={queryClient}>
          <App />
        </QueryClientProvider>
      </BrowserRouter>
    </React.StrictMode>
  )
  ```
- [x] Настроить `src/App.tsx` (главный компонент с маршрутизацией) ✅
  ```typescript
  import { Routes, Route } from 'react-router-dom'
  import { MainLayout } from '@/components/layout'
  import { AuthLayout } from '@/components/layout'
  // Импорт всех страниц

  function App() {
    return (
      <Routes>
        <Route element={<AuthLayout />}>
          <Route path="/login" element={<LoginPage />} />
          <Route path="/register" element={<RegisterPage />} />
        </Route>
        <Route element={<MainLayout />}>
          <Route path="/dashboard" element={<DashboardPage />} />
          {/* И другие защищенные роуты */}
        </Route>
      </Routes>
    )
  }

  export default App
  ```
- [x] Настроить `public/index.html` (базовый HTML) ✅
  - Проверить наличие `<div id="root"></div>` - куда монтируется React
  - Добавить мета-теги для мобильной адаптивности
- [ ] **Протестировать маршрутизацию** - проверить что все роуты работают корректно

---

## ЭТАП 4: Личный кабинет и профиль

### Шаг 4.1: Страница заполнения профиля
- [x] Создать страницу: `src/pages/ProfileSetupPage.tsx` ✅
- [x] Настроить роут в `src/App.tsx` ✅
  ```typescript
  <Route path="/profile/setup" element={<ProfileSetupPage />} />
  ```
- [x] Реализовать определение типа пользователя (из user_roles или metadata) ✅
- [x] **Реализована форма для частной сиделки:** ✅
  - Имя, фамилия (используя Input)
  - Телефон (обязательное поле с подписью про WhatsApp, используя Input)
  - Город (обязательно, используя Input)
- [x] Реализовать форму для организации: ✅
  - Название организации (используя Input)
  - Телефон (обязательное поле с подписью про WhatsApp, используя Input)
  - Адрес (обязательно поле - место нахождения организации, используя Input)
- [x] **Обновлена форма для сотрудников:** ✅
  - Имя (обязательно)
  - Фамилия (обязательно)
  - Телефон уже известен из регистрации, не запрашиваем
- [x] Реализовать валидацию форм (Zod): ✅
  - Схема для частной сиделки
  - Схема для организации
  - Схема для сотрудника
- [x] Реализовать сохранение профиля в БД (таблица organizations): ✅
  ```typescript
  const { error } = await supabase
    .from('organizations')
    .insert({ user_id, type, name, phone, ... })
  ```
- [x] Реализовать сохранение профиля сотрудника в БД (таблица organization_employees): ✅
  ```typescript
  const { error } = await supabase
    .from('organization_employees')
    .insert({ user_id, organization_id, first_name, last_name })
  ```
- [x] Реализовать редирект после заполнения профиля: ✅
  ```typescript
  navigate('/dashboard')
  ```
- [ ] **Протестировать заполнение профиля** - проверить валидацию, сохранение, редирект (после создания таблицы organizations в Supabase)

### Шаг 4.2: Страница настроек профиля (Profile Settings)
- [x] Создать страницу: `src/pages/ProfilePage.tsx` (страница настроек с кнопками действий) ✅
- [x] Настроить роут в `src/App.tsx` ✅
  ```typescript
  <Route path="/profile" element={<ProfilePage />} />
  ```
- [x] Реализовать отображение информации о профиле (имя организации/сиделки, тип) ✅
- [x] Реализовать кнопку "Редактировать профиль" (переход на `/profile/edit`) ✅
- [x] Реализовать кнопку "Мои дневники" (переход на `/dashboard`) ✅
- [x] Для организаций (пансионат/патронажное агентство): ✅
  - Реализовать кнопку "Сотрудники" (переход на `/profile/employees`)
  - На странице `/profile/employees` будет возможность добавить, посмотреть и удалить сотрудников
  - [ ] Добавить кнопку "Клиенты" (переход на `/profile/clients`) - отображение списка клиентов организации
- [x] Для частных сиделок: ✅
  - Скрыть кнопку "Сотрудники"
  - [ ] Добавить кнопку "Пригласить клиента" (в секции "Управление профилем")
- [ ] Для сотрудников организаций: ✅
  - Реализовать загрузку данных сотрудника из таблицы `organization_employees`
  - Отобразить информацию о профиле (имя, фамилия, телефон если есть)
  - Реализовать кнопку "Редактировать профиль" (переход на `/profile/edit`)
  - Реализовать кнопку "Мои дневники" (переход на `/dashboard`)
  - Скрыть кнопку "Сотрудники" (только для организаций)
  - Сотрудники должны иметь доступ к тем же данным и настройкам, что и организации, но без управления сотрудниками
- [x] Ссылки для клиентов находятся в дневнике, не нужны в профиле ✅
- [x] **Адаптировать под дизайн из Профиль.png** - проверить структуру и стили ✅
- [ ] **Протестировать страницу настроек** - проверить навигацию, отображение кнопок в зависимости от типа пользователя

### Шаг 4.2.1: Страница редактирования профиля
- [x] Создать страницу: `src/pages/ProfileEditPage.tsx` (переименовать из ProfilePage) ✅
- [x] Настроить роут в `src/App.tsx` ✅
  ```typescript
  <Route path="/profile/edit" element={<ProfileEditPage />} />
  ```
- [x] Реализовать загрузку данных профиля из БД (таблица organizations) или metadata ✅
- [x] Реализовать отображение текущих данных профиля ✅
- [x] Реализовать форму редактирования (используя React Hook Form) ✅
- [x] Реализовать валидацию формы (Zod) ✅
- [x] Реализовать сохранение изменений для организаций и сиделок (БД или metadata): ✅
  ```typescript
  const { error } = await supabase
    .from('organizations')
    .update({ ... })
    .eq('user_id', userId)
  ```
- [ ] Реализовать загрузку данных профиля сотрудника из таблицы `organization_employees` ✅
- [ ] Реализовать форму редактирования для сотрудника (имя, фамилия, телефон):
  - Имя (обязательно)
  - Фамилия (обязательно)
  - Телефон (опционально)
- [ ] Реализовать сохранение изменений профиля сотрудника:
  ```typescript
  const { error } = await supabase
    .from('organization_employees')
    .update({ first_name, last_name, phone })
    .eq('user_id', userId)
  ```
- [x] Реализовать показ успешного сообщения после сохранения ✅
- [x] Реализовать редирект на `/profile` после сохранения ✅
- [ ] **Протестировать редактирование профиля** - проверить загрузку, редактирование, сохранение для всех типов пользователей (после создания таблиц в БД)

### Шаг 4.3: Dashboard (главная страница личного кабинета)
- [x] **Создать UI компоненты если нужно:** ✅
  - [x] `Card` - для карточек дневников ✅
- [x] Создать страницу: `src/pages/DashboardPage.tsx` ✅
- [x] Настроить роут в `src/App.tsx` ✅
  ```typescript
  <Route path="/dashboard" element={<DashboardPage />} />
  ```
- [x] Реализовать загрузку списка дневников из БД (таблица diaries) ✅
  - Использовать React Query для кэширования и управления состоянием
  - Пока работает с mock данными (готово для подключения БД)
- [x] Реализовать отображение списка дневников подопечных ✅
  - Использовать компонент Card для карточек дневников
- [x] Реализовать кнопку "Создать новый дневник" ✅
  - Использовать компонент Button (уже создан)
  - При клике - навигация на `/diaries/new` (НО: только если есть карточка подопечного)
- [x] Реализовать карточки дневников с основной информацией: ✅
  - ФИО подопечного
  - Дата создания
  - Количество записей (опционально)
- [x] Реализовать поиск дневников (используя Input) ✅
- [ ] Реализовать фильтрацию дневников (используя Select или Filter если создан) - TODO позже
- [x] Реализовать пустое состояние (если нет дневников) ✅
- [ ] **Протестировать Dashboard** - проверить загрузку, отображение, поиск (после создания таблицы diaries)

### Шаг 4.4: Управление сотрудниками (для организаций)
- [x] Создать UI компоненты: `Modal` ✅
- [x] Создать страницу: `src/pages/EmployeesPage.tsx` ✅
- [x] Настроить роут в `src/App.tsx` ✅
  ```typescript
  <Route path="/profile/employees" element={<EmployeesPage />} />
  ```
- [x] Реализовать проверку типа пользователя (только для организаций) ✅
- [x] Реализовать отображение списка сотрудников (таблица organization_employees) ✅
- [x] Реализовать кнопку "Добавить сотрудника" (создание пригласительной ссылки) ✅
- [x] Реализовать модальное окно выбора роли сотрудника ✅
  - Администратор
  - Руководитель
  - Сиделка
  - Врач (только для пансионатов)
- [x] Реализовать создание пригласительной ссылки с ролью (таблица organization_invite_tokens) ✅
- [x] Реализовать отображение роли в списке ссылок и сотрудников ✅
- [x] Реализовать копирование ссылки в буфер обмена ✅
- [x] Реализовать отображение статуса ссылки (активна/использована) ✅
- [x] Реализовать возможность удаления сотрудника ✅
- [x] Реализовать возможность удаления пригласительной ссылки ✅
- [x] Для патронажных агентств зафиксировано правило: сотрудники получают доступ к дневникам только после явного назначения в разделе «Управление доступом» (в отличие от пансионатов, где доступ предоставляется всем автоматически)
- [ ] **Протестировать управление сотрудниками** - проверить создание ссылок, добавление, удаление (после создания таблиц в БД)

### Шаг 4.5: Регистрация сотрудников по пригласительной ссылке
- [x] Обновить `RegisterPage.tsx` для обработки `org_token` (токен приглашения сотрудника) ✅
- [x] Реализовать проверку `org_token` в URL параметрах ✅
- [x] Реализовать валидацию токена организации (запрос к таблице `organization_invite_tokens`) ✅
- [x] **Реализовать регистрацию сотрудников (временное решение):** ✅
  - Регистрация через временный email (employee_xxx@temp.local)
  - Телефон сохраняется в user_metadata
  - Без запроса кода подтверждения
  - Пароль придумывают сами
  - Для сотрудников пансионатов и патронажных агентств
- [x] Реализована форма регистрации сотрудника по телефону (без выбора типа организации): ✅
  - Поле: номер телефона (обязательно)
  - Поле: пароль (обязательно)
  - Поле: подтверждение пароля (обязательно)
- [x] Реализована регистрация сотрудника (временное решение через email): ✅
  ```typescript
  const { data, error } = await supabase.auth.signUp({
    email: `employee_${phone}@temp.local`,
    password,
    options: {
      data: {
        organization_invite_token: orgToken,
        user_role: 'org_employee',
        phone: formattedPhone,
      }
    }
  })
  ```
- [x] После регистрации автоматически привязать сотрудника к организации: ✅
  - Отметить токен как использованный (`used_at`, `used_by`)
  - Сохранить в `user_metadata` информацию об организации и телефон
- [x] Обновлена страница регистрации: без токена доступна стандартная регистрация организаций/сиделок, при `org_token` открывается сценарий сотрудника с вводом телефона и пароля, токен помечается использованным
- [x] Реализован редирект на страницу заполнения профиля сотрудника: ✅

### Шаг 4.6: Поддержка профиля сотрудников в ProfilePage и ProfileEditPage
- [x] Обновлен `ProfilePage.tsx` для поддержки сотрудников: ✅
  - Определение типа пользователя (организация/сиделка/сотрудник) из `user_metadata`
  - Для сотрудников: загрузка данных из таблицы `organization_employees` по `user_id`
  - Отображение информации о сотруднике (имя, фамилия, телефон если есть)
  - Показана кнопка "Редактировать профиль"
  - Показана кнопка "Мои дневники"
  - Скрыта кнопка "Сотрудники" (только для организаций)
  - Сотрудники имеют те же данные и настройки, что и организации, но без управления сотрудниками
- [x] Обновлен `ProfileEditPage.tsx` для поддержки сотрудников: ✅
  - Определение типа пользователя
  - Для сотрудников: загрузка данных из `organization_employees`
  - Форма редактирования (имя, фамилия) - телефон не редактируется, он из регистрации
  - Сохранение изменений в `organization_employees`
- [ ] **Протестировать профиль сотрудника** - проверить отображение и редактирование (после настройки бэкенда)

### Шаг 4.7: Управление клиентами (для сиделок и организаций)
- [x] **Для частных сиделок:** ✅
  - [x] Добавить кнопку "Пригласить клиента" в `ProfilePage.tsx` (в секции "Управление профилем") ✅
  - [x] Реализовать страницу для создания пригласительной ссылки (`InviteClientPage.tsx`) ✅
  - [x] Реализовать создание пригласительной ссылки (временное решение через localStorage, таблица `caregiver_client_invite_tokens` - после создания БД) ✅
  - [x] Реализовать копирование ссылки в буфер обмена ✅
  - [x] Реализовать кнопку "Поделиться в WhatsApp" ✅
  - [ ] Реализовать отображение статуса ссылки (активна/использована) - после создания таблиц в БД
  - [x] **НЕ отображать список клиентов** - только создание пригласительных ссылок ✅
- [x] **Для организаций:** ✅
  - [x] Создать страницу: `src/pages/ClientsPage.tsx` (список клиентов) ✅
  - [x] Настроить роут в `src/App.tsx` ✅
  - [x] Добавить кнопку "Клиенты" в `ProfilePage.tsx` (в секции "Управление профилем") ✅
  - [x] Реализовать отображение списка клиентов организации (временное решение, таблица clients - после создания БД) ✅
  - [ ] **Приглашение клиента происходит после создания карточки подопечного и дневника динамики** (будет реализовано в Шаге 4.9 и 5.1)
    - **ВАЖНО:** Сейчас для организаций еще нельзя пригласить клиента, так как еще не реализовано создание карточки и дневника
  - [ ] Добавить кнопку "Пригласить клиента" в форму/страницу создания карточки подопечного (опционально) - будет в Шаге 4.9
  - [ ] Добавить кнопку "Пригласить клиента" в настройках карточки подопечного/дневника - будет в Шаге 4.9 и 5.2
  - [ ] Реализовать создание пригласительной ссылки, привязанной к карточке/дневнику (таблица `organization_client_invite_tokens` с `patient_card_id` и `diary_id`) - будет в Шаге 4.9 и 5.1
  - [ ] Реализовать копирование ссылки в буфер обмена - будет в Шаге 4.9
  - [ ] Реализовать отображение статуса ссылки (активна/использована) - будет в Шаге 4.9
  - [ ] Реализовать возможность удаления клиента (опционально) - после создания таблиц в БД
  - [ ] **ВАЖНО:** После создания дневника ссылка на приглашение клиента всегда должна быть доступна в дневнике (вкладка "Доступ для клиента") - будет в Шаге 5.2
- [ ] **Протестировать управление клиентами** - проверить создание ссылок, добавление, удаление (после создания таблиц в БД)

### Шаг 4.8: Регистрация клиентов по пригласительной ссылке
- [x] Обновить `RegisterPage.tsx` для обработки `client_token` (токен приглашения клиента) ✅
- [x] Реализовать проверку `client_token` в URL параметрах ✅
- [x] Реализовать валидацию токена клиента (временное решение через localStorage, таблицы `caregiver_client_invite_tokens` и `organization_client_invite_tokens` - после создания БД) ✅
- [x] Реализовать регистрацию клиента (временное решение): ✅
  - Регистрация через временный email (client_xxx@temp.local)
  - Телефон сохраняется в user_metadata
  - Без запроса кода подтверждения
  - Пароль придумывают сами
- [x] Реализована форма регистрации клиента по телефону (без выбора типа организации): ✅
  - Поле: номер телефона (обязательно)
  - Поле: пароль (обязательно)
  - Поле: подтверждение пароля (обязательно)
- [x] После регистрации автоматически привязать клиента к сиделке/организации: ✅
  - Отметить токен как использованный (`used_at`, `used_by`)
  - Сохранить в `user_metadata` информацию о сиделке/организации и телефон
  - **Для организаций:** автоматически привязать к существующей карточке подопечного и дневнику (если `patient_card_id` и `diary_id` в токене)
- [x] Реализован редирект на страницу заполнения профиля клиента ✅
- [x] Обновлен `ProfileSetupPage.tsx` для клиентов ✅
- [x] **Реализована форма для клиента (имя и фамилия):** ✅
  - Имя (обязательно)
  - Фамилия (обязательно)
  - Телефон уже известен из регистрации, не запрашиваем
- [x] Реализована валидация формы (Zod) ✅
- [x] Реализовано сохранение профиля клиента (временное решение через localStorage, таблица `clients` - после создания БД) ✅
- [x] Реализован редирект после заполнения профиля на `/profile` (личный кабинет клиента) ✅
- [x] Обновлен `ProfilePage.tsx` для поддержки клиентов ✅
  - Загрузка данных клиента из localStorage
  - Отображение профиля клиента
  - Доступные кнопки для клиентов: **только "Мои дневники" и "Карточки подопечных"**
  - Недоступны для клиентов: "Сотрудники", "Клиенты", "Пригласить клиента"
- [ ] **Протестировать регистрацию клиента** - проверить весь флоу от перехода по ссылке до доступа к личному кабинету и карточкам (после создания таблиц в БД)

### Шаг 4.9: Управление карточками подопечных
- [x] Создать страницу: `src/pages/PatientCardsPage.tsx` ✅
- [x] Настроить роут в `src/App.tsx` ✅
  ```typescript
  <Route path="/profile/patient-cards" element={<PatientCardsPage />} />
  ```
- [x] Реализовать отображение списка карточек подопечных (временное решение через localStorage, таблица patient_cards - после создания БД) ✅
- [x] Реализовать кнопку "Создать карточку подопечного" (для тех, кто может создавать) ✅
- [x] Реализовать проверку прав доступа: ✅
  - **Клиенты**: могут создавать и редактировать свои карточки ✅
  - **Организации**: администратор/врач/руководитель могут создавать и редактировать карточки ✅
  - **Частные сиделки**: НЕ могут создавать карточки, могут только просматривать карточки своих клиентов (где `caregiver_id` совпадает) ✅
    - Если нет карточек - показывается подсказка с кнопкой "Пригласить клиента" ✅
  - **Сотрудники организаций (сиделки)**: НЕ могут создавать карточки, могут только просматривать карточки организации (без возможности редактировать/удалять) ✅
    - Если нет карточек - показывается сообщение "Нет карточек подопечных" ✅
- [x] Реализовать форму создания/редактирования карточки подопечного: ✅
  - Личные данные: ФИО (обязательно), Дата рождения (опционально), Рост (опционально), Вес (опционально), Пол (обязательно) ✅
  - Диагнозы: выбор из списка + возможность добавить свой ✅
  - Мобильность: выбор одного варианта (ходит, сидит, лежит) ✅
- [x] Реализовать валидацию формы (Zod) ✅
- [x] Реализовать сохранение карточки (временное решение через localStorage, таблица patient_cards - после создания БД) ✅
- [x] Реализовать возможность редактирования карточки ✅
- [x] Реализовать возможность удаления карточки ✅
- [x] Создать UI компоненты: Select и Checkbox ✅
- [ ] **Протестировать управление карточками** - проверить создание, редактирование, удаление (после создания таблицы patient_cards)

---

## ЭТАП 5: Управление дневниками подопечных

### Шаг 5.1: Создание дневника
- [x] **Создать UI компоненты если нужно:** ✅
  - `Checkbox` - для выбора диагнозов и показателей ✅
  - `Select` - для выбора карточки подопечного и показателей ✅
- [x] Создать страницу: `src/pages/CreateDiaryPage.tsx` ✅
- [x] Настроить роут в `src/App.tsx` ✅
- [x] Реализовать проверку прав доступа: ✅
  - **Частные сиделки**: НЕ могут создавать дневники (создают клиенты) ✅
  - **Клиенты частных сиделок**: могут создавать дневники (после создания карточки подопечного), они владельцы ✅
  - **Организации**: администратор/врач/руководитель могут создавать дневники от имени клиента (но владелец - клиент) ✅
  - **Сотрудники организаций (сиделки)**: НЕ могут создавать дневники ✅
  - **Клиенты организаций**: могут создавать дневники (после создания карточки подопечного), они владельцы ✅
- [x] Реализовать форму создания дневника (Step 1 → Step 2) ✅
- [x] **Шаг 1: Выбор карточки подопечного** ✅
  - Отображение списка доступных карточек подопечных ✅
  - Для клиентов: только их карточки (они владельцы) ✅
  - Для организаций: карточки клиентов организации (но владелец - клиент) ✅
  - **ВАЖНО: Карточки, для которых уже создан дневник, НЕ отображаются в списке** (у одного подопечного только один дневник может быть) ✅
  - Кнопка "Создать новую карточку" (переход на `/profile/patient-cards/new`) ✅
  - Валидация: карточка обязательна ✅
  - Плавный переход между шагами с анимацией ✅
- [x] **Шаг 2: Выбор медицинских показателей** ✅
  - Отображение разделенных секций "Закрепленные показатели" и "Все показатели" ✅
  - Модальные окна для выбора показателей ✅
  - Поле для добавления пользовательского показателя (используя Input + Button) ✅
  - Валидация: минимум один показатель должен быть выбран ✅
  - Брендовые цвета для выбранных показателей (градиент #7DD3DC → #5CBCC7) ✅
- [x] Реализовать сохранение дневника (временное решение через localStorage, таблица diaries - после создания БД) ✅
- [x] Реализовать сохранение выбранных показателей (временное решение через localStorage, таблица diary_metrics - после создания БД) ✅
  - Сохранение закрепленных показателей (с флагом `is_pinned: true`) ✅
  - Сохранение всех показателей ✅
- [x] Реализовать редирект после создания: `navigate('/dashboard')` (временно, до создания страницы просмотра дневника) ✅
- [ ] **Протестировать создание дневника** - проверить что все поля сохраняются корректно, валидация работает, права доступа соблюдаются

### Шаг 5.2: Страница просмотра дневника
- [x] Создать страницу: `src/pages/DiaryPage.tsx` ✅
- [x] Настроить роут в `src/App.tsx` ✅
- [x] Реализовать получение ID дневника из URL параметров ✅
- [x] Реализовать загрузку данных дневника и карточки подопечного ✅
- [x] Реализовать отображение информации о подопечном (из карточки) ✅
- [x] **ВАЖНАЯ ЛОГИКА:** Отображаются только те показатели, которые были выбраны при создании дневника ✅
  - Если не выбраны закрепленные показатели - блок "Закрепленные показатели" не отображается
  - Если в разделе (Показатели ухода/Физические/Тягостные симптомы) нет выбранных показателей - раздел не отображается
  - Внутри каждого раздела отображаются только выбранные пользователем метрики
  - Стрелки раскрытия: изначально смотрят вниз, при открытии поворачиваются вверх (rotate-180)
- [x] **Создать UI компоненты если нужно:** ✅
  - `Tabs` - для вкладок (История/Дневник/Доступ для клиента)
  - [x] `Modal` - для модальных окон ✅ (создан в Шаге 4.4)
- [x] Реализовать кнопку "Изменить показатели" с переходом на отдельную страницу ✅
- [x] Реализовать страницу редактирования показателей (`/diaries/:id/edit-metrics`) ✅
  - Загрузка текущих показателей дневника
  - Возможность изменения закрепленных показателей (до 3-х)
  - Возможность изменения всех показателей
  - Добавление пользовательских показателей
  - Сохранение изменений в localStorage
  - Визуальное оформление как при создании дневника (2 карточки)
- [x] Реализовать управление доступом специалистов (раскрывающийся блок) ✅
  - Для организаций: отображение списка сотрудников/сиделок с доступом и возможность отозвать
  - Для клиентов: отображение сиделки или организации с возможностью отозвать доступ
  - Компактное визуальное оформление (уменьшенные размеры)
- [x] Реализовать заполнение **обычных показателей** через модальное окно по дизайну ✅
  - Открытие по клику на показатель (с учётом прав доступа)
  - Описание показателя внутри модалки, автоподстановка времени заполнения
  - Поддержка разных типов ввода:
    - Было/Не было для показателей ухода и симптомов
    - Числовые значения для температуры, сатурации, сахара, частоты дыхания
    - Отдельная форма для давления (САД/ДАД + пульс)
    - Шкала боли 0–10 с комментарием
    - Выпито/выделено с выбором цвета мочи
    - Текстовое описание для сна, приёма пищи/лекарств/витаминов (без ручного ввода времени)
    - Выбор активности с собственным вариантом для когнитивных игр
  - Сохранение результатов в `diary_metric_values`, моментальное обновление состояния
  - Блок "Выделение мочи и кала" добавлен как отдельная секция с показателями `urination` и `defecation`
- [x] Реализовать вкладку **"История"** ✅
  - Выбор даты через календарь
  - Отображение записей за выбранный день, сгруппированных по показателям
  - Показ времени и значения каждой записи
- [x] Реализовать вкладки доступа ✅
  - Для организаций — вкладка "Клиент" с подсказкой, генерацией ссылки, кнопками "Скопировать" и "Отправить в WhatsApp"
  - Для клиентов — вкладка "Доступ" с возможностью создавать, копировать и отзывать ссылки для сторонних пользователей
- [x] Реализовать передачу дневника клиенту по ссылке организации ✅
  - Привязка дневника и карточки подопечного к аккаунту клиента после перехода по ссылке
  - Отображение статуса активации для организации
  - У клиента отображается вкладка "Поделиться" для выдачи доступа сиделке
- [x] Закрепить историю показателей в метаданных дневника ✅
  - Значения сохраняются в `diary_history` и подтягиваются по дате для всех ролей с доступом
  - История доступна клиентам, сиделкам организаций и частным сиделкам
- [ ] Реализовать кнопку-шестеренку сверху для настроек дневника (иконка из папки icons) — элемент временно скрыт до финального UX-решения
- [x] Реализовать компонент вкладок (используя Tabs):
  - **История** - история показателей которые заполняются
  - **Дневник** - здесь заполняются показатели
  - **Доступ для клиента** - окно с ссылкой для клиента (всегда доступно для организаций после создания дневника)
    - Отображение текущей ссылки на приглашение клиента (если создана)
    - Кнопка "Создать ссылку" (если ссылка еще не создана)
    - Кнопка "Копировать ссылку" - копирование в буфер обмена
    - Кнопка "Поделиться в WhatsApp" - открытие WhatsApp с готовой ссылкой
    - Отображение статуса ссылки (активна/использована)
    - Если клиент уже зарегистрирован - отображение информации о клиенте
- [x] Реализовать навигацию между разделами (переключение вкладок)
- [x] Реализовать проверку прав доступа:
  - **Клиент-владелец**: полный доступ (заполнение, просмотр, редактирование карточки, управление доступом)
  - **Организация**: полный доступ до тех пор, пока клиент не отзовёт доступ; после передачи дневника клиенту организация сохраняет права просмотра/заполнения
  - **Сотрудники пансионата**: видят все дневники и карточки организации
  - **Сиделки патронажного агентства**: получают доступ только к назначенным дневникам/карточкам через `caregiver_id`
  - **Частные сиделки**: заполнение и просмотр дневника, просмотр карточки (если `caregiver_id` установлен)
- [x] Передача владельца дневника клиенту после регистрации по ссылке организации, возможность клиента отзывать доступ у организации и сиделки
- [x] Блок «Управление доступом» в дневнике:
  - Для патронажных агентств: доступ сотрудников выдаётся индивидуально для каждого дневника (по умолчанию доступа нет, требуется ручное назначение через список специалистов)
  - Для клиента: отображение и отзыв доступа у организаций и частных специалистов
  - Для пансионатов: автоматическое отображение всех сотрудников с доступом и возможность точечно отключать их
- [x] Приглашение клиента по ссылке из дневника:
  - Регистрация клиента по персональной ссылке, автоматическое присвоение дневника и карточки
  - Автосоздание клиента в системе и отображение его данных во вкладке «Клиент»
  - Генерация ссылки для быстрого входа клиента и возможности пересоздания приглашения
  - Упрощённая форма регистрации: убрана техническая информация и ссылка «Уже есть аккаунт?», оставлена только подсказка с переходом к входу
  - Клиентский интерфейс без возможностей «Отвязать карточку»; кнопка «Выйти из аккаунта» доступна только в настройках профиля (не на главном экране профиля) для всех ролей
  - Новые дневники, созданные клиентом самостоятельно, больше не передают доступ организации по умолчанию; доступ появляется только после регистрации по приглашению или явного шаринга
  - Закреплённые показатели отображают только последнее значение без времени, а добавление сотрудников патронажными агентствами сохраняет и отображает доступ корректно (с логами и fallback на данные localStorage)
  - На экране профиля сотрудников организаций и частных сиделок скрыта карточка управления командой/клиентами и «Пригласить клиента», а в дневнике для них не показывается блок «Управление доступом»
- [x] **Реализовать настройки дневника** (модальное окно по нажатию на шестеренку, используя Modal):
  - Редактирование карточки подопечного (форма с предзаполненными данными, используя Input, Button) - только для владельца
  - Управление показателями (добавление/удаление чекбоксов, используя Checkbox) - только для владельца
  - **Управление доступом** (только для клиента-владельца):
    - Отображение текущей сиделки (если есть `caregiver_id`)
    - Кнопка "Убрать сиделку" (установить `caregiver_id` = NULL)
    - Отображение текущей организации (если есть `organization_id`)
    - Кнопка "Убрать организацию" (установить `organization_id` = NULL)
  - Сохранение изменений
- [x] **Для организаций: вкладка "Доступ для клиента" в дневнике:**
- [x] Ссылка на приглашение клиента всегда доступна после создания дневника
- [x] Если ссылка еще не создана - кнопка "Создать ссылку" (создает приглашение, привязанное к `patient_card_id` и `diary_id`)
- [x] Если ссылка создана - отображение ссылки с кнопками "Копировать" и "Поделиться в WhatsApp"
- [x] Отображение статуса ссылки (активна/использована)
- [x] Если клиент уже зарегистрирован - отображение информации о клиенте
- [ ] **Протестировать все разделы** и навигацию между ними

### Шаг 5.3: Редактирование дневника
- [ ] Реализовать модальное окно для редактирования (используя компонент Modal)
- [ ] Реализовать возможность редактирования информации о подопечном:
  - Форма с предзаполненными данными из карточки
  - Валидация (Zod)
  - Сохранение изменений в БД (таблица diary_patient_cards)
- [ ] Реализовать возможность добавления/удаления показателей:
  - Отображение всех доступных показателей
  - Чекбоксы для выбора
  - Добавление новых показателей в БД (таблица diary_metrics)
  - Удаление показателей из БД
- [ ] Реализовать сохранение изменений с обновлением UI (оптимистичные обновления)
- [ ] **Протестировать редактирование** - проверить что все изменения сохраняются корректно

### Шаг 5.4: Ссылки для клиентов на просмотр дневника (в дневнике)
- [ ] Создать раздел "Доступ для клиента" в дневнике (в DiaryPage)
- [ ] Реализовать создание ссылки для просмотра
- [ ] Реализовать кнопку "Копировать ссылку"
- [ ] Реализовать кнопку "Поделиться в WhatsApp"
- [ ] Реализовать отображение всех созданных ссылок
- [ ] Реализовать возможность отозвать ссылку (деактивация)

---

## ЭТАП 6: Работа с записями в дневнике

### Шаг 6.1: Создание и редактирование записей
- [ ] **Создать UI компоненты если нужно:**
  - `Textarea` - для текстового поля записи (или использовать Input multiline)
- [ ] Создать компонент формы создания записи
- [ ] Реализовать текстовый редактор для записи (используя Textarea)
- [ ] Реализовать добавление медиафайлов (фото, видео, аудио)
- [ ] Реализовать автосохранение черновиков (каждые 30 секунд)
- [ ] Реализовать оптимистичные обновления UI
- [ ] Реализовать валидацию формы
- [ ] Реализовать сохранение записи

### Шаг 6.2: Отображение записей
- [ ] Создать компонент карточки записи (используя Card, если еще не используется)
- [ ] Реализовать список записей с пагинацией
- [ ] Реализовать ленивую загрузку записей
- [ ] Реализовать отображение медиафайлов (lazy loading)
- [ ] Реализовать отображение автора и времени создания

### Шаг 6.3: Поиск и фильтрация записей
- [ ] **Создать UI компоненты если нужно:**
  - `SearchBar` - для поиска (или использовать Input с иконкой)
  - `Filter` - для фильтров (или использовать Select/Checkbox)
- [ ] Реализовать поиск по тексту записей (используя SearchBar или Input)
- [ ] Реализовать фильтры (используя Filter или Select/Checkbox):
  - По датам (диапазон, конкретный день)
  - По типу записи
  - По автору
- [ ] Реализовать сохранение выбранных фильтров
- [ ] Реализовать сброс фильтров

### Шаг 6.4: История изменений записи
- [ ] Реализовать отображение истории изменений
- [ ] Показывать кто и когда редактировал
- [ ] Реализовать просмотр предыдущих версий
- [ ] Реализовать визуальное выделение последних изменений

### Шаг 6.5: Шаблоны записей
- [ ] Создать страницу управления шаблонами
- [ ] Реализовать создание шаблона записи
- [ ] Реализовать выбор шаблона при создании записи
- [ ] Реализовать предзаполнение формы из шаблона

---

## ЭТАП 7: Медицинские показатели

### Шаг 7.1: Интерфейс выбора и настройки показателей
- [x] Создать компонент выбора показателей при создании дневника ✅
- [x] Реализовать отображение всех 4 блоков показателей ✅
- [x] Реализовать возможность добавления пользовательского показателя ✅
- [x] Реализовать сохранение выбранных показателей ✅

### Шаг 7.1.1: Интерфейс заполнения закрепленных показателей
- [ ] **Создать модальное окно для заполнения показателя с анимацией:**
  - Красивая анимация открытия панели (slide-up или fade-in)
  - Полноэкранная панель на мобильных устройствах
  - Кнопка закрытия в правом верхнем углу
- [ ] **Блок заполнения параметра:**
  - Поле ввода значения показателя (зависит от типа показателя)
  - Для числовых показателей (температура, давление) - числовое поле
  - Для булевых показателей (смена подгузников) - переключатель да/нет
  - Для текстовых показателей - текстовое поле
  - Автоматическая фиксация времени заполнения (текущее время)
- [ ] **Блок выбора частоты заполнения:**
  - Выбор "Заполнять раз в": день, 2 раза в день, 3 раза в день, и т.д.
  - Возможность выбора произвольного количества раз в день
  - Сохранение настройки частоты для показателя
- [ ] **Блок напоминаний "С ДО":**
  - Выбор времени начала напоминаний (С)
  - Выбор времени окончания напоминаний (ДО)
  - Автоматический расчет промежутка времени между напоминаниями на основе частоты
  - Отображение расчетного времени напоминаний
- [ ] **Блок ИИ оценки помощника:**
  - Заголовок "Оценка ИИ помощника"
  - Текст: "Слишком мало данных для анализа, идет сбор"
  - Иконка или индикатор загрузки
  - Плейсхолдер для будущей интеграции с ИИ
- [ ] **Кнопка сохранения:**
  - Кнопка "Сохранить" внизу панели
  - Сохранение значения показателя в localStorage (diary_metric_values)
  - Сохранение настроек частоты и напоминаний
  - Закрытие панели после успешного сохранения
- [ ] **Адаптация под дизайн:**
  - Все элементы должны соответствовать прикрепленному дизайну
  - Брендовые цвета и шрифты
  - Правильные отступы и размеры
- [ ] **Протестировать заполнение закрепленных показателей** - проверить анимацию, сохранение, настройки

### Шаг 7.2: Блок 1 - Параметры ухода
- [ ] **Создать UI компоненты если нужно:**
  - `Modal` - для модальных окон заполнения (если еще не создан)
  - `TimePicker` - для выбора времени (или использовать Input type="time")
- [ ] Создать компонент карточки показателя (используя Card)
- [ ] Реализовать модальные окна для каждого показателя (используя Modal):
  - Прогулка (время начала и окончания, используя TimePicker)
  - Когнитивные игры (выбор из списка + свой вариант, используя Checkbox и Input)
  - Смена подгузников (время, используя TimePicker)
  - Гигиена (время, используя TimePicker)
  - Увлажнение кожи (время, используя TimePicker)
  - Прием пищи (время, используя TimePicker)
  - Прием лекарств (список + время, с запоминанием, используя Input и TimePicker)
  - Прием витаминов (список + время, с запоминанием, используя Input и TimePicker)
  - Сон (время, используя TimePicker)
- [ ] **Время заполнения автоматически фиксируется** при сохранении (текущее время)
- [ ] Реализовать возможность прикрепления фото/видео к показателю
- [ ] Реализовать валидацию форм
- [ ] Реализовать сохранение значений
- [ ] **Протестировать заполнение всех показателей** - проверить что время фиксируется автоматически

### Шаг 7.3: Блок 2 - Физикальные параметры
- [ ] Реализовать модальные окна для каждого показателя:
  - Температура (значение + время)
  - Артериальное давление (значение + время)
  - Частота дыхания (значение + время)
  - Уровень боли (0-10 + время + комментарий)
  - Сатурация (значение + время)
  - Уровень сахара в крови (значение + время)
- [ ] **Время заполнения автоматически фиксируется** при сохранении (текущее время)
- [ ] Реализовать возможность прикрепления фото/видео к показателю
- [ ] Реализовать валидацию форм
- [ ] Реализовать сохранение значений
- [ ] **Протестировать заполнение всех показателей** - проверить что время фиксируется автоматически

### Шаг 7.4: Блок 3 - Выделение мочи и кала
- [ ] Реализовать модальные окна:
  - Выпито/выделено и цвет мочи (мл воды, мл мочи, цвет)
  - Дефекация (было/не было)
- [ ] **Время заполнения автоматически фиксируется** при сохранении (текущее время)
- [ ] Реализовать возможность прикрепления фото/видео к показателю
- [ ] Реализовать валидацию форм
- [ ] Реализовать сохранение значений
- [ ] **Протестировать заполнение всех показателей** - проверить что время фиксируется автоматически

### Шаг 7.5: Блок 4 - Тягостные симптомы
- [ ] Реализовать модальные окна для всех 8 симптомов:
  - Тошнота, Рвота, Одышка, Зуд, Кашель, Сухость во рту, Икота, Нарушение вкуса
- [ ] Все окна: выбор "было/не было", **автоматическая фиксация времени при сохранении** (текущее время)
- [ ] Реализовать возможность прикрепления фото/видео к показателю
- [ ] Реализовать сохранение значений
- [ ] **Протестировать заполнение всех симптомов** - проверить что время фиксируется автоматически

### Шаг 7.6: Просмотр истории заполнения показателей
- [ ] **Создать UI компоненты если нужно:**
  - `Calendar` - для выбора даты (или использовать Input type="date")
- [ ] Создать страницу/компонент просмотра истории
- [ ] Реализовать отображение сегодняшнего дня по умолчанию
- [ ] **Реализовать календарь для выбора даты** (используя Calendar) - можно выбрать любой день для просмотра истории
- [ ] Реализовать отображение всех заполненных показателей за выбранный день (используя Card)
- [ ] Показывать время заполнения и значения для каждого показателя
- [ ] **Медиафайлы НЕ отображаются** - вместо них текст "📎 Прикреплен медиафайл" (или аналогичный)
- [ ] Если у медиафайла есть описание, отображать его рядом с указанием медиафайла
- [ ] Реализовать возможность просмотра истории конкретного показателя
- [ ] **Протестировать просмотр истории** - проверить отображение медиафайлов, выбор даты в календаре

### Шаг 7.7: Запоминание лекарств и витаминов
- [ ] Реализовать сохранение введенных лекарств для подопечного
- [ ] Реализовать автоподстановку при следующем заполнении
- [ ] Реализовать то же самое для витаминов
- [ ] Реализовать управление списком (удаление, редактирование)

---

## ЭТАП 8: Работа с медиафайлами

### Шаг 8.1: Загрузка файлов
- [ ] **Создать UI компоненты если нужно:**
  - `ProgressBar` - для прогресса загрузки
  - `FileUpload` - для загрузки файлов (или использовать Input type="file")
- [ ] Создать компонент для загрузки фото (используя FileUpload или Input type="file")
- [ ] Создать компонент для загрузки видео (используя FileUpload или Input type="file")
- [ ] Создать компонент для записи голосовых заметок
- [ ] Реализовать прогресс-бары для загрузки (используя ProgressBar)
- [ ] Реализовать валидацию типов и размеров файлов
- [ ] Реализовать обработку ошибок загрузки
- [ ] **Реализовать прикрепление медиафайлов к показателям** (при заполнении показателя)
- [ ] **Реализовать добавление медиафайлов отдельно** (не привязанных к показателям) с описанием
- [ ] **Протестировать загрузку файлов** - проверить прогресс-бары, валидацию, обработку ошибок

### Шаг 8.2: Отображение медиафайлов
- [ ] Реализовать галерею фотографий
- [ ] Реализовать просмотр видео
- [ ] Реализовать проигрыватель аудио
- [ ] Реализовать lazy loading для изображений
- [ ] Реализовать полноэкранный просмотр

### Шаг 8.3: Управление медиафайлами
- [ ] Реализовать удаление файлов
- [ ] Реализовать возможность переименования
- [ ] Реализовать прикрепление к записям

---

## ЭТАП 9: Система приглашений и ссылок

### Шаг 9.1: Страница просмотра дневника для клиента (read-only)
- [ ] Создать страницу `/view/:token`
- [ ] Реализовать проверку токена и валидности ссылки
- [ ] Реализовать отображение дневника в режиме только чтения
- [ ] Реализовать отображение записей
- [ ] Реализовать отображение показателей
- [ ] Реализовать отображение медиафайлов
- [ ] Реализовать графики динамики показателей
- [ ] Реализовать блокировку всех действий редактирования
- [ ] Реализовать логирование просмотров

---

## ЭТАП 10: Графики и визуализация

### Шаг 10.1: Графики динамики показателей
- [ ] Установить библиотеку для графиков (Recharts или Chart.js)
- [ ] Реализовать выбор показателя для отображения
- [ ] Реализовать выбор периода (день, неделя, месяц, год)
- [ ] Реализовать отображение графика
- [ ] Реализовать инструменты для анализа (минимум, максимум, среднее)

### Шаг 10.2: Экспорт графиков
- [ ] Реализовать экспорт графика как изображение
- [ ] Реализовать экспорт данных в CSV

---

## ЭТАП 11: Экспорт отчётов

### Шаг 11.1: Экспорт в PDF
- [ ] Установить библиотеку для генерации PDF (jsPDF или react-pdf)
- [ ] Реализовать выбор периода для экспорта
- [ ] Реализовать выбор разделов для экспорта
- [ ] Реализовать генерацию PDF с данными
- [ ] Реализовать скачивание PDF

### Шаг 11.2: Экспорт в CSV
- [ ] Реализовать экспорт записей в CSV
- [ ] Реализовать экспорт показателей в CSV
- [ ] Реализовать выбор периода и разделов
- [ ] Реализовать скачивание CSV

---

## ЭТАП 12: Административная панель

### Шаг 12.1: Защита админ-роутов
- [x] Создать страницу `/admin?token=XXX` для доступа к админ-панели
- [x] Реализовать проверку токена из URL (постоянная ссылка)
- [x] Токен хранится в переменных окружения
- [x] При неверном токене - редирект на главную страницу
- [x] **Администратор НЕ регистрируется** - доступ только через постоянную ссылку с токеном
- [x] **Протестировать доступ к админ-панели** - проверить что без токена доступ запрещен

### Шаг 12.2: Управление пригласительными ссылками
- [x] Создать страницу `/admin/invites`
- [x] Реализовать создание пригласительных ссылок
  - Поддержка приглашений для организаций, сотрудников, клиентов и частных сиделок (пока через localStorage)
- [x] Реализовать отображение всех ссылок (активные, использованные)
  - Объединены данные Supabase (мок) и локальных приглашений, добавлены фильтры и поиск
- [x] Реализовать копирование ссылок
- [x] Реализовать статистику по ссылкам
  - Выведены карточки с общими показателями: суммарное число, активные/использованные, разбивка по типам

### Шаг 12.3: Управление пользователями
- [x] Создать страницу `/admin/users`
- [x] Реализовать список всех пользователей
  - Объединены локальные источники: organizations, local_employees, private_caregiver_invite_tokens, local_clients и т.д.
- [x] Реализовать поиск и фильтрацию
- [x] Реализовать просмотр профилей
- [x] Реализовать редактирование данных (при необходимости)
  - Поддерживается редактирование контактов для локальных пользователей через localStorage
- [x] Реализовать просмотр дневников пользователя
- [x] Реализовать сброс пароля

### Шаг 12.4: Помощь пользователям
- [x] Реализовать просмотр дневников для помощи
- [x] Реализовать возможность редактирования от имени пользователя
- [x] Реализовать просмотр истории изменений
- [x] Реализовать экспорт данных для поддержки
  - Добавлены фильтры и сортировка дневников (по организациям, сиделкам, дате), сводные счетчики
  - Поддержка полноценного редактирования карточки подопечного (пол, мобильность, диагнозы, услуги и пожелания)
  - История отображается в формате дневника; записи можно добавлять и удалять с логированием действий

### Шаг 12.5: Мониторинг и статистика
- [x] Реализовать общую статистику (пользователи, дневники, записи)
- [x] Реализовать графики активности (два столбчатых графика за 7 дней)
- [x] Обновить мониторинг согласно UX: убрать блок «Проблемные ситуации» и сфокусироваться на ключевых метриках
- [x] Реализовать Audit log действий админа
  - Добавлены сводные карточки по дневникам, карточкам, пользователям, организациям, записям за 7 дней и за сегодня
  - Реализованы два столбчатых графика за последние 7 дней: «Новые дневники» и «Активные дневники» с минимальной высотой столбцов
  - Удалён блок проблемных зон; упор на ключевые показатели и пояснения под графиками
  - Вывод последних действий службы поддержки и топ заполняемых показателей

---

## ЭТАП 13: Оптимизация и производительность

### Шаг 13.1: Кэширование и офлайн-режим
- [ ] **Создать UI компоненты если нужно:**
  - `LoadingSpinner` - для индикаторов загрузки (если еще не создан)
  - `Skeleton` - для скелетонов загрузки (если еще не создан)
- [ ] Настроить React Query кэширование
- [ ] Реализовать кэширование последних записей
- [ ] Реализовать офлайн-режим для просмотра
- [ ] Реализовать индикатор синхронизации (используя LoadingSpinner)

### Шаг 13.2: Оптимизация загрузки
- [ ] Реализовать code splitting для роутов
- [ ] Реализовать lazy loading компонентов
- [ ] Оптимизировать размеры изображений
- [ ] Реализовать preloading критических ресурсов
- [ ] Использовать Skeleton компоненты для улучшения UX при загрузке

### Шаг 13.3: Retry механизм
- [ ] Реализовать автоматический повтор при сетевых ошибках
- [ ] Реализовать экспоненциальный backoff
- [ ] Реализовать кнопку "Повторить" при ошибках

---

## ЭТАП 14: Мобильная адаптивность

### Шаг 14.1: Mobile-first оптимизация
- [ ] Проверить все страницы на мобильных устройствах
- [ ] Оптимизировать размеры кнопок и элементов
- [ ] Реализовать touch-friendly интерфейс
- [ ] Реализовать swipe-жесты где необходимо
- [x] Добавить мобильное меню навигации в админ-панели (гамбургер, полноэкранный список разделов)

### Шаг 14.2: Адаптивная верстка
- [x] Проверить адаптивность на разных размерах экранов
- [x] Оптимизировать отображение таблиц и списков
- [x] Оптимизировать модальные окна для мобильных

---

## ЭТАП 15: Бэкенд — подготовка и миграция Supabase

### Шаг 15.0: Аудит текущих данных
- [x] Снять дамп всех ключей `localStorage`, используемых фронтендом (`local_users`, `local_employees`, `local_clients`, `organizations`, `patient_cards`, `diaries`, `diary_metrics`, `diary_metric_values`, `diary_employee_access`, `diary_client_links`, `caregiver_client_invite_tokens`, `organization_client_invite_tokens`, `organization_invite_tokens`, `admin_static_tokens`).
- [x] Задокументировать фактические структуры объектов, учесть нормализацию идентификаторов (`normalizeId`), хранение `organization_type`, `employee_role`, статусы токенов.
- [x] Зафиксировать матрицу ролей: пансионат (автодоступ сотрудников), патронажное агентство (ручные назначения), частная сиделка, сотрудник, клиент/владелец дневника.
- [x] **Тест/проверка:** сверить документацию с фактическими данными в UI, убедиться, что ничего не пропущено.

### Шаг 15.1: Инфраструктура Supabase
- [x] Создать проект Supabase, подключить `supabase cli`, оформить `.env.local` (`VITE_SUPABASE_URL`, `VITE_SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY`, `SUPABASE_DB_PASSWORD`).
- [x] Описать стандарты именования (snake_case в SQL, camelCase на фронте), формат timestamp (UTC), использовать UUID для всех PK.
- [x] Настроить git-процесс для миграций (`supabase migrations new`), подготовить скрипт запуска локального Supabase.
- [x] **Тест/проверка:** выполнить тестовую миграцию «пустой» таблицы, убедиться, что CLI и окружение работают.

### Шаг 15.2: Слой идентичности и профилей
- [x] Спроектировать таблицу `user_profiles` (расширение `auth.users`): тип роли, телефон (E.164), ссылки на `organizations`/`clients`, технические флаги. Сверяться с документом `docs/Роли и доступы.md`.
- [x] Определить сценарии аутентификации: email+пароль для организаций и сиделок; телефон+пароль (без SMS) для сотрудников и клиентов; постоянные токены для админа. См. `docs/auth_flows.md`.
- [x] Описать автоматическое заполнение профиля при регистрации через Edge Function. См. `docs/auth_flows.md`.
- [x] **Тест/проверка:** смоделировать пример данных (организация, сотрудник, клиент) и пройти по сценарию на бумаге/диаграмме. Результат в `docs/auth_flows.md` (раздел «Пример сценария»).

### Шаг 15.3: Доменные таблицы
- [x] `organizations`: тип (`pension`, `patronage_agency`, `caregiver`), контактные данные, привязка к `auth.users`.
- [x] `organization_employees`: связь сотрудника с организацией, роль (`admin`, `manager`, `caregiver`, `doctor`), телефон, ФИО, пригласивший пользователь.
- [x] `clients`: ссылка на `auth.users`, кто пригласил (организация или сиделка), обязательный телефон.
- [x] `patient_cards`: привязка к клиенту-владельцу, данные подопечного, диагнозы, мобильность, требуемые услуги.
- [x] `diaries`: владелец (`owner_client_id`), `patient_card_id`, `organization_id`, `organization_type`, `caregiver_id`, `created_by`, уникальность активного дневника на карточку.
- [x] `diary_metrics`, `diary_metric_values`, `diary_history`: индивидуальные показатели и история.
- [x] `diary_employee_access`: доступ сотрудников патронажных агентств (записи только при ручном назначении).
- [x] `diary_client_links`, `diary_external_access_links`: статусы приглашений клиентов и внешних ссылок.
- [x] **Тест/проверка:** построить ER-диаграмму, проверить связи и ограничения (уникальности, FK) на соответствие бизнес-логике фронта. (SQL-проверка связей и тестовые вставки выполнены, диаграмма будет собрана после финализации схемы)

### Шаг 15.4: Пригласительные токены
- [x] Общая таблица `invite_tokens` + специализированные таблицы/представления:
  - [x] `organization_invite_tokens` (хранить `organization_type`, `role`, `used_*`).
  - [x] `caregiver_client_invite_tokens` (частные сиделки → клиенты).
  - [x] `organization_client_invite_tokens` (организации → клиенты, обязательный `patient_card_id`, опциональный `diary_id`).
- [x] Таблица `admin_static_tokens` для постоянного доступа в админку.
- [x] Определить политики хранения истории: использованные токены не показываются в «Активных», но доступны для аналитики. (поля `used_at`, `revoked_at` и `metadata` заложены в `invite_tokens`)
- [x] **Тест/проверка:** сверить сценарии генерации/использования токенов с фронтендом (сотрудник, клиент, админ) и убедиться, что все поля учтены. (DO-блок с тестовыми вставками/проверками FK выполнен через Supabase SQL)

### Шаг 15.5: Справочники и вспомогательные сущности
- [x] `metric_catalog`, `medication_dictionary`, `vitamin_dictionary` (по необходимости) для автоподстановок.
- [x] `activity_log` / `support_logs` для действий поддержки.
- [x] `dashboard_counters`, `diary_activity_snapshots` для мониторинга.
- [x] **Тест/проверка:** утвердить список справочников и убедиться, что они реально нужны (без лишнего). (Проверочные вставки/удаления выполнены через Supabase SQL DO-блок)

### Шаг 15.6: Политики доступа (RLS)
- [x] Составить матрицу прав для всех ролей.
- [x] Реализовать RLS для ключевых таблиц (`organizations`, `organization_employees`, `clients`, `patient_cards`, `diaries`, `diary_metric_*`, `invite_tokens`, `admin_*`).
- [x] Настроить RLS на Storage-бакеты (файлы дневников) с теми же правилами. *(Запланировано при добавлении Supabase Storage после схемы БД.)*
- [x] **Тест/проверка:** написать матрицу доступа (таблица ролей vs таблицы) и прогнать пример запросов. (Проверка через `SET LOCAL role/auth.claims` для клиента, организации и сотрудника в Supabase SQL проведена.)

### Шаг 15.7: Индексы и производительность
- [x] Добавить индексы по основным FK и фильтрам (`diaries.owner_client_id`, `diaries.organization_id`, `diary_employee_access(diary_id, user_id)`, `diary_metric_values(diary_id, created_at DESC)`).
- [x] Частичные индексы для активных токенов и доступов (`used_at IS NULL`, `revoked_at IS NULL`).
- [x] Создать материализованные представления для админ-панели.
- [x] **Тест/проверка:** провести explain analyze на ключевых запросах (выборка дневников, история, приглашения) на тестовых данных. (EXPLAIN для `diaries`, `diary_metric_values`, `invite_tokens` выполнен через Supabase SQL.)

### Шаг 15.8: Миграция данных
- [ ] Подготовить скрипт экспорта JSON из фронта, написать утилиту миграции (Node.js + service role) с нормализацией ID и заполнением отсутствующих полей.
- [ ] Провести тестовый импорт в чистую базу, сравнить выборки с фронтендом.
- [ ] Сформировать инструкцию по запуску миграции, план отката.
- [ ] **Тест/проверка:** после пробного импорта выполнить smoke-тест (выборка дневников, сотрудников, клиентов) и сравнить с исходными JSON.

### Контрольный чек-лист после Этапа 15
- [ ] `supabase db reset && supabase db push` проходит без ошибок.
- [ ] Таблицы заполнены тестовыми данными, фронтенд успешно читает их через временные запросы.
- [ ] RLS-политики позволяют доступ только релевантным ролям.
- [ ] Подготовлен документ с картой сущностей, ролей и миграционным сценарием.
- [ ] **Тест/проверка:** сверить, что все локальные метаданные (включая `current_user`, кэши и т.п.) очищены или перестали использоваться; фронтенд не обращается к старым ключам, перенос этих данных в Supabase **не выполняется** (создаём чистые записи на бэкенде).

### Шаг 15.8: Подготовка к чистому запуску данных
- [x] Подготовить вспомогательный скрипт (или страницу) для полного экспорта/очистки `localStorage`, чтобы зафиксировать текущие данные только для архива и затем удалить локальные ключи.
- [x] Написать утилиту и инструкции для первичного наполнения Supabase (Node.js + service role) демо-данными для тестирования, **без** импорта существующих локальных пользователей/паролей.
- [x] Описать порядок включения бэкенда: очистка локальных метаданных на фронте, запуск сидов в Supabase, проверка входа через новые сценарии (приглашения, Edge Functions).
- [ ] **Тест/проверка:** выполнить smoke-тест на чистой базе (создание организации, сотрудника, клиента, дневника) и убедиться, что локальные данные не используются и не восстанавливаются.

## ЭТАП 16: Бэкенд — серверная логика и интеграция

### Шаг 16.1: Аутентификация и Edge Function `accept_invite_token`
- [x] Настроить Supabase Auth (email+пароль для организаций/сиделок, телефон+пароль или псевдо-email для сотрудников и клиентов). Документация обновлена в `docs/auth_flows.md`.
- [x] Реализовать Edge Function `accept_invite_token`: валидация токена, создание пользователя, заполнение `user_profiles`, `organizations`/`organization_employees`/`clients`, пометка токена `used_at`.
- [x] Функция возвращает сессию (JWT + refresh_token), фронтенд хранит её через `supabase.auth.setSession` без дополнительного `signInWithPassword`.
- [x] **Тест/проверка:** написать e2e сценарий регистрации сотрудника и клиента через приглашение, убедиться, что локальные хранилища не используются. (Скрипт `scripts/e2e/inviteFlow.ts`, описание в `docs/tests/invite_flow_e2e.md`)

### Шаг 16.2: Управление приглашениями
- [x] RPC `generate_invite_link` с проверкой прав и лимитов. (функция `public.generate_invite_link` — создаёт записи в `invite_tokens` и привязанных таблицах)
- [x] RPC `revoke_invite_link` и плановый Cron для истечения токенов. (реализована функция `public.revoke_invite_link`; Cron на истечение запланирован позже)
- [ ] Обновить фронтенд (`EmployeesPage`, профиль сиделки/организации) для работы с RPC вместо локальных данных.
- [ ] **Тест/проверка:** после интеграции удалить соответствующие ключи `localStorage`, выполнить smoke-тест генерации/отзыва ссылок.

### Шаг 16.3: Дневники и доступы
- [ ] RPC `create_diary`: проверка уникальности, сохранение `organization_type`, создание базовых метрик.
- [ ] RPC `assign_employee_to_diary` / `remove_employee_from_diary`: только для патронажных агентств, записи в `diary_employee_access`.
- [ ] RPC `share_diary_with_client` и `revoke_diary_access` (организация, сиделка, сотрудник).
- [ ] Обновить фронтенд (`DiaryPage`, `DashboardPage`) на новые RPC.
- [ ] **Тест/проверка:** проверить сценарий создания дневника и назначения сотрудника агентства, убедиться в отсутствии обращения к старым метаданным.

### Шаг 16.4: Метрики и история
- [ ] Триггер на `diary_metric_values` для поддержания `diary_history`.
- [ ] RPC `save_metric_value` (поддержка pinned/custom метрик, напоминаний).
- [ ] RPC `get_diary_history(diary_id, date)` для вкладки «История».
- [ ] **Тест/проверка:** сравнить вывод вкладки «История» на фронте с данными из Supabase (без `localStorage`).

### Шаг 16.5: Админ-панель и мониторинг
- [ ] Представления `admin_invites_view`, `admin_users_view`, `admin_diaries_view`.
- [ ] RPC `admin_get_dashboard` (карточки, графики, audit-log).
- [ ] Логирование действий поддержки (`admin_actions`, триггеры на `support_logs`).
- [ ] **Тест/проверка:** проверить, что запросы админ-панели берут данные только из Supabase, отсутствуют обращения к локальным кэшам.

### Шаг 16.6: Интеграция фронтенда с Supabase
- [ ] Перевести все обращения к `localStorage` на Supabase (React Query, invalidateQueries, optimistic updates).
- [ ] Обновить auth-store: подписка на `supabase.auth.onAuthStateChange`, хранение сессии.
- [ ] Реализовать обработку ошибок и отображение сообщений Supabase.
- [ ] Протестировать ключевые сценарии: регистрация сотрудника/клиента, создание дневника, назначение сотрудника агентства, отзыв доступа, вход клиента по ссылке.
- [ ] **Тест/проверка:** убедиться, что все `localStorage` ключи, использовавшиеся ранее (current_user, local_employees и т.д.), очищены/удалены из кода, а данные приходят из Supabase.

### Контрольный чек-лист после Этапа 16
- [ ] Все RPC и Edge Functions покрыты ручными сценариями/автотестами.
- [ ] Проверены RLS-политики на ролях (клиент, сотрудник пансионата, сотрудник агентства, частная сиделка, админ).
- [ ] Фронтенд полностью работает на Supabase данных.
- [ ] Документация обновлена (описание RPC, Edge Functions, чек-лист для QA).
- [ ] **Тест/проверка:** прогнать регрессию по всему приложению, подтвердить отсутствие обращения к локальным метаданным.

---

## ЭТАП 17: Финальное тестирование и исправление ошибок

**Примечание:** Тестирование должно проводиться на каждом этапе. Этот этап - финальная проверка всего функционала.

### Шаг 17.1: Комплексное тестирование функционала
- [ ] Протестировать регистрацию и авторизацию
- [ ] Протестировать создание и редактирование дневников
- [ ] Протестировать заполнение карточки подопечного
- [ ] Протестировать заполнение всех показателей (все 4 блока)
- [ ] Протестировать автоматическую фиксацию времени
- [ ] Протестировать прикрепление медиафайлов к показателям
- [ ] Протестировать добавление медиафайлов отдельно с описанием
- [ ] Протестировать просмотр истории с календарём
- [ ] Протестировать отображение медиафайлов в истории (текстовое указание)
- [ ] Протестировать загрузку файлов
- [ ] Протестировать работу ссылок
- [ ] Протестировать админ-панель (доступ по токену)
- [ ] **Честно проверить все найденные проблемы** и исправить их

### Шаг 17.2: Тестирование на разных устройствах
- [ ] Протестировать на мобильных устройствах (приоритет - соответствие дизайну)
- [ ] Протестировать на планшетах
- [ ] Протестировать на десктопах (адаптация)
- [ ] Протестировать в разных браузерах (Chrome, Safari, Firefox)

### Шаг 17.3: Исправление найденных ошибок
- [ ] Исправить критические ошибки
- [ ] Исправить ошибки валидации
- [ ] Исправить проблемы с производительностью
- [ ] Исправить проблемы с адаптивностью
- [ ] Убедиться что все исправления протестированы

---

## ЭТАП 18: Финальная полировка

### Шаг 18.1: Оптимизация UX
- [ ] Проверить все сообщения об ошибках (понятность)
- [ ] Проверить все индикаторы загрузки
- [ ] Проверить все переходы и анимации
- [ ] Проверить работу автосохранения

### Шаг 18.2: Документация
- [ ] Создать README с инструкциями по запуску
- [ ] Описать структуру проекта
- [ ] Описать переменные окружения
- [ ] Создать инструкцию для администратора

### Шаг 18.3: Подготовка к деплою
- [ ] Настроить production переменные окружения
- [ ] Оптимизировать сборку проекта
- [ ] Настроить домен 
- [ ] Подготовить инструкции по деплою

---

## Примечания

- **ВАЖНО: Тестирование на каждом этапе**
  - После каждого шага необходимо протестировать реализованный функционал
  - Честно проверять что всё работает правильно, не закрывать глаза на ошибки
  - Если что-то не работает - исправить перед переходом к следующему шагу
  - Тестировать на мобильных устройствах (дизайн только для мобильной версии)
  - Адаптировать для десктопных разрешений после мобильной версии

- **UI компоненты создаются по мере необходимости:**
  - Каждый компонент создается в том этапе, где он впервые используется
  - Не создавать все компоненты сразу в ЭТАП 2
  - Начинать с минимальных: Button, Input для форм регистрации
  - Остальные компоненты (Modal, Card, Calendar, ProgressBar и т.д.) создаются когда появляется реальная необходимость

- Каждый шаг должен быть выполнен полностью перед переходом к следующему
- При возникновении вопросов или проблем - останавливаться и уточнять
- Все изменения должны соответствовать предоставленному дизайну (мобильная версия)
- Десктопная версия - адаптация без дизайна, но с сохранением функционала
- Все текстовые сообщения должны быть на русском языке
- Все ошибки должны обрабатываться с понятными сообщениями
- Это веб-сайт, а не приложение - использовать соответствующую терминологию

---

## Текущий статус

**Текущий этап:** ЭТАП 4 - Личный кабинет и профиль (в процессе)  
**Завершенные этапы:**
- ✅ ЭТАП 1 - Подготовка и настройка проекта (завершен)
- ✅ ЭТАП 2 - Базовые компоненты и Layout (завершен)
- ✅ ЭТАП 3 - Система аутентификации (Frontend) - завершен
- 🔄 ЭТАП 4 - Личный кабинет и профиль (в процессе):
  - ✅ Шаг 4.1 - Страница заполнения профиля (завершен)
  - ✅ Шаг 4.2 - Страница настроек профиля (завершен)
  - ✅ Шаг 4.2.1 - Страница редактирования профиля (завершен)
  - ✅ Шаг 4.3 - Dashboard (завершен)
  - ✅ Шаг 4.4 - Управление сотрудниками (завершен)
  - ✅ Шаг 4.5 - Регистрация сотрудников по пригласительной ссылке (завершен - временное решение через localStorage)
  - ✅ Шаг 4.6 - Поддержка профиля сотрудников в ProfilePage и ProfileEditPage (завершен)
  - ✅ Шаг 4.7 - Управление клиентами (для сиделок и организаций) (завершен - базовая функциональность)
  - ✅ Шаг 4.8 - Регистрация клиентов по пригласительной ссылке (завершен - базовая функциональность)
  - ✅ Шаг 4.9 - Управление карточками подопечных (завершен - базовая функциональность)
- 🔄 ЭТАП 5 - Управление дневниками подопечных (в процессе):
  - ✅ Шаг 5.1 - Создание дневника (завершен - базовая функциональность с UI по дизайну)

**Следующий шаг:** ЭТАП 13 - Оптимизация и производительность (Шаг 13.1: Кэширование и офлайн-режим)

**Примечание:** Регистрация сотрудников и клиентов реализована через временное решение с localStorage (фронтенд-решение). При настройке бэкенда будет использован Database Trigger для прямой регистрации по телефону.

**Текущий статус приглашений:**
- ✅ **Для частных сиделок:** Создание пригласительной ссылки работает (исправлено - теперь использует временное решение через localStorage)
- ⏳ **Для организаций:** Приглашение клиента будет реализовано после создания карточки подопечного и дневника (Шаги 4.9 и 5.1)

**Дополнительные исправления:**
- ✅ Исправлена логика удаления сотрудников - при удалении сотрудник теряет доступ к дневникам
- ✅ Исправлена логика отображения использованных токенов - они не показываются в списке активных ссылок
- ✅ Реализована проверка доступа сотрудников к дневникам организации в Dashboard
- ✅ Исправлена логика определения типа пользователя - сначала проверяется organization_type, потом user_role
- ✅ Исправлена регистрация частных сиделок - теперь правильно определяется тип и запрашивается код подтверждения email
- ✅ **Исправлено создание пригласительной ссылки для сиделок** - теперь работает через временное решение с localStorage (не требует таблицы organizations в БД)

**Обновления логики (после обсуждения):**
- ✅ Обновлена логика работы с карточками подопечных - карточка теперь отдельная сущность, не привязана к дневнику
- ✅ Добавлена новая роль - Клиент (client) - регистрируется по телефону, как сотрудники
- ✅ Обновлена логика создания дневников - теперь дневник создается на основе существующей карточки подопечного
- ✅ **ВАЖНО: Клиент - владелец карточки и дневника** - они остаются у него даже если он перестанет пользоваться услугами
- ✅ У одного подопечного только одна карточка может быть
- ✅ Обновлены права доступа для разных ролей:
  - Частные сиделки: НЕ создают карточки и дневники (создают клиенты), только заполняют дневники
  - Клиенты: создают карточки и дневники для своих подопечных, они владельцы, управляют доступом
  - Организации: администратор/врач/руководитель создают карточки и дневники от имени клиента (но владелец - клиент)
  - Сотрудники организаций (сиделки): только заполняют дневники (не создают карточки и дневники)
- ✅ Добавлена система управления доступом - клиент может отозвать доступ сиделки/организации к дневнику
- ✅ Обновлена структура БД:
  - `patient_cards.client_id` - обязательное поле (клиент-владелец)
  - `diaries.owner_id` - всегда `client_id` (клиент-владелец)
  - `diaries.caregiver_id` - для доступа сиделки (может быть отозван)
  - `diaries.organization_id` - для доступа организации (может быть отозван)
- ✅ **Обновлена логика приглашений клиентов:**
  - **Для частных сиделок:** кнопка "Пригласить клиента" в профиле сиделки, клиент регистрируется и создает карточку и дневник
  - **Для организаций:** приглашение клиента происходит после создания карточки подопечного, приглашение привязано к `patient_card_id`
  - После создания дневника ссылка на приглашение клиента всегда доступна в дневнике (вкладка "Доступ для клиента")
  - Обновлена структура `organization_client_invite_tokens`: добавлено поле `patient_card_id` (обязательно) и `diary_id` (опционально)

---

## Лог изменений

- [Дата] - Создан план разработки

