# Роли и доступы — справочник

## Список ролей
1. **Администратор (`admin`)** — технический персонал, работает только через админ-панель по постоянному токену.
2. **Организация**
   - `organization_type = 'pension'` — пансионат, у сотрудников автоматический доступ ко всем дневникам организации.
   - `organization_type = 'patronage_agency'` — патронажное агентство, доступ сотрудников выдаётся вручную на каждый дневник.
   - `organization_type = 'caregiver'` — частная сиделка ().
3. **Сотрудник организации (`org_employee`)**
   - Роли: `admin`, `manager`, `doctor`, `caregiver`.
   - Поведение зависит от `organization_type` родительской организации.
4. **Клиент (`client`)** — родственник/опекун, владелец карточек подопечных и дневников.

## Аутентификация и регистрация
| Роль | Способ регистрации | Источник приглашения | Требования к данным |
|------|--------------------|----------------------|---------------------|
| Администратор | Нет регистрации, токен | Статический список (`admin_static_tokens`) | — |
| Организация (пансионат/агентство) | Email + пароль (Supabase Auth) | Admin-приглашение или открытая регистрация | Название/ФИО, телефон, адрес (для пансионата/агентства), город (для сиделки) |
| Частная сиделка | Email + пароль | Admin-приглашение или открытая регистрация | ФИО, телефон, город |
| Сотрудник организации | Телефон + пароль (Edge Function) | `organization_invite_tokens` | ФИО, роль, телефон |
| Клиент | Телефон + пароль (Edge Function) | `caregiver_client_invite_tokens` или `organization_client_invite_tokens` | Имя, фамилия, телефон |

## Основные таблицы и связи
| Роль | Основные таблицы | Ключевые поля |
|------|------------------|---------------|
| Администратор | `admin_static_tokens`, `admin_actions`, `admin_invites_view`, `admin_users_view` | токен, аудит |
| Организация | `organizations`, `organization_client_invite_tokens`, `patient_cards`, `diaries` | `organization_type`, контакты |
| Частная сиделка | `organizations` (type `caregiver`), `caregiver_client_invite_tokens`, `diaries` | `caregiver_id`, город |
| Сотрудник | `organization_employees`, `diary_employee_access` | `role`, `organization_id`, `user_id` |
| Клиент | `clients`, `patient_cards`, `diaries`, `diary_client_links`, `diary_external_access_links` | `owner_client_id`, `patient_card_id` |

## Матрица доступа (RLS ориентир)
| Роль | Таблицы (чтение) | Таблицы (запись) | Особые правила |
|------|-----------------|------------------|----------------|
| Администратор | Все | Через сервисную роль/Edge Functions | Полный доступ, аудит действий |
| Пансионат | Свои `organizations`, все `patient_cards`/`diaries` где `organization_id = current_org` | Создание карточек и дневников, приглашение сотрудников и клиентов | Сотрудники видят все дневники без `diary_employee_access` |
| Патронажное агентство | Свои `organizations`, `patient_cards`/`diaries` по `organization_id` | Создание карточек/дневников, приглашение сотрудников и клиентов, ручное назначение сотрудников | Сотрудники видят дневник только при записи в `diary_employee_access` |
| Частная сиделка | Свои `organizations`, `diaries` где `caregiver_id` = сиделка | Приглашение клиентов, работа с дневниками клиентов | Не может создавать карточки/дневники — только клиент |
| Сотрудник пансионата | `patient_cards`/`diaries` `organization_id = org` | Ввод метрик, управление доступом (если роль `admin`/`manager`) | Автодоступ по организации |
| Сотрудник патронажного агентства | `patient_cards`/`diaries` только при наличии строки в `diary_employee_access` | Ввод метрик, управление доступом зависит от роли | Нет записи — нет доступа |
| Клиент | Свои `clients`, `patient_cards`, `diaries`, `diary_metric_values`, `diary_history` | Создание карточек и дневников, управление доступом, приглашения | Может отзывать `organization_id`, `caregiver_id`, записи в `diary_employee_access` |

## Логика доступа к дневникам
- **Клиент** — владелец: `owner_client_id = client_id`. Полный контроль: редактирование карточки, настройка показателей, выдача/отзыв доступа (организация, сиделка, сотрудники).
- **Организация**
  - Пансионат: все сотрудники, пока активны, видят дневник и карточку. Доступ можно отозвать полностью (`organization_id = NULL`).
  - Патронажное агентство: сотрудники ничего не видят по умолчанию. Доступ выдается через `diary_employee_access`.
- **Частная сиделка**: появляется в дневнике как `caregiver_id`. Если клиент убирает сиделку, она теряет доступ.
- **Сотрудник**: работает от имени организации; права зависят от роли (`admin/manager` могут управлять доступом, `caregiver/doctor` — только видеть и заполнять).

## Сценарии приглашений
### Организация → сотрудник
1. Создаёт токен `organization_invite_tokens` с полями `organization_id`, `organization_type`, `role`.
2. Сотрудник проходит регистрацию по телефону + пароль.
3. Edge Function создаёт `auth.users`, `organization_employees`, помечает токен `used_at`.
4. Если `organization_type = 'patronage_agency'`, доступ к дневникам появляется только после ручного назначения.

### Организация → клиент
1. Токен `organization_client_invite_tokens` (обязательно `patient_card_id`, опционально `diary_id`).
2. Клиент регистрируется, создаётся запись в `clients` и привязка к карточке/дневнику.
3. Организация сохраняет доступ как `organization_id` в дневнике; клиент может отозвать.

### Частная сиделка → клиент
1. Токен `caregiver_client_invite_tokens`.
2. Клиент регистрируется, получает дневник с `caregiver_id`.
3. Сиделка видит дневник по `caregiver_id`, клиент может убрать доступ.

## Миграция от фронта к Supabase
- Все локальные метаданные (`local_users`, `current_user`, `local_employees`, `auth_token`, `organization_invite_tokens` и др.) должны быть удалены из приложения после переключения на Supabase; переносить их в бэкенд **не планируется**, вместо этого создаются чистые записи.
- После каждого шага интеграции проверять, что фронтенд не обращается к `localStorage`.
- Edge Functions и RPC становятся единственной точкой генерации токенов и создания пользователей.

## Чеклист тестов по ролям
1. **Админ:** вход по токену, просмотр invite/user списков, создание приглашения, аудит.
2. **Пансионат:** регистрация, создание дневника, проверка автодоступа сотрудника.
3. **Патронажное агентство:** назначение сотрудника, отсутствие доступа без записи, отзыв доступа.
4. **Частная сиделка:** приглашение клиента, появление дневника с `caregiver_id`, отзыв доступа.
5. **Сотрудник:** флоу регистрации по приглашению, доступ к дневнику (пансионат — сразу, агентство — после назначения).
6. **Клиент:** регистрация, создание карточки и дневника, управление доступами, вход по ссылке.
