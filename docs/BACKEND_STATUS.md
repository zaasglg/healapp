# –°—Ç–∞—Ç—É—Å –ø–µ—Ä–µ–≤–æ–¥–∞ –Ω–∞ –±—ç–∫–µ–Ω–¥ (Supabase)

**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 12 –Ω–æ—è–±—Ä—è 2025

---

## ‚úÖ –£–ñ–ï –ù–ê –ë–≠–ö–ï–ù–î–ï (—á–µ—Ä–µ–∑ Supabase)

### 1. –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ (–®–∞–≥ 16.2)
- ‚úÖ **–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π:** RPC `generate_invite_link` 
- ‚úÖ **–û—Ç–∑—ã–≤ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π:** RPC `revoke_invite_link`
- ‚úÖ **–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π:** –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `invite_tokens`
- ‚úÖ **–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:** –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `organization_employees`
- ‚úÖ **–£–¥–∞–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:** —á–µ—Ä–µ–∑ Supabase DELETE

**–§–∞–π–ª—ã:** `src/pages/EmployeesPage.tsx`

### 2. –î–Ω–µ–≤–Ω–∏–∫–∏ (–®–∞–≥ 16.3)
- ‚úÖ **–°–æ–∑–¥–∞–Ω–∏–µ –¥–Ω–µ–≤–Ω–∏–∫–∞:** RPC `create_diary`
- ‚úÖ **–ó–∞–≥—Ä—É–∑–∫–∞ –¥–Ω–µ–≤–Ω–∏–∫–æ–≤:** –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `diaries` (DashboardPage)
- ‚úÖ **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:** RPC `assign_employee_to_diary`
- ‚úÖ **–û—Ç–∑—ã–≤ –¥–æ—Å—Ç—É–ø–∞:** RPC `remove_employee_from_diary`
- ‚úÖ **–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:** –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `diary_employee_access`

**–§–∞–π–ª—ã:** `src/pages/CreateDiaryPage.tsx`, `src/pages/DashboardPage.tsx`, `src/pages/DiaryPage.tsx`

### 3. –ú–µ—Ç—Ä–∏–∫–∏ –∏ –∏—Å—Ç–æ—Ä–∏—è (–®–∞–≥ 16.4)
- ‚úÖ **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫:** RPC `save_metric_value`
- ‚úÖ **–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏:** RPC `get_diary_history`
- ‚úÖ **–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ç—Ä–∏–∫:** –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `diary_metrics`
- ‚úÖ **–ó–∞–≥—Ä—É–∑–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–π:** –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `diary_metric_values`

**–§–∞–π–ª—ã:** `src/pages/DiaryPage.tsx`

---

## ‚ùå –ï–©–ï –ù–ê LOCALSTORAGE (–Ω—É–∂–Ω–æ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏)

### 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –≤—Ö–æ–¥
- ‚ùå **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:** —á–µ—Ä–µ–∑ localStorage (`local_users`)
- ‚ùå **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤:** —á–µ—Ä–µ–∑ localStorage (`local_clients`)
- ‚ùå **–í—Ö–æ–¥ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:** —á–µ—Ä–µ–∑ localStorage (`local_users`)
- ‚ùå **–í—Ö–æ–¥ –∫–ª–∏–µ–Ω—Ç–æ–≤:** —á–µ—Ä–µ–∑ localStorage (`local_clients`)

**–§–∞–π–ª—ã:** `src/pages/RegisterPage.tsx`, `src/pages/LoginPage.tsx`

**–ß—Ç–æ –Ω—É–∂–Ω–æ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Edge Function `accept_invite_token` –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

### 2. –ü—Ä–æ—Ñ–∏–ª–∏
- ‚ùå **–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏:** —á–∞—Å—Ç–∏—á–Ω–æ —á–µ—Ä–µ–∑ localStorage
- ‚ùå **–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è —Å–∏–¥–µ–ª–∫–∏:** —á–∞—Å—Ç–∏—á–Ω–æ —á–µ—Ä–µ–∑ localStorage
- ‚ùå **–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:** —á–µ—Ä–µ–∑ localStorage
- ‚ùå **–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –∫–ª–∏–µ–Ω—Ç–∞:** —á–µ—Ä–µ–∑ localStorage

**–§–∞–π–ª—ã:** `src/pages/ProfileSetupPage.tsx`, `src/pages/ProfileEditPage.tsx`

**–ß—Ç–æ –Ω—É–∂–Ω–æ:** –°–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—ã `organizations`, `organization_employees`, `clients`

### 3. –ö–∞—Ä—Ç–æ—á–∫–∏ –ø–æ–¥–æ–ø–µ—á–Ω—ã—Ö
- ‚ùå **–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫:** —á–µ—Ä–µ–∑ localStorage (`patient_cards`)
- ‚ùå **–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫:** —á–µ—Ä–µ–∑ localStorage
- ‚ùå **–£–¥–∞–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫:** —á–µ—Ä–µ–∑ localStorage

**–§–∞–π–ª—ã:** `src/pages/PatientCardsPage.tsx`, `src/pages/PatientCardFormPage.tsx`

**–ß—Ç–æ –Ω—É–∂–Ω–æ:** –°–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É `patient_cards`

### 4. –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤
- ‚ùå **–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è —á–∞—Å—Ç–Ω—ã—Ö —Å–∏–¥–µ–ª–æ–∫:** —á–µ—Ä–µ–∑ localStorage (`caregiver_client_invite_tokens`)
- ‚ùå **–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π:** —á–µ—Ä–µ–∑ localStorage (`organization_client_invite_tokens`)

**–§–∞–π–ª—ã:** `src/pages/InviteClientPage.tsx`, `src/pages/ClientInviteRegisterPage.tsx`

**–ß—Ç–æ –Ω—É–∂–Ω–æ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å RPC `generate_invite_link` —Å —Ç–∏–ø–æ–º `caregiver_client` –∏–ª–∏ `organization_client`

### 5. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–µ—Ç—Ä–∏–∫
- ‚ùå **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è:** —á–µ—Ä–µ–∑ localStorage (`diary_metric_settings`)

**–§–∞–π–ª—ã:** `src/pages/DiaryPage.tsx`

**–ß—Ç–æ –Ω—É–∂–Ω–æ:** –°–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ `diary_metrics.metadata.settings`

### 6. –°—Å—ã–ª–∫–∏ –¥–æ—Å—Ç—É–ø–∞
- ‚ùå **–°—Å—ã–ª–∫–∏ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤:** —á–µ—Ä–µ–∑ localStorage (`diary_client_links`)
- ‚ùå **–í–Ω–µ—à–Ω–∏–µ —Å—Å—ã–ª–∫–∏:** —á–µ—Ä–µ–∑ localStorage (`diary_external_access_links`)

**–§–∞–π–ª—ã:** `src/pages/DiaryPage.tsx`

**–ß—Ç–æ –Ω—É–∂–Ω–æ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å RPC `share_diary_with_client` –∏ —Ç–∞–±–ª–∏—Ü—É `diary_client_links`

### 7. –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
- ‚ùå **–í—Å–µ –¥–∞–Ω–Ω—ã–µ:** —á–µ—Ä–µ–∑ localStorage

**–§–∞–π–ª—ã:** `src/pages/admin/*`

**–ß—Ç–æ –Ω—É–∂–Ω–æ:** –°–æ–∑–¥–∞—Ç—å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∏ RPC –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ (–®–∞–≥ 16.5)

---

## üîß –ß–¢–û –ù–£–ñ–ù–û –°–î–ï–õ–ê–¢–¨ –°–ï–ô–ß–ê–°

### –®–∞–≥ 1: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

**–ì–¥–µ –≤—Å—Ç–∞–≤–ª—è—Ç—å SQL:**
1. –û—Ç–∫—Ä–æ–π—Ç–µ Supabase Dashboard: https://supabase.com/dashboard
2. –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –ø—Ä–æ–µ–∫—Ç
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **SQL Editor** (–≤ –ª–µ–≤–æ–º –º–µ–Ω—é)
4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ `supabase/migrations/20251112000002_014_fix_current_organization_id.sql`
5. –í—Å—Ç–∞–≤—å—Ç–µ –≤ SQL Editor
6. –ù–∞–∂–º–∏—Ç–µ **RUN** (–∏–ª–∏ Ctrl+Enter)

**–ò–ª–∏ —á–µ—Ä–µ–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:**
```bash
ssh root@176.124.217.224
cd /root/HealApp-Web
supabase db push
```

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã

–í SQL Editor –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞
SELECT pg_get_functiondef(oid) 
FROM pg_proc 
WHERE proname = 'current_organization_id';
```

–î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∞ `organizations.id where user_id = auth.uid()`

### –®–∞–≥ 3: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è

1. –í–æ–π–¥–∏—Ç–µ –∫–∞–∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏"
3. –°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É
4. –î–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –æ—à–∏–±–∫–∏ "organization_id is required"

---

## üìã –ü–õ–ê–ù –ü–û–≠–¢–ê–ü–ù–û–ì–û –ü–ï–†–ï–í–û–î–ê

### –≠—Ç–∞–ø 1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –æ—à–∏–±–∫–∏ (–°–ï–ô–ß–ê–°)
- [x] –ò—Å–ø—Ä–∞–≤–∏—Ç—å `employee_role` ‚Üí `role` –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö
- [x] –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `current_organization_id()`
- [ ] –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π

### –≠—Ç–∞–ø 2: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ Edge Function (–®–∞–≥ 16.1)
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `RegisterPage.tsx` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Edge Function `accept_invite_token`
- [ ] –£–±—Ä–∞—Ç—å localStorage –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
- [ ] –£–±—Ä–∞—Ç—å localStorage –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é

### –≠—Ç–∞–ø 3: –ü—Ä–æ—Ñ–∏–ª–∏ (–ø–æ—Å–ª–µ –≠—Ç–∞–ø–∞ 2)
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `ProfileSetupPage.tsx` –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Supabase
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `ProfileEditPage.tsx` –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Supabase
- [ ] –£–±—Ä–∞—Ç—å localStorage –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–µ–π

### –≠—Ç–∞–ø 4: –ö–∞—Ä—Ç–æ—á–∫–∏ –ø–æ–¥–æ–ø–µ—á–Ω—ã—Ö
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `PatientCardsPage.tsx` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Supabase
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `PatientCardFormPage.tsx` –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Supabase
- [ ] –£–±—Ä–∞—Ç—å localStorage –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫

### –≠—Ç–∞–ø 5: –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `InviteClientPage.tsx` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è RPC
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `ClientInviteRegisterPage.tsx` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Edge Function
- [ ] –£–±—Ä–∞—Ç—å localStorage –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π –∫–ª–∏–µ–Ω—Ç–æ–≤

### –≠—Ç–∞–ø 6: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —Å—Å—ã–ª–∫–∏
- [ ] –°–æ—Ö—Ä–∞–Ω—è—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–µ—Ç—Ä–∏–∫ –≤ `diary_metrics.metadata`
- [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å RPC –¥–ª—è —Å—Å—ã–ª–æ–∫ –¥–æ—Å—Ç—É–ø–∞
- [ ] –£–±—Ä–∞—Ç—å localStorage –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫

### –≠—Ç–∞–ø 7: –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (–®–∞–≥ 16.5)
- [ ] –°–æ–∑–¥–∞—Ç—å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
- [ ] –°–æ–∑–¥–∞—Ç—å RPC –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
- [ ] –û–±–Ω–æ–≤–∏—Ç—å –∞–¥–º–∏–Ω-—Å—Ç—Ä–∞–Ω–∏—Ü—ã

---

## ‚ö†Ô∏è –í–ê–ñ–ù–û

1. **Fallback –Ω–∞ localStorage:** –ü–æ–∫–∞ –æ—Å—Ç–∞–≤–ª—è–µ–º fallback –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏, –Ω–æ –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Supabase
2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞ –Ω—É–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
3. **–ú–∏–≥—Ä–∞—Ü–∏–∏:** –í—Å–µ SQL –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ —Ñ–∞–π–ª–∞—Ö –º–∏–≥—Ä–∞—Ü–∏–π
4. **SQL Editor:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ SQL Editor –≤ Supabase Dashboard –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL

