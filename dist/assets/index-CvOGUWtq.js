import{r as nc,b as ic,a as oc,c as u,R as tt,O as un,N as Eo,u as rt,d as Tr,e as Po,f as lc,h as Bt,L as cc,i as dc,j as Te,B as uc}from"./vendor-BLYH5sOE.js";import{c as Io}from"./supabase-CbeKR10q.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&a(o)}).observe(document,{childList:!0,subtree:!0});function s(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(n){if(n.ep)return;n.ep=!0;const i=s(n);fetch(n.href,i)}})();var Pa={exports:{}},Xr={};var gi;function mc(){if(gi)return Xr;gi=1;var e=nc(),r=Symbol.for("react.element"),s=Symbol.for("react.fragment"),a=Object.prototype.hasOwnProperty,n=e.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,i={key:!0,ref:!0,__self:!0,__source:!0};function o(c,g,_){var y,D={},w=null,I=null;_!==void 0&&(w=""+_),g.key!==void 0&&(w=""+g.key),g.ref!==void 0&&(I=g.ref);for(y in g)a.call(g,y)&&!i.hasOwnProperty(y)&&(D[y]=g[y]);if(c&&c.defaultProps)for(y in g=c.defaultProps,g)D[y]===void 0&&(D[y]=g[y]);return{$$typeof:r,type:c,key:w,ref:I,props:D,_owner:n.current}}return Xr.Fragment=s,Xr.jsx=o,Xr.jsxs=o,Xr}var pi;function hc(){return pi||(pi=1,Pa.exports=mc()),Pa.exports}var t=hc(),Rs={},xi;function fc(){if(xi)return Rs;xi=1;var e=ic();return Rs.createRoot=e.createRoot,Rs.hydrateRoot=e.hydrateRoot,Rs}var gc=fc();const pc=oc(gc);var ds=class{constructor(){this.listeners=new Set,this.subscribe=this.subscribe.bind(this)}subscribe(e){return this.listeners.add(e),this.onSubscribe(),()=>{this.listeners.delete(e),this.onUnsubscribe()}}hasListeners(){return this.listeners.size>0}onSubscribe(){}onUnsubscribe(){}},xc={setTimeout:(e,r)=>setTimeout(e,r),clearTimeout:e=>clearTimeout(e),setInterval:(e,r)=>setInterval(e,r),clearInterval:e=>clearInterval(e)},yc=class{#e=xc;#t=!1;setTimeoutProvider(e){this.#e=e}setTimeout(e,r){return this.#e.setTimeout(e,r)}clearTimeout(e){this.#e.clearTimeout(e)}setInterval(e,r){return this.#e.setInterval(e,r)}clearInterval(e){this.#e.clearInterval(e)}},xr=new yc;function bc(e){setTimeout(e,0)}var br=typeof window>"u"||"Deno"in globalThis;function ft(){}function _c(e,r){return typeof e=="function"?e(r):e}function Ja(e){return typeof e=="number"&&e>=0&&e!==1/0}function $o(e,r){return Math.max(e+(r||0)-Date.now(),0)}function or(e,r){return typeof e=="function"?e(r):e}function Dt(e,r){return typeof e=="function"?e(r):e}function yi(e,r){const{type:s="all",exact:a,fetchStatus:n,predicate:i,queryKey:o,stale:c}=e;if(o){if(a){if(r.queryHash!==mn(o,r.options))return!1}else if(!os(r.queryKey,o))return!1}if(s!=="all"){const g=r.isActive();if(s==="active"&&!g||s==="inactive"&&g)return!1}return!(typeof c=="boolean"&&r.isStale()!==c||n&&n!==r.state.fetchStatus||i&&!i(r))}function bi(e,r){const{exact:s,status:a,predicate:n,mutationKey:i}=e;if(i){if(!r.options.mutationKey)return!1;if(s){if(is(r.options.mutationKey)!==is(i))return!1}else if(!os(r.options.mutationKey,i))return!1}return!(a&&r.state.status!==a||n&&!n(r))}function mn(e,r){return(r?.queryKeyHashFn||is)(e)}function is(e){return JSON.stringify(e,(r,s)=>Ka(s)?Object.keys(s).sort().reduce((a,n)=>(a[n]=s[n],a),{}):s)}function os(e,r){return e===r?!0:typeof e!=typeof r?!1:e&&r&&typeof e=="object"&&typeof r=="object"?Object.keys(r).every(s=>os(e[s],r[s])):!1}var vc=Object.prototype.hasOwnProperty;function Mo(e,r){if(e===r)return e;const s=_i(e)&&_i(r);if(!s&&!(Ka(e)&&Ka(r)))return r;const n=(s?e:Object.keys(e)).length,i=s?r:Object.keys(r),o=i.length,c=s?new Array(o):{};let g=0;for(let _=0;_<o;_++){const y=s?_:i[_],D=e[y],w=r[y];if(D===w){c[y]=D,(s?_<n:vc.call(e,y))&&g++;continue}if(D===null||w===null||typeof D!="object"||typeof w!="object"){c[y]=w;continue}const I=Mo(D,w);c[y]=I,I===D&&g++}return n===o&&g===n?e:c}function Qa(e,r){if(!r||Object.keys(e).length!==Object.keys(r).length)return!1;for(const s in e)if(e[s]!==r[s])return!1;return!0}function _i(e){return Array.isArray(e)&&e.length===Object.keys(e).length}function Ka(e){if(!vi(e))return!1;const r=e.constructor;if(r===void 0)return!0;const s=r.prototype;return!(!vi(s)||!s.hasOwnProperty("isPrototypeOf")||Object.getPrototypeOf(e)!==Object.prototype)}function vi(e){return Object.prototype.toString.call(e)==="[object Object]"}function jc(e){return new Promise(r=>{xr.setTimeout(r,e)})}function Ga(e,r,s){return typeof s.structuralSharing=="function"?s.structuralSharing(e,r):s.structuralSharing!==!1?Mo(e,r):r}function wc(e,r,s=0){const a=[...e,r];return s&&a.length>s?a.slice(1):a}function Nc(e,r,s=0){const a=[r,...e];return s&&a.length>s?a.slice(0,-1):a}var hn=Symbol();function To(e,r){return!e.queryFn&&r?.initialPromise?()=>r.initialPromise:!e.queryFn||e.queryFn===hn?()=>Promise.reject(new Error(`Missing queryFn: '${e.queryHash}'`)):e.queryFn}function kc(e,r){return typeof e=="function"?e(...r):!!e}var Ac=class extends ds{#e;#t;#r;constructor(){super(),this.#r=e=>{if(!br&&window.addEventListener){const r=()=>e();return window.addEventListener("visibilitychange",r,!1),()=>{window.removeEventListener("visibilitychange",r)}}}}onSubscribe(){this.#t||this.setEventListener(this.#r)}onUnsubscribe(){this.hasListeners()||(this.#t?.(),this.#t=void 0)}setEventListener(e){this.#r=e,this.#t?.(),this.#t=e(r=>{typeof r=="boolean"?this.setFocused(r):this.onFocus()})}setFocused(e){this.#e!==e&&(this.#e=e,this.onFocus())}onFocus(){const e=this.isFocused();this.listeners.forEach(r=>{r(e)})}isFocused(){return typeof this.#e=="boolean"?this.#e:globalThis.document?.visibilityState!=="hidden"}},fn=new Ac;function Ha(){let e,r;const s=new Promise((n,i)=>{e=n,r=i});s.status="pending",s.catch(()=>{});function a(n){Object.assign(s,n),delete s.resolve,delete s.reject}return s.resolve=n=>{a({status:"fulfilled",value:n}),e(n)},s.reject=n=>{a({status:"rejected",reason:n}),r(n)},s}var Cc=bc;function Sc(){let e=[],r=0,s=c=>{c()},a=c=>{c()},n=Cc;const i=c=>{r?e.push(c):n(()=>{s(c)})},o=()=>{const c=e;e=[],c.length&&n(()=>{a(()=>{c.forEach(g=>{s(g)})})})};return{batch:c=>{let g;r++;try{g=c()}finally{r--,r||o()}return g},batchCalls:c=>(...g)=>{i(()=>{c(...g)})},schedule:i,setNotifyFunction:c=>{s=c},setBatchNotifyFunction:c=>{a=c},setScheduler:c=>{n=c}}}var at=Sc(),Dc=class extends ds{#e=!0;#t;#r;constructor(){super(),this.#r=e=>{if(!br&&window.addEventListener){const r=()=>e(!0),s=()=>e(!1);return window.addEventListener("online",r,!1),window.addEventListener("offline",s,!1),()=>{window.removeEventListener("online",r),window.removeEventListener("offline",s)}}}}onSubscribe(){this.#t||this.setEventListener(this.#r)}onUnsubscribe(){this.hasListeners()||(this.#t?.(),this.#t=void 0)}setEventListener(e){this.#r=e,this.#t?.(),this.#t=e(this.setOnline.bind(this))}setOnline(e){this.#e!==e&&(this.#e=e,this.listeners.forEach(s=>{s(e)}))}isOnline(){return this.#e}},Qs=new Dc;function zc(e){return Math.min(1e3*2**e,3e4)}function Ro(e){return(e??"online")==="online"?Qs.isOnline():!0}var Ya=class extends Error{constructor(e){super("CancelledError"),this.revert=e?.revert,this.silent=e?.silent}};function Fo(e){let r=!1,s=0,a;const n=Ha(),i=()=>n.status!=="pending",o=C=>{if(!i()){const B=new Ya(C);w(B),e.onCancel?.(B)}},c=()=>{r=!0},g=()=>{r=!1},_=()=>fn.isFocused()&&(e.networkMode==="always"||Qs.isOnline())&&e.canRun(),y=()=>Ro(e.networkMode)&&e.canRun(),D=C=>{i()||(a?.(),n.resolve(C))},w=C=>{i()||(a?.(),n.reject(C))},I=()=>new Promise(C=>{a=B=>{(i()||_())&&C(B)},e.onPause?.()}).then(()=>{a=void 0,i()||e.onContinue?.()}),P=()=>{if(i())return;let C;const B=s===0?e.initialPromise:void 0;try{C=B??e.fn()}catch(O){C=Promise.reject(O)}Promise.resolve(C).then(D).catch(O=>{if(i())return;const $=e.retry??(br?0:3),p=e.retryDelay??zc,k=typeof p=="function"?p(s,O):p,f=$===!0||typeof $=="number"&&s<$||typeof $=="function"&&$(s,O);if(r||!f){w(O);return}s++,e.onFail?.(s,O),jc(k).then(()=>_()?void 0:I()).then(()=>{r?w(O):P()})})};return{promise:n,status:()=>n.status,cancel:o,continue:()=>(a?.(),n),cancelRetry:c,continueRetry:g,canStart:y,start:()=>(y()?P():I().then(P),n)}}var Oo=class{#e;destroy(){this.clearGcTimeout()}scheduleGc(){this.clearGcTimeout(),Ja(this.gcTime)&&(this.#e=xr.setTimeout(()=>{this.optionalRemove()},this.gcTime))}updateGcTime(e){this.gcTime=Math.max(this.gcTime||0,e??(br?1/0:300*1e3))}clearGcTimeout(){this.#e&&(xr.clearTimeout(this.#e),this.#e=void 0)}},Ec=class extends Oo{#e;#t;#r;#a;#s;#o;#i;constructor(e){super(),this.#i=!1,this.#o=e.defaultOptions,this.setOptions(e.options),this.observers=[],this.#a=e.client,this.#r=this.#a.getQueryCache(),this.queryKey=e.queryKey,this.queryHash=e.queryHash,this.#e=wi(this.options),this.state=e.state??this.#e,this.scheduleGc()}get meta(){return this.options.meta}get promise(){return this.#s?.promise}setOptions(e){if(this.options={...this.#o,...e},this.updateGcTime(this.options.gcTime),this.state&&this.state.data===void 0){const r=wi(this.options);r.data!==void 0&&(this.setState(ji(r.data,r.dataUpdatedAt)),this.#e=r)}}optionalRemove(){!this.observers.length&&this.state.fetchStatus==="idle"&&this.#r.remove(this)}setData(e,r){const s=Ga(this.state.data,e,this.options);return this.#n({data:s,type:"success",dataUpdatedAt:r?.updatedAt,manual:r?.manual}),s}setState(e,r){this.#n({type:"setState",state:e,setStateOptions:r})}cancel(e){const r=this.#s?.promise;return this.#s?.cancel(e),r?r.then(ft).catch(ft):Promise.resolve()}destroy(){super.destroy(),this.cancel({silent:!0})}reset(){this.destroy(),this.setState(this.#e)}isActive(){return this.observers.some(e=>Dt(e.options.enabled,this)!==!1)}isDisabled(){return this.getObserversCount()>0?!this.isActive():this.options.queryFn===hn||this.state.dataUpdateCount+this.state.errorUpdateCount===0}isStatic(){return this.getObserversCount()>0?this.observers.some(e=>or(e.options.staleTime,this)==="static"):!1}isStale(){return this.getObserversCount()>0?this.observers.some(e=>e.getCurrentResult().isStale):this.state.data===void 0||this.state.isInvalidated}isStaleByTime(e=0){return this.state.data===void 0?!0:e==="static"?!1:this.state.isInvalidated?!0:!$o(this.state.dataUpdatedAt,e)}onFocus(){this.observers.find(r=>r.shouldFetchOnWindowFocus())?.refetch({cancelRefetch:!1}),this.#s?.continue()}onOnline(){this.observers.find(r=>r.shouldFetchOnReconnect())?.refetch({cancelRefetch:!1}),this.#s?.continue()}addObserver(e){this.observers.includes(e)||(this.observers.push(e),this.clearGcTimeout(),this.#r.notify({type:"observerAdded",query:this,observer:e}))}removeObserver(e){this.observers.includes(e)&&(this.observers=this.observers.filter(r=>r!==e),this.observers.length||(this.#s&&(this.#i?this.#s.cancel({revert:!0}):this.#s.cancelRetry()),this.scheduleGc()),this.#r.notify({type:"observerRemoved",query:this,observer:e}))}getObserversCount(){return this.observers.length}invalidate(){this.state.isInvalidated||this.#n({type:"invalidate"})}async fetch(e,r){if(this.state.fetchStatus!=="idle"&&this.#s?.status()!=="rejected"){if(this.state.data!==void 0&&r?.cancelRefetch)this.cancel({silent:!0});else if(this.#s)return this.#s.continueRetry(),this.#s.promise}if(e&&this.setOptions(e),!this.options.queryFn){const c=this.observers.find(g=>g.options.queryFn);c&&this.setOptions(c.options)}const s=new AbortController,a=c=>{Object.defineProperty(c,"signal",{enumerable:!0,get:()=>(this.#i=!0,s.signal)})},n=()=>{const c=To(this.options,r),_=(()=>{const y={client:this.#a,queryKey:this.queryKey,meta:this.meta};return a(y),y})();return this.#i=!1,this.options.persister?this.options.persister(c,_,this):c(_)},o=(()=>{const c={fetchOptions:r,options:this.options,queryKey:this.queryKey,client:this.#a,state:this.state,fetchFn:n};return a(c),c})();this.options.behavior?.onFetch(o,this),this.#t=this.state,(this.state.fetchStatus==="idle"||this.state.fetchMeta!==o.fetchOptions?.meta)&&this.#n({type:"fetch",meta:o.fetchOptions?.meta}),this.#s=Fo({initialPromise:r?.initialPromise,fn:o.fetchFn,onCancel:c=>{c instanceof Ya&&c.revert&&this.setState({...this.#t,fetchStatus:"idle"}),s.abort()},onFail:(c,g)=>{this.#n({type:"failed",failureCount:c,error:g})},onPause:()=>{this.#n({type:"pause"})},onContinue:()=>{this.#n({type:"continue"})},retry:o.options.retry,retryDelay:o.options.retryDelay,networkMode:o.options.networkMode,canRun:()=>!0});try{const c=await this.#s.start();if(c===void 0)throw new Error(`${this.queryHash} data is undefined`);return this.setData(c),this.#r.config.onSuccess?.(c,this),this.#r.config.onSettled?.(c,this.state.error,this),c}catch(c){if(c instanceof Ya){if(c.silent)return this.#s.promise;if(c.revert){if(this.state.data===void 0)throw c;return this.state.data}}throw this.#n({type:"error",error:c}),this.#r.config.onError?.(c,this),this.#r.config.onSettled?.(this.state.data,c,this),c}finally{this.scheduleGc()}}#n(e){const r=s=>{switch(e.type){case"failed":return{...s,fetchFailureCount:e.failureCount,fetchFailureReason:e.error};case"pause":return{...s,fetchStatus:"paused"};case"continue":return{...s,fetchStatus:"fetching"};case"fetch":return{...s,...Lo(s.data,this.options),fetchMeta:e.meta??null};case"success":const a={...s,...ji(e.data,e.dataUpdatedAt),dataUpdateCount:s.dataUpdateCount+1,...!e.manual&&{fetchStatus:"idle",fetchFailureCount:0,fetchFailureReason:null}};return this.#t=e.manual?a:void 0,a;case"error":const n=e.error;return{...s,error:n,errorUpdateCount:s.errorUpdateCount+1,errorUpdatedAt:Date.now(),fetchFailureCount:s.fetchFailureCount+1,fetchFailureReason:n,fetchStatus:"idle",status:"error"};case"invalidate":return{...s,isInvalidated:!0};case"setState":return{...s,...e.state}}};this.state=r(this.state),at.batch(()=>{this.observers.forEach(s=>{s.onQueryUpdate()}),this.#r.notify({query:this,type:"updated",action:e})})}};function Lo(e,r){return{fetchFailureCount:0,fetchFailureReason:null,fetchStatus:Ro(r.networkMode)?"fetching":"paused",...e===void 0&&{error:null,status:"pending"}}}function ji(e,r){return{data:e,dataUpdatedAt:r??Date.now(),error:null,isInvalidated:!1,status:"success"}}function wi(e){const r=typeof e.initialData=="function"?e.initialData():e.initialData,s=r!==void 0,a=s?typeof e.initialDataUpdatedAt=="function"?e.initialDataUpdatedAt():e.initialDataUpdatedAt:0;return{data:r,dataUpdateCount:0,dataUpdatedAt:s?a??Date.now():0,error:null,errorUpdateCount:0,errorUpdatedAt:0,fetchFailureCount:0,fetchFailureReason:null,fetchMeta:null,isInvalidated:!1,status:s?"success":"pending",fetchStatus:"idle"}}var Pc=class extends ds{constructor(e,r){super(),this.options=r,this.#e=e,this.#n=null,this.#i=Ha(),this.bindMethods(),this.setOptions(r)}#e;#t=void 0;#r=void 0;#a=void 0;#s;#o;#i;#n;#g;#m;#h;#c;#d;#l;#f=new Set;bindMethods(){this.refetch=this.refetch.bind(this)}onSubscribe(){this.listeners.size===1&&(this.#t.addObserver(this),Ni(this.#t,this.options)?this.#u():this.updateResult(),this.#b())}onUnsubscribe(){this.hasListeners()||this.destroy()}shouldFetchOnReconnect(){return Xa(this.#t,this.options,this.options.refetchOnReconnect)}shouldFetchOnWindowFocus(){return Xa(this.#t,this.options,this.options.refetchOnWindowFocus)}destroy(){this.listeners=new Set,this.#_(),this.#v(),this.#t.removeObserver(this)}setOptions(e){const r=this.options,s=this.#t;if(this.options=this.#e.defaultQueryOptions(e),this.options.enabled!==void 0&&typeof this.options.enabled!="boolean"&&typeof this.options.enabled!="function"&&typeof Dt(this.options.enabled,this.#t)!="boolean")throw new Error("Expected enabled to be a boolean or a callback that returns a boolean");this.#j(),this.#t.setOptions(this.options),r._defaulted&&!Qa(this.options,r)&&this.#e.getQueryCache().notify({type:"observerOptionsUpdated",query:this.#t,observer:this});const a=this.hasListeners();a&&ki(this.#t,s,this.options,r)&&this.#u(),this.updateResult(),a&&(this.#t!==s||Dt(this.options.enabled,this.#t)!==Dt(r.enabled,this.#t)||or(this.options.staleTime,this.#t)!==or(r.staleTime,this.#t))&&this.#p();const n=this.#x();a&&(this.#t!==s||Dt(this.options.enabled,this.#t)!==Dt(r.enabled,this.#t)||n!==this.#l)&&this.#y(n)}getOptimisticResult(e){const r=this.#e.getQueryCache().build(this.#e,e),s=this.createResult(r,e);return $c(this,s)&&(this.#a=s,this.#o=this.options,this.#s=this.#t.state),s}getCurrentResult(){return this.#a}trackResult(e,r){return new Proxy(e,{get:(s,a)=>(this.trackProp(a),r?.(a),a==="promise"&&(this.trackProp("data"),!this.options.experimental_prefetchInRender&&this.#i.status==="pending"&&this.#i.reject(new Error("experimental_prefetchInRender feature flag is not enabled"))),Reflect.get(s,a))})}trackProp(e){this.#f.add(e)}getCurrentQuery(){return this.#t}refetch({...e}={}){return this.fetch({...e})}fetchOptimistic(e){const r=this.#e.defaultQueryOptions(e),s=this.#e.getQueryCache().build(this.#e,r);return s.fetch().then(()=>this.createResult(s,r))}fetch(e){return this.#u({...e,cancelRefetch:e.cancelRefetch??!0}).then(()=>(this.updateResult(),this.#a))}#u(e){this.#j();let r=this.#t.fetch(this.options,e);return e?.throwOnError||(r=r.catch(ft)),r}#p(){this.#_();const e=or(this.options.staleTime,this.#t);if(br||this.#a.isStale||!Ja(e))return;const s=$o(this.#a.dataUpdatedAt,e)+1;this.#c=xr.setTimeout(()=>{this.#a.isStale||this.updateResult()},s)}#x(){return(typeof this.options.refetchInterval=="function"?this.options.refetchInterval(this.#t):this.options.refetchInterval)??!1}#y(e){this.#v(),this.#l=e,!(br||Dt(this.options.enabled,this.#t)===!1||!Ja(this.#l)||this.#l===0)&&(this.#d=xr.setInterval(()=>{(this.options.refetchIntervalInBackground||fn.isFocused())&&this.#u()},this.#l))}#b(){this.#p(),this.#y(this.#x())}#_(){this.#c&&(xr.clearTimeout(this.#c),this.#c=void 0)}#v(){this.#d&&(xr.clearInterval(this.#d),this.#d=void 0)}createResult(e,r){const s=this.#t,a=this.options,n=this.#a,i=this.#s,o=this.#o,g=e!==s?e.state:this.#r,{state:_}=e;let y={..._},D=!1,w;if(r._optimisticResults){const H=this.hasListeners(),M=!H&&Ni(e,r),L=H&&ki(e,s,r,a);(M||L)&&(y={...y,...Lo(_.data,e.options)}),r._optimisticResults==="isRestoring"&&(y.fetchStatus="idle")}let{error:I,errorUpdatedAt:P,status:C}=y;w=y.data;let B=!1;if(r.placeholderData!==void 0&&w===void 0&&C==="pending"){let H;n?.isPlaceholderData&&r.placeholderData===o?.placeholderData?(H=n.data,B=!0):H=typeof r.placeholderData=="function"?r.placeholderData(this.#h?.state.data,this.#h):r.placeholderData,H!==void 0&&(C="success",w=Ga(n?.data,H,r),D=!0)}if(r.select&&w!==void 0&&!B)if(n&&w===i?.data&&r.select===this.#g)w=this.#m;else try{this.#g=r.select,w=r.select(w),w=Ga(n?.data,w,r),this.#m=w,this.#n=null}catch(H){this.#n=H}this.#n&&(I=this.#n,w=this.#m,P=Date.now(),C="error");const O=y.fetchStatus==="fetching",$=C==="pending",p=C==="error",k=$&&O,f=w!==void 0,F={status:C,fetchStatus:y.fetchStatus,isPending:$,isSuccess:C==="success",isError:p,isInitialLoading:k,isLoading:k,data:w,dataUpdatedAt:y.dataUpdatedAt,error:I,errorUpdatedAt:P,failureCount:y.fetchFailureCount,failureReason:y.fetchFailureReason,errorUpdateCount:y.errorUpdateCount,isFetched:y.dataUpdateCount>0||y.errorUpdateCount>0,isFetchedAfterMount:y.dataUpdateCount>g.dataUpdateCount||y.errorUpdateCount>g.errorUpdateCount,isFetching:O,isRefetching:O&&!$,isLoadingError:p&&!f,isPaused:y.fetchStatus==="paused",isPlaceholderData:D,isRefetchError:p&&f,isStale:gn(e,r),refetch:this.refetch,promise:this.#i,isEnabled:Dt(r.enabled,e)!==!1};if(this.options.experimental_prefetchInRender){const H=U=>{F.status==="error"?U.reject(F.error):F.data!==void 0&&U.resolve(F.data)},M=()=>{const U=this.#i=F.promise=Ha();H(U)},L=this.#i;switch(L.status){case"pending":e.queryHash===s.queryHash&&H(L);break;case"fulfilled":(F.status==="error"||F.data!==L.value)&&M();break;case"rejected":(F.status!=="error"||F.error!==L.reason)&&M();break}}return F}updateResult(){const e=this.#a,r=this.createResult(this.#t,this.options);if(this.#s=this.#t.state,this.#o=this.options,this.#s.data!==void 0&&(this.#h=this.#t),Qa(r,e))return;this.#a=r;const s=()=>{if(!e)return!0;const{notifyOnChangeProps:a}=this.options,n=typeof a=="function"?a():a;if(n==="all"||!n&&!this.#f.size)return!0;const i=new Set(n??this.#f);return this.options.throwOnError&&i.add("error"),Object.keys(this.#a).some(o=>{const c=o;return this.#a[c]!==e[c]&&i.has(c)})};this.#w({listeners:s()})}#j(){const e=this.#e.getQueryCache().build(this.#e,this.options);if(e===this.#t)return;const r=this.#t;this.#t=e,this.#r=e.state,this.hasListeners()&&(r?.removeObserver(this),e.addObserver(this))}onQueryUpdate(){this.updateResult(),this.hasListeners()&&this.#b()}#w(e){at.batch(()=>{e.listeners&&this.listeners.forEach(r=>{r(this.#a)}),this.#e.getQueryCache().notify({query:this.#t,type:"observerResultsUpdated"})})}};function Ic(e,r){return Dt(r.enabled,e)!==!1&&e.state.data===void 0&&!(e.state.status==="error"&&r.retryOnMount===!1)}function Ni(e,r){return Ic(e,r)||e.state.data!==void 0&&Xa(e,r,r.refetchOnMount)}function Xa(e,r,s){if(Dt(r.enabled,e)!==!1&&or(r.staleTime,e)!=="static"){const a=typeof s=="function"?s(e):s;return a==="always"||a!==!1&&gn(e,r)}return!1}function ki(e,r,s,a){return(e!==r||Dt(a.enabled,e)===!1)&&(!s.suspense||e.state.status!=="error")&&gn(e,s)}function gn(e,r){return Dt(r.enabled,e)!==!1&&e.isStaleByTime(or(r.staleTime,e))}function $c(e,r){return!Qa(e.getCurrentResult(),r)}function Ai(e){return{onFetch:(r,s)=>{const a=r.options,n=r.fetchOptions?.meta?.fetchMore?.direction,i=r.state.data?.pages||[],o=r.state.data?.pageParams||[];let c={pages:[],pageParams:[]},g=0;const _=async()=>{let y=!1;const D=P=>{Object.defineProperty(P,"signal",{enumerable:!0,get:()=>(r.signal.aborted?y=!0:r.signal.addEventListener("abort",()=>{y=!0}),r.signal)})},w=To(r.options,r.fetchOptions),I=async(P,C,B)=>{if(y)return Promise.reject();if(C==null&&P.pages.length)return Promise.resolve(P);const $=(()=>{const x={client:r.client,queryKey:r.queryKey,pageParam:C,direction:B?"backward":"forward",meta:r.options.meta};return D(x),x})(),p=await w($),{maxPages:k}=r.options,f=B?Nc:wc;return{pages:f(P.pages,p,k),pageParams:f(P.pageParams,C,k)}};if(n&&i.length){const P=n==="backward",C=P?Mc:Ci,B={pages:i,pageParams:o},O=C(a,B);c=await I(B,O,P)}else{const P=e??i.length;do{const C=g===0?o[0]??a.initialPageParam:Ci(a,c);if(g>0&&C==null)break;c=await I(c,C),g++}while(g<P)}return c};r.options.persister?r.fetchFn=()=>r.options.persister?.(_,{client:r.client,queryKey:r.queryKey,meta:r.options.meta,signal:r.signal},s):r.fetchFn=_}}}function Ci(e,{pages:r,pageParams:s}){const a=r.length-1;return r.length>0?e.getNextPageParam(r[a],r,s[a],s):void 0}function Mc(e,{pages:r,pageParams:s}){return r.length>0?e.getPreviousPageParam?.(r[0],r,s[0],s):void 0}var Tc=class extends Oo{#e;#t;#r;#a;constructor(e){super(),this.#e=e.client,this.mutationId=e.mutationId,this.#r=e.mutationCache,this.#t=[],this.state=e.state||Rc(),this.setOptions(e.options),this.scheduleGc()}setOptions(e){this.options=e,this.updateGcTime(this.options.gcTime)}get meta(){return this.options.meta}addObserver(e){this.#t.includes(e)||(this.#t.push(e),this.clearGcTimeout(),this.#r.notify({type:"observerAdded",mutation:this,observer:e}))}removeObserver(e){this.#t=this.#t.filter(r=>r!==e),this.scheduleGc(),this.#r.notify({type:"observerRemoved",mutation:this,observer:e})}optionalRemove(){this.#t.length||(this.state.status==="pending"?this.scheduleGc():this.#r.remove(this))}continue(){return this.#a?.continue()??this.execute(this.state.variables)}async execute(e){const r=()=>{this.#s({type:"continue"})},s={client:this.#e,meta:this.options.meta,mutationKey:this.options.mutationKey};this.#a=Fo({fn:()=>this.options.mutationFn?this.options.mutationFn(e,s):Promise.reject(new Error("No mutationFn found")),onFail:(i,o)=>{this.#s({type:"failed",failureCount:i,error:o})},onPause:()=>{this.#s({type:"pause"})},onContinue:r,retry:this.options.retry??0,retryDelay:this.options.retryDelay,networkMode:this.options.networkMode,canRun:()=>this.#r.canRun(this)});const a=this.state.status==="pending",n=!this.#a.canStart();try{if(a)r();else{this.#s({type:"pending",variables:e,isPaused:n}),await this.#r.config.onMutate?.(e,this,s);const o=await this.options.onMutate?.(e,s);o!==this.state.context&&this.#s({type:"pending",context:o,variables:e,isPaused:n})}const i=await this.#a.start();return await this.#r.config.onSuccess?.(i,e,this.state.context,this,s),await this.options.onSuccess?.(i,e,this.state.context,s),await this.#r.config.onSettled?.(i,null,this.state.variables,this.state.context,this,s),await this.options.onSettled?.(i,null,e,this.state.context,s),this.#s({type:"success",data:i}),i}catch(i){try{throw await this.#r.config.onError?.(i,e,this.state.context,this,s),await this.options.onError?.(i,e,this.state.context,s),await this.#r.config.onSettled?.(void 0,i,this.state.variables,this.state.context,this,s),await this.options.onSettled?.(void 0,i,e,this.state.context,s),i}finally{this.#s({type:"error",error:i})}}finally{this.#r.runNext(this)}}#s(e){const r=s=>{switch(e.type){case"failed":return{...s,failureCount:e.failureCount,failureReason:e.error};case"pause":return{...s,isPaused:!0};case"continue":return{...s,isPaused:!1};case"pending":return{...s,context:e.context,data:void 0,failureCount:0,failureReason:null,error:null,isPaused:e.isPaused,status:"pending",variables:e.variables,submittedAt:Date.now()};case"success":return{...s,data:e.data,failureCount:0,failureReason:null,error:null,status:"success",isPaused:!1};case"error":return{...s,data:void 0,error:e.error,failureCount:s.failureCount+1,failureReason:e.error,isPaused:!1,status:"error"}}};this.state=r(this.state),at.batch(()=>{this.#t.forEach(s=>{s.onMutationUpdate(e)}),this.#r.notify({mutation:this,type:"updated",action:e})})}};function Rc(){return{context:void 0,data:void 0,error:null,failureCount:0,failureReason:null,isPaused:!1,status:"idle",variables:void 0,submittedAt:0}}var Fc=class extends ds{constructor(e={}){super(),this.config=e,this.#e=new Set,this.#t=new Map,this.#r=0}#e;#t;#r;build(e,r,s){const a=new Tc({client:e,mutationCache:this,mutationId:++this.#r,options:e.defaultMutationOptions(r),state:s});return this.add(a),a}add(e){this.#e.add(e);const r=Fs(e);if(typeof r=="string"){const s=this.#t.get(r);s?s.push(e):this.#t.set(r,[e])}this.notify({type:"added",mutation:e})}remove(e){if(this.#e.delete(e)){const r=Fs(e);if(typeof r=="string"){const s=this.#t.get(r);if(s)if(s.length>1){const a=s.indexOf(e);a!==-1&&s.splice(a,1)}else s[0]===e&&this.#t.delete(r)}}this.notify({type:"removed",mutation:e})}canRun(e){const r=Fs(e);if(typeof r=="string"){const a=this.#t.get(r)?.find(n=>n.state.status==="pending");return!a||a===e}else return!0}runNext(e){const r=Fs(e);return typeof r=="string"?this.#t.get(r)?.find(a=>a!==e&&a.state.isPaused)?.continue()??Promise.resolve():Promise.resolve()}clear(){at.batch(()=>{this.#e.forEach(e=>{this.notify({type:"removed",mutation:e})}),this.#e.clear(),this.#t.clear()})}getAll(){return Array.from(this.#e)}find(e){const r={exact:!0,...e};return this.getAll().find(s=>bi(r,s))}findAll(e={}){return this.getAll().filter(r=>bi(e,r))}notify(e){at.batch(()=>{this.listeners.forEach(r=>{r(e)})})}resumePausedMutations(){const e=this.getAll().filter(r=>r.state.isPaused);return at.batch(()=>Promise.all(e.map(r=>r.continue().catch(ft))))}};function Fs(e){return e.options.scope?.id}var Oc=class extends ds{constructor(e={}){super(),this.config=e,this.#e=new Map}#e;build(e,r,s){const a=r.queryKey,n=r.queryHash??mn(a,r);let i=this.get(n);return i||(i=new Ec({client:e,queryKey:a,queryHash:n,options:e.defaultQueryOptions(r),state:s,defaultOptions:e.getQueryDefaults(a)}),this.add(i)),i}add(e){this.#e.has(e.queryHash)||(this.#e.set(e.queryHash,e),this.notify({type:"added",query:e}))}remove(e){const r=this.#e.get(e.queryHash);r&&(e.destroy(),r===e&&this.#e.delete(e.queryHash),this.notify({type:"removed",query:e}))}clear(){at.batch(()=>{this.getAll().forEach(e=>{this.remove(e)})})}get(e){return this.#e.get(e)}getAll(){return[...this.#e.values()]}find(e){const r={exact:!0,...e};return this.getAll().find(s=>yi(r,s))}findAll(e={}){const r=this.getAll();return Object.keys(e).length>0?r.filter(s=>yi(e,s)):r}notify(e){at.batch(()=>{this.listeners.forEach(r=>{r(e)})})}onFocus(){at.batch(()=>{this.getAll().forEach(e=>{e.onFocus()})})}onOnline(){at.batch(()=>{this.getAll().forEach(e=>{e.onOnline()})})}},Lc=class{#e;#t;#r;#a;#s;#o;#i;#n;constructor(e={}){this.#e=e.queryCache||new Oc,this.#t=e.mutationCache||new Fc,this.#r=e.defaultOptions||{},this.#a=new Map,this.#s=new Map,this.#o=0}mount(){this.#o++,this.#o===1&&(this.#i=fn.subscribe(async e=>{e&&(await this.resumePausedMutations(),this.#e.onFocus())}),this.#n=Qs.subscribe(async e=>{e&&(await this.resumePausedMutations(),this.#e.onOnline())}))}unmount(){this.#o--,this.#o===0&&(this.#i?.(),this.#i=void 0,this.#n?.(),this.#n=void 0)}isFetching(e){return this.#e.findAll({...e,fetchStatus:"fetching"}).length}isMutating(e){return this.#t.findAll({...e,status:"pending"}).length}getQueryData(e){const r=this.defaultQueryOptions({queryKey:e});return this.#e.get(r.queryHash)?.state.data}ensureQueryData(e){const r=this.defaultQueryOptions(e),s=this.#e.build(this,r),a=s.state.data;return a===void 0?this.fetchQuery(e):(e.revalidateIfStale&&s.isStaleByTime(or(r.staleTime,s))&&this.prefetchQuery(r),Promise.resolve(a))}getQueriesData(e){return this.#e.findAll(e).map(({queryKey:r,state:s})=>{const a=s.data;return[r,a]})}setQueryData(e,r,s){const a=this.defaultQueryOptions({queryKey:e}),i=this.#e.get(a.queryHash)?.state.data,o=_c(r,i);if(o!==void 0)return this.#e.build(this,a).setData(o,{...s,manual:!0})}setQueriesData(e,r,s){return at.batch(()=>this.#e.findAll(e).map(({queryKey:a})=>[a,this.setQueryData(a,r,s)]))}getQueryState(e){const r=this.defaultQueryOptions({queryKey:e});return this.#e.get(r.queryHash)?.state}removeQueries(e){const r=this.#e;at.batch(()=>{r.findAll(e).forEach(s=>{r.remove(s)})})}resetQueries(e,r){const s=this.#e;return at.batch(()=>(s.findAll(e).forEach(a=>{a.reset()}),this.refetchQueries({type:"active",...e},r)))}cancelQueries(e,r={}){const s={revert:!0,...r},a=at.batch(()=>this.#e.findAll(e).map(n=>n.cancel(s)));return Promise.all(a).then(ft).catch(ft)}invalidateQueries(e,r={}){return at.batch(()=>(this.#e.findAll(e).forEach(s=>{s.invalidate()}),e?.refetchType==="none"?Promise.resolve():this.refetchQueries({...e,type:e?.refetchType??e?.type??"active"},r)))}refetchQueries(e,r={}){const s={...r,cancelRefetch:r.cancelRefetch??!0},a=at.batch(()=>this.#e.findAll(e).filter(n=>!n.isDisabled()&&!n.isStatic()).map(n=>{let i=n.fetch(void 0,s);return s.throwOnError||(i=i.catch(ft)),n.state.fetchStatus==="paused"?Promise.resolve():i}));return Promise.all(a).then(ft)}fetchQuery(e){const r=this.defaultQueryOptions(e);r.retry===void 0&&(r.retry=!1);const s=this.#e.build(this,r);return s.isStaleByTime(or(r.staleTime,s))?s.fetch(r):Promise.resolve(s.state.data)}prefetchQuery(e){return this.fetchQuery(e).then(ft).catch(ft)}fetchInfiniteQuery(e){return e.behavior=Ai(e.pages),this.fetchQuery(e)}prefetchInfiniteQuery(e){return this.fetchInfiniteQuery(e).then(ft).catch(ft)}ensureInfiniteQueryData(e){return e.behavior=Ai(e.pages),this.ensureQueryData(e)}resumePausedMutations(){return Qs.isOnline()?this.#t.resumePausedMutations():Promise.resolve()}getQueryCache(){return this.#e}getMutationCache(){return this.#t}getDefaultOptions(){return this.#r}setDefaultOptions(e){this.#r=e}setQueryDefaults(e,r){this.#a.set(is(e),{queryKey:e,defaultOptions:r})}getQueryDefaults(e){const r=[...this.#a.values()],s={};return r.forEach(a=>{os(e,a.queryKey)&&Object.assign(s,a.defaultOptions)}),s}setMutationDefaults(e,r){this.#s.set(is(e),{mutationKey:e,defaultOptions:r})}getMutationDefaults(e){const r=[...this.#s.values()],s={};return r.forEach(a=>{os(e,a.mutationKey)&&Object.assign(s,a.defaultOptions)}),s}defaultQueryOptions(e){if(e._defaulted)return e;const r={...this.#r.queries,...this.getQueryDefaults(e.queryKey),...e,_defaulted:!0};return r.queryHash||(r.queryHash=mn(r.queryKey,r)),r.refetchOnReconnect===void 0&&(r.refetchOnReconnect=r.networkMode!=="always"),r.throwOnError===void 0&&(r.throwOnError=!!r.suspense),!r.networkMode&&r.persister&&(r.networkMode="offlineFirst"),r.queryFn===hn&&(r.enabled=!1),r}defaultMutationOptions(e){return e?._defaulted?e:{...this.#r.mutations,...e?.mutationKey&&this.getMutationDefaults(e.mutationKey),...e,_defaulted:!0}}clear(){this.#e.clear(),this.#t.clear()}},Uo=u.createContext(void 0),Rr=e=>{const r=u.useContext(Uo);if(!r)throw new Error("No QueryClient set, use QueryClientProvider to set one");return r},Uc=({client:e,children:r})=>(u.useEffect(()=>(e.mount(),()=>{e.unmount()}),[e]),t.jsx(Uo.Provider,{value:e,children:r})),Bo=u.createContext(!1),Bc=()=>u.useContext(Bo);Bo.Provider;function Vc(){let e=!1;return{clearReset:()=>{e=!1},reset:()=>{e=!0},isReset:()=>e}}var Zc=u.createContext(Vc()),Wc=()=>u.useContext(Zc),qc=(e,r)=>{(e.suspense||e.throwOnError||e.experimental_prefetchInRender)&&(r.isReset()||(e.retryOnMount=!1))},Jc=e=>{u.useEffect(()=>{e.clearReset()},[e])},Qc=({result:e,errorResetBoundary:r,throwOnError:s,query:a,suspense:n})=>e.isError&&!r.isReset()&&!e.isFetching&&a&&(n&&e.data===void 0||kc(s,[e.error,a])),Kc=e=>{if(e.suspense){const s=n=>n==="static"?n:Math.max(n??1e3,1e3),a=e.staleTime;e.staleTime=typeof a=="function"?(...n)=>s(a(...n)):s(a),typeof e.gcTime=="number"&&(e.gcTime=Math.max(e.gcTime,1e3))}},Gc=(e,r)=>e.isLoading&&e.isFetching&&!r,Hc=(e,r)=>e?.suspense&&r.isPending,Si=(e,r,s)=>r.fetchOptimistic(e).catch(()=>{s.clearReset()});function Yc(e,r,s){const a=Bc(),n=Wc(),i=Rr(),o=i.defaultQueryOptions(e);i.getDefaultOptions().queries?._experimental_beforeQuery?.(o),o._optimisticResults=a?"isRestoring":"optimistic",Kc(o),qc(o,n),Jc(n);const c=!i.getQueryCache().get(o.queryHash),[g]=u.useState(()=>new r(i,o)),_=g.getOptimisticResult(o),y=!a&&e.subscribed!==!1;if(u.useSyncExternalStore(u.useCallback(D=>{const w=y?g.subscribe(at.batchCalls(D)):ft;return g.updateResult(),w},[g,y]),()=>g.getCurrentResult(),()=>g.getCurrentResult()),u.useEffect(()=>{g.setOptions(o)},[o,g]),Hc(o,_))throw Si(o,g,n);if(Qc({result:_,errorResetBoundary:n,throwOnError:o.throwOnError,query:i.getQueryCache().get(o.queryHash),suspense:o.suspense}))throw _.error;return i.getDefaultOptions().queries?._experimental_afterQuery?.(o,_),o.experimental_prefetchInRender&&!br&&Gc(_,a)&&(c?Si(o,g,n):i.getQueryCache().get(o.queryHash)?.promise)?.catch(ft).finally(()=>{g.updateResult()}),o.notifyOnChangeProps?_:g.trackResult(_)}function Xc(e,r){return Yc(e,Pc)}const Di=e=>{let r;const s=new Set,a=(_,y)=>{const D=typeof _=="function"?_(r):_;if(!Object.is(D,r)){const w=r;r=y??(typeof D!="object"||D===null)?D:Object.assign({},r,D),s.forEach(I=>I(r,w))}},n=()=>r,c={setState:a,getState:n,getInitialState:()=>g,subscribe:_=>(s.add(_),()=>s.delete(_))},g=r=e(a,n,c);return c},ed=(e=>e?Di(e):Di),td=e=>e;function rd(e,r=td){const s=tt.useSyncExternalStore(e.subscribe,tt.useCallback(()=>r(e.getState()),[e,r]),tt.useCallback(()=>r(e.getInitialState()),[e,r]));return tt.useDebugValue(s),s}const zi=e=>{const r=ed(e),s=a=>rd(r,a);return Object.assign(s,r),s},sd=(e=>e?zi(e):zi),Vo="https://supabase.healapp.ru",ad="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyAgCiAgICAicm9sZSI6ICJhbm9uIiwKICAgICJpc3MiOiAic3VwYWJhc2UtZGVtbyIsCiAgICAiaWF0IjogMTY0MTc2OTIwMCwKICAgICJleHAiOiAxNzk5NTM1NjAwCn0.dc_X5iR_VP_qT0zsiyj_I_OZ2T9FtRU2BBNWN8Bu4GE",nd="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyAgCiAgICAicm9sZSI6ICJzZXJ2aWNlX3JvbGUiLAogICAgImlzcyI6ICJzdXBhYmFzZS1kZW1vIiwKICAgICJpYXQiOiAxNjQxNzY5MjAwLAogICAgImV4cCI6IDE3OTk1MzU2MDAKfQ.DaYlNEoUrrEn2Ig7tqibS-PHK5vgusbcbo7X36XVt4Q",R=Io(Vo,ad),Cr=Io(Vo,nd,{auth:{autoRefreshToken:!1,persistSession:!1}});console.warn("⚠️ Service Role Key detected. This should only be used in local development!");const Se=sd(e=>({user:null,session:null,isAuthenticated:!1,loading:!0,setUser:r=>e({user:r,isAuthenticated:!!r}),setSession:r=>e({session:r,user:r?.user??null,isAuthenticated:!!r?.user}),setLoading:r=>e({loading:r}),checkAuth:async()=>{try{e({loading:!0});try{const{data:{session:a}}=await R.auth.getSession();if(a?.user){console.log("authStore.checkAuth: Found Supabase session:",{userId:a.user.id,email:a.user.email,organizationType:a.user.user_metadata?.organization_type,userRole:a.user.user_metadata?.user_role});const n=a.user.user_metadata?.organization_type;if(n&&["pension","patronage_agency","caregiver"].includes(n))if(a.user.email_confirmed_at!==null){localStorage.removeItem("current_user"),localStorage.removeItem("auth_token"),console.log("✅ authStore.checkAuth: Authenticated as ORGANIZATION/CAREGIVER via Supabase"),e({session:a,user:a.user,isAuthenticated:!0,loading:!1});return}else{console.log("⚠️ authStore.checkAuth: Email not confirmed for organization/caregiver"),e({session:null,user:null,isAuthenticated:!1,loading:!1});return}const i=a.user.user_metadata?.user_role,o=i==="org_employee";if(o||i==="client"){localStorage.removeItem("current_user"),localStorage.removeItem("auth_token"),console.log("✅ authStore.checkAuth: Authenticated as",o?"EMPLOYEE":"CLIENT","via Supabase"),e({session:a,user:a.user,isAuthenticated:!0,loading:!1});return}}else console.log("authStore.checkAuth: No Supabase session found")}catch(a){console.log("authStore.checkAuth: Supabase unavailable, checking localStorage:",a)}const r=localStorage.getItem("current_user"),s=localStorage.getItem("auth_token");if(console.log("authStore.checkAuth: Checking localStorage...",{hasCurrentUser:!!r,hasAuthToken:!!s,currentUserLength:r?.length||0}),r&&s&&r!=="{}")try{const a=JSON.parse(r),n=a.user_role||a.user_metadata?.user_role;if(console.log("authStore.checkAuth: Parsed localStorage user:",{id:a.id,role:n,phone:a.phone,caregiver_id:a.caregiver_id,organization_id:a.organization_id}),n==="client"||n==="org_employee"){console.log("✅ authStore.checkAuth: Loading",n==="client"?"CLIENT":"EMPLOYEE","from localStorage (legacy)"),e({session:{user:a,access_token:s},user:a,isAuthenticated:!0,loading:!1});return}else console.log("⚠️ authStore.checkAuth: User role not client or employee:",n)}catch(a){console.error("❌ authStore.checkAuth: Error parsing current_user:",a)}else console.log("authStore.checkAuth: No valid localStorage data found");e({session:null,user:null,isAuthenticated:!1,loading:!1})}catch(r){console.error("Error checking auth:",r),e({session:null,user:null,isAuthenticated:!1,loading:!1})}},logout:async()=>{try{localStorage.removeItem("current_user"),localStorage.removeItem("auth_token");try{await R.auth.signOut()}catch{}e({user:null,session:null,isAuthenticated:!1})}catch(r){console.error("Error logging out:",r)}}})),id=()=>t.jsxs("div",{className:"min-h-screen flex flex-col relative",children:[t.jsx("div",{className:"absolute inset-0 bg-blue-primary",children:t.jsx("div",{className:"absolute left-0 top-0 w-32 h-32 bg-blue-400 opacity-20 rounded-full -translate-x-1/2 -translate-y-1/2"})}),t.jsx("div",{className:"h-32 relative z-0",children:t.jsx("div",{className:"absolute inset-0 bg-blue-primary rounded-b-[40px]"})}),t.jsx("div",{className:"flex-1 bg-white rounded-t-[30px] -mt-8 relative z-10 px-4 pt-12 pb-8",children:t.jsx("div",{className:"max-w-md mx-auto",children:t.jsx(un,{})})})]}),od=()=>t.jsx("div",{className:"min-h-screen bg-white",children:t.jsx("main",{className:"w-full",children:t.jsx(un,{})})}),pt=({children:e})=>{const{isAuthenticated:r,loading:s,checkAuth:a,session:n,user:i}=Se();return u.useEffect(()=>{if(n&&i&&r){s&&(console.log("ProtectedRoute: Already authenticated, resetting loading"),Se.getState().setLoading(!1));return}if(!n&&!i&&!r){console.log("ProtectedRoute: No session/user found, calling checkAuth()");const o=a(),c=setTimeout(()=>{console.warn("ProtectedRoute: checkAuth timeout, resetting loading"),Se.getState().setLoading(!1)},5e3);o.then(()=>{clearTimeout(c)}).catch(g=>{clearTimeout(c),console.error("ProtectedRoute: checkAuth failed:",g),Se.getState().setLoading(!1)})}else s&&(n||i)&&(console.log("ProtectedRoute: Resetting loading state (have session/user)"),Se.getState().setLoading(!1))},[a,n,i,r,s]),s?t.jsxs("div",{className:"min-h-screen flex items-center justify-center",children:[t.jsx("div",{className:"animate-spin w-8 h-8 border-4 border-blue-primary border-t-transparent rounded-full"}),t.jsx("p",{className:"ml-4 text-gray-600",children:"Загрузка..."})]}):r?t.jsx(t.Fragment,{children:e}):(console.log("ProtectedRoute: Not authenticated, redirecting to /login"),t.jsx(Eo,{to:"/login",replace:!0}))},ld=()=>{const e=rt(),[r,s]=u.useState(null),a=u.useRef(null);u.useEffect(()=>{if(r)document.body.style.overflow="auto";else{document.body.style.overflow="hidden",window.scrollTo({top:0,behavior:"smooth"});const i=o=>{o.preventDefault(),window.scrollTo({top:0,behavior:"smooth"})};return window.addEventListener("scroll",i,{passive:!1}),window.addEventListener("wheel",i,{passive:!1}),window.addEventListener("touchmove",i,{passive:!1}),()=>{window.removeEventListener("scroll",i),window.removeEventListener("wheel",i),window.removeEventListener("touchmove",i)}}return()=>{document.body.style.overflow="auto"}},[r]);const n=i=>{s(i),setTimeout(()=>{a.current?.scrollIntoView({behavior:"smooth"})},100)};return t.jsxs("div",{className:"min-h-screen bg-white",children:[t.jsxs("section",{className:"relative w-full h-screen bg-[#35B9C5] text-white flex flex-col",children:[t.jsx("header",{className:"absolute top-0 left-0 px-8 md:px-16 py-6 md:py-8 z-10",children:t.jsxs("div",{className:"flex items-center gap-4",children:[t.jsx("img",{src:"/icons/logo.png",alt:"Здраво",className:"w-16 h-16 md:w-20 md:h-20 lg:w-24 lg:h-24 object-contain"}),t.jsx("span",{className:"text-4xl md:text-5xl lg:text-6xl font-extrabold text-[#4A4A4A]",children:"Здраво"})]})}),t.jsx("div",{className:"flex-1 flex flex-col items-center justify-center px-4",children:t.jsxs("div",{className:"max-w-5xl mx-auto text-center",children:[t.jsx("h1",{className:"text-4xl md:text-5xl lg:text-6xl font-extrabold mb-6 leading-tight",children:"Кому вы хотите помочь?"}),t.jsx("p",{className:"text-xl md:text-2xl font-sans mb-12 md:mb-16 text-white",children:"Выберите свой вариант ниже"}),t.jsxs("div",{className:"flex flex-row gap-3 md:gap-16 justify-center items-start",children:[t.jsxs("div",{className:"flex flex-col items-center w-[160px] sm:w-[160px] md:w-[280px]",children:[t.jsx("button",{onClick:()=>n("relative"),className:`w-full h-[55px] md:h-[75px] px-2 md:px-8 rounded-full text-white font-semibold text-xs sm:text-sm md:text-lg transition-all duration-300 hover:opacity-90 hover:scale-105 ${r==="relative"?"ring-2 md:ring-4 ring-white ring-offset-1 md:ring-offset-2 ring-offset-[#35B9C5]":""}`,style:{background:"linear-gradient(to bottom, #5FBDD6 0%, #3A9BBF 100%)"},children:"Я родственник"}),t.jsxs("p",{className:"mt-2 md:mt-4 text-[10px] md:text-sm text-white/80 text-center leading-tight md:leading-relaxed",children:["*У меня пожилой родитель",t.jsx("br",{}),"или близкий"]})]}),t.jsxs("div",{className:"flex flex-col items-center w-[160px] sm:w-[160px] md:w-[280px]",children:[t.jsxs("button",{onClick:()=>n("caregiver"),className:`w-full h-[55px] md:h-[75px] px-2 md:px-8 leading-tight md:leading-5 rounded-full text-white font-semibold text-xs sm:text-sm md:text-lg transition-all duration-300 hover:opacity-90 hover:scale-105 shadow-lg bg-[#1E3A4C] ${r==="caregiver"?"ring-2 md:ring-4 ring-white ring-offset-1 md:ring-offset-2 ring-offset-[#35B9C5]":""}`,children:["Я сиделка/",t.jsx("br",{}),"организация"]}),t.jsxs("p",{className:"mt-2 md:mt-4 text-[10px] md:text-sm text-white/80 text-center leading-tight md:leading-relaxed",children:["*Я помогаю пожилым",t.jsx("br",{}),"людям"]})]})]})]})})]}),t.jsx("section",{ref:a,className:"py-16 md:py-24 bg-white",children:t.jsx("div",{className:"container mx-auto px-4",children:t.jsx("div",{className:"max-w-4xl mx-auto text-center",children:r==="caregiver"?t.jsxs(t.Fragment,{children:[t.jsx("h2",{className:"text-4xl md:text-5xl font-bold text-[#4A4A4A] mb-6 text-left lg:text-center",children:"Порядок в работе и доверие со стороны семьи"}),t.jsxs("p",{className:"text-xl text-gray-700 font-sans leading-relaxed text-left lg:text-center",children:["Сервис ",t.jsx("span",{className:"font-bold text-gray-dark",children:"Здраво"})," — простой и понятный инструмент для сиделок и организаций по уходу.",t.jsx("br",{}),"Он помогает работать спокойно и быть уверенным в каждом дне."]})]}):t.jsxs(t.Fragment,{children:[t.jsx("h2",{className:"text-4xl md:text-5xl font-bold text-[#4A4A4A] mb-6 text-left lg:text-center",children:"Спокойствие за близкого — каждый день"}),t.jsxs("p",{className:"text-xl text-gray-700 font-sans leading-relaxed text-left lg:text-center",children:["Сервис ",t.jsx("span",{className:"font-bold text-gray-dark",children:"Здраво"}),", помогает быть уверенным, что с пожилым родителем или близким всё в порядке. Вы видите состояние, динамику и работу сиделки в одном приложении."]})]})})})}),t.jsx("section",{className:"bg-center bg-cover bg-no-repeat bg-[url('/icons/f_m.png')] lg:bg-none lg:bg-[#35B9C5]",children:t.jsxs("div",{className:"container mx-auto px-4 relative",children:[t.jsx("img",{src:"/icons/book.png",alt:"",className:"absolute -top-12 left-[5%] w-16 h-16 md:w-24 md:h-24 object-contain opacity-90 -rotate-12 animate-float-slow z-0"}),t.jsx("img",{src:"/icons/book.png",alt:"",className:"absolute -bottom-[5%] -left-4 md:left-[2%] size-12 md:size-28 object-contain -rotate-45 animate-float-medium z-0"}),t.jsx("img",{src:"/icons/book.png",alt:"",className:"absolute top-[-65%] lg:top-auto lg:bottom-[30%] right-[4%] lg:right-auto lg:left-[35%] w-20 h-20 md:w-24 md:h-24 object-contain -rotate-6 animate-float-fast z-0"}),t.jsx("img",{src:"/icons/book.png",alt:"",className:"absolute -top-8 right-[5%] w-10 h-10 md:w-24 md:h-24 object-contain rotate-12 animate-float-medium hidden md:block z-0"}),t.jsx("img",{src:"/icons/book.png",alt:"",className:"absolute bottom-[15%] right-[2%] w-8 h-8 md:w-24 md:h-24 object-contain -rotate-3 animate-float-slow hidden md:block z-0"}),t.jsxs("div",{className:"grid grid-cols-4 lg:grid-cols-2 gap-8 items-center max-w-6xl mx-auto py-8 md:py-12",children:[t.jsxs("div",{className:"col-span-3 lg:col-span-1 z-10 relative py-4",children:[t.jsx("h2",{className:"text-2xl md:text-3xl lg:text-4xl font-bold text-[#4A4A4A] mb-4 md:mb-6",children:"Что такое дневник здоровья"}),r==="caregiver"?t.jsxs(t.Fragment,{children:[t.jsxs("p",{className:"text-base md:text-lg text-[#4A4A4A] leading-relaxed mb-6 md:mb-8",children:["Дневник здоровья — это удобный журнал в приложении.",t.jsx("br",{}),"В нём можно фиксировать показатели подопечных."]}),t.jsx("p",{className:"text-base md:text-lg font-semibold text-[#4A4A4A] mb-4",children:"Вы можете:"}),t.jsx("div",{className:"space-y-1 md:space-y-1 mb-6 md:mb-8",children:["Делать короткие записи","Добавлять комментарии по состоянию","Объяснять изменения простыми словами"].map((i,o)=>t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"w-6 h-6 bg-white/30 rounded-full flex items-center justify-center flex-shrink-0",children:t.jsx("svg",{className:"w-4 h-4 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),t.jsx("span",{className:"text-base md:text-lg text-[#4A4A4A]",children:i})]},o))}),t.jsx("p",{className:"text-base md:text-lg font-semibold text-[#4A4A4A]",children:"Без сложных форм и лишней писанины."})]}):t.jsxs(t.Fragment,{children:[t.jsx("p",{className:"text-base md:text-lg text-[#4A4A4A] leading-relaxed mb-6 md:mb-8",children:"Дневник здоровья — это удобный журнал в приложении. В нём собирается вся информация о состоянии близкого."}),t.jsx("div",{className:"space-y-3 md:space-y-4 mb-6 md:mb-8",children:["Основные показатели","Ежедневные наблюдения","Комментарии по состоянию","Историю записей по дням"].map((i,o)=>t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"w-6 h-6 bg-white/30 rounded-full flex items-center justify-center flex-shrink-0",children:t.jsx("svg",{className:"w-4 h-4 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),t.jsx("span",{className:"text-base md:text-lg text-[#4A4A4A]",children:i})]},o))}),t.jsx("p",{className:"text-base md:text-lg font-semibold text-[#4A4A4A]",children:"Всё собрано в одном месте, без тетрадей и звонков."})]})]}),t.jsx("div",{className:"hidden lg:flex justify-center lg:justify-end relative z-10",children:t.jsx("div",{className:"relative",children:t.jsx("img",{src:"/icons/phone.png",alt:"Приложение дневник здоровья",className:"w-56 md:w-72 lg:w-96 h-auto object-contain drop-shadow-2xl -mt-24 md:-mt-32 lg:-mt-48 -mb-24 md:-mb-32 lg:-mb-48"})})})]})]})}),t.jsx("section",{className:"py-8 md:py-24 bg-white relative overflow-hidden",children:t.jsxs("div",{className:"container mx-auto px-4 relative",children:[t.jsx("img",{src:"/icons/heart.png",alt:"",className:"absolute top-1/4 -left-12 md:-left-24 w-32 h-32 md:w-52 md:h-52 object-contain opacity-80 rotate-[-15deg] blur-sm animate-float-slow z-0"}),t.jsx("img",{src:"/icons/heart.png",alt:"",className:"absolute -top-12 left-1/2 -translate-x-1/2 w-20 h-20 md:w-32 md:h-32 object-contain opacity-90 rotate-12 animate-float-medium z-0"}),t.jsx("img",{src:"/icons/heart.png",alt:"",className:"absolute -top-16 right-0 md:-right-12 w-24 h-24 md:w-40 md:h-40 object-contain opacity-80 rotate-[30deg] animate-float-fast z-0"}),t.jsx("img",{src:"/icons/heart.png",alt:"",className:"absolute bottom-0 left-1/3 w-16 h-16 md:w-24 md:h-24 object-contain opacity-70 rotate-[-10deg] animate-float-slow z-0"}),t.jsx("img",{src:"/icons/heart.png",alt:"",className:"absolute -bottom-12 right-4 md:right-16 w-24 h-24 md:w-36 md:h-36 object-contain opacity-80 rotate-[15deg] blur-[2px] animate-float-medium z-0"}),t.jsxs("div",{className:"flex flex-col lg:flex-row items-center justify-center gap-8 md:gap-16 max-w-6xl mx-auto py-8 md:py-12",children:[t.jsx("div",{className:"flex justify-center relative z-10 order-2 lg:order-1 flex-1 lg:flex-none",children:t.jsx("div",{className:"relative",children:t.jsx("img",{src:"/icons/phone-2.png",alt:"Динамика состояния в приложении",className:"w-56 md:w-72 lg:w-80 h-auto object-contain drop-shadow-2xl md:-my-12 lg:-my-16"})})}),t.jsx("div",{className:"z-10 relative py-4 order-1 lg:order-2 flex-1 max-w-2xl text-center lg:text-left",children:r==="caregiver"?t.jsxs(t.Fragment,{children:[t.jsx("h2",{className:"text-3xl md:text-4xl lg:text-5xl font-black text-[#4A4A4A] mb-6 leading-tight text-left",children:"Безопасность специалиста и доверие со стороны родственников"}),t.jsx("p",{className:"text-lg md:text-xl text-[#4A4A4A] leading-relaxed font-sans mb-4 text-left ",children:"Все действия и комментарии фиксируются в приложении."}),t.jsx("div",{className:"space-y-1 md:space-y-2 mb-6",children:["Видно, что, когда и как было сделано","Есть объяснения к выполненным действиям","Меньше недоразумений с родственниками"].map((i,o)=>t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"w-6 h-6 bg-[#35B9C5]/30 rounded-full flex items-center justify-center flex-shrink-0",children:t.jsx("svg",{className:"w-4 h-4 text-[#35B9C5]",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),t.jsx("span",{className:"text-base md:text-lg text-[#4A4A4A]",children:i})]},o))}),t.jsx("p",{className:"text-lg md:text-xl font-semibold text-[#4A4A4A]",children:"Ваша работа прозрачна и защищена."})]}):t.jsxs(t.Fragment,{children:[t.jsx("h2",{className:"text-3xl md:text-4xl lg:text-5xl font-black text-[#4A4A4A] mb-6 leading-tight text-left",children:"Динамика состояния — с понятными комментариями"}),t.jsxs("p",{className:"text-lg md:text-xl text-[#4A4A4A] leading-relaxed font-sans text-left",children:["Приложение показывает не просто цифры, а как"," ",t.jsx("br",{className:"hidden md:block"}),"состояние меняется со временем."," ",t.jsx("br",{className:"hidden md:block"}),"Вы понимаете, что происходит и почему."]})]})})]})]})}),t.jsxs("section",{className:"relative overflow-visible z-30",children:[t.jsxs("div",{className:"container mx-auto px-4 pt-12 pb-12",children:[t.jsx("h2",{className:"block lg:hidden text-3xl md:text-4xl lg:text-5xl font-black text-[#4A4A4A] mb-6 leading-tight text-left",children:"Маршрутный лист ухода"}),t.jsx("p",{className:"block lg:hidden text-lg md:text-xl text-[#4A4A4A] leading-relaxed font-sans mb-6 text-left",children:"В приложении вы видите конкретный список задач по уходу и отмечаете выполнение по ходу работы."})]}),t.jsx("div",{className:"bg-top bg-cover bg-no-repeat bg-[url('/icons/s_2.png')] lg:bg-none lg:bg-[#35B9C5]",children:t.jsxs("div",{className:"container mx-auto px-4 relative",children:[t.jsx("img",{src:"/icons/calendar.png",alt:"",className:"absolute -top-16 left-0 w-24 h-24 md:w-40 md:h-40 object-contain rotate-12 animate-float-slow z-20 blur-[2px]"}),t.jsx("img",{src:"/icons/calendar.png",alt:"",className:"absolute bottom-0 -left-8 md:left-[2%] w-16 h-16 md:w-32 md:h-32 object-contain rotate-6 animate-float-medium z-20"}),t.jsx("img",{src:"/icons/calendar.png",alt:"",className:"absolute bottom-[100%] lg:bottom-[30%] left-[70%] lg:left-[30%] w-20 h-20 md:w-36 md:h-36 object-contain -rotate-6 animate-float-fast z-20"}),t.jsx("img",{src:"/icons/calendar.png",alt:"",className:"absolute -top-12 right-[2%] w-16 h-16 md:w-36 md:h-36 object-contain  rotate-12 animate-float-medium hidden md:block z-20"}),t.jsx("img",{src:"/icons/calendar.png",alt:"",className:"absolute bottom-[20%] right-[2%] w-14 h-14 md:w-36 md:h-36 object-contain -rotate-3 animate-float-slow hidden md:block z-20"}),t.jsxs("div",{className:"flex flex-col lg:flex-row items-center justify-center gap-8 md:gap-16 w-8/12 lg:max-w-6xl lg:mx-auto pt-2 md:pt-6",children:[t.jsx("div",{className:"z-10 relative py-4 flex-1 order-1 lg:order-1 text-lef",children:r==="caregiver"?t.jsxs(t.Fragment,{children:[t.jsx("h2",{className:"hidden lg:block text-3xl md:text-4xl lg:text-5xl font-black text-[#4A4A4A] mb-6 leading-tight text-left",children:"Маршрутный лист ухода"}),t.jsx("p",{className:"hidden lg:block text-lg md:text-xl text-[#4A4A4A] leading-relaxed font-sans mb-6 text-left",children:"В приложении вы видите конкретный список задач по уходу и отмечаете выполнение по ходу работы."}),t.jsxs("div",{className:"mb-4",children:[t.jsx("h3",{className:"text-xl md:text-2xl font-bold text-[#4A4A4A] mb-2",children:"Плюсы:"}),t.jsx("ul",{className:"space-y-1",children:["Понятный план на день","Ничего не забывается","Легко добавить комментарий к задаче"].map((i,o)=>t.jsxs("li",{className:"flex items-center gap-3 justify-start",children:[t.jsx("div",{className:"flex-shrink-0 w-6 h-6 rounded-full bg-white/30 flex items-center justify-center",children:t.jsx("svg",{className:"w-4 h-4 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})})}),t.jsx("span",{className:"text-lg text-[#4A4A4A] font-medium",children:i})]},o))})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-xl md:text-2xl font-bold text-[#4A4A4A] mb-4",children:"Примеры задач:"}),t.jsx("div",{className:"grid grid-cols-2 gap-4 max-w-md mx-auto lg:mx-0",children:["Утренняя гигиена","Завтрак","Прогулка","Игра в шахматы"].map((i,o)=>t.jsx("div",{className:"bg-white rounded-xl py-3 px-4 text-center shadow-sm text-[#4A4A4A] font-medium",children:i},o))})]})]}):t.jsxs(t.Fragment,{children:[t.jsx("h2",{className:"hidden lg:block text-3xl md:text-4xl lg:text-5xl font-black text-[#4A4A4A] mb-6 leading-tight text-left",children:"Маршрутный лист ухода"}),t.jsxs("p",{className:"hidden lg:block text-lg md:text-xl text-[#4A4A4A] leading-relaxed font-sans mb-8 text-left",children:["Маршрутный лист — это список конкретных задач для"," ",t.jsx("br",{className:"hidden md:block"}),"сиделки. Вы сами указываете, что нужно сделать."]}),t.jsxs("div",{className:"mb-4",children:[t.jsx("h3",{className:"text-xl md:text-2xl font-bold text-[#4A4A4A] mb-2",children:"В приложении видно:"}),t.jsx("ul",{className:"space-y-1",children:["Какие задачи поставлены","Что уже выполнено","Комментарии к задачам","Когда и кем это сделано"].map((i,o)=>t.jsxs("li",{className:"flex items-center gap-3 justify-start",children:[t.jsx("div",{className:"flex-shrink-0 w-6 h-6 rounded-full bg-white/30 flex items-center justify-center",children:t.jsx("svg",{className:"w-4 h-4 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})})}),t.jsx("span",{className:"text-lg text-[#4A4A4A] font-medium",children:i})]},o))})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-xl md:text-2xl font-bold text-[#4A4A4A] mb-4",children:"Примеры задач:"}),t.jsx("div",{className:"grid grid-cols-2 gap-4 max-w-md mx-auto lg:mx-0",children:["Утренняя гигиена","Завтрак","Прогулка","Игра в шахматы"].map((i,o)=>t.jsx("div",{className:"bg-white rounded-xl py-3 px-4 text-center shadow-sm text-[#4A4A4A] font-medium",children:i},o))})]})]})}),t.jsx("div",{className:"hidden lg:flex justify-center z-10 flex-1 order-2 lg:order-2 ",children:t.jsx("div",{className:"relative",children:t.jsx("img",{src:"/icons/phone-3.png",alt:"Маршрутный лист в приложении",className:"w-auto md:w-80 lg:w-[400px] h-auto object-contain drop-shadow-2xl -mt-32 md:-mt-32 lg:-mt-32"})})})]})]})})]}),r==="caregiver"&&t.jsx("section",{className:"py-12 md:py-20 bg-white",children:t.jsxs("div",{className:"container mx-auto px-4",children:[t.jsx("h2",{className:"text-3xl md:text-4xl lg:text-5xl font-black text-[#4A4A4A] text-center mb-10 md:mb-16",children:"Дополнительные функции для организаций"}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8 max-w-5xl mx-auto",children:[t.jsxs("div",{className:"bg-[#F8F9FA] rounded-2xl p-6 md:p-8 shadow-sm",children:[t.jsx("h3",{className:"text-2xl md:text-3xl font-bold text-[#4A4A4A] mb-6 text-center",children:"Пансионат"}),t.jsx("ul",{className:"space-y-3",children:["Создание расписания пансионата","Самостоятельное создание карточки подопечного и дневника","Добавление сотрудников в приложение организации","Постановка задач конкретным сотрудникам по конкретному подопечному в маршрутном листе"].map((i,o)=>t.jsxs("li",{className:"flex items-start gap-3",children:[t.jsx("div",{className:"flex-shrink-0 w-5 h-5 mt-0.5 rounded-full bg-[#35B9C5]/20 flex items-center justify-center",children:t.jsx("svg",{className:"w-3 h-3 text-[#35B9C5]",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})})}),t.jsx("span",{className:"text-base text-[#4A4A4A] leading-relaxed",children:i})]},o))})]}),t.jsxs("div",{className:"bg-[#F8F9FA] rounded-2xl p-6 md:p-8 shadow-sm",children:[t.jsx("h3",{className:"text-2xl md:text-3xl font-bold text-[#4A4A4A] mb-6 text-center",children:"Патронажное агентство"}),t.jsx("ul",{className:"space-y-3",children:["Самостоятельное создание карточки подопечного и дневника","Добавление сотрудников в приложение организации","Постановка задач конкретным сотрудникам по конкретному подопечному в маршрутном листе"].map((i,o)=>t.jsxs("li",{className:"flex items-start gap-3",children:[t.jsx("div",{className:"flex-shrink-0 w-5 h-5 mt-0.5 rounded-full bg-[#35B9C5]/20 flex items-center justify-center",children:t.jsx("svg",{className:"w-3 h-3 text-[#35B9C5]",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})})}),t.jsx("span",{className:"text-base text-[#4A4A4A] leading-relaxed",children:i})]},o))})]})]})]})}),t.jsx("section",{className:"hidden lg:block py-12 md:py-24 bg-white overflow-hidden",children:t.jsx("div",{className:"container mx-auto px-4",children:t.jsxs("div",{className:"relative max-w-5xl mx-auto h-auto lg:h-[600px] flex flex-col lg:block",children:[t.jsx("div",{className:"hidden lg:flex absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-10 w-full justify-center",children:t.jsx("h2",{className:"text-4xl md:text-5xl font-black text-[#4A4A4A] text-center",children:"Как начать пользоваться"})}),t.jsx("h2",{className:"lg:hidden text-3xl font-black text-[#4A4A4A] text-center mb-12",children:"Как начать пользоваться"}),t.jsx("div",{className:"relative lg:absolute lg:top-0 lg:left-[8%] flex flex-col items-center lg:block mb-12 lg:mb-0",children:t.jsx("img",{src:"/icons/market.svg",alt:"Market",className:"h-[300px]"})}),t.jsx("div",{className:"hidden lg:block absolute top-28 left-[30%] text-2xl font-bold text-gray-400 -rotate-12",children:"ИЛИ"}),t.jsx("div",{className:"relative lg:absolute lg:top-[-7%] lg:left-[42%] flex flex-col items-center lg:block mb-12 lg:mb-0",children:t.jsx("img",{src:"/icons/register_by_link.svg",className:"h-[300px]",alt:""})}),t.jsx("div",{className:"relative lg:absolute lg:top-[0%] lg:right-[-13%] flex flex-col items-center lg:block mb-12 lg:mb-0",children:t.jsx("img",{src:r==="relative"?"/icons/love.svg":"/icons/lova_caregiver.svg",alt:"love",className:"h-[250px]"})}),t.jsx("div",{className:"relative lg:absolute lg:bottom-[1%] lg:right-0 flex flex-col items-center lg:block mb-12 lg:mb-0",children:t.jsx("img",{src:r==="relative"?"/icons/create_diary.svg":"/icons/create_diart_caregiver.svg",alt:"Doctor",className:"w-full h-auto object-contain drop-shadow-md translate-y-2"})}),t.jsx("div",{className:"relative lg:absolute lg:bottom-0 lg:left-[20%] flex flex-col items-center lg:block",children:t.jsx("img",{src:r==="relative"?"/icons/doctor.svg":"/icons/doctor_caregiver.svg",alt:"Doctor",className:"w-full h-auto object-contain drop-shadow-md translate-y-2"})})]})})}),t.jsx("section",{className:"block lg:hidden",children:t.jsx("img",{src:r==="relative"?"/icons/how_to_use.svg":"/icons/how_to_use_cav.svg",className:"px-10",alt:""})}),t.jsx("section",{className:"py-12 md:py-16 bg-[#35B9C5]",children:t.jsx("div",{className:"container mx-auto px-4",children:t.jsxs("div",{className:"max-w-4xl mx-auto text-center",children:[t.jsx("h2",{className:"text-2xl md:text-3xl lg:text-4xl font-black text-[#4A4A4A] mb-8 md:mb-12 leading-tight",children:"Выберите ваш телефон, скачайте приложение по кнопке и начните пользоваться"}),t.jsxs("div",{className:"flex flex-col gap-4 items-center mb-8 md:hidden",children:[t.jsx("a",{href:"#",className:"bg-white text-gray-800 font-medium py-3 px-8 rounded-full shadow-sm border border-gray-200 w-64 text-center",children:"Скачать для Андроид"}),t.jsx("a",{href:"#",className:"bg-white text-gray-800 font-medium py-3 px-8 rounded-full shadow-sm border border-gray-200 w-64 text-center",children:"Скачать для Айфон"})]}),t.jsxs("div",{className:"hidden md:flex flex-row gap-12 justify-center items-center mb-12",children:[t.jsxs("div",{className:"relative flex flex-col items-center",children:[t.jsx("img",{src:"/icons/left_arrow.svg",alt:""}),t.jsx("a",{href:"#",className:"mt-5 bg-white text-gray-800 font-semibold py-4 px-8 rounded-full shadow-md transition-all duration-300 hover:shadow-lg hover:scale-105",children:"Скачать для Андроид"})]}),t.jsxs("div",{className:"relative flex flex-col items-center",children:[t.jsx("img",{src:"/icons/right_arrow.svg",alt:""}),t.jsx("a",{href:"#",className:"mt-5 bg-[#C0FAFF] text-gray-800 font-semibold py-4 px-8 rounded-full shadow-md border-2 border-white/30 transition-all duration-300 hover:shadow-lg hover:scale-105",children:"Скачать для Айфон"})]})]}),t.jsxs("div",{className:"flex flex-col items-center",children:[t.jsx("p",{className:"text-lg font-semibold text-[#4A4A4A] mb-4",children:"Уже скоро в:"}),t.jsx("div",{className:"flex gap-4 items-center",children:t.jsx("img",{src:"/icons/soon_markets.svg",alt:"Google Play",className:"w-[100px] h-[100px] md:w-[120px] md:h-[120px] object-contain drop-shadow-md hover:scale-110 transition-transform duration-300"})})]})]})})}),t.jsx("div",{className:"bg-white py-8",children:t.jsx("div",{className:"container mx-auto px-4",children:t.jsxs("div",{className:"flex items-center justify-center gap-4 max-w-lg mx-auto",children:[t.jsx("div",{className:"flex-1 h-px bg-gray-300"}),t.jsx("span",{className:"text-gray-500 font-medium text-lg",children:"ИЛИ"}),t.jsx("div",{className:"flex-1 h-px bg-gray-300"})]})})}),t.jsx("section",{className:"w-full bg-white flex items-center justify-center py-12 md:py-16",children:t.jsx("div",{className:"container mx-auto px-4",children:t.jsxs("div",{className:"max-w-2xl mx-auto",children:[t.jsx("h2",{className:"text-3xl md:text-4xl lg:text-5xl font-black text-[#4A4A4A] leading-tight text-center mb-8 md:mb-12",children:"Зарегистрируйтесь и используйте Веб-версию"}),t.jsxs("form",{className:"space-y-6",children:[t.jsxs("div",{children:[t.jsxs("label",{className:"block text-gray-600 mb-2 text-base",children:["Введите ",t.jsx("span",{className:"text-[#35B9C5]",children:"email"})," или номер телефона"]}),t.jsx("input",{type:"text",placeholder:"example@email.com",className:"w-full px-6 py-4 bg-[#E8F4F8] rounded-xl border-none outline-none text-gray-700 text-lg focus:ring-2 focus:ring-[#35B9C5] transition-all duration-200"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-gray-600 mb-2 text-base",children:"Введите пароль"}),t.jsx("input",{type:"password",placeholder:"••••••••",className:"w-full px-6 py-4 bg-[#E8F4F8] rounded-xl border-none outline-none text-gray-700 text-lg focus:ring-2 focus:ring-[#35B9C5] transition-all duration-200"})]}),t.jsx("button",{type:"submit",onClick:i=>{i.preventDefault(),e("/login")},className:"w-full py-4 bg-[#35B9C5] text-white font-semibold text-lg rounded-full shadow-lg hover:bg-[#2fa8b3] hover:shadow-xl transition-all duration-300 mt-4",children:"Войти"}),t.jsxs("p",{className:"text-center text-gray-600 mt-6",children:["Если еще нет аккаунта, нажмите"," ",t.jsx("button",{type:"button",onClick:()=>e("/register"),className:"text-gray-700 font-medium underline hover:text-[#35B9C5] transition-colors duration-200",children:"Регистрация"})]})]})]})})}),t.jsx("footer",{className:"bg-[#1E2530] text-white py-10 md:py-12",children:t.jsxs("div",{className:"container mx-auto px-6 md:px-8",children:[t.jsxs("div",{className:"flex flex-col md:flex-row items-center justify-between gap-8 mb-10",children:[t.jsx("div",{className:"flex items-center",children:t.jsx("span",{className:"text-xl md:text-5xl font-bold text-white",children:"Здраво"})}),t.jsxs("nav",{className:"flex flex-wrap justify-center gap-6 md:gap-10 text-base md:text-lg text-white",children:[t.jsx("a",{href:"#",className:"hover:text-gray-300 transition-colors duration-200",children:"О проекте"}),t.jsx("a",{href:"#",className:"hover:text-gray-300 transition-colors duration-200",children:"Контакты"}),t.jsx("a",{href:"#",className:"hover:text-gray-300 transition-colors duration-200",children:"Поддержка"}),t.jsx("a",{href:"#",className:"hover:text-gray-300 transition-colors duration-200",children:"Политика конфиденциальности"})]}),t.jsx("button",{className:"px-8 py-3 border-2 border-white rounded-xl text-white font-medium hover:bg-white hover:text-[#1E2530] transition-all duration-300",children:"Скачать приложение"})]}),t.jsx("div",{className:"text-center text-gray-400 text-base border-t border-gray-600 pt-8",children:"© 2025 Здраво. Все права защищены."})]})})]})};var us=e=>e.type==="checkbox",yr=e=>e instanceof Date,gt=e=>e==null;const Zo=e=>typeof e=="object";var Je=e=>!gt(e)&&!Array.isArray(e)&&Zo(e)&&!yr(e),cd=e=>Je(e)&&e.target?us(e.target)?e.target.checked:e.target.value:e,dd=e=>e.substring(0,e.search(/\.\d+(\.|$)/))||e,ud=(e,r)=>e.has(dd(r)),md=e=>{const r=e.constructor&&e.constructor.prototype;return Je(r)&&r.hasOwnProperty("isPrototypeOf")},pn=typeof window<"u"&&typeof window.HTMLElement<"u"&&typeof document<"u";function et(e){let r;const s=Array.isArray(e),a=typeof FileList<"u"?e instanceof FileList:!1;if(e instanceof Date)r=new Date(e);else if(!(pn&&(e instanceof Blob||a))&&(s||Je(e)))if(r=s?[]:Object.create(Object.getPrototypeOf(e)),!s&&!md(e))r=e;else for(const n in e)e.hasOwnProperty(n)&&(r[n]=et(e[n]));else return e;return r}var ra=e=>/^\w*$/.test(e),Ze=e=>e===void 0,xn=e=>Array.isArray(e)?e.filter(Boolean):[],yn=e=>xn(e.replace(/["|']|\]/g,"").split(/\.|\[/)),pe=(e,r,s)=>{if(!r||!Je(e))return s;const a=(ra(r)?[r]:yn(r)).reduce((n,i)=>gt(n)?n:n[i],e);return Ze(a)||a===e?Ze(e[r])?s:e[r]:a},Wt=e=>typeof e=="boolean",Re=(e,r,s)=>{let a=-1;const n=ra(r)?[r]:yn(r),i=n.length,o=i-1;for(;++a<i;){const c=n[a];let g=s;if(a!==o){const _=e[c];g=Je(_)||Array.isArray(_)?_:isNaN(+n[a+1])?{}:[]}if(c==="__proto__"||c==="constructor"||c==="prototype")return;e[c]=g,e=e[c]}};const Ei={BLUR:"blur",FOCUS_OUT:"focusout"},Mt={onBlur:"onBlur",onChange:"onChange",onSubmit:"onSubmit",onTouched:"onTouched",all:"all"},Kt={max:"max",min:"min",maxLength:"maxLength",minLength:"minLength",pattern:"pattern",required:"required",validate:"validate"},hd=tt.createContext(null);hd.displayName="HookFormContext";var fd=(e,r,s,a=!0)=>{const n={defaultValues:r._defaultValues};for(const i in e)Object.defineProperty(n,i,{get:()=>{const o=i;return r._proxyFormState[o]!==Mt.all&&(r._proxyFormState[o]=!a||Mt.all),e[o]}});return n};const gd=typeof window<"u"?tt.useLayoutEffect:tt.useEffect;var Nt=e=>typeof e=="string",pd=(e,r,s,a,n)=>Nt(e)?(a&&r.watch.add(e),pe(s,e,n)):Array.isArray(e)?e.map(i=>(a&&r.watch.add(i),pe(s,i))):(a&&(r.watchAll=!0),s),en=e=>gt(e)||!Zo(e);function ir(e,r,s=new WeakSet){if(en(e)||en(r))return e===r;if(yr(e)&&yr(r))return e.getTime()===r.getTime();const a=Object.keys(e),n=Object.keys(r);if(a.length!==n.length)return!1;if(s.has(e)||s.has(r))return!0;s.add(e),s.add(r);for(const i of a){const o=e[i];if(!n.includes(i))return!1;if(i!=="ref"){const c=r[i];if(yr(o)&&yr(c)||Je(o)&&Je(c)||Array.isArray(o)&&Array.isArray(c)?!ir(o,c,s):o!==c)return!1}}return!0}var bn=(e,r,s,a,n)=>r?{...s[e],types:{...s[e]&&s[e].types?s[e].types:{},[a]:n||!0}}:{},ss=e=>Array.isArray(e)?e:[e],Pi=()=>{let e=[];return{get observers(){return e},next:n=>{for(const i of e)i.next&&i.next(n)},subscribe:n=>(e.push(n),{unsubscribe:()=>{e=e.filter(i=>i!==n)}}),unsubscribe:()=>{e=[]}}};function Wo(e,r){const s={};for(const a in e)if(e.hasOwnProperty(a)){const n=e[a],i=r[a];if(n&&Je(n)&&i){const o=Wo(n,i);Je(o)&&(s[a]=o)}else e[a]&&(s[a]=i)}return s}var mt=e=>Je(e)&&!Object.keys(e).length,_n=e=>e.type==="file",Tt=e=>typeof e=="function",Ks=e=>{if(!pn)return!1;const r=e?e.ownerDocument:0;return e instanceof(r&&r.defaultView?r.defaultView.HTMLElement:HTMLElement)},qo=e=>e.type==="select-multiple",vn=e=>e.type==="radio",xd=e=>vn(e)||us(e),Ia=e=>Ks(e)&&e.isConnected;function yd(e,r){const s=r.slice(0,-1).length;let a=0;for(;a<s;)e=Ze(e)?a++:e[r[a++]];return e}function bd(e){for(const r in e)if(e.hasOwnProperty(r)&&!Ze(e[r]))return!1;return!0}function qe(e,r){const s=Array.isArray(r)?r:ra(r)?[r]:yn(r),a=s.length===1?e:yd(e,s),n=s.length-1,i=s[n];return a&&delete a[i],n!==0&&(Je(a)&&mt(a)||Array.isArray(a)&&bd(a))&&qe(e,s.slice(0,-1)),e}var _d=e=>{for(const r in e)if(Tt(e[r]))return!0;return!1};function Jo(e){return Array.isArray(e)||Je(e)&&!_d(e)}function tn(e,r={}){for(const s in e)Jo(e[s])?(r[s]=Array.isArray(e[s])?[]:{},tn(e[s],r[s])):Ze(e[s])||(r[s]=!0);return r}function Er(e,r,s){s||(s=tn(r));for(const a in e)Jo(e[a])?Ze(r)||en(s[a])?s[a]=tn(e[a],Array.isArray(e[a])?[]:{}):Er(e[a],gt(r)?{}:r[a],s[a]):s[a]=!ir(e[a],r[a]);return s}const Ii={value:!1,isValid:!1},$i={value:!0,isValid:!0};var Qo=e=>{if(Array.isArray(e)){if(e.length>1){const r=e.filter(s=>s&&s.checked&&!s.disabled).map(s=>s.value);return{value:r,isValid:!!r.length}}return e[0].checked&&!e[0].disabled?e[0].attributes&&!Ze(e[0].attributes.value)?Ze(e[0].value)||e[0].value===""?$i:{value:e[0].value,isValid:!0}:$i:Ii}return Ii},Ko=(e,{valueAsNumber:r,valueAsDate:s,setValueAs:a})=>Ze(e)?e:r?e===""?NaN:e&&+e:s&&Nt(e)?new Date(e):a?a(e):e;const Mi={isValid:!1,value:null};var Go=e=>Array.isArray(e)?e.reduce((r,s)=>s&&s.checked&&!s.disabled?{isValid:!0,value:s.value}:r,Mi):Mi;function Ti(e){const r=e.ref;return _n(r)?r.files:vn(r)?Go(e.refs).value:qo(r)?[...r.selectedOptions].map(({value:s})=>s):us(r)?Qo(e.refs).value:Ko(Ze(r.value)?e.ref.value:r.value,e)}var vd=(e,r,s,a)=>{const n={};for(const i of e){const o=pe(r,i);o&&Re(n,i,o._f)}return{criteriaMode:s,names:[...e],fields:n,shouldUseNativeValidation:a}},Gs=e=>e instanceof RegExp,es=e=>Ze(e)?e:Gs(e)?e.source:Je(e)?Gs(e.value)?e.value.source:e.value:e,Ri=e=>({isOnSubmit:!e||e===Mt.onSubmit,isOnBlur:e===Mt.onBlur,isOnChange:e===Mt.onChange,isOnAll:e===Mt.all,isOnTouch:e===Mt.onTouched});const Fi="AsyncFunction";var jd=e=>!!e&&!!e.validate&&!!(Tt(e.validate)&&e.validate.constructor.name===Fi||Je(e.validate)&&Object.values(e.validate).find(r=>r.constructor.name===Fi)),wd=e=>e.mount&&(e.required||e.min||e.max||e.maxLength||e.minLength||e.pattern||e.validate),Oi=(e,r,s)=>!s&&(r.watchAll||r.watch.has(e)||[...r.watch].some(a=>e.startsWith(a)&&/^\.\w+/.test(e.slice(a.length))));const as=(e,r,s,a)=>{for(const n of s||Object.keys(e)){const i=pe(e,n);if(i){const{_f:o,...c}=i;if(o){if(o.refs&&o.refs[0]&&r(o.refs[0],n)&&!a)return!0;if(o.ref&&r(o.ref,o.name)&&!a)return!0;if(as(c,r))break}else if(Je(c)&&as(c,r))break}}};function Li(e,r,s){const a=pe(e,s);if(a||ra(s))return{error:a,name:s};const n=s.split(".");for(;n.length;){const i=n.join("."),o=pe(r,i),c=pe(e,i);if(o&&!Array.isArray(o)&&s!==i)return{name:s};if(c&&c.type)return{name:i,error:c};if(c&&c.root&&c.root.type)return{name:`${i}.root`,error:c.root};n.pop()}return{name:s}}var Nd=(e,r,s,a)=>{s(e);const{name:n,...i}=e;return mt(i)||Object.keys(i).length>=Object.keys(r).length||Object.keys(i).find(o=>r[o]===(!a||Mt.all))},kd=(e,r,s)=>!e||!r||e===r||ss(e).some(a=>a&&(s?a===r:a.startsWith(r)||r.startsWith(a))),Ad=(e,r,s,a,n)=>n.isOnAll?!1:!s&&n.isOnTouch?!(r||e):(s?a.isOnBlur:n.isOnBlur)?!e:(s?a.isOnChange:n.isOnChange)?e:!0,Cd=(e,r)=>!xn(pe(e,r)).length&&qe(e,r),Sd=(e,r,s)=>{const a=ss(pe(e,s));return Re(a,"root",r[s]),Re(e,s,a),e};function Ui(e,r,s="validate"){if(Nt(e)||Array.isArray(e)&&e.every(Nt)||Wt(e)&&!e)return{type:s,message:Nt(e)?e:"",ref:r}}var Sr=e=>Je(e)&&!Gs(e)?e:{value:e,message:""},Bi=async(e,r,s,a,n,i)=>{const{ref:o,refs:c,required:g,maxLength:_,minLength:y,min:D,max:w,pattern:I,validate:P,name:C,valueAsNumber:B,mount:O}=e._f,$=pe(s,C);if(!O||r.has(C))return{};const p=c?c[0]:o,k=Z=>{n&&p.reportValidity&&(p.setCustomValidity(Wt(Z)?"":Z||""),p.reportValidity())},f={},x=vn(o),F=us(o),H=x||F,M=(B||_n(o))&&Ze(o.value)&&Ze($)||Ks(o)&&o.value===""||$===""||Array.isArray($)&&!$.length,L=bn.bind(null,C,a,f),U=(Z,j,v,z=Kt.maxLength,T=Kt.minLength)=>{const J=Z?j:v;f[C]={type:Z?z:T,message:J,ref:o,...L(Z?z:T,J)}};if(i?!Array.isArray($)||!$.length:g&&(!H&&(M||gt($))||Wt($)&&!$||F&&!Qo(c).isValid||x&&!Go(c).isValid)){const{value:Z,message:j}=Nt(g)?{value:!!g,message:g}:Sr(g);if(Z&&(f[C]={type:Kt.required,message:j,ref:p,...L(Kt.required,j)},!a))return k(j),f}if(!M&&(!gt(D)||!gt(w))){let Z,j;const v=Sr(w),z=Sr(D);if(!gt($)&&!isNaN($)){const T=o.valueAsNumber||$&&+$;gt(v.value)||(Z=T>v.value),gt(z.value)||(j=T<z.value)}else{const T=o.valueAsDate||new Date($),J=A=>new Date(new Date().toDateString()+" "+A),W=o.type=="time",h=o.type=="week";Nt(v.value)&&$&&(Z=W?J($)>J(v.value):h?$>v.value:T>new Date(v.value)),Nt(z.value)&&$&&(j=W?J($)<J(z.value):h?$<z.value:T<new Date(z.value))}if((Z||j)&&(U(!!Z,v.message,z.message,Kt.max,Kt.min),!a))return k(f[C].message),f}if((_||y)&&!M&&(Nt($)||i&&Array.isArray($))){const Z=Sr(_),j=Sr(y),v=!gt(Z.value)&&$.length>+Z.value,z=!gt(j.value)&&$.length<+j.value;if((v||z)&&(U(v,Z.message,j.message),!a))return k(f[C].message),f}if(I&&!M&&Nt($)){const{value:Z,message:j}=Sr(I);if(Gs(Z)&&!$.match(Z)&&(f[C]={type:Kt.pattern,message:j,ref:o,...L(Kt.pattern,j)},!a))return k(j),f}if(P){if(Tt(P)){const Z=await P($,s),j=Ui(Z,p);if(j&&(f[C]={...j,...L(Kt.validate,j.message)},!a))return k(j.message),f}else if(Je(P)){let Z={};for(const j in P){if(!mt(Z)&&!a)break;const v=Ui(await P[j]($,s),p,j);v&&(Z={...v,...L(j,v.message)},k(v.message),a&&(f[C]=Z))}if(!mt(Z)&&(f[C]={ref:p,...Z},!a))return f}}return k(!0),f};const Dd={mode:Mt.onSubmit,reValidateMode:Mt.onChange,shouldFocusError:!0};function zd(e={}){let r={...Dd,...e},s={submitCount:0,isDirty:!1,isReady:!1,isLoading:Tt(r.defaultValues),isValidating:!1,isSubmitted:!1,isSubmitting:!1,isSubmitSuccessful:!1,isValid:!1,touchedFields:{},dirtyFields:{},validatingFields:{},errors:r.errors||{},disabled:r.disabled||!1},a={},n=Je(r.defaultValues)||Je(r.values)?et(r.defaultValues||r.values)||{}:{},i=r.shouldUnregister?{}:et(n),o={action:!1,mount:!1,watch:!1},c={mount:new Set,disabled:new Set,unMount:new Set,array:new Set,watch:new Set},g,_=0;const y={isDirty:!1,dirtyFields:!1,validatingFields:!1,touchedFields:!1,isValidating:!1,isValid:!1,errors:!1};let D={...y};const w={array:Pi(),state:Pi()},I=r.criteriaMode===Mt.all,P=m=>S=>{clearTimeout(_),_=setTimeout(m,S)},C=async m=>{if(!r.disabled&&(y.isValid||D.isValid||m)){const S=r.resolver?mt((await F()).errors):await M(a,!0);S!==s.isValid&&w.state.next({isValid:S})}},B=(m,S)=>{!r.disabled&&(y.isValidating||y.validatingFields||D.isValidating||D.validatingFields)&&((m||Array.from(c.mount)).forEach(V=>{V&&(S?Re(s.validatingFields,V,S):qe(s.validatingFields,V))}),w.state.next({validatingFields:s.validatingFields,isValidating:!mt(s.validatingFields)}))},O=(m,S=[],V,le,se=!0,ie=!0)=>{if(le&&V&&!r.disabled){if(o.action=!0,ie&&Array.isArray(pe(a,m))){const be=V(pe(a,m),le.argA,le.argB);se&&Re(a,m,be)}if(ie&&Array.isArray(pe(s.errors,m))){const be=V(pe(s.errors,m),le.argA,le.argB);se&&Re(s.errors,m,be),Cd(s.errors,m)}if((y.touchedFields||D.touchedFields)&&ie&&Array.isArray(pe(s.touchedFields,m))){const be=V(pe(s.touchedFields,m),le.argA,le.argB);se&&Re(s.touchedFields,m,be)}(y.dirtyFields||D.dirtyFields)&&(s.dirtyFields=Er(n,i)),w.state.next({name:m,isDirty:U(m,S),dirtyFields:s.dirtyFields,errors:s.errors,isValid:s.isValid})}else Re(i,m,S)},$=(m,S)=>{Re(s.errors,m,S),w.state.next({errors:s.errors})},p=m=>{s.errors=m,w.state.next({errors:s.errors,isValid:!1})},k=(m,S,V,le)=>{const se=pe(a,m);if(se){const ie=pe(i,m,Ze(V)?pe(n,m):V);Ze(ie)||le&&le.defaultChecked||S?Re(i,m,S?ie:Ti(se._f)):v(m,ie),o.mount&&C()}},f=(m,S,V,le,se)=>{let ie=!1,be=!1;const $e={name:m};if(!r.disabled){if(!V||le){(y.isDirty||D.isDirty)&&(be=s.isDirty,s.isDirty=$e.isDirty=U(),ie=be!==$e.isDirty);const Me=ir(pe(n,m),S);be=!!pe(s.dirtyFields,m),Me?qe(s.dirtyFields,m):Re(s.dirtyFields,m,!0),$e.dirtyFields=s.dirtyFields,ie=ie||(y.dirtyFields||D.dirtyFields)&&be!==!Me}if(V){const Me=pe(s.touchedFields,m);Me||(Re(s.touchedFields,m,V),$e.touchedFields=s.touchedFields,ie=ie||(y.touchedFields||D.touchedFields)&&Me!==V)}ie&&se&&w.state.next($e)}return ie?$e:{}},x=(m,S,V,le)=>{const se=pe(s.errors,m),ie=(y.isValid||D.isValid)&&Wt(S)&&s.isValid!==S;if(r.delayError&&V?(g=P(()=>$(m,V)),g(r.delayError)):(clearTimeout(_),g=null,V?Re(s.errors,m,V):qe(s.errors,m)),(V?!ir(se,V):se)||!mt(le)||ie){const be={...le,...ie&&Wt(S)?{isValid:S}:{},errors:s.errors,name:m};s={...s,...be},w.state.next(be)}},F=async m=>{B(m,!0);const S=await r.resolver(i,r.context,vd(m||c.mount,a,r.criteriaMode,r.shouldUseNativeValidation));return B(m),S},H=async m=>{const{errors:S}=await F(m);if(m)for(const V of m){const le=pe(S,V);le?Re(s.errors,V,le):qe(s.errors,V)}else s.errors=S;return S},M=async(m,S,V={valid:!0})=>{for(const le in m){const se=m[le];if(se){const{_f:ie,...be}=se;if(ie){const $e=c.array.has(ie.name),Me=se._f&&jd(se._f);Me&&y.validatingFields&&B([ie.name],!0);const ot=await Bi(se,c.disabled,i,I,r.shouldUseNativeValidation&&!S,$e);if(Me&&y.validatingFields&&B([ie.name]),ot[ie.name]&&(V.valid=!1,S))break;!S&&(pe(ot,ie.name)?$e?Sd(s.errors,ot,ie.name):Re(s.errors,ie.name,ot[ie.name]):qe(s.errors,ie.name))}!mt(be)&&await M(be,S,V)}}return V.valid},L=()=>{for(const m of c.unMount){const S=pe(a,m);S&&(S._f.refs?S._f.refs.every(V=>!Ia(V)):!Ia(S._f.ref))&&E(m)}c.unMount=new Set},U=(m,S)=>!r.disabled&&(m&&S&&Re(i,m,S),!ir(A(),n)),Z=(m,S,V)=>pd(m,c,{...o.mount?i:Ze(S)?n:Nt(m)?{[m]:S}:S},V,S),j=m=>xn(pe(o.mount?i:n,m,r.shouldUnregister?pe(n,m,[]):[])),v=(m,S,V={})=>{const le=pe(a,m);let se=S;if(le){const ie=le._f;ie&&(!ie.disabled&&Re(i,m,Ko(S,ie)),se=Ks(ie.ref)&&gt(S)?"":S,qo(ie.ref)?[...ie.ref.options].forEach(be=>be.selected=se.includes(be.value)):ie.refs?us(ie.ref)?ie.refs.forEach(be=>{(!be.defaultChecked||!be.disabled)&&(Array.isArray(se)?be.checked=!!se.find($e=>$e===be.value):be.checked=se===be.value||!!se)}):ie.refs.forEach(be=>be.checked=be.value===se):_n(ie.ref)?ie.ref.value="":(ie.ref.value=se,ie.ref.type||w.state.next({name:m,values:et(i)})))}(V.shouldDirty||V.shouldTouch)&&f(m,se,V.shouldTouch,V.shouldDirty,!0),V.shouldValidate&&h(m)},z=(m,S,V)=>{for(const le in S){if(!S.hasOwnProperty(le))return;const se=S[le],ie=m+"."+le,be=pe(a,ie);(c.array.has(m)||Je(se)||be&&!be._f)&&!yr(se)?z(ie,se,V):v(ie,se,V)}},T=(m,S,V={})=>{const le=pe(a,m),se=c.array.has(m),ie=et(S);Re(i,m,ie),se?(w.array.next({name:m,values:et(i)}),(y.isDirty||y.dirtyFields||D.isDirty||D.dirtyFields)&&V.shouldDirty&&w.state.next({name:m,dirtyFields:Er(n,i),isDirty:U(m,ie)})):le&&!le._f&&!gt(ie)?z(m,ie,V):v(m,ie,V),Oi(m,c)&&w.state.next({...s,name:m}),w.state.next({name:o.mount?m:void 0,values:et(i)})},J=async m=>{o.mount=!0;const S=m.target;let V=S.name,le=!0;const se=pe(a,V),ie=Me=>{le=Number.isNaN(Me)||yr(Me)&&isNaN(Me.getTime())||ir(Me,pe(i,V,Me))},be=Ri(r.mode),$e=Ri(r.reValidateMode);if(se){let Me,ot;const Jt=S.type?Ti(se._f):cd(m),Pt=m.type===Ei.BLUR||m.type===Ei.FOCUS_OUT,Or=!wd(se._f)&&!r.resolver&&!pe(s.errors,V)&&!se._f.deps||Ad(Pt,pe(s.touchedFields,V),s.isSubmitted,$e,be),Yt=Oi(V,c,Pt);Re(i,V,Jt),Pt?(!S||!S.readOnly)&&(se._f.onBlur&&se._f.onBlur(m),g&&g(0)):se._f.onChange&&se._f.onChange(m);const Nr=f(V,Jt,Pt),Lr=!mt(Nr)||Yt;if(!Pt&&w.state.next({name:V,type:m.type,values:et(i)}),Or)return(y.isValid||D.isValid)&&(r.mode==="onBlur"?Pt&&C():Pt||C()),Lr&&w.state.next({name:V,...Yt?{}:Nr});if(!Pt&&Yt&&w.state.next({...s}),r.resolver){const{errors:Ur}=await F([V]);if(ie(Jt),le){const gs=Li(s.errors,a,V),ps=Li(Ur,a,gs.name||V);Me=ps.error,V=ps.name,ot=mt(Ur)}}else B([V],!0),Me=(await Bi(se,c.disabled,i,I,r.shouldUseNativeValidation))[V],B([V]),ie(Jt),le&&(Me?ot=!1:(y.isValid||D.isValid)&&(ot=await M(a,!0)));le&&(se._f.deps&&(!Array.isArray(se._f.deps)||se._f.deps.length>0)&&h(se._f.deps),x(V,ot,Me,Nr))}},W=(m,S)=>{if(pe(s.errors,S)&&m.focus)return m.focus(),1},h=async(m,S={})=>{let V,le;const se=ss(m);if(r.resolver){const ie=await H(Ze(m)?m:se);V=mt(ie),le=m?!se.some(be=>pe(ie,be)):V}else m?(le=(await Promise.all(se.map(async ie=>{const be=pe(a,ie);return await M(be&&be._f?{[ie]:be}:be)}))).every(Boolean),!(!le&&!s.isValid)&&C()):le=V=await M(a);return w.state.next({...!Nt(m)||(y.isValid||D.isValid)&&V!==s.isValid?{}:{name:m},...r.resolver||!m?{isValid:V}:{},errors:s.errors}),S.shouldFocus&&!le&&as(a,W,m?se:c.mount),le},A=(m,S)=>{let V={...o.mount?i:n};return S&&(V=Wo(S.dirtyFields?s.dirtyFields:s.touchedFields,V)),Ze(m)?V:Nt(m)?pe(V,m):m.map(le=>pe(V,le))},Y=(m,S)=>({invalid:!!pe((S||s).errors,m),isDirty:!!pe((S||s).dirtyFields,m),error:pe((S||s).errors,m),isValidating:!!pe(s.validatingFields,m),isTouched:!!pe((S||s).touchedFields,m)}),ee=m=>{m&&ss(m).forEach(S=>qe(s.errors,S)),w.state.next({errors:m?s.errors:{}})},ae=(m,S,V)=>{const le=(pe(a,m,{_f:{}})._f||{}).ref,se=pe(s.errors,m)||{},{ref:ie,message:be,type:$e,...Me}=se;Re(s.errors,m,{...Me,...S,ref:le}),w.state.next({name:m,errors:s.errors,isValid:!1}),V&&V.shouldFocus&&le&&le.focus&&le.focus()},ne=(m,S)=>Tt(m)?w.state.subscribe({next:V=>"values"in V&&m(Z(void 0,S),V)}):Z(m,S,!0),b=m=>w.state.subscribe({next:S=>{kd(m.name,S.name,m.exact)&&Nd(S,m.formState||y,kt,m.reRenderRoot)&&m.callback({values:{...i},...s,...S,defaultValues:n})}}).unsubscribe,Q=m=>(o.mount=!0,D={...D,...m.formState},b({...m,formState:D})),E=(m,S={})=>{for(const V of m?ss(m):c.mount)c.mount.delete(V),c.array.delete(V),S.keepValue||(qe(a,V),qe(i,V)),!S.keepError&&qe(s.errors,V),!S.keepDirty&&qe(s.dirtyFields,V),!S.keepTouched&&qe(s.touchedFields,V),!S.keepIsValidating&&qe(s.validatingFields,V),!r.shouldUnregister&&!S.keepDefaultValue&&qe(n,V);w.state.next({values:et(i)}),w.state.next({...s,...S.keepDirty?{isDirty:U()}:{}}),!S.keepIsValid&&C()},fe=({disabled:m,name:S})=>{(Wt(m)&&o.mount||m||c.disabled.has(S))&&(m?c.disabled.add(S):c.disabled.delete(S))},ye=(m,S={})=>{let V=pe(a,m);const le=Wt(S.disabled)||Wt(r.disabled);return Re(a,m,{...V||{},_f:{...V&&V._f?V._f:{ref:{name:m}},name:m,mount:!0,...S}}),c.mount.add(m),V?fe({disabled:Wt(S.disabled)?S.disabled:r.disabled,name:m}):k(m,!0,S.value),{...le?{disabled:S.disabled||r.disabled}:{},...r.progressive?{required:!!S.required,min:es(S.min),max:es(S.max),minLength:es(S.minLength),maxLength:es(S.maxLength),pattern:es(S.pattern)}:{},name:m,onChange:J,onBlur:J,ref:se=>{if(se){ye(m,S),V=pe(a,m);const ie=Ze(se.value)&&se.querySelectorAll&&se.querySelectorAll("input,select,textarea")[0]||se,be=xd(ie),$e=V._f.refs||[];if(be?$e.find(Me=>Me===ie):ie===V._f.ref)return;Re(a,m,{_f:{...V._f,...be?{refs:[...$e.filter(Ia),ie,...Array.isArray(pe(n,m))?[{}]:[]],ref:{type:ie.type,name:m}}:{ref:ie}}}),k(m,!1,void 0,ie)}else V=pe(a,m,{}),V._f&&(V._f.mount=!1),(r.shouldUnregister||S.shouldUnregister)&&!(ud(c.array,m)&&o.action)&&c.unMount.add(m)}}},ce=()=>r.shouldFocusError&&as(a,W,c.mount),me=m=>{Wt(m)&&(w.state.next({disabled:m}),as(a,(S,V)=>{const le=pe(a,V);le&&(S.disabled=le._f.disabled||m,Array.isArray(le._f.refs)&&le._f.refs.forEach(se=>{se.disabled=le._f.disabled||m}))},0,!1))},_e=(m,S)=>async V=>{let le;V&&(V.preventDefault&&V.preventDefault(),V.persist&&V.persist());let se=et(i);if(w.state.next({isSubmitting:!0}),r.resolver){const{errors:ie,values:be}=await F();s.errors=ie,se=et(be)}else await M(a);if(c.disabled.size)for(const ie of c.disabled)qe(se,ie);if(qe(s.errors,"root"),mt(s.errors)){w.state.next({errors:{}});try{await m(se,V)}catch(ie){le=ie}}else S&&await S({...s.errors},V),ce(),setTimeout(ce);if(w.state.next({isSubmitted:!0,isSubmitting:!1,isSubmitSuccessful:mt(s.errors)&&!le,submitCount:s.submitCount+1,errors:s.errors}),le)throw le},De=(m,S={})=>{pe(a,m)&&(Ze(S.defaultValue)?T(m,et(pe(n,m))):(T(m,S.defaultValue),Re(n,m,et(S.defaultValue))),S.keepTouched||qe(s.touchedFields,m),S.keepDirty||(qe(s.dirtyFields,m),s.isDirty=S.defaultValue?U(m,et(pe(n,m))):U()),S.keepError||(qe(s.errors,m),y.isValid&&C()),w.state.next({...s}))},xe=(m,S={})=>{const V=m?et(m):n,le=et(V),se=mt(m),ie=se?n:le;if(S.keepDefaultValues||(n=V),!S.keepValues){if(S.keepDirtyValues){const be=new Set([...c.mount,...Object.keys(Er(n,i))]);for(const $e of Array.from(be))pe(s.dirtyFields,$e)?Re(ie,$e,pe(i,$e)):T($e,pe(ie,$e))}else{if(pn&&Ze(m))for(const be of c.mount){const $e=pe(a,be);if($e&&$e._f){const Me=Array.isArray($e._f.refs)?$e._f.refs[0]:$e._f.ref;if(Ks(Me)){const ot=Me.closest("form");if(ot){ot.reset();break}}}}if(S.keepFieldsRef)for(const be of c.mount)T(be,pe(ie,be));else a={}}i=r.shouldUnregister?S.keepDefaultValues?et(n):{}:et(ie),w.array.next({values:{...ie}}),w.state.next({values:{...ie}})}c={mount:S.keepDirtyValues?c.mount:new Set,unMount:new Set,array:new Set,disabled:new Set,watch:new Set,watchAll:!1,focus:""},o.mount=!y.isValid||!!S.keepIsValid||!!S.keepDirtyValues||!r.shouldUnregister&&!mt(ie),o.watch=!!r.shouldUnregister,w.state.next({submitCount:S.keepSubmitCount?s.submitCount:0,isDirty:se?!1:S.keepDirty?s.isDirty:!!(S.keepDefaultValues&&!ir(m,n)),isSubmitted:S.keepIsSubmitted?s.isSubmitted:!1,dirtyFields:se?{}:S.keepDirtyValues?S.keepDefaultValues&&i?Er(n,i):s.dirtyFields:S.keepDefaultValues&&m?Er(n,m):S.keepDirty?s.dirtyFields:{},touchedFields:S.keepTouched?s.touchedFields:{},errors:S.keepErrors?s.errors:{},isSubmitSuccessful:S.keepIsSubmitSuccessful?s.isSubmitSuccessful:!1,isSubmitting:!1,defaultValues:n})},Ee=(m,S)=>xe(Tt(m)?m(i):m,S),Ae=(m,S={})=>{const V=pe(a,m),le=V&&V._f;if(le){const se=le.refs?le.refs[0]:le.ref;se.focus&&(se.focus(),S.shouldSelect&&Tt(se.select)&&se.select())}},kt=m=>{s={...s,...m}},At={control:{register:ye,unregister:E,getFieldState:Y,handleSubmit:_e,setError:ae,_subscribe:b,_runSchema:F,_focusError:ce,_getWatch:Z,_getDirty:U,_setValid:C,_setFieldArray:O,_setDisabledField:fe,_setErrors:p,_getFieldArray:j,_reset:xe,_resetDefaultValues:()=>Tt(r.defaultValues)&&r.defaultValues().then(m=>{Ee(m,r.resetOptions),w.state.next({isLoading:!1})}),_removeUnmounted:L,_disableForm:me,_subjects:w,_proxyFormState:y,get _fields(){return a},get _formValues(){return i},get _state(){return o},set _state(m){o=m},get _defaultValues(){return n},get _names(){return c},set _names(m){c=m},get _formState(){return s},get _options(){return r},set _options(m){r={...r,...m}}},subscribe:Q,trigger:h,register:ye,handleSubmit:_e,watch:ne,setValue:T,getValues:A,reset:Ee,resetField:De,clearErrors:ee,unregister:E,setError:ae,setFocus:Ae,getFieldState:Y};return{...At,formControl:At}}function xt(e={}){const r=tt.useRef(void 0),s=tt.useRef(void 0),[a,n]=tt.useState({isDirty:!1,isValidating:!1,isLoading:Tt(e.defaultValues),isSubmitted:!1,isSubmitting:!1,isSubmitSuccessful:!1,isValid:!1,submitCount:0,dirtyFields:{},touchedFields:{},validatingFields:{},errors:e.errors||{},disabled:e.disabled||!1,isReady:!1,defaultValues:Tt(e.defaultValues)?void 0:e.defaultValues});if(!r.current)if(e.formControl)r.current={...e.formControl,formState:a},e.defaultValues&&!Tt(e.defaultValues)&&e.formControl.reset(e.defaultValues,e.resetOptions);else{const{formControl:o,...c}=zd(e);r.current={...c,formState:a}}const i=r.current.control;return i._options=e,gd(()=>{const o=i._subscribe({formState:i._proxyFormState,callback:()=>n({...i._formState}),reRenderRoot:!0});return n(c=>({...c,isReady:!0})),i._formState.isReady=!0,o},[i]),tt.useEffect(()=>i._disableForm(e.disabled),[i,e.disabled]),tt.useEffect(()=>{e.mode&&(i._options.mode=e.mode),e.reValidateMode&&(i._options.reValidateMode=e.reValidateMode)},[i,e.mode,e.reValidateMode]),tt.useEffect(()=>{e.errors&&(i._setErrors(e.errors),i._focusError())},[i,e.errors]),tt.useEffect(()=>{e.shouldUnregister&&i._subjects.state.next({values:i._getWatch()})},[i,e.shouldUnregister]),tt.useEffect(()=>{if(i._proxyFormState.isDirty){const o=i._getDirty();o!==a.isDirty&&i._subjects.state.next({isDirty:o})}},[i,a.isDirty]),tt.useEffect(()=>{e.values&&!ir(e.values,s.current)?(i._reset(e.values,{keepFieldsRef:!0,...i._options.resetOptions}),s.current=e.values,n(o=>({...o}))):i._resetDefaultValues()},[i,e.values]),tt.useEffect(()=>{i._state.mount||(i._setValid(),i._state.mount=!0),i._state.watch&&(i._state.watch=!1,i._subjects.state.next({...i._formState})),i._removeUnmounted()}),r.current.formState=fd(a,i),r.current}const Vi=(e,r,s)=>{if(e&&"reportValidity"in e){const a=pe(s,r);e.setCustomValidity(a&&a.message||""),e.reportValidity()}},rn=(e,r)=>{for(const s in r.fields){const a=r.fields[s];a&&a.ref&&"reportValidity"in a.ref?Vi(a.ref,s,e):a&&a.refs&&a.refs.forEach(n=>Vi(n,s,e))}},Zi=(e,r)=>{r.shouldUseNativeValidation&&rn(e,r);const s={};for(const a in e){const n=pe(r.fields,a),i=Object.assign(e[a]||{},{ref:n&&n.ref});if(Ed(r.names||Object.keys(e),a)){const o=Object.assign({},pe(s,a));Re(o,"root",i),Re(s,a,o)}else Re(s,a,i)}return s},Ed=(e,r)=>{const s=Wi(r);return e.some(a=>Wi(a).match(`^${s}\\.\\d+`))};function Wi(e){return e.replace(/\]|\[/g,"")}function te(e,r,s){function a(c,g){var _;Object.defineProperty(c,"_zod",{value:c._zod??{},enumerable:!1}),(_=c._zod).traits??(_.traits=new Set),c._zod.traits.add(e),r(c,g);for(const y in o.prototype)y in c||Object.defineProperty(c,y,{value:o.prototype[y].bind(c)});c._zod.constr=o,c._zod.def=g}const n=s?.Parent??Object;class i extends n{}Object.defineProperty(i,"name",{value:e});function o(c){var g;const _=s?.Parent?new i:this;a(_,c),(g=_._zod).deferred??(g.deferred=[]);for(const y of _._zod.deferred)y();return _}return Object.defineProperty(o,"init",{value:a}),Object.defineProperty(o,Symbol.hasInstance,{value:c=>s?.Parent&&c instanceof s.Parent?!0:c?._zod?.traits?.has(e)}),Object.defineProperty(o,"name",{value:e}),o}class Ir extends Error{constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}}class Ho extends Error{constructor(r){super(`Encountered unidirectional transform during encode: ${r}`),this.name="ZodEncodeError"}}const Yo={};function _r(e){return Yo}function Pd(e){const r=Object.values(e).filter(a=>typeof a=="number");return Object.entries(e).filter(([a,n])=>r.indexOf(+a)===-1).map(([a,n])=>n)}function sn(e,r){return typeof r=="bigint"?r.toString():r}function jn(e){return{get value(){{const r=e();return Object.defineProperty(this,"value",{value:r}),r}}}}function wn(e){return e==null}function Nn(e){const r=e.startsWith("^")?1:0,s=e.endsWith("$")?e.length-1:e.length;return e.slice(r,s)}const qi=Symbol("evaluating");function Fe(e,r,s){let a;Object.defineProperty(e,r,{get(){if(a!==qi)return a===void 0&&(a=qi,a=s()),a},set(n){Object.defineProperty(e,r,{value:n})},configurable:!0})}function jr(e,r,s){Object.defineProperty(e,r,{value:s,writable:!0,enumerable:!0,configurable:!0})}function wr(...e){const r={};for(const s of e){const a=Object.getOwnPropertyDescriptors(s);Object.assign(r,a)}return Object.defineProperties({},r)}function Ji(e){return JSON.stringify(e)}const Xo="captureStackTrace"in Error?Error.captureStackTrace:(...e)=>{};function Hs(e){return typeof e=="object"&&e!==null&&!Array.isArray(e)}const Id=jn(()=>{if(typeof navigator<"u"&&navigator?.userAgent?.includes("Cloudflare"))return!1;try{const e=Function;return new e(""),!0}catch{return!1}});function ls(e){if(Hs(e)===!1)return!1;const r=e.constructor;if(r===void 0)return!0;const s=r.prototype;return!(Hs(s)===!1||Object.prototype.hasOwnProperty.call(s,"isPrototypeOf")===!1)}function el(e){return ls(e)?{...e}:Array.isArray(e)?[...e]:e}const $d=new Set(["string","number","symbol"]);function sa(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function cr(e,r,s){const a=new e._zod.constr(r??e._zod.def);return(!r||s?.parent)&&(a._zod.parent=e),a}function ve(e){const r=e;if(!r)return{};if(typeof r=="string")return{error:()=>r};if(r?.message!==void 0){if(r?.error!==void 0)throw new Error("Cannot specify both `message` and `error` params");r.error=r.message}return delete r.message,typeof r.error=="string"?{...r,error:()=>r.error}:r}function Md(e){return Object.keys(e).filter(r=>e[r]._zod.optin==="optional"&&e[r]._zod.optout==="optional")}function Td(e,r){const s=e._zod.def,a=wr(e._zod.def,{get shape(){const n={};for(const i in r){if(!(i in s.shape))throw new Error(`Unrecognized key: "${i}"`);r[i]&&(n[i]=s.shape[i])}return jr(this,"shape",n),n},checks:[]});return cr(e,a)}function Rd(e,r){const s=e._zod.def,a=wr(e._zod.def,{get shape(){const n={...e._zod.def.shape};for(const i in r){if(!(i in s.shape))throw new Error(`Unrecognized key: "${i}"`);r[i]&&delete n[i]}return jr(this,"shape",n),n},checks:[]});return cr(e,a)}function Fd(e,r){if(!ls(r))throw new Error("Invalid input to extend: expected a plain object");const s=e._zod.def.checks;if(s&&s.length>0)throw new Error("Object schemas containing refinements cannot be extended. Use `.safeExtend()` instead.");const n=wr(e._zod.def,{get shape(){const i={...e._zod.def.shape,...r};return jr(this,"shape",i),i},checks:[]});return cr(e,n)}function Od(e,r){if(!ls(r))throw new Error("Invalid input to safeExtend: expected a plain object");const s={...e._zod.def,get shape(){const a={...e._zod.def.shape,...r};return jr(this,"shape",a),a},checks:e._zod.def.checks};return cr(e,s)}function Ld(e,r){const s=wr(e._zod.def,{get shape(){const a={...e._zod.def.shape,...r._zod.def.shape};return jr(this,"shape",a),a},get catchall(){return r._zod.def.catchall},checks:[]});return cr(e,s)}function Ud(e,r,s){const a=wr(r._zod.def,{get shape(){const n=r._zod.def.shape,i={...n};if(s)for(const o in s){if(!(o in n))throw new Error(`Unrecognized key: "${o}"`);s[o]&&(i[o]=e?new e({type:"optional",innerType:n[o]}):n[o])}else for(const o in n)i[o]=e?new e({type:"optional",innerType:n[o]}):n[o];return jr(this,"shape",i),i},checks:[]});return cr(r,a)}function Bd(e,r,s){const a=wr(r._zod.def,{get shape(){const n=r._zod.def.shape,i={...n};if(s)for(const o in s){if(!(o in i))throw new Error(`Unrecognized key: "${o}"`);s[o]&&(i[o]=new e({type:"nonoptional",innerType:n[o]}))}else for(const o in n)i[o]=new e({type:"nonoptional",innerType:n[o]});return jr(this,"shape",i),i},checks:[]});return cr(r,a)}function Pr(e,r=0){if(e.aborted===!0)return!0;for(let s=r;s<e.issues.length;s++)if(e.issues[s]?.continue!==!0)return!0;return!1}function tl(e,r){return r.map(s=>{var a;return(a=s).path??(a.path=[]),s.path.unshift(e),s})}function Os(e){return typeof e=="string"?e:e?.message}function vr(e,r,s){const a={...e,path:e.path??[]};if(!e.message){const n=Os(e.inst?._zod.def?.error?.(e))??Os(r?.error?.(e))??Os(s.customError?.(e))??Os(s.localeError?.(e))??"Invalid input";a.message=n}return delete a.inst,delete a.continue,r?.reportInput||delete a.input,a}function kn(e){return Array.isArray(e)?"array":typeof e=="string"?"string":"unknown"}function cs(...e){const[r,s,a]=e;return typeof r=="string"?{message:r,code:"custom",input:s,inst:a}:{...r}}const rl=(e,r)=>{e.name="$ZodError",Object.defineProperty(e,"_zod",{value:e._zod,enumerable:!1}),Object.defineProperty(e,"issues",{value:r,enumerable:!1}),e.message=JSON.stringify(r,sn,2),Object.defineProperty(e,"toString",{value:()=>e.message,enumerable:!1})},An=te("$ZodError",rl),aa=te("$ZodError",rl,{Parent:Error});function Vd(e,r=s=>s.message){const s={},a=[];for(const n of e.issues)n.path.length>0?(s[n.path[0]]=s[n.path[0]]||[],s[n.path[0]].push(r(n))):a.push(r(n));return{formErrors:a,fieldErrors:s}}function Zd(e,r=s=>s.message){const s={_errors:[]},a=n=>{for(const i of n.issues)if(i.code==="invalid_union"&&i.errors.length)i.errors.map(o=>a({issues:o}));else if(i.code==="invalid_key")a({issues:i.issues});else if(i.code==="invalid_element")a({issues:i.issues});else if(i.path.length===0)s._errors.push(r(i));else{let o=s,c=0;for(;c<i.path.length;){const g=i.path[c];c===i.path.length-1?(o[g]=o[g]||{_errors:[]},o[g]._errors.push(r(i))):o[g]=o[g]||{_errors:[]},o=o[g],c++}}};return a(e),s}const na=e=>(r,s,a,n)=>{const i=a?Object.assign(a,{async:!1}):{async:!1},o=r._zod.run({value:s,issues:[]},i);if(o instanceof Promise)throw new Ir;if(o.issues.length){const c=new(n?.Err??e)(o.issues.map(g=>vr(g,i,_r())));throw Xo(c,n?.callee),c}return o.value},Wd=na(aa),ia=e=>async(r,s,a,n)=>{const i=a?Object.assign(a,{async:!0}):{async:!0};let o=r._zod.run({value:s,issues:[]},i);if(o instanceof Promise&&(o=await o),o.issues.length){const c=new(n?.Err??e)(o.issues.map(g=>vr(g,i,_r())));throw Xo(c,n?.callee),c}return o.value},qd=ia(aa),oa=e=>(r,s,a)=>{const n=a?{...a,async:!1}:{async:!1},i=r._zod.run({value:s,issues:[]},n);if(i instanceof Promise)throw new Ir;return i.issues.length?{success:!1,error:new(e??An)(i.issues.map(o=>vr(o,n,_r())))}:{success:!0,data:i.value}},Jd=oa(aa),la=e=>async(r,s,a)=>{const n=a?Object.assign(a,{async:!0}):{async:!0};let i=r._zod.run({value:s,issues:[]},n);return i instanceof Promise&&(i=await i),i.issues.length?{success:!1,error:new e(i.issues.map(o=>vr(o,n,_r())))}:{success:!0,data:i.value}},Qd=la(aa),Kd=e=>(r,s,a)=>{const n=a?Object.assign(a,{direction:"backward"}):{direction:"backward"};return na(e)(r,s,n)},Gd=e=>(r,s,a)=>na(e)(r,s,a),Hd=e=>async(r,s,a)=>{const n=a?Object.assign(a,{direction:"backward"}):{direction:"backward"};return ia(e)(r,s,n)},Yd=e=>async(r,s,a)=>ia(e)(r,s,a),Xd=e=>(r,s,a)=>{const n=a?Object.assign(a,{direction:"backward"}):{direction:"backward"};return oa(e)(r,s,n)},eu=e=>(r,s,a)=>oa(e)(r,s,a),tu=e=>async(r,s,a)=>{const n=a?Object.assign(a,{direction:"backward"}):{direction:"backward"};return la(e)(r,s,n)},ru=e=>async(r,s,a)=>la(e)(r,s,a),su=/^[cC][^\s-]{8,}$/,au=/^[0-9a-z]+$/,nu=/^[0-9A-HJKMNP-TV-Za-hjkmnp-tv-z]{26}$/,iu=/^[0-9a-vA-V]{20}$/,ou=/^[A-Za-z0-9]{27}$/,lu=/^[a-zA-Z0-9_-]{21}$/,cu=/^P(?:(\d+W)|(?!.*W)(?=\d|T\d)(\d+Y)?(\d+M)?(\d+D)?(T(?=\d)(\d+H)?(\d+M)?(\d+([.,]\d+)?S)?)?)$/,du=/^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12})$/,Qi=e=>e?new RegExp(`^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-${e}[0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12})$`):/^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-8][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/,uu=/^(?!\.)(?!.*\.\.)([A-Za-z0-9_'+\-\.]*)[A-Za-z0-9_+-]@([A-Za-z0-9][A-Za-z0-9\-]*\.)+[A-Za-z]{2,}$/,mu="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";function hu(){return new RegExp(mu,"u")}const fu=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,gu=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:))$/,pu=/^((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/([0-9]|[1-2][0-9]|3[0-2])$/,xu=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|::|([0-9a-fA-F]{1,4})?::([0-9a-fA-F]{1,4}:?){0,6})\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,yu=/^$|^(?:[0-9a-zA-Z+/]{4})*(?:(?:[0-9a-zA-Z+/]{2}==)|(?:[0-9a-zA-Z+/]{3}=))?$/,sl=/^[A-Za-z0-9_-]*$/,bu=/^(?=.{1,253}\.?$)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[-0-9a-zA-Z]{0,61}[0-9a-zA-Z])?)*\.?$/,_u=/^\+(?:[0-9]){6,14}[0-9]$/,al="(?:(?:\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-(?:(?:0[13578]|1[02])-(?:0[1-9]|[12]\\d|3[01])|(?:0[469]|11)-(?:0[1-9]|[12]\\d|30)|(?:02)-(?:0[1-9]|1\\d|2[0-8])))",vu=new RegExp(`^${al}$`);function nl(e){const r="(?:[01]\\d|2[0-3]):[0-5]\\d";return typeof e.precision=="number"?e.precision===-1?`${r}`:e.precision===0?`${r}:[0-5]\\d`:`${r}:[0-5]\\d\\.\\d{${e.precision}}`:`${r}(?::[0-5]\\d(?:\\.\\d+)?)?`}function ju(e){return new RegExp(`^${nl(e)}$`)}function wu(e){const r=nl({precision:e.precision}),s=["Z"];e.local&&s.push(""),e.offset&&s.push("([+-](?:[01]\\d|2[0-3]):[0-5]\\d)");const a=`${r}(?:${s.join("|")})`;return new RegExp(`^${al}T(?:${a})$`)}const Nu=e=>{const r=e?`[\\s\\S]{${e?.minimum??0},${e?.maximum??""}}`:"[\\s\\S]*";return new RegExp(`^${r}$`)},ku=/^(?:true|false)$/i,Au=/^[^A-Z]*$/,Cu=/^[^a-z]*$/,qt=te("$ZodCheck",(e,r)=>{var s;e._zod??(e._zod={}),e._zod.def=r,(s=e._zod).onattach??(s.onattach=[])}),Su=te("$ZodCheckMaxLength",(e,r)=>{var s;qt.init(e,r),(s=e._zod.def).when??(s.when=a=>{const n=a.value;return!wn(n)&&n.length!==void 0}),e._zod.onattach.push(a=>{const n=a._zod.bag.maximum??Number.POSITIVE_INFINITY;r.maximum<n&&(a._zod.bag.maximum=r.maximum)}),e._zod.check=a=>{const n=a.value;if(n.length<=r.maximum)return;const o=kn(n);a.issues.push({origin:o,code:"too_big",maximum:r.maximum,inclusive:!0,input:n,inst:e,continue:!r.abort})}}),Du=te("$ZodCheckMinLength",(e,r)=>{var s;qt.init(e,r),(s=e._zod.def).when??(s.when=a=>{const n=a.value;return!wn(n)&&n.length!==void 0}),e._zod.onattach.push(a=>{const n=a._zod.bag.minimum??Number.NEGATIVE_INFINITY;r.minimum>n&&(a._zod.bag.minimum=r.minimum)}),e._zod.check=a=>{const n=a.value;if(n.length>=r.minimum)return;const o=kn(n);a.issues.push({origin:o,code:"too_small",minimum:r.minimum,inclusive:!0,input:n,inst:e,continue:!r.abort})}}),zu=te("$ZodCheckLengthEquals",(e,r)=>{var s;qt.init(e,r),(s=e._zod.def).when??(s.when=a=>{const n=a.value;return!wn(n)&&n.length!==void 0}),e._zod.onattach.push(a=>{const n=a._zod.bag;n.minimum=r.length,n.maximum=r.length,n.length=r.length}),e._zod.check=a=>{const n=a.value,i=n.length;if(i===r.length)return;const o=kn(n),c=i>r.length;a.issues.push({origin:o,...c?{code:"too_big",maximum:r.length}:{code:"too_small",minimum:r.length},inclusive:!0,exact:!0,input:a.value,inst:e,continue:!r.abort})}}),ca=te("$ZodCheckStringFormat",(e,r)=>{var s,a;qt.init(e,r),e._zod.onattach.push(n=>{const i=n._zod.bag;i.format=r.format,r.pattern&&(i.patterns??(i.patterns=new Set),i.patterns.add(r.pattern))}),r.pattern?(s=e._zod).check??(s.check=n=>{r.pattern.lastIndex=0,!r.pattern.test(n.value)&&n.issues.push({origin:"string",code:"invalid_format",format:r.format,input:n.value,...r.pattern?{pattern:r.pattern.toString()}:{},inst:e,continue:!r.abort})}):(a=e._zod).check??(a.check=()=>{})}),Eu=te("$ZodCheckRegex",(e,r)=>{ca.init(e,r),e._zod.check=s=>{r.pattern.lastIndex=0,!r.pattern.test(s.value)&&s.issues.push({origin:"string",code:"invalid_format",format:"regex",input:s.value,pattern:r.pattern.toString(),inst:e,continue:!r.abort})}}),Pu=te("$ZodCheckLowerCase",(e,r)=>{r.pattern??(r.pattern=Au),ca.init(e,r)}),Iu=te("$ZodCheckUpperCase",(e,r)=>{r.pattern??(r.pattern=Cu),ca.init(e,r)}),$u=te("$ZodCheckIncludes",(e,r)=>{qt.init(e,r);const s=sa(r.includes),a=new RegExp(typeof r.position=="number"?`^.{${r.position}}${s}`:s);r.pattern=a,e._zod.onattach.push(n=>{const i=n._zod.bag;i.patterns??(i.patterns=new Set),i.patterns.add(a)}),e._zod.check=n=>{n.value.includes(r.includes,r.position)||n.issues.push({origin:"string",code:"invalid_format",format:"includes",includes:r.includes,input:n.value,inst:e,continue:!r.abort})}}),Mu=te("$ZodCheckStartsWith",(e,r)=>{qt.init(e,r);const s=new RegExp(`^${sa(r.prefix)}.*`);r.pattern??(r.pattern=s),e._zod.onattach.push(a=>{const n=a._zod.bag;n.patterns??(n.patterns=new Set),n.patterns.add(s)}),e._zod.check=a=>{a.value.startsWith(r.prefix)||a.issues.push({origin:"string",code:"invalid_format",format:"starts_with",prefix:r.prefix,input:a.value,inst:e,continue:!r.abort})}}),Tu=te("$ZodCheckEndsWith",(e,r)=>{qt.init(e,r);const s=new RegExp(`.*${sa(r.suffix)}$`);r.pattern??(r.pattern=s),e._zod.onattach.push(a=>{const n=a._zod.bag;n.patterns??(n.patterns=new Set),n.patterns.add(s)}),e._zod.check=a=>{a.value.endsWith(r.suffix)||a.issues.push({origin:"string",code:"invalid_format",format:"ends_with",suffix:r.suffix,input:a.value,inst:e,continue:!r.abort})}}),Ru=te("$ZodCheckOverwrite",(e,r)=>{qt.init(e,r),e._zod.check=s=>{s.value=r.tx(s.value)}});class Fu{constructor(r=[]){this.content=[],this.indent=0,this&&(this.args=r)}indented(r){this.indent+=1,r(this),this.indent-=1}write(r){if(typeof r=="function"){r(this,{execution:"sync"}),r(this,{execution:"async"});return}const a=r.split(`
`).filter(o=>o),n=Math.min(...a.map(o=>o.length-o.trimStart().length)),i=a.map(o=>o.slice(n)).map(o=>" ".repeat(this.indent*2)+o);for(const o of i)this.content.push(o)}compile(){const r=Function,s=this?.args,n=[...(this?.content??[""]).map(i=>`  ${i}`)];return new r(...s,n.join(`
`))}}const Ou={major:4,minor:1,patch:12},Qe=te("$ZodType",(e,r)=>{var s;e??(e={}),e._zod.def=r,e._zod.bag=e._zod.bag||{},e._zod.version=Ou;const a=[...e._zod.def.checks??[]];e._zod.traits.has("$ZodCheck")&&a.unshift(e);for(const n of a)for(const i of n._zod.onattach)i(e);if(a.length===0)(s=e._zod).deferred??(s.deferred=[]),e._zod.deferred?.push(()=>{e._zod.run=e._zod.parse});else{const n=(o,c,g)=>{let _=Pr(o),y;for(const D of c){if(D._zod.def.when){if(!D._zod.def.when(o))continue}else if(_)continue;const w=o.issues.length,I=D._zod.check(o);if(I instanceof Promise&&g?.async===!1)throw new Ir;if(y||I instanceof Promise)y=(y??Promise.resolve()).then(async()=>{await I,o.issues.length!==w&&(_||(_=Pr(o,w)))});else{if(o.issues.length===w)continue;_||(_=Pr(o,w))}}return y?y.then(()=>o):o},i=(o,c,g)=>{if(Pr(o))return o.aborted=!0,o;const _=n(c,a,g);if(_ instanceof Promise){if(g.async===!1)throw new Ir;return _.then(y=>e._zod.parse(y,g))}return e._zod.parse(_,g)};e._zod.run=(o,c)=>{if(c.skipChecks)return e._zod.parse(o,c);if(c.direction==="backward"){const _=e._zod.parse({value:o.value,issues:[]},{...c,skipChecks:!0});return _ instanceof Promise?_.then(y=>i(y,o,c)):i(_,o,c)}const g=e._zod.parse(o,c);if(g instanceof Promise){if(c.async===!1)throw new Ir;return g.then(_=>n(_,a,c))}return n(g,a,c)}}e["~standard"]={validate:n=>{try{const i=Jd(e,n);return i.success?{value:i.data}:{issues:i.error?.issues}}catch{return Qd(e,n).then(o=>o.success?{value:o.data}:{issues:o.error?.issues})}},vendor:"zod",version:1}}),Cn=te("$ZodString",(e,r)=>{Qe.init(e,r),e._zod.pattern=[...e?._zod.bag?.patterns??[]].pop()??Nu(e._zod.bag),e._zod.parse=(s,a)=>{if(r.coerce)try{s.value=String(s.value)}catch{}return typeof s.value=="string"||s.issues.push({expected:"string",code:"invalid_type",input:s.value,inst:e}),s}}),Ue=te("$ZodStringFormat",(e,r)=>{ca.init(e,r),Cn.init(e,r)}),Lu=te("$ZodGUID",(e,r)=>{r.pattern??(r.pattern=du),Ue.init(e,r)}),Uu=te("$ZodUUID",(e,r)=>{if(r.version){const a={v1:1,v2:2,v3:3,v4:4,v5:5,v6:6,v7:7,v8:8}[r.version];if(a===void 0)throw new Error(`Invalid UUID version: "${r.version}"`);r.pattern??(r.pattern=Qi(a))}else r.pattern??(r.pattern=Qi());Ue.init(e,r)}),Bu=te("$ZodEmail",(e,r)=>{r.pattern??(r.pattern=uu),Ue.init(e,r)}),Vu=te("$ZodURL",(e,r)=>{Ue.init(e,r),e._zod.check=s=>{try{const a=s.value.trim(),n=new URL(a);r.hostname&&(r.hostname.lastIndex=0,r.hostname.test(n.hostname)||s.issues.push({code:"invalid_format",format:"url",note:"Invalid hostname",pattern:bu.source,input:s.value,inst:e,continue:!r.abort})),r.protocol&&(r.protocol.lastIndex=0,r.protocol.test(n.protocol.endsWith(":")?n.protocol.slice(0,-1):n.protocol)||s.issues.push({code:"invalid_format",format:"url",note:"Invalid protocol",pattern:r.protocol.source,input:s.value,inst:e,continue:!r.abort})),r.normalize?s.value=n.href:s.value=a;return}catch{s.issues.push({code:"invalid_format",format:"url",input:s.value,inst:e,continue:!r.abort})}}}),Zu=te("$ZodEmoji",(e,r)=>{r.pattern??(r.pattern=hu()),Ue.init(e,r)}),Wu=te("$ZodNanoID",(e,r)=>{r.pattern??(r.pattern=lu),Ue.init(e,r)}),qu=te("$ZodCUID",(e,r)=>{r.pattern??(r.pattern=su),Ue.init(e,r)}),Ju=te("$ZodCUID2",(e,r)=>{r.pattern??(r.pattern=au),Ue.init(e,r)}),Qu=te("$ZodULID",(e,r)=>{r.pattern??(r.pattern=nu),Ue.init(e,r)}),Ku=te("$ZodXID",(e,r)=>{r.pattern??(r.pattern=iu),Ue.init(e,r)}),Gu=te("$ZodKSUID",(e,r)=>{r.pattern??(r.pattern=ou),Ue.init(e,r)}),Hu=te("$ZodISODateTime",(e,r)=>{r.pattern??(r.pattern=wu(r)),Ue.init(e,r)}),Yu=te("$ZodISODate",(e,r)=>{r.pattern??(r.pattern=vu),Ue.init(e,r)}),Xu=te("$ZodISOTime",(e,r)=>{r.pattern??(r.pattern=ju(r)),Ue.init(e,r)}),em=te("$ZodISODuration",(e,r)=>{r.pattern??(r.pattern=cu),Ue.init(e,r)}),tm=te("$ZodIPv4",(e,r)=>{r.pattern??(r.pattern=fu),Ue.init(e,r),e._zod.onattach.push(s=>{const a=s._zod.bag;a.format="ipv4"})}),rm=te("$ZodIPv6",(e,r)=>{r.pattern??(r.pattern=gu),Ue.init(e,r),e._zod.onattach.push(s=>{const a=s._zod.bag;a.format="ipv6"}),e._zod.check=s=>{try{new URL(`http://[${s.value}]`)}catch{s.issues.push({code:"invalid_format",format:"ipv6",input:s.value,inst:e,continue:!r.abort})}}}),sm=te("$ZodCIDRv4",(e,r)=>{r.pattern??(r.pattern=pu),Ue.init(e,r)}),am=te("$ZodCIDRv6",(e,r)=>{r.pattern??(r.pattern=xu),Ue.init(e,r),e._zod.check=s=>{const a=s.value.split("/");try{if(a.length!==2)throw new Error;const[n,i]=a;if(!i)throw new Error;const o=Number(i);if(`${o}`!==i)throw new Error;if(o<0||o>128)throw new Error;new URL(`http://[${n}]`)}catch{s.issues.push({code:"invalid_format",format:"cidrv6",input:s.value,inst:e,continue:!r.abort})}}});function il(e){if(e==="")return!0;if(e.length%4!==0)return!1;try{return atob(e),!0}catch{return!1}}const nm=te("$ZodBase64",(e,r)=>{r.pattern??(r.pattern=yu),Ue.init(e,r),e._zod.onattach.push(s=>{s._zod.bag.contentEncoding="base64"}),e._zod.check=s=>{il(s.value)||s.issues.push({code:"invalid_format",format:"base64",input:s.value,inst:e,continue:!r.abort})}});function im(e){if(!sl.test(e))return!1;const r=e.replace(/[-_]/g,a=>a==="-"?"+":"/"),s=r.padEnd(Math.ceil(r.length/4)*4,"=");return il(s)}const om=te("$ZodBase64URL",(e,r)=>{r.pattern??(r.pattern=sl),Ue.init(e,r),e._zod.onattach.push(s=>{s._zod.bag.contentEncoding="base64url"}),e._zod.check=s=>{im(s.value)||s.issues.push({code:"invalid_format",format:"base64url",input:s.value,inst:e,continue:!r.abort})}}),lm=te("$ZodE164",(e,r)=>{r.pattern??(r.pattern=_u),Ue.init(e,r)});function cm(e,r=null){try{const s=e.split(".");if(s.length!==3)return!1;const[a]=s;if(!a)return!1;const n=JSON.parse(atob(a));return!("typ"in n&&n?.typ!=="JWT"||!n.alg||r&&(!("alg"in n)||n.alg!==r))}catch{return!1}}const dm=te("$ZodJWT",(e,r)=>{Ue.init(e,r),e._zod.check=s=>{cm(s.value,r.alg)||s.issues.push({code:"invalid_format",format:"jwt",input:s.value,inst:e,continue:!r.abort})}}),um=te("$ZodBoolean",(e,r)=>{Qe.init(e,r),e._zod.pattern=ku,e._zod.parse=(s,a)=>{if(r.coerce)try{s.value=!!s.value}catch{}const n=s.value;return typeof n=="boolean"||s.issues.push({expected:"boolean",code:"invalid_type",input:n,inst:e}),s}}),mm=te("$ZodUnknown",(e,r)=>{Qe.init(e,r),e._zod.parse=s=>s}),hm=te("$ZodNever",(e,r)=>{Qe.init(e,r),e._zod.parse=(s,a)=>(s.issues.push({expected:"never",code:"invalid_type",input:s.value,inst:e}),s)});function Ki(e,r,s){e.issues.length&&r.issues.push(...tl(s,e.issues)),r.value[s]=e.value}const fm=te("$ZodArray",(e,r)=>{Qe.init(e,r),e._zod.parse=(s,a)=>{const n=s.value;if(!Array.isArray(n))return s.issues.push({expected:"array",code:"invalid_type",input:n,inst:e}),s;s.value=Array(n.length);const i=[];for(let o=0;o<n.length;o++){const c=n[o],g=r.element._zod.run({value:c,issues:[]},a);g instanceof Promise?i.push(g.then(_=>Ki(_,s,o))):Ki(g,s,o)}return i.length?Promise.all(i).then(()=>s):s}});function Ys(e,r,s,a){e.issues.length&&r.issues.push(...tl(s,e.issues)),e.value===void 0?s in a&&(r.value[s]=void 0):r.value[s]=e.value}function ol(e){const r=Object.keys(e.shape);for(const a of r)if(!e.shape?.[a]?._zod?.traits?.has("$ZodType"))throw new Error(`Invalid element at key "${a}": expected a Zod schema`);const s=Md(e.shape);return{...e,keys:r,keySet:new Set(r),numKeys:r.length,optionalKeys:new Set(s)}}function ll(e,r,s,a,n,i){const o=[],c=n.keySet,g=n.catchall._zod,_=g.def.type;for(const y of Object.keys(r)){if(c.has(y))continue;if(_==="never"){o.push(y);continue}const D=g.run({value:r[y],issues:[]},a);D instanceof Promise?e.push(D.then(w=>Ys(w,s,y,r))):Ys(D,s,y,r)}return o.length&&s.issues.push({code:"unrecognized_keys",keys:o,input:r,inst:i}),e.length?Promise.all(e).then(()=>s):s}const gm=te("$ZodObject",(e,r)=>{if(Qe.init(e,r),!Object.getOwnPropertyDescriptor(r,"shape")?.get){const c=r.shape;Object.defineProperty(r,"shape",{get:()=>{const g={...c};return Object.defineProperty(r,"shape",{value:g}),g}})}const a=jn(()=>ol(r));Fe(e._zod,"propValues",()=>{const c=r.shape,g={};for(const _ in c){const y=c[_]._zod;if(y.values){g[_]??(g[_]=new Set);for(const D of y.values)g[_].add(D)}}return g});const n=Hs,i=r.catchall;let o;e._zod.parse=(c,g)=>{o??(o=a.value);const _=c.value;if(!n(_))return c.issues.push({expected:"object",code:"invalid_type",input:_,inst:e}),c;c.value={};const y=[],D=o.shape;for(const w of o.keys){const P=D[w]._zod.run({value:_[w],issues:[]},g);P instanceof Promise?y.push(P.then(C=>Ys(C,c,w,_))):Ys(P,c,w,_)}return i?ll(y,_,c,g,a.value,e):y.length?Promise.all(y).then(()=>c):c}}),pm=te("$ZodObjectJIT",(e,r)=>{gm.init(e,r);const s=e._zod.parse,a=jn(()=>ol(r)),n=w=>{const I=new Fu(["shape","payload","ctx"]),P=a.value,C=p=>{const k=Ji(p);return`shape[${k}]._zod.run({ value: input[${k}], issues: [] }, ctx)`};I.write("const input = payload.value;");const B=Object.create(null);let O=0;for(const p of P.keys)B[p]=`key_${O++}`;I.write("const newResult = {};");for(const p of P.keys){const k=B[p],f=Ji(p);I.write(`const ${k} = ${C(p)};`),I.write(`
        if (${k}.issues.length) {
          payload.issues = payload.issues.concat(${k}.issues.map(iss => ({
            ...iss,
            path: iss.path ? [${f}, ...iss.path] : [${f}]
          })));
        }
        
        
        if (${k}.value === undefined) {
          if (${f} in input) {
            newResult[${f}] = undefined;
          }
        } else {
          newResult[${f}] = ${k}.value;
        }
        
      `)}I.write("payload.value = newResult;"),I.write("return payload;");const $=I.compile();return(p,k)=>$(w,p,k)};let i;const o=Hs,c=!Yo.jitless,_=c&&Id.value,y=r.catchall;let D;e._zod.parse=(w,I)=>{D??(D=a.value);const P=w.value;return o(P)?c&&_&&I?.async===!1&&I.jitless!==!0?(i||(i=n(r.shape)),w=i(w,I),y?ll([],P,w,I,D,e):w):s(w,I):(w.issues.push({expected:"object",code:"invalid_type",input:P,inst:e}),w)}});function Gi(e,r,s,a){for(const i of e)if(i.issues.length===0)return r.value=i.value,r;const n=e.filter(i=>!Pr(i));return n.length===1?(r.value=n[0].value,n[0]):(r.issues.push({code:"invalid_union",input:r.value,inst:s,errors:e.map(i=>i.issues.map(o=>vr(o,a,_r())))}),r)}const xm=te("$ZodUnion",(e,r)=>{Qe.init(e,r),Fe(e._zod,"optin",()=>r.options.some(n=>n._zod.optin==="optional")?"optional":void 0),Fe(e._zod,"optout",()=>r.options.some(n=>n._zod.optout==="optional")?"optional":void 0),Fe(e._zod,"values",()=>{if(r.options.every(n=>n._zod.values))return new Set(r.options.flatMap(n=>Array.from(n._zod.values)))}),Fe(e._zod,"pattern",()=>{if(r.options.every(n=>n._zod.pattern)){const n=r.options.map(i=>i._zod.pattern);return new RegExp(`^(${n.map(i=>Nn(i.source)).join("|")})$`)}});const s=r.options.length===1,a=r.options[0]._zod.run;e._zod.parse=(n,i)=>{if(s)return a(n,i);let o=!1;const c=[];for(const g of r.options){const _=g._zod.run({value:n.value,issues:[]},i);if(_ instanceof Promise)c.push(_),o=!0;else{if(_.issues.length===0)return _;c.push(_)}}return o?Promise.all(c).then(g=>Gi(g,n,e,i)):Gi(c,n,e,i)}}),ym=te("$ZodIntersection",(e,r)=>{Qe.init(e,r),e._zod.parse=(s,a)=>{const n=s.value,i=r.left._zod.run({value:n,issues:[]},a),o=r.right._zod.run({value:n,issues:[]},a);return i instanceof Promise||o instanceof Promise?Promise.all([i,o]).then(([g,_])=>Hi(s,g,_)):Hi(s,i,o)}});function an(e,r){if(e===r)return{valid:!0,data:e};if(e instanceof Date&&r instanceof Date&&+e==+r)return{valid:!0,data:e};if(ls(e)&&ls(r)){const s=Object.keys(r),a=Object.keys(e).filter(i=>s.indexOf(i)!==-1),n={...e,...r};for(const i of a){const o=an(e[i],r[i]);if(!o.valid)return{valid:!1,mergeErrorPath:[i,...o.mergeErrorPath]};n[i]=o.data}return{valid:!0,data:n}}if(Array.isArray(e)&&Array.isArray(r)){if(e.length!==r.length)return{valid:!1,mergeErrorPath:[]};const s=[];for(let a=0;a<e.length;a++){const n=e[a],i=r[a],o=an(n,i);if(!o.valid)return{valid:!1,mergeErrorPath:[a,...o.mergeErrorPath]};s.push(o.data)}return{valid:!0,data:s}}return{valid:!1,mergeErrorPath:[]}}function Hi(e,r,s){if(r.issues.length&&e.issues.push(...r.issues),s.issues.length&&e.issues.push(...s.issues),Pr(e))return e;const a=an(r.value,s.value);if(!a.valid)throw new Error(`Unmergable intersection. Error path: ${JSON.stringify(a.mergeErrorPath)}`);return e.value=a.data,e}const bm=te("$ZodEnum",(e,r)=>{Qe.init(e,r);const s=Pd(r.entries),a=new Set(s);e._zod.values=a,e._zod.pattern=new RegExp(`^(${s.filter(n=>$d.has(typeof n)).map(n=>typeof n=="string"?sa(n):n.toString()).join("|")})$`),e._zod.parse=(n,i)=>{const o=n.value;return a.has(o)||n.issues.push({code:"invalid_value",values:s,input:o,inst:e}),n}}),_m=te("$ZodTransform",(e,r)=>{Qe.init(e,r),e._zod.parse=(s,a)=>{if(a.direction==="backward")throw new Ho(e.constructor.name);const n=r.transform(s.value,s);if(a.async)return(n instanceof Promise?n:Promise.resolve(n)).then(o=>(s.value=o,s));if(n instanceof Promise)throw new Ir;return s.value=n,s}});function Yi(e,r){return e.issues.length&&r===void 0?{issues:[],value:void 0}:e}const vm=te("$ZodOptional",(e,r)=>{Qe.init(e,r),e._zod.optin="optional",e._zod.optout="optional",Fe(e._zod,"values",()=>r.innerType._zod.values?new Set([...r.innerType._zod.values,void 0]):void 0),Fe(e._zod,"pattern",()=>{const s=r.innerType._zod.pattern;return s?new RegExp(`^(${Nn(s.source)})?$`):void 0}),e._zod.parse=(s,a)=>{if(r.innerType._zod.optin==="optional"){const n=r.innerType._zod.run(s,a);return n instanceof Promise?n.then(i=>Yi(i,s.value)):Yi(n,s.value)}return s.value===void 0?s:r.innerType._zod.run(s,a)}}),jm=te("$ZodNullable",(e,r)=>{Qe.init(e,r),Fe(e._zod,"optin",()=>r.innerType._zod.optin),Fe(e._zod,"optout",()=>r.innerType._zod.optout),Fe(e._zod,"pattern",()=>{const s=r.innerType._zod.pattern;return s?new RegExp(`^(${Nn(s.source)}|null)$`):void 0}),Fe(e._zod,"values",()=>r.innerType._zod.values?new Set([...r.innerType._zod.values,null]):void 0),e._zod.parse=(s,a)=>s.value===null?s:r.innerType._zod.run(s,a)}),wm=te("$ZodDefault",(e,r)=>{Qe.init(e,r),e._zod.optin="optional",Fe(e._zod,"values",()=>r.innerType._zod.values),e._zod.parse=(s,a)=>{if(a.direction==="backward")return r.innerType._zod.run(s,a);if(s.value===void 0)return s.value=r.defaultValue,s;const n=r.innerType._zod.run(s,a);return n instanceof Promise?n.then(i=>Xi(i,r)):Xi(n,r)}});function Xi(e,r){return e.value===void 0&&(e.value=r.defaultValue),e}const Nm=te("$ZodPrefault",(e,r)=>{Qe.init(e,r),e._zod.optin="optional",Fe(e._zod,"values",()=>r.innerType._zod.values),e._zod.parse=(s,a)=>(a.direction==="backward"||s.value===void 0&&(s.value=r.defaultValue),r.innerType._zod.run(s,a))}),km=te("$ZodNonOptional",(e,r)=>{Qe.init(e,r),Fe(e._zod,"values",()=>{const s=r.innerType._zod.values;return s?new Set([...s].filter(a=>a!==void 0)):void 0}),e._zod.parse=(s,a)=>{const n=r.innerType._zod.run(s,a);return n instanceof Promise?n.then(i=>eo(i,e)):eo(n,e)}});function eo(e,r){return!e.issues.length&&e.value===void 0&&e.issues.push({code:"invalid_type",expected:"nonoptional",input:e.value,inst:r}),e}const Am=te("$ZodCatch",(e,r)=>{Qe.init(e,r),Fe(e._zod,"optin",()=>r.innerType._zod.optin),Fe(e._zod,"optout",()=>r.innerType._zod.optout),Fe(e._zod,"values",()=>r.innerType._zod.values),e._zod.parse=(s,a)=>{if(a.direction==="backward")return r.innerType._zod.run(s,a);const n=r.innerType._zod.run(s,a);return n instanceof Promise?n.then(i=>(s.value=i.value,i.issues.length&&(s.value=r.catchValue({...s,error:{issues:i.issues.map(o=>vr(o,a,_r()))},input:s.value}),s.issues=[]),s)):(s.value=n.value,n.issues.length&&(s.value=r.catchValue({...s,error:{issues:n.issues.map(i=>vr(i,a,_r()))},input:s.value}),s.issues=[]),s)}}),Cm=te("$ZodPipe",(e,r)=>{Qe.init(e,r),Fe(e._zod,"values",()=>r.in._zod.values),Fe(e._zod,"optin",()=>r.in._zod.optin),Fe(e._zod,"optout",()=>r.out._zod.optout),Fe(e._zod,"propValues",()=>r.in._zod.propValues),e._zod.parse=(s,a)=>{if(a.direction==="backward"){const i=r.out._zod.run(s,a);return i instanceof Promise?i.then(o=>Ls(o,r.in,a)):Ls(i,r.in,a)}const n=r.in._zod.run(s,a);return n instanceof Promise?n.then(i=>Ls(i,r.out,a)):Ls(n,r.out,a)}});function Ls(e,r,s){return e.issues.length?(e.aborted=!0,e):r._zod.run({value:e.value,issues:e.issues},s)}const Sm=te("$ZodReadonly",(e,r)=>{Qe.init(e,r),Fe(e._zod,"propValues",()=>r.innerType._zod.propValues),Fe(e._zod,"values",()=>r.innerType._zod.values),Fe(e._zod,"optin",()=>r.innerType._zod.optin),Fe(e._zod,"optout",()=>r.innerType._zod.optout),e._zod.parse=(s,a)=>{if(a.direction==="backward")return r.innerType._zod.run(s,a);const n=r.innerType._zod.run(s,a);return n instanceof Promise?n.then(to):to(n)}});function to(e){return e.value=Object.freeze(e.value),e}const Dm=te("$ZodCustom",(e,r)=>{qt.init(e,r),Qe.init(e,r),e._zod.parse=(s,a)=>s,e._zod.check=s=>{const a=s.value,n=r.fn(a);if(n instanceof Promise)return n.then(i=>ro(i,s,a,e));ro(n,s,a,e)}});function ro(e,r,s,a){if(!e){const n={code:"custom",input:s,inst:a,path:[...a._zod.def.path??[]],continue:!a._zod.def.abort};a._zod.def.params&&(n.params=a._zod.def.params),r.issues.push(cs(n))}}class zm{constructor(){this._map=new WeakMap,this._idmap=new Map}add(r,...s){const a=s[0];if(this._map.set(r,a),a&&typeof a=="object"&&"id"in a){if(this._idmap.has(a.id))throw new Error(`ID ${a.id} already exists in the registry`);this._idmap.set(a.id,r)}return this}clear(){return this._map=new WeakMap,this._idmap=new Map,this}remove(r){const s=this._map.get(r);return s&&typeof s=="object"&&"id"in s&&this._idmap.delete(s.id),this._map.delete(r),this}get(r){const s=r._zod.parent;if(s){const a={...this.get(s)??{}};delete a.id;const n={...a,...this._map.get(r)};return Object.keys(n).length?n:void 0}return this._map.get(r)}has(r){return this._map.has(r)}}function Em(){return new zm}const Us=Em();function Pm(e,r){return new e({type:"string",...ve(r)})}function Im(e,r){return new e({type:"string",format:"email",check:"string_format",abort:!1,...ve(r)})}function so(e,r){return new e({type:"string",format:"guid",check:"string_format",abort:!1,...ve(r)})}function $m(e,r){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,...ve(r)})}function Mm(e,r){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v4",...ve(r)})}function Tm(e,r){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v6",...ve(r)})}function Rm(e,r){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v7",...ve(r)})}function Fm(e,r){return new e({type:"string",format:"url",check:"string_format",abort:!1,...ve(r)})}function Om(e,r){return new e({type:"string",format:"emoji",check:"string_format",abort:!1,...ve(r)})}function Lm(e,r){return new e({type:"string",format:"nanoid",check:"string_format",abort:!1,...ve(r)})}function Um(e,r){return new e({type:"string",format:"cuid",check:"string_format",abort:!1,...ve(r)})}function Bm(e,r){return new e({type:"string",format:"cuid2",check:"string_format",abort:!1,...ve(r)})}function Vm(e,r){return new e({type:"string",format:"ulid",check:"string_format",abort:!1,...ve(r)})}function Zm(e,r){return new e({type:"string",format:"xid",check:"string_format",abort:!1,...ve(r)})}function Wm(e,r){return new e({type:"string",format:"ksuid",check:"string_format",abort:!1,...ve(r)})}function qm(e,r){return new e({type:"string",format:"ipv4",check:"string_format",abort:!1,...ve(r)})}function Jm(e,r){return new e({type:"string",format:"ipv6",check:"string_format",abort:!1,...ve(r)})}function Qm(e,r){return new e({type:"string",format:"cidrv4",check:"string_format",abort:!1,...ve(r)})}function Km(e,r){return new e({type:"string",format:"cidrv6",check:"string_format",abort:!1,...ve(r)})}function Gm(e,r){return new e({type:"string",format:"base64",check:"string_format",abort:!1,...ve(r)})}function Hm(e,r){return new e({type:"string",format:"base64url",check:"string_format",abort:!1,...ve(r)})}function Ym(e,r){return new e({type:"string",format:"e164",check:"string_format",abort:!1,...ve(r)})}function Xm(e,r){return new e({type:"string",format:"jwt",check:"string_format",abort:!1,...ve(r)})}function eh(e,r){return new e({type:"string",format:"datetime",check:"string_format",offset:!1,local:!1,precision:null,...ve(r)})}function th(e,r){return new e({type:"string",format:"date",check:"string_format",...ve(r)})}function rh(e,r){return new e({type:"string",format:"time",check:"string_format",precision:null,...ve(r)})}function sh(e,r){return new e({type:"string",format:"duration",check:"string_format",...ve(r)})}function ah(e,r){return new e({type:"boolean",...ve(r)})}function nh(e){return new e({type:"unknown"})}function ih(e,r){return new e({type:"never",...ve(r)})}function cl(e,r){return new Su({check:"max_length",...ve(r),maximum:e})}function Xs(e,r){return new Du({check:"min_length",...ve(r),minimum:e})}function dl(e,r){return new zu({check:"length_equals",...ve(r),length:e})}function oh(e,r){return new Eu({check:"string_format",format:"regex",...ve(r),pattern:e})}function lh(e){return new Pu({check:"string_format",format:"lowercase",...ve(e)})}function ch(e){return new Iu({check:"string_format",format:"uppercase",...ve(e)})}function dh(e,r){return new $u({check:"string_format",format:"includes",...ve(r),includes:e})}function uh(e,r){return new Mu({check:"string_format",format:"starts_with",...ve(r),prefix:e})}function mh(e,r){return new Tu({check:"string_format",format:"ends_with",...ve(r),suffix:e})}function ms(e){return new Ru({check:"overwrite",tx:e})}function hh(e){return ms(r=>r.normalize(e))}function fh(){return ms(e=>e.trim())}function gh(){return ms(e=>e.toLowerCase())}function ph(){return ms(e=>e.toUpperCase())}function xh(e,r,s){return new e({type:"array",element:r,...ve(s)})}function yh(e,r,s){return new e({type:"custom",check:"custom",fn:r,...ve(s)})}function bh(e){const r=_h(s=>(s.addIssue=a=>{if(typeof a=="string")s.issues.push(cs(a,s.value,r._zod.def));else{const n=a;n.fatal&&(n.continue=!1),n.code??(n.code="custom"),n.input??(n.input=s.value),n.inst??(n.inst=r),n.continue??(n.continue=!r._zod.def.abort),s.issues.push(cs(n))}},e(s.value,s)));return r}function _h(e,r){const s=new qt({check:"custom",...ve(r)});return s._zod.check=e,s}function ao(e,r){try{var s=e()}catch(a){return r(a)}return s&&s.then?s.then(void 0,r):s}function vh(e,r){for(var s={};e.length;){var a=e[0],n=a.code,i=a.message,o=a.path.join(".");if(!s[o])if("unionErrors"in a){var c=a.unionErrors[0].errors[0];s[o]={message:c.message,type:c.code}}else s[o]={message:i,type:n};if("unionErrors"in a&&a.unionErrors.forEach(function(y){return y.errors.forEach(function(D){return e.push(D)})}),r){var g=s[o].types,_=g&&g[a.code];s[o]=bn(o,r,s,n,_?[].concat(_,a.message):a.message)}e.shift()}return s}function jh(e,r){for(var s={};e.length;){var a=e[0],n=a.code,i=a.message,o=a.path.join(".");if(!s[o])if(a.code==="invalid_union"&&a.errors.length>0){var c=a.errors[0][0];s[o]={message:c.message,type:c.code}}else s[o]={message:i,type:n};if(a.code==="invalid_union"&&a.errors.forEach(function(y){return y.forEach(function(D){return e.push(D)})}),r){var g=s[o].types,_=g&&g[a.code];s[o]=bn(o,r,s,n,_?[].concat(_,a.message):a.message)}e.shift()}return s}function yt(e,r,s){if(s===void 0&&(s={}),(function(a){return"_def"in a&&typeof a._def=="object"&&"typeName"in a._def})(e))return function(a,n,i){try{return Promise.resolve(ao(function(){return Promise.resolve(e[s.mode==="sync"?"parse":"parseAsync"](a,r)).then(function(o){return i.shouldUseNativeValidation&&rn({},i),{errors:{},values:s.raw?Object.assign({},a):o}})},function(o){if((function(c){return Array.isArray(c?.issues)})(o))return{values:{},errors:Zi(vh(o.errors,!i.shouldUseNativeValidation&&i.criteriaMode==="all"),i)};throw o}))}catch(o){return Promise.reject(o)}};if((function(a){return"_zod"in a&&typeof a._zod=="object"})(e))return function(a,n,i){try{return Promise.resolve(ao(function(){return Promise.resolve((s.mode==="sync"?Wd:qd)(e,a,r)).then(function(o){return i.shouldUseNativeValidation&&rn({},i),{errors:{},values:s.raw?Object.assign({},a):o}})},function(o){if((function(c){return c instanceof An})(o))return{values:{},errors:Zi(jh(o.issues,!i.shouldUseNativeValidation&&i.criteriaMode==="all"),i)};throw o}))}catch(o){return Promise.reject(o)}};throw new Error("Invalid input: not a Zod schema")}const wh=te("ZodISODateTime",(e,r)=>{Hu.init(e,r),Be.init(e,r)});function Nh(e){return eh(wh,e)}const kh=te("ZodISODate",(e,r)=>{Yu.init(e,r),Be.init(e,r)});function Ah(e){return th(kh,e)}const Ch=te("ZodISOTime",(e,r)=>{Xu.init(e,r),Be.init(e,r)});function Sh(e){return rh(Ch,e)}const Dh=te("ZodISODuration",(e,r)=>{em.init(e,r),Be.init(e,r)});function zh(e){return sh(Dh,e)}const Eh=(e,r)=>{An.init(e,r),e.name="ZodError",Object.defineProperties(e,{format:{value:s=>Zd(e,s)},flatten:{value:s=>Vd(e,s)},addIssue:{value:s=>{e.issues.push(s),e.message=JSON.stringify(e.issues,sn,2)}},addIssues:{value:s=>{e.issues.push(...s),e.message=JSON.stringify(e.issues,sn,2)}},isEmpty:{get(){return e.issues.length===0}}})},Et=te("ZodError",Eh,{Parent:Error}),Ph=na(Et),Ih=ia(Et),$h=oa(Et),Mh=la(Et),Th=Kd(Et),Rh=Gd(Et),Fh=Hd(Et),Oh=Yd(Et),Lh=Xd(Et),Uh=eu(Et),Bh=tu(Et),Vh=ru(Et),He=te("ZodType",(e,r)=>(Qe.init(e,r),e.def=r,e.type=r.type,Object.defineProperty(e,"_def",{value:r}),e.check=(...s)=>e.clone(wr(r,{checks:[...r.checks??[],...s.map(a=>typeof a=="function"?{_zod:{check:a,def:{check:"custom"},onattach:[]}}:a)]})),e.clone=(s,a)=>cr(e,s,a),e.brand=()=>e,e.register=((s,a)=>(s.add(e,a),e)),e.parse=(s,a)=>Ph(e,s,a,{callee:e.parse}),e.safeParse=(s,a)=>$h(e,s,a),e.parseAsync=async(s,a)=>Ih(e,s,a,{callee:e.parseAsync}),e.safeParseAsync=async(s,a)=>Mh(e,s,a),e.spa=e.safeParseAsync,e.encode=(s,a)=>Th(e,s,a),e.decode=(s,a)=>Rh(e,s,a),e.encodeAsync=async(s,a)=>Fh(e,s,a),e.decodeAsync=async(s,a)=>Oh(e,s,a),e.safeEncode=(s,a)=>Lh(e,s,a),e.safeDecode=(s,a)=>Uh(e,s,a),e.safeEncodeAsync=async(s,a)=>Bh(e,s,a),e.safeDecodeAsync=async(s,a)=>Vh(e,s,a),e.refine=(s,a)=>e.check($f(s,a)),e.superRefine=s=>e.check(Mf(s)),e.overwrite=s=>e.check(ms(s)),e.optional=()=>oo(e),e.nullable=()=>lo(e),e.nullish=()=>oo(lo(e)),e.nonoptional=s=>Cf(e,s),e.array=()=>Js(e),e.or=s=>xf([e,s]),e.and=s=>bf(e,s),e.transform=s=>co(e,vf(s)),e.default=s=>Nf(e,s),e.prefault=s=>Af(e,s),e.catch=s=>Df(e,s),e.pipe=s=>co(e,s),e.readonly=()=>Pf(e),e.describe=s=>{const a=e.clone();return Us.add(a,{description:s}),a},Object.defineProperty(e,"description",{get(){return Us.get(e)?.description},configurable:!0}),e.meta=(...s)=>{if(s.length===0)return Us.get(e);const a=e.clone();return Us.add(a,s[0]),a},e.isOptional=()=>e.safeParse(void 0).success,e.isNullable=()=>e.safeParse(null).success,e)),ul=te("_ZodString",(e,r)=>{Cn.init(e,r),He.init(e,r);const s=e._zod.bag;e.format=s.format??null,e.minLength=s.minimum??null,e.maxLength=s.maximum??null,e.regex=(...a)=>e.check(oh(...a)),e.includes=(...a)=>e.check(dh(...a)),e.startsWith=(...a)=>e.check(uh(...a)),e.endsWith=(...a)=>e.check(mh(...a)),e.min=(...a)=>e.check(Xs(...a)),e.max=(...a)=>e.check(cl(...a)),e.length=(...a)=>e.check(dl(...a)),e.nonempty=(...a)=>e.check(Xs(1,...a)),e.lowercase=a=>e.check(lh(a)),e.uppercase=a=>e.check(ch(a)),e.trim=()=>e.check(fh()),e.normalize=(...a)=>e.check(hh(...a)),e.toLowerCase=()=>e.check(gh()),e.toUpperCase=()=>e.check(ph())}),Zh=te("ZodString",(e,r)=>{Cn.init(e,r),ul.init(e,r),e.email=s=>e.check(Im(Wh,s)),e.url=s=>e.check(Fm(qh,s)),e.jwt=s=>e.check(Xm(lf,s)),e.emoji=s=>e.check(Om(Jh,s)),e.guid=s=>e.check(so(no,s)),e.uuid=s=>e.check($m(Bs,s)),e.uuidv4=s=>e.check(Mm(Bs,s)),e.uuidv6=s=>e.check(Tm(Bs,s)),e.uuidv7=s=>e.check(Rm(Bs,s)),e.nanoid=s=>e.check(Lm(Qh,s)),e.guid=s=>e.check(so(no,s)),e.cuid=s=>e.check(Um(Kh,s)),e.cuid2=s=>e.check(Bm(Gh,s)),e.ulid=s=>e.check(Vm(Hh,s)),e.base64=s=>e.check(Gm(af,s)),e.base64url=s=>e.check(Hm(nf,s)),e.xid=s=>e.check(Zm(Yh,s)),e.ksuid=s=>e.check(Wm(Xh,s)),e.ipv4=s=>e.check(qm(ef,s)),e.ipv6=s=>e.check(Jm(tf,s)),e.cidrv4=s=>e.check(Qm(rf,s)),e.cidrv6=s=>e.check(Km(sf,s)),e.e164=s=>e.check(Ym(of,s)),e.datetime=s=>e.check(Nh(s)),e.date=s=>e.check(Ah(s)),e.time=s=>e.check(Sh(s)),e.duration=s=>e.check(zh(s))});function ke(e){return Pm(Zh,e)}const Be=te("ZodStringFormat",(e,r)=>{Ue.init(e,r),ul.init(e,r)}),Wh=te("ZodEmail",(e,r)=>{Bu.init(e,r),Be.init(e,r)}),no=te("ZodGUID",(e,r)=>{Lu.init(e,r),Be.init(e,r)}),Bs=te("ZodUUID",(e,r)=>{Uu.init(e,r),Be.init(e,r)}),qh=te("ZodURL",(e,r)=>{Vu.init(e,r),Be.init(e,r)}),Jh=te("ZodEmoji",(e,r)=>{Zu.init(e,r),Be.init(e,r)}),Qh=te("ZodNanoID",(e,r)=>{Wu.init(e,r),Be.init(e,r)}),Kh=te("ZodCUID",(e,r)=>{qu.init(e,r),Be.init(e,r)}),Gh=te("ZodCUID2",(e,r)=>{Ju.init(e,r),Be.init(e,r)}),Hh=te("ZodULID",(e,r)=>{Qu.init(e,r),Be.init(e,r)}),Yh=te("ZodXID",(e,r)=>{Ku.init(e,r),Be.init(e,r)}),Xh=te("ZodKSUID",(e,r)=>{Gu.init(e,r),Be.init(e,r)}),ef=te("ZodIPv4",(e,r)=>{tm.init(e,r),Be.init(e,r)}),tf=te("ZodIPv6",(e,r)=>{rm.init(e,r),Be.init(e,r)}),rf=te("ZodCIDRv4",(e,r)=>{sm.init(e,r),Be.init(e,r)}),sf=te("ZodCIDRv6",(e,r)=>{am.init(e,r),Be.init(e,r)}),af=te("ZodBase64",(e,r)=>{nm.init(e,r),Be.init(e,r)}),nf=te("ZodBase64URL",(e,r)=>{om.init(e,r),Be.init(e,r)}),of=te("ZodE164",(e,r)=>{lm.init(e,r),Be.init(e,r)}),lf=te("ZodJWT",(e,r)=>{dm.init(e,r),Be.init(e,r)}),cf=te("ZodBoolean",(e,r)=>{um.init(e,r),He.init(e,r)});function df(e){return ah(cf,e)}const uf=te("ZodUnknown",(e,r)=>{mm.init(e,r),He.init(e,r)});function io(){return nh(uf)}const mf=te("ZodNever",(e,r)=>{hm.init(e,r),He.init(e,r)});function hf(e){return ih(mf,e)}const ff=te("ZodArray",(e,r)=>{fm.init(e,r),He.init(e,r),e.element=r.element,e.min=(s,a)=>e.check(Xs(s,a)),e.nonempty=s=>e.check(Xs(1,s)),e.max=(s,a)=>e.check(cl(s,a)),e.length=(s,a)=>e.check(dl(s,a)),e.unwrap=()=>e.element});function Js(e,r){return xh(ff,e,r)}const gf=te("ZodObject",(e,r)=>{pm.init(e,r),He.init(e,r),Fe(e,"shape",()=>r.shape),e.keyof=()=>on(Object.keys(e._zod.def.shape)),e.catchall=s=>e.clone({...e._zod.def,catchall:s}),e.passthrough=()=>e.clone({...e._zod.def,catchall:io()}),e.loose=()=>e.clone({...e._zod.def,catchall:io()}),e.strict=()=>e.clone({...e._zod.def,catchall:hf()}),e.strip=()=>e.clone({...e._zod.def,catchall:void 0}),e.extend=s=>Fd(e,s),e.safeExtend=s=>Od(e,s),e.merge=s=>Ld(e,s),e.pick=s=>Td(e,s),e.omit=s=>Rd(e,s),e.partial=(...s)=>Ud(ml,e,s[0]),e.required=(...s)=>Bd(hl,e,s[0])});function bt(e,r){const s={type:"object",shape:e??{},...ve(r)};return new gf(s)}const pf=te("ZodUnion",(e,r)=>{xm.init(e,r),He.init(e,r),e.options=r.options});function xf(e,r){return new pf({type:"union",options:e,...ve(r)})}const yf=te("ZodIntersection",(e,r)=>{ym.init(e,r),He.init(e,r)});function bf(e,r){return new yf({type:"intersection",left:e,right:r})}const nn=te("ZodEnum",(e,r)=>{bm.init(e,r),He.init(e,r),e.enum=r.entries,e.options=Object.values(r.entries);const s=new Set(Object.keys(r.entries));e.extract=(a,n)=>{const i={};for(const o of a)if(s.has(o))i[o]=r.entries[o];else throw new Error(`Key ${o} not found in enum`);return new nn({...r,checks:[],...ve(n),entries:i})},e.exclude=(a,n)=>{const i={...r.entries};for(const o of a)if(s.has(o))delete i[o];else throw new Error(`Key ${o} not found in enum`);return new nn({...r,checks:[],...ve(n),entries:i})}});function on(e,r){const s=Array.isArray(e)?Object.fromEntries(e.map(a=>[a,a])):e;return new nn({type:"enum",entries:s,...ve(r)})}const _f=te("ZodTransform",(e,r)=>{_m.init(e,r),He.init(e,r),e._zod.parse=(s,a)=>{if(a.direction==="backward")throw new Ho(e.constructor.name);s.addIssue=i=>{if(typeof i=="string")s.issues.push(cs(i,s.value,r));else{const o=i;o.fatal&&(o.continue=!1),o.code??(o.code="custom"),o.input??(o.input=s.value),o.inst??(o.inst=e),s.issues.push(cs(o))}};const n=r.transform(s.value,s);return n instanceof Promise?n.then(i=>(s.value=i,s)):(s.value=n,s)}});function vf(e){return new _f({type:"transform",transform:e})}const ml=te("ZodOptional",(e,r)=>{vm.init(e,r),He.init(e,r),e.unwrap=()=>e._zod.def.innerType});function oo(e){return new ml({type:"optional",innerType:e})}const jf=te("ZodNullable",(e,r)=>{jm.init(e,r),He.init(e,r),e.unwrap=()=>e._zod.def.innerType});function lo(e){return new jf({type:"nullable",innerType:e})}const wf=te("ZodDefault",(e,r)=>{wm.init(e,r),He.init(e,r),e.unwrap=()=>e._zod.def.innerType,e.removeDefault=e.unwrap});function Nf(e,r){return new wf({type:"default",innerType:e,get defaultValue(){return typeof r=="function"?r():el(r)}})}const kf=te("ZodPrefault",(e,r)=>{Nm.init(e,r),He.init(e,r),e.unwrap=()=>e._zod.def.innerType});function Af(e,r){return new kf({type:"prefault",innerType:e,get defaultValue(){return typeof r=="function"?r():el(r)}})}const hl=te("ZodNonOptional",(e,r)=>{km.init(e,r),He.init(e,r),e.unwrap=()=>e._zod.def.innerType});function Cf(e,r){return new hl({type:"nonoptional",innerType:e,...ve(r)})}const Sf=te("ZodCatch",(e,r)=>{Am.init(e,r),He.init(e,r),e.unwrap=()=>e._zod.def.innerType,e.removeCatch=e.unwrap});function Df(e,r){return new Sf({type:"catch",innerType:e,catchValue:typeof r=="function"?r:()=>r})}const zf=te("ZodPipe",(e,r)=>{Cm.init(e,r),He.init(e,r),e.in=r.in,e.out=r.out});function co(e,r){return new zf({type:"pipe",in:e,out:r})}const Ef=te("ZodReadonly",(e,r)=>{Sm.init(e,r),He.init(e,r),e.unwrap=()=>e._zod.def.innerType});function Pf(e){return new Ef({type:"readonly",innerType:e})}const If=te("ZodCustom",(e,r)=>{Dm.init(e,r),He.init(e,r)});function $f(e,r={}){return yh(If,e,r)}function Mf(e){return bh(e)}const oe=u.forwardRef(({variant:e="primary",size:r="md",isLoading:s=!1,fullWidth:a=!1,className:n="",disabled:i,children:o,...c},g)=>{const _="inline-flex items-center justify-center font-medium transition-transform duration-150 ease-out focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-[#55ACBF] disabled:opacity-50 disabled:cursor-not-allowed select-none touch-manipulation active:scale-95 min-h-[48px]",y={primary:"bg-gradient-to-r from-[#7DD3DC] to-[#5CBCC7] text-white hover:opacity-90 shadow-md hover:shadow-lg",secondary:"bg-gray-200 text-gray-dark hover:bg-gray-300",outline:"border-2 border-blue-primary text-blue-primary hover:bg-blue-50 bg-white"},D={sm:"px-4 py-2 text-sm rounded-2xl",md:"px-6 py-3 text-base rounded-2xl",lg:"px-6 py-4 text-base font-bold rounded-2xl"},w=a?"w-full":"";return t.jsx("button",{ref:g,className:`${_} ${y[e]} ${D[r]} ${w} ${n}`,disabled:i||s,...c,children:s?t.jsxs(t.Fragment,{children:[t.jsxs("svg",{className:"animate-spin -ml-1 mr-2 h-4 w-4 text-current",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[t.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),t.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Загрузка..."]}):o})});oe.displayName="Button";const he=u.forwardRef(({label:e,error:r,helperText:s,fullWidth:a=!1,className:n="",type:i="text",id:o,...c},g)=>{const _=o||e?.toLowerCase().replace(/\s+/g,"-"),y=a?"w-full":"";return t.jsxs("div",{className:`${y}`,children:[e&&t.jsx("label",{htmlFor:_,className:"block text-sm font-manrope font-normal text-gray-dark mb-2",children:e}),t.jsx("input",{ref:g,id:_,type:i,className:`
            block w-full px-4 py-3.5 
            border rounded-xl
            text-base font-manrope text-gray-dark placeholder-gray-400
            focus:outline-none focus:ring-2 focus:ring-offset-0
            transition-colors
            bg-[#F5F5F5]
            ${r?"border-red-500 focus:ring-red-500 focus:border-red-500":"border-transparent focus:ring-blue-primary focus:border-blue-primary"}
            disabled:bg-gray-100 disabled:cursor-not-allowed
            ${n}
          `,...c}),r&&t.jsx("p",{className:"mt-1 text-sm font-manrope text-red-600",children:r}),s&&!r&&t.jsx("p",{className:"mt-1 text-sm font-manrope text-gray-500",children:s})]})});he.displayName="Input";const ea=({isOpen:e,onClose:r,title:s,children:a,size:n="md"})=>{const i=u.useRef(null);if(u.useEffect(()=>{const c=g=>{i.current&&!i.current.contains(g.target)&&r()};return e&&(document.addEventListener("mousedown",c),document.body.style.overflow="hidden"),()=>{document.removeEventListener("mousedown",c),document.body.style.overflow="unset"}},[e,r]),u.useEffect(()=>{const c=g=>{g.key==="Escape"&&r()};return e&&document.addEventListener("keydown",c),()=>{document.removeEventListener("keydown",c)}},[e,r]),!e)return null;const o={sm:"sm:max-w-sm",md:"sm:max-w-md",lg:"sm:max-w-lg"};return t.jsx("div",{className:"fixed inset-0 z-50 flex items-start justify-center p-4 sm:p-6 bg-black/40 overflow-y-auto",children:t.jsxs("div",{ref:i,className:`relative mt-8 sm:mt-12 bg-white rounded-3xl shadow-xl w-full ${o[n]} max-h-[calc(100dvh-3rem)] sm:max-h-[90vh] overflow-y-auto`,children:[s&&t.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[t.jsx("h2",{className:"text-xl font-bold",style:{color:"#7DD3DC"},children:s}),t.jsx("button",{onClick:r,className:"p-2 text-gray-400 hover:text-gray-600 transition-colors","aria-label":"Закрыть",children:t.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),t.jsx("div",{className:"p-6",children:a})]})})},fl=u.forwardRef(({label:e,error:r,helperText:s,fullWidth:a=!1,className:n="",id:i,options:o,...c},g)=>{const _=i||e?.toLowerCase().replace(/\s+/g,"-"),y=a?"w-full":"";return t.jsxs("div",{className:`${y}`,children:[e&&t.jsx("label",{htmlFor:_,className:"block text-sm font-manrope font-normal text-gray-dark mb-2",children:e}),t.jsx("select",{ref:g,id:_,className:`
            block w-full px-4 py-3.5 
            border rounded-xl
            text-base font-manrope text-gray-dark
            focus:outline-none focus:ring-2 focus:ring-offset-0
            transition-colors
            bg-[#F5F5F5]
            ${r?"border-red-500 focus:ring-red-500 focus:border-red-500":"border-transparent focus:ring-blue-primary focus:border-blue-primary"}
            disabled:bg-gray-100 disabled:cursor-not-allowed
            ${n}
          `,...c,children:o.map(D=>t.jsx("option",{value:D.value,children:D.label},D.value))}),r&&t.jsx("p",{className:"mt-1 text-sm font-manrope text-red-600",children:r}),s&&!r&&t.jsx("p",{className:"mt-1 text-sm font-manrope text-gray-500",children:s})]})});fl.displayName="Select";const Tf=u.forwardRef(({label:e,error:r,helperText:s,className:a="",id:n,...i},o)=>{const c=n||e?.toLowerCase().replace(/\s+/g,"-");return t.jsxs("div",{className:"flex items-start",children:[t.jsx("div",{className:"flex items-center h-5",children:t.jsx("input",{ref:o,id:c,type:"checkbox",className:`
              w-5 h-5
              rounded border-gray-300
              text-blue-primary
              focus:ring-2 focus:ring-blue-primary focus:ring-offset-0
              transition-colors
              cursor-pointer
              ${r?"border-red-500":""}
              ${a}
            `,...i})}),e&&t.jsxs("div",{className:"ml-3 flex-1",children:[t.jsx("label",{htmlFor:c,className:"text-sm font-manrope font-normal text-gray-dark cursor-pointer",children:e}),r&&t.jsx("p",{className:"mt-1 text-sm font-manrope text-red-600",children:r}),s&&!r&&t.jsx("p",{className:"mt-1 text-sm font-manrope text-gray-500",children:s})]})]})});Tf.displayName="Checkbox";function Rf(){return"https://supabase.healapp.ru"}function Ff(){const e=Rf();return e.includes(":54327")?e.replace(":54327",":54325"):e.replace(/\/$/,"")}function hs(e){return`${Ff().replace(/\/$/,"")}/functions/v1/${e}`}const Of=bt({email:ke().email("Некорректный email адрес"),password:ke().min(6,"Пароль должен содержать минимум 6 символов"),confirmPassword:ke()}).refine(e=>e.password===e.confirmPassword,{message:"Пароли не совпадают",path:["confirmPassword"]}),Lf=bt({phone:ke().min(10,"Введите номер телефона"),password:ke().min(6,"Пароль должен содержать минимум 6 символов"),confirmPassword:ke().min(1,"Подтвердите пароль")}).refine(e=>e.password===e.confirmPassword,{message:"Пароли не совпадают",path:["confirmPassword"]}),Uf={admin:"Администратор",manager:"Руководитель",caregiver:"Сиделка",doctor:"Врач"},Bf=e=>{let r=e.trim().replace(/\s+/g,"");return r?(r=r.replace(/[^\d+]/g,""),r.startsWith("+")?r:r.startsWith("8")?`+7${r.slice(1)}`:r.startsWith("7")?`+${r}`:r.startsWith("7")?r:`+7${r}`):""},Vf=()=>{const e=rt(),r=Rr(),[s]=Tr(),a=s.get("token"),n=s.get("org_token"),i=s.get("client_token"),o=s.get("diary"),c=!!a,g=!!n;if(u.useEffect(()=>{if(!i)return;const z=new URLSearchParams;z.set("token",i),o&&z.set("diary",o),e(`/client-invite?${z.toString()}`,{replace:!0})},[i,o,e]),i)return null;const[_,y]=u.useState(null),[D,w]=u.useState(c?null:!1),[I,P]=u.useState(!1),[C,B]=u.useState(null),[O,$]=u.useState(null),[p,k]=u.useState(g?"checking":"form"),[f,x]=u.useState(null),{register:F,handleSubmit:H,formState:{errors:M}}=xt({resolver:yt(Of)}),{register:L,handleSubmit:U,formState:{errors:Z}}=xt({resolver:yt(Lf)});u.useEffect(()=>{if(i)return;if(!c&&!g){w(!1),B("Регистрация доступна только по пригласительной ссылке");return}(async()=>{try{w(!0)}catch{w(!1),B("Недействительный токен приглашения")}})()},[i,c,a]),u.useEffect(()=>{if(!g||i||!n)return;k("checking"),$(null),(async()=>{try{const{data:T,error:J}=await R.from("invite_tokens").select(`
            id,
            token,
            invite_type,
            expires_at,
            used_at,
            revoked_at,
            organization_invite_tokens (
              organization_id,
              organization_type,
              employee_role
            )
          `).eq("token",n).eq("invite_type","organization_employee").is("revoked_at",null).single();if(J||!T){k("invalid"),$("Пригласительная ссылка недействительна или была удалена.");return}if(T.used_at){k("invalid"),$("Эта пригласительная ссылка уже была использована.");return}if(T.expires_at&&new Date(T.expires_at)<new Date){k("invalid"),$("Срок действия пригласительной ссылки истек.");return}const W=Array.isArray(T.organization_invite_tokens)?T.organization_invite_tokens[0]:T.organization_invite_tokens;x({token:T.token,organization_id:W?.organization_id,organization_type:W?.organization_type,role:W?.employee_role}),k("form")}catch(T){console.error("Ошибка проверки пригласительной ссылки сотрудника",T),k("invalid"),$("Не удалось проверить пригласительную ссылку. Попробуйте позже.")}})()},[g,n,i]);const j=async z=>{if(!a){B("Регистрация доступна только по пригласительной ссылке");return}if(!_){B("Выберите тип организации");return}P(!0),B(null);try{const{data:T,error:J}=await R.auth.signUp({email:z.email,password:z.password,options:{data:{organization_type:_,invite_token:a||void 0}}});if(J)throw J;if(T.user){const{setUser:W,setSession:h}=Se.getState();if(T.session&&(W(T.user),h(T.session),await R.auth.setSession({access_token:T.session.access_token,refresh_token:T.session.refresh_token})),a){console.log("[RegisterPage] Помечаем токен как использованный:",{token:a,userId:T.user.id});try{const{data:A,error:Y}=await R.rpc("mark_invite_token_used",{p_token:a,p_user_id:T.user.id});Y?console.error("[RegisterPage] Ошибка пометки токена как использованного:",Y):A?console.log("[RegisterPage] ✅ Токен успешно помечен как использованный"):console.warn("[RegisterPage] ⚠️ Токен не найден или уже использован:",a)}catch(A){console.error("[RegisterPage] Ошибка при пометке токена:",A)}}else console.log("[RegisterPage] Регистрация без токена приглашения");try{const A="organization",{error:Y}=await R.rpc("create_user_profile",{p_role:A});Y?console.error("Ошибка создания user_profiles через RPC:",Y):console.log("✅ user_profiles создан с ролью:",A)}catch(A){console.error("Ошибка создания user_profiles:",A)}if(T.user.email_confirmed_at){try{const{data:A,error:Y}=await R.rpc("process_pending_diary_access",{p_user_id:T.user.id});!Y&&A?.success_count>0&&(console.log("[RegisterPage] Обработано pending токенов:",A.success_count),await r.invalidateQueries({queryKey:["dashboard-diaries"]}))}catch(A){console.error("[RegisterPage] Ошибка обработки pending токенов:",A)}e("/profile/setup")}else e(`/email-confirmation?email=${encodeURIComponent(T.user.email||"")}`)}}catch(T){B(T.message||"Ошибка при регистрации. Попробуйте ещё раз.")}finally{P(!1)}},v=async z=>{if(!(!g||!n||!f)){P(!0),$(null);try{const T=Bf(z.phone);if(!T){$("Введите корректный номер телефона"),P(!1);return}const J="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyAgCiAgICAicm9sZSI6ICJhbm9uIiwKICAgICJpc3MiOiAic3VwYWJhc2UtZGVtbyIsCiAgICAiaWF0IjogMTY0MTc2OTIwMCwKICAgICJleHAiOiAxNzk5NTM1NjAwCn0.dc_X5iR_VP_qT0zsiyj_I_OZ2T9FtRU2BBNWN8Bu4GE",W=hs("accept-invite");console.log("Calling Edge Function:",W);const h=await fetch(W,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${J}`,apikey:J},body:JSON.stringify({token:n,password:z.password,phone:T,firstName:"",lastName:""})});if(!h.ok){const ce=await h.text();console.error("Edge Function error:",h.status,ce);let me="Не удалось завершить регистрацию. Попробуйте ещё раз.";try{const _e=JSON.parse(ce);me=_e.message||_e.error||me}catch{me=ce||me}throw h.status===409&&(me="Пользователь с этим телефоном уже зарегистрирован. Используйте правильный пароль для входа или обратитесь к администратору."),new Error(me)}const A=await h.json();if(!A?.data)throw new Error("Не удалось получить данные после регистрации. Попробуйте войти вручную.");if(A.data.loginEmail&&!A.data.session)try{const{data:ce,error:me}=await R.auth.signInWithPassword({email:A.data.loginEmail,password:z.password});if(me||!ce.session)throw new Error("Не удалось войти. Проверьте пароль или обратитесь к администратору.");const{setUser:_e,setSession:De,setLoading:xe}=Se.getState();_e(ce.user),De(ce.session),xe(!1),Se.setState({isAuthenticated:!0}),e("/profile/setup");return}catch(ce){throw new Error(ce.message||"Не удалось войти. Попробуйте войти вручную.")}if(!A?.data?.session)throw new Error("Не удалось получить сессию после регистрации. Попробуйте войти вручную.");const{error:Y}=await R.auth.setSession({access_token:A.data.session.access_token,refresh_token:A.data.session.refresh_token});if(console.log("Session set, sessionError:",Y),Y)throw console.error("Ошибка установки сессии:",Y),new Error("Не удалось установить сессию. Попробуйте войти вручную.");const{data:{user:ee},error:ae}=await R.auth.getUser(),{data:{session:ne}}=await R.auth.getSession();if(ae||!ee)throw console.error("Ошибка получения пользователя:",ae),new Error("Не удалось получить данные пользователя. Попробуйте войти вручную.");const{data:{user:b}}=await R.auth.getUser(),Q=b||ee;console.log("RegisterPage: User metadata after registration:",{role:Q.user_metadata?.role,user_role:Q.user_metadata?.user_role,organization_id:Q.user_metadata?.organization_id});const{setUser:E,setSession:fe,setLoading:ye}=Se.getState();if(ne&&Q?(console.log("RegisterPage: Setting auth state directly:",{userId:Q.id,email:Q.email,role:Q.user_metadata?.role,user_role:Q.user_metadata?.user_role,organization_id:Q.user_metadata?.organization_id,hasSession:!!ne}),E(Q),fe(ne),ye(!1),Se.setState({isAuthenticated:!0,loading:!1}),console.log("RegisterPage: Auth state set, isAuthenticated:",Se.getState().isAuthenticated)):console.error("RegisterPage: Missing session or user:",{hasSession:!!ne,hasUser:!!Q}),console.log("✅ Регистрация сотрудника завершена успешно"),console.log("Final auth state:",{isAuthenticated:Se.getState().isAuthenticated,hasUser:!!Se.getState().user,hasSession:!!Se.getState().session,userRole:Se.getState().user?.user_metadata?.role,userRoleAlt:Se.getState().user?.user_metadata?.user_role,organizationId:Se.getState().user?.user_metadata?.organization_id}),await new Promise(ce=>setTimeout(ce,200)),Q?.id)try{const{data:ce,error:me}=await R.rpc("process_pending_diary_access",{p_user_id:Q.id});!me&&ce?.success_count>0&&(console.log("[RegisterPage] Обработано pending токенов:",ce.success_count),await r.invalidateQueries({queryKey:["dashboard-diaries"]}))}catch(ce){console.error("[RegisterPage] Ошибка обработки pending токенов:",ce)}e("/profile/setup")}catch(T){console.error("Ошибка регистрации по приглашению организации",T),$(T.message||"Не удалось завершить регистрацию. Попробуйте ещё раз.")}finally{P(!1)}}};return g?p==="checking"?t.jsxs("div",{className:"text-center py-8",children:[t.jsx("div",{className:"animate-spin w-12 h-12 border-4 border-blue-primary border-t-transparent rounded-full mx-auto mb-4"}),t.jsx("p",{className:"text-gray-600",children:"Проверяем пригласительную ссылку..."})]}):p==="invalid"?t.jsxs("div",{className:"text-center",children:[t.jsxs("div",{className:"mb-6",children:[t.jsx("div",{className:"w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4",children:t.jsx("svg",{className:"w-8 h-8 text-red-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),t.jsx("h1",{className:"text-2xl font-bold text-gray-dark mb-3",children:"Недействительная ссылка"}),t.jsx("p",{className:"text-gray-600 text-sm mb-6",children:O||"Эта пригласительная ссылка недействительна или уже была использована."})]}),t.jsx(oe,{onClick:()=>e("/login"),fullWidth:!0,size:"lg",children:"Войти в систему"})]}):t.jsxs("div",{children:[t.jsx("h1",{className:"text-[32px] font-bold text-gray-dark mb-2 text-center",children:"Регистрация сотрудника"}),t.jsx("p",{className:"text-gray-600 text-center text-sm mb-6",children:"Введите номер телефона и придумайте пароль, чтобы получить доступ к дневникам организации."}),f?.role&&t.jsxs("p",{className:"text-center text-sm text-gray-500 mb-6",children:["Ваша роль: ",Uf[f.role]||"Сотрудник"]}),t.jsxs("form",{onSubmit:U(v),className:"space-y-5",children:[t.jsx(he,{label:"Введите номер телефона",type:"tel",placeholder:"Номер телефона",error:Z.phone?.message,fullWidth:!0,...L("phone")}),t.jsx(he,{label:"Придумайте пароль",type:"password",placeholder:"Пароль",error:Z.password?.message,helperText:"Минимум 6 символов",fullWidth:!0,...L("password")}),t.jsx(he,{label:"Подтвердите пароль",type:"password",placeholder:"Повторите пароль",error:Z.confirmPassword?.message,fullWidth:!0,...L("confirmPassword")}),O&&t.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-xl",children:t.jsx("p",{className:"text-sm text-red-600",children:O})}),t.jsx(oe,{type:"submit",fullWidth:!0,isLoading:I,size:"lg",children:"Завершить регистрацию"})]})]}):D===!1?t.jsxs("div",{className:"text-center",children:[t.jsxs("div",{className:"mb-6",children:[t.jsx("div",{className:"w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4",children:t.jsx("svg",{className:"w-8 h-8 text-red-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),t.jsx("h1",{className:"text-2xl font-bold text-gray-dark mb-3",children:"Недействительная ссылка"}),t.jsx("p",{className:"text-gray-600 text-sm mb-4",children:C||"Эта ссылка для регистрации недействительна или уже использована."}),t.jsx("p",{className:"text-gray-600 text-sm mb-4",children:"Для регистрации необходимо записаться на закрытое тестирование."}),t.jsx("p",{className:"text-gray-600 text-sm mb-6",children:"Свяжитесь с нами в WhatsApp, и мы отправим вам пригласительную ссылку для доступа к платформе."})]}),t.jsxs("div",{className:"flex flex-col items-center gap-3",children:[t.jsx("a",{href:`https://wa.me/79145391376?text=${encodeURIComponent("Здравствуйте! Хочу записаться на закрытое тестирование Дневника подопечного. Нужна пригласительная ссылка для регистрации.")}`,target:"_blank",rel:"noreferrer",className:"w-full",children:t.jsxs(oe,{fullWidth:!0,size:"lg",className:"bg-gradient-to-r from-[#25D366] to-[#128C7E] hover:from-[#20BA5A] hover:to-[#0F7A6D] text-white border-0 shadow-lg hover:shadow-xl",children:[t.jsx("svg",{className:"w-5 h-5 mr-2",fill:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{d:"M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"})}),"Связаться с нами в WhatsApp"]})}),t.jsx(oe,{onClick:()=>e("/login"),size:"lg",fullWidth:!0,variant:"outline",children:"Войти в систему"}),t.jsx(oe,{onClick:()=>e("/"),size:"lg",fullWidth:!0,variant:"outline",children:"На главную"})]})]}):D===null?t.jsxs("div",{className:"text-center py-8",children:[t.jsx("div",{className:"animate-spin w-12 h-12 border-4 border-blue-primary border-t-transparent rounded-full mx-auto mb-4"}),t.jsx("p",{className:"text-gray-600",children:"Проверка приглашения..."})]}):!c&&!g?t.jsxs("div",{className:"text-center",children:[t.jsxs("div",{className:"mb-6",children:[t.jsx("h1",{className:"text-2xl font-bold text-gray-dark mb-3",children:"Регистрация по приглашению"}),t.jsx("p",{className:"text-gray-600 text-sm mb-4",children:"Для регистрации необходимо записаться на закрытое тестирование."}),t.jsx("p",{className:"text-gray-600 text-sm mb-4",children:"Свяжитесь с нами в WhatsApp, и мы отправим вам пригласительную ссылку для доступа к платформе."}),t.jsxs("p",{className:"text-gray-500 text-sm mb-6",children:["Если у вас уже есть аккаунт, вы можете"," ",t.jsx("button",{onClick:()=>e("/login"),className:"text-blue-primary font-semibold underline decoration-1 hover:text-blue-600",children:"войти в систему"}),"."]})]}),t.jsxs("div",{className:"flex flex-col items-center gap-3",children:[t.jsx("a",{href:`https://wa.me/79145391376?text=${encodeURIComponent("Здравствуйте! Хочу записаться на закрытое тестирование Дневника подопечного. Нужна пригласительная ссылка для регистрации.")}`,target:"_blank",rel:"noreferrer",className:"w-full",children:t.jsxs(oe,{fullWidth:!0,size:"lg",className:"bg-gradient-to-r from-[#25D366] to-[#128C7E] hover:from-[#20BA5A] hover:to-[#0F7A6D] text-white border-0 shadow-lg hover:shadow-xl",children:[t.jsx("svg",{className:"w-5 h-5 mr-2",fill:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{d:"M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"})}),"Связаться с нами в WhatsApp"]})}),t.jsx(oe,{onClick:()=>e("/login"),size:"lg",fullWidth:!0,variant:"outline",children:"Войти в систему"}),t.jsx(oe,{onClick:()=>e("/"),size:"lg",fullWidth:!0,variant:"outline",children:"На главную"})]})]}):_?t.jsxs("div",{children:[t.jsxs("button",{onClick:()=>y(null),className:"flex items-center gap-2 text-blue-primary hover:text-blue-600 mb-6 text-sm font-medium transition-colors",children:[t.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})}),"Назад к выбору типа"]}),t.jsx("h1",{className:"text-3xl font-bold text-gray-dark mb-2 text-center",children:"Регистрация"}),t.jsx("p",{className:"text-gray-600 mb-6 text-center text-sm",children:_==="pension"?"Пансионат":_==="patronage_agency"?"Патронажное агентство":"Частная сиделка"}),t.jsxs("form",{onSubmit:H(j),className:"space-y-5",children:[t.jsx(he,{label:"Введите почту",type:"email",placeholder:"Почта",error:M.email?.message,fullWidth:!0,...F("email")}),t.jsx(he,{label:"Придумайте пароль",type:"password",placeholder:"Пароль",error:M.password?.message,helperText:"Минимум 6 символов",fullWidth:!0,...F("password")}),t.jsx(he,{label:"Подтвердите пароль",type:"password",placeholder:"Повторите пароль",error:M.confirmPassword?.message,fullWidth:!0,...F("confirmPassword")}),C&&t.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-xl",children:t.jsx("p",{className:"text-sm text-red-600",children:C})}),t.jsx(oe,{type:"submit",fullWidth:!0,isLoading:I,size:"lg",children:"Зарегистрироваться"}),t.jsxs("p",{className:"text-center text-sm text-gray-600 mt-4",children:["Если уже есть аккаунт, нажмите"," ",t.jsx("button",{type:"button",onClick:()=>e("/login"),className:"text-gray-dark font-semibold underline",children:"Войти"})]})]})]}):t.jsxs("div",{children:[t.jsx("h1",{className:"text-3xl font-bold text-gray-dark mb-2 text-center",children:"Регистрация"}),t.jsx("p",{className:"text-gray-600 mb-8 text-center text-sm",children:"Выберите тип вашей организации"}),t.jsxs("div",{className:"space-y-4",children:[t.jsxs("button",{onClick:()=>y("pension"),className:"w-full p-6 bg-gradient-to-br from-[#55ACBF] to-[#4A9BAD] rounded-2xl shadow-md hover:shadow-xl transition-all text-white text-left transform hover:scale-[1.02] active:scale-[0.98]",children:[t.jsx("h3",{className:"font-bold text-xl mb-2",children:"Пансионат"}),t.jsx("p",{className:"text-sm text-white/90",children:"Учреждение для ухода за подопечными"})]}),t.jsxs("button",{onClick:()=>y("patronage_agency"),className:"w-full p-6 bg-gradient-to-br from-[#4A9BAD] to-[#3D8291] rounded-2xl shadow-md hover:shadow-xl transition-all text-white text-left transform hover:scale-[1.02] active:scale-[0.98]",children:[t.jsx("h3",{className:"font-bold text-xl mb-2",children:"Патронажное агентство"}),t.jsx("p",{className:"text-sm text-white/90",children:"Агентство по предоставлению услуг ухода"})]}),t.jsxs("button",{onClick:()=>y("caregiver"),className:"w-full p-6 bg-gradient-to-br from-[#3D8291] to-[#2F6A78] rounded-2xl shadow-md hover:shadow-xl transition-all text-white text-left transform hover:scale-[1.02] active:scale-[0.98]",children:[t.jsx("h3",{className:"font-bold text-xl mb-2",children:"Частная сиделка"}),t.jsx("p",{className:"text-sm text-white/90",children:"Индивидуальный специалист по уходу"})]})]})]})},zt=e=>{if(!e)return"Произошла неизвестная ошибка";const r=e.message||e.toString();return r.includes("Failed to fetch")||r.includes("fetch")?"Ошибка подключения к серверу. Проверьте интернет-соединение и попробуйте ещё раз.":r.includes("Invalid login credentials")?"Неверный email/телефон или пароль":r.includes("Email not confirmed")?"Email не подтвержден. Проверьте почту и подтвердите регистрацию.":r.includes("Phone signups are disabled")?'Регистрация по телефону отключена в настройках Supabase. Включите "Phone Auth" в Authentication → Settings.':r.includes("User already registered")?"Пользователь с таким email уже зарегистрирован":r.includes("Password should be at least")?"Пароль должен содержать минимум 6 символов":r.includes("Invalid email")?"Некорректный email адрес":r.includes("JWT")?"Ошибка авторизации. Попробуйте войти заново.":r.includes("Network")?"Ошибка сети. Проверьте подключение к интернету.":r.includes("Missing Supabase")?"Ошибка конфигурации. Обратитесь к администратору.":"Произошла ошибка. Попробуйте ещё раз или обратитесь в поддержку."},Zf=bt({login:ke().min(1,"Введите email или номер телефона"),password:ke().min(1,"Введите пароль")}),Wf=()=>{const e=rt(),r=Rr(),[s,a]=u.useState(!1),[n,i]=u.useState(null),{register:o,handleSubmit:c,formState:{errors:g}}=xt({resolver:yt(Zf)}),_=async y=>{if(a(!0),i(null),y.login.includes("@"))try{localStorage.removeItem("current_user"),localStorage.removeItem("auth_token");try{await R.auth.signOut()}catch{}const w=await R.auth.signInWithPassword({email:y.login,password:y.password});if(w.error)throw w.error;if(w.data.user){const{setUser:I,setSession:P}=Se.getState();I(w.data.user),P(w.data.session),console.log("Logged in as organization:",w.data.user.email);try{const{data:C,error:B}=await R.rpc("process_pending_diary_access",{p_user_id:w.data.user.id});!B&&C?.success_count>0&&(console.log("[LoginPage] Обработано pending токенов:",C.success_count),await r.invalidateQueries({queryKey:["dashboard-diaries"]}))}catch(C){console.error("[LoginPage] Ошибка обработки pending токенов:",C)}e("/dashboard")}}catch(w){i(zt(w))}finally{a(!1)}else try{let w=y.login.trim().replace(/\s/g,"");w.startsWith("+")||(w.startsWith("7")?w="+"+w:w.startsWith("8")?w="+7"+w.substring(1):w="+7"+w.replace(/\D/g,""));const I=w.replace(/[^0-9]/g,"");console.log("LoginPage: Phone normalization:",{original:y.login,formatted:w,sanitized:I});try{console.log("LoginPage: Searching user by phone:",I);const{data:B,error:O}=await R.rpc("find_user_email_by_phone",{p_phone:I});if(O?console.error("LoginPage: RPC find_user_email_by_phone error:",O):console.log("LoginPage: RPC find_user_email_by_phone result:",B),!O&&B&&B.length>0){const $=B[0];console.log("LoginPage: ✅ Found user by phone:",{user_id:$.user_id,email:$.email,user_role:$.user_role,organization_type:$.organization_type});const p=await R.auth.signInWithPassword({email:$.email,password:y.password});if(!p.error&&p.data.user){console.log("LoginPage: ✅ Successfully logged in as:",p.data.user.email);const{setUser:k,setSession:f}=Se.getState();k(p.data.user),f(p.data.session);try{const{data:x,error:F}=await R.rpc("process_pending_diary_access",{p_user_id:p.data.user.id});!F&&x?.success_count>0&&(console.log("[LoginPage] Обработано pending токенов:",x.success_count),await r.invalidateQueries({queryKey:["dashboard-diaries"]}))}catch(x){console.error("[LoginPage] Ошибка обработки pending токенов:",x)}e("/dashboard");return}else throw console.error("LoginPage: ❌ User found but password incorrect:",p.error),p.error||new Error("Неверный пароль")}else console.log("LoginPage: No user found by phone, trying fallback method")}catch(B){console.error("LoginPage: RPC find_user_email_by_phone exception:",B)}const P=[`admin-${I}@diary.local`,`organization_employee-${I}@diary.local`,`organization_client-${I}@diary.local`,`caregiver_client-${I}@diary.local`];console.log("LoginPage: Trying email variants (fallback):",P);let C=null;for(const B of P)try{console.log("LoginPage: Attempting login with:",B);const O=await R.auth.signInWithPassword({email:B,password:y.password});if(O.error)console.log("LoginPage: ❌ Login failed with",B,":",O.error.message),C=O.error;else if(O.data.user){console.log("LoginPage: ✅ Successfully logged in as:",O.data.user.email);const{setUser:$,setSession:p}=Se.getState();$(O.data.user),p(O.data.session);try{const{data:k,error:f}=await R.rpc("process_pending_diary_access",{p_user_id:O.data.user.id});!f&&k?.success_count>0&&(console.log("[LoginPage] Обработано pending токенов:",k.success_count),await r.invalidateQueries({queryKey:["dashboard-diaries"]}))}catch(k){console.error("[LoginPage] Ошибка обработки pending токенов:",k)}e("/dashboard");return}}catch(O){console.log("LoginPage: ❌ Exception with",B,":",O.message),C=O}if(C)throw console.error("LoginPage: All login attempts failed, last error:",C),C}catch(w){i(zt(w))}finally{a(!1)}};return t.jsxs("div",{children:[t.jsx("h1",{className:"text-[32px] font-bold text-gray-dark mb-10 text-center",children:"Войти"}),t.jsxs("form",{onSubmit:c(_),className:"space-y-6 mt-4",children:[t.jsx(he,{label:"Введите email или номер телефона",type:"text",placeholder:"Email или номер телефона",error:g.login?.message,fullWidth:!0,...o("login")}),t.jsx(he,{label:"Введите пароль",type:"password",placeholder:"Пароль",error:g.password?.message,fullWidth:!0,...o("password")}),n&&t.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-xl",children:t.jsx("p",{className:"text-sm font-manrope text-red-600",children:n})}),t.jsx(oe,{type:"submit",fullWidth:!0,isLoading:s,size:"lg",className:"mt-6",children:"Войти"}),t.jsxs("p",{className:"text-center text-sm font-manrope text-gray-600 mt-6 leading-relaxed",children:["Если еще нет аккаунта, нажмите"," ",t.jsx("button",{type:"button",onClick:()=>e("/register"),className:"text-gray-dark font-semibold underline decoration-1",children:"Регистрация"})]})]})]})},qf=bt({code:ke().min(6,"Код должен содержать 8 символов").max(8,"Код должен содержать 8 символов")}),Jf=()=>{const e=rt(),r=Rr(),[s]=Tr(),{user:a}=Se(),n=s.get("email")||a?.email||"",[i,o]=u.useState(!1),[c,g]=u.useState(!1),[_,y]=u.useState(null),[D,w]=u.useState(null),{register:I,handleSubmit:P,formState:{errors:C}}=xt({resolver:yt(qf)});u.useEffect(()=>{(async()=>{a&&a.email_confirmed_at&&e("/profile/setup")})()},[a,e]);const B=async $=>{o(!0),y(null),w(null);try{const{data:p,error:k}=await R.auth.verifyOtp({email:n,token:$.code,type:"email"});if(k)throw k;if(p.user){w("Email успешно подтвержден!"),localStorage.removeItem("current_user"),localStorage.removeItem("auth_token");const{setSession:f,checkAuth:x}=Se.getState(),{data:{session:F}}=await R.auth.getSession();if(F){if(f(F),await x(),F.user?.id)try{const{data:H,error:M}=await R.rpc("process_pending_diary_access",{p_user_id:F.user.id});!M&&H?.success_count>0&&(console.log("[EmailConfirmationPage] Обработано pending токенов:",H.success_count),await r.invalidateQueries({queryKey:["dashboard-diaries"]}))}catch(H){console.error("[EmailConfirmationPage] Ошибка обработки pending токенов:",H)}setTimeout(()=>{e("/profile/setup",{replace:!0})},1500)}else throw new Error("Не удалось создать сессию после подтверждения email")}}catch(p){y(zt(p))}finally{o(!1)}},O=async()=>{if(!n){y("Email не указан");return}g(!0),y(null);try{const{error:$}=await R.auth.resend({type:"signup",email:n});if($)throw $;w("Код подтверждения отправлен на вашу почту!"),setTimeout(()=>w(null),5e3)}catch($){y(zt($))}finally{g(!1)}};return t.jsxs("div",{className:"max-w-md mx-auto px-4 py-8",children:[t.jsx("h1",{className:"text-[32px] font-bold text-gray-dark mb-2 text-center",children:"Подтверждение email"}),t.jsx("p",{className:"text-gray-600 mb-8 text-center text-sm font-manrope",children:"Мы отправили код подтверждения на вашу почту"}),n&&t.jsx("p",{className:"text-center text-sm font-manrope text-gray-600 mb-6",children:n}),D&&t.jsx("div",{className:"mb-6 p-3 bg-green-50 border border-green-200 rounded-xl",children:t.jsx("p",{className:"text-sm font-manrope text-green-600",children:D})}),t.jsxs("form",{onSubmit:P(B),className:"space-y-6",children:[t.jsx(he,{label:"Введите код подтверждения",placeholder:"00000000",maxLength:8,error:C.code?.message,fullWidth:!0,className:"text-center text-2xl tracking-widest font-mono",...I("code")}),_&&t.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-xl",children:t.jsx("p",{className:"text-sm font-manrope text-red-600",children:_})}),t.jsx(oe,{type:"submit",fullWidth:!0,isLoading:i,size:"lg",children:"Подтвердить"}),t.jsx("div",{className:"text-center",children:t.jsx("button",{type:"button",onClick:O,disabled:c,className:"text-sm font-manrope text-blue-primary hover:text-blue-600 underline disabled:opacity-50 disabled:cursor-not-allowed",children:c?"Отправка...":"Отправить код повторно"})})]})]})},Sn=["organization_invite_tokens","employee_invite_tokens","local_employee_invite_tokens"],ln=Sn[0],Dn=()=>typeof window<"u"&&typeof window.localStorage<"u",Qf=()=>typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`invite_${Date.now()}_${Math.random().toString(16).slice(2)}`,Kf=e=>{if(!e)return new Date().toISOString();const r=new Date(e);return Number.isNaN(r.getTime())?new Date().toISOString():r.toISOString()},Gf=e=>{if(!e)return null;try{return JSON.parse(e)}catch(r){return console.warn("inviteStorage: не удалось распарсить JSON",r),null}},Hf=e=>{if(!e||typeof e!="object"&&typeof e!="function")return null;const r=new Date().toISOString(),s=e.token?String(e.token):e.id?String(e.id):"";if(!s)return null;const a=e.id?String(e.id):s||Qf(),n=Kf(e.created_at??e.createdAt??r),i={id:a,token:s,organization_id:e.organization_id??e.organizationId??e.owner_id??e.ownerId??e.caregiver_id??null,role:e.role??e.employee_role??e.employeeRole??null,created_at:n,used_at:e.used_at??e.usedAt??null,used_by:e.used_by??e.usedBy??null,link:e.link??e.direct_link??e.url??void 0};return Object.keys(e).forEach(o=>{o in i||(i[o]=e[o])}),i},Yf=()=>{if(!Dn())return{key:ln,tokens:[]};for(const e of Sn){const r=Gf(window.localStorage.getItem(e));if(Array.isArray(r)){const s=r.map(Hf).filter(a=>!!a);return{key:e,tokens:s}}}return{key:ln,tokens:[]}},uo=(e,r=ln)=>{if(Dn())try{const s=JSON.stringify(e);window.localStorage.setItem(r,s),Sn.forEach(a=>{a!==r&&window.localStorage.getItem(a)!==null&&window.localStorage.removeItem(a)})}catch(s){console.warn("inviteStorage: не удалось сохранить токены",s)}},mo=()=>{if(!Dn())return[];const{key:e,tokens:r}=Yf();return r.length?(uo(r,e),r):(uo([],e),[])},Xf=bt({firstName:ke().min(1,"Введите имя"),lastName:ke().min(1,"Введите фамилию"),phone:ke().min(1,"Введите номер телефона"),city:ke().min(1,"Введите город")}),eg=bt({name:ke().min(1,"Введите название организации"),phone:ke().min(1,"Введите номер телефона"),address:ke().min(1,"Введите адрес организации")}),tg=bt({firstName:ke().min(1,"Введите имя"),lastName:ke().min(1,"Введите фамилию")}),rg=bt({firstName:ke().min(1,"Введите имя"),lastName:ke().min(1,"Введите фамилию")}),sg=()=>{const e=rt(),r=Rr(),{user:s}=Se(),[a,n]=u.useState(null),[i,o]=u.useState(!1),[c,g]=u.useState(!1),[_,y]=u.useState(null),[D,w]=u.useState(null),[I,P]=u.useState(!1),[C,B]=u.useState(null),[O,$]=u.useState(!0),p=u.useRef(!1);u.useEffect(()=>{(async()=>{let v=null,z;console.log("ProfileSetupPage: Starting user type check...");try{const W=localStorage.getItem("current_user");if(console.log("ProfileSetupPage: localStorage current_user:",W),W&&W!=="{}"){if(v=JSON.parse(W),z=v.user_role||v.user_metadata?.user_role,console.log("ProfileSetupPage: Parsed localStorage user:",{id:v.id,role:z,caregiver_id:v.caregiver_id,organization_id:v.organization_id,phone:v.phone}),z==="client"&&v.id){console.log("✅ ProfileSetupPage: Detected CLIENT from localStorage");try{const{data:h,error:A}=await R.from("clients").select("first_name, last_name").eq("user_id",v.id).single();if(!A&&h&&h.first_name&&h.last_name){console.log("ProfileSetupPage: Client profile already filled, redirecting to dashboard"),e("/dashboard");return}}catch(h){console.error("ProfileSetupPage: Error checking client profile:",h)}g(!0),w({caregiver_id:v.caregiver_id,organization_id:v.organization_id,patient_card_id:v.patient_card_id,diary_id:v.diary_id}),$(!1),p.current=!0;return}if(z==="org_employee"&&v.id&&v.organization_id){console.log("✅ ProfileSetupPage: Detected EMPLOYEE from localStorage"),o(!0),y(v.organization_id),$(!1),p.current=!0;return}}}catch(W){console.error("ProfileSetupPage: Error parsing localStorage:",W)}if(p.current){console.log("ProfileSetupPage: Already checked, skipping...");return}if(i||c||a){console.log("ProfileSetupPage: Type already determined:",{isEmployee:i,isClient:c,organizationType:a}),$(!1),p.current=!0;return}if(p.current=!0,!s){console.log("ProfileSetupPage: No user in authStore, but localStorage user was found - using it"),(!v?.id||!z||z!=="client"&&z!=="org_employee")&&(console.log("ProfileSetupPage: No valid user found, redirecting to login"),e("/login"));return}console.log("ProfileSetupPage: Checking user from authStore:",{id:s.id,email:s.email,phone:s.phone,user_role:s.user_role,user_metadata_role:s.user_metadata?.role,user_metadata_user_role:s.user_metadata?.user_role,organization_type:s.user_metadata?.organization_type});let T=s.user_role||s.user_metadata?.user_role||s.user_metadata?.role;if(!T)try{console.log("ProfileSetupPage: Role not found in metadata, loading from user_profiles...");const{data:W,error:h}=await R.from("user_profiles").select("role, organization_id").eq("user_id",s.id).single();!h&&W?(T=W.role,console.log("ProfileSetupPage: Loaded role from user_profiles:",T,"organization_id:",W.organization_id),T==="org_employee"&&W.organization_id&&(console.log("ProfileSetupPage: Setting organization_id from user_profiles:",W.organization_id),y(W.organization_id))):h&&console.error("ProfileSetupPage: Error loading user_profiles:",h)}catch(W){console.error("ProfileSetupPage: Error loading from user_profiles:",W)}if(console.log("ProfileSetupPage: Final userRole:",T),T==="client"){console.log("✅ ProfileSetupPage: Detected CLIENT from authStore");try{const{data:W,error:h}=await R.from("clients").select("first_name, last_name").eq("user_id",s.id).single();if(!h&&W&&W.first_name&&W.last_name){console.log("ProfileSetupPage: Client profile already filled, redirecting to dashboard"),e("/dashboard");return}}catch(W){console.error("ProfileSetupPage: Error checking client profile:",W)}g(!0),w({caregiver_id:s.caregiver_id||s.user_metadata?.caregiver_id||v?.caregiver_id,organization_id:s.organization_id||s.user_metadata?.organization_id||v?.organization_id,patient_card_id:s.patient_card_id||s.user_metadata?.patient_card_id||v?.patient_card_id,diary_id:s.diary_id||s.user_metadata?.diary_id||v?.diary_id}),$(!1);return}const J=s.user_metadata?.organization_type;if(console.log("ProfileSetupPage: Checking organization_type:",J),J&&["pension","patronage_agency","caregiver"].includes(J)){if(console.log("✅ ProfileSetupPage: Detected ORGANIZATION/CAREGIVER:",J),!s.email_confirmed_at){console.log("Email not confirmed, redirecting to email confirmation"),p.current=!1,e(`/email-confirmation?email=${encodeURIComponent(s.email||"")}`);return}n(J),$(!1);return}if(T==="org_employee"){let W=s.organization_id||s.user_metadata?.organization_id||v?.organization_id;if(!W||W==="temp")try{console.log("ProfileSetupPage: organization_id not found, loading from DB...");const{data:h}=await R.from("user_profiles").select("organization_id").eq("user_id",s.id).single();if(h?.organization_id)W=h.organization_id,console.log("ProfileSetupPage: Loaded organization_id from user_profiles:",W);else{const{data:A}=await R.from("organization_employees").select("organization_id").eq("user_id",s.id).single();A?.organization_id&&(W=A.organization_id,console.log("ProfileSetupPage: Loaded organization_id from organization_employees:",W))}}catch(h){console.error("ProfileSetupPage: Error loading organization_id:",h)}if(console.log("ProfileSetupPage: Checking employee, orgId:",W),W&&W!=="temp"){console.log("✅ ProfileSetupPage: Detected EMPLOYEE with orgId:",W),o(!0),y(W),$(!1),p.current=!0;return}else console.warn("ProfileSetupPage: Employee detected but no organization_id found")}console.error("❌ ProfileSetupPage: Could not determine user type:",{userRole:T,localStorageUserRole:z,userType:J,email:s.email,phone:s.phone,hasLocalStorageData:!!v?.id}),B("Не удалось определить тип пользователя. Проверьте данные регистрации."),$(!1),setTimeout(()=>{p.current=!1,e("/register")},3e3)})()},[]);const k=xt({resolver:yt(Xf)}),f=xt({resolver:yt(eg)}),x=xt({resolver:yt(tg)}),F=xt({resolver:yt(rg)}),H=async j=>{if(!(!s||!a)){P(!0),B(null);try{try{const{error:v}=await R.rpc("create_user_profile",{p_role:"organization"});v&&v.code!=="23505"&&console.warn("Не удалось создать/обновить user_profiles через RPC:",v);const{data:z,error:T}=await R.rpc("create_organization",{p_organization_type:a,p_name:`${j.firstName} ${j.lastName}`,p_phone:j.phone,p_address:null});if(T)throw T;if(z?.id){const{error:J}=await R.from("organizations").update({first_name:j.firstName,last_name:j.lastName,city:j.city}).eq("id",z.id);J&&console.warn("Не удалось обновить дополнительные поля организации:",J)}await R.auth.updateUser({data:{organization_type:a,firstName:j.firstName,lastName:j.lastName,phone:j.phone,city:j.city}})}catch(v){console.error("Ошибка создания организации:",v);const{error:z}=await R.auth.updateUser({data:{profile_data:{firstName:j.firstName,lastName:j.lastName,phone:j.phone,city:j.city},organization_type:a}});if(z)throw z}if(s?.id)try{console.log("[ProfileSetupPage] Обработка pending токенов доступа к дневникам после создания организации"),await new Promise(T=>setTimeout(T,500));const{data:v,error:z}=await R.rpc("process_pending_diary_access",{p_user_id:s.id});if(!z&&v)if(console.log("[ProfileSetupPage] Результат обработки pending токенов:",v),v.success_count>0){console.log("[ProfileSetupPage] Успешно обработано токенов:",v.success_count),await r.invalidateQueries({queryKey:["dashboard-diaries"]}),e("/dashboard",{replace:!0});return}else v.error_count>0&&console.log("[ProfileSetupPage] Некоторые токены не удалось обработать:",v.errors);else z&&console.error("[ProfileSetupPage] Ошибка обработки pending токенов:",z)}catch(v){console.error("[ProfileSetupPage] Ошибка обработки pending токенов:",v)}e("/dashboard")}catch(v){B(zt(v))}finally{P(!1)}}},M=async j=>{if(!(!s||!D)){P(!0),B(null);try{const v=s.phone||s.user_metadata?.phone_for_login||s.user_metadata?.phone||null,{data:z,error:T}=await R.from("clients").select("id").eq("user_id",s.id).single();if(T&&T.code!=="PGRST116")throw console.error("Ошибка проверки клиента:",T),T;if(z){const{error:J}=await R.from("clients").update({first_name:j.firstName,last_name:j.lastName,phone:v,invited_by_caregiver_id:D.caregiver_id||null,invited_by_organization_id:D.organization_id||null}).eq("user_id",s.id);if(J)throw console.error("Ошибка обновления клиента:",J),J}else{const{error:J}=await R.from("clients").insert({user_id:s.id,first_name:j.firstName,last_name:j.lastName,phone:v,invited_by_caregiver_id:D.caregiver_id||null,invited_by_organization_id:D.organization_id||null});if(J)throw console.error("Ошибка создания клиента:",J),J}await R.auth.updateUser({data:{firstName:j.firstName,lastName:j.lastName,phone:v}}),console.log("✅ Профиль клиента сохранен в Supabase"),e("/profile")}catch(v){console.error("Ошибка сохранения профиля клиента:",v),B(zt(v)||"Не удалось сохранить профиль. Попробуйте ещё раз.")}finally{P(!1)}}},L=async j=>{if(s){P(!0),B(null);try{let v=s.organization_id||s.user_metadata?.organization_id||_;const z=s.organization_invite_token||s.user_metadata?.organization_invite_token;if((!v||v==="temp")&&z){const b=mo().find(Q=>Q.token===z);b&&b.organization_id&&(v=b.organization_id,console.log("Found organization_id from token:",v))}(!v||v==="temp")&&(console.warn("Warning: organization_id is still temp, employee may not be linked to organization"),v="temp"),console.log("Saving employee with organization_id:",v,"user_id:",s.id);let T=s.employee_role||s.user_metadata?.employee_role||null;if(!T)try{const{data:ne}=await R.from("organization_employees").select("role").eq("user_id",s.id).single();ne?.role&&(T=ne.role,console.log("ProfileSetupPage: Loaded role from organization_employees:",T))}catch(ne){console.error("ProfileSetupPage: Error loading role from organization_employees:",ne)}let J=s.organization_type||s.user_metadata?.organization_type||a||null;if(!J&&z){const b=mo().find(Q=>Q.token===z);b?.organization_type&&(J=b.organization_type)}const W=s.phone||s.user_metadata?.phone_for_login||s.user_metadata?.phone||null;try{console.log("ProfileSetupPage: Saving employee to Supabase:",{user_id:s.id,organization_id:v,first_name:j.firstName,last_name:j.lastName,phone:W,role:T});const{data:ne,error:b}=await R.from("organization_employees").select("id").eq("user_id",s.id).single();if(b&&b.code!=="PGRST116"&&console.error("ProfileSetupPage: Error checking existing employee:",b),ne){const{error:Q}=await R.from("organization_employees").update({first_name:j.firstName,last_name:j.lastName,phone:W||null}).eq("user_id",s.id);if(Q)throw console.error("ProfileSetupPage: Error updating employee in Supabase:",Q),Q;console.log("✅ ProfileSetupPage: Employee updated in Supabase")}else{const{error:Q}=await R.from("organization_employees").insert({user_id:s.id,organization_id:v,first_name:j.firstName,last_name:j.lastName,phone:W||null,role:T||"caregiver"});if(Q)throw console.error("ProfileSetupPage: Error inserting employee in Supabase:",Q),Q;console.log("✅ ProfileSetupPage: Employee created in Supabase")}}catch(ne){console.error("ProfileSetupPage: Database error:",ne),B("Не удалось сохранить в базу данных. Данные сохранены локально.")}const h=JSON.parse(localStorage.getItem("local_employees")||"[]"),A=h.findIndex(ne=>ne.user_id===s.id),Y={user_id:s.id,organization_id:v,organization_type:J,first_name:j.firstName,last_name:j.lastName,phone:W,role:T,organization_invite_token:z,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};A!==-1?h[A]={...h[A],...Y}:h.push(Y),localStorage.setItem("local_employees",JSON.stringify(h));const ee=JSON.parse(localStorage.getItem("current_user")||"{}");ee.organization_id=v,ee.organization_type=J,ee.profile_data={firstName:j.firstName,lastName:j.lastName,phone:W,organization_id:v,organization_type:J},localStorage.setItem("current_user",JSON.stringify(ee));const{setUser:ae}=Se.getState();ae({...s,...ee}),e("/dashboard")}catch{B("Не удалось сохранить профиль. Попробуйте ещё раз.")}finally{P(!1)}}},U=async j=>{if(!(!s||!a)){P(!0),B(null);try{try{const{error:v}=await R.rpc("create_organization",{p_organization_type:a,p_name:j.name,p_phone:j.phone,p_address:j.address});if(v)throw v;await R.auth.updateUser({data:{organization_type:a,name:j.name,phone:j.phone,address:j.address}})}catch(v){console.error("Ошибка создания организации:",v);const{error:z}=await R.auth.updateUser({data:{profile_data:{name:j.name,phone:j.phone,address:j.address},organization_type:a}});if(z)throw z}e("/dashboard")}catch(v){B(zt(v))}finally{P(!1)}}};if(O)return t.jsx("div",{className:"min-h-screen flex items-center justify-center",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"animate-spin w-12 h-12 border-4 border-blue-primary border-t-transparent rounded-full mx-auto mb-4"}),t.jsx("p",{className:"text-gray-600",children:"Загрузка..."})]})});if(!i&&!c&&!a)return t.jsx("div",{className:"min-h-screen flex items-center justify-center px-4",children:t.jsxs("div",{className:"text-center max-w-md",children:[t.jsx("div",{className:"w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4",children:t.jsx("svg",{className:"w-8 h-8 text-red-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),t.jsx("h1",{className:"text-2xl font-bold text-gray-dark mb-3",children:"Ошибка"}),t.jsx("p",{className:"text-gray-600 text-sm font-manrope mb-6",children:C||"Не удалось определить тип пользователя. Пожалуйста, зарегистрируйтесь заново."}),t.jsx(oe,{onClick:()=>e("/register"),fullWidth:!0,size:"lg",children:"Вернуться к регистрации"})]})});if(c)return t.jsxs("div",{className:"max-w-md mx-auto px-4 py-8",children:[t.jsx("h1",{className:"text-[32px] font-bold text-gray-dark mb-2 text-center",children:"Заполнить профиль"}),t.jsx("p",{className:"text-gray-600 mb-8 text-center text-sm font-manrope",children:"Клиент"}),t.jsxs("form",{onSubmit:F.handleSubmit(M),className:"space-y-6",children:[t.jsx(he,{label:"Имя",placeholder:"Введите имя",error:F.formState.errors.firstName?.message,fullWidth:!0,...F.register("firstName")}),t.jsx(he,{label:"Фамилия",placeholder:"Введите фамилию",error:F.formState.errors.lastName?.message,fullWidth:!0,...F.register("lastName")}),C&&t.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-xl",children:t.jsx("p",{className:"text-sm font-manrope text-red-600",children:C})}),t.jsx(oe,{type:"submit",fullWidth:!0,isLoading:I,size:"lg",children:"Сохранить профиль"})]})]});if(i)return t.jsxs("div",{className:"max-w-md mx-auto px-4 py-8",children:[t.jsx("h1",{className:"text-[32px] font-bold text-gray-dark mb-2 text-center",children:"Заполнить профиль"}),t.jsx("p",{className:"text-gray-600 mb-8 text-center text-sm font-manrope",children:"Сотрудник организации"}),t.jsxs("form",{onSubmit:x.handleSubmit(L),className:"space-y-6",children:[t.jsx(he,{label:"Имя",placeholder:"Введите имя",error:x.formState.errors.firstName?.message,fullWidth:!0,...x.register("firstName")}),t.jsx(he,{label:"Фамилия",placeholder:"Введите фамилию",error:x.formState.errors.lastName?.message,fullWidth:!0,...x.register("lastName")}),C&&t.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-xl",children:t.jsx("p",{className:"text-sm font-manrope text-red-600",children:C})}),t.jsx(oe,{type:"submit",fullWidth:!0,isLoading:I,size:"lg",children:"Сохранить профиль"})]})]});if(a==="caregiver")return t.jsxs("div",{className:"max-w-md mx-auto px-4 py-8",children:[t.jsx("h1",{className:"text-[32px] font-bold text-gray-dark mb-2 text-center",children:"Заполнить профиль"}),t.jsx("p",{className:"text-gray-600 mb-8 text-center text-sm font-manrope",children:"Частная сиделка"}),t.jsxs("form",{onSubmit:k.handleSubmit(H),className:"space-y-6",children:[t.jsx(he,{label:"Имя",placeholder:"Введите имя",error:k.formState.errors.firstName?.message,fullWidth:!0,...k.register("firstName")}),t.jsx(he,{label:"Фамилия",placeholder:"Введите фамилию",error:k.formState.errors.lastName?.message,fullWidth:!0,...k.register("lastName")}),t.jsx(he,{label:"Номер телефона",type:"tel",placeholder:"+7 (999) 123-45-67",error:k.formState.errors.phone?.message,helperText:"Номер телефона нужен для связи с поддержкой в WhatsApp",fullWidth:!0,...k.register("phone")}),t.jsx(he,{label:"Город",placeholder:"Введите город",error:k.formState.errors.city?.message,fullWidth:!0,...k.register("city")}),C&&t.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-xl",children:t.jsx("p",{className:"text-sm font-manrope text-red-600",children:C})}),t.jsx(oe,{type:"submit",fullWidth:!0,isLoading:I,size:"lg",children:"Сохранить профиль"})]})]});const Z=a==="pension"?"Пансионат":"Патронажное агентство";return t.jsxs("div",{className:"max-w-md mx-auto px-4 py-8",children:[t.jsx("h1",{className:"text-[32px] font-bold text-gray-dark mb-2 text-center",children:"Заполнить профиль"}),t.jsx("p",{className:"text-gray-600 mb-8 text-center text-sm font-manrope",children:Z}),t.jsxs("form",{onSubmit:f.handleSubmit(U),className:"space-y-6",children:[t.jsx(he,{label:"Название организации",placeholder:"Введите название организации",error:f.formState.errors.name?.message,fullWidth:!0,...f.register("name")}),t.jsx(he,{label:"Номер телефона",type:"tel",placeholder:"+7 (999) 123-45-67",error:f.formState.errors.phone?.message,helperText:"Номер телефона нужен для связи с поддержкой в WhatsApp",fullWidth:!0,...f.register("phone")}),t.jsx(he,{label:"Адрес организации",placeholder:"Введите адрес места нахождения организации",error:f.formState.errors.address?.message,fullWidth:!0,...f.register("address")}),C&&t.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-xl",children:t.jsx("p",{className:"text-sm text-red-600",children:C})}),t.jsx(oe,{type:"submit",fullWidth:!0,isLoading:I,size:"lg",children:"Сохранить профиль"})]})]})},ag=()=>{const e=rt(),{user:r}=Se(),[s,a]=u.useState(null),[n,i]=u.useState(null),[o,c]=u.useState(!0),[g,_]=u.useState(!1),y=u.useRef(null);if(u.useEffect(()=>{(async()=>{if(!r){e("/login");return}try{const p=r.user_metadata?.organization_type;if(p&&["pension","patronage_agency","caregiver"].includes(p)){a(p);try{const{data:x,error:F}=await R.from("organizations").select("*").eq("user_id",r.id).single();if(!F&&x){i({name:x.name||"",type:p,phone:x.phone||null,city:x.city||null,address:x.address||null,firstName:x.first_name||null,lastName:x.last_name||null,avatar_url:x.avatar_url||null}),c(!1);return}}catch(x){console.error("Ошибка загрузки организации из БД:",x)}const f=r.user_metadata?.profile_data||r.user_metadata;f&&i({name:p==="caregiver"?`${f.firstName||f.first_name||""} ${f.lastName||f.last_name||""}`.trim():f.name||"",type:p,phone:f.phone||null,city:f.city||null,address:f.address||null,firstName:f.firstName||f.first_name||null,lastName:f.lastName||f.last_name||null}),c(!1);return}let k=r.user_role||r.user_metadata?.user_role||r.user_metadata?.role;if(!k)try{console.log("ProfilePage: Role not found in metadata, loading from user_profiles...");const{data:f,error:x}=await R.from("user_profiles").select("role").eq("user_id",r.id).maybeSingle();!x&&f?.role?(k=f.role,console.log("ProfilePage: Loaded role from user_profiles:",k)):x&&x.code!=="PGRST116"&&console.error("ProfilePage: Error loading from user_profiles:",x)}catch(f){console.error("ProfilePage: Error loading from user_profiles:",f)}if(console.log("ProfilePage: Final userRole:",k),k==="client"){a("client");try{const{data:f,error:x}=await R.from("clients").select("first_name, last_name, phone, avatar_url").eq("user_id",r.id).single();if(!x&&f){const F=f.phone||r.phone||r.user_metadata?.phone||null;i({name:`${f.first_name||""} ${f.last_name||""}`.trim(),type:"client",firstName:f.first_name,lastName:f.last_name,phone:F,avatar_url:f.avatar_url||null}),c(!1),console.log("✅ ProfilePage: Client profile loaded from Supabase");return}}catch(f){console.error("Error loading client from Supabase:",f)}try{const x=JSON.parse(localStorage.getItem("local_clients")||"[]").find(F=>F.user_id===r.id);if(x){const F=r.phone||r.user_metadata?.phone||x.phone||null;i({name:`${x.first_name||""} ${x.last_name||""}`.trim(),type:"client",firstName:x.first_name,lastName:x.last_name,phone:F}),c(!1),console.log("✅ ProfilePage: Client profile loaded from localStorage");return}}catch(f){console.log("Error loading client from localStorage:",f)}try{const f=JSON.parse(localStorage.getItem("current_user")||"{}");if(f.profile_data){const x=r.phone||r.user_metadata?.phone||f.profile_data.phone||f.phone||null;i({name:`${f.profile_data.firstName||""} ${f.profile_data.lastName||""}`.trim(),type:"client",firstName:f.profile_data.firstName,lastName:f.profile_data.lastName,phone:x}),c(!1),console.log("✅ ProfilePage: Client profile loaded from current_user");return}}catch(f){console.log("Error loading client from current_user:",f)}c(!1);return}if(k==="org_employee"){console.log("ProfilePage: Detected org_employee, loading profile...");try{const x=JSON.parse(localStorage.getItem("local_employees")||"[]").find(F=>F.user_id===r.id);if(x){if(!x.first_name&&!x.last_name){console.log("ProfilePage: Employee in localStorage has no first_name/last_name, redirecting to setup"),e("/profile/setup");return}const F=r.phone||r.user_metadata?.phone_for_login||r.user_metadata?.phone||x.phone||null;i({name:`${x.first_name||""} ${x.last_name||""}`.trim(),type:"employee",firstName:x.first_name,lastName:x.last_name,phone:F}),a("employee"),c(!1),console.log("✅ ProfilePage: Employee profile loaded from localStorage");return}}catch(f){console.log("Error loading from localStorage:",f)}try{const f=JSON.parse(localStorage.getItem("current_user")||"{}");if(f.profile_data){if(!f.profile_data.firstName&&!f.profile_data.lastName){console.log("ProfilePage: current_user profile_data has no firstName/lastName, redirecting to setup"),e("/profile/setup");return}const x=r.phone||r.user_metadata?.phone_for_login||r.user_metadata?.phone||f.profile_data.phone||null;i({name:`${f.profile_data.firstName||""} ${f.profile_data.lastName||""}`.trim(),type:"employee",firstName:f.profile_data.firstName,lastName:f.profile_data.lastName,phone:x}),a("employee"),c(!1),console.log("✅ ProfilePage: Employee profile loaded from current_user");return}}catch(f){console.log("Error loading from current_user:",f)}try{const f=new Promise((M,L)=>setTimeout(()=>L(new Error("Timeout")),2e3)),x=R.from("organization_employees").select("*").eq("user_id",r.id).single(),{data:F,error:H}=await Promise.race([x,f]);if(console.log("ProfilePage: DB query result:",{data:F,error:H,hasData:!!F}),!H&&F){const M=r.phone||r.user_metadata?.phone_for_login||r.user_metadata?.phone||F.phone||null;let L=null;try{const{data:U}=await R.from("user_profiles").select("avatar_url").eq("user_id",r.id).maybeSingle();L=U?.avatar_url||null}catch(U){console.log("Error loading avatar from user_profiles:",U)}if(console.log("ProfilePage: Employee data from DB:",{first_name:F.first_name,last_name:F.last_name,phone:M,hasFirstName:!!F.first_name,hasLastName:!!F.last_name}),!F.first_name&&!F.last_name){console.log("ProfilePage: Employee has no first_name/last_name, redirecting to setup"),e("/profile/setup");return}i({name:`${F.first_name||""} ${F.last_name||""}`.trim(),type:"employee",firstName:F.first_name,lastName:F.last_name,phone:M,avatar_url:L}),a("employee"),c(!1),console.log("✅ ProfilePage: Employee profile loaded successfully from DB");return}else if(H){if(console.error("ProfilePage: DB error:",H),H.code==="PGRST116"){console.log("ProfilePage: Employee record not found (PGRST116), redirecting to setup"),e("/profile/setup");return}console.log("ProfilePage: DB error (not PGRST116), trying metadata fallback")}}catch{console.log("DB query timeout or error, using metadata");const x=r.phone||r.user_metadata?.phone_for_login||r.user_metadata?.phone||null,F=r.user_metadata?.profile_data||r.profile_data;if(F)i({name:`${F.firstName||""} ${F.lastName||""}`.trim(),type:"employee",firstName:F.firstName,lastName:F.lastName,phone:x}),a("employee"),console.log("✅ ProfilePage: Employee profile loaded from metadata fallback");else{console.log("ProfilePage: No employee data found, redirecting to setup"),e("/profile/setup");return}}c(!1);return}}catch(p){console.error("Error loading profile:",p)}finally{c(!1)}})()},[r,e]),o)return t.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-100",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"animate-spin w-12 h-12 border-4 border-blue-primary border-t-transparent rounded-full mx-auto mb-4"}),t.jsx("p",{className:"text-gray-600",children:"Загрузка профиля..."})]})});if(!s||!n)return t.jsx("div",{className:"min-h-screen flex items-center justify-center px-4 bg-gray-100",children:t.jsxs("div",{className:"text-center max-w-md",children:[t.jsx("div",{className:"w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4",children:t.jsx("svg",{className:"w-8 h-8 text-red-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),t.jsx("h1",{className:"text-2xl font-bold text-gray-dark mb-3",children:"Ошибка"}),t.jsx("p",{className:"text-gray-600 text-sm mb-6",children:"Не удалось загрузить профиль. Пожалуйста, заполните профиль сначала."}),t.jsx(oe,{onClick:()=>e("/profile/setup"),fullWidth:!0,size:"lg",children:"Заполнить профиль"})]})});const D=s==="pension"||s==="patronage_agency",w=s==="employee",I=s==="client",P=s==="caregiver",C=(w||I)&&n.firstName?n.firstName:n.name,B=()=>{y.current?.click()},O=async $=>{const p=$.target.files?.[0];if(!(!p||!r)){if(!p.type.startsWith("image/")){alert("Пожалуйста, выберите изображение");return}if(p.size>5*1024*1024){alert("Размер файла не должен превышать 5MB");return}_(!0);try{const k=p.name.split(".").pop(),x=`${r.id}-${Date.now()}.${k}`;console.log('ProfilePage: Uploading avatar to bucket "avatars", filePath:',x);const{data:F,error:H}=await R.storage.from("avatars").upload(x,p,{cacheControl:"3600",upsert:!0});if(H){console.error("ProfilePage: Upload error:",H),console.error("ProfilePage: Upload error details:",{message:H.message,statusCode:H.statusCode,error:H.error});let L="Не удалось загрузить аватар. ";throw H.message?.includes("Bucket not found")||H.message?.includes("not found")?L+='Bucket "avatars" не найден. Убедитесь, что bucket создан в Supabase Storage.':H.message?.includes("row-level security")||H.message?.includes("RLS")?L+="Нет прав на загрузку файла. Обратитесь к администратору для настройки политик Storage.":H.message?.includes("JWT")?L+="Ошибка аутентификации. Попробуйте выйти и войти снова.":H.message?.includes("size")||H.message?.includes("limit")?L+="Файл слишком большой. Максимальный размер: 5MB.":L+=H.message||"Попробуйте еще раз.",new Error(L)}console.log("ProfilePage: File uploaded successfully:",F);const{data:{publicUrl:M}}=R.storage.from("avatars").getPublicUrl(x);if(console.log("ProfilePage: Public URL generated:",M),D){const{error:L}=await R.from("organizations").update({avatar_url:M}).eq("user_id",r.id);if(L)throw L}else if(w){const{error:L}=await R.from("user_profiles").update({avatar_url:M}).eq("user_id",r.id);if(L)throw L}else if(I){const{error:L}=await R.from("clients").update({avatar_url:M}).eq("user_id",r.id);if(L)throw L}i(L=>L?{...L,avatar_url:M}:null)}catch(k){console.error("Ошибка загрузки аватара:",k),alert("Не удалось загрузить аватар. Попробуйте еще раз.")}finally{_(!1),y.current&&(y.current.value="")}}};return t.jsxs("div",{className:"min-h-screen bg-gray-100 flex flex-col",children:[t.jsx("header",{className:"bg-white",children:t.jsxs("div",{className:"flex items-center px-4 py-3 relative",children:[t.jsx("button",{onClick:()=>e("/dashboard"),className:"mr-4 p-2 -ml-2","aria-label":"Назад",children:t.jsx("img",{src:"/icons/Иконка стрелка.png",alt:"Назад",className:"w-6 h-6 object-contain"})}),t.jsx("h1",{className:"absolute left-1/2 transform -translate-x-1/2 text-lg font-bold text-gray-dark",children:"Профиль"})]})}),t.jsxs("div",{className:"flex-1 max-w-md mx-auto w-full px-4 pb-0",children:[t.jsx("div",{className:"bg-white rounded-3xl shadow-md p-4 mb-6 mt-4",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("div",{className:"flex flex-col items-center flex-shrink-0",children:[t.jsxs("div",{onClick:B,className:"w-16 h-16 rounded-full flex items-center justify-center overflow-hidden cursor-pointer relative group bg-gray-100",children:[n.avatar_url?t.jsx("img",{src:n.avatar_url,alt:"Аватар",className:"w-full h-full object-cover"}):t.jsx("img",{src:"/icons/Иконка профиль.png",alt:"Профиль",className:"w-full h-full object-contain"}),g&&t.jsx("div",{className:"absolute inset-0 bg-black/50 flex items-center justify-center",children:t.jsx("div",{className:"animate-spin w-6 h-6 border-2 border-white border-t-transparent rounded-full"})}),!g&&t.jsx("div",{className:"absolute inset-0 bg-black/0 group-hover:bg-black/30 flex items-center justify-center transition-colors",children:t.jsxs("svg",{className:"w-6 h-6 text-white opacity-0 group-hover:opacity-100 transition-opacity",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"}),t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 13a3 3 0 11-6 0 3 3 0 016 0z"})]})})]}),t.jsx("input",{ref:y,type:"file",accept:"image/*",onChange:O,className:"hidden"})]}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("h2",{className:"text-xl font-bold text-gray-dark mb-1.5",children:C}),n.phone&&t.jsx("p",{className:"text-xs font-manrope text-gray-600 mb-1.5",children:n.phone}),D&&n.address&&t.jsx("p",{className:"text-xs font-manrope text-gray-600 mb-2",children:n.address}),!D&&!w&&n.city&&t.jsxs("p",{className:"text-xs font-manrope text-gray-600 mb-2",children:["г. ",n.city]}),t.jsx("button",{onClick:()=>e("/profile/edit"),className:"px-3 py-1.5 text-white rounded-lg text-xs font-manrope font-normal hover:opacity-90 transition-opacity",style:{background:"linear-gradient(135deg, #7DD3DC 0%, #5CBCC7 100%)"},children:"Настройки"})]})]})}),t.jsxs("div",{className:"mb-0",children:[t.jsx("h3",{className:"text-2xl font-bold text-gray-dark mb-6 mt-2",children:"Управление профилем"}),t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{onClick:()=>e("/dashboard"),className:"bg-white rounded-2xl shadow-md p-5 flex items-center justify-between cursor-pointer active:bg-gray-50 transition-colors",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx("p",{className:"text-lg font-bold text-gray-dark mb-1",children:"Мои дневники"}),t.jsx("p",{className:"text-xs font-manrope text-gray-500",children:"Просмотр и управление"})]}),t.jsx("img",{src:"/icons/иконка маленькая стрелка.png",alt:"",className:"w-5 h-5 ml-4 flex-shrink-0 object-contain"})]}),t.jsxs("div",{onClick:()=>e("/profile/patient-cards"),className:"bg-white rounded-2xl shadow-md p-5 flex items-center justify-between cursor-pointer active:bg-gray-50 transition-colors",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx("p",{className:"text-lg font-bold text-gray-dark mb-1",children:"Карточки подопечных"}),t.jsx("p",{className:"text-xs font-manrope text-gray-500",children:w?"Просмотр":"Просмотр и редактирование"})]}),t.jsx("img",{src:"/icons/иконка маленькая стрелка.png",alt:"",className:"w-5 h-5 ml-4 flex-shrink-0 object-contain"})]}),D&&!w&&!I&&t.jsxs("div",{onClick:()=>e("/profile/employees"),className:"bg-white rounded-2xl shadow-md p-5 flex items-center justify-between cursor-pointer active:bg-gray-50 transition-colors",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx("p",{className:"text-lg font-bold text-gray-dark mb-1",children:"Сотрудники"}),t.jsx("p",{className:"text-xs font-manrope text-gray-500",children:"Управление командой"})]}),t.jsx("img",{src:"/icons/иконка маленькая стрелка.png",alt:"",className:"w-5 h-5 ml-4 flex-shrink-0 object-contain"})]}),D&&!w&&!I&&t.jsxs("div",{onClick:()=>e("/profile/clients"),className:"bg-white rounded-2xl shadow-md p-5 flex items-center justify-between cursor-pointer active:bg-gray-50 transition-colors",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx("p",{className:"text-lg font-bold text-gray-dark mb-1",children:"Клиенты"}),t.jsx("p",{className:"text-xs font-manrope text-gray-500",children:"Список клиентов организации"})]}),t.jsx("img",{src:"/icons/иконка маленькая стрелка.png",alt:"",className:"w-5 h-5 ml-4 flex-shrink-0 object-contain"})]}),P&&!I&&!w&&t.jsxs("div",{onClick:()=>e("/profile/invite-client"),className:"bg-white rounded-2xl shadow-md p-5 flex items-center justify-between cursor-pointer active:bg-gray-50 transition-colors",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx("p",{className:"text-lg font-bold text-gray-dark mb-1",children:"Пригласить клиента"}),t.jsx("p",{className:"text-xs font-manrope text-gray-500",children:"Создать пригласительную ссылку"})]}),t.jsx("img",{src:"/icons/иконка маленькая стрелка.png",alt:"",className:"w-5 h-5 ml-4 flex-shrink-0 object-contain"})]})]})]})]}),t.jsx("div",{className:"mt-8 flex-1 flex flex-col justify-end",children:t.jsx("div",{className:"bg-white rounded-t-[30px] pb-8 pt-6 max-w-md mx-auto w-full",children:t.jsx("div",{className:"px-4",children:t.jsx("button",{onClick:()=>{window.open("https://wa.me/79145391376","_blank")},className:"w-full py-3.5 px-6 rounded-3xl text-white font-manrope font-bold text-base shadow-lg active:opacity-90 transition-opacity",style:{background:"#55ACBF"},children:"Связаться с поддержкой"})})})})]})},ng=bt({firstName:ke().min(1,"Введите имя"),lastName:ke().min(1,"Введите фамилию"),phone:ke().min(1,"Введите номер телефона"),city:ke().min(1,"Введите город")}),ig=bt({name:ke().min(1,"Введите название организации"),phone:ke().min(1,"Введите номер телефона"),address:ke().min(1,"Введите адрес организации")}),og=bt({firstName:ke().min(1,"Введите имя"),lastName:ke().min(1,"Введите фамилию")}),lg=bt({firstName:ke().min(1,"Введите имя"),lastName:ke().min(1,"Введите фамилию")}),cg=()=>{const e=rt(),{user:r,logout:s}=Se(),[a,n]=u.useState(null),[i,o]=u.useState(!1),[c,g]=u.useState(!0),[_,y]=u.useState(null),[D,w]=u.useState(null),[I,P]=u.useState(null),[C,B]=u.useState(!1),O=u.useRef(null),$=xt({resolver:yt(ng)}),p=xt({resolver:yt(ig)}),k=xt({resolver:yt(og)}),f=xt({resolver:yt(lg)});u.useEffect(()=>{(async()=>{if(!r){e("/login");return}try{const v=r.user_metadata?.organization_type;if(v&&["pension","patronage_agency","caregiver"].includes(v)){n(v);try{const{data:J,error:W}=await R.from("organizations").select("*").eq("user_id",r.id).single();if(!W&&J){P(J.avatar_url||null),v==="caregiver"?$.reset({firstName:J.first_name||"",lastName:J.last_name||"",phone:J.phone||"",city:J.city||""}):p.reset({name:J.name||"",phone:J.phone||"",address:J.address||""}),g(!1);return}}catch(J){console.error("Ошибка загрузки организации из БД:",J)}const T=r.user_metadata?.profile_data||r.user_metadata;T&&(v==="caregiver"?$.reset({firstName:T.firstName||T.first_name||"",lastName:T.lastName||T.last_name||"",phone:T.phone||"",city:T.city||""}):p.reset({name:T.name||"",phone:T.phone||"",address:T.address||""})),g(!1);return}let z=r.user_role||r.user_metadata?.user_role||r.user_metadata?.role;if(!z)try{console.log("ProfileEditPage: Role not found in metadata, loading from user_profiles...");const{data:T,error:J}=await R.from("user_profiles").select("role").eq("user_id",r.id).single();!J&&T&&(z=T.role,console.log("ProfileEditPage: Loaded role from user_profiles:",z))}catch(T){console.error("ProfileEditPage: Error loading from user_profiles:",T)}if(console.log("ProfileEditPage: Final userRole:",z),z==="client"){n("client");try{const{data:T,error:J}=await R.from("clients").select("first_name, last_name").eq("user_id",r.id).single();if(!J&&T){f.reset({firstName:T.first_name||"",lastName:T.last_name||""}),g(!1),console.log("✅ ProfileEditPage: Client profile loaded from Supabase");return}else if(J&&J.code==="PGRST116"){console.log("ProfileEditPage: Client record not found, using empty values"),f.reset({firstName:"",lastName:""}),g(!1);return}else J&&(console.error("Error loading client from Supabase:",J),y("Не удалось загрузить профиль клиента"))}catch(T){console.error("Error loading client from Supabase:",T),y("Ошибка при загрузке профиля")}f.reset({firstName:"",lastName:""}),g(!1);return}if(z==="org_employee"){console.log("ProfileEditPage: Detected org_employee, loading profile..."),n("employee");try{const{data:T,error:J}=await R.from("organization_employees").select("first_name, last_name").eq("user_id",r.id).single();if(console.log("ProfileEditPage: DB query result:",{data:T,error:J,hasData:!!T}),!J&&T){k.reset({firstName:T.first_name||"",lastName:T.last_name||""}),g(!1),console.log("✅ ProfileEditPage: Employee profile loaded from Supabase");return}else if(J&&J.code==="PGRST116"){console.log("ProfileEditPage: Employee record not found, using empty values"),k.reset({firstName:"",lastName:""}),g(!1);return}else J&&(console.error("ProfileEditPage: DB error:",J),y("Не удалось загрузить профиль сотрудника"))}catch(T){console.error("ProfileEditPage: Error loading employee from Supabase:",T),y("Ошибка при загрузке профиля")}k.reset({firstName:"",lastName:""}),g(!1);return}}catch(v){y(zt(v))}finally{g(!1)}})()},[r,e,$,p,k,f]);const x=async j=>{if(!(!r||!a)){o(!0),y(null),w(null);try{try{const{error:v}=await R.from("organizations").update({first_name:j.firstName,last_name:j.lastName,name:`${j.firstName} ${j.lastName}`,phone:j.phone,city:j.city}).eq("user_id",r.id);if(v)throw v;w("Профиль успешно обновлен!"),setTimeout(()=>{e("/profile")},2e3)}catch{const{error:z}=await R.auth.updateUser({data:{profile_data:{firstName:j.firstName,lastName:j.lastName,phone:j.phone,city:j.city}}});if(z)throw z;w("Профиль успешно обновлен!"),setTimeout(()=>{e("/profile")},2e3)}}catch(v){y(zt(v))}finally{o(!1)}}},F=async j=>{if(r){o(!0),y(null),w(null);try{const{error:v}=await R.from("clients").update({first_name:j.firstName,last_name:j.lastName}).eq("user_id",r.id);if(v)throw console.error("Error updating client in Supabase:",v),v;console.log("✅ ProfileEditPage: Client profile updated in Supabase"),await R.auth.updateUser({data:{firstName:j.firstName,lastName:j.lastName}}),w("Профиль успешно обновлен!"),setTimeout(()=>{e("/profile")},2e3)}catch(v){console.error("Error saving client profile:",v),y(zt(v)||"Не удалось сохранить изменения. Попробуйте ещё раз.")}finally{o(!1)}}},H=async j=>{if(r){o(!0),y(null),w(null);try{let v=r.organization_id||r.user_metadata?.organization_id;if(!v||v==="temp")try{const{data:W}=await R.from("user_profiles").select("organization_id").eq("user_id",r.id).single();if(W?.organization_id)v=W.organization_id;else{const{data:h}=await R.from("organization_employees").select("organization_id").eq("user_id",r.id).single();h?.organization_id&&(v=h.organization_id)}}catch(W){console.error("ProfileEditPage: Error loading organization_id:",W)}(!v||v==="temp")&&(console.warn("ProfileEditPage: organization_id is still temp, using fallback"),v="temp");const z=r.phone||r.user_metadata?.phone_for_login||r.user_metadata?.phone||null;console.log("ProfileEditPage: Saving employee to Supabase:",{user_id:r.id,organization_id:v,first_name:j.firstName,last_name:j.lastName,phone:z});const{data:T,error:J}=await R.from("organization_employees").select("id").eq("user_id",r.id).single();if(J&&J.code!=="PGRST116")throw console.error("ProfileEditPage: Error checking existing employee:",J),J;if(T){const{error:W}=await R.from("organization_employees").update({first_name:j.firstName,last_name:j.lastName,phone:z||null}).eq("user_id",r.id);if(W)throw console.error("ProfileEditPage: Error updating employee in Supabase:",W),W;console.log("✅ ProfileEditPage: Employee updated in Supabase")}else{const{error:W}=await R.from("organization_employees").insert({user_id:r.id,organization_id:v!=="temp"?v:null,first_name:j.firstName,last_name:j.lastName,phone:z||null,role:"caregiver"});if(W)throw console.error("ProfileEditPage: Error inserting employee in Supabase:",W),W;console.log("✅ ProfileEditPage: Employee created in Supabase")}w("Профиль успешно обновлен!"),setTimeout(()=>{e("/profile")},2e3)}catch(v){y(zt(v))}finally{o(!1)}}},M=()=>{O.current?.click()},L=async j=>{const v=j.target.files?.[0];if(!(!v||!r)){if(!v.type.startsWith("image/")){alert("Пожалуйста, выберите изображение");return}if(v.size>5*1024*1024){alert("Размер файла не должен превышать 5MB");return}B(!0),y(null);try{const z=v.name.split(".").pop(),J=`${r.id}-${Date.now()}.${z}`;console.log('ProfileEditPage: Uploading avatar to bucket "avatars", filePath:',J);const{data:W,error:h}=await R.storage.from("avatars").upload(J,v,{cacheControl:"3600",upsert:!0});if(h){console.error("ProfileEditPage: Upload error:",h),console.error("ProfileEditPage: Upload error details:",{message:h.message,statusCode:h.statusCode,error:h.error});let ee="Не удалось загрузить аватар. ";throw h.message?.includes("Bucket not found")||h.message?.includes("not found")?ee+='Bucket "avatars" не найден. Убедитесь, что bucket создан в Supabase Storage.':h.message?.includes("row-level security")||h.message?.includes("RLS")?ee+="Нет прав на загрузку файла. Обратитесь к администратору для настройки политик Storage.":h.message?.includes("JWT")?ee+="Ошибка аутентификации. Попробуйте выйти и войти снова.":h.message?.includes("size")||h.message?.includes("limit")?ee+="Файл слишком большой. Максимальный размер: 5MB.":ee+=h.message||"Попробуйте еще раз.",new Error(ee)}console.log("ProfileEditPage: File uploaded successfully:",W);const{data:{publicUrl:A}}=R.storage.from("avatars").getPublicUrl(J);console.log("ProfileEditPage: Public URL generated:",A);const{error:Y}=await R.from("organizations").update({avatar_url:A}).eq("user_id",r.id);if(Y)throw Y;P(A),w("Аватар успешно загружен!")}catch(z){console.error("Ошибка загрузки аватара:",z),y("Не удалось загрузить аватар. Попробуйте еще раз.")}finally{B(!1),O.current&&(O.current.value="")}}},U=async j=>{if(!r||!a){console.error("ProfileEditPage: Missing user or organizationType",{user:!!r,organizationType:a}),y("Ошибка: не удалось определить пользователя или тип организации");return}o(!0),y(null),w(null),console.log("ProfileEditPage: Starting save organization profile",{userId:r.id,organizationType:a,data:{name:j.name,phone:j.phone,address:j.address,hasAvatar:!!I}});try{const v={name:j.name.trim(),phone:j.phone.trim(),address:j.address.trim()};I&&(v.avatar_url=I),console.log("ProfileEditPage: Updating organization with data:",v);const{data:z,error:T}=await R.from("organizations").select("id, name, phone, address").eq("user_id",r.id).single();if(T&&T.code!=="PGRST116")throw console.error("ProfileEditPage: Error checking existing organization:",T),new Error(`Ошибка проверки записи: ${T.message}`);if(!z)throw console.error("ProfileEditPage: Organization not found for user_id:",r.id),new Error("Организация не найдена. Обратитесь в поддержку.");console.log("ProfileEditPage: Existing organization found:",z);const{data:J,error:W}=await R.from("organizations").update(v).eq("user_id",r.id).select();if(W)throw console.error("ProfileEditPage: Error updating organization:",W),console.error("ProfileEditPage: Update error details:",{code:W.code,message:W.message,details:W.details,hint:W.hint}),W;if(!J||J.length===0)throw console.error("ProfileEditPage: No data returned after update"),new Error("Не удалось обновить профиль. Попробуйте еще раз.");console.log("✅ ProfileEditPage: Organization profile updated successfully:",J[0]),w("Профиль успешно обновлен!"),setTimeout(()=>{e("/profile")},2e3)}catch(v){console.error("ProfileEditPage: Error saving organization profile:",v);const z=v?.message||zt(v)||"Не удалось сохранить изменения. Попробуйте ещё раз.";y(z),o(!1)}};if(c)return t.jsx("div",{className:"min-h-screen flex items-center justify-center",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"animate-spin w-12 h-12 border-4 border-blue-primary border-t-transparent rounded-full mx-auto mb-4"}),t.jsx("p",{className:"text-gray-600",children:"Загрузка профиля..."})]})});if(!a)return t.jsx("div",{className:"min-h-screen flex items-center justify-center px-4",children:t.jsxs("div",{className:"text-center max-w-md",children:[t.jsx("div",{className:"w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4",children:t.jsx("svg",{className:"w-8 h-8 text-red-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),t.jsx("h1",{className:"text-2xl font-bold text-gray-dark mb-3",children:"Ошибка"}),t.jsx("p",{className:"text-gray-600 text-sm font-manrope mb-6",children:_||"Не удалось загрузить профиль. Пожалуйста, заполните профиль сначала."}),t.jsx(oe,{onClick:()=>e("/profile/setup"),fullWidth:!0,size:"lg",children:"Заполнить профиль"})]})});if(a==="client")return t.jsxs("div",{className:"min-h-screen bg-gray-100",children:[t.jsx("header",{className:"bg-white",children:t.jsxs("div",{className:"flex items-center px-4 py-3 relative",children:[t.jsx("button",{onClick:()=>e("/profile"),className:"mr-4 p-2 -ml-2","aria-label":"Назад",children:t.jsx("img",{src:"/icons/Иконка стрелка.png",alt:"Назад",className:"w-6 h-6 object-contain"})}),t.jsx("h1",{className:"absolute left-1/2 transform -translate-x-1/2 text-lg font-bold text-gray-dark",children:"Настройки"})]})}),t.jsxs("div",{className:"max-w-md mx-auto px-4 py-8",children:[t.jsxs("h2",{className:"text-[32px] font-bold text-gray-dark mb-2 text-center",children:[t.jsx("span",{className:"block",children:"Редактирование"}),t.jsx("span",{className:"block",children:"профиля"})]}),t.jsx("p",{className:"text-gray-600 mb-8 text-center text-sm font-manrope",children:"Клиент"}),D&&t.jsx("div",{className:"mb-6 p-3 bg-green-50 border border-green-200 rounded-xl",children:t.jsx("p",{className:"text-sm font-manrope text-green-600",children:D})}),t.jsx("div",{className:"bg-white rounded-3xl shadow-md p-6",children:t.jsxs("form",{onSubmit:f.handleSubmit(F),className:"space-y-6",children:[t.jsx(he,{label:"Имя",placeholder:"Введите имя",error:f.formState.errors.firstName?.message,fullWidth:!0,...f.register("firstName")}),t.jsx(he,{label:"Фамилия",placeholder:"Введите фамилию",error:f.formState.errors.lastName?.message,fullWidth:!0,...f.register("lastName")}),_&&t.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-xl",children:t.jsx("p",{className:"text-sm font-manrope text-red-600",children:_})}),t.jsx(oe,{type:"submit",fullWidth:!0,isLoading:i,size:"lg",children:"Сохранить изменения"})]})}),t.jsx("div",{className:"mt-6",children:t.jsx("button",{onClick:async()=>{confirm("Вы уверены, что хотите выйти из аккаунта?")&&(await s(),e("/login"))},className:"w-full py-3.5 px-6 rounded-3xl text-white font-manrope font-bold text-base shadow-lg active:opacity-90 transition-opacity",style:{background:"#EF4444"},children:"Выйти из аккаунта"})})]})]});if(a==="employee")return t.jsxs("div",{className:"min-h-screen bg-gray-100",children:[t.jsx("header",{className:"bg-white",children:t.jsxs("div",{className:"flex items-center px-4 py-3 relative",children:[t.jsx("button",{onClick:()=>e("/profile"),className:"mr-4 p-2 -ml-2","aria-label":"Назад",children:t.jsx("img",{src:"/icons/Иконка стрелка.png",alt:"Назад",className:"w-6 h-6 object-contain"})}),t.jsx("h1",{className:"absolute left-1/2 transform -translate-x-1/2 text-lg font-bold text-gray-dark",children:"Настройки"})]})}),t.jsxs("div",{className:"max-w-md mx-auto px-4 py-8",children:[t.jsxs("h2",{className:"text-[32px] font-bold text-gray-dark mb-2 text-center",children:[t.jsx("span",{className:"block",children:"Редактирование"}),t.jsx("span",{className:"block",children:"профиля"})]}),t.jsx("p",{className:"text-gray-600 mb-8 text-center text-sm font-manrope",children:"Сотрудник организации"}),D&&t.jsx("div",{className:"mb-6 p-3 bg-green-50 border border-green-200 rounded-xl",children:t.jsx("p",{className:"text-sm font-manrope text-green-600",children:D})}),t.jsx("div",{className:"bg-white rounded-3xl shadow-md p-6",children:t.jsxs("form",{onSubmit:k.handleSubmit(H),className:"space-y-6",children:[t.jsx(he,{label:"Имя",placeholder:"Введите имя",error:k.formState.errors.firstName?.message,fullWidth:!0,...k.register("firstName")}),t.jsx(he,{label:"Фамилия",placeholder:"Введите фамилию",error:k.formState.errors.lastName?.message,fullWidth:!0,...k.register("lastName")}),_&&t.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-xl",children:t.jsx("p",{className:"text-sm font-manrope text-red-600",children:_})}),t.jsx(oe,{type:"submit",fullWidth:!0,isLoading:i,size:"lg",children:"Сохранить изменения"})]})}),t.jsx("div",{className:"mt-6",children:t.jsx("button",{onClick:async()=>{confirm("Вы уверены, что хотите выйти из аккаунта?")&&(await s(),e("/login"))},className:"w-full py-3.5 px-6 rounded-3xl text-white font-manrope font-bold text-base shadow-lg active:opacity-90 transition-opacity",style:{background:"#EF4444"},children:"Выйти из аккаунта"})})]})]});if(a==="caregiver")return t.jsxs("div",{className:"min-h-screen bg-gray-100",children:[t.jsx("header",{className:"bg-white",children:t.jsxs("div",{className:"flex items-center px-4 py-3 relative",children:[t.jsx("button",{onClick:()=>e("/profile"),className:"mr-4 p-2 -ml-2","aria-label":"Назад",children:t.jsx("img",{src:"/icons/Иконка стрелка.png",alt:"Назад",className:"w-6 h-6 object-contain"})}),t.jsx("h1",{className:"absolute left-1/2 transform -translate-x-1/2 text-lg font-bold text-gray-dark",children:"Настройки"})]})}),t.jsxs("div",{className:"max-w-md mx-auto px-4 py-8",children:[t.jsx("h2",{className:"text-[32px] font-bold text-gray-dark mb-2 text-center",children:"Редактирование профиля"}),t.jsx("p",{className:"text-gray-600 mb-8 text-center text-sm font-manrope",children:"Частная сиделка"}),D&&t.jsx("div",{className:"mb-6 p-3 bg-green-50 border border-green-200 rounded-xl",children:t.jsx("p",{className:"text-sm font-manrope text-green-600",children:D})}),t.jsx("div",{className:"bg-white rounded-3xl shadow-md p-6",children:t.jsxs("form",{onSubmit:$.handleSubmit(x),className:"space-y-6",children:[t.jsx(he,{label:"Имя",placeholder:"Введите имя",error:$.formState.errors.firstName?.message,fullWidth:!0,...$.register("firstName")}),t.jsx(he,{label:"Фамилия",placeholder:"Введите фамилию",error:$.formState.errors.lastName?.message,fullWidth:!0,...$.register("lastName")}),t.jsx(he,{label:"Номер телефона",type:"tel",placeholder:"+7 (999) 123-45-67",error:$.formState.errors.phone?.message,helperText:"Номер телефона нужен для связи с поддержкой в WhatsApp",fullWidth:!0,...$.register("phone")}),t.jsx(he,{label:"Город",placeholder:"Введите город",error:$.formState.errors.city?.message,fullWidth:!0,...$.register("city")}),_&&t.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-xl",children:t.jsx("p",{className:"text-sm font-manrope text-red-600",children:_})}),t.jsx(oe,{type:"submit",fullWidth:!0,isLoading:i,size:"lg",children:"Сохранить изменения"})]})}),t.jsx("div",{className:"mt-6",children:t.jsx("button",{onClick:async()=>{confirm("Вы уверены, что хотите выйти из аккаунта?")&&(await s(),e("/login"))},className:"w-full py-3.5 px-6 rounded-3xl text-white font-manrope font-bold text-base shadow-lg active:opacity-90 transition-opacity",style:{background:"#EF4444"},children:"Выйти из аккаунта"})})]})]});const Z=a==="pension"?"Пансионат":"Патронажное агентство";return t.jsxs("div",{className:"min-h-screen bg-gray-100",children:[t.jsx("header",{className:"bg-white",children:t.jsxs("div",{className:"flex items-center px-4 py-3 relative",children:[t.jsx("button",{onClick:()=>e("/profile"),className:"mr-4 p-2 -ml-2","aria-label":"Назад",children:t.jsx("img",{src:"/icons/Иконка стрелка.png",alt:"Назад",className:"w-6 h-6 object-contain"})}),t.jsx("h1",{className:"absolute left-1/2 transform -translate-x-1/2 text-lg font-bold text-gray-dark",children:"Настройки"})]})}),t.jsxs("div",{className:"max-w-md mx-auto px-4 py-8",children:[t.jsx("h2",{className:"text-[32px] font-bold text-gray-dark mb-2 text-center",children:"Редактирование профиля"}),t.jsx("p",{className:"text-gray-600 mb-8 text-center text-sm font-manrope",children:Z}),D&&t.jsx("div",{className:"mb-6 p-3 bg-green-50 border border-green-200 rounded-xl",children:t.jsx("p",{className:"text-sm text-green-600",children:D})}),t.jsx("div",{className:"bg-white rounded-3xl shadow-md p-6",children:t.jsxs("form",{onSubmit:p.handleSubmit(U),className:"space-y-6",children:[t.jsxs("div",{className:"flex flex-col items-center mb-6",children:[t.jsxs("div",{onClick:M,className:"w-24 h-24 rounded-full flex items-center justify-center overflow-hidden cursor-pointer relative group bg-gray-100 mb-2",children:[I?t.jsx("img",{src:I,alt:"Аватар",className:"w-full h-full object-cover"}):t.jsx("img",{src:"/icons/Иконка профиль.png",alt:"Профиль",className:"w-full h-full object-contain"}),C&&t.jsx("div",{className:"absolute inset-0 bg-black/50 flex items-center justify-center",children:t.jsx("div",{className:"animate-spin w-8 h-8 border-2 border-white border-t-transparent rounded-full"})}),!C&&t.jsx("div",{className:"absolute inset-0 bg-black/0 group-hover:bg-black/30 flex items-center justify-center transition-colors",children:t.jsxs("svg",{className:"w-8 h-8 text-white opacity-0 group-hover:opacity-100 transition-opacity",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"}),t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 13a3 3 0 11-6 0 3 3 0 016 0z"})]})})]}),t.jsx("button",{type:"button",onClick:M,className:"text-sm text-gray-600 hover:text-gray-800 transition-colors",disabled:C,children:C?"Загрузка...":"Выбрать аватар"}),t.jsx("input",{ref:O,type:"file",accept:"image/*",onChange:L,className:"hidden"})]}),t.jsx(he,{label:"Название организации",placeholder:"Введите название организации",error:p.formState.errors.name?.message,fullWidth:!0,...p.register("name")}),t.jsx(he,{label:"Номер телефона",type:"tel",placeholder:"+7 (999) 123-45-67",error:p.formState.errors.phone?.message,helperText:"Номер телефона нужен для связи с поддержкой в WhatsApp",fullWidth:!0,...p.register("phone")}),t.jsx(he,{label:"Адрес организации",placeholder:"Введите адрес места нахождения организации",error:p.formState.errors.address?.message,fullWidth:!0,...p.register("address")}),_&&t.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-xl",children:t.jsx("p",{className:"text-sm text-red-600",children:_})}),t.jsx(oe,{type:"submit",fullWidth:!0,isLoading:i,size:"lg",children:"Сохранить изменения"})]})}),t.jsx("div",{className:"mt-6",children:t.jsx("button",{onClick:async()=>{confirm("Вы уверены, что хотите выйти из аккаунта?")&&(await s(),e("/login"))},className:"w-full py-3.5 px-6 rounded-3xl text-white font-manrope font-bold text-base shadow-lg active:opacity-90 transition-opacity",style:{background:"#EF4444"},children:"Выйти из аккаунта"})})]})]})},fs=async e=>{try{const{data:r,error:s}=await R.from("organization_employees").select("role").eq("user_id",e).single();return s||!r?null:r.role||null}catch(r){return console.error("Ошибка получения роли сотрудника:",r),null}},zn=async e=>{if(!e)return!1;const r=e.user_metadata?.organization_type;if(r&&["pension","patronage_agency","caregiver"].includes(r))return!0;const s=e.user_metadata?.user_role||e.user_metadata?.role;if(s==="client")return!0;if(s==="org_employee"){const a=await fs(e.id);return a==="admin"||a==="manager"}return!1},En=async e=>{if(!e)return!1;const r=e.user_metadata?.organization_type;if(r&&["pension","patronage_agency","caregiver"].includes(r))return!0;const s=e.user_metadata?.user_role||e.user_metadata?.role;if(s==="client")return!0;if(s==="org_employee"){const a=await fs(e.id);return a==="admin"||a==="manager"}return!1},dg=async e=>{if(!e)return!1;const r=e.user_metadata?.organization_type;return r&&["pension","patronage_agency"].includes(r)?!0:(e.user_metadata?.user_role||e.user_metadata?.role)==="org_employee"?await fs(e.id)==="manager":!1},ug=async e=>{if(!e)return!1;const r=e.user_metadata?.organization_type;return r&&["pension","patronage_agency"].includes(r)?!0:(e.user_metadata?.user_role||e.user_metadata?.role)==="org_employee"?await fs(e.id)==="manager":!1},gl=async e=>{if(!e)return!1;const r=e.user_metadata?.organization_type;if(r&&["pension","patronage_agency"].includes(r))return!0;const s=e.user_metadata?.user_role||e.user_metadata?.role;if(s==="client")return!0;if(s==="org_employee"){const a=await fs(e.id);return a==="admin"||a==="manager"}return!1},mg=e=>{const r=(Array.isArray(e.patient_card)?e.patient_card[0]:e.patient_card)||e.patient_cards?.[0]||null;return{id:e.id,created_at:e.created_at,status:e.status??"active",patient_card:r?{id:r.id,full_name:r.full_name??"",date_of_birth:r.date_of_birth??null,address:r.address??r.metadata?.address??null}:null}},ho=e=>{if(!e)return null;const r=new Date(e);if(Number.isNaN(r.getTime()))return null;const s=new Date;let a=s.getFullYear()-r.getFullYear();const n=s.getMonth()-r.getMonth();return(n<0||n===0&&s.getDate()<r.getDate())&&(a-=1),a},hg=()=>{const e=rt(),{user:r}=Se(),[s,a]=u.useState(""),[n,i]=u.useState(r?.user_metadata?.user_role),[o,c]=u.useState(!1);u.useEffect(()=>{(async()=>{if(!r?.id)return;const k=r.user_metadata?.user_role||r.user_metadata?.role;if(k){i(k);return}try{const{data:f,error:x}=await R.from("user_profiles").select("role").eq("user_id",r.id).maybeSingle();!x&&f?.role?i(f.role):x&&x.code!=="PGRST116"&&console.error("Ошибка загрузки роли пользователя:",x)}catch(f){console.error("Ошибка загрузки роли пользователя:",f)}})()},[r]),u.useEffect(()=>{(async()=>{if(!r){c(!1);return}try{const k=await zn(r);c(k)}catch(k){console.error("Ошибка проверки прав на создание:",k),c(!1)}})()},[r]);const g=r?.user_metadata?.organization_type,_=n==="org_employee",y=g==="caregiver"||n==="organization"&&g==="caregiver",{data:D=[],isLoading:w,isError:I,error:P,refetch:C}=Xc({queryKey:["dashboard-diaries",r?.id],enabled:!!r,queryFn:async()=>{if(!r)return[];if(console.log("[DashboardPage] Загрузка дневников для пользователя:",{user_id:r.id,userRole:n,organizationType:g,isCaregiver:y}),y){const{data:f,error:x}=await R.from("organizations").select("id, user_id, organization_type").eq("user_id",r.id).eq("organization_type","caregiver").maybeSingle();console.log("[DashboardPage] Данные организации-сиделки:",f,"Ошибка:",x),f&&console.log("[DashboardPage] ID организации-сиделки:",f.id)}const{data:p,error:k}=await R.from("diaries").select(`
            id,
            created_at,
          status,
            caregiver_id,
          organization_id,
          patient_card:patient_card_id (
            id,
            full_name,
            date_of_birth,
            metadata
          )
        `).order("created_at",{ascending:!1});if(k)throw console.error("[DashboardPage] Ошибка загрузки дневников:",k),console.error("[DashboardPage] Детали ошибки:",{message:k.message,details:k.details,hint:k.hint,code:k.code}),k;return console.log("[DashboardPage] Загружено дневников:",p?.length||0),p&&p.length>0?console.log("[DashboardPage] Детали загруженных дневников:",p.map(f=>({id:f.id,caregiver_id:f.caregiver_id,organization_id:f.organization_id,patient_card:f.patient_card}))):(console.log("[DashboardPage] Дневники не загружены. Возможные причины:"),console.log("[DashboardPage] - RLS политики блокируют доступ"),console.log("[DashboardPage] - has_diary_access возвращает false"),console.log("[DashboardPage] - current_organization_id не совпадает с caregiver_id")),p?p.map(mg):[]},retry:1,staleTime:1e3*30}),B=u.useMemo(()=>{const p=s.trim().toLowerCase();return p?D.filter(k=>(k.patient_card?.full_name?.toLowerCase()??"").includes(p)):D},[D,s]),O=()=>{o&&e("/diaries/new")},$=p=>{e(`/diaries/${p}`)};return t.jsxs("div",{className:"min-h-screen bg-gray-100",children:[t.jsxs("div",{className:"max-w-md mx-auto px-4 pt-4 pb-24",children:[t.jsxs("div",{className:"flex items-center justify-between mb-6",children:[t.jsx("h1",{className:"text-2xl font-bold text-gray-dark",children:"Мои дневники"}),t.jsx("button",{onClick:()=>e("/profile"),className:"w-10 h-10 rounded-full flex items-center justify-center hover:opacity-80 transition-opacity flex-shrink-0",children:t.jsx("img",{src:"/icons/Иконка профиль.png",alt:"Профиль",className:"w-10 h-10"})})]}),I&&t.jsxs("div",{className:"rounded-2xl bg-red-50 border border-red-100 px-4 py-3 text-sm text-red-600 mb-6",children:["Не удалось загрузить дневники."," ",t.jsx("button",{onClick:()=>C(),className:"underline font-semibold hover:text-red-700",children:"Повторить попытку"}),t.jsx("pre",{className:"text-xs text-red-400 mt-2 whitespace-pre-wrap break-words",children:String(P?.message??"")})]}),!w&&D.length>0&&!I&&t.jsx("div",{className:"mb-6",children:t.jsx(he,{placeholder:"Поиск по имени подопечного...",value:s,onChange:p=>a(p.target.value),fullWidth:!0})}),w&&t.jsxs("div",{className:"flex items-center justify-center py-12",children:[t.jsx("div",{className:"animate-spin w-8 h-8 border-4 border-blue-primary border-t-transparent rounded-full"}),t.jsx("p",{className:"ml-4 font-manrope text-gray-600",children:"Загрузка дневников..."})]}),!w&&D.length===0&&!I&&t.jsxs("div",{className:"text-center py-8",children:[t.jsx("div",{className:"w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6",style:{background:"linear-gradient(180deg, #7DD3DC 0%, #5CBCC7 100%)"},children:t.jsx("svg",{className:"w-12 h-12 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})})}),t.jsx("h2",{className:"text-xl font-bold text-gray-dark mb-2",children:"У вас пока нет дневников"}),t.jsx("p",{className:"text-sm font-manrope text-gray-600 mb-6",children:y?"Здесь появится дневник здоровья после того, как клиент зарегистрируется и создаст его.":_?"Организация ещё не создала дневники. Как только доступ появится, вы увидите их здесь.":"Создайте первый дневник для подопечного"})]}),!w&&B.length>0&&!I&&t.jsx("div",{className:"space-y-3",children:B.map(p=>t.jsxs("div",{onClick:()=>$(p.id),className:"bg-white rounded-2xl shadow-md p-5 flex items-center justify-between cursor-pointer active:bg-gray-50 transition-colors",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx("h3",{className:"text-lg font-bold text-gray-dark mb-1",children:p.patient_card?.full_name||"Неизвестный"}),t.jsxs("div",{className:"text-sm text-gray-600 space-y-0.5",children:[ho(p.patient_card?.date_of_birth??null)!==null&&t.jsxs("p",{children:["Возраст: ",ho(p.patient_card?.date_of_birth??null)]}),t.jsxs("p",{children:["Адрес: ",p.patient_card?.address||"Адрес не указан"]})]})]}),t.jsx("img",{src:"/icons/иконка маленькая стрелка.png",alt:"",className:"w-5 h-5 ml-4 flex-shrink-0 object-contain"})]},p.id))}),!w&&D.length>0&&B.length===0&&!I&&t.jsx("div",{className:"text-center py-12",children:t.jsxs("p",{className:"font-manrope text-gray-600",children:['Дневники по запросу "',s,'" не найдены']})})]}),!w&&!I&&o&&t.jsx("div",{className:"fixed bottom-0 left-0 right-0 bg-gray-100 p-4 shadow-lg max-w-md mx-auto",children:t.jsx(oe,{onClick:O,fullWidth:!0,children:"+ Создать новый дневник"})})]})},fo=[{value:"admin",label:"Администратор"},{value:"manager",label:"Руководитель"},{value:"caregiver",label:"Сиделка"},{value:"doctor",label:"Врач"}],ts={admin:"Администратор",manager:"Руководитель",caregiver:"Сиделка",doctor:"Врач"},fg={admin:"Создание дневников и карточек подопечных, изменение и заполнение дневников",manager:"Создание дневников и карточек, редактирование, раздача доступа клиентам, управление доступом сотрудников, заполнение дневников",caregiver:"Просмотр и заполнение назначенных дневников",doctor:"Просмотр и заполнение назначенных дневников"},$a=e=>{if(!e)return"Неизвестно";const r=new Date(e);return Number.isNaN(r.getTime())?"Неизвестно":r.toLocaleString("ru-RU",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})},Ma=e=>typeof window>"u"?e:`${window.location.origin}/register?org_token=${e}`,Ta=e=>{if(e==null)return null;const r=String(e);return r==="null"||r==="undefined"||r.trim()===""?null:r},gg=e=>e==="pension"||e==="patronage_agency",pg=()=>{const e=rt(),{user:r}=Se(),[s,a]=u.useState(null),[n,i]=u.useState(!0),[o,c]=u.useState(null),[g,_]=u.useState([]),[y,D]=u.useState([]),[w,I]=u.useState(!1),[P,C]=u.useState(fo[0]?.value??"caregiver"),[B,O]=u.useState(null),[$,p]=u.useState(null),k=u.useCallback(async L=>{if(!L){_([]);return}try{const{data:U,error:Z}=await R.from("organization_employees").select(`
            user_id,
            organization_id,
            first_name,
            last_name,
            phone,
            role,
            created_at,
            organizations!inner (
              organization_type
            )
          `).eq("organization_id",L);if(Z){console.error("Ошибка загрузки сотрудников:",Z),_([]);return}_((U||[]).map(j=>({user_id:j.user_id,organization_id:j.organization_id,organization_type:j.organizations?.organization_type||null,first_name:j.first_name||"",last_name:j.last_name||"",phone:j.phone||null,role:j.role||null,created_at:j.created_at})))}catch(U){console.error("Не удалось загрузить сотрудников:",U),_([])}},[]),f=u.useCallback(async L=>{if(!L){console.log("[EmployeesPage] loadInvites: orgId is null, clearing invites"),D([]);return}console.log("[EmployeesPage] loadInvites: Loading invites for orgId:",L);try{const{data:U,error:Z}=await R.from("invite_tokens").select(`
            id,
            token,
            invite_type,
            created_at,
            expires_at,
            used_at,
            revoked_at,
            organization_invite_tokens (
              organization_id,
              organization_type,
              employee_role
            )
          `).eq("invite_type","organization_employee").is("revoked_at",null).order("created_at",{ascending:!1});if(Z){console.error("[EmployeesPage] Ошибка загрузки приглашений:",Z),D([]);return}console.log("[EmployeesPage] Загружено приглашений (до фильтрации):",U?.length||0,U);const j=(U||[]).map(T=>{const J=Array.isArray(T.organization_invite_tokens)?T.organization_invite_tokens[0]:T.organization_invite_tokens;return{id:T.id,token:T.token,invite_type:T.invite_type,created_at:T.created_at,expires_at:T.expires_at,used_at:T.used_at,revoked_at:T.revoked_at,organization_invite_tokens:J}}).filter(T=>{const J=T.organization_invite_tokens?.organization_id,W=J===L;return W||console.log("[EmployeesPage] Приглашение отфильтровано:",{inviteId:T.id,inviteOrgId:J,expectedOrgId:L}),W});console.log("[EmployeesPage] Отфильтровано приглашений:",j.length);const v=j.filter(T=>!T.used_at),z=j.filter(T=>T.used_at);if(console.log("[EmployeesPage] Активных приглашений:",v.length),console.log("[EmployeesPage] Использованных приглашений:",z.length),z.length>0){const T=z.reduce((J,W)=>J?W.used_at?J.used_at?new Date(W.used_at)>new Date(J.used_at)?W:J:W:J:W,z[0]);p({role:T?.organization_invite_tokens?.employee_role||null,used_at:T?.used_at||null})}D(v)}catch(U){console.error("[EmployeesPage] Не удалось загрузить приглашения:",U),D([])}},[]);u.useEffect(()=>{if(!r){e("/login");return}const L=r.user_metadata?.organization_type??null,U=r.user_metadata?.user_role;if(!gg(L))if(U==="org_employee"){(async()=>{try{const{data:v,error:z}=await R.from("organization_employees").select("role, organization_id").eq("user_id",r.id).maybeSingle();!z&&v&&(v.role==="manager"||v.role==="admin")?console.log("[EmployeesPage] Manager/Admin access granted:",v.role):(e("/dashboard"),i(!1))}catch(v){console.error("[EmployeesPage] Error checking employee role:",v),e("/dashboard"),i(!1)}})();return}else{c("Эта страница доступна только организациям и руководителям."),i(!1);return}(async()=>{if(U==="org_employee"){try{const{data:j,error:v}=await R.from("organization_employees").select("organization_id").eq("user_id",r.id).maybeSingle();if(!v&&j?.organization_id)return console.log("[EmployeesPage] Loaded organization_id from organization_employees:",j.organization_id),j.organization_id}catch(j){console.error("[EmployeesPage] Error loading organization_id from organization_employees:",j)}return null}if(!L)return null;try{const{data:j,error:v}=await R.from("organizations").select("id").eq("user_id",r.id).single();if(v&&v.code==="PGRST116"){const{data:z,error:T}=await R.rpc("create_organization",{p_organization_type:L,p_name:r.user_metadata?.name||r.email||"Организация",p_phone:r.user_metadata?.phone||r.email||"",p_address:r.user_metadata?.address||null});return T?(console.error("Ошибка создания записи организации через RPC:",T),c("Не удалось создать запись организации. Обратитесь в поддержку."),null):(console.log("✅ Организация создана через RPC:",z),z?.id||null)}else{if(v)return console.error("Ошибка проверки организации:",v),null;if(j?.id)return console.log("✅ Организация найдена в БД:",j.id),j.id}}catch(j){return console.error("Ошибка при проверке организации:",j),null}return null})().then(j=>{if(!j){console.warn("[EmployeesPage] Не удалось получить organization_id"),i(!1);return}console.log("[EmployeesPage] Используем organization_id:",j);const v=Ta(j),z=Ta(r.organization_id)||Ta(r.user_metadata?.organization_id),T=v||z;a(T);const J=async()=>{console.log("[EmployeesPage] Загрузка данных для organization_id:",T);try{await Promise.all([k(T),f(T)])}catch(h){console.error("[EmployeesPage] Ошибка при загрузке данных:",h)}finally{i(!1)}};J();const W=setInterval(()=>{console.log("[EmployeesPage] Автоматическое обновление списка сотрудников и приглашений"),J()},3e3);return()=>{clearInterval(W)}}).catch(j=>{console.error("[EmployeesPage] Ошибка при загрузке организации:",j),i(!1)})},[r,e,k,f]),u.useEffect(()=>{if(!$)return;const L=setTimeout(()=>p(null),5e3);return()=>clearTimeout(L)},[$]);const x=async L=>{try{const U=Ma(L);await navigator.clipboard.writeText(U),O(L),setTimeout(()=>O(null),2e3)}catch(U){console.warn("Не удалось скопировать ссылку",U),c("Не удалось скопировать ссылку. Попробуйте ещё раз.")}},F=async L=>{if(!(!L||!window.confirm("Удалить сотрудника и отозвать его доступ?")))try{const{error:Z}=await R.from("organization_employees").delete().eq("user_id",L).eq("organization_id",s);if(Z){console.error("Ошибка удаления сотрудника:",Z),c("Не удалось удалить сотрудника. Попробуйте позже.");return}await k(s)}catch(Z){console.error("Не удалось удалить сотрудника",Z),c("Не удалось удалить сотрудника. Попробуйте позже.")}},H=async L=>{if(window.confirm("Удалить пригласительную ссылку?"))try{const{error:Z}=await R.rpc("revoke_invite_link",{p_invite_id:L});if(Z){console.error("Ошибка отзыва приглашения:",Z),c("Не удалось отозвать приглашение. Попробуйте позже.");return}await f(s)}catch(Z){console.error("Ошибка при отзыве приглашения:",Z),c("Не удалось отозвать приглашение. Попробуйте позже.")}},M=async()=>{if(!s){c("Не удалось определить организацию. Обновите страницу и попробуйте снова.");return}I(!0),c(null);try{const{data:L,error:U}=await R.rpc("generate_invite_link",{invite_type:"organization_employee",payload:{employee_role:P}});if(U){console.error("Ошибка создания приглашения:",U),c(U.message||"Не удалось создать пригласительную ссылку. Попробуйте позже.");return}if(!L||!L.token){c("Не удалось создать пригласительную ссылку. Попробуйте позже.");return}const Z=Ma(L.token);await f(s),O(L.token),await navigator.clipboard.writeText(Z),setTimeout(()=>O(null),2e3)}catch(L){console.error("Не удалось создать пригласительную ссылку",L),c("Не удалось создать пригласительную ссылку. Попробуйте позже.")}finally{I(!1)}};return n?t.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-100",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"animate-spin w-12 h-12 border-4 border-blue-primary border-t-transparent rounded-full mx-auto mb-4"}),t.jsx("p",{className:"text-gray-600",children:"Загрузка сотрудников..."})]})}):o&&!s?t.jsx("div",{className:"min-h-screen flex items-center justify-center px-4 bg-gray-100",children:t.jsxs("div",{className:"max-w-sm text-center",children:[t.jsx("div",{className:"w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4",children:t.jsx("svg",{className:"w-8 h-8 text-red-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),t.jsx("h1",{className:"text-2xl font-bold text-gray-dark mb-3",children:"Нет доступа"}),t.jsx("p",{className:"text-sm text-gray-600 mb-6",children:o}),t.jsx(oe,{onClick:()=>e("/profile"),fullWidth:!0,size:"lg",children:"Вернуться в профиль"})]})}):t.jsxs("div",{className:"min-h-screen bg-gray-100 flex flex-col",children:[t.jsx("header",{className:"bg-white",children:t.jsxs("div",{className:"flex items-center px-4 py-3 relative",children:[t.jsx("button",{onClick:()=>e("/profile"),className:"mr-4 p-2 -ml-2","aria-label":"Назад",children:t.jsx("img",{src:"/icons/Иконка стрелка.png",alt:"Назад",className:"w-6 h-6 object-contain"})}),t.jsx("h1",{className:"absolute left-1/2 transform -translate-x-1/2 text-lg font-bold text-gray-dark",children:"Сотрудники"}),s&&t.jsx("button",{onClick:()=>{i(!0),Promise.all([k(s),f(s)]).finally(()=>i(!1))},className:"ml-auto p-2","aria-label":"Обновить",title:"Обновить список",children:t.jsx("svg",{className:"w-5 h-5 text-gray-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})})})]})}),t.jsxs("main",{className:"flex-1 w-full max-w-md mx-auto px-4 pb-10",children:[o&&s&&t.jsx("div",{className:"bg-red-50 border border-red-200 text-sm text-red-600 rounded-xl p-3 mt-4",children:o}),$&&t.jsxs("div",{className:"mt-4 bg-green-50 border border-green-200 text-sm text-green-700 rounded-xl p-3",children:[t.jsx("p",{className:"font-semibold",children:"Сотрудник успешно зарегистрировался"}),t.jsxs("p",{className:"mt-1 text-xs text-green-600",children:["Роль: ",ts[$.role||""]||"Сотрудник",", время: ",$.used_at?$a($.used_at):"Неизвестно"]})]}),t.jsxs("section",{className:"mt-6 bg-white rounded-2xl shadow-md p-6",children:[t.jsx("h2",{className:"text-xl font-bold text-gray-dark mb-4",children:"Пригласить специалиста"}),t.jsxs("div",{className:"space-y-4",children:[t.jsx(fl,{label:"Выберите роль",fullWidth:!0,value:P,onChange:L=>C(L.target.value),options:fo}),P&&t.jsxs("div",{className:"bg-gray-50 rounded-xl p-3 border border-gray-200",children:[t.jsx("p",{className:"text-xs font-semibold text-gray-700 mb-1",children:ts[P]?`Права ${ts[P].toLowerCase()}:`:"Права доступа:"}),t.jsx("p",{className:"text-xs text-gray-600",children:fg[P]||"Права не определены"})]}),t.jsx(oe,{onClick:M,fullWidth:!0,size:"lg",isLoading:w,disabled:w,children:w?"Создание ссылки...":"Создать пригласительную ссылку"}),t.jsx("p",{className:"text-xs text-gray-500",children:"Ссылка создаётся мгновенно и автоматически копируется. Передайте её сотруднику в удобном мессенджере."})]})]}),t.jsxs("section",{className:"mt-6",children:[t.jsx("h2",{className:"text-lg font-semibold text-gray-dark mb-3",children:"Активные приглашения"}),y.length===0?t.jsx("div",{className:"bg-white rounded-2xl shadow-sm px-4 py-6 text-center text-sm text-gray-500",children:"Активных приглашений нет. Создайте новую ссылку, чтобы пригласить специалиста."}):t.jsx("div",{className:"space-y-4",children:y.map(L=>{const U=L.token,Z=Ma(L.token),j=L.organization_invite_tokens?.employee_role||"";return t.jsx("div",{className:"bg-white rounded-2xl shadow-sm p-4",children:t.jsxs("div",{className:"flex justify-between items-start gap-3",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-semibold text-gray-dark",children:ts[j]||"Сотрудник"}),t.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Создано: ",$a(L.created_at)]}),t.jsx("p",{className:"text-xs text-gray-500 break-all mt-2",children:Z})]}),t.jsxs("div",{className:"flex flex-col gap-2 min-w-[96px]",children:[t.jsx(oe,{size:"sm",onClick:()=>x(U),children:B===U?"Скопировано":"Скопировать"}),t.jsx(oe,{size:"sm",variant:"secondary",onClick:()=>H(L.id),children:"Удалить"})]})]})},L.id)})})]}),t.jsxs("section",{className:"mt-8 pb-4",children:[t.jsx("h2",{className:"text-lg font-semibold text-gray-dark mb-3",children:"Сотрудники"}),g.length===0?t.jsx("div",{className:"bg-white rounded-2xl shadow-sm px-4 py-6 text-center text-sm text-gray-500",children:"Пока нет сотрудников. Отправьте приглашение, чтобы добавить специалиста в команду."}):t.jsx("div",{className:"space-y-4",children:g.map(L=>t.jsx("div",{className:"bg-white rounded-2xl shadow-md p-4",children:t.jsxs("div",{className:"flex justify-between gap-3",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-semibold text-gray-dark",children:L.first_name||L.last_name?`${L.first_name??""} ${L.last_name??""}`.trim():"Без имени"}),t.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Роль: ",ts[L.role||""]||"Сотрудник организации"]}),L.phone&&t.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Телефон: ",L.phone]}),t.jsxs("p",{className:"text-xs text-gray-400 mt-1",children:["В организации: ",$a(L.created_at)]})]}),t.jsx(oe,{size:"sm",variant:"secondary",onClick:()=>F(L.user_id),children:"Удалить"})]})},L.user_id))})]})]})]})},xg=()=>{const e=rt(),{user:r}=Se(),[s,a]=u.useState([]),[n,i]=u.useState(!0);u.useEffect(()=>{if(!r){e("/login");return}(async()=>{try{i(!0);let C=R.from("patient_cards").select("id, client_id, full_name, date_of_birth, gender, diagnoses, mobility, metadata, created_at");const{data:B,error:O}=await C.order("created_at",{ascending:!1});if(O){console.error("Error loading patient cards from Supabase:",O),a([]);return}const $=(B||[]).map(p=>({id:p.id,client_id:p.client_id,full_name:p.full_name,date_of_birth:p.date_of_birth,address:p.metadata?.address||null,gender:p.gender||"male",diagnoses:Array.isArray(p.diagnoses)?p.diagnoses:[],mobility:p.mobility||"walks",metadata:p.metadata}));a($)}catch(C){console.error("Error loading patient cards:",C),a([])}finally{i(!1)}})()},[r,e]);const[o,c]=u.useState(!1),[g,_]=u.useState(!1);u.useEffect(()=>{(async()=>{if(!r){c(!1),_(!1);return}try{const[C,B]=await Promise.all([zn(r),En(r)]);c(C),_(B)}catch(C){console.error("Ошибка проверки прав доступа:",C),c(!1),_(!1)}})()},[r]);const y=()=>o,D=()=>g,w=P=>{if(!P)return null;const C=new Date(P),B=new Date;let O=B.getFullYear()-C.getFullYear();const $=B.getMonth()-C.getMonth();return($<0||$===0&&B.getDate()<C.getDate())&&O--,O};if(n)return t.jsx("div",{className:"min-h-screen bg-gray-100 flex items-center justify-center",children:t.jsx("p",{className:"text-gray-600",children:"Загрузка..."})});const I=y();return t.jsxs("div",{className:"min-h-screen bg-gray-100 pb-32",children:[t.jsx("header",{className:"bg-white shadow-sm",children:t.jsxs("div",{className:"flex items-center px-4 py-3",children:[t.jsx("button",{onClick:()=>e("/profile"),className:"flex items-center justify-center w-6 h-6 mr-3","aria-label":"Назад",children:t.jsx("img",{src:"/icons/Иконка стрелка.png",alt:"Назад",className:"w-full h-full object-contain"})}),t.jsx("h1",{className:"text-lg font-bold text-[#4A4A4A]",children:"Карточки подопечных"})]})}),t.jsx("div",{className:"px-4 py-6 max-w-md mx-auto",children:s.length===0?t.jsx("div",{className:"flex flex-col items-center justify-center min-h-[60vh]",children:t.jsx("p",{className:"text-center text-gray-600 px-8 mb-8 leading-relaxed",children:I?"Для доступа к дневнику подопечного, сначала заполните карточку подопечного по кнопке ниже":"Карточки подопечных пока не назначены. Обратитесь к администратору или клиенту, чтобы получить доступ."})}):t.jsx("div",{className:"space-y-4",children:s.map(P=>{const C=w(P.date_of_birth);return t.jsxs("button",{onClick:()=>{D()?e(`/profile/patient-cards/edit?id=${P.id}`):e(`/profile/patient-cards/view?id=${P.id}&mode=view`)},className:"w-full bg-white rounded-2xl p-5 shadow-sm hover:shadow-md transition-shadow flex items-center justify-between min-h-[100px]",children:[t.jsxs("div",{className:"text-left flex-1",children:[t.jsx("h3",{className:"text-lg font-bold text-[#4A4A4A] mb-1",children:P.full_name}),C&&t.jsxs("p",{className:"text-sm text-gray-500 mb-0.5",children:["Возраст: ",C]}),P.address&&t.jsxs("p",{className:"text-sm text-gray-500",children:["Адрес: ",P.address]})]}),t.jsx("img",{src:"/icons/иконка маленькая стрелка.png",alt:"",className:"w-4 h-4"})]},P.id)})})}),I&&t.jsx("div",{className:"fixed bottom-0 left-0 right-0 p-4 max-w-md mx-auto",children:t.jsx("button",{onClick:()=>e("/profile/patient-cards/new"),className:"w-full bg-gradient-to-r from-[#7DD3DC] to-[#5CBCC7] text-white font-bold py-4 rounded-full shadow-lg",children:s.length===0?"+ Добавить карточку":"Создать новую карточку"})})]})},cn=["male","female"],dn=["walks","sits","lies"],yg=bt({full_name:ke().min(1,"Введите ФИО"),date_of_birth:ke().optional(),address:ke().optional(),entrance:ke().optional(),apartment:ke().optional(),gender:on(cn),has_pets:df(),diagnoses:Js(ke()),mobility:on(dn),services:Js(ke()),service_wishes:Js(ke())}),Ra=["Деменция","Паркинсон","Альцгеймер","Инсульт","Инфаркт","Перелом шейки бедра"],Fa=["Растирание конечностей","Развивающие игры","Интересный досуг","Напоминать о приеме лекарств","Помощь в кормлении","Мерять давление","Уборка","Стирка","Уколы","Капельницы","Лечение пролежней","Перевязки"],Oa=()=>{const e=rt(),[r]=Tr(),{user:s}=Se(),a=r.get("id"),n=r.get("mode")||"edit",i=!!a,o=n==="view",[c,g]=u.useState(null),[_,y]=u.useState(""),[D,w]=u.useState(""),[I,P]=u.useState(""),[C,B]=u.useState(!1),O=s?.user_metadata?.role||s?.user_metadata?.user_role||null,$=s?.user_metadata?.organization_type||null,p=O==="client",k=$==="pension",[f,x]=u.useState(!1),[F,H]=u.useState(!0);u.useEffect(()=>{(async()=>{if(o){x(!1),H(!1);return}try{const S=await En(s);x(S)}catch(S){console.error("Ошибка проверки прав доступа:",S),x(!1)}finally{H(!1)}})()},[s,o]);const M=()=>f,{register:L,handleSubmit:U,formState:{errors:Z,isSubmitting:j},setValue:v,watch:z,reset:T,getValues:J}=xt({resolver:yt(yg),defaultValues:{full_name:"",date_of_birth:"",address:"",entrance:"",apartment:"",diagnoses:[],services:[],service_wishes:[],gender:"male",has_pets:!1,mobility:"walks"}}),W=a?`patient_card_draft_${s?.id||"anonymous"}_${a}`:`patient_card_draft_${s?.id||"anonymous"}_new`,h=z("diagnoses")??[],A=z("services")??[],Y=z("service_wishes")??[],ee=z("gender")??cn[0],ae=z("has_pets")??!1,ne=z("mobility")??dn[0],b=m=>(m??[]).filter(S=>typeof S=="string"&&S.trim().length>0),Q=m=>({full_name:m.full_name??"",date_of_birth:m.date_of_birth??"",address:m.address??"",entrance:m.entrance??"",apartment:m.apartment??"",gender:m.gender??cn[0],has_pets:m.has_pets??!1,diagnoses:b(m.diagnoses),services:b(m.services),service_wishes:b(m.service_wishes),mobility:m.mobility??dn[0]});u.useEffect(()=>{(async()=>{let S={};if(i&&a)try{console.log("PatientCardFormPage: Loading card data for edit mode, cardId:",a);const{data:V,error:le}=await R.from("patient_cards").select("*").eq("id",a).single();if(le){console.error("PatientCardFormPage: Error loading card from Supabase:",le),alert("Ошибка загрузки карточки: "+le.message);return}if(V){console.log("PatientCardFormPage: Card loaded successfully:",V);const se=V.metadata||{};S={full_name:V.full_name||"",date_of_birth:V.date_of_birth||"",address:se.address||"",entrance:se.entrance||"",apartment:se.apartment||"",gender:V.gender||"male",has_pets:se.has_pets||!1,diagnoses:Array.isArray(V.diagnoses)?V.diagnoses:[],services:Array.isArray(se.services)?se.services:[],service_wishes:Array.isArray(se.service_wishes)?se.service_wishes:[],mobility:V.mobility||"walks"},console.log("PatientCardFormPage: Initial values prepared:",S)}}catch(V){console.error("PatientCardFormPage: Error loading patient card from Supabase:",V),alert("Ошибка загрузки карточки");return}if(!i){const V=localStorage.getItem(W);if(V)try{const le=JSON.parse(V);S={...S,...le},console.log("PatientCardFormPage: Loaded draft from localStorage")}catch(le){console.warn("PatientCardFormPage: Не удалось загрузить черновик карточки",le)}}console.log("PatientCardFormPage: Resetting form with values:",S),T(Q(S))})()},[i,a,T,W]),u.useEffect(()=>{const m=z(S=>{localStorage.setItem(W,JSON.stringify(Q(S)))});return()=>m.unsubscribe()},[z,W]),u.useEffect(()=>{k&&v("has_pets",!1,{shouldValidate:!0})},[k,v]);const E=m=>{const S=h;S.includes(m)?v("diagnoses",S.filter(V=>V!==m)):v("diagnoses",[...S,m])},fe=m=>{const S=A;S.includes(m)?v("services",S.filter(V=>V!==m),{shouldDirty:!0,shouldTouch:!0,shouldValidate:!0}):v("services",[...S,m],{shouldDirty:!0,shouldTouch:!0,shouldValidate:!0})},ye=()=>{_.trim()&&!h.includes(_.trim())&&(v("diagnoses",[...h,_.trim()],{shouldDirty:!0,shouldTouch:!0,shouldValidate:!0}),y(""))},ce=()=>{D.trim()&&!A.includes(D.trim())&&(v("services",[...A,D.trim()],{shouldDirty:!0,shouldTouch:!0,shouldValidate:!0}),w(""))},me=()=>{I.trim()&&!Y.includes(I.trim())&&(v("service_wishes",[...Y,I.trim()],{shouldDirty:!0,shouldTouch:!0,shouldValidate:!0}),P(""))},_e=m=>{v("diagnoses",h.filter(S=>S!==m),{shouldDirty:!0,shouldTouch:!0,shouldValidate:!0})},De=m=>{v("services",A.filter(S=>S!==m),{shouldDirty:!0,shouldTouch:!0,shouldValidate:!0})},xe=m=>{v("service_wishes",Y.filter(S=>S!==m),{shouldDirty:!0,shouldTouch:!0,shouldValidate:!0})},Ee=async()=>{if(!s)return null;if((s.user_metadata?.role||s.user_metadata?.user_role)==="client")try{const{data:S,error:V}=await R.from("clients").select("id").eq("user_id",s.id).single();if(!V&&S)return S.id}catch(S){console.error("Error resolving client_id:",S)}return($==="pension"||$==="patronage_agency")&&console.log("PatientCardFormPage: Organization creating card without client_id (will be set when client registers)"),null},Ae=()=>{if(!M())return;const m=Q(J());localStorage.setItem(W,JSON.stringify(m))},kt=async m=>{if(console.log("PatientCardFormPage: onSubmit called",{canEdit:M(),user:s?.id,userRole:O,isEditMode:i,cardId:a}),!M()||!s){console.log("PatientCardFormPage: Cannot edit or no user");return}_.trim()&&!h.includes(_.trim())&&ye(),D.trim()&&!A.includes(D.trim())&&ce(),I.trim()&&!Y.includes(I.trim())&&me(),await new Promise(S=>setTimeout(S,100)),m.diagnoses=z("diagnoses"),m.services=z("services"),m.service_wishes=z("service_wishes");try{let S=null;if(i&&a){console.log("PatientCardFormPage: Edit mode, loading existing card");const{data:se,error:ie}=await R.from("patient_cards").select("client_id").eq("id",a).single();if(ie){console.error("PatientCardFormPage: Error loading existing card:",ie),alert("Ошибка при загрузке карточки: "+ie.message);return}se&&(S=se.client_id,console.log("PatientCardFormPage: Found client_id from existing card:",S))}else console.log("PatientCardFormPage: Create mode, resolving client_id"),S=await Ee(),console.log("PatientCardFormPage: Resolved client_id:",S);if(!S&&O==="client"){console.error("PatientCardFormPage: client_id is null for client user",{userRole:O,organizationType:$,isEditMode:i}),alert("Не удалось определить клиента. Пожалуйста, войдите в систему заново.");return}!S&&($==="pension"||$==="patronage_agency")&&console.log("PatientCardFormPage: Creating card without client_id (organization will invite client later)");const V={};k?V.has_pets=!1:(m.address&&(V.address=m.address),m.entrance&&(V.entrance=m.entrance),m.apartment&&(V.apartment=m.apartment),V.has_pets=m.has_pets||!1),m.services&&m.services.length>0&&(V.services=m.services),m.service_wishes&&m.service_wishes.length>0&&(V.service_wishes=m.service_wishes);const le={client_id:S,full_name:m.full_name,date_of_birth:m.date_of_birth||null,gender:m.gender,diagnoses:m.diagnoses||[],mobility:m.mobility,metadata:Object.keys(V).length>0?V:null,created_by:s.id};if(i&&a){const{error:se}=await R.from("patient_cards").update(le).eq("id",a);if(se){console.error("Error updating patient card:",se),alert("Ошибка при обновлении карточки: "+se.message);return}}else{const{error:se}=await R.from("patient_cards").insert(le);if(se){console.error("Error creating patient card:",se),alert("Ошибка при создании карточки: "+se.message);return}}localStorage.removeItem(W),e("/profile/patient-cards")}catch(S){console.error("Error saving patient card:",S),alert("Ошибка при сохранении карточки")}},Fr=async()=>{if(!(!a||!confirm("Вы уверены, что хотите удалить эту карточку?"))){B(!0);try{const{error:m}=await R.from("patient_cards").delete().eq("id",a);if(m){console.error("Error deleting patient card:",m),alert("Ошибка при удалении карточки: "+m.message);return}localStorage.removeItem(W),e("/profile/patient-cards")}catch(m){console.error("Error deleting patient card:",m),alert("Ошибка при удалении карточки")}finally{B(!1)}}},At=m=>{c===m?(m==="diagnoses"&&_.trim()&&!h.includes(_.trim())&&ye(),m==="services"&&(D.trim()&&!A.includes(D.trim())&&ce(),I.trim()&&!Y.includes(I.trim())&&me()),Ae(),g(null)):g(m)};return t.jsxs("div",{className:"min-h-screen bg-gray-100 pb-32",children:[t.jsx("header",{className:"bg-white shadow-sm",children:t.jsxs("div",{className:"flex items-center px-4 py-3",children:[t.jsx("button",{onClick:()=>e("/profile/patient-cards"),className:"flex items-center justify-center w-6 h-6 mr-3","aria-label":"Назад",children:t.jsx("img",{src:"/icons/Иконка стрелка.png",alt:"Назад",className:"w-full h-full object-contain"})}),t.jsx("h1",{className:"text-lg font-bold text-[#4A4A4A]",children:o?"Просмотр карточки":i?"Редактировать карточку":"Новая карточка пациента"})]})}),t.jsxs("div",{className:"px-4 py-6 max-w-md mx-auto",children:[t.jsxs("h2",{className:"text-2xl font-bold text-[#4A4A4A] text-center mb-8",children:["Заполните данные",t.jsx("br",{}),"пациента"]}),t.jsxs("form",{id:"patient-card-form",onSubmit:m=>{U(kt)(m)},className:"space-y-4",children:[t.jsxs("div",{className:"bg-gradient-to-br from-[#A0E7E5] to-[#7DD3DC] rounded-3xl overflow-hidden",children:[t.jsxs("button",{type:"button",onClick:()=>At("personal"),className:"w-full px-6 py-5",children:[t.jsx("h3",{className:"text-xl font-bold mb-1 text-[#4A4A4A]",children:"Личные данные"}),c!=="personal"&&t.jsx("p",{className:"text-sm mb-3 text-[#4A4A4A]",children:"ФИО, дата рождения, адрес, пол, животные"}),t.jsx("div",{className:"flex justify-center",children:t.jsx("img",{src:"/icons/иконка маленькая стрелка.png",alt:"",className:`w-4 h-4 transition-transform duration-200 ${c==="personal"?"-rotate-90":"rotate-90"}`,style:{filter:"brightness(0) saturate(100%) invert(29%) sepia(0%) saturate(0%) hue-rotate(174deg) brightness(95%) contrast(88%)"}})})]}),c==="personal"&&t.jsxs("div",{className:"px-6 pb-6 space-y-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"text-sm font-semibold text-[#4A4A4A] mb-2 block",children:"ФИО пациента"}),t.jsx(he,{placeholder:"Введите ФИО пациента",...L("full_name"),error:Z.full_name?.message,className:"bg-white",disabled:!M()})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-sm font-semibold text-[#4A4A4A] mb-2 block",children:"Дата рождения пациента"}),t.jsx(he,{placeholder:"Введите дату рождения пациента",type:"date",...L("date_of_birth"),className:"bg-white",disabled:!M()})]}),!k&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{children:[t.jsx("label",{className:"text-sm font-semibold text-[#4A4A4A] mb-2 block",children:"Адрес пациента"}),t.jsx(he,{placeholder:"Введите адрес пациента",...L("address"),className:"bg-white",disabled:!M()})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"text-sm font-semibold text-[#4A4A4A] mb-2 block",children:"Подъезд"}),t.jsx(he,{placeholder:"№ подъезда",...L("entrance"),className:"bg-white",disabled:!M()})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-sm font-semibold text-[#4A4A4A] mb-2 block",children:"Квартира"}),t.jsx(he,{placeholder:"№ квартиры",...L("apartment"),className:"bg-white",disabled:!M()})]})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-sm font-semibold text-[#4A4A4A] mb-2 block",children:"Выберите пол пациента"}),t.jsxs("div",{className:"flex gap-3",children:[t.jsx("button",{type:"button",onClick:()=>M()&&v("gender","male"),disabled:!M(),className:`flex-1 py-3 rounded-2xl text-sm font-bold transition-all ${ee==="male"?"bg-[#4A9BAD] text-white":"bg-white text-[#4A4A4A]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:"Мужской"}),t.jsx("button",{type:"button",onClick:()=>M()&&v("gender","female"),disabled:!M(),className:`flex-1 py-3 rounded-2xl text-sm font-bold transition-all ${ee==="female"?"bg-[#4A9BAD] text-white":"bg-white text-[#4A4A4A]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:"Женский"})]})]}),!k&&t.jsxs("div",{children:[t.jsx("label",{className:"text-sm font-semibold text-[#4A4A4A] mb-2 block",children:"Есть ли домашние животные?"}),t.jsxs("div",{className:"flex gap-3",children:[t.jsx("button",{type:"button",onClick:()=>{M()&&v("has_pets",!1)},disabled:!M(),className:`flex-1 py-3 rounded-2xl text-sm font-bold transition-all ${ae===!1?"bg-[#4A9BAD] text-white":"bg-white text-[#4A4A4A]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:"Нет"}),t.jsx("button",{type:"button",onClick:()=>{M()&&v("has_pets",!0)},disabled:!M(),className:`flex-1 py-3 rounded-2xl text-sm font-bold transition-all ${ae===!0?"bg-[#4A9BAD] text-white":"bg-white text-[#4A4A4A]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:"Да"})]})]}),M()&&t.jsx(oe,{type:"button",onClick:()=>At("personal"),className:"w-full !bg-[#4A9BAD] !text-white font-bold",children:"Готово"})]})]}),t.jsxs("div",{className:"bg-gradient-to-br from-[#5CBCC7] to-[#3D8A9C] rounded-3xl overflow-hidden",children:[t.jsxs("button",{type:"button",onClick:()=>At("diagnoses"),className:"w-full px-6 py-5 text-white",children:[t.jsx("h3",{className:"text-xl font-bold mb-1",children:"Болезни"}),c!=="diagnoses"&&t.jsx("p",{className:"text-sm opacity-90 mb-3",children:"Деменция, паркинсон, инсульт, инфаркт и т.д."}),t.jsx("div",{className:"flex justify-center",children:t.jsx("img",{src:"/icons/иконка маленькая стрелка.png",alt:"",className:`w-4 h-4 filter brightness-0 invert transition-transform duration-200 ${c==="diagnoses"?"-rotate-90":"rotate-90"}`})})]}),c==="diagnoses"&&t.jsxs("div",{className:"px-6 pb-6 space-y-4",children:[M()&&t.jsx("p",{className:"text-sm text-white font-semibold",children:"Выберите болезни, если есть"}),t.jsx("div",{className:"flex flex-wrap gap-2",children:Ra.map(m=>t.jsx("button",{type:"button",onClick:()=>M()&&E(m),disabled:!M(),className:`px-4 py-2 rounded-2xl text-sm font-bold transition-all ${h.includes(m)?"bg-[#A0D9E3] text-[#4A4A4A]":"bg-white text-[#4A4A4A]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:m},m))}),h.filter(m=>!Ra.includes(m)).length>0&&t.jsxs("div",{className:"space-y-2",children:[t.jsx("p",{className:"text-sm text-white font-semibold",children:"Добавленные болезни:"}),h.filter(m=>!Ra.includes(m)).map(m=>t.jsxs("div",{className:"flex items-center justify-between bg-white/20 rounded-2xl px-4 py-2",children:[t.jsx("span",{className:"text-white font-medium text-sm",children:m}),M()&&t.jsx("button",{type:"button",onClick:()=>_e(m),className:"text-white hover:text-red-300 ml-2",children:t.jsx("span",{className:"text-lg",children:"🗑"})})]},m))]}),M()&&t.jsxs("div",{className:"flex gap-2",children:[t.jsx(he,{value:_,onChange:m=>y(m.target.value),placeholder:"Добавить болезнь не из списка",className:"flex-1 bg-white"}),t.jsx(oe,{type:"button",onClick:ye,className:"!bg-[#A0D9E3] !text-[#4A4A4A] !px-8 !py-3 !text-2xl !font-bold !min-w-[60px]",children:"+"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-sm font-semibold text-white mb-2 block",children:"Мобильность"}),t.jsx("div",{className:"flex gap-2",children:[{value:"walks",label:"Ходит"},{value:"sits",label:"Сидит"},{value:"lies",label:"Лежит"}].map(m=>t.jsx("button",{type:"button",onClick:()=>{M()&&v("mobility",m.value,{shouldDirty:!0,shouldTouch:!0,shouldValidate:!0})},disabled:!M(),className:`flex-1 py-2 rounded-2xl text-sm font-bold transition-all ${ne===m.value?"bg-[#A0D9E3] text-[#4A4A4A]":"bg-white text-[#4A4A4A]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:m.label},m.value))})]}),M()&&t.jsx(oe,{type:"button",onClick:()=>At("diagnoses"),className:"w-full !bg-[#A0D9E3] !text-[#4A4A4A] font-bold",children:"Готово"})]})]}),t.jsxs("div",{className:"bg-gradient-to-br from-[#3D8A9C] to-[#2A6B7A] rounded-3xl overflow-hidden",children:[t.jsxs("button",{type:"button",onClick:()=>At("services"),className:"w-full px-6 py-5 text-white",children:[t.jsx("h3",{className:"text-xl font-bold mb-1",children:"Требуемые услуги"}),c!=="services"&&t.jsx("p",{className:"text-sm opacity-90 mb-3",children:"Уколы, стирка, уборка, мерять давление и т.д."}),t.jsx("div",{className:"flex justify-center",children:t.jsx("img",{src:"/icons/иконка маленькая стрелка.png",alt:"",className:`w-4 h-4 filter brightness-0 invert transition-transform duration-200 ${c==="services"?"-rotate-90":"rotate-90"}`})})]}),c==="services"&&t.jsxs("div",{className:"px-6 pb-6 space-y-4",children:[t.jsx("div",{className:"flex flex-wrap gap-2",children:Fa.map(m=>t.jsx("button",{type:"button",onClick:()=>M()&&fe(m),disabled:!M(),className:`px-4 py-2 rounded-2xl text-sm font-bold transition-all ${A.includes(m)?"bg-[#A0D9E3] text-[#4A4A4A]":"bg-white text-[#4A4A4A]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:m},m))}),A.filter(m=>!Fa.includes(m)).length>0&&t.jsxs("div",{className:"space-y-2",children:[t.jsx("p",{className:"text-sm text-white font-semibold",children:"Добавленные услуги:"}),A.filter(m=>!Fa.includes(m)).map(m=>t.jsxs("div",{className:"flex items-center justify-between bg-white/20 rounded-2xl px-4 py-2",children:[t.jsx("span",{className:"text-white font-medium text-sm",children:m}),M()&&t.jsx("button",{type:"button",onClick:()=>De(m),className:"text-white hover:text-red-300 ml-2",children:t.jsx("span",{className:"text-lg",children:"🗑"})})]},m))]}),Y.length>0&&t.jsxs("div",{className:"space-y-2",children:[t.jsx("p",{className:"text-sm text-white font-semibold",children:"Добавленные пожелания:"}),Y.map(m=>t.jsxs("div",{className:"flex items-center justify-between bg-white/20 rounded-2xl px-4 py-2",children:[t.jsx("span",{className:"text-white font-medium text-sm",children:m}),M()&&t.jsx("button",{type:"button",onClick:()=>xe(m),className:"text-white hover:text-red-300 ml-2",children:t.jsx("span",{className:"text-lg",children:"🗑"})})]},m))]}),M()&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"flex gap-2",children:[t.jsx(he,{value:D,onChange:m=>w(m.target.value),placeholder:"Добавить свою услугу",className:"flex-1 bg-white"}),t.jsx(oe,{type:"button",onClick:ce,className:"!bg-[#A0D9E3] !text-[#4A4A4A] !px-8 !py-3 !text-2xl !font-bold !min-w-[60px]",children:"+"})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(he,{value:I,onChange:m=>P(m.target.value),placeholder:"Добавить пожелание",className:"flex-1 bg-white"}),t.jsx(oe,{type:"button",onClick:me,className:"!bg-[#A0D9E3] !text-[#4A4A4A] !px-8 !py-3 !text-2xl !font-bold !min-w-[60px]",children:"+"})]}),t.jsx(oe,{type:"button",onClick:()=>At("services"),className:"w-full !bg-[#A0D9E3] !text-[#4A4A4A] font-bold",children:"Готово"})]})]})]})]})]}),t.jsx("div",{className:"fixed bottom-0 left-0 right-0 bg-[#F3F4F6] pb-6 pt-4 px-4 z-10",children:t.jsxs("div",{className:"max-w-md mx-auto",children:[t.jsx(oe,{type:"button",onClick:()=>{console.log("=== Кнопка Сохранить нажата ==="),console.log("errors:",Z),console.log("isSubmitting:",j),console.log("canEdit():",M()),U(m=>(console.log("Валидация прошла успешно"),kt(m)),m=>{console.log("Ошибки валидации:",m);const S=[];m.full_name&&S.push("ФИО пациента"),m.gender&&S.push("Пол пациента"),m.mobility&&S.push("Мобильность"),m.has_pets&&S.push("Наличие животных"),m.address&&S.push("Адрес"),m.entrance&&S.push("Подъезд"),m.apartment&&S.push("Квартира"),alert(`Пожалуйста, заполните обязательные поля:

`+S.join(`
`))})()},disabled:j||!M(),className:"w-full !bg-gradient-to-r !from-[#7DD3DC] !to-[#5CBCC7] !text-white font-bold py-3.5 !rounded-3xl",children:j?"Сохранение...":"Сохранить"}),M()&&i&&!p&&t.jsx("button",{onClick:Fr,disabled:C,className:"w-full mt-4 text-sm font-semibold text-[#4A4A4A] disabled:opacity-50",children:C?"Удаление...":"Отвязать карточку"})]})})]})},bg=()=>{const e=rt(),{user:r}=Se(),[s,a]=u.useState([]),[n,i]=u.useState(!0);return u.useEffect(()=>{(async()=>{if(!r){e("/login");return}try{let c=null;try{const y=new Promise((P,C)=>setTimeout(()=>C(new Error("Timeout")),2e3)),D=R.from("organizations").select("id").eq("user_id",r.id).single(),{data:w,error:I}=await Promise.race([D,y]);if(!I&&w)c=w.id;else{console.log("Organization not found or timeout, using localStorage"),i(!1);return}}catch{console.log("DB query timeout or error, using localStorage"),i(!1);return}const{data:g,error:_}=await R.from("clients").select("id, first_name, last_name, phone, created_at, user_id").eq("invited_by_organization_id",c).order("created_at",{ascending:!1});if(_)console.error("Ошибка загрузки клиентов:",_),a([]);else{const y=(g||[]).map(D=>({id:D.id,first_name:D.first_name||"",last_name:D.last_name||"",phone:D.phone||"",created_at:D.created_at}));a(y),console.log("[ClientsPage] Загружено клиентов:",y.length)}}catch(c){console.error("Error loading clients:",c)}finally{i(!1)}})()},[r,e]),n?t.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-100",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"animate-spin w-12 h-12 border-4 border-blue-primary border-t-transparent rounded-full mx-auto mb-4"}),t.jsx("p",{className:"text-gray-600",children:"Загрузка клиентов..."})]})}):t.jsxs("div",{className:"min-h-screen bg-gray-100 flex flex-col",children:[t.jsx("header",{className:"bg-white",children:t.jsxs("div",{className:"flex items-center px-4 py-3 relative",children:[t.jsx("button",{onClick:()=>e("/profile"),className:"mr-4 p-2 -ml-2","aria-label":"Назад",children:t.jsx("img",{src:"/icons/Иконка стрелка.png",alt:"Назад",className:"w-6 h-6 object-contain"})}),t.jsx("h1",{className:"absolute left-1/2 transform -translate-x-1/2 text-lg font-bold text-gray-dark",children:"Клиенты"})]})}),t.jsx("div",{className:"flex-1 max-w-md mx-auto w-full px-4 pb-8",children:t.jsx("div",{className:"mt-6",children:s.length===0?t.jsxs("div",{className:"bg-white rounded-2xl shadow-md p-8 text-center",children:[t.jsx("p",{className:"text-gray-600 mb-4",children:"Список клиентов пуст"}),t.jsx("p",{className:"text-sm text-gray-500",children:"Клиенты появятся здесь после того, как они зарегистрируются по вашей пригласительной ссылке"})]}):t.jsx("div",{className:"space-y-4",children:s.map(o=>{const c=o.created_at?new Date(o.created_at).toLocaleDateString("ru-RU",{year:"numeric",month:"long",day:"numeric"}):null;return t.jsx("div",{className:"bg-white rounded-2xl shadow-md p-5",children:t.jsx("div",{className:"flex items-center justify-between",children:t.jsxs("div",{className:"flex-1",children:[t.jsxs("p",{className:"text-lg font-bold text-gray-dark mb-1",children:[o.first_name," ",o.last_name]}),o.phone&&t.jsx("p",{className:"text-xs font-manrope text-gray-500 mb-1",children:o.phone}),c&&t.jsxs("p",{className:"text-xs font-manrope text-gray-400",children:["Зарегистрирован: ",c]})]})})},o.id)})})})})]})},_g=()=>{const e=rt(),{user:r}=Se(),[s,a]=u.useState(null),[n,i]=u.useState(!1),[o,c]=u.useState(!1),[g,_]=u.useState(!1);u.useEffect(()=>{if(!r){e("/login");return}if(r.user_metadata?.organization_type!=="caregiver"){e("/profile");return}},[r,e]);const y=async()=>{if(r){i(!0);try{const{data:P,error:C}=await R.from("organizations").select("id").eq("user_id",r.id).eq("organization_type","caregiver").single();if(C&&C.code==="PGRST116"){console.log("InviteClientPage: Организация не найдена, создаем через RPC");const{data:p,error:k}=await R.rpc("create_organization",{p_organization_type:"caregiver",p_name:`${r.user_metadata?.firstName||""} ${r.user_metadata?.lastName||""}`.trim()||r.email||"Сиделка",p_phone:r.user_metadata?.phone||r.email||"",p_address:null});if(k){console.error("Ошибка создания организации через RPC:",k),alert("Не удалось создать запись организации. Обратитесь в поддержку."),i(!1);return}console.log("✅ Организация создана через RPC:",p)}else if(C){console.error("Ошибка проверки организации:",C),alert("Ошибка при проверке организации. Попробуйте позже."),i(!1);return}const{data:B,error:O}=await R.rpc("generate_invite_link",{invite_type:"caregiver_client",payload:{}});if(O||!B){console.error("Error creating invite token via RPC:",O),alert(O?.message||"Ошибка при создании ссылки. Попробуйте позже."),i(!1);return}const $=`${window.location.origin}/client-invite?token=${B.token}`;a($),console.log("✅ Пригласительная ссылка создана:",$)}catch(P){console.error("Error creating invite link:",P),alert("Ошибка при создании ссылки. Попробуйте позже.")}finally{i(!1)}}},D=async()=>{if(s)try{await navigator.clipboard.writeText(s),c(!0),setTimeout(()=>c(!1),2e3)}catch(P){console.error("Error copying to clipboard:",P),alert("Не удалось скопировать ссылку")}},w=()=>`Приглашаю вас в удобную систему для отслеживания здоровья вашего родственника! ${s}`,I=P=>{if(!s)return;const C=w();let B="";switch(P){case"whatsapp":B=`https://wa.me/?text=${encodeURIComponent(C)}`;break;case"telegram":B=`https://t.me/share/url?url=${encodeURIComponent(s)}&text=${encodeURIComponent(C)}`;break;case"max":B=`https://web.max.ru/share?text=${encodeURIComponent(C)}`;break}B&&(window.open(B,"_blank"),_(!1))};return t.jsxs("div",{className:"min-h-screen bg-gray-100 flex flex-col",children:[t.jsx("header",{className:"bg-white",children:t.jsxs("div",{className:"flex items-center px-4 py-3 relative",children:[t.jsx("button",{onClick:()=>e("/profile"),className:"mr-4 p-2 -ml-2","aria-label":"Назад",children:t.jsx("img",{src:"/icons/Иконка стрелка.png",alt:"Назад",className:"w-6 h-6 object-contain"})}),t.jsx("h1",{className:"absolute left-1/2 transform -translate-x-1/2 text-lg font-bold text-gray-dark",children:"Пригласить клиента"})]})}),t.jsx("div",{className:"flex-1 max-w-md mx-auto w-full px-4 pb-8",children:t.jsx("div",{className:"mt-6",children:t.jsxs("div",{className:"bg-white rounded-2xl shadow-md p-6",children:[t.jsx("h2",{className:"text-xl font-bold text-gray-dark mb-4",children:"Создать пригласительную ссылку"}),t.jsx("p",{className:"text-sm text-gray-600 mb-6",children:"Создайте ссылку для приглашения клиента. Клиент сможет зарегистрироваться и создать карточку подопечного."}),s?t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"bg-gray-50 rounded-xl p-4",children:[t.jsx("p",{className:"text-xs font-manrope text-gray-500 mb-2",children:"Пригласительная ссылка:"}),t.jsx("p",{className:"text-sm font-mono text-gray-800 break-all",children:s})]}),t.jsxs("div",{className:"space-y-3",children:[t.jsx(oe,{onClick:D,variant:"outline",fullWidth:!0,children:o?"Скопировано!":"Копировать ссылку"}),t.jsx(oe,{onClick:()=>_(!0),fullWidth:!0,children:"Поделиться в мессенджере"})]}),t.jsx(oe,{onClick:()=>{a(null),c(!1)},variant:"outline",fullWidth:!0,children:"Создать новую ссылку"})]}):t.jsx(oe,{onClick:y,disabled:n,fullWidth:!0,size:"lg",children:n?"Создание ссылки...":"Создать ссылку"})]})})}),g&&t.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",onClick:()=>_(!1),children:t.jsxs("div",{className:"bg-white rounded-2xl p-6 max-w-sm w-full",onClick:P=>P.stopPropagation(),children:[t.jsx("h3",{className:"text-lg font-bold text-gray-dark mb-4",children:"Выберите мессенджер"}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("button",{onClick:()=>I("whatsapp"),className:"w-full p-4 bg-[#25D366] text-white rounded-xl font-medium hover:bg-opacity-90 transition-opacity flex items-center justify-center gap-2",children:[t.jsx("svg",{className:"w-6 h-6",fill:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{d:"M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"})}),"WhatsApp"]}),t.jsxs("button",{onClick:()=>I("telegram"),className:"w-full p-4 bg-[#0088cc] text-white rounded-xl font-medium hover:bg-opacity-90 transition-opacity flex items-center justify-center gap-2",children:[t.jsx("svg",{className:"w-6 h-6",fill:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{d:"M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"})}),"Telegram"]}),t.jsxs("button",{onClick:()=>I("max"),className:"w-full p-4 bg-[#00A3FF] text-white rounded-xl font-medium hover:bg-opacity-90 transition-opacity flex items-center justify-center gap-2",children:[t.jsx("div",{className:"w-6 h-6 rounded-full bg-white flex items-center justify-center",children:t.jsx("span",{className:"text-[#00A3FF] font-bold text-sm",children:"M"})}),"Макс"]})]}),t.jsx("button",{onClick:()=>_(!1),className:"mt-4 w-full p-3 bg-gray-200 text-gray-dark hover:bg-gray-300 transition-colors rounded-2xl font-medium",children:"Отмена"})]})})]})},go=[{value:"walk",label:"Прогулка"},{value:"cognitive_games",label:"Когнитивные игры"},{value:"diaper_change",label:"Смена подгузников"},{value:"hygiene",label:"Гигиена"},{value:"skin_moisturizing",label:"Увлажнение кожи"},{value:"meal",label:"Прием пищи"},{value:"medications",label:"Прием лекарств"},{value:"vitamins",label:"Прием витаминов"},{value:"sleep",label:"Сон"}],po=[{value:"temperature",label:"Температура"},{value:"blood_pressure",label:"Артериальное давление"},{value:"breathing_rate",label:"Частота дыхания"},{value:"pain_level",label:"Уровень боли"},{value:"saturation",label:"Сатурация"},{value:"blood_sugar",label:"Уровень сахара в крови"}],xo=[{value:"urination",label:"Выпито/выделено и цвет мочи"},{value:"defecation",label:"Дефекация"}],yo=[{value:"nausea",label:"Тошнота"},{value:"vomiting",label:"Рвота"},{value:"shortness_of_breath",label:"Одышка"},{value:"itching",label:"Зуд"},{value:"cough",label:"Кашель"},{value:"dry_mouth",label:"Сухость во рту"},{value:"hiccups",label:"Икота"},{value:"taste_disturbance",label:"Нарушение вкуса"}],vg=()=>{const e=rt(),{user:r}=Se(),[s,a]=u.useState(1),[n,i]=u.useState(null),[o,c]=u.useState([]),[g,_]=u.useState([]),[y,D]=u.useState([]),[w,I]=u.useState(!1),[P,C]=u.useState(!1),[B,O]=u.useState([]),[$,p]=u.useState([]),[k,f]=u.useState([]),[x,F]=u.useState([]),[H,M]=u.useState(""),[L,U]=u.useState(""),[Z,j]=u.useState(""),[v,z]=u.useState("");u.useEffect(()=>{if(!r){e("/login");return}(async()=>{try{if(!await zn(r)){alert("У вас нет прав на создание дневников. Обратитесь к администратору организации."),e("/dashboard");return}}catch(E){console.error("Ошибка проверки прав на создание дневников:",E),alert("Ошибка проверки прав доступа"),e("/dashboard");return}})(),(async()=>{try{const E=r.user_metadata?.user_role,fe=r.user_metadata?.organization_type;let ye=R.from("patient_cards").select("*");E==="client"&&(ye=ye.eq("client_id",r.id));const{data:ce,error:me}=await ye;if(me){console.error("Ошибка загрузки карточек:",me),alert("Не удалось загрузить карточки подопечных. Попробуйте позже."),c([]);return}const{data:_e,error:De}=await R.from("diaries").select("patient_card_id, status").eq("status","active");if(De){console.error("Ошибка загрузки дневников:",De),c((ce||[]).map(Ae=>({id:Ae.id,client_id:Ae.client_id||"",full_name:Ae.full_name,date_of_birth:Ae.date_of_birth,gender:Ae.gender,diagnoses:Array.isArray(Ae.diagnoses)?Ae.diagnoses:[],mobility:Ae.mobility})));return}const xe=new Set((_e||[]).map(Ae=>Ae.patient_card_id).filter(Boolean)),Ee=(ce||[]).filter(Ae=>!xe.has(Ae.id)).map(Ae=>({id:Ae.id,client_id:Ae.client_id||"",full_name:Ae.full_name,date_of_birth:Ae.date_of_birth,gender:Ae.gender,diagnoses:Array.isArray(Ae.diagnoses)?Ae.diagnoses:[],mobility:Ae.mobility}));c(Ee)}catch(E){console.error("Error loading patient cards:",E),alert("Не удалось загрузить карточки подопечных. Попробуйте позже."),c([])}})()},[r,e]);const T=b=>{_(Q=>Q.includes(b)?Q.filter(E=>E!==b):Q.length<3?[...Q,b]:Q)},J=b=>{D(Q=>Q.includes(b)?Q.filter(E=>E!==b):[...Q,b])},W=()=>{H.trim()&&!B.includes(H.trim())&&(O([...B,H.trim()]),M(""))},h=()=>{L.trim()&&!$.includes(L.trim())&&(p([...$,L.trim()]),U(""))},A=()=>{Z.trim()&&!k.includes(Z.trim())&&(f([...k,Z.trim()]),j(""))},Y=()=>{v.trim()&&!x.includes(v.trim())&&(F([...x,v.trim()]),z(""))},ee=(b,Q)=>{b==="care"?(O(B.filter(E=>E!==Q)),_(g.filter(E=>E!==`custom_care_${Q}`)),D(y.filter(E=>E!==`custom_care_${Q}`))):b==="physical"?(p($.filter(E=>E!==Q)),_(g.filter(E=>E!==`custom_physical_${Q}`)),D(y.filter(E=>E!==`custom_physical_${Q}`))):b==="excretion"?(f(k.filter(E=>E!==Q)),_(g.filter(E=>E!==`custom_excretion_${Q}`)),D(y.filter(E=>E!==`custom_excretion_${Q}`))):(F(x.filter(E=>E!==Q)),_(g.filter(E=>E!==`custom_symptom_${Q}`)),D(y.filter(E=>E!==`custom_symptom_${Q}`)))},ae=()=>{s===2?(window.scrollTo({top:0,behavior:"smooth"}),a(1)):e("/dashboard")},ne=async()=>{if(g.length===0&&y.length===0){alert("Необходимо выбрать хотя бы один показатель");return}if(!n||!r)return;if(!o.find(Q=>Q.id===n)){alert("Не удалось найти выбранную карточку подопечного");return}try{const Q=r.user_metadata?.user_role,E=r.user_metadata?.organization_type;let fe=null;if(E==="pension"||E==="patronage_agency")fe=r.id;else if(Q==="org_employee")try{const{data:xe,error:Ee}=await R.from("organization_employees").select("organization_id").eq("user_id",r.id).maybeSingle();!Ee&&xe&&(fe=xe.organization_id)}catch(xe){console.error("Ошибка загрузки organization_id для сотрудника:",xe)}let ye=null;if(E==="caregiver")try{const{data:xe,error:Ee}=await R.from("organizations").select("id").eq("user_id",r.id).eq("type","caregiver").maybeSingle();!Ee&&xe?(ye=xe.id,console.log("[CreateDiaryPage] Загружен caregiver_id для сиделки:",ye)):Ee&&console.error("Ошибка загрузки caregiver_id для сиделки:",Ee)}catch(xe){console.error("Ошибка загрузки caregiver_id для сиделки:",xe)}else if(Q==="client")try{const{data:xe,error:Ee}=await R.from("clients").select("invited_by_caregiver_id").eq("user_id",r.id).maybeSingle();!Ee&&xe&&(ye=xe.invited_by_caregiver_id)}catch(xe){console.error("Ошибка загрузки caregiver_id для клиента:",xe)}const ce=xe=>xe.startsWith("custom_care_")?{label:xe.replace("custom_care_",""),category:"care"}:xe.startsWith("custom_physical_")?{label:xe.replace("custom_physical_",""),category:"physical"}:xe.startsWith("custom_excretion_")?{label:xe.replace("custom_excretion_",""),category:"excretion"}:xe.startsWith("custom_symptom_")?{label:xe.replace("custom_symptom_",""),category:"symptom"}:{},me=[...g.map(xe=>({metric_key:xe,is_pinned:!0,metadata:ce(xe)})),...y.map(xe=>({metric_key:xe,is_pinned:!1,metadata:ce(xe)}))],{data:_e,error:De}=await R.rpc("create_diary",{p_patient_card_id:n,p_metrics:me,p_organization_id:fe,p_organization_type:E??null,p_caregiver_id:ye});if(De){console.error("Ошибка создания дневника:",De),alert(De.message||"Ошибка при создании дневника");return}if(!_e||!_e.id){alert("Не удалось создать дневник. Попробуйте позже.");return}e(`/diaries/${_e.id}`)}catch(Q){console.error("Error creating diary:",Q),alert("Ошибка при создании дневника")}};return t.jsxs("div",{className:"min-h-screen bg-gray-100",children:[t.jsx("header",{className:"bg-white shadow-sm sticky top-0 z-10",children:t.jsx("div",{className:"flex items-center justify-between px-4 py-3",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("button",{onClick:ae,className:"-ml-2 flex items-center justify-center w-6 h-6","aria-label":"Назад",children:t.jsx("img",{src:"/icons/Иконка стрелка.png",alt:"Назад",className:"w-full h-full object-contain"})}),t.jsx("h1",{className:"text-lg font-bold text-gray-dark",children:s===1?"Выберите карточку подопечного":"Выберите показатели"})]})})}),t.jsxs("div",{className:"px-4 py-6 max-w-md mx-auto pb-24",children:[s===1&&t.jsx("div",{className:"space-y-4",children:o.length===0?t.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-2xl p-6 text-center",children:[t.jsx("p",{className:"text-red-800 font-semibold mb-2",children:"Нет доступных карточек"}),t.jsx("p",{className:"text-red-600 text-sm mb-4",children:"Создайте карточку подопечного, чтобы начать вести дневник"}),t.jsx(oe,{onClick:()=>e("/profile/patient-cards/new"),children:"Создать новую карточку"})]}):t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-2xl p-4 mb-4",children:t.jsx("p",{className:"text-blue-800 text-sm text-center",children:"Выберите карточку подопечного, для которого вы хотите создать дневник"})}),o.map(b=>t.jsx("button",{onClick:()=>{i(b.id),window.scrollTo({top:0,behavior:"smooth"}),a(2)},className:`w-full bg-white rounded-2xl p-4 shadow-sm text-left transition-all relative ${n===b.id?"border-2 border-[#7DD3DC]":"border-2 border-transparent hover:border-gray-200"}`,children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx("h3",{className:"text-lg font-bold text-gray-dark mb-2",children:b.full_name}),b.date_of_birth&&t.jsxs("p",{className:"text-sm text-gray-600",children:["Дата рождения: ",new Date(b.date_of_birth).toLocaleDateString("ru-RU")]}),t.jsxs("p",{className:"text-sm text-gray-600",children:["Пол: ",b.gender==="male"?"Мужской":"Женский"]})]}),t.jsx("img",{src:"/icons/иконка маленькая стрелка.png",alt:"",className:"w-4 h-4 ml-4"})]})},b.id))]})}),s===2&&t.jsxs("div",{className:"space-y-6",children:[t.jsx("div",{className:"bg-transparent border border-[#7DD3DC] rounded-2xl p-3",children:t.jsxs("p",{className:"text-[#4A4A4A] text-xs text-center font-medium",children:["Для ",t.jsx("strong",{children:"закрепленных показателей"})," лучше выбирать показатели, которые нужно замерять через определенный промежуток времени: давление, пульс, температура и др."]})}),t.jsxs("div",{className:"bg-gradient-to-r from-[#7DD3DC] to-[#5CBCC7] rounded-3xl p-6 shadow-md",children:[t.jsx("h2",{className:"text-xl font-bold text-white mb-3 text-center",children:"Закрепленные показатели"}),t.jsx("p",{className:"text-sm text-white opacity-90 mb-4 text-center",children:"Выберите до 3-х показателей для быстрого доступа с таймером заполнения"}),t.jsxs(oe,{variant:"outline",className:"w-full !bg-white !text-[#5CBCC7] !border-none",onClick:()=>I(!0),children:["Выбрать (",g.length,"/3)"]})]}),t.jsxs("div",{className:"bg-white rounded-3xl p-6 shadow-md border-2 border-gray-300",children:[t.jsx("h2",{className:"text-xl font-bold text-gray-dark mb-3 text-center",children:"Все показатели"}),t.jsx("p",{className:"text-sm text-gray-600 mb-4 text-center",children:"Выберите остальные показатели для отслеживания"}),t.jsxs(oe,{variant:"outline",className:"w-full",onClick:()=>C(!0),children:["Выбрать (",y.length,")"]})]}),t.jsx(oe,{onClick:ne,disabled:g.length===0&&y.length===0,className:"w-full",children:"Создать дневник"})]})]}),t.jsx(ea,{isOpen:w,onClose:()=>I(!1),title:"Выбор показателей (закрепленных)",children:t.jsxs("div",{className:"space-y-6",children:[t.jsx("p",{className:"text-sm text-gray-600 text-center",children:"Чтобы закрепить параметры которые важно не забывать отслеживать - нажмите на него и нажмите на кнопку выбрать, доступно не более 3 параметров"}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-bold text-gray-dark mb-3",children:"Показатели ухода"}),t.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-3",children:[go.map(b=>t.jsx("button",{type:"button",onClick:()=>T(b.value),disabled:!g.includes(b.value)&&g.length>=3,className:`px-4 py-3 rounded-3xl text-sm font-semibold transition-all ${g.includes(b.value)?"bg-[#A0D9E3] text-[#4A4A4A] border-2 border-[#A0D9E3]":"bg-white text-[#4A4A4A] border-2 border-[#7DD3DC]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:b.label},b.value)),B.map(b=>t.jsxs("div",{className:"relative",children:[t.jsx("button",{type:"button",onClick:()=>T(`custom_care_${b}`),disabled:!g.includes(`custom_care_${b}`)&&g.length>=3,className:`w-full px-4 py-3 rounded-3xl text-sm font-semibold transition-all ${g.includes(`custom_care_${b}`)?"bg-[#A0D9E3] text-[#4A4A4A] border-2 border-[#A0D9E3]":"bg-white text-[#4A4A4A] border-2 border-[#7DD3DC]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:b}),t.jsx("button",{type:"button",onClick:()=>ee("care",b),className:"absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs flex items-center justify-center",children:"×"})]},b))]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(he,{value:H,onChange:b=>M(b.target.value),placeholder:"Добавить показатель не из списка",className:"flex-1 bg-white"}),t.jsx(oe,{type:"button",onClick:W,className:"!bg-[#7DD3DC] !text-white px-6",children:"+"})]})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-bold text-gray-dark mb-3",children:"Физические показатели"}),t.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-3",children:[po.map(b=>t.jsx("button",{type:"button",onClick:()=>T(b.value),disabled:!g.includes(b.value)&&g.length>=3,className:`px-4 py-3 rounded-3xl text-sm font-semibold transition-all ${g.includes(b.value)?"bg-[#A0D9E3] text-[#4A4A4A] border-2 border-[#A0D9E3]":"bg-white text-[#4A4A4A] border-2 border-[#7DD3DC]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:b.label},b.value)),$.map(b=>t.jsxs("div",{className:"relative",children:[t.jsx("button",{type:"button",onClick:()=>T(`custom_physical_${b}`),disabled:!g.includes(`custom_physical_${b}`)&&g.length>=3,className:`w-full px-4 py-3 rounded-3xl text-sm font-semibold transition-all ${g.includes(`custom_physical_${b}`)?"bg-[#A0D9E3] text-[#4A4A4A] border-2 border-[#A0D9E3]":"bg-white text-[#4A4A4A] border-2 border-[#7DD3DC]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:b}),t.jsx("button",{type:"button",onClick:()=>ee("physical",b),className:"absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs flex items-center justify-center",children:"×"})]},b))]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(he,{value:L,onChange:b=>U(b.target.value),placeholder:"Добавить показатель не из списка",className:"flex-1 bg-white"}),t.jsx(oe,{type:"button",onClick:h,className:"!bg-[#7DD3DC] !text-white px-6",children:"+"})]})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-bold text-gray-dark mb-3",children:"Выделение мочи и кала"}),t.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-3",children:[xo.map(b=>t.jsx("button",{type:"button",onClick:()=>T(b.value),disabled:!g.includes(b.value)&&g.length>=3,className:`px-4 py-3 rounded-3xl text-sm font-semibold transition-all ${g.includes(b.value)?"bg-[#A0D9E3] text-[#4A4A4A] border-2 border-[#A0D9E3]":"bg-white text-[#4A4A4A] border-2 border-[#7DD3DC]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:b.label},b.value)),k.map(b=>t.jsxs("div",{className:"relative",children:[t.jsx("button",{type:"button",onClick:()=>T(`custom_excretion_${b}`),disabled:!g.includes(`custom_excretion_${b}`)&&g.length>=3,className:`w-full px-4 py-3 rounded-3xl text-sm font-semibold transition-all ${g.includes(`custom_excretion_${b}`)?"bg-[#A0D9E3] text-[#4A4A4A] border-2 border-[#A0D9E3]":"bg-white text-[#4A4A4A] border-2 border-[#7DD3DC]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:b}),t.jsx("button",{type:"button",onClick:()=>ee("excretion",b),className:"absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs flex items-center justify-center",children:"×"})]},b))]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(he,{value:Z,onChange:b=>j(b.target.value),placeholder:"Добавить показатель не из списка",className:"flex-1 bg-white"}),t.jsx(oe,{type:"button",onClick:A,className:"!bg-[#7DD3DC] !text-white px-6",children:"+"})]})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-bold text-gray-dark mb-3",children:"Тягостные симптомы"}),t.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-3",children:[yo.map(b=>t.jsx("button",{type:"button",onClick:()=>T(b.value),disabled:!g.includes(b.value)&&g.length>=3,className:`px-4 py-3 rounded-3xl text-sm font-semibold transition-all ${g.includes(b.value)?"bg-[#A0D9E3] text-[#4A4A4A] border-2 border-[#A0D9E3]":"bg-white text-[#4A4A4A] border-2 border-[#7DD3DC]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:b.label},b.value)),x.map(b=>t.jsxs("div",{className:"relative",children:[t.jsx("button",{type:"button",onClick:()=>T(`custom_symptom_${b}`),disabled:!g.includes(`custom_symptom_${b}`)&&g.length>=3,className:`w-full px-4 py-3 rounded-3xl text-sm font-semibold transition-all ${g.includes(`custom_symptom_${b}`)?"bg-[#A0D9E3] text-[#4A4A4A] border-2 border-[#A0D9E3]":"bg-white text-[#4A4A4A] border-2 border-[#7DD3DC]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:b}),t.jsx("button",{type:"button",onClick:()=>ee("symptom",b),className:"absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs flex items-center justify-center",children:"×"})]},b))]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(he,{value:v,onChange:b=>z(b.target.value),placeholder:"Добавить показатель не из списка",className:"flex-1 bg-white"}),t.jsx(oe,{type:"button",onClick:Y,className:"!bg-[#7DD3DC] !text-white px-6",children:"+"})]})]}),t.jsx(oe,{onClick:()=>I(!1),className:"w-full !bg-gradient-to-r !from-[#7DD3DC] !to-[#5CBCC7] !text-white font-bold py-4 !rounded-3xl",children:"Выбрать"})]})}),t.jsx(ea,{isOpen:P,onClose:()=>C(!1),title:"Выбор показателей",children:t.jsxs("div",{className:"space-y-6",children:[t.jsx("p",{className:"text-sm text-gray-600 text-center",children:"Чтобы выбрать индивидуальные параметры которые важно отслеживать - нажмите на него и после выбора всех необходимых нажмите на кнопку выбрать"}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-bold text-gray-dark mb-3",children:"Показатели ухода"}),t.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-3",children:[go.map(b=>t.jsx("button",{type:"button",onClick:()=>J(b.value),disabled:g.includes(b.value),className:`px-4 py-3 rounded-3xl text-sm font-semibold transition-all ${y.includes(b.value)?"bg-[#A0D9E3] text-[#4A4A4A] border-2 border-[#A0D9E3]":g.includes(b.value)?"bg-gray-200 text-gray-500 border-2 border-gray-300":"bg-white text-[#4A4A4A] border-2 border-[#7DD3DC]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:b.label},b.value)),B.map(b=>t.jsxs("div",{className:"relative",children:[t.jsx("button",{type:"button",onClick:()=>J(`custom_care_${b}`),disabled:g.includes(`custom_care_${b}`),className:`w-full px-4 py-3 rounded-3xl text-sm font-semibold transition-all ${y.includes(`custom_care_${b}`)?"bg-[#A0D9E3] text-[#4A4A4A] border-2 border-[#A0D9E3]":g.includes(`custom_care_${b}`)?"bg-gray-200 text-gray-500 border-2 border-gray-300":"bg-white text-[#4A4A4A] border-2 border-[#7DD3DC]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:b}),t.jsx("button",{type:"button",onClick:()=>ee("care",b),className:"absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs flex items-center justify-center",children:"×"})]},`custom_care_${b}`))]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(he,{value:H,onChange:b=>M(b.target.value),placeholder:"Добавить показатель не из списка",className:"flex-1 bg-white"}),t.jsx(oe,{type:"button",onClick:W,className:"!bg-[#7DD3DC] !text-white px-6",children:"+"})]})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-bold text-gray-dark mb-3",children:"Физические показатели"}),t.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-3",children:[po.map(b=>t.jsx("button",{type:"button",onClick:()=>J(b.value),disabled:g.includes(b.value),className:`px-4 py-3 rounded-3xl text-sm font-semibold transition-all ${y.includes(b.value)?"bg-[#A0D9E3] text-[#4A4A4A] border-2 border-[#A0D9E3]":g.includes(b.value)?"bg-gray-200 text-gray-500 border-2 border-gray-300":"bg-white text-[#4A4A4A] border-2 border-[#7DD3DC]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:b.label},b.value)),$.map(b=>t.jsxs("div",{className:"relative",children:[t.jsx("button",{type:"button",onClick:()=>J(`custom_physical_${b}`),disabled:g.includes(`custom_physical_${b}`),className:`w-full px-4 py-3 rounded-3xl text-sm font-semibold transition-all ${y.includes(`custom_physical_${b}`)?"bg-[#A0D9E3] text-[#4A4A4A] border-2 border-[#A0D9E3]":g.includes(`custom_physical_${b}`)?"bg-gray-200 text-gray-500 border-2 border-gray-300":"bg-white text-[#4A4A4A] border-2 border-[#7DD3DC]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:b}),t.jsx("button",{type:"button",onClick:()=>ee("physical",b),className:"absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs flex items-center justify-center",children:"×"})]},`custom_physical_${b}`))]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(he,{value:L,onChange:b=>U(b.target.value),placeholder:"Добавить показатель не из списка",className:"flex-1 bg-white"}),t.jsx(oe,{type:"button",onClick:h,className:"!bg-[#7DD3DC] !text-white px-6",children:"+"})]})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-bold text-gray-dark mb-3",children:"Выделение мочи и кала"}),t.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-3",children:[xo.map(b=>t.jsx("button",{type:"button",onClick:()=>J(b.value),disabled:g.includes(b.value),className:`px-4 py-3 rounded-3xl text-sm font-semibold transition-all ${y.includes(b.value)?"bg-[#A0D9E3] text-[#4A4A4A] border-2 border-[#A0D9E3]":g.includes(b.value)?"bg-gray-200 text-gray-500 border-2 border-gray-300":"bg-white text-[#4A4A4A] border-2 border-[#7DD3DC]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:b.label},b.value)),k.map(b=>t.jsxs("div",{className:"relative",children:[t.jsx("button",{type:"button",onClick:()=>J(`custom_excretion_${b}`),disabled:g.includes(`custom_excretion_${b}`),className:`w-full px-4 py-3 rounded-3xl text-sm font-semibold transition-all ${y.includes(`custom_excretion_${b}`)?"bg-[#A0D9E3] text-[#4A4A4A] border-2 border-[#A0D9E3]":g.includes(`custom_excretion_${b}`)?"bg-gray-200 text-gray-500 border-2 border-gray-300":"bg-white text-[#4A4A4A] border-2 border-[#7DD3DC]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:b}),t.jsx("button",{type:"button",onClick:()=>ee("excretion",b),className:"absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs flex items-center justify-center",children:"×"})]},`custom_excretion_${b}`))]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(he,{value:Z,onChange:b=>j(b.target.value),placeholder:"Добавить показатель не из списка",className:"flex-1 bg-white"}),t.jsx(oe,{type:"button",onClick:A,className:"!bg-[#7DD3DC] !text-white px-6",children:"+"})]})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-bold text-gray-dark mb-3",children:"Тягостные симптомы"}),t.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-3",children:[yo.map(b=>t.jsx("button",{type:"button",onClick:()=>J(b.value),disabled:g.includes(b.value),className:`px-4 py-3 rounded-3xl text-sm font-semibold transition-all ${y.includes(b.value)?"bg-[#A0D9E3] text-[#4A4A4A] border-2 border-[#A0D9E3]":g.includes(b.value)?"bg-gray-200 text-gray-500 border-2 border-gray-300":"bg-white text-[#4A4A4A] border-2 border-[#7DD3DC]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:b.label},b.value)),x.map(b=>t.jsxs("div",{className:"relative",children:[t.jsx("button",{type:"button",onClick:()=>J(`custom_symptom_${b}`),disabled:g.includes(`custom_symptom_${b}`),className:`w-full px-4 py-3 rounded-3xl text-sm font-semibold transition-all ${y.includes(`custom_symptom_${b}`)?"bg-[#A0D9E3] text-[#4A4A4A] border-2 border-[#A0D9E3]":g.includes(`custom_symptom_${b}`)?"bg-gray-200 text-gray-500 border-2 border-gray-300":"bg-white text-[#4A4A4A] border-2 border-[#7DD3DC]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:b}),t.jsx("button",{type:"button",onClick:()=>ee("symptom",b),className:"absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs flex items-center justify-center",children:"×"})]},`custom_symptom_${b}`))]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(he,{value:v,onChange:b=>z(b.target.value),placeholder:"Добавить показатель не из списка",className:"flex-1 bg-white"}),t.jsx(oe,{type:"button",onClick:Y,className:"!bg-[#7DD3DC] !text-white px-6",children:"+"})]})]}),t.jsx(oe,{onClick:()=>C(!1),className:"w-full !bg-gradient-to-r !from-[#7DD3DC] !to-[#5CBCC7] !text-white font-bold py-4 !rounded-3xl",children:"Выбрать"})]})}),s===1&&o.length>0&&t.jsx("div",{className:"fixed bottom-0 left-0 right-0 bg-white pb-6 pt-4 px-4 z-10 shadow-lg border-t border-gray-200",children:t.jsx("div",{className:"max-w-md mx-auto",children:t.jsx(oe,{onClick:()=>e("/profile/patient-cards/new"),className:"w-full !bg-gradient-to-r !from-[#7DD3DC] !to-[#5CBCC7] !text-white font-bold py-4 !rounded-3xl text-base shadow-md",children:"Создать новую карточку"})})})]})};function $r(e){if(!e)return"07:00";const r=e.split(":");return r.length>=2?`${r[0].padStart(2,"0")}:${r[1].padStart(2,"0")}`:"07:00"}function ta(e){if(!e)return"07:00:00";const r=e.split(":");return r.length===2?`${r[0].padStart(2,"0")}:${r[1].padStart(2,"0")}:00`:r.length===3?e:"07:00:00"}async function Pn(e){const{data:r,error:s}=await R.from("route_templates").select("*").eq("diary_id",e).order("created_at",{ascending:!0});return s?(console.error("[routeService] fetchRouteTemplates error:",s),[]):(r&&r.length&&console.log("[routeService] fetchRouteTemplates: found",r.length,"templates for diary",e),r||[])}async function pl(e){if(!e.length)return[];const{data:r,error:s}=await R.from("route_template_slots").select("*").in("template_id",e).order("position",{ascending:!0});return s?(console.error("[routeService] fetchRouteSlots error:",s),[]):(r&&r.length&&console.log("[routeService] fetchRouteSlots: found",r.length,"slots for templates",e),(r||[]).map(a=>({...a,from_time:$r(a.from_time),to_time:$r(a.to_time)})))}async function jg(e,r){if(!e.length)return[];let s=R.from("route_assignments").select("*").in("template_id",e);r&&(s=s.or(`event_date.is.null,event_date.eq.${r}`));const{data:a,error:n}=await s;return n?(console.error("[routeService] fetchRouteAssignments error:",n),[]):a||[]}async function wg(e,r){if(!e.length)return[];const{data:s,error:a}=await R.from("route_events").select("*").in("slot_id",e).eq("event_date",r).order("created_at",{ascending:!1});return a?(console.error("[routeService] fetchRouteEvents error:",a),[]):(s||[]).map(n=>({...n,event_from:$r(n.event_from),event_to:$r(n.event_to)}))}async function bo(e,r,s){const a=await Pn(e);if(!a.length)return[];const n=a.map(O=>O.id),i=new Map(a.map(O=>[O.id,O])),o=await pl(n);if(!o.length)return[];const _=(new Date(r).getDay()+6)%7,y=o.filter(O=>O.day_of_week===null||O.day_of_week===_);if(!y.length)return[];const D=y.map(O=>O.id),w=await jg(n,r),I=new Map;w.forEach(O=>{const $=I.get(O.slot_id);$?O.event_date&&!$.event_date&&I.set(O.slot_id,O):I.set(O.slot_id,O)});const P=await wg(D,r),C=new Map;P.forEach(O=>{C.has(O.slot_id)||C.set(O.slot_id,O)});const B=[];for(const O of y){const $=i.get(O.template_id);if(!$)continue;const p=I.get(O.id),k=C.get(O.id),f=p?.assigned_employee_id||O.default_assigned_employee;B.push({template_id:$.id,slot_id:O.id,diary_id:$.diary_id,title:$.title,metric_type:$.metric_type,description:$.description,day_of_week:O.day_of_week,from_time:O.from_time,to_time:O.to_time,position:O.position,assigned_employee_id:f||null,allow_multiple_assignments:O.allow_multiple_assignments,event_id:k?.id||null,status:k?.status||null,performed_by:k?.performed_by||null,performed_at:k?.performed_at||null,reason:k?.reason||null,comment:k?.comment||null})}return B.sort((O,$)=>{const p=Mr(O.from_time),k=Mr($.from_time);return p-k}),B}function Mr(e){const[r,s]=e.split(":").map(Number);return(r||0)*60+(s||0)}function xl(e){const r=(e%1440+1440)%1440,s=Math.floor(r/60),a=r%60;return`${String(s).padStart(2,"0")}:${String(a).padStart(2,"0")}`}async function Ng(e,r,s,a,n,i,o){try{const{data:c}=await R.from("route_templates").select("id").eq("diary_id",e).eq("metric_type",r).limit(1);let g;if(c&&c.length>0)g=c[0].id,await R.from("route_templates").update({title:s,updated_at:new Date().toISOString()}).eq("id",g),await R.from("route_template_slots").delete().eq("template_id",g);else{const{data:D,error:w}=await R.from("route_templates").insert({diary_id:e,metric_type:r,title:s,created_by:i,organization_id:o||null,visible_to:"organization"}).select("id").single();if(w||!D)return console.error("[routeService] saveRouteTemplate: failed to create template",w),null;g=D.id}const _=[];let y=0;for(const D of a)for(const w of n){const I=w.from||"07:00";let P=w.to??I,C=Mr(I),B=Mr(P);B<=C&&(B=C+1,P=xl(B)),_.push({template_id:g,day_of_week:D,from_time:ta(I),to_time:ta(P),position:y++})}if(_.length>0){const{data:D,error:w}=await R.from("route_template_slots").insert(_).select("id");return w?(console.error("[routeService] saveRouteTemplate: failed to create slots",w),null):{templateId:g,slotIds:(D||[]).map(I=>I.id)}}return{templateId:g,slotIds:[]}}catch(c){return console.error("[routeService] saveRouteTemplate error:",c),null}}async function kg(e){const r=e.eventFrom||"07:00";let s=e.eventTo??r,a=Mr(r),n=Mr(s);n<=a&&(n=a+1,s=xl(n));const{data:i,error:o}=await R.from("route_events").insert({template_id:e.templateId,slot_id:e.slotId,event_date:e.eventDate,event_from:ta(r),event_to:ta(s),status:e.status,performed_by:e.performedBy||null,performed_at:e.status==="done"?new Date().toISOString():null,reason:e.reason||null,comment:null,created_by:e.createdBy}).select().single();return o?(console.error("[routeService] createRouteEvent error:",o),null):i?{...i,event_from:$r(i.event_from),event_to:$r(i.event_to)}:null}function Ag(e,r){const s={};for(const a of e){if(!a.metric_type)continue;const n=r.filter(c=>c.template_id===a.id);if(!n.length)continue;const i=new Set,o=new Map;for(const c of n){c.day_of_week!==null&&i.add(c.day_of_week);const g=`${c.from_time}_${c.to_time}`;o.has(g)||o.set(g,{from:c.from_time,to:c.to_time})}s[a.metric_type]={days:Array.from(i).sort((c,g)=>c-g),times:Array.from(o.values())}}return s}async function Cg(e){const r=await Pn(e);if(!r.length)return{};const s=r.map(n=>n.id),a=await pl(s);return Ag(r,a)}const Sg=()=>{const[e,r]=u.useState(()=>typeof window<"u"?window.innerWidth:1920);return u.useEffect(()=>{if(typeof window>"u")return;const s=()=>{r(window.innerWidth)};return window.addEventListener("resize",s),()=>window.removeEventListener("resize",s)},[]),e},Dg=({metricType:e,metricLabel:r,lastValue:s,onSave:a,onClose:n,initialTimes:i})=>{const o=u.useMemo(()=>!i||i.length===0?[]:Array.from(new Set(i)).sort(),[i]),[c,g]=u.useState(""),[_,y]=u.useState(()=>i&&i.length>0?[...i].sort():[]),[D,w]=u.useState(()=>i&&i.length>0?[...i].sort()[0]:""),[I,P]=u.useState("Выберите время"),C=u.useRef(!1),B=u.useRef({timeInput:"",times:[],value:"",metricType:""});u.useEffect(()=>{if(i&&i.length>0){const F=[...i].sort();y(F),w(F[0])}else y([]),w(""),P("Выберите время")},[i]),u.useEffect(()=>{B.current={timeInput:D,times:_,value:c,metricType:e},D&&D.trim()!==""&&!_.includes(D)?C.current=!0:(D===""||_.includes(D))&&(C.current=!1)},[D,_,c,e]),u.useEffect(()=>{const F=()=>{const M=B.current;if(C.current&&M.timeInput&&M.timeInput.trim()!==""&&!M.times.includes(M.timeInput)){const L=Array.from(new Set([...M.times,M.timeInput])).sort(),U={value:"",frequency:L.length,reminderStart:L[0]??"",reminderEnd:L[L.length-1]??"",times:L};try{a(M.metricType,U)}catch(Z){console.error("Ошибка сохранения при размонтировании:",Z)}}},H=()=>{F()};return window.addEventListener("beforeunload",H),()=>{window.removeEventListener("beforeunload",H),F()}},[a]);const O=async()=>{let F=[..._];D&&D.trim()!==""&&!F.includes(D)&&(F=Array.from(new Set([...F,D])).sort(),y(F));const H=F.length>0?Array.from(new Set(F)).sort():[],M=c.trim()==="",L=H.length===o.length&&H.every((Z,j)=>Z===o[j]);if(M&&L){n();return}const U={value:c,frequency:H.length,reminderStart:H[0]??"",reminderEnd:H[H.length-1]??"",times:H};try{await a(e,U),C.current=!1,g(""),y(H),w(H[0]??"")}catch(Z){console.error("Ошибка сохранения:",Z)}},$=u.useMemo(()=>_.length===0?[]:Array.from(new Set(_)).sort(),[_]),p=()=>{if($.length===0){P("Выберите время");return}const F=new Date,H=F.getHours()*60+F.getMinutes(),M=$.find(v=>{const[z,T]=v.split(":").map(Number);return z*60+T>H});let L;if(M){const[v,z]=M.split(":").map(Number);L=v*60+z-H}else{const[v,z]=$[0].split(":").map(Number);L=v*60+z+(1440-H)}const U=Math.floor(L/60),Z=L%60,j=(U?`${String(U).padStart(2,"0")}:`:"00:")+String(Z).padStart(2,"0");P(j)};u.useEffect(()=>{p();const F=setInterval(p,60*1e3);return()=>clearInterval(F)},[$]);const k=s||"--",x=Sg()<388;return t.jsxs("div",{className:"bg-gradient-to-br from-[#61B4C6] to-[#317799] rounded-2xl text-white shadow-md grid gap-3 overflow-hidden h-full",style:{gridTemplateColumns:x?"clamp(80px, calc((100% - 16px) / 3), 120px) 1fr":"calc((100% - 24px) / 3) 1fr",minHeight:x?"120px":"140px",padding:x?"8px":"12px",borderRadius:x?"12px":"16px",gap:x?"8px":"12px"},children:[t.jsxs("div",{className:"flex flex-col items-center text-white text-center h-full justify-between min-w-0",style:{fontFamily:"Manrope, sans-serif"},children:[t.jsx("div",{className:"text-base font-bold w-full text-center mb-2",style:{minHeight:x?"32px":"38px",lineHeight:"1.1",display:"flex",alignItems:"center",justifyContent:"center",fontSize:x?"12px":"16px"},children:r}),t.jsx("div",{className:"flex items-center justify-center w-full",style:{height:x?"70px":"90px"},children:t.jsxs("div",{className:"relative flex items-center justify-center",style:{width:x?"70px":"100px",height:x?"70px":"100px",minWidth:x?"70px":"100px",minHeight:x?"70px":"100px"},children:[t.jsxs("svg",{className:"absolute inset-0 w-full h-full",viewBox:"0 0 100 100",preserveAspectRatio:"xMidYMid meet",children:[t.jsx("circle",{cx:"50",cy:"50",r:"42",fill:"url(#circleGradient)",opacity:"0.85"}),t.jsx("circle",{cx:"50",cy:"50",r:"40",fill:"none",stroke:"#ffffff",strokeOpacity:"0.35",strokeWidth:"6",strokeDasharray:"8 8"}),t.jsx("defs",{children:t.jsxs("radialGradient",{id:"circleGradient",cx:"50%",cy:"50%",r:"50%",children:[t.jsx("stop",{offset:"0%",stopColor:"rgba(255,255,255,0.25)"}),t.jsx("stop",{offset:"100%",stopColor:"rgba(0,0,0,0.15)"})]})})]}),t.jsx("div",{className:"relative z-10 flex items-center justify-center text-center",style:{fontFamily:"Manrope, sans-serif",fontWeight:800,fontSize:typeof k=="string"&&k.length<=5?x?"24px":"32px":typeof k=="string"&&k.length<=8?x?"20px":"28px":x?"16px":"22px",color:"#FFFFFF",textShadow:"0 2px 6px rgba(0, 0, 0, 0.25)",minWidth:x?"48px":"64px",padding:x?"0 4px":"0 6px",wordBreak:"break-word"},children:k})]})}),t.jsxs("div",{className:"w-full space-y-1.5 mt-2",children:[t.jsx("div",{className:"text-xs opacity-90 text-center",style:{fontSize:x?"10px":"12px"},children:_.length===0?"Выберите время":`Заполнить через: ${I}`}),t.jsx("button",{onClick:O,className:"w-full text-xs text-white py-1.5 bg-[#4A4A4A] rounded-xl",style:{borderRadius:"12px",fontSize:x?"10px":"12px",paddingTop:x?"4px":"6px",paddingBottom:x?"4px":"6px"},children:"Сохранить"})]})]}),t.jsxs("div",{className:"flex flex-col justify-between gap-1.5 min-w-0 h-full",children:[t.jsxs("div",{className:"rounded-2xl bg-gradient-to-r from-[#7DCAD6] to-[#55ACBF] px-3 py-1.5 w-full",style:{borderRadius:x?"12px":"16px",padding:x?"8px 12px":"12px"},children:[t.jsx("p",{className:"text-[11px] font-semibold mb-1",style:{fontFamily:"Manrope, sans-serif",fontSize:x?"10px":"11px",marginBottom:"4px"},children:"Заполните:"}),t.jsx(he,{type:"text",value:c,onChange:F=>g(F.target.value),placeholder:"Внесите замер",className:"w-full bg-white text-[#4A4A4A] text-xs h-7 rounded-xl px-2.5",style:{fontSize:x?"10px":"12px",height:x?"24px":"28px",padding:x?"4px 10px":"6px 10px",borderRadius:x?"10px":"12px"}})]}),t.jsxs("div",{className:"rounded-2xl bg-gradient-to-r from-[#7DCAD6] to-[#55ACBF] px-3 py-1.5 w-full space-y-2",style:{borderRadius:x?"12px":"16px",padding:x?"8px 12px":"12px",gap:"8px"},children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("p",{className:"text-[11px] font-semibold",style:{fontFamily:"Manrope, sans-serif",fontSize:x?"10px":"11px"},children:"Время заполнения:"}),t.jsxs("span",{className:"text-[11px] opacity-80 whitespace-nowrap",style:{fontFamily:"Manrope, sans-serif",fontSize:x?"10px":"11px"},children:[$.length," ",$.length===1?"раз в день":"раза в день"]})]}),t.jsx("div",{className:"flex flex-wrap gap-2",children:$.map(F=>t.jsxs("span",{className:"inline-flex items-center gap-1 bg-white text-[#4A4A4A] text-xs px-2.5 py-1 rounded-xl",style:{fontSize:x?"10px":"12px",padding:"4px 10px",borderRadius:x?"10px":"12px",gap:"4px"},children:[F,t.jsx("button",{type:"button",onClick:()=>y(H=>{const M=H.filter(L=>L!==F);return M.length===0?(w(""),[]):(M.includes(D)||w(M[0]),M)}),className:"text-[#4A4A4A] text-xs leading-none",style:{fontSize:x?"10px":"12px"},children:"×"})]},F))}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(he,{type:"time",value:D,onChange:F=>w(F.target.value),className:"bg-white text-[#4A4A4A] text-xs h-7 rounded-xl px-2.5 flex-1",style:{fontSize:x?"10px":"12px",height:x?"24px":"28px",padding:x?"4px 10px":"6px 10px",borderRadius:x?"10px":"12px"}}),t.jsx("button",{type:"button",onClick:async()=>{if(!D)return;const F=Array.from(new Set([..._,D])).sort();y(F),w(""),C.current=!1;const H={value:"",frequency:F.length,reminderStart:F[0]??"",reminderEnd:F[F.length-1]??"",times:F};try{await a(e,H)}catch(M){console.error("Ошибка сохранения времени:",M)}},className:"bg-[#A0D9E3] text-[#4A4A4A] text-xl font-bold rounded-xl flex items-center justify-center p-0 border-0 cursor-pointer hover:opacity-80 transition-opacity flex-shrink-0",style:{width:x?"28px":"35px",height:x?"28px":"35px",fontSize:x?"18px":"24px",borderRadius:x?"10px":"12px"},children:"+"})]})]})]})]})},zg=()=>{const[e,r]=u.useState(()=>typeof window<"u"?window.innerWidth:1920);return u.useEffect(()=>{if(typeof window>"u")return;const s=()=>{r(window.innerWidth)};return window.addEventListener("resize",s),()=>window.removeEventListener("resize",s)},[]),e},lr=1440,ns=e=>{if(!e||typeof e!="string")return 0;const[r,s]=e.split(":"),a=Number(r),n=Number(s);return Number.isNaN(a)||Number.isNaN(n)?0:((a*60+n)%lr+lr)%lr},_o=e=>{const r=(e%lr+lr)%lr,s=Math.floor(r/60),a=r%60;return`${String(s).padStart(2,"0")}:${String(a).padStart(2,"0")}`},Eg=(e,r,s)=>{const a=Math.max(1,Math.floor(e||1)),n=ns(r||"09:00");if(a===1)return[_o(n)];let i=ns(s||"21:00");i<=n&&(i+=lr);const o=Math.max(1,Math.floor((i-n)/(a-1)));return Array.from({length:a},(c,g)=>_o(n+g*o))},pr=e=>{const r=typeof e?.reminderStart=="string"?e.reminderStart:"09:00",s=typeof e?.reminderEnd=="string"?e.reminderEnd:"21:00";let a=[];return Array.isArray(e?.times)?a=Array.from(new Set(e.times.map(n=>String(n??"").slice(0,5)).filter(n=>!!n&&n.includes(":")))).sort():typeof e?.frequency=="number"&&e.frequency>0&&(a=Eg(Math.floor(e.frequency),r,s)),a.length===0?{frequency:0,reminderStart:"",reminderEnd:"",times:[]}:(a=Array.from(new Set(a)).sort(),{frequency:a.length,reminderStart:a[0],reminderEnd:a[a.length-1],times:a})},Pg=e=>{if(!e||typeof e!="object")return null;const r=e.id??e.value_id??crypto.randomUUID(),s=e.diary_id??e.diaryId,a=e.metric_type??e.metricType,n=e.created_at??e.createdAt;if(!r||!s||!a||!n)return null;let i;try{i=new Date(n).toISOString()}catch{i=new Date().toISOString()}return{id:String(r),diary_id:String(s),metric_type:String(a),value:e.value,created_at:i}},Dr=e=>{const r=new Map;return e.forEach(s=>{const a=Pg(s);if(!a)return;const n=typeof a.value=="object"?JSON.stringify(a.value):String(a.value??""),i=new Date(a.created_at).toISOString().slice(0,19)+"Z",o=`${a.metric_type}_${n}_${i}`;r.has(o)||r.set(o,a)}),Array.from(r.values()).sort((s,a)=>new Date(a.created_at).getTime()-new Date(s.created_at).getTime())},La=async(e,r)=>{try{const s=r?new Date(r).toISOString().split("T")[0]:void 0,{data:a,error:n}=await R.rpc("get_diary_history",{p_diary_id:e,p_date:s||null});return n?(console.error("Ошибка загрузки истории:",n),[]):(a||[]).map(i=>{const o=i.payload||{};let c=o.value;return o.value&&typeof o.value=="object"&&"value"in o.value&&(c=o.value.value),{id:o.metric_id||`value_${Date.now()}_${Math.random()}`,diary_id:e,metric_type:o.metric_key||"",value:c||null,created_at:i.occurred_at||new Date().toISOString()}})}catch(s){return console.error("Ошибка загрузки истории:",s),[]}},Ig={walk:{variant:"boolean",description:"Отметьте, состоялась ли прогулка у подопечного."},cognitive_games:{variant:"options",description:"Выберите проведённую активность или добавьте свою.",options:["Чтение","Настольные игры","Пазлы","Разговор","Музыка"]},diaper_change:{variant:"boolean",description:"Отметьте, была ли выполнена смена подгузника."},hygiene:{variant:"boolean",description:"Отметьте, проводилась ли гигиена."},skin_moisturizing:{variant:"boolean",description:"Отметьте, было ли увлажнение кожи."},meal:{variant:"text",description:"Опишите, что ели и как прошёл приём пищи.",placeholder:"Например: завтрак — овсянка, чай"},medications:{variant:"text",description:"Укажите, какие лекарства были приняты.",placeholder:"Например: принимаем Энап 5 мг"},vitamins:{variant:"text",description:"Укажите витамины/БАДы и особенности приёма.",placeholder:"Например: витамин D 1000 МЕ"},sleep:{variant:"text",description:"Опишите длительность и качество сна.",placeholder:"Например: спал c 22:30 до 07:00, крепко"},temperature:{variant:"numeric",description:"Запишите измеренную температуру тела.",unit:"°C",min:30,max:45,step:.1},blood_pressure:{variant:"pressure",description:"Укажите систолическое и диастолическое давление, при необходимости пульс."},breathing_rate:{variant:"numeric",description:"Количество вдохов в минуту.",unit:"вдох/мин",min:5,max:60},pulse:{variant:"numeric",description:"Укажите частоту пульса.",unit:"уд/мин",min:20,max:220,step:1},pain_level:{variant:"pain",description:"Оцените уровень боли по шкале от 0 до 10 и опишите, что беспокоит."},saturation:{variant:"numeric",description:"Укажите уровень сатурации кислорода.",unit:"%",min:50,max:100},blood_sugar:{variant:"numeric",description:"Укажите уровень сахара в крови.",unit:"ммоль/л",min:1,max:30,step:.1},urination:{variant:"urination",description:"Отметьте количество выпитой жидкости, выделенной мочи и её цвет."},defecation:{variant:"boolean",description:"Зафиксируйте, была ли дефекация."},nausea:{variant:"boolean",description:"Отметьте, была ли тошнота."},vomiting:{variant:"boolean",description:"Отметьте, была ли рвота."},shortness_of_breath:{variant:"boolean",description:"Зафиксируйте появление одышки."},itching:{variant:"boolean",description:"Зафиксируйте наличие зуда."},cough:{variant:"boolean",description:"Отметьте появление кашля."},dry_mouth:{variant:"boolean",description:"Отметьте ощущение сухости во рту."},hiccups:{variant:"boolean",description:"Зафиксируйте, была ли икота."},taste_disturbance:{variant:"boolean",description:"Отметьте нарушение вкуса."}},vo=[{value:"walk",label:"Прогулка"},{value:"cognitive_games",label:"Когнитивные игры"},{value:"diaper_change",label:"Смена подгузников"},{value:"hygiene",label:"Гигиена"},{value:"skin_moisturizing",label:"Увлажнение кожи"},{value:"meal",label:"Прием пищи"},{value:"medications",label:"Прием лекарств"},{value:"vitamins",label:"Прием витаминов"}],Vs=[{value:"temperature",label:"Температура"},{value:"blood_pressure",label:"Артериальное давление"},{value:"breathing_rate",label:"Частота дыхания"},{value:"pain_level",label:"Уровень боли"},{value:"saturation",label:"Сатурация"},{value:"blood_sugar",label:"Уровень сахара в крови"},{value:"urination",label:"Выпито/выделено и цвет мочи"},{value:"defecation",label:"Дефекация"},{value:"pulse",label:"Пульс"}],jo=[{value:"urination",label:"Выпито/выделено и цвет мочи"},{value:"defecation",label:"Дефекация"}],wo=[{value:"nausea",label:"Тошнота"},{value:"vomiting",label:"Рвота"},{value:"shortness_of_breath",label:"Одышка"},{value:"itching",label:"Зуд"},{value:"cough",label:"Кашель"},{value:"dry_mouth",label:"Сухость во рту"},{value:"hiccups",label:"Икота"},{value:"taste_disturbance",label:"Нарушение вкуса"}],$g=[{value:"walks",label:"Ходит"},{value:"sits",label:"Сидит"},{value:"lies",label:"Лежит"}],Mg=e=>{if(e.startsWith("custom_"))return{variant:"text",description:"Запишите значение показателя.",placeholder:"Введите значение"};const r={variant:"boolean",description:"Зафиксируйте состояние показателя."};return Ig[e]||r},Tg=()=>new Date().toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"}),Ua=e=>{const r=e.getTimezoneOffset();return new Date(e.getTime()-r*60*1e3).toISOString().slice(0,10)},Zs=e=>e?new Date(`${e}T00:00:00`):new Date,Rg=({isOpen:e,metricType:r,metricLabel:s,onClose:a,onSave:n})=>{const i=u.useRef(null),o=Mg(r),[c,g]=u.useState(null),[_,y]=u.useState(""),[D,w]=u.useState(""),[I,P]=u.useState(""),[C,B]=u.useState(""),[O,$]=u.useState(0),[p,k]=u.useState(""),[f,x]=u.useState(""),[F,H]=u.useState(""),[M,L]=u.useState(""),[U,Z]=u.useState(""),[j,v]=u.useState([]),[z,T]=u.useState([]),[J,W]=u.useState(""),[h,A]=u.useState(""),Y=u.useMemo(()=>{const Q=o.options||[],E=z.filter(fe=>!Q.includes(fe));return[...Q,...E]},[o.options,z]);if(u.useEffect(()=>{e&&(g(null),y(""),w(""),P(""),B(""),$(3),k(""),x(""),H(""),L(""),Z(""),v([]),T([]),W(""),A(""))},[e,r]),u.useEffect(()=>{const Q=fe=>{i.current&&!i.current.contains(fe.target)&&a()},E=fe=>{fe.key==="Escape"&&a()};return e&&(document.addEventListener("mousedown",Q),document.addEventListener("keydown",E),document.body.style.overflow="hidden"),()=>{document.removeEventListener("mousedown",Q),document.removeEventListener("keydown",E),document.body.style.overflow="unset"}},[e,a]),!e)return null;const ee=()=>{const Q=J.trim();Q&&(v(E=>Array.from(new Set([...E,Q]))),T(E=>Array.from(new Set([...E,Q]))),W(""))},ae=Q=>{v(E=>E.includes(Q)?E.filter(fe=>fe!==Q):[...E,Q])},ne=()=>{switch(o.variant){case"boolean":return c!==null;case"numeric":return _.trim().length>0;case"pressure":return D.trim().length>0&&I.trim().length>0;case"pain":return O>=0;case"urination":return f.trim().length>0||F.trim().length>0||M!=="";case"options":return j.length>0||h.trim().length>0;case"text":return h.trim().length>0;default:return!1}},b=()=>{const Q=Tg();let E="";switch(o.variant){case"boolean":E=`${c?"Было":"Не было"} · ${Q}`;break;case"numeric":{const fe=o.unit?` ${o.unit}`:"";E=`${_}${fe} · ${Q}`;break}case"pressure":{const fe=`${D}/${I}`,ye=C?` · Пульс ${C}`:"";E=`${fe}${ye} · ${Q}`;break}case"pain":{const fe=p.trim()?` · ${p.trim()}`:"";E=`Боль ${O}/10${fe} · ${Q}`;break}case"urination":{const fe=[];f.trim()&&fe.push(`Выпито ${f.trim()} мл`),F.trim()&&fe.push(`Выделено ${F.trim()} мл`),M&&fe.push(`Цвет: ${M}`),U.trim()&&fe.push(U.trim()),E=`${fe.join(" / ")} · ${Q}`;break}case"options":{const fe=[...j];h.trim()&&fe.push(h.trim()),E=`${fe.join(", ")} · ${Q}`;break}case"text":{E=`${h.trim()} · ${Q}`;break}default:E=""}n(E),a()};return t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 px-4",children:t.jsxs("div",{ref:i,className:"w-full max-w-sm rounded-[28px] bg-white shadow-[0_20px_60px_rgba(0,0,0,0.18)] p-6 space-y-6",children:[t.jsxs("div",{className:"text-center space-y-2",children:[t.jsx("h2",{className:"text-xl font-semibold text-[#4A4A4A]",children:s}),o.description&&t.jsx("p",{className:"text-sm text-gray-500 leading-relaxed",children:o.description}),t.jsx("p",{className:"text-xs text-gray-400",children:"Время заполнения фиксируется автоматически"})]}),o.variant==="boolean"&&t.jsx("div",{className:"flex items-center justify-between gap-3",children:[{label:"Было",value:!0},{label:"Не было",value:!1}].map(Q=>{const E=c===Q.value;return t.jsx("button",{onClick:()=>g(Q.value),className:`flex-1 rounded-2xl py-3 text-sm font-semibold transition-all ${E?"bg-gradient-to-r from-[#7DD3DC] to-[#5CBCC7] text-white shadow-md":"bg-white text-[#4A4A4A] border border-[#7DD3DC]"}`,children:Q.label},Q.label)})}),o.variant==="numeric"&&t.jsx("div",{className:"space-y-3",children:t.jsxs("label",{className:"text-sm font-medium text-[#4A4A4A]",children:["Значение",t.jsx(he,{type:"number",value:_,onChange:Q=>y(Q.target.value),min:o.min,max:o.max,step:o.step,className:"mt-2"})]})}),o.variant==="pressure"&&t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Систолическое"}),t.jsx(he,{type:"number",value:D,onChange:Q=>w(Q.target.value),className:"mt-1"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Диастолическое"}),t.jsx(he,{type:"number",value:I,onChange:Q=>P(Q.target.value),className:"mt-1"})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Пульс (опционально)"}),t.jsx(he,{type:"number",value:C,onChange:Q=>B(Q.target.value),className:"mt-1"})]})]}),o.variant==="pain"&&t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-sm text-gray-500",children:"Нет боли"}),t.jsx("span",{className:"text-sm font-semibold text-[#4A4A4A]",children:O}),t.jsx("span",{className:"text-sm text-gray-500",children:"Сильная боль"})]}),t.jsx("input",{type:"range",min:0,max:10,value:O,onChange:Q=>$(Number(Q.target.value)),className:"w-full accent-[#7DD3DC]"}),t.jsx("textarea",{value:p,onChange:Q=>k(Q.target.value),placeholder:"Что болит или беспокоит?",className:"w-full min-h-[72px] rounded-2xl border border-gray-200 px-4 py-3 text-sm focus:border-[#7DD3DC] focus:outline-none"})]}),o.variant==="urination"&&t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Выпито (мл)"}),t.jsx(he,{type:"number",value:f,onChange:Q=>x(Q.target.value),className:"mt-1"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Выделено (мл)"}),t.jsx(he,{type:"number",value:F,onChange:Q=>H(Q.target.value),className:"mt-1"})]}),t.jsx("div",{className:"flex gap-2",children:["светлая","нормальная","тёмная"].map(Q=>{const E=M===Q;return t.jsx("button",{onClick:()=>L(Q),className:`flex-1 rounded-2xl py-2 text-xs font-semibold capitalize transition-all ${E?"bg-gradient-to-r from-[#7DD3DC] to-[#5CBCC7] text-white shadow-md":"bg-white text-[#4A4A4A] border border-[#7DD3DC]"}`,children:Q},Q)})}),t.jsx("textarea",{value:U,onChange:Q=>Z(Q.target.value),placeholder:"Комментарий (опционально)",className:"w-full min-h-[68px] rounded-2xl border border-gray-200 px-4 py-3 text-sm focus:border-[#7DD3DC] focus:outline-none"})]}),o.variant==="options"&&t.jsxs("div",{className:"space-y-4",children:[Y.length>0&&t.jsx("div",{className:"flex flex-wrap gap-2",children:Y.map(Q=>{const E=j.includes(Q);return t.jsx("button",{onClick:()=>ae(Q),className:`px-4 py-2 rounded-2xl text-xs font-semibold transition-all ${E?"bg-gradient-to-r from-[#7DD3DC] to-[#5CBCC7] text-white shadow-md":"bg-white text-[#4A4A4A] border border-[#7DD3DC]"}`,children:Q},Q)})}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(he,{value:J,onChange:Q=>W(Q.target.value),placeholder:"Своя активность"}),t.jsx("button",{onClick:ee,className:"px-4 py-2 rounded-2xl bg-[#7DD3DC] text-white text-sm font-semibold hover:opacity-90 transition-opacity",children:"Добавить"})]}),t.jsx("textarea",{value:h,onChange:Q=>A(Q.target.value),placeholder:"Комментарий (опционально)",className:"w-full min-h-[68px] rounded-2xl border border-gray-200 px-4 py-3 text-sm focus:border-[#7DD3DC] focus:outline-none"})]}),o.variant==="text"&&t.jsx("div",{className:"space-y-3",children:t.jsx(he,{type:"text",value:h,onChange:Q=>A(Q.target.value),placeholder:o.placeholder||"Введите значение",className:"w-full"})}),t.jsxs("div",{className:"flex items-center gap-3 pt-2",children:[t.jsx("button",{onClick:a,className:"flex-1 rounded-2xl bg-gray-200 text-[#4A4A4A] font-semibold py-3 hover:bg-gray-300 transition-colors",children:"Отмена"}),t.jsx("button",{onClick:b,disabled:!ne(),className:"flex-1 rounded-2xl bg-gradient-to-r from-[#7DD3DC] to-[#5CBCC7] text-white font-semibold py-3 shadow-md disabled:opacity-60 disabled:cursor-not-allowed transition-opacity",children:"Сохранить"})]})]})})},Fg=()=>{const{id:e}=Po(),r=rt(),s=Rr(),{user:a}=Se(),[n]=Tr(),i=typeof window<"u"?window.location.origin:"",o=u.useMemo(()=>{const l=d=>{if(d==null)return null;const N=String(d);return N==="null"||N==="undefined"||N.trim()===""?null:N};try{const d=JSON.parse(localStorage.getItem("current_user")||"{}");return d&&typeof d=="object"&&("organization_id"in d&&(d.organization_id=l(d.organization_id)),"caregiver_id"in d&&(d.caregiver_id=l(d.caregiver_id))),d}catch(d){return console.warn("Не удалось прочитать current_user",d),{}}},[]),[c,g]=u.useState(o.user_role||a?.user_metadata?.user_role||null);u.useEffect(()=>{(async()=>{if(!c&&a?.id)try{const{data:d,error:N}=await R.from("user_profiles").select("role").eq("user_id",a.id).single();!N&&d?.role?(console.log("[DiaryPage] Загружена роль из user_profiles:",d.role),g(d.role)):N&&console.error("[DiaryPage] Ошибка загрузки роли из user_profiles:",N)}catch(d){console.error("Ошибка загрузки роли из user_profiles:",d)}})()},[a?.id,c]);const _=o.organization_type||a?.user_metadata?.organization_type,y=_==="pension"||_==="patronage_agency",D=c==="client",w=_==="caregiver",I=c==="org_employee",P=y&&!I,C=a?.id||o.id||o.user_id||o.user?.id||o.user_metadata?.user_id||null,B=l=>{if(l==null)return null;const d=String(l);return d==="null"||d==="undefined"||d.trim()===""?null:d},O=B(o.organization_id||a?.user_metadata?.organization_id||a?.organization_id),$=B(o.caregiver_id||a?.user_metadata?.caregiver_id||a?.caregiver_id),p=O||(P?C:null),k=u.useMemo(()=>Ua(new Date),[]),[f,x]=u.useState(null),[F,H]=u.useState(null),[M,L]=u.useState([]),[U,Z]=u.useState([]),[j,v]=u.useState("diary"),[z,T]=u.useState(null),[J,W]=u.useState(!1),[h,A]=u.useState({}),[Y,ee]=u.useState(null),[ae,ne]=u.useState(!1),[b,Q]=u.useState(!1),[E,fe]=u.useState(!1),[ye,ce]=u.useState([]),me=l=>{ce(d=>d.includes(l)?d.filter(N=>N!==l):[...d,l])},[_e,De]=u.useState(()=>vo),xe=u.useRef(new Set(vo.map(l=>l.value))),[Ee,Ae]=u.useState(""),[kt,Fr]=u.useState(()=>Vs),At=u.useRef(new Set(Vs.map(l=>l.value))),[m,S]=u.useState(""),V=()=>{const l=m.trim();if(!l)return;const d=se(l);Fr(N=>{if(N.some(K=>K.value===d)){const K=`${d}_${Date.now().toString(36)}`;return[...N,{value:K,label:l}]}return[...N,{value:d,label:l}]}),ce(N=>N.includes(d)?N:[...N,d]),S("")},le=l=>{l.key==="Enter"&&(l.preventDefault(),V())},se=l=>{let d=l.toLowerCase().trim().replace(/\s+/g,"_").replace(/[^\w\u0400-\u04FF0-9_]/g,"").slice(0,60);return d||(d=`custom_${Date.now().toString(36)}`),d},ie=()=>{const l=Ee.trim();if(!l)return;const d=se(l);De(N=>{if(N.some(K=>K.value===d)){const K=`${d}_${Date.now().toString(36)}`;return[...N,{value:K,label:l}]}return[...N,{value:d,label:l}]}),ce(N=>N.includes(d)?N:[...N,d]),Ae("")},be=l=>{l.key==="Enter"&&(l.preventDefault(),ie())},$e=l=>{xe.current.has(l)||(De(d=>d.filter(N=>N.value!==l)),ce(d=>d.filter(N=>N!==l)))},Me=l=>{At.current.has(l)||(Fr(d=>d.filter(N=>N.value!==l)),ce(d=>d.filter(N=>N!==l)))},[ot,Jt]=u.useState(!1),[Pt,Or]=u.useState(null),[Yt,Nr]=u.useState({}),[Lr,Ur]=u.useState([]),[gs,ps]=u.useState([]),[yl,In]=u.useState(!1),bl=async(l,d)=>{if(e&&C){const N=nt(l),K=await Ng(e,l,N,d.days,d.times,C,ut||null);K?console.log("[DiaryPage] route schedule saved to DB:",l,K):console.warn("[DiaryPage] Failed to save route schedule to DB, falling back to localStorage")}Nr(N=>({...N,[l]:d})),console.log("[DiaryPage] route schedule updated:",l,d)};u.useEffect(()=>{if(!e)return;(async()=>{try{const d=await Cg(e);Nr(d),console.log("[DiaryPage] Loaded routeSchedules from Supabase",d)}catch(d){console.warn("[DiaryPage] Failed to load routeSchedules from Supabase",d)}})()},[e]),u.useEffect(()=>{if(!E||!e)return;(async()=>{In(!0);try{const d=await Pn(e);ps(d),console.log("[DiaryPage] Loaded route templates:",d)}catch(d){console.warn("[DiaryPage] Failed to load route templates",d)}finally{In(!1)}})()},[e,E]);const _l=({isOpen:l,metric:d,onClose:N,onSave:K})=>{const[q,ge]=u.useState([!1,!1,!1,!1,!1,!1,!1]),[G,X]=u.useState([]),[ue,ze]=u.useState("07:00"),[Oe,de]=u.useState("07:00"),[re,we]=u.useState(null),[Ne,je]=u.useState(!1);if(u.useEffect(()=>{!l||!d||(Array.isArray(d)?we(d[0]||null):we(d),je(!1))},[l,d]),u.useEffect(()=>{if(!l||!re)return;const Ce=Yt[re]||{days:[],times:[]},Ve=[!1,!1,!1,!1,!1,!1,!1];(Ce.days||[]).forEach(ht=>{ht>=0&&ht<7&&(Ve[ht]=!0)}),ge(Ve);const Yr=(Ce.times||[]).map(ht=>ht?typeof ht=="string"?{from:ht,to:ht}:typeof ht=="object"&&"from"in ht&&"to"in ht?{from:ht.from||"07:00",to:ht.to||ht.from||"07:00"}:{from:"07:00",to:"07:00"}:{from:"07:00",to:"07:00"});X(Yr),ze("07:00"),de("07:00")},[l,re]),!l||!d)return null;const Le=Ce=>{ge(Ve=>{const Ge=[...Ve];return Ge[Ce]=!Ge[Ce],Ge})},Pe=()=>{if(!ue||!Oe)return;G.some(Ve=>Ve.from===ue&&Ve.to===Oe)||X(Ve=>[...Ve,{from:ue,to:Oe}]),ze("07:00"),de("07:00")},Xe=Ce=>X(Ve=>Ve.filter(Ge=>!(Ge.from===Ce.from&&Ge.to===Ce.to))),Ie=()=>{const Ve={days:q.map((Ge,Yr)=>Ge?Yr:-1).filter(Ge=>Ge!==-1),times:G};Array.isArray(d)&&Ne?d.forEach(Ge=>K(Ge,Ve)):Array.isArray(d)&&re?K(re,Ve):typeof d=="string"&&K(d,Ve),N()},Ut=["ПН","ВТ","СР","ЧТ","ПТ","СБ","ВС"];return t.jsx("div",{className:"fixed inset-0 z-60 flex items-center justify-center bg-black/40 px-4",children:t.jsxs("div",{className:"w-full max-w-sm rounded-[28px] bg-white p-6 space-y-4",children:[t.jsxs("div",{className:"text-center",children:[t.jsx("h2",{className:"text-2xl font-bold text-[#25ADB8]",children:"Настройте манипуляцию"}),t.jsx("div",{className:"text-xl font-semibold mt-1",children:Array.isArray(d)?t.jsx("div",{className:"flex flex-wrap gap-2 justify-center",children:d.map(Ce=>t.jsx("button",{type:"button",onClick:()=>we(Ce),className:`px-3 py-2 rounded-2xl text-sm font-semibold ${re===Ce?"bg-[#CFF6F8] text-[#0A6D83] shadow-md":"bg-white border border-gray-200 text-[#4A4A4A]"}`,children:nt(Ce)},Ce))}):nt(d)})]}),t.jsx("div",{children:t.jsx("div",{className:"flex flex-wrap gap-2 justify-center",children:Ut.map((Ce,Ve)=>t.jsx("button",{type:"button",onClick:()=>Le(Ve),className:`px-3 py-2 rounded-2xl text-sm font-semibold ${q[Ve]?"bg-[#CFF6F8] text-[#0A6D83] shadow-md":"bg-white border border-gray-200 text-[#4A4A4A]"}`,children:Ce},Ce))})}),t.jsxs("div",{children:[t.jsx("div",{className:"flex flex-wrap gap-2 mb-2",children:G.map(Ce=>t.jsxs("div",{className:"inline-flex items-center gap-2 bg-gray-100 rounded-full px-3 py-2",children:[t.jsxs("span",{className:"text-sm font-medium",children:[Ce.from,Ce.from!==Ce.to?` — ${Ce.to}`:""]}),t.jsx("button",{onClick:()=>Xe(Ce),className:"text-xs text-red-500",children:"×"})]},`${Ce.from}_${Ce.to}`))}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"time",value:ue,onChange:Ce=>ze(Ce.target.value),className:"rounded-xl border border-gray-200 px-3 py-2"}),t.jsx("span",{className:"text-gray-400",children:"—"}),t.jsx("input",{type:"time",value:Oe,onChange:Ce=>de(Ce.target.value),className:"rounded-xl border border-gray-200 px-3 py-2"}),t.jsx("button",{onClick:Pe,className:"w-12 h-12 rounded-xl bg-[#2AA6B1] text-white",children:"+"})]})]}),Array.isArray(d)&&t.jsx("div",{className:"flex items-center justify-center gap-3 pt-2",children:t.jsxs("label",{className:"inline-flex items-center gap-2 text-sm",children:[t.jsx("input",{type:"checkbox",checked:Ne,onChange:Ce=>je(Ce.target.checked)}),t.jsx("span",{children:"Применить ко всем выбранным"})]})}),t.jsxs("div",{className:"flex items-center gap-3 justify-center pt-2",children:[t.jsx("button",{onClick:Ie,className:"px-6 py-3 rounded-2xl bg-[#55ACBF] text-white font-semibold",children:"Сохранить"}),t.jsx("button",{onClick:N,className:"px-6 py-3 rounded-2xl bg-gray-200 text-[#4A4A4A] font-semibold",children:"Отмена"})]})]})})},[da,vl]=u.useState(null),[Ct,xs]=u.useState(null),[$n,Mn]=u.useState(null),[kr,ys]=u.useState({}),[Tn,ua]=u.useState(()=>new Date),Rt=u.useRef(null),Xt=u.useRef(null),[Ke,jl]=u.useState(k),[ma,bs]=u.useState(!1),[_t,ha]=u.useState(()=>Zs(k)),fa=u.useRef(null);u.useEffect(()=>{if(!e||!Ke)return;(async()=>{try{const d=await bo(e,Ke);Ur(d),console.log("[DiaryPage] Loaded routeSlotsForDate from Supabase",d)}catch(d){console.warn("[DiaryPage] Failed to load routeSlotsForDate",d)}})()},[e,Ke]);const[Ye,er]=u.useState(null),[tr,Ft]=u.useState(null),[_s,Ar]=u.useState([]),[Br,wl]=u.useState(!1),[vs,Rn]=u.useState("card"),lt=zg()<388,nt=l=>{if(l.startsWith("custom_")){const N=M.find(q=>q.metric_type===l);if(N){const q=N.metadata||{};return q.label?q.label:l.replace("custom_care_","").replace("custom_physical_","").replace("custom_excretion_","").replace("custom_symptom_","")||l}return l.replace("custom_care_","").replace("custom_physical_","").replace("custom_excretion_","").replace("custom_symptom_","")||l}return{walk:"Прогулка",cognitive_games:"Когнитивные игры",diaper_change:"Смена подгузников",hygiene:"Гигиена",skin_moisturizing:"Увлажнение кожи",meal:"Прием пищи",medications:"Прием лекарств",vitamins:"Прием витаминов",sleep:"Сон",temperature:"Температура",blood_pressure:"Давление",pulse:"Пульс",breathing_rate:"Частота дыхания",pain_level:"Уровень боли",saturation:"Сатурация",blood_sugar:"Уровень сахара в крови",urination:"Выпито/выделено и цвет мочи",defecation:"Дефекация",nausea:"Тошнота",vomiting:"Рвота",shortness_of_breath:"Одышка",itching:"Зуд",cough:"Кашель",dry_mouth:"Сухость во рту",hiccups:"Икота",taste_disturbance:"Нарушение вкуса"}[l]||l},dr=u.useMemo(()=>{if(!Ke)return[];if(Lr.length>0)return Lr.map(q=>({metric:q.metric_type||q.title,label:q.title||nt(q.metric_type||""),from:q.from_time,to:q.to_time,startMinutes:ns(q.from_time),slotId:q.slot_id,templateId:q.template_id,status:q.status,eventId:q.event_id,performedBy:q.performed_by,performedAt:q.performed_at,reason:q.reason,comment:q.comment,assignedEmployeeId:q.assigned_employee_id}));const N=(Zs(Ke).getDay()+6)%7,K=[];return Object.entries(Yt||{}).forEach(([q,ge])=>{if(!ge||!Array.isArray(ge.days)||!ge.days.includes(N))return;(Array.isArray(ge.times)?ge.times:[]).forEach(X=>{const ue=X&&X.from||X||"07:00",ze=X&&X.to||X||ue,Oe=ns(ue);K.push({metric:q,label:nt(q),from:ue,to:ze,startMinutes:Oe})})}),K.sort((q,ge)=>q.startMinutes-ge.startMinutes),K},[Yt,Lr,Ke,M]),vt=u.useMemo(()=>_||f?.organization_type||o.organization_type||null,[_,f?.organization_type,o.organization_type]),[Fn,Vr]=u.useState(null),[On,ct]=u.useState(null),[st,ur]=u.useState({fullName:"",dateOfBirth:"",address:"",diagnoses:"",mobility:"walks"}),[Ot,js]=u.useState([]),[Ln,ws]=u.useState([]),[mr,Un]=u.useState(!1),[Bn,ga]=u.useState(!1),[It,Nl]=u.useState([]),[Ns,ks]=u.useState([]),[Zr,Wr]=u.useState(null),[jt,As]=u.useState([]),[qr,Cs]=u.useState(""),[kl,Vn]=u.useState(!1),pa=async l=>{if(!l?.accepted_by){Ft(null);return}try{const{data:d,error:N}=await R.from("clients").select("*").eq("user_id",l.accepted_by).maybeSingle();N?(console.warn("Ошибка загрузки клиента:",N),Ft(null)):Ft(d?{user_id:d.user_id,first_name:d.first_name||"",last_name:d.last_name||""}:null)}catch(d){console.warn("Не удалось загрузить данные клиента",d),Ft(null)}};u.useEffect(()=>{const l=setInterval(()=>{ua(new Date)},6e4);return()=>clearInterval(l)},[]),u.useEffect(()=>{if(!w||!C)return;(async()=>{try{const{data:d,error:N}=await R.from("organizations").select("id").eq("user_id",C).eq("organization_type","caregiver").maybeSingle();!N&&d?(console.log("[DiaryPage] Загружен ID организации-сиделки:",d.id),vl(d.id)):N&&console.error("[DiaryPage] Ошибка загрузки ID организации-сиделки:",N)}catch(d){console.error("[DiaryPage] Ошибка загрузки ID организации-сиделки:",d)}})()},[w,C]);const Jr=u.useMemo(()=>$||(w?da:null),[$,w,da]),[dt,Zn]=u.useState(null),[xa,Wn]=u.useState(null);u.useEffect(()=>{if(!C){Zn(null),Wn(null);return}(async()=>{if(I)try{const{data:d,error:N}=await R.from("organization_employees").select("organization_id").eq("user_id",C).maybeSingle();!N&&d?.organization_id&&(Zn(d.organization_id),console.log("[DiaryPage] Loaded employee organization_id:",d.organization_id))}catch(d){console.error("[DiaryPage] Error loading employee organization_id:",d)}if(P&&!O)try{const{data:d,error:N}=await R.from("organizations").select("id").eq("user_id",C).maybeSingle();!N&&d?.id&&(Wn(d.id),console.log("[DiaryPage] Loaded organization_id from organizations table:",d.id))}catch(d){console.error("[DiaryPage] Error loading organization_id:",d)}})()},[I,P,C,O]);const ut=u.useMemo(()=>I&&dt?dt:P&&xa?xa:p,[I,P,dt,xa,p]);u.useEffect(()=>{if(!e)return;(async()=>{try{const{data:d,error:N}=await R.from("diary_client_links").select("*").eq("diary_id",e).maybeSingle();if(N){console.error("Ошибка загрузки ссылки для клиента:",N),er(null),Ft(null);return}if(d){const q={link:d.token?`${i}/client-invite?diary=${e}&token=${d.token}`:"",created_at:d.accepted_at||new Date().toISOString(),token:d.token||"",diary_id:d.diary_id,patient_card_id:f?.patient_card_id??null,organization_id:f?.organization_id??p??null,accepted_by:d.accepted_by||null,accepted_at:d.accepted_at||null,client_id:d.client_id||null};er(q),pa(q)}else er(null),Ft(null)}catch(d){console.error("Ошибка загрузки ссылки для клиента:",d),er(null),Ft(null)}})()},[e,f?.patient_card_id,f?.organization_id,p,ut,dt,I]),u.useEffect(()=>{if(console.log("[DiaryPage] useEffect для загрузки клиентов:",{id:e,isOrganization:y,organizationType:_,userRole:c}),!e){console.log("[DiaryPage] Пропуск загрузки клиентов: нет id");return}if(!y&&!I){console.log("[DiaryPage] Пропуск загрузки клиентов: не организация и не сотрудник",{isOrganization:y,isOrgEmployee:I,organizationType:_});return}(async()=>{try{if(I&&!rr.canManageClientAccess){console.log("[DiaryPage] Пропуск загрузки клиентов: руководитель без прав на управление клиентами"),ks([]);return}const d=I?dt||ut||f?.organization_id:f?.organization_id||p;console.log("[DiaryPage] Загрузка приглашенных клиентов для дневника:",e,"organization_id:",d);const{data:N,error:K}=await R.from("diary_client_links").select("token, accepted_at, client_id, accepted_by").eq("diary_id",e);console.log("[DiaryPage] Загружено diary_client_links:",N?.length||0,"Ошибка:",K);const{data:q,error:ge}=await R.from("invite_tokens").select(`
            id,
            token,
            used_at,
            used_by,
            revoked_at,
            created_at,
            organization_client_invite_tokens (
              invite_id,
              diary_id,
              organization_id,
              invited_client_phone,
              invited_client_name,
              metadata
            )
          `).eq("invite_type","organization_client").order("created_at",{ascending:!1});console.log("[DiaryPage] Загружено приглашений:",q?.length||0,"Ошибка:",ge),q&&q.length>0&&console.log("[DiaryPage] Детали загруженных приглашений:",q.map(de=>({token:de.token,used_at:de.used_at,used_by:de.used_by,invite_type:de.invite_type})));const G=new Map;!K&&N&&N.length>0&&(N.forEach(de=>{G.set(de.token,{accepted_at:de.accepted_at,client_id:de.client_id,accepted_by:de.accepted_by}),console.log("[DiaryPage] Добавлена ссылка в карту:",{token:de.token,client_id:de.client_id,accepted_at:de.accepted_at,accepted_by:de.accepted_by})}),console.log("[DiaryPage] Создана карта токенов из diary_client_links:",G.size));let X={};const ue=new Map,ze=new Set;!ge&&q&&q.length>0&&q.forEach(de=>{const re=Array.isArray(de.organization_client_invite_tokens)?de.organization_client_invite_tokens.find(we=>we.diary_id===e):de.organization_client_invite_tokens?.diary_id===e?de.organization_client_invite_tokens:null;if(re){const we=re.diary_id===e,Ne=I?dt||ut||f?.organization_id||p:f?.organization_id||p,je=!Ne||!re.organization_id||re.organization_id===Ne;we||je?(ue.set(de.token,{invite_id:de.id,used_at:de.used_at,used_by:de.used_by,created_at:de.created_at,invited_client_phone:re.invited_client_phone,invited_client_name:re.invited_client_name,organization_id:re.organization_id}),de.used_at&&de.used_by?(ze.add(de.used_by),console.log("[DiaryPage] ✅ Найдено использованное приглашение:",{token:de.token,used_at:de.used_at,used_by:de.used_by,invite_id:de.id,diary_id:re.diary_id,isForCurrentDiary:we})):console.log("[DiaryPage] ⚠️ Приглашение не использовано или нет used_by:",{token:de.token,used_at:de.used_at,used_by:de.used_by,invite_id:de.id,diary_id:re.diary_id,isForCurrentDiary:we})):console.log("[DiaryPage] Пропуск приглашения: organization_id не совпадает и не для текущего дневника",{invite_id:de.id,invite_org_id:re.organization_id,current_org_id:p,diary_id:re.diary_id,current_diary_id:e})}});const Oe=Array.from(ue.entries()).filter(([,de])=>de.used_at&&!de.used_by);if(Oe.length>0&&(console.log("[DiaryPage] ⚠️ Найдены использованные приглашения без used_by (возможно, RLS блокирует):",Oe.length),console.log("[DiaryPage] Детали приглашений без used_by:",Oe.map(([de,re])=>({token:de,used_at:re.used_at})))),ze.size>0){console.log("[DiaryPage] Восстанавливаем данные для использованных приглашений, used_by:",Array.from(ze));const{data:de,error:re}=await R.from("clients").select("id, user_id, first_name, last_name, phone, invited_by_organization_id").in("user_id",Array.from(ze));if(console.log("[DiaryPage] Загружено зарегистрированных клиентов по used_by:",de?.length||0,"Ошибка:",re),!re&&de&&de.length>0){const we=new Map(de.map(Ne=>[Ne.user_id,Ne]));ue.forEach((Ne,je)=>{if(Ne.used_by&&Ne.used_at){const Le=we.get(Ne.used_by);if(Le){const Pe=I?dt||ut||f?.organization_id||p:f?.organization_id||p;if(!Pe||!Ne.organization_id||Ne.organization_id===Pe||Le.invited_by_organization_id===Pe){const Ie=G.get(je);Ie?(Ie.client_id=Le.id,Ie.accepted_by=Ne.used_by,Ie.accepted_at=Ne.used_at,console.log("[DiaryPage] Восстановлены данные для существующей записи:",{token:je,client_id:Le.id,accepted_by:Ne.used_by,accepted_at:Ne.used_at})):(G.set(je,{client_id:Le.id,accepted_by:Ne.used_by,accepted_at:Ne.used_at}),console.log("[DiaryPage] Создана новая запись в linksMap для токена:",je))}}}}),de.forEach(Ne=>{X[Ne.id]||(X[Ne.id]={first_name:Ne.first_name||void 0,last_name:Ne.last_name||void 0,user_id:Ne.user_id||void 0,phone:Ne.phone||void 0},console.log("[DiaryPage] Добавлены данные восстановленного клиента в clientsData:",Ne.id))})}}if(G.size>0||ue.size>0){const de=new Set,re=new Set;G.forEach(je=>{je.client_id&&de.add(je.client_id),je.accepted_by&&re.add(je.accepted_by)}),ue.forEach(je=>{je.used_by&&je.used_at&&re.add(je.used_by)}),console.log("[DiaryPage] ID зарегистрированных клиентов из client_id:",Array.from(de)),console.log("[DiaryPage] User ID из accepted_by и used_by:",Array.from(re));let we={};if(re.size>0){const je=Array.from(re);console.log("[DiaryPage] Загружаем клиентов по accepted_by (user_id)");const{data:Le,error:Pe}=await R.from("clients").select("id, user_id, first_name, last_name, phone").in("user_id",je);if(console.log("[DiaryPage] Загружено клиентов по user_id:",Le?.length||0,"Ошибка:",Pe),!Pe&&Le&&Le.length>0){const Xe=new Map(Le.map(Ie=>[Ie.user_id,Ie.id]));G.forEach((Ie,Ut)=>{if(!Ie.client_id&&Ie.accepted_by){const Ce=Xe.get(Ie.accepted_by);Ce&&(Ie.client_id=Ce,de.add(Ce),console.log("[DiaryPage] Найден client_id для токена:",Ut,"client_id:",Ce))}}),Le.forEach(Ie=>{we[Ie.id]={first_name:Ie.first_name||void 0,last_name:Ie.last_name||void 0,user_id:Ie.user_id||void 0,phone:Ie.phone||void 0}})}}if(de.size>0){const je=Array.from(de),{data:Le,error:Pe}=await R.from("clients").select("id, first_name, last_name, user_id, phone").in("id",je);console.log("[DiaryPage] Загружено клиентов из БД:",Le?.length||0,"Ошибка:",Pe),!Pe&&Le&&Le.length>0&&Le.forEach(Xe=>{we[Xe.id]={first_name:Xe.first_name||void 0,last_name:Xe.last_name||void 0,user_id:Xe.user_id||void 0,phone:Xe.phone||void 0}})}const Ne=[];G.forEach((je,Le)=>{const Pe=ue.get(Le),Xe=je.client_id;let Ie=Xe?we[Xe]:null;if(!Xe&&Pe?.used_by&&Object.values(we).find(Ge=>Ge.user_id===Pe.used_by)){const Ge=Object.keys(we).find(Yr=>we[Yr].user_id===Pe.used_by);Ge&&(Ie=we[Ge],je.client_id=Ge)}const Ut=je.accepted_at||Pe?.used_at||null,Ce=je.accepted_by||Pe?.used_by||null;Ne.push({invite_id:Pe?.invite_id||`link_${Le}`,token:Le,client_id:Xe||Ce&&Object.keys(we).find(Ve=>we[Ve].user_id===Ce)||null,invited_client_phone:Pe?.invited_client_phone||Ie?.phone||null,invited_client_name:Pe?.invited_client_name||Ie&&`${Ie.first_name||""} ${Ie.last_name||""}`.trim()||null,used_at:Pe?.used_at||null,used_by:Pe?.used_by||null,accepted_at:Ut,accepted_by:Ce,created_at:Pe?.created_at||Ut||new Date().toISOString(),registered_client_name:Ie&&`${Ie.first_name||""} ${Ie.last_name||""}`.trim()||void 0,registered_client_phone:Ie?.phone||void 0,registered_client_user_id:Ie?.user_id||void 0})}),ue.forEach((je,Le)=>{if(!G.has(Le)){let Pe=null,Xe=null;if(je.used_by&&je.used_at){const Ie=Object.values(we).find(Ut=>Ut.user_id===je.used_by);Ie&&(Xe=Object.keys(we).find(Ut=>we[Ut].user_id===je.used_by)||null,Pe=Ie)}Ne.push({invite_id:je.invite_id,token:Le,client_id:Xe,invited_client_phone:je.invited_client_phone||Pe?.phone||null,invited_client_name:je.invited_client_name||Pe&&`${Pe.first_name||""} ${Pe.last_name||""}`.trim()||null,used_at:je.used_at||null,used_by:je.used_by||null,accepted_at:je.used_at||null,accepted_by:je.used_by||null,created_at:je.created_at,registered_client_name:Pe&&`${Pe.first_name||""} ${Pe.last_name||""}`.trim()||void 0,registered_client_phone:Pe?.phone||void 0,registered_client_user_id:Pe?.user_id||void 0})}}),console.log("[DiaryPage] Итоговый список клиентов:",Ne.length),ks(Ne)}else console.log("[DiaryPage] Нет данных о клиентах"),ks([])}catch(d){console.error("Ошибка загрузки приглашенных клиентов:",d),ks([])}})()},[e,y,I,p,ut,dt,f?.organization_id,Ye?.accepted_by]),u.useEffect(()=>{if(!e)return;(async()=>{try{const{data:d,error:N}=await R.from("diary_external_access_links").select("*").eq("diary_id",e).is("revoked_at",null).order("created_at",{ascending:!1});if(N){console.error("Ошибка загрузки внешних ссылок:",N),Ar([]);return}if(d&&d.length>0){const K=d.map(q=>({id:q.id,token:q.link_token,link:`${i}/diaries/${e}?access=${q.link_token}`,invited_email:q.invited_email||null,invited_phone:q.invited_phone||null,expires_at:q.expires_at||null,created_at:q.created_at}));Ar(K)}else Ar([])}catch(d){console.error("Ошибка загрузки внешних ссылок:",d),Ar([])}})()},[e]),u.useEffect(()=>{if(!ma)return;const l=N=>{fa.current&&!fa.current.contains(N.target)&&bs(!1)},d=N=>{N.key==="Escape"&&bs(!1)};return document.addEventListener("mousedown",l),document.addEventListener("keydown",d),()=>{document.removeEventListener("mousedown",l),document.removeEventListener("keydown",d)}},[ma]),u.useEffect(()=>()=>{Rt.current&&(window.clearTimeout(Rt.current),Rt.current=null),Xt.current&&(cancelAnimationFrame(Xt.current),Xt.current=null)},[]);const Al=u.useMemo(()=>{const l=(de,re)=>!!de&&!!re&&String(de)===String(re);if(!f)return{hasBaseAccess:!1,isOwner:!1,isClientAccess:!1,organizationAccountAccess:!1,organizationEmployeeAccess:!1,caregiverAccess:!1,canManageDiarySettings:!1,canEditCardSettings:!1,canManageMetricsSettings:!1,canManageAccessSettings:!1};const d=l(f.owner_id,C);let N=!1;c==="client"?(console.log("[DiaryPage] Проверка доступа клиента:",{diaryId:f.id,diaryClientId:f.client_id,userId:C,organizationClientLink:Ye?.accepted_by}),f.id&&(N=!0,console.log("[DiaryPage] ✅ Клиент имеет доступ через RLS (дневник загружен)")),Ye?.accepted_by===C&&(N=!0,console.log("[DiaryPage] ✅ Клиент имеет доступ через organizationClientLink"))):console.log("[DiaryPage] ⚠️ userRole не является client:",c,"userId:",C);const K=P&&(l(f.organization_id,ut||p)||l(f.organization_id,C)||!f.organization_id&&l(f.owner_id,ut||p)||!f.organization_id&&l(f.owner_id,C)),q=jt.map(de=>de.user_id),ge=vt==="patronage_agency";let G=!1;if(I&&C){const de=jt.find(re=>re.user_id===C);if(de&&(de.role==="admin"||de.role==="manager"))G=!0;else{const re=It.find(we=>we.user_id===C);re&&(re.role==="admin"||re.role==="manager")&&(G=!0)}}const X=!ge||G||(C?q.includes(C):!1),ue=I&&(l(f.organization_id,dt||O||ut||p)||!f.organization_id&&l(f.owner_id,dt||O||ut||p))&&X,ze=(w||!!Jr)&&l(f.caregiver_id,Jr),Oe=d||N||K||ue||ze;return console.log("[DiaryPage] accessState calculation:",{isOwner:d,isClientAccess:N,organizationAccountAccess:K,organizationEmployeeAccess:ue,caregiverAccess:ze,hasBaseAccess:Oe,userRole:c,userId:C,diaryId:f.id,diaryClientId:f.client_id}),{hasBaseAccess:Oe,isOwner:d,isClientAccess:N,organizationAccountAccess:K,organizationEmployeeAccess:ue,caregiverAccess:ze,canManageDiarySettings:d||K,canEditCardSettings:d||N||K,canManageMetricsSettings:d||N||K||ze,canManageAccessSettings:d||N||K}},[f,C,c,p,ut,O,dt,Jr,da,P,I,w,jt,It,_,vt,Ye]),ya=async()=>{if(!(!f||!e))try{const{data:l,error:d}=await R.from("diary_employee_access").select("user_id, revoked_at").eq("diary_id",e);if(d)return console.error("Ошибка загрузки назначенных сотрудников:",d),[];const N=(l||[]).filter(X=>vt==="pension"?!0:!X.revoked_at);if(N.length===0&&vt!=="pension")return[];const K=N.map(X=>X.user_id).filter(Boolean);if(K.length===0&&vt!=="pension")return[];const{data:q,error:ge}=await R.from("organization_employees").select(`
          user_id,
          first_name,
          last_name,
          role,
          organization_id,
          organizations (
            organization_type
          )
        `).in("user_id",K.length>0?K:[]);if(ge)return console.error("Ошибка загрузки данных сотрудников:",ge),[];const G=new Map(N.map(X=>[X.user_id,X.revoked_at]));return(q||[]).map(X=>({user_id:X.user_id,first_name:X.first_name||"",last_name:X.last_name||"",role:X.role||"",organization_type:X.organizations?.organization_type||null,revoked_at:G.get(X.user_id)||null}))}catch(l){return console.error("Ошибка загрузки назначенных сотрудников:",l),[]}};u.useEffect(()=>{if(!f)return;Vn(!1),(async()=>{let d=[];d=await ya()||[];let K=[];if(P||I)try{let G=B(f.organization_id);if(!G)if(I&&dt)G=dt,console.log("[DiaryPage] Using employeeOrganizationId:",G);else if(C){if(I){const{data:X,error:ue}=await R.from("organization_employees").select("organization_id").eq("user_id",C).maybeSingle();!ue&&X?.organization_id&&(G=X.organization_id,console.log("[DiaryPage] Loaded organization_id from organization_employees:",G))}if(!G){const{data:X,error:ue}=await R.from("organizations").select("id").eq("user_id",C).single();!ue&&X?.id?(G=X.id,console.log("[DiaryPage] Loaded organization_id from organizations table:",G)):(G=B(ut||p),console.log("[DiaryPage] Using finalEffectiveOrganizationId/effectiveOrganizationId as fallback:",G))}}else G=B(ut||p);if(G){console.log("[DiaryPage] Loading employees for organization_id:",G);const{data:X,error:ue}=await R.from("organization_employees").select(`
                user_id,
                first_name,
                last_name,
                role,
                organizations!inner (
                  organization_type
                )
              `).eq("organization_id",G);ue?console.error("[DiaryPage] Error loading employees:",ue):X&&(console.log("[DiaryPage] Loaded employees:",X.length),K=X.map(ze=>({user_id:ze.user_id,first_name:ze.first_name||"",last_name:ze.last_name||"",role:ze.role||"",organization_type:ze.organizations?.organization_type||null})))}else console.warn("[DiaryPage] No organization_id found for loading employees");K.length===0&&console.warn("[DiaryPage] Сотрудники не найдены для организации:",{orgId:G,effectiveOrganizationId:p,diaryOrganizationId:f.organization_id,userId:C})}catch(G){console.error("[DiaryPage] Не удалось загрузить сотрудников организации",G),K=[]}Nl(K);let q=null,ge=!1;if((P||I)&&vt==="pension"&&e){const{data:G}=await R.from("diary_employee_access").select("user_id").eq("diary_id",e).limit(1);ge=(G?.length||0)>0}if((P||I)&&vt==="pension"&&d.length===0&&K.length>0&&!ge)d=K,q=K,console.log("[DiaryPage] auto-assign all employees for pension",q);else if((P||I)&&K.length>0){const G=d.filter(X=>K.some(ue=>ue.user_id===X.user_id));G.length!==d.length&&(d=G,q=G,console.log("[DiaryPage] cleaned assignment list",{normalizedAssignments:d}))}if(q)try{if(vt==="pension")for(const G of q)try{await R.rpc("assign_employee_to_diary",{p_diary_id:f.id,p_user_id:G.user_id})}catch(X){console.warn("Не удалось назначить доступ сотруднику:",X)}}catch(G){console.warn("Не удалось сохранить доступ сотрудников организации",G)}As(d),Vn(!0)})()},[f,P,I,_,p,C,e]),u.useEffect(()=>{f&&console.log("[DiaryPage] assignedEmployees changed",jt)},[jt,f]);const Qr=u.useMemo(()=>{const l=new Map;return jt.forEach(d=>{l.set(String(d.user_id),d)}),It.forEach(d=>{const N=String(d.user_id);l.has(N)&&l.set(N,{user_id:d.user_id,first_name:d.first_name,last_name:d.last_name,role:d.role,organization_type:d.organization_type||l.get(N)?.organization_type||null})}),Array.from(l.values())},[jt,It]),{hasBaseAccess:Ss,organizationAccountAccess:hr,organizationEmployeeAccess:Ds,caregiverAccess:qn,canEditCardSettings:Cl,canManageMetricsSettings:Sl,canManageAccessSettings:Dl}=Al,[rr,ba]=u.useState({canEditCard:!1,canManageMetrics:!1,canManageClientAccess:!1,canManageEmployeeAccess:!1});u.useEffect(()=>{(async()=>{if(!a||!I){ba({canEditCard:!1,canManageMetrics:!1,canManageClientAccess:!1,canManageEmployeeAccess:!1});return}try{const[d,N,K,q]=await Promise.all([En(a),dg(a),ug(a),gl(a)]);ba({canEditCard:d,canManageMetrics:q,canManageClientAccess:N,canManageEmployeeAccess:K})}catch(d){console.error("Ошибка проверки прав сотрудника:",d),ba({canEditCard:!1,canManageMetrics:!1,canManageClientAccess:!1,canManageEmployeeAccess:!1})}})()},[a,I]);const St=Cl||I&&rr.canEditCard,it=Sl||I&&rr.canManageMetrics,$t=I?rr.canManageClientAccess||rr.canManageEmployeeAccess:Dl;u.useEffect(()=>{f&&console.log("[DiaryPage] access state",{diaryId:f.id,owner_id:f.owner_id,client_id:f.client_id,organization_id:f.organization_id,caregiver_id:f.caregiver_id,userId:C,effectiveOrganizationId:p,userOrganizationId:O,effectiveCaregiverId:Jr,roles:{isOrganization:y,isOrgEmployee:I,isCaregiver:w,isClient:D},organizationAccountAccess:hr,organizationEmployeeAccess:Ds,caregiverAccess:qn,hasBaseAccess:Ss})},[f,C,p,O,Jr,y,I,w,D,hr,Ds,qn,Ss]);const fr=u.useMemo(()=>[St?{id:"card",label:"Карточка"}:null,it?{id:"metrics",label:"Показатели"}:null,$t?{id:"access",label:"Доступ"}:null].filter(Boolean),[St,it,$t]);u.useEffect(()=>{if(!Br)return;Vr(null),ct(null),console.log("[DiaryPage] Settings modal opened",{sections:fr.map(d=>d.id),canEditCardSettings:St,canManageMetricsSettings:it,canManageAccessSettings:$t}),fr.length>0&&Rn(d=>fr.some(N=>N.id===d)?d:fr[0].id),F&&ur({fullName:F.full_name,dateOfBirth:F.date_of_birth||"",address:F.address||"",diagnoses:Array.isArray(F.diagnoses)?F.diagnoses.join(", "):"",mobility:F.mobility});const l=Array.from(new Set(M.map(d=>d.metric_type)));js(l),ws(M.filter(d=>d.is_pinned).map(d=>d.metric_type).filter(d=>l.includes(d)))},[Br,F,M,fr,St,it,$t]),u.useEffect(()=>{if(!Br)return;const l=document.body.style.overflow;return document.body.style.overflow="hidden",()=>{document.body.style.overflow=l}},[Br]);const wt=Ss,zl=l=>{f&&(console.log("[DiaryPage] persistAssignedEmployees",{diaryId:f.id,next:l}),As(l))},_a=async l=>{if(!f||!e)return;const d=l||qr;if(!d){console.warn("[DiaryPage] handleAddEmployeeAccess: targetId is empty");return}const N=q=>String(q),K=jt.find(q=>N(q.user_id)===N(d));if(K&&!K.revoked_at){l||Cs(""),console.log("[DiaryPage] handleAddEmployeeAccess: already has active access",{targetId:d});return}try{const{error:q}=await R.rpc("assign_employee_to_diary",{p_diary_id:e,p_user_id:d});if(q){console.error("Ошибка назначения доступа:",q),alert(q.message||"Не удалось назначить доступ. Попробуйте позже.");return}const ge=await ya();As(ge||[]),l||Cs(""),ct(null),console.log("[DiaryPage] Доступ сотрудника предоставлен, список обновлен")}catch(q){console.error("Ошибка назначения доступа:",q),alert("Не удалось назначить доступ. Попробуйте позже.")}},Jn=async l=>{if(!(!f||!e||!window.confirm("Убрать доступ у сотрудника к этому дневнику?")))try{const{error:N}=await R.rpc("remove_employee_from_diary",{p_diary_id:e,p_user_id:l});if(N){console.error("Ошибка отзыва доступа:",N),alert("Не удалось отозвать доступ. Попробуйте позже.");return}const K=await ya();As(K||[]),console.log("[DiaryPage] Доступ сотрудника отозван, список обновлен")}catch(N){console.error("Ошибка отзыва доступа:",N),alert("Не удалось отозвать доступ. Попробуйте позже.")}},zs=async l=>{if(!(!f||!e||!window.confirm(l==="caregiver"?"Вы уверены, что хотите отозвать доступ у сиделки?":"Вы уверены, что хотите отозвать доступ у организации?")))try{const N=l==="caregiver"?"caregiver_id":"organization_id",{error:K}=await R.from("diaries").update({[N]:null}).eq("id",e);if(K){console.error("Ошибка отзыва доступа:",K),alert("Не удалось отозвать доступ. Попробуйте позже.");return}if(x({...f,[N]:null}),l==="caregiver")console.log("[DiaryPage] Доступ сиделки отозван, дневник и карточка остаются у клиента");else if(l==="organization"){Wr(null),zl([]);try{const{error:q}=await R.from("diary_client_links").delete().eq("diary_id",e);q&&console.warn("Не удалось удалить ссылку клиента при отзыве доступа организации:",q)}catch(q){console.warn("Не удалось очистить ссылку клиента при удалении доступа организации",q)}er(null),Ft(null)}alert("Доступ успешно отозван")}catch(N){console.error("Ошибка отзыва доступа:",N),alert("Не удалось отозвать доступ. Попробуйте позже.")}};u.useEffect(()=>{if(!a){const K=n.get("client"),q=n.get("access");K?r(`/client-invite?diary=${e}&token=${K}`,{replace:!0}):(q&&(async()=>{try{await R.rpc("register_diary_access_attempt",{p_link_token:q,p_user_id:null,p_user_email:null,p_user_phone:null})}catch(G){console.error("[DiaryPage] Ошибка регистрации попытки принять приглашение:",G)}})(),r("/login"));return}(async()=>{if(e)try{const{data:K,error:q}=await R.from("diaries").select("*").eq("id",e).single();if(q||!K){console.error("Ошибка загрузки дневника:",q),console.error("Детали ошибки:",{code:q?.code,message:q?.message,details:q?.details,hint:q?.hint,userId:a?.id,userRole:c}),(q?.code==="PGRST301"||q?.message?.includes("permission")||q?.message?.includes("access"))&&console.error("Доступ заблокирован RLS. Проверьте has_diary_access для этого дневника."),alert("Не удалось загрузить дневник. Попробуйте позже."),r("/dashboard");return}const ge={id:K.id,owner_id:K.created_by||K.owner_client_id||"",client_id:K.owner_client_id||null,patient_card_id:K.patient_card_id,caregiver_id:K.caregiver_id,organization_id:K.organization_id,organization_type:K.organization_type||_||o.organization_type||null,created_at:K.created_at};if(x(ge),ge.organization_id)try{const{data:G,error:X}=await R.from("organizations").select("id, name, type").eq("id",ge.organization_id).single();Wr(!X&&G?{id:G.id,name:G.name||"Организация",type:G.type}:null)}catch(G){console.error("Ошибка загрузки информации об организации:",G),Wr(null)}else Wr(null);if(ge.patient_card_id){const{data:G,error:X}=await R.from("patient_cards").select("*").eq("id",ge.patient_card_id).single();if(!X&&G){const ue={id:G.id,client_id:G.client_id||"",full_name:G.full_name,date_of_birth:G.date_of_birth,gender:G.gender,diagnoses:Array.isArray(G.diagnoses)?G.diagnoses:[],mobility:G.mobility,address:G.metadata?.address||null};H(ue)}else console.error("Ошибка загрузки карточки:",X),alert("Не удалось загрузить карточку подопечного.")}}catch(K){console.error("Ошибка загрузки дневника:",K),r("/dashboard")}})();const d=async()=>{if(e)try{const{data:K,error:q}=await R.from("diary_metrics").select("*").eq("diary_id",e);if(q)console.error("Ошибка загрузки метрик:",q),L([]),ys({});else{const ge=(K||[]).map(X=>({id:X.id,diary_id:X.diary_id,metric_type:X.metric_key,is_pinned:X.is_pinned,settings:X.metadata?.settings||void 0,metadata:X.metadata||{}}));L(ge);const G={};ge.forEach(X=>{X.settings&&(G[X.metric_type]=pr(X.settings))}),ys(G)}}catch(K){console.error("Ошибка загрузки метрик:",K)}},N=async()=>{if(e)try{const{data:K,error:q}=await R.from("diary_metric_values").select("*").eq("diary_id",e).order("recorded_at",{ascending:!1}).limit(100);if(q)console.error("Ошибка загрузки значений метрик:",q),Z([]);else{const ge=(K||[]).map(X=>{let ue=X.value;return X.value&&typeof X.value=="object"&&"value"in X.value&&(ue=X.value.value),{id:X.id,diary_id:X.diary_id,metric_type:X.metric_key,value:ue,created_at:X.recorded_at||X.created_at}}),G=Dr(ge);Z(G)}}catch(K){console.error("Ошибка загрузки значений метрик:",K)}};d(),N(),ua(new Date)},[e,a,r,n]),u.useEffect(()=>{if(!e||!a)return;const l=n.get("access");if(!l)return;(async()=>{try{console.log("[DiaryPage] Обработка токена доступа к дневнику:",l);const N=a.user_metadata?.user_role||a.user_metadata?.role,K=a.user_metadata?.organization_type;if(!(N==="organization"||N==="org_employee")&&!(K==="caregiver")){if(console.log("[DiaryPage] Пользователь не является организацией, сиделкой или сотрудником, пропускаем обработку токена"),K==="caregiver"){console.log("[DiaryPage] Сиделка еще не создала организацию, регистрируем попытку для обработки после создания профиля");try{await R.rpc("register_diary_access_attempt",{p_link_token:l,p_user_id:a.id,p_user_email:a.email||null,p_user_phone:a.user_metadata?.phone||null})}catch(ue){console.error("[DiaryPage] Ошибка регистрации попытки:",ue)}r("/profile/setup",{replace:!0})}return}const{data:G,error:X}=await R.rpc("accept_diary_access_token",{p_link_token:l});if(X){if(console.error("[DiaryPage] Ошибка привязки дневника по токену:",X),X.message?.includes("Организация не найдена")||X.message?.includes("не удалось определить организацию")){console.log("[DiaryPage] Организация не найдена, регистрируем попытку для обработки после создания профиля");try{await R.rpc("register_diary_access_attempt",{p_link_token:l,p_user_id:a.id,p_user_email:a.email||null,p_user_phone:a.user_metadata?.phone||null})}catch(ue){console.error("[DiaryPage] Ошибка регистрации попытки:",ue)}r("/profile/setup",{replace:!0});return}alert("Ошибка привязки дневника: "+X.message);return}if(G?.success)console.log("[DiaryPage] Дневник успешно привязан:",G),await s.invalidateQueries({queryKey:["dashboard-diaries"]}),alert("Доступ к дневнику получен! Дневник добавлен в ваш список."),r("/dashboard",{replace:!0});else{if(console.error("[DiaryPage] Ошибка привязки дневника:",G?.error),G?.error?.includes("Организация не найдена")||G?.error?.includes("не удалось определить организацию")){console.log("[DiaryPage] Организация не найдена, регистрируем попытку для обработки после создания профиля");try{await R.rpc("register_diary_access_attempt",{p_link_token:l,p_user_id:a.id,p_user_email:a.email||null,p_user_phone:a.user_metadata?.phone||null})}catch(ue){console.error("[DiaryPage] Ошибка регистрации попытки:",ue)}r("/profile/setup",{replace:!0});return}alert("Ошибка привязки дневника: "+(G?.error||"Неизвестная ошибка"))}}catch(N){console.error("[DiaryPage] Ошибка обработки токена доступа:",N),alert("Ошибка обработки токена доступа")}})()},[e,a,n,r]),u.useEffect(()=>{if(!e||!a||!f)return;const l=n.get("client");if(!l)return;(async()=>{try{const{data:N,error:K}=await R.from("diary_client_links").select("*").eq("diary_id",e).eq("token",l).maybeSingle();if(K){console.error("Ошибка проверки приглашения:",K),alert("Ошибка проверки ссылки приглашения"),r(`/diaries/${e}`,{replace:!0});return}if(!N){alert("Ссылка приглашения недействительна или устарела"),r(`/diaries/${e}`,{replace:!0});return}if(N.accepted_by&&N.accepted_by!==a.id){alert("Эта ссылка уже была использована другим пользователем"),r(`/diaries/${e}`,{replace:!0});return}const{data:q,error:ge}=await R.from("clients").select("id").eq("user_id",a.id).single();if(ge||!q){alert("Ошибка: не удалось определить клиента"),r(`/diaries/${e}`,{replace:!0});return}const G=q.id,{error:X}=await R.from("diary_client_links").update({client_id:G,accepted_by:a.id,accepted_at:new Date().toISOString()}).eq("diary_id",e).eq("token",l);if(X){console.error("Ошибка обновления diary_client_links:",X),alert("Ошибка при принятии приглашения"),r(`/diaries/${e}`,{replace:!0});return}const{data:ue,error:ze}=await R.from("diaries").select("*").eq("id",e).single();if(!ze&&ue&&x(ue),ue?.patient_card_id){const{data:de,error:re}=await R.from("patient_cards").select("*").eq("id",ue.patient_card_id).single();!re&&de&&H(de)}const Oe={link:`${i}/client-invite?diary=${e}&token=${l}`,created_at:N.accepted_at||new Date().toISOString(),token:l,diary_id:e,patient_card_id:f.patient_card_id,organization_id:f.organization_id??p??null,accepted_by:a.id,accepted_at:new Date().toISOString(),client_id:G};er(Oe),pa(Oe),alert("Дневник успешно привязан к вашему аккаунту. Вы можете управлять доступом и делиться дневником со специалистами."),r(`/diaries/${e}`,{replace:!0})}catch(N){console.error("Ошибка при принятии приглашения:",N),alert("Ошибка при принятии приглашения"),r(`/diaries/${e}`,{replace:!0})}})()},[e,a,f,n,r,p]);const Kr=l=>{A(d=>({...d,[l]:!d[l]}))},Qn=M.filter(l=>l.is_pinned),Es=l=>{if(l.startsWith("custom_")){const d=M.find(N=>N.metric_type===l);if(d)return(d?.metadata||{}).category||null;if(l.startsWith("custom_care_"))return"care";if(l.startsWith("custom_physical_"))return"physical";if(l.startsWith("custom_excretion_"))return"excretion";if(l.startsWith("custom_symptom_"))return"symptom"}return["walk","cognitive_games","diaper_change","hygiene","skin_moisturizing","meal","medications","vitamins","sleep"].includes(l)?"care":["temperature","blood_pressure","breathing_rate","pain_level","saturation","blood_sugar"].includes(l)?"physical":["urination","defecation"].includes(l)?"excretion":["nausea","vomiting","shortness_of_breath","itching","cough","dry_mouth","hiccups","taste_disturbance"].includes(l)?"symptom":null},Kn=M.filter(l=>!l.is_pinned&&Es(l.metric_type)==="care"),Gn=M.filter(l=>!l.is_pinned&&Es(l.metric_type)==="physical"),Hn=M.filter(l=>!l.is_pinned&&Es(l.metric_type)==="excretion"),Yn=M.filter(l=>!l.is_pinned&&Es(l.metric_type)==="symptom"),Xn=l=>{const d=U.filter(G=>G.metric_type===l).sort((G,X)=>new Date(X.created_at).getTime()-new Date(G.created_at).getTime());if(d.length===0)return null;const N=d[0];if(typeof N.value=="boolean")return N.value?"✓":"✗";const K=String(N.value??"").trim();return K&&K.split(`
`)[0].replace(/\s*\d{1,2}:\d{2}$/,"").trim()||null},El=l=>{if(!l||l.length===0)return"Выберите время";const d=Tn.getHours()*60+Tn.getMinutes(),N=l.map(ns).sort((X,ue)=>X-ue),K=N.find(X=>X>d),q=K!==void 0?K-d:N[0]+lr-d,ge=Math.floor(q/60),G=q%60;return`${String(ge).padStart(2,"0")}:${String(G).padStart(2,"0")}`},Pl=l=>{const d=kr[l];return!d||!d.times?.length?"Выберите время":El(d.times)},va=520,[ei,ja]=u.useState([]);u.useEffect(()=>{(async()=>{if(!e||!Ke){ja([]);return}try{const d=await La(e,Ke);ja(d)}catch(d){console.error("Ошибка загрузки истории для даты:",d),ja([])}})()},[e,Ke]);const ti=u.useMemo(()=>{if(!Ke)return[];const l=Zs(Ke);return Dr([...U,...ei]).filter(N=>{const K=new Date(N.created_at);return K.getFullYear()===l.getFullYear()&&K.getMonth()===l.getMonth()&&K.getDate()===l.getDate()}).map((N,K)=>{let q=new Date(N.created_at).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"}),ge;if(typeof N.value=="string"){const X=N.value.split(" · ").map(ue=>ue.trim()).filter(Boolean);if(X.length>1){const ue=X[X.length-1];/^\d{1,2}:\d{2}$/.test(ue)&&(q=ue.padStart(5,"0"),X.pop())}ge=X.join(" · ")||"--"}else typeof N.value=="boolean"?ge=N.value?"Было":"Не было":ge=`${N.value}`;const G=`${N.id}_${N.metric_type}_${N.created_at}_${K}`;return{...N,label:nt(N.metric_type),time:q,displayValue:ge,uniqueKey:G}})},[U,ei,Ke]),wa=u.useMemo(()=>{const l={};return ti.forEach(d=>{l[d.metric_type]||(l[d.metric_type]={metricType:d.metric_type,label:d.label,items:[]}),l[d.metric_type].items.push(d)}),Object.values(l).sort((d,N)=>d.label.localeCompare(N.label))},[ti]),ri=u.useMemo(()=>({medications:wa.filter(l=>["medications","vitamins"].includes(l.metricType)).map(l=>({...l,items:l.items.sort((d,N)=>new Date(N.created_at).getTime()-new Date(d.created_at).getTime())})),others:wa.filter(l=>!["medications","vitamins"].includes(l.metricType)).map(l=>({...l,items:l.items.sort((d,N)=>new Date(N.created_at).getTime()-new Date(d.created_at).getTime())}))}),[wa]),si=ri.medications,ai=ri.others,ni=u.useMemo(()=>Zs(Ke),[Ke]),Il=u.useMemo(()=>{const d=ni.toLocaleDateString("ru-RU",{weekday:"long",day:"numeric",month:"long",year:"numeric"}).replace(/\s?г\./,"г").replace(/\s?г$/,"г");return d.charAt(0).toUpperCase()+d.slice(1)},[ni]),$l=u.useMemo(()=>{const l=new Date(_t.getFullYear(),_t.getMonth(),1),d=new Date(_t.getFullYear(),_t.getMonth()+1,0).getDate(),N=(l.getDay()+6)%7,K=Math.ceil((N+d)/7)*7,q=Ua(new Date);return Array.from({length:K},(ge,G)=>{const X=new Date(l);X.setDate(X.getDate()+G-N);const ue=Ua(X);return{date:X,key:ue,label:X.getDate(),isCurrentMonth:X.getMonth()===_t.getMonth(),isSelected:ue===Ke,isToday:ue===q}})},[_t,Ke]),Ml=u.useMemo(()=>{const l=_t.toLocaleDateString("ru-RU",{month:"long"}).replace(" г.","");return`${l.charAt(0).toUpperCase()+l.slice(1)} ${_t.getFullYear()}`},[_t]),Na=u.useMemo(()=>{const l=[{id:"diary",label:"Дневник"},{id:"history",label:"История"},{id:"route",label:"Маршрутный лист"}];return(y||I&&rr.canManageClientAccess)&&l.push({id:"client",label:"Клиент"}),D&&l.push({id:"share",label:"Поделиться"}),l},[y,I,rr.canManageClientAccess,D]),Qt=u.useMemo(()=>Na.map(l=>l.id),[Na]),ii=u.useCallback(l=>{if(Qt.length<=1)return;const d=Qt.indexOf(j);if(d===-1)return;const N=l==="next"?d+1:d-1;N<0||N>=Qt.length||v(Qt[N])},[Qt,j]),gr=u.useRef(null),Tl=u.useCallback(l=>{if(Qt.length<=1)return;const d=l.touches[0];gr.current={startX:d.clientX,startY:d.clientY,active:!0}},[Qt.length]),Rl=u.useCallback(l=>{if(!gr.current||!gr.current.active)return;const d=l.touches[0];Math.abs(d.clientY-gr.current.startY)>45&&(gr.current.active=!1)},[]),Fl=u.useCallback(l=>{const d=gr.current;if(gr.current=null,!d||!d.active||Qt.length<=1)return;const K=l.changedTouches[0].clientX-d.startX;Math.abs(K)<60||ii(K<0?"next":"prev")},[ii,Qt.length]),oi=u.useMemo(()=>new Set([..._e.map(l=>l.value),...Vs.map(l=>l.value),...jo.map(l=>l.value),...wo.map(l=>l.value)]),[_e]),li=u.useMemo(()=>Ot.filter(l=>!oi.has(l)),[Ot,oi]),ci=(l,d)=>{Rt.current&&(window.clearTimeout(Rt.current),Rt.current=null),Xt.current&&(cancelAnimationFrame(Xt.current),Xt.current=null),Mn(d),ee(l),Xt.current=requestAnimationFrame(()=>{ne(!0),Xt.current=null})},Ps=()=>{Y&&$n!==null&&xs({type:Y,index:$n,direction:"fromPanel"}),ne(!1),Rt.current&&window.clearTimeout(Rt.current),Rt.current=window.setTimeout(()=>{ee(null),Mn(null),xs(null),Rt.current=null},va)},Ol=(l,d)=>{if(!wt||Ct)return;const N=()=>{d===0?ci(l.metric_type,d):(xs({type:l.metric_type,index:d,direction:"toPanel"}),window.setTimeout(()=>{xs(null),ci(l.metric_type,d)},va))};Y?Y===l.metric_type&&ae?Ps():(Ps(),window.setTimeout(()=>{N()},va)):N()},Is=l=>{wt&&(T({type:l,label:nt(l)}),W(!0))},[Ll,Gr]=u.useState(!1),[We,sr]=u.useState(null),[Lt,ar]=u.useState(null),[Ul,$s]=u.useState(!1),[Bl,ka]=u.useState(!1),[di,Aa]=u.useState(""),[Vl,Ca]=u.useState(!1),[ui,Sa]=u.useState(""),Zl=(l,d)=>{wt&&(sr({type:l,label:nt(l)}),ar(d||null),Gr(!0))},Wl=()=>{Gr(!1),sr(null),ar(null)},ql=async()=>{We&&(Gr(!1),$s(!0))},Ms=async(l,d,N)=>{if(!Lt?.slotId||!Lt?.templateId||!e||!C||!Ke)return console.warn("[DiaryPage] Cannot save route event: missing slot/template/diary info"),!1;const K=await kg({templateId:Lt.templateId,slotId:Lt.slotId,eventDate:Ke,eventFrom:Lt.from,eventTo:Lt.to,status:l,performedBy:C,reason:d||null,createdBy:C});if(K){console.log("[DiaryPage] Route event saved to DB:",K);const q=await bo(e,Ke);return Ur(q),!0}return!1},Jl=async()=>{if(We)try{Lt?.slotId&&await Ms("done"),await Ts(We.type,!0)}finally{$s(!1),sr(null),ar(null)}},Ql=async()=>{if(We)try{Lt?.slotId&&await Ms("not_done","Отмечено как не выполнено"),await Ts(We.type,!1)}finally{$s(!1),sr(null),ar(null)}},Kl=()=>{We&&(Gr(!1),Ca(!0))},Gl=async()=>{if(We){try{Lt?.slotId&&await Ms("not_done",ui||"Не указана причина")}catch(l){console.warn("[DiaryPage] Failed to save cancel event to DB",l)}await Ts(We.type,!1),Ca(!1),Sa(""),sr(null),ar(null)}},mi=()=>{Ca(!1),Sa(""),sr(null),ar(null)},Hl=()=>{We&&(Gr(!1),ka(!0))},Yl=async()=>{if(We){try{Lt?.slotId&&await Ms("rescheduled",di||"Не указана причина")}catch(l){console.warn("[DiaryPage] Failed to save reschedule event to DB",l)}ka(!1),Or(We.type),Jt(!0),Aa(""),sr(null),ar(null)}},hi=()=>{ka(!1),Aa(""),sr(null),ar(null)},Ts=async(l,d)=>{if(e)try{const{data:N,error:K}=await R.rpc("save_metric_value",{p_diary_id:e,p_metric_key:l,p_value:typeof d=="object"?d:{value:d},p_recorded_at:new Date().toISOString(),p_metadata:{}});if(K){console.error("Ошибка сохранения метрики:",K),alert("Не удалось сохранить значение метрики. Попробуйте позже.");return}const q={id:N?.id||`value_${Date.now()}`,diary_id:e,metric_type:l,value:typeof d=="object"?d.value:d,created_at:N?.recorded_at||new Date().toISOString()},ge=Dr([...U,q]);Z(ge),setTimeout(async()=>{try{const G=new Date().toISOString().split("T")[0],X=await La(e,G),{data:ue,error:ze}=await R.from("diary_metric_values").select("*").eq("diary_id",e).order("recorded_at",{ascending:!1}).limit(100);if(!ze&&ue){const Oe=(ue||[]).map(re=>{let we=re.value;return re.value&&typeof re.value=="object"&&"value"in re.value&&(we=re.value.value),{id:re.id,diary_id:re.diary_id,metric_type:re.metric_key,value:we,created_at:re.recorded_at||re.created_at}}),de=Dr([...Oe,...X]);Z(de)}}catch(G){console.error("Ошибка перезагрузки значений:",G)}},500)}catch(N){console.error("Ошибка сохранения метрики:",N)}},fi=async()=>{if(!e||!f?.patient_card_id){alert("Не удалось создать ссылку: отсутствует карточка подопечного");return}try{const l=I?dt||ut||f.organization_id:f.organization_id||p,{data:d,error:N}=await R.rpc("generate_invite_link",{invite_type:"organization_client",payload:{patient_card_id:f.patient_card_id,diary_id:e,organization_id:l}});if(N){console.error("Ошибка создания приглашения клиента:",N),alert("Ошибка создания ссылки: "+N.message);return}if(!d||!d.token){alert("Ошибка создания ссылки: токен не получен");return}const{error:K}=await R.from("diary_client_links").upsert({diary_id:e,client_id:null,token:d.token,accepted_by:null,accepted_at:null},{onConflict:"diary_id"});K&&console.error("Ошибка создания записи в diary_client_links:",K);const q=`${i}/client-invite?diary=${e}&token=${d.token}`,ge=I?dt||ut||f.organization_id:f.organization_id||p,G={link:q,created_at:d.created_at||new Date().toISOString(),token:d.token,diary_id:e,patient_card_id:f.patient_card_id,organization_id:ge??null,accepted_by:null,accepted_at:null};er(G),Ft(null);const{data:X}=await R.from("diary_client_links").select("*").eq("diary_id",e).maybeSingle();if(X){const ue={...G,accepted_by:X.accepted_by,accepted_at:X.accepted_at,client_id:X.client_id};er(ue),pa(ue)}setTimeout(()=>{},500)}catch(l){console.error("Ошибка создания ссылки для клиента:",l),alert("Ошибка создания ссылки")}},Da=async l=>{try{await navigator.clipboard.writeText(l),alert("Ссылка скопирована")}catch(d){console.error("Clipboard error",d),prompt("Скопируйте ссылку вручную",l)}},za=(l,d)=>{const N=`${d}
${l}`,K=`https://wa.me/?text=${encodeURIComponent(N)}`;window.open(K,"_blank","noopener,noreferrer")},Xl=async()=>{if(!(!e||!a))try{const l=crypto.randomUUID(),d=`${i}/diaries/${e}?access=${l}`,{data:N,error:K}=await R.from("diary_external_access_links").insert({diary_id:e,link_token:l,created_by:a.id}).select().single();if(K){console.error("Ошибка создания внешней ссылки:",K),alert("Ошибка создания ссылки: "+K.message);return}const q={id:N.id,token:N.link_token,link:d,invited_email:N.invited_email||null,invited_phone:N.invited_phone||null,expires_at:N.expires_at||null,created_at:N.created_at};Ar([..._s,q])}catch(l){console.error("Ошибка создания внешней ссылки:",l),alert("Ошибка создания ссылки")}},ec=async l=>{if(e)try{const{error:d}=await R.from("diary_external_access_links").update({revoked_at:new Date().toISOString()}).eq("id",l).eq("diary_id",e);if(d){console.error("Ошибка отзыва внешней ссылки:",d),alert("Ошибка отзыва ссылки: "+d.message);return}Ar(_s.filter(N=>N.id!==l))}catch(d){console.error("Ошибка отзыва внешней ссылки:",d),alert("Ошибка отзыва ссылки")}},tc=async(l,d)=>{if(!e)return;const N=d.value!==void 0&&d.value!==null&&String(d.value).trim()!=="";let K=null;if(N){const ge=new Date,G=new Date(ge.getTime()-2e3),X=U.find(ue=>ue.metric_type===l&&String(ue.value)===String(d.value)&&new Date(ue.created_at)>G);if(X)console.log("[DiaryPage] Пропускаем сохранение: обнаружено дублирование значения",{metricType:l,value:d.value,recentValue:X});else try{const{data:ue,error:ze}=await R.rpc("save_metric_value",{p_diary_id:e,p_metric_key:l,p_value:typeof d.value=="object"?d.value:{value:d.value},p_recorded_at:new Date().toISOString(),p_metadata:{}});if(ze){console.error("Ошибка сохранения значения метрики:",ze),alert("Не удалось сохранить значение метрики. Попробуйте позже.");return}K={id:ue?.id||`value_${Date.now()}`,diary_id:e,metric_type:l,value:typeof d.value=="object"?d.value.value:d.value,created_at:ue?.recorded_at||new Date().toISOString()}}catch(ue){console.error("Ошибка сохранения значения метрики:",ue),alert("Не удалось сохранить значение метрики. Попробуйте позже.");return}}const q={frequency:d.frequency,reminderStart:d.reminderStart,reminderEnd:d.reminderEnd,times:d.times};try{const{data:ge,error:G}=await R.from("diary_metrics").select("id, metadata").eq("diary_id",e).eq("metric_key",l).maybeSingle();if(G&&G.code!=="PGRST116")console.error("Ошибка поиска метрики для сохранения настроек:",G);else if(ge){const ue={...ge.metadata||{},settings:pr(q)},{error:ze}=await R.from("diary_metrics").update({metadata:ue}).eq("id",ge.id);ze?(console.error("Ошибка сохранения настроек метрики:",ze),alert("Не удалось сохранить настройки метрики. Попробуйте позже.")):L(Oe=>Oe.map(de=>de.metric_type===l?{...de,settings:pr(q)}:de))}else console.warn("Метрика не найдена для сохранения настроек:",l),alert("Метрика не найдена. Сначала добавьте метрику в дневник.")}catch(ge){console.error("Ошибка сохранения настроек метрики:",ge),alert("Не удалось сохранить настройки метрики. Попробуйте позже.")}if(N&&K){const ge=Dr([...U,K]);Z(ge),setTimeout(async()=>{try{const G=new Date().toISOString().split("T")[0],X=await La(e,G),{data:ue,error:ze}=await R.from("diary_metric_values").select("*").eq("diary_id",e).order("recorded_at",{ascending:!1}).limit(100);if(!ze&&ue){const Oe=(ue||[]).map(re=>{let we=re.value;return re.value&&typeof re.value=="object"&&"value"in re.value&&(we=re.value.value),{id:re.id,diary_id:re.diary_id,metric_type:re.metric_key,value:we,created_at:re.recorded_at||re.created_at}}),de=Dr([...Oe,...X]);Z(de)}}catch(G){console.error("Ошибка перезагрузки значений:",G)}},500)}ys(ge=>({...ge,[l]:pr(q)})),ua(new Date),Y===l&&N&&Ps()},Ea=()=>{wl(!1),Vr(null),ct(null)},Hr=l=>{js(d=>d.includes(l)?(ws(N=>N.filter(K=>K!==l)),d.filter(N=>N!==l)):(ct(null),[...d,l]))},rc=l=>{ws(d=>d.includes(l)?d.filter(N=>N!==l):d.length>=3?(ct("Можно закрепить не более трёх показателей"),d):(ct(null),js(N=>N.includes(l)?N:[...N,l]),[...d,l]))},sc=()=>{if(!(!St||!F)){if(ct(null),!st.fullName.trim()){ct("Введите ФИО подопечного");return}Un(!0);try{const l=JSON.parse(localStorage.getItem("patient_cards")||"[]"),d=st.diagnoses?st.diagnoses.split(",").map(G=>G.trim()).filter(Boolean):[],N=st.mobility==="walks"||st.mobility==="sits"||st.mobility==="lies"?st.mobility:F.mobility,K={...F,full_name:st.fullName.trim(),date_of_birth:st.dateOfBirth?st.dateOfBirth:null,address:st.address?st.address.trim():null,diagnoses:d,mobility:N},q=l.map(G=>G.id===F.id?K:G);localStorage.setItem("patient_cards",JSON.stringify(q));const ge=localStorage.getItem("current_user");if(ge)try{const G=JSON.parse(ge),X={...G,user_metadata:{...G.user_metadata||{},patient_cards:q}};localStorage.setItem("current_user",JSON.stringify(X))}catch(G){console.warn("Не удалось обновить current_user при сохранении карточки",G)}H(K),ur({fullName:K.full_name,dateOfBirth:K.date_of_birth||"",address:K.address||"",diagnoses:K.diagnoses.join(", "),mobility:K.mobility}),Vr("Карточка подопечного обновлена")}catch(l){console.error("Error updating patient card from settings:",l),ct("Не удалось сохранить изменения карточки")}finally{Un(!1)}}},ac=async()=>{if(!it||!e)return;ct(null);const l=Array.from(new Set(Ot));if(l.length===0){ct("Выберите минимум один показатель");return}const d=Ln.filter(N=>l.includes(N));if(d.length>3){ct("Можно закрепить не более трёх показателей");return}ws(d),js(l),ga(!0);try{const{data:N,error:K}=await R.from("diary_metrics").select("*").eq("diary_id",e);if(K){console.error("Ошибка загрузки метрик:",K),ct("Не удалось загрузить показатели"),ga(!1);return}const q=new Map(M.map(re=>[re.metric_type,re])),ge=new Map((N||[]).map(re=>[re.metric_key,re])),G=[];d.forEach(re=>{const we=ge.get(re),je=q.get(re)?.settings||kr[re];G.push({id:we?.id,diary_id:e,metric_key:re,is_pinned:!0,metadata:je?{settings:pr(je)}:void 0})}),l.filter(re=>!d.includes(re)).forEach(re=>{const we=ge.get(re),je=q.get(re)?.settings||kr[re];G.push({id:we?.id,diary_id:e,metric_key:re,is_pinned:!1,metadata:je?{settings:pr(je)}:void 0})});const X=M.map(re=>re.metric_type).filter(re=>!l.includes(re));if(X.length>0){const{error:re}=await R.from("diary_metrics").delete().eq("diary_id",e).in("metric_key",X);re&&console.error("Ошибка удаления метрик:",re)}const ue=G.map(async re=>{if(re.id){const{error:we}=await R.from("diary_metrics").update({is_pinned:re.is_pinned,metadata:re.metadata||{}}).eq("id",re.id);we&&console.error("Ошибка обновления метрики:",we)}else{const{error:we}=await R.from("diary_metrics").insert({diary_id:re.diary_id,metric_key:re.metric_key,is_pinned:re.is_pinned,metadata:re.metadata||{}});we&&console.error("Ошибка создания метрики:",we)}});await Promise.all(ue);const ze={...kr};X.forEach(re=>{ze[re]&&delete ze[re]});const{data:Oe,error:de}=await R.from("diary_metrics").select("*").eq("diary_id",e);if(!de&&Oe){const re=Oe.map(Ne=>({id:Ne.id,diary_id:Ne.diary_id,metric_type:Ne.metric_key,is_pinned:Ne.is_pinned,settings:Ne.metadata?.settings||void 0}));L(re);const we={};re.forEach(Ne=>{Ne.settings&&(we[Ne.metric_type]=pr(Ne.settings))}),ys({...we,...ze})}else console.error("Ошибка перезагрузки метрик:",de),alert("Не удалось обновить метрики. Попробуйте обновить страницу.");Vr("Показатели обновлены")}catch(N){console.error("Error updating diary metrics from settings:",N),ct("Не удалось сохранить показатели")}finally{ga(!1)}};return!f||!F?t.jsx("div",{className:"min-h-screen bg-gray-100 flex items-center justify-center",children:t.jsx("p",{className:"text-gray-600",children:"Загрузка..."})}):!kl&&I&&_==="patronage_agency"?t.jsx("div",{className:"min-h-screen bg-gray-100 flex items-center justify-center",children:t.jsx("p",{className:"text-gray-600",children:"Загрузка доступа..."})}):Ss?t.jsxs("div",{className:"min-h-screen bg-gray-100",children:[t.jsx("header",{className:"bg-white shadow-sm",children:t.jsxs("div",{className:"flex items-center justify-between px-4 py-3",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("button",{onClick:()=>r("/dashboard"),className:"-ml-2 flex items-center justify-center w-6 h-6","aria-label":"Назад",children:t.jsx("img",{src:"/icons/Иконка стрелка.png",alt:"Назад",className:"w-full h-full object-contain"})}),t.jsx("h1",{className:"text-lg font-bold text-gray-dark",children:"Дневник здоровья"})]}),t.jsx("span",{className:"w-9 h-9"})]})}),t.jsx("div",{className:"bg-white border-b border-gray-200",children:t.jsx("div",{className:"flex",role:"tablist","aria-label":"Разделы дневника",children:Na.map(l=>t.jsx("button",{type:"button",onClick:()=>v(l.id),role:"tab","aria-selected":j===l.id,className:`flex-1 py-3.5 text-base font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-[#55ACBF] ${j===l.id?"text-gray-dark border-b-2 border-[#7DD3DC]":"text-gray-400"}`,children:l.label},l.id))})}),t.jsxs("div",{className:"px-4 py-6 max-w-md mx-auto pb-6",onTouchStart:Tl,onTouchMove:Rl,onTouchEnd:Fl,children:[j==="diary"&&t.jsxs("div",{className:"space-y-6",children:[Qn.length>0&&t.jsxs("div",{children:[t.jsx("h2",{className:"text-xl font-bold text-gray-dark mb-4",children:"Закрепленные показатели"}),t.jsxs("div",{className:"relative",children:[t.jsx("div",{className:`grid grid-cols-3 gap-3 transition-opacity duration-300 ${ae?"opacity-0 pointer-events-none":"opacity-100"}`,style:{gap:lt?"8px":"12px"},children:Qn.map((l,d)=>{const K=Xn(l.metric_type)||"--",q=Ct?.type===l.metric_type,G={transform:`translate3d(${q&&(Ct.direction==="toPanel"||Ct.direction==="fromPanel")?Ct.index===1?"calc(-100% - 12px)":Ct.index===2?"calc(-200% - 24px)":"0":"0"}, 0, 0)`,transition:"transform 480ms cubic-bezier(0.2, 0.8, 0.2, 1), opacity 240ms ease",zIndex:q?10:"auto"};return Ct&&Ct.type!==l.metric_type&&(G.opacity=ae?0:1),t.jsxs("button",{onClick:()=>Ol(l,d),className:`bg-gradient-to-br from-[#61B4C6] to-[#317799] rounded-2xl text-white text-center shadow-md flex flex-col items-center w-full min-w-0 ${wt?"":"opacity-60 cursor-not-allowed"}`,style:{fontFamily:"Manrope, sans-serif",padding:lt?"8px":"12px",borderRadius:lt?"12px":"16px",...G},disabled:!wt||!!Ct&&Ct.type!==l.metric_type,children:[t.jsx("div",{className:"text-base font-bold w-full text-center mb-2",style:{fontFamily:"Manrope, sans-serif",fontWeight:700,minHeight:lt?"32px":"38px",lineHeight:"1.1",display:"flex",alignItems:"center",justifyContent:"center",fontSize:lt?"12px":"16px"},children:nt(l.metric_type)}),t.jsx("div",{className:"flex items-center justify-center w-full",style:{height:lt?"70px":"90px"},children:t.jsxs("div",{className:"relative flex items-center justify-center",style:{width:lt?"70px":"90px",height:lt?"70px":"90px",minWidth:lt?"70px":"90px",minHeight:lt?"70px":"90px"},children:[t.jsx("svg",{className:"absolute inset-0 w-full h-full",viewBox:"0 0 90 90",preserveAspectRatio:"xMidYMid meet",children:t.jsx("circle",{cx:"45",cy:"45",r:"38",fill:"none",stroke:"#4A4A4A",strokeWidth:"3",strokeDasharray:"4 4",opacity:"0.9"})}),t.jsx("div",{className:"text-2xl font-bold relative z-10 text-center",style:{fontFamily:"Manrope, sans-serif",fontWeight:700,fontSize:lt?"18px":"24px"},children:K})]})}),t.jsxs("div",{className:"w-full space-y-1.5 mt-2",children:[t.jsx("div",{className:"text-xs opacity-90 text-center",style:{fontFamily:"Manrope, sans-serif",fontWeight:400,fontSize:lt?"10px":"12px"},children:kr[l.metric_type]?.times?.length?`Заполнить через: ${Pl(l.metric_type)}`:"Выберите время"}),t.jsx("div",{className:"w-full text-xs text-white py-1.5 text-center",style:{fontFamily:"Manrope, sans-serif",fontWeight:400,backgroundColor:"#4A4A4A",borderRadius:"12px",fontSize:lt?"10px":"12px",paddingTop:lt?"4px":"6px",paddingBottom:lt?"4px":"6px"},children:"Заполнить"})]})]},l.id)})}),Y&&t.jsx("div",{className:`absolute inset-0 w-full h-full origin-left transition-transform duration-[600ms] cubic-bezier(0.2, 0.8, 0.2, 1) shadow-lg ${ae?"scale-x-100":"scale-x-0"}`,style:{transformOrigin:"left center",zIndex:20},children:t.jsx(Dg,{metricType:Y,metricLabel:nt(Y),lastValue:Xn(Y),onSave:tc,onClose:Ps,initialTimes:kr[Y]?.times},Y)})]})]}),t.jsxs("div",{className:"mt-8",children:[t.jsx("h2",{className:"text-xl font-bold text-gray-dark mb-4",children:"Все показатели"}),Kn.length>0&&t.jsxs("div",{className:"bg-white rounded-3xl shadow-sm mb-4 overflow-hidden",children:[t.jsxs("button",{onClick:()=>Kr("care"),className:"w-full px-6 py-5 flex flex-col items-center justify-center",children:[t.jsx("h3",{className:"text-xl font-bold text-gray-dark text-center mb-2",children:"Показатели ухода"}),t.jsx("p",{className:"text-sm text-gray-500 text-center mb-3",children:"Прогулка, когнитивные игры, гигиена, сон и т.д."}),t.jsx("img",{src:"/icons/иконка маленькая стрелка.png",alt:"Раскрыть",className:`w-4 h-4 transition-transform ${h.care?"-rotate-90":"rotate-90"}`})]}),h.care&&t.jsx("div",{className:"px-5 pb-5 pt-1 border-t border-gray-100",children:t.jsx("div",{className:"grid grid-cols-2 gap-3 mt-4",children:Kn.map(l=>t.jsx("button",{onClick:()=>Is(l.metric_type),disabled:!wt,className:`py-3 px-4 border-2 border-[#7DD3DC] text-gray-dark rounded-2xl font-medium text-sm transition-colors ${wt?"hover:bg-[#7DD3DC] hover:text-white":"opacity-60 cursor-not-allowed"}`,children:nt(l.metric_type)},l.id))})})]}),Gn.length>0&&t.jsxs("div",{className:"bg-white rounded-3xl shadow-sm mb-4 overflow-hidden",children:[t.jsxs("button",{onClick:()=>Kr("physical"),className:"w-full px-6 py-5 flex flex-col items-center justify-center",children:[t.jsx("h3",{className:"text-xl font-bold text-gray-dark text-center mb-2",children:"Физические показатели"}),t.jsx("p",{className:"text-sm text-gray-500 text-center mb-3",children:"Температура, давление, сатурация и т.д."}),t.jsx("img",{src:"/icons/иконка маленькая стрелка.png",alt:"Раскрыть",className:`w-4 h-4 transition-transform ${h.physical?"-rotate-90":"rotate-90"}`})]}),h.physical&&t.jsx("div",{className:"px-5 pb-5 pt-1 border-t border-gray-100",children:t.jsx("div",{className:"grid grid-cols-2 gap-3 mt-4",children:Gn.map(l=>t.jsx("button",{onClick:()=>Is(l.metric_type),disabled:!wt,className:`py-3 px-4 border-2 border-[#7DD3DC] text-gray-dark rounded-2xl font-medium text-sm transition-colors ${wt?"hover:bg-[#7DD3DC] hover:text-white":"opacity-60 cursor-not-allowed"}`,children:nt(l.metric_type)},l.id))})})]}),Hn.length>0&&t.jsxs("div",{className:"bg-white rounded-3xl shadow-sm mb-4 overflow-hidden",children:[t.jsxs("button",{onClick:()=>Kr("excretion"),className:"w-full px-6 py-5 flex flex-col items-center justify-center",children:[t.jsx("h3",{className:"text-xl font-bold text-gray-dark text-center mb-2",children:"Выделение мочи и кала"}),t.jsx("p",{className:"text-sm text-gray-500 text-center mb-3",children:"Выпито/выделено, цвет мочи и дефекация"}),t.jsx("img",{src:"/icons/иконка маленькая стрелка.png",alt:"Раскрыть",className:`w-4 h-4 transition-transform ${h.excretion?"-rotate-90":"rotate-90"}`})]}),h.excretion&&t.jsx("div",{className:"px-5 pb-5 pt-1 border-t border-gray-100",children:t.jsx("div",{className:"grid grid-cols-1 gap-3 mt-4",children:Hn.map(l=>t.jsx("button",{onClick:()=>Is(l.metric_type),disabled:!wt,className:`py-3 px-4 border-2 border-[#7DD3DC] text-gray-dark rounded-2xl font-medium text-sm transition-colors ${wt?"hover:bg-[#7DD3DC] hover:text-white":"opacity-60 cursor-not-allowed"}`,children:nt(l.metric_type)},l.id))})})]}),Yn.length>0&&t.jsxs("div",{className:"bg-white rounded-3xl shadow-sm mb-4 overflow-hidden",children:[t.jsxs("button",{onClick:()=>Kr("symptoms"),className:"w-full px-6 py-5 flex flex-col items-center justify-center",children:[t.jsx("h3",{className:"text-xl font-bold text-gray-dark text-center mb-2",children:"Тягостные симптомы"}),t.jsx("p",{className:"text-sm text-gray-500 text-center mb-3",children:"Рвота, тошнота, зуд, кашель, одышка и т.д."}),t.jsx("img",{src:"/icons/иконка маленькая стрелка.png",alt:"Раскрыть",className:`w-4 h-4 transition-transform ${h.symptoms?"-rotate-90":"rotate-90"}`})]}),h.symptoms&&t.jsx("div",{className:"px-5 pb-5 pt-1 border-t border-gray-100",children:t.jsx("div",{className:"grid grid-cols-2 gap-3 mt-4",children:Yn.map(l=>t.jsx("button",{onClick:()=>Is(l.metric_type),disabled:!wt,className:`py-3 px-4 border-2 border-[#7DD3DC] text-gray-dark rounded-2xl font-medium text-sm transition-colors ${wt?"hover:bg-[#7DD3DC] hover:text-white":"opacity-60 cursor-not-allowed"}`,children:nt(l.metric_type)},l.id))})})]})]}),t.jsxs("div",{className:"mt-6 space-y-3",children:[it&&t.jsx("button",{onClick:()=>r(`/diaries/${e}/edit-metrics`),className:"w-full bg-white rounded-3xl shadow-sm px-5 py-3 text-center",children:t.jsx("h3",{className:"text-base font-bold text-[#7DD3DC]",children:"Изменить показатели"})}),$t&&t.jsxs("div",{className:"bg-white rounded-3xl shadow-sm overflow-hidden",children:[t.jsxs("button",{onClick:()=>Kr("accessManagement"),className:"w-full px-4 py-2 flex flex-col items-center justify-center",children:[t.jsx("h3",{className:"text-sm font-bold text-red-600 text-center mb-1.5",children:"Управление доступом"}),t.jsx("img",{src:"/icons/иконка маленькая стрелка.png",alt:"Раскрыть",className:`w-3 h-3 transition-transform ${h.accessManagement?"-rotate-90":"rotate-90"}`})]}),h.accessManagement&&t.jsxs("div",{className:"px-4 py-3 border-t border-gray-100 space-y-4",children:[vt==="patronage_agency"&&(P||I)&&t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-semibold text-gray-700 mb-2",children:"Добавить специалиста"}),It.filter(l=>!jt.some(d=>d.user_id===l.user_id)).length===0?t.jsx("p",{className:"text-xs text-gray-500",children:"Все специалисты уже имеют доступ или отсутствуют в списке."}):t.jsxs("div",{className:"flex gap-2",children:[t.jsxs("select",{value:qr,onChange:l=>Cs(l.target.value),className:"flex-1 rounded-2xl border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:border-[#7DD3DC] bg-white",children:[t.jsx("option",{value:"",children:"Выберите специалиста"}),It.filter(l=>!jt.some(d=>d.user_id===l.user_id)).map(l=>t.jsxs("option",{value:l.user_id,children:[`${l.first_name||""} ${l.last_name||""}`.trim()||l.user_id," ",l.role?`(${l.role})`:""]},l.user_id))]}),t.jsx("button",{onClick:()=>_a(),disabled:!qr,className:"px-4 py-2 rounded-2xl bg-gradient-to-r from-[#7DD3DC] to-[#5CBCC7] text-white text-sm font-semibold disabled:opacity-60 disabled:cursor-not-allowed transition-opacity",children:"Добавить"})]})]}),t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-semibold text-gray-700 mb-2",children:"Специалисты с доступом:"}),Qr.length===0?t.jsx("p",{className:"text-sm text-gray-500",children:"Нет назначенных специалистов"}):t.jsx("div",{className:"space-y-2",children:Qr.map(l=>t.jsxs("div",{className:"flex items-center justify-between py-2 border-b border-gray-100",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-gray-800",children:`${l.first_name||""} ${l.last_name||""}`.trim()||l.user_id}),l.role&&t.jsx("p",{className:"text-xs text-gray-500",children:l.role})]}),t.jsx("button",{onClick:()=>Jn(l.user_id),className:"text-red-600 hover:text-red-700 text-lg","aria-label":"Удалить доступ специалиста",children:"🗑️"})]},l.user_id))})]})]}),vt==="pension"&&(P||I)&&It.length>0&&t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-semibold text-gray-700 mb-2",children:"Добавить специалиста"}),It.filter(l=>!jt.some(d=>d.user_id===l.user_id)).length===0?t.jsx("p",{className:"text-xs text-gray-500",children:"Все специалисты уже имеют доступ или отсутствуют в списке."}):t.jsxs("div",{className:"flex gap-2",children:[t.jsxs("select",{value:qr,onChange:l=>Cs(l.target.value),className:"flex-1 rounded-2xl border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:border-[#7DD3DC] bg-white",children:[t.jsx("option",{value:"",children:"Выберите специалиста"}),It.filter(l=>!jt.some(d=>d.user_id===l.user_id)).map(l=>t.jsxs("option",{value:l.user_id,children:[`${l.first_name||""} ${l.last_name||""}`.trim()||l.user_id," ",l.role?`(${l.role})`:""]},l.user_id))]}),t.jsx("button",{onClick:()=>_a(),disabled:!qr,className:"px-4 py-2 rounded-2xl bg-gradient-to-r from-[#7DD3DC] to-[#5CBCC7] text-white text-sm font-semibold disabled:opacity-60 disabled:cursor-not-allowed transition-opacity",children:"Добавить"})]})]}),t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-semibold text-gray-700 mb-2",children:"Сотрудники организации"}),t.jsx("div",{className:"space-y-2",children:It.map(l=>{let d=!0;return vt==="pension"?d=!jt.find(K=>K.user_id===l.user_id&&K.revoked_at):d=Qr.some(N=>N.user_id===l.user_id),t.jsxs("div",{className:"flex items-center justify-between py-2 border-b border-gray-100",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-gray-800",children:`${l.first_name||""} ${l.last_name||""}`.trim()||l.user_id}),l.role&&t.jsx("p",{className:"text-xs text-gray-500",children:l.role}),d&&t.jsx("p",{className:"text-xs text-green-600 mt-1",children:"✓ Доступ предоставлен"}),!d&&t.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"Нет доступа"})]}),d?t.jsx("button",{onClick:()=>Jn(l.user_id),className:"text-red-600 hover:text-red-700 text-lg","aria-label":"Удалить доступ специалиста",title:"Убрать доступ",children:"🗑️"}):t.jsx("button",{onClick:()=>_a(l.user_id),className:"text-[#7DD3DC] hover:text-[#5CBCC7] text-lg","aria-label":"Добавить доступ специалиста",title:"Добавить доступ",children:"➕"})]},`pension-${l.user_id}`)})}),t.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"Вы можете добавлять и убирать доступ у сотрудников пансионата."})]})]}),t.jsxs("div",{className:"space-y-3",children:[t.jsx("p",{className:"text-sm font-semibold text-gray-700",children:"Текущий доступ"}),hr&&t.jsxs("div",{className:"py-2 border-b border-gray-100",children:[t.jsx("p",{className:"text-sm text-gray-800",children:"Организация (этот аккаунт)"}),t.jsx("p",{className:"text-xs text-gray-500",children:f?.organization_id?`ID: ${f.organization_id}`:"ID не указан"})]}),Ds&&!hr&&t.jsxs("div",{className:"py-2 border-b border-gray-100",children:[t.jsx("p",{className:"text-sm text-gray-800",children:"Сотрудник организации"}),t.jsxs("p",{className:"text-xs text-gray-500",children:["Доступ предоставлен организацией (ID: ",f?.organization_id||"—",")"]})]}),vt==="patronage_agency"&&hr&&Qr.length===0&&t.jsx("p",{className:"text-xs text-gray-500",children:"Нет назначенных специалистов"}),vt==="pension"&&hr&&It.length===0&&t.jsx("p",{className:"text-xs text-gray-500",children:"Все сотрудники пансионата имеют доступ к дневнику автоматически."}),f?.caregiver_id&&t.jsxs("div",{className:"flex items-center justify-between py-2 border-b border-gray-100",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-gray-800",children:"Частная сиделка"}),t.jsxs("p",{className:"text-xs text-gray-500",children:["ID: ",f.caregiver_id]})]}),$t&&t.jsx("button",{onClick:()=>zs("caregiver"),className:"text-red-600 hover:text-red-700 text-lg","aria-label":"Удалить доступ сиделки",children:"🗑️"})]}),f?.organization_id&&$t&&t.jsxs("div",{className:"flex items-center justify-between py-2 border-b border-gray-100",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-gray-800",children:Zr?.name||"Организация"}),t.jsxs("p",{className:"text-xs text-gray-500",children:[Zr?.type==="patronage_agency"?"Патронажное агентство":Zr?.type==="pension"?"Пансионат":"Организация",Zr?.id&&` (ID: ${Zr.id})`]})]}),t.jsx("button",{onClick:()=>zs("organization"),className:"text-red-600 hover:text-red-700 text-lg","aria-label":"Удалить доступ организации",title:"Отвязать дневник от организации",children:"🗑️"})]}),!f?.organization_id&&!f?.caregiver_id&&(_!=="patronage_agency"||Qr.length===0)&&t.jsx("p",{className:"text-sm text-gray-500 text-center",children:"Нет активных доступов"}),!$t&&!hr&&!Ds&&t.jsx("p",{className:"text-xs text-gray-500 text-center",children:"У вас нет прав для изменения доступа"})]})]})]})]})]}),j==="history"&&t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"relative",ref:fa,children:[t.jsxs("div",{className:"bg-white rounded-[32px] shadow-[0_14px_35px_rgba(9,109,131,0.08)] px-6 py-6 text-center space-y-3",children:[t.jsx("p",{className:"text-xs text-[#4A4A4A] uppercase tracking-wide",children:"Нажмите, чтобы выбрать дату истории заполнения"}),t.jsx("button",{onClick:()=>bs(l=>!l),className:"w-full","aria-label":"Выбрать дату",children:t.jsxs("div",{className:"relative bg-gradient-to-b from-[#F6FEFF] via-[#F0FBFD] to-[#E6F8FA] border border-[#C5EEF2] rounded-[28px] px-5 py-4 shadow-[0_12px_30px_rgba(9,109,131,0.08)]",children:[t.jsx("p",{className:"text-[20px] font-semibold text-[#0A6D83]",children:Il}),t.jsx("p",{className:"text-xs text-[#7BA0A6] mt-1",children:"Отчёт будет построен за этот день"})]})})]}),ma&&t.jsx("div",{className:"absolute left-0 right-0 mt-4 z-30",children:t.jsxs("div",{className:"bg-white rounded-[32px] shadow-[0_26px_45px_rgba(9,109,131,0.18)] px-6 py-6",children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsx("button",{onClick:()=>ha(new Date(_t.getFullYear(),_t.getMonth()-1,1)),className:"p-2 rounded-full bg-[#F3FBFD] text-[#0A6D83] hover:bg-[#E8F7FA] transition","aria-label":"Предыдущий месяц",children:"‹"}),t.jsx("div",{className:"text-[#0A6D83] font-semibold text-base",children:Ml}),t.jsx("button",{onClick:()=>ha(new Date(_t.getFullYear(),_t.getMonth()+1,1)),className:"p-2 rounded-full bg-[#F3FBFD] text-[#0A6D83] hover:bg-[#E8F7FA] transition","aria-label":"Следующий месяц",children:"›"})]}),t.jsx("div",{className:"grid grid-cols-7 gap-2 text-xs font-semibold text-[#7BA0A6] mb-3",children:["ПН","ВТ","СР","ЧТ","ПТ","СБ","ВС"].map(l=>t.jsx("div",{className:"text-center uppercase tracking-wide",children:l},l))}),t.jsx("div",{className:"grid grid-cols-7 gap-2",children:$l.map(l=>t.jsx("button",{onClick:()=>{jl(l.key),ha(new Date(l.date.getFullYear(),l.date.getMonth(),1)),bs(!1)},className:`h-10 w-10 rounded-full flex items-center justify-center text-sm transition ${l.isSelected?"bg-gradient-to-r from-[#7DD3DC] to-[#5CBCC7] text-white shadow-md":l.isCurrentMonth?"text-[#0A6D83]":"text-[#B6C9CD]"} ${l.isToday&&!l.isSelected?"border border-[#7DD3DC]":""}`,"aria-label":`Выбрать ${l.key}`,children:l.label},`${l.key}-${l.label}`))}),t.jsx("div",{className:"flex justify-center mt-4",children:t.jsx("div",{className:"w-0 h-0 border-l-[12px] border-r-[12px] border-l-transparent border-r-transparent border-t-white"})})]})})]}),t.jsxs("div",{className:"bg-[#E8F9FB] rounded-[32px] px-5 py-6 space-y-6",children:[t.jsxs("div",{children:[t.jsx("h3",{className:"text-base font-semibold text-[#4A4A4A] mb-3",children:"Принятые лекарства и витамины"}),t.jsx("div",{className:"bg-white/85 rounded-[24px] px-4 py-4 space-y-2",children:si.length>0?si.map(l=>t.jsxs("div",{className:"space-y-2",children:[t.jsx("p",{className:"text-xs font-semibold text-[#0A6D83] uppercase tracking-wide pl-1",children:l.label}),l.items.map((d,N)=>t.jsxs("div",{className:"bg-white border border-[#7DD3DC] rounded-full px-4 py-2 text-sm text-[#4A4A4A] flex items-center justify-between gap-3",children:[t.jsx("span",{className:"flex-1 whitespace-normal break-words leading-tight",children:d.displayValue&&d.displayValue!=="--"?d.displayValue:d.label}),t.jsx("span",{className:"text-xs text-[#0A6D83] font-semibold whitespace-nowrap self-center",children:d.time})]},d.uniqueKey||`${d.id}_${d.metric_type}_${d.created_at}_${N}`))]},l.metricType)):t.jsx("p",{className:"text-sm text-[#7BA0A6] text-center",children:"Нет записей за эту дату"})})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-base font-semibold text-[#4A4A4A] mb-3",children:"Отчёт за сегодня"}),t.jsx("div",{className:"bg-white/85 rounded-[24px] px-4 py-4 space-y-2",children:ai.length>0?ai.map(l=>t.jsxs("div",{className:"space-y-2",children:[t.jsx("p",{className:"text-xs font-semibold text-[#0A6D83] uppercase tracking-wide pl-1",children:l.label}),l.items.map((d,N)=>t.jsxs("div",{className:"bg-white border border-[#7DD3DC] rounded-full px-4 py-2 text-sm text-[#4A4A4A] flex items-center justify-between gap-3",children:[t.jsx("span",{className:"flex-1 whitespace-normal break-words leading-tight",children:d.displayValue&&d.displayValue!=="--"?d.displayValue:""}),t.jsx("span",{className:"text-xs text-[#0A6D83] font-semibold whitespace-nowrap self-center",children:d.time})]},d.uniqueKey||`${d.id}_${d.metric_type}_${d.created_at}_${N}`))]},l.metricType)):t.jsx("p",{className:"text-sm text-[#7BA0A6] text-center",children:"Нет записей за эту дату"})})]})]})]}),j==="route"&&t.jsxs("div",{className:"space-y-6",children:[(!dr||dr.length===0)&&t.jsx("div",{className:"bg-white rounded-[20px] shadow-[0_12px_30px_rgba(9,109,131,0.06)] px-6 py-5",children:t.jsx("p",{className:"text-sm text-[#4A4A4A] leading-relaxed",children:"Маршрутный лист показывает, какие манипуляции нужно выполнять с подопечным, когда и с какой периодичностью (ежедневно, раз в неделю). Можно составить вручную или воспользоваться ИИ, который предложит готовый вариант на основе дневника динамики ухода. С маршрутным листом легко согласовать, изменить и отслеживать выполнение всех процедур."})}),t.jsx("h2",{className:"text-2xl font-bold text-gray-dark",children:"Настроить маршрутный лист"}),dr&&dr.length>0&&t.jsxs("div",{className:"bg-white rounded-3xl shadow-sm mb-4 overflow-hidden p-4",children:[t.jsx("h2",{className:"text-xl font-bold text-gray-dark mb-3 text-center",children:"Манипуляции на сегодня"}),t.jsx("div",{className:"max-w-md mx-auto",children:t.jsx("div",{className:"border rounded-lg overflow-hidden",children:Array.from({length:14}).map((l,d)=>{const N=7+d,K=dr.filter(q=>Math.floor(q.startMinutes/60)===N);return t.jsxs("div",{className:"flex items-start gap-3 py-2 px-3 border-b last:border-b-0",children:[t.jsxs("div",{className:"w-16 text-sm text-gray-500",children:[String(N).padStart(2,"0"),":00"]}),t.jsx("div",{className:"flex-1 min-h-[40px]",children:K.length===0?t.jsx("div",{className:"text-xs text-gray-300",children:" "}):t.jsx("div",{className:"flex flex-col gap-2",children:K.map(q=>{const G=(()=>{if(!q.status)return{bg:"bg-[#CFF6F8]",text:"text-[#0A6D83]",btnBg:"bg-[#2AA6B1]",btnText:"Заполнить"};switch(q.status){case"done":return{bg:"bg-green-100",text:"text-green-800",btnBg:"bg-green-600",btnText:"✓ Выполнено"};case"not_done":return{bg:"bg-red-100",text:"text-red-800",btnBg:"bg-red-500",btnText:"✗ Не выполнено"};case"rescheduled":return{bg:"bg-yellow-100",text:"text-yellow-800",btnBg:"bg-yellow-600",btnText:"↻ Перенесено"};case"cancelled":return{bg:"bg-gray-200",text:"text-gray-600",btnBg:"bg-gray-500",btnText:"Отменено"};case"missed":return{bg:"bg-orange-100",text:"text-orange-800",btnBg:"bg-orange-500",btnText:"Просрочено"};default:return{bg:"bg-[#CFF6F8]",text:"text-[#0A6D83]",btnBg:"bg-[#2AA6B1]",btnText:"Заполнить"}}})(),X=q.status==="done"||q.status==="not_done"||q.status==="cancelled";return t.jsxs("div",{className:`inline-flex items-center justify-between ${G.bg} ${G.text} rounded-md px-3 py-2 shadow-sm`,children:[t.jsxs("div",{className:"flex flex-col",children:[t.jsx("div",{className:"text-sm font-semibold",children:q.label}),t.jsxs("div",{className:`text-xs ${G.text} opacity-80`,children:[q.from,q.from!==q.to?` — ${q.to}`:""]}),q.reason&&t.jsxs("div",{className:`text-xs ${G.text} opacity-70 mt-1`,children:["Причина: ",q.reason]})]}),X?t.jsx("span",{className:`ml-3 text-xs ${G.btnBg} text-white rounded-md px-2 py-1`,children:G.btnText}):t.jsx("button",{onClick:()=>Zl(q.metric,{slotId:q.slotId,templateId:q.templateId,from:q.from,to:q.to}),className:`ml-3 text-xs text-white ${G.btnBg} rounded-md px-2 py-1`,children:G.btnText})]},`${q.metric}_${q.from}`)})})})]},N)})})}),t.jsx("div",{className:"mt-4 flex justify-center",children:t.jsx("button",{type:"button",onClick:()=>fe(!0),className:"px-8 py-2.5 rounded-full bg-[#4A4A4A] text-white text-sm font-semibold shadow-sm hover:opacity-90 transition-opacity",children:"Изменить"})})]}),(!dr||dr.length===0)&&t.jsxs("div",{className:"bg-white rounded-2xl shadow-sm p-6",children:[t.jsx("p",{className:"text-base text-gray-700 mb-6",children:"Добавьте манипуляции вручную или с помощью ИИ"}),t.jsxs("div",{className:"flex flex-col items-center gap-3",children:[t.jsx("button",{type:"button",onClick:()=>Q(!0),className:"px-6 py-2 rounded-full bg-[#4A4A4A] text-white text-sm font-semibold shadow-sm hover:opacity-90",children:"Добавить"}),t.jsx("button",{type:"button",onClick:()=>Q(!0),className:"px-6 py-2 rounded-full bg-gradient-to-r from-[#0A6D83] to-[#2A9DB0] text-white text-sm font-semibold shadow-sm hover:opacity-90",children:"Добавить с ИИ"})]})]})]}),b&&t.jsxs("div",{className:"fixed inset-0 z-50",children:[t.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:()=>Q(!1)}),t.jsx("div",{className:"absolute left-0 right-0 bottom-0 mx-auto w-full max-w-3xl",children:t.jsxs("div",{className:"bg-white rounded-t-3xl shadow-lg p-4 pb-6 max-h-[80vh] overflow-auto transform transition-transform duration-200 ease-out",children:[t.jsx("div",{className:"w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-3"}),t.jsxs("div",{className:"flex items-center justify-center mb-2 text-center relative",children:[t.jsx("h3",{className:"text-3xl font-black text-[#25ADB8]",children:"Выбор манипуляций"}),t.jsx("button",{onClick:()=>Q(!1),"aria-label":"Закрыть",className:"text-2xl absolute right-0",children:"×"})]}),t.jsx("p",{className:"text-sm text-gray-600 mb-4 text-center border-t border-gray-100 pt-4",children:"Чтобы выбрать манипуляции, которые необходимо выполнять специалисту, выберите их, укажите дни, по которым нужно проводить а также порядок выполнения."}),t.jsx("h3",{className:"text-2xl font-black text-[#4A4A4A] text-center mb-5",children:"Манипуляции ухода"}),t.jsx("div",{className:"grid grid-cols-2 gap-3",children:_e.map(l=>t.jsxs("div",{className:"relative",children:[t.jsx("button",{onClick:()=>me(l.value),className:`w-full py-3 px-4 rounded-xl shadow-sm border border-[#25ACB7] text-sm font-medium text-center ${ye.includes(l.value)?"bg-[#CFF6F8] border-[#0A6D83]":"bg-white border-gray-200"}`,children:l.label}),!xe.current.has(l.value)&&t.jsx("button",{onClick:d=>{d.stopPropagation(),$e(l.value)},"aria-label":`Удалить ${l.label}`,className:"absolute top-1 right-1 text-xs text-red-500 bg-white rounded-full w-6 h-6 flex items-center justify-center shadow-sm",title:"Удалить",children:"×"})]},l.value))}),t.jsxs("div",{className:"mt-6 w-full flex items-center gap-3",children:[t.jsx("input",{value:Ee,onChange:l=>Ae(l.target.value),onKeyDown:be,className:"flex-1 rounded-xl border border-gray-200 px-6 py-2.5 text-lg text-gray-700 bg-white shadow-inner",placeholder:"Добавить показатель","aria-label":"Добавить показатель"}),t.jsx("button",{onClick:ie,disabled:!Ee.trim(),className:`w-12 h-12 rounded-xl text-white flex items-center justify-center ${Ee.trim()?"bg-[#2AA6B1]":"bg-gray-300 cursor-not-allowed"} shadow-md`,"aria-label":"Добавить",children:"+"})]}),t.jsxs("div",{className:"mt-6",children:[t.jsx("h3",{className:"text-2xl font-black text-[#4A4A4A] text-center mb-5",children:"Физические манипуляции"}),t.jsx("div",{className:"grid grid-cols-2 gap-3 mb-4",children:kt.map(l=>t.jsxs("div",{className:"relative",children:[t.jsx("button",{onClick:()=>me(l.value),className:`w-full py-3 px-4 rounded-xl shadow-sm border border-[#25ACB7] text-sm font-medium text-center ${ye.includes(l.value)?"bg-[#CFF6F8] border-[#0A6D83]":"bg-white border-gray-200"}`,children:l.label}),!At.current.has(l.value)&&t.jsx("button",{onClick:d=>{d.stopPropagation(),Me(l.value)},"aria-label":`Удалить ${l.label}`,className:"absolute top-1 right-1 text-xs text-red-500 bg-white rounded-full w-6 h-6 flex items-center justify-center shadow-sm",title:"Удалить",children:"×"})]},l.value))}),t.jsxs("div",{className:"mt-2 w-full flex items-center gap-3",children:[t.jsx("input",{value:m,onChange:l=>S(l.target.value),onKeyDown:le,className:"flex-1 rounded-xl border border-gray-200 px-6 py-2.5 text-lg text-gray-700 bg-white shadow-inner",placeholder:"Добавить показатель","aria-label":"Добавить показатель"}),t.jsx("button",{onClick:V,disabled:!m.trim(),className:`w-12 h-12 rounded-xl text-white flex items-center justify-center ${m.trim()?"bg-[#2AA6B1]":"bg-gray-300 cursor-not-allowed"} shadow-md`,"aria-label":"Добавить",children:"+"})]})]}),t.jsx("div",{className:"mt-6",children:t.jsx("div",{className:"flex justify-center",children:t.jsx("button",{onClick:()=>{if(!ye||ye.length===0){alert("Выберите манипуляцию");return}Or([...ye]),Q(!1),Jt(!0)},className:"px-20 py-4 rounded-2xl bg-[#55ACBF] text-white",children:"Выбрать"})})})]})})]}),E&&t.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:[t.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:()=>fe(!1)}),t.jsx("div",{className:"relative w-full max-w-md",children:t.jsxs("div",{className:"bg-white rounded-3xl shadow-lg p-6 max-h-[80vh] overflow-auto transform transition-transform duration-200 ease-out",children:[t.jsxs("div",{className:"flex items-center justify-center mb-4 text-center relative",children:[t.jsx("h3",{className:"text-2xl font-black text-[#25ADB8]",children:"Редактировать манипуляции"}),t.jsx("button",{onClick:()=>fe(!1),"aria-label":"Закрыть",className:"text-2xl absolute right-0 text-gray-400 hover:text-gray-600",children:"×"})]}),t.jsx("p",{className:"text-sm text-gray-600 mb-6 text-center",children:"Выберите манипуляцию для редактирования"}),t.jsx("div",{className:"space-y-4",children:yl?t.jsx("p",{className:"text-sm text-gray-500 text-center py-8",children:"Загрузка..."}):gs.length===0?t.jsx("p",{className:"text-sm text-gray-500 text-center py-8",children:"Нет настроенных манипуляций"}):t.jsx("div",{className:"space-y-2",children:gs.map(l=>{const d=l.metric_type||"",N=Yt[d];return t.jsx("button",{onClick:()=>{Or([d]),fe(!1),Jt(!0)},className:"w-full py-3 px-4 rounded-xl bg-white border-2 border-[#25ACB7] text-left hover:bg-[#CFF6F8] transition-colors",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx("p",{className:"text-sm font-semibold text-gray-800",children:l.title}),t.jsx("p",{className:"text-xs text-gray-500 mt-1",children:N?`${N.days?.length||0} дней, ${N.times?.length||0} времён`:"Не настроено"})]}),t.jsx("svg",{className:"w-5 h-5 text-[#25ACB7]",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})})]})},l.id)})})}),t.jsxs("div",{className:"mt-6 flex justify-center gap-3",children:[t.jsx("button",{onClick:()=>fe(!1),className:"px-8 py-3 rounded-2xl bg-gray-200 text-[#4A4A4A] font-semibold",children:"Отмена"}),t.jsx("button",{onClick:()=>{fe(!1),Q(!0)},className:"px-8 py-3 rounded-2xl bg-[#4A4A4A] text-white font-semibold",children:"Добавить манипуляции"})]})]})})]}),j==="client"&&(y||I&&rr.canManageClientAccess)&&t.jsxs("div",{className:"space-y-5",children:[!Ye?.accepted_by&&t.jsxs("div",{className:"bg-white rounded-3xl shadow-sm p-6 space-y-3",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-dark text-center",children:"Поделитесь дневником с клиентом"}),t.jsx("p",{className:"text-sm text-gray-600 text-center",children:"Отправьте ссылку клиенту, чтобы он получил доступ к карточке подопечного и дневнику. Ссылка сохранится в его личном кабинете."})]}),(Ns.length>0||Ye)&&t.jsxs("div",{className:"bg-white rounded-3xl shadow-sm p-5 space-y-3",children:[t.jsx("h3",{className:"text-sm font-semibold text-gray-700 mb-3",children:"Приглашенные клиенты"}),Ns.length===0&&Ye&&t.jsx("p",{className:"text-xs text-gray-500 mb-3",children:"Есть активная ссылка, но список приглашений пуст. Создайте новую ссылку для приглашения клиента."}),Ns.length>0&&t.jsx("div",{className:"space-y-2",children:Ns.map(l=>{const d=!!(l.accepted_at||l.used_at)&&!!(l.accepted_by||l.used_by||l.client_id),N=l.registered_client_name||l.invited_client_name||"Клиент",K=l.registered_client_phone||l.invited_client_phone||null,q=l.accepted_at||l.used_at;return console.log("[DiaryPage] Статус клиента:",{token:l.token,isRegistered:d,accepted_at:l.accepted_at,used_at:l.used_at,accepted_by:l.accepted_by,used_by:l.used_by,client_id:l.client_id,registrationDate:q,clientName:N}),t.jsx("div",{className:"flex items-center justify-between py-3 px-3 border border-gray-100 rounded-2xl bg-gray-50",children:t.jsxs("div",{className:"flex-1",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[t.jsx("p",{className:"text-sm font-semibold text-gray-800",children:N}),d&&t.jsx("span",{className:"inline-flex items-center rounded-full bg-green-100 text-green-700 text-xs font-semibold px-2 py-0.5",children:"✓ Зарегистрирован"}),!d&&l.used_at&&t.jsx("span",{className:"inline-flex items-center rounded-full bg-yellow-100 text-yellow-700 text-xs font-semibold px-2 py-0.5",children:"⚠ Использован"}),!d&&!l.used_at&&t.jsx("span",{className:"inline-flex items-center rounded-full bg-gray-100 text-gray-600 text-xs font-semibold px-2 py-0.5",children:"Ожидает"})]}),K&&t.jsx("p",{className:"text-xs text-gray-500 mb-1",children:K}),d&&q&&t.jsxs("p",{className:"text-xs text-gray-400",children:["Подключен ",new Date(q).toLocaleDateString("ru-RU",{day:"2-digit",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})]}),!d&&l.created_at&&t.jsxs("p",{className:"text-xs text-gray-400",children:["Приглашение отправлено ",new Date(l.created_at).toLocaleDateString("ru-RU",{day:"2-digit",month:"long",year:"numeric"})]})]})},l.invite_id)})})]}),Ye?t.jsxs("div",{className:"bg-white rounded-3xl shadow-sm p-5 space-y-3",children:[t.jsxs("div",{className:"text-xs text-gray-400",children:["Ссылка создана"," ",new Date(Ye.created_at).toLocaleDateString("ru-RU",{day:"2-digit",month:"long",year:"numeric"})]}),Ye.accepted_by?t.jsxs("div",{className:"text-xs text-green-600",children:["Клиент подключил дневник"," ",Ye.accepted_at?new Date(Ye.accepted_at).toLocaleString("ru-RU",{day:"2-digit",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"}):""]}):t.jsx("div",{className:"text-xs text-[#7BA0A6]",children:"После перехода по ссылке дневник привяжется к аккаунту клиента, и он сможет управлять доступом."}),!Ye.accepted_by&&t.jsx("div",{className:"bg-gray-100 rounded-2xl px-3 py-2 text-sm text-gray-700 break-all",children:Ye.link}),Ye.accepted_by&&tr?t.jsxs("div",{className:"border border-gray-100 rounded-2xl px-4 py-3 space-y-3 bg-[#F8FEFF]",children:[t.jsxs("div",{className:"flex items-start justify-between gap-3",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-semibold text-gray-800",children:`${tr.first_name||""} ${tr.last_name||""}`.trim()||"Клиент"}),tr.phone&&t.jsx("p",{className:"text-xs text-gray-500",children:tr.phone})]}),t.jsx("span",{className:"inline-flex items-center rounded-full bg-[#E3F6F8] text-[#0A6D83] text-xs font-semibold px-3 py-1",children:"Клиент подключен"})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx("p",{className:"text-xs text-gray-500",children:"Скопируйте ссылку, чтобы клиент мог быстро войти в свой аккаунт."}),t.jsx("div",{className:"bg-white rounded-2xl px-3 py-2 text-sm text-gray-700 break-all border border-[#CDEBF0]",children:`${i}/login?client_id=${tr.user_id}`}),t.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row",children:[t.jsx(oe,{onClick:()=>Da(`${i}/login?client_id=${tr.user_id}`),fullWidth:!0,children:"Скопировать ссылку входа"}),t.jsx(oe,{variant:"outline",onClick:()=>za(`${i}/login?client_id=${tr.user_id}`,"Здравствуйте! Вот ссылка для входа в ваш дневник:"),fullWidth:!0,children:"Отправить в WhatsApp"})]})]})]}):null,!Ye.accepted_by&&t.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row",children:[t.jsx(oe,{onClick:()=>Da(Ye.link),fullWidth:!0,children:"Скопировать ссылку"}),t.jsx(oe,{variant:"outline",onClick:()=>za(Ye.link,"Здравствуйте! Мы подготовили доступ к дневнику вашего близкого. Перейдите по ссылке:"),fullWidth:!0,children:"Отправить в WhatsApp"})]}),t.jsx("p",{className:"text-xs text-gray-400",children:"При необходимости вы можете сгенерировать новую ссылку — старая станет недействительной."}),t.jsx(oe,{variant:"secondary",onClick:fi,className:"w-full",children:"Создать новую ссылку"})]}):t.jsxs("div",{className:"bg-white rounded-3xl shadow-sm p-6 text-center space-y-4",children:[t.jsx("p",{className:"text-sm text-gray-600",children:"Пока ссылка не создана. Нажмите кнопку ниже, чтобы сформировать персональную ссылку для клиента."}),t.jsx(oe,{onClick:fi,children:"Создать ссылку"})]})]}),j==="share"&&D&&t.jsxs("div",{className:"space-y-5",children:[t.jsxs("div",{className:"bg-white rounded-3xl shadow-sm p-6 space-y-3",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-dark text-center",children:"Поделитесь доступом к дневнику"}),t.jsx("p",{className:"text-sm text-gray-600 text-center leading-relaxed",children:"Отправьте ссылку сиделке или доверенному человеку, чтобы они могли заполнять и просматривать дневник. После перехода по ссылке дневник появится у них в списке, пока вы не отмените доступ."})]}),t.jsxs("div",{className:"bg-white rounded-3xl shadow-sm p-5 space-y-4",children:[t.jsx(oe,{onClick:Xl,fullWidth:!0,children:"Создать ссылку для сиделки"}),_s.length===0?t.jsx("p",{className:"text-sm text-gray-500 text-center",children:"Активных ссылок пока нет — создайте первую, чтобы поделиться доступом с сиделкой."}):t.jsx("div",{className:"space-y-4",children:_s.sort((l,d)=>new Date(d.created_at).getTime()-new Date(l.created_at).getTime()).map(l=>t.jsxs("div",{className:"border border-gray-100 rounded-2xl px-4 py-3 space-y-3",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("span",{className:"text-xs text-gray-400",children:["Создано"," ",new Date(l.created_at).toLocaleDateString("ru-RU",{day:"2-digit",month:"long",year:"numeric"})]}),t.jsx("button",{onClick:()=>ec(l.id),className:"text-sm text-red-500 hover:text-red-600",children:"Отменить доступ"})]}),t.jsx("div",{className:"bg-gray-100 rounded-2xl px-3 py-2 text-sm text-gray-700 break-all",children:l.link}),t.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row",children:[t.jsx(oe,{onClick:()=>Da(l.link||""),fullWidth:!0,children:"Скопировать"}),t.jsx(oe,{variant:"outline",onClick:()=>za(l.link||"","Я делюсь доступом к дневнику подопечного. Перейдите по ссылке:"),fullWidth:!0,children:"Отправить в WhatsApp"})]})]},l.id))})]})]})]}),Br&&t.jsxs("div",{className:"fixed inset-0 z-50 flex items-end justify-center bg-black/40 backdrop-blur-[2px]",children:[t.jsx("div",{className:"absolute inset-0",onClick:Ea}),t.jsxs("div",{className:"relative w-full max-w-md bg-white rounded-t-[32px] px-5 pt-6 pb-8 max-h-[90vh] overflow-y-auto",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("h2",{className:"text-lg font-bold text-gray-dark",children:"Настройки дневника"}),t.jsx("button",{onClick:Ea,className:"w-9 h-9 rounded-full flex items-center justify-center bg-gray-100 text-gray-600","aria-label":"Закрыть окно настроек",type:"button",children:"✕"})]}),fr.length>1&&t.jsx("div",{className:"flex gap-2 mt-5",children:fr.map(l=>t.jsx("button",{onClick:()=>{Rn(l.id),ct(null),Vr(null)},type:"button",className:`flex-1 rounded-2xl py-2 text-sm font-semibold transition-colors ${vs===l.id?"bg-gradient-to-r from-[#7DD3DC] to-[#5CBCC7] text-white shadow-md":"bg-gray-100 text-gray-600"}`,children:l.label},l.id))}),Fn&&t.jsx("div",{className:"mt-4 rounded-2xl bg-[#E6F7F9] text-[#0A6D83] text-sm px-4 py-3",children:Fn}),On&&t.jsx("div",{className:"mt-4 rounded-2xl bg-red-50 text-red-600 text-sm px-4 py-3",children:On}),vs==="card"&&t.jsxs("div",{className:"mt-5 space-y-4",children:[!St&&t.jsx("p",{className:"text-sm text-gray-500",children:"Только владелец дневника может редактировать карточку подопечного."}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"text-xs uppercase tracking-wide text-gray-500",children:"ФИО"}),t.jsx(he,{value:st.fullName,onChange:l=>ur(d=>({...d,fullName:l.target.value})),disabled:!St||mr,className:"mt-1"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-xs uppercase tracking-wide text-gray-500",children:"Дата рождения"}),t.jsx(he,{type:"date",value:st.dateOfBirth,onChange:l=>ur(d=>({...d,dateOfBirth:l.target.value})),disabled:!St||mr,className:"mt-1"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-xs uppercase tracking-wide text-gray-500",children:"Адрес"}),t.jsx(he,{value:st.address,onChange:l=>ur(d=>({...d,address:l.target.value})),disabled:!St||mr,className:"mt-1"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-xs uppercase tracking-wide text-gray-500",children:"Диагнозы"}),t.jsx("textarea",{value:st.diagnoses,onChange:l=>ur(d=>({...d,diagnoses:l.target.value})),disabled:!St||mr,placeholder:"Перечислите через запятую",className:"mt-1 w-full rounded-2xl border border-gray-200 px-4 py-3 text-sm focus:border-[#7DD3DC] focus:outline-none min-h-[72px]"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-xs uppercase tracking-wide text-gray-500",children:"Мобильность"}),t.jsx("select",{value:st.mobility,onChange:l=>ur(d=>({...d,mobility:l.target.value==="walks"||l.target.value==="sits"||l.target.value==="lies"?l.target.value:d.mobility})),disabled:!St||mr,className:"mt-1 w-full rounded-2xl border border-gray-200 px-4 py-3 text-sm focus:border-[#7DD3DC] focus:outline-none bg-white",children:$g.map(l=>t.jsx("option",{value:l.value,children:l.label},l.value))})]})]}),St&&t.jsx("button",{type:"button",onClick:sc,disabled:mr,className:"w-full rounded-2xl bg-gradient-to-r from-[#7DD3DC] to-[#5CBCC7] text-white font-semibold py-3 shadow-md disabled:opacity-60 disabled:cursor-not-allowed transition-opacity",children:mr?"Сохранение...":"Сохранить изменения"})]}),vs==="metrics"&&t.jsxs("div",{className:"mt-5 space-y-5",children:[!it&&t.jsx("p",{className:"text-sm text-gray-500",children:"Только владелец или организация могут изменять список показателей."}),t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-semibold text-gray-dark",children:"Показатели ухода"}),t.jsx("div",{className:"space-y-2 mt-2",children:_e.map(l=>{const d=Ot.includes(l.value);return t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("label",{className:"flex items-center gap-3 text-sm text-gray-700",children:[t.jsx("input",{type:"checkbox",className:"w-4 h-4 accent-[#55ACBF]",checked:d,onChange:()=>Hr(l.value),disabled:!it}),l.label]}),it&&!xe.current.has(l.value)&&t.jsx("button",{onClick:()=>$e(l.value),className:"text-red-500 text-sm px-2 py-1","aria-label":`Удалить ${l.label}`,title:"Удалить",children:"🗑"})]},l.value)})})]}),t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-semibold text-gray-dark",children:"Физические показатели"}),t.jsx("div",{className:"space-y-2 mt-2",children:Vs.map(l=>{const d=Ot.includes(l.value);return t.jsxs("label",{className:"flex items-center gap-3 text-sm text-gray-700",children:[t.jsx("input",{type:"checkbox",className:"w-4 h-4 accent-[#55ACBF]",checked:d,onChange:()=>Hr(l.value),disabled:!it}),l.label]},l.value)})})]}),t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-semibold text-gray-dark",children:"Выделение мочи и кала"}),t.jsx("div",{className:"space-y-2 mt-2",children:jo.map(l=>{const d=Ot.includes(l.value);return t.jsxs("label",{className:"flex items-center gap-3 text-sm text-gray-700",children:[t.jsx("input",{type:"checkbox",className:"w-4 h-4 accent-[#55ACBF]",checked:d,onChange:()=>Hr(l.value),disabled:!it}),l.label]},l.value)})})]}),t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-semibold text-gray-dark",children:"Тягостные симптомы"}),t.jsx("div",{className:"space-y-2 mt-2",children:wo.map(l=>{const d=Ot.includes(l.value);return t.jsxs("label",{className:"flex items-center gap-3 text-sm text-gray-700",children:[t.jsx("input",{type:"checkbox",className:"w-4 h-4 accent-[#55ACBF]",checked:d,onChange:()=>Hr(l.value),disabled:!it}),l.label]},l.value)})})]}),li.length>0&&t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-semibold text-gray-dark",children:"Пользовательские показатели"}),t.jsx("div",{className:"space-y-2 mt-2",children:li.map(l=>{const d=Ot.includes(l);return t.jsxs("label",{className:"flex items-center gap-3 text-sm text-gray-700",children:[t.jsx("input",{type:"checkbox",className:"w-4 h-4 accent-[#55ACBF]",checked:d,onChange:()=>Hr(l),disabled:!it}),nt(l)]},l)})})]})]}),t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-semibold text-gray-dark",children:"Закрепленные показатели (до 3)"}),t.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:Ot.length===0?t.jsx("p",{className:"text-xs text-gray-500",children:"Сначала выберите показатели выше."}):Ot.map(l=>{const d=Ln.includes(l);return t.jsx("button",{type:"button",onClick:()=>rc(l),disabled:!it,className:`px-3 py-1.5 rounded-full text-xs font-semibold transition-colors ${d?"bg-gradient-to-r from-[#7DD3DC] to-[#5CBCC7] text-white shadow-md":"bg-gray-100 text-gray-600"} ${it?"":"cursor-not-allowed opacity-60"}`,children:nt(l)},l)})})]}),it&&t.jsx("button",{type:"button",onClick:ac,disabled:Bn,className:"w-full rounded-2xl bg-gradient-to-r from-[#7DD3DC] to-[#5CBCC7] text-white font-semibold py-3 shadow-md disabled:opacity-60 disabled:cursor-not-allowed transition-opacity",children:Bn?"Сохранение...":"Сохранить показатели"})]}),vs==="access"&&t.jsxs("div",{className:"mt-5 space-y-4",children:[!$t&&t.jsx("p",{className:"text-sm text-gray-500",children:"Управлять доступом может только владелец дневника."}),t.jsxs("div",{className:"rounded-2xl bg-[#F5FBFC] px-4 py-4 space-y-2",children:[t.jsx("p",{className:"text-sm font-semibold text-gray-dark",children:"Сиделка"}),t.jsx("p",{className:"text-sm text-gray-600",children:f.caregiver_id?`Доступ предоставлен (ID: ${f.caregiver_id})`:"Сиделка не привязана"}),f.caregiver_id&&$t&&t.jsx("button",{type:"button",onClick:()=>zs("caregiver"),className:"text-sm font-semibold text-red-600 hover:text-red-700",children:"Отозвать доступ сиделки"})]}),t.jsxs("div",{className:"rounded-2xl bg-[#F5FBFC] px-4 py-4 space-y-2",children:[t.jsx("p",{className:"text-sm font-semibold text-gray-dark",children:"Организация"}),t.jsx("p",{className:"text-sm text-gray-600",children:f.organization_id?`Доступ предоставлен (ID: ${f.organization_id})`:"Организация не привязана"}),f.organization_id&&$t&&t.jsx("button",{type:"button",onClick:()=>zs("organization"),className:"text-sm font-semibold text-red-600 hover:text-red-700",children:"Отозвать доступ организации"})]}),t.jsx("p",{className:"text-xs text-gray-500",children:"Чтобы выдать доступ, поделитесь ссылкой во вкладке «Поделиться» или отправьте приглашение из раздела «Клиент»."})]}),t.jsx("button",{type:"button",onClick:Ea,className:"mt-6 w-full rounded-2xl bg-gray-200 text-gray-700 font-semibold py-3 hover:bg-gray-300 transition-colors",children:"Закрыть"})]})]}),ot&&Pt&&t.jsx(_l,{isOpen:ot,metric:Pt,onClose:()=>Jt(!1),onSave:bl}),Ll&&We&&t.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[t.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:Wl}),t.jsxs("div",{className:"relative bg-white rounded-2xl w-80 max-w-full p-6 text-center shadow-lg",children:[t.jsx("h3",{className:"text-2xl font-bold text-[#25ADB8] mb-2",children:We.label}),t.jsx("p",{className:"text-sm text-gray-700 mb-4",children:"Выберите действие"}),t.jsxs("div",{className:"space-y-3",children:[t.jsx("button",{onClick:ql,className:"w-full py-2 rounded-md bg-[#2AA6B1] text-white font-semibold",children:"Задача выполнена"}),t.jsx("button",{onClick:Hl,className:"w-full py-2 rounded-md bg-[#FB923C] text-white font-semibold",children:"Перенести задачу"}),t.jsx("button",{onClick:Kl,className:"w-full py-2 rounded-md bg-[#EF4444] text-white font-semibold",children:"Задача не выполнена"})]})]})]}),Ul&&We&&t.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[t.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:()=>$s(!1)}),t.jsxs("div",{className:"relative bg-white rounded-2xl w-80 max-w-full p-6 text-center shadow-lg",children:[t.jsx("h3",{className:"text-2xl font-bold text-[#25ADB8] mb-2",children:We.label}),t.jsxs("p",{className:"text-sm text-gray-700 mb-4",children:["Отметьте, состоялась ли ",We.label.toLowerCase()," у подопечного"]}),t.jsxs("div",{className:"flex gap-3 justify-center",children:[t.jsx("button",{onClick:Jl,className:"px-4 py-2 rounded-full bg-[#2AA6B1] text-white font-semibold",children:"Было"}),t.jsx("button",{onClick:Ql,className:"px-4 py-2 rounded-full bg-white border border-[#D1E8EA] text-gray-700 font-semibold",children:"Не было"})]})]})]}),Bl&&We&&t.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[t.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:hi}),t.jsxs("div",{className:"relative bg-white rounded-2xl w-80 max-w-full p-6 text-center shadow-lg",children:[t.jsx("h3",{className:"text-2xl font-bold text-[#25ADB8] mb-2",children:We.label}),t.jsx("p",{className:"text-sm text-gray-700 mb-4",children:"Напишите причину переноса манипуляции"}),t.jsx("textarea",{value:di,onChange:l=>Aa(l.target.value),placeholder:"Напишите причину",className:"w-full mb-4 p-3 border rounded-md text-sm resize-none h-24"}),t.jsxs("div",{className:"flex gap-3 justify-center",children:[t.jsx("button",{onClick:Yl,className:"px-4 py-2 rounded-full bg-[#2AA6B1] text-white font-semibold",children:"Сохранить"}),t.jsx("button",{onClick:hi,className:"px-4 py-2 rounded-full bg-white border border-[#D1E8EA] text-gray-700 font-semibold",children:"Отмена"})]})]})]}),Vl&&We&&t.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[t.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:mi}),t.jsxs("div",{className:"relative bg-white rounded-2xl w-80 max-w-full p-6 text-center shadow-lg",children:[t.jsx("h3",{className:"text-2xl font-bold text-[#25ADB8] mb-2",children:We.label}),t.jsx("p",{className:"text-sm text-gray-700 mb-4",children:"Напишите причину отмены задачи"}),t.jsx("textarea",{value:ui,onChange:l=>Sa(l.target.value),placeholder:"Напишите причину",className:"w-full mb-4 p-3 border rounded-md text-sm resize-none h-24"}),t.jsxs("div",{className:"flex gap-3 justify-center",children:[t.jsx("button",{onClick:Gl,className:"px-4 py-2 rounded-full bg-[#2AA6B1] text-white font-semibold",children:"Сохранить"}),t.jsx("button",{onClick:mi,className:"px-4 py-2 rounded-full bg-white border border-[#D1E8EA] text-gray-700 font-semibold",children:"Отмена"})]})]})]}),z&&t.jsx(Rg,{isOpen:J,metricType:z.type,metricLabel:z.label,onClose:()=>{W(!1),T(null)},onSave:l=>{Ts(z.type,l)}})]}):t.jsx("div",{className:"min-h-screen bg-gray-100 flex items-center justify-center px-4",children:t.jsxs("div",{className:"bg-white rounded-3xl shadow-sm px-6 py-8 text-center max-w-xs",children:[t.jsx("h2",{className:"text-lg font-bold text-gray-dark mb-2",children:"Нет доступа"}),t.jsx("p",{className:"text-sm text-gray-500",children:"У вас нет прав для просмотра этого дневника. Обратитесь к владельцу для получения доступа."})]})})},Og=[{value:"walk",label:"Прогулка"},{value:"cognitive_games",label:"Когнитивные игры"},{value:"diaper_change",label:"Смена подгузников"},{value:"hygiene",label:"Гигиена"},{value:"skin_moisturizing",label:"Увлажнение кожи"},{value:"meal",label:"Прием пищи"},{value:"medications",label:"Прием лекарств"},{value:"vitamins",label:"Прием витаминов"},{value:"sleep",label:"Сон"}],Lg=[{value:"temperature",label:"Температура"},{value:"blood_pressure",label:"Артериальное давление"},{value:"breathing_rate",label:"Частота дыхания"},{value:"pain_level",label:"Уровень боли"},{value:"saturation",label:"Сатурация"},{value:"blood_sugar",label:"Уровень сахара в крови"}],Ug=[{value:"urination",label:"Выпито/выделено и цвет мочи"},{value:"defecation",label:"Дефекация"}],Bg=[{value:"nausea",label:"Тошнота"},{value:"vomiting",label:"Рвота"},{value:"shortness_of_breath",label:"Одышка"},{value:"itching",label:"Зуд"},{value:"cough",label:"Кашель"},{value:"dry_mouth",label:"Сухость во рту"},{value:"hiccups",label:"Икота"},{value:"taste_disturbance",label:"Нарушение вкуса"}],Vg=[{value:"care",label:"Уход"},{value:"physical",label:"Физические"},{value:"excretion",label:"Выделения"},{value:"symptom",label:"Симптомы"}],Zg=()=>{const{id:e}=Po(),r=rt(),{user:s}=Se(),[a,n]=u.useState([]),[i,o]=u.useState([]),[c,g]=u.useState([]),[_,y]=u.useState(!1),[D,w]=u.useState(!1),[I,P]=u.useState(""),[C,B]=u.useState("care");u.useEffect(()=>{if(!s||!e){r("/login");return}(async()=>{if(!s){r("/login");return}try{if(!await gl(s)){alert("У вас нет прав на редактирование показателей дневника"),r(`/diaries/${e}`);return}}catch(j){console.error("Ошибка проверки прав доступа:",j),alert("Ошибка проверки прав доступа"),r(`/diaries/${e}`);return}})(),(async()=>{if(e)try{const{data:j,error:v}=await R.from("diary_metrics").select("id, metric_key, is_pinned, metadata").eq("diary_id",e);if(v){console.error("Ошибка загрузки метрик:",v),n([]),o([]),g([]);return}if(!j||j.length===0){n([]),o([]),g([]);return}const z=[],T=[],J=[];j.forEach(W=>{const h=W.metric_key;if(h.startsWith("custom_")||W.metadata&&typeof W.metadata=="object"&&"is_custom"in W.metadata){const Y=W.metadata?.label||h.replace("custom_",""),ee=W.metadata?.category||"care";J.push({id:h,diary_id:e,label:Y,category:ee}),W.is_pinned?z.push(h):T.push(h)}else W.is_pinned?z.push(h):T.push(h)}),n(z),o(T),g(J)}catch(j){console.error("Ошибка загрузки метрик:",j),n([]),o([]),g([])}})()},[e,s,r]);const O=U=>{n(Z=>Z.includes(U)?Z.filter(j=>j!==U):Z.length<3?[...Z,U]:Z)},$=U=>{o(Z=>Z.includes(U)?Z.filter(j=>j!==U):[...Z,U])},p=()=>{if(!e)return;const U=I.trim();if(!U)return;const Z=`custom_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,j={id:Z,diary_id:e,label:U,category:C};g(v=>[...v,j]),o(v=>[...new Set([...v,Z])]),P("")},k=async()=>{if(e){if(I.trim()&&(p(),await new Promise(U=>setTimeout(U,150))),a.length===0&&i.length===0){alert("Необходимо выбрать хотя бы один показатель");return}try{const{data:U,error:Z}=await R.from("diary_metrics").select("*").eq("diary_id",e);if(Z){console.error("Ошибка загрузки метрик:",Z),alert("Не удалось загрузить показатели. Попробуйте позже.");return}const j=new Map((U||[]).map(J=>[J.metric_key,J])),v=Array.from(new Set([...a,...i])),z=[];a.forEach(J=>{const W=j.get(J),h=c.find(A=>A.id===J);z.push({id:W?.id,diary_id:e,metric_key:J,is_pinned:!0,metadata:h?{label:h.label,category:h.category,is_custom:!0,...W?.metadata&&typeof W.metadata=="object"?{settings:W.metadata.settings}:{}}:W?.metadata||{}})}),i.forEach(J=>{const W=j.get(J),h=c.find(A=>A.id===J);z.push({id:W?.id,diary_id:e,metric_key:J,is_pinned:!1,metadata:h?{label:h.label,category:h.category,is_custom:!0,...W?.metadata&&typeof W.metadata=="object"?{settings:W.metadata.settings}:{}}:W?.metadata||{}})});const T=Array.from(j.keys()).filter(J=>!v.includes(J));if(T.length>0){const{error:J}=await R.from("diary_metrics").delete().eq("diary_id",e).in("metric_key",T);J&&console.error("Ошибка удаления метрик:",J)}if(z.length>0){const J=z.map(async W=>{if(W.id){const{error:h}=await R.from("diary_metrics").update({is_pinned:W.is_pinned,metadata:W.metadata||{}}).eq("id",W.id);if(h)throw console.error("Ошибка обновления метрики:",h),h}else{const{error:h}=await R.from("diary_metrics").insert({diary_id:W.diary_id,metric_key:W.metric_key,is_pinned:W.is_pinned,metadata:W.metadata||{}});if(h)throw console.error("Ошибка создания метрики:",h),h}});try{await Promise.all(J)}catch(W){console.error("Ошибка сохранения метрик:",W),W?.code==="42501"||W?.message?.includes("permission")||W?.message?.includes("policy")?alert("У вас нет прав на редактирование показателей этого дневника. Обратитесь к владельцу для получения доступа."):alert("Ошибка при сохранении показателей. Попробуйте позже.");return}}alert("Показатели успешно обновлены"),setTimeout(()=>{r(`/diaries/${e}`)},500)}catch(U){console.error("Ошибка сохранения метрик:",U),alert("Ошибка при сохранении показателей. Попробуйте позже.")}}},f=(U,Z)=>{let j="px-4 py-2 rounded-full text-sm font-semibold transition-all duration-200 ";return Z?j+="bg-gray-200 text-gray-400 border border-gray-200 cursor-not-allowed":U?j+="bg-gradient-to-r from-[#7DD3DC] to-[#5CBCC7] text-white shadow border border-transparent":j+="bg-white text-[#4A4A4A] border-2 border-gray-300 hover:border-[#7DD3DC]",j},x=(U,Z,j,v)=>t.jsx("div",{className:"flex flex-wrap gap-2",children:U.map(z=>{const T=Z.includes(z.value),J=v?.isDisabled?v.isDisabled(z.value,T):!1;return t.jsx("button",{type:"button",onClick:()=>{J||j(z.value)},className:f(T,J),disabled:J,children:z.label},z.value)})}),F=[...Og,...c.filter(U=>U.category==="care").map(U=>({value:U.id,label:U.label}))],H=[...Lg,...c.filter(U=>U.category==="physical").map(U=>({value:U.id,label:U.label}))],M=[...Ug,...c.filter(U=>U.category==="excretion").map(U=>({value:U.id,label:U.label}))],L=[...Bg,...c.filter(U=>U.category==="symptom").map(U=>({value:U.id,label:U.label}))];return t.jsxs("div",{className:"min-h-screen bg-gray-100 pb-24",children:[t.jsx("header",{className:"bg-white shadow-sm sticky top-0 z-10",children:t.jsx("div",{className:"flex items-center justify-between px-4 py-3",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("button",{onClick:()=>r(`/diaries/${e}`),className:"-ml-2 flex items-center justify-center w-6 h-6","aria-label":"Назад",children:t.jsx("img",{src:"/icons/Иконка стрелка.png",alt:"Назад",className:"w-full h-full object-contain"})}),t.jsx("h1",{className:"text-lg font-bold text-gray-dark",children:"Изменить показатели"})]})})}),t.jsxs("div",{className:"px-4 py-6 max-w-md mx-auto",children:[t.jsx("div",{className:"mb-6",children:t.jsxs("div",{className:"bg-gradient-to-r from-[#7DD3DC] to-[#5CBCC7] rounded-3xl p-6 shadow-md",children:[t.jsx("h2",{className:"text-xl font-bold text-[#4A4A4A] mb-3 text-center",children:"Закрепленные показатели"}),t.jsx("p",{className:"text-sm text-[#4A4A4A] mb-4 text-center",children:"Выберите до 3-х показателей для быстрого доступа"}),t.jsxs(oe,{variant:"outline",className:"w-full !bg-[#4A4A4A] !text-white !border-none",onClick:()=>y(!0),children:["Изменить (",a.length,"/3)"]})]})}),t.jsx("div",{className:"mb-6",children:t.jsxs("div",{className:"bg-white rounded-3xl p-6 shadow-md border-2 border-gray-300",children:[t.jsx("h2",{className:"text-xl font-bold text-gray-dark mb-3 text-center",children:"Все показатели"}),t.jsx("p",{className:"text-sm text-gray-600 mb-4 text-center",children:"Выберите остальные показатели для отслеживания"}),t.jsxs(oe,{variant:"outline",className:"w-full",onClick:()=>w(!0),children:["Изменить (",i.length,")"]})]})}),t.jsx(oe,{onClick:k,disabled:a.length===0&&i.length===0,className:"w-full",children:"Сохранить изменения"})]}),t.jsx(ea,{isOpen:_,onClose:()=>y(!1),title:"Закрепленные показатели",children:t.jsxs("div",{className:"space-y-6",children:[t.jsxs("p",{className:"text-sm text-[#4A4A4A] text-center",children:["Выберите до 3-х показателей для быстрого доступа (",a.length,"/3)"]}),t.jsxs("div",{className:"space-y-5",children:[t.jsxs("div",{children:[t.jsx("h3",{className:"text-sm font-semibold text-[#4A4A4A] mb-2",children:"Показатели ухода"}),x(F,a,O,{isDisabled:(U,Z)=>!Z&&a.length>=3})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-sm font-semibold text-[#4A4A4A] mb-2",children:"Физические показатели"}),x(H,a,O,{isDisabled:(U,Z)=>!Z&&a.length>=3})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-sm font-semibold text-[#4A4A4A] mb-2",children:"Выделение мочи и кала"}),x(M,a,O,{isDisabled:(U,Z)=>!Z&&a.length>=3})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-sm font-semibold text-[#4A4A4A] mb-2",children:"Тягостные симптомы"}),x(L,a,O,{isDisabled:(U,Z)=>!Z&&a.length>=3})]})]}),t.jsx(oe,{onClick:()=>{I.trim()&&p(),y(!1)},className:"w-full",children:"Сохранить"})]})}),t.jsx(ea,{isOpen:D,onClose:()=>w(!1),title:"Все показатели",children:t.jsxs("div",{className:"space-y-6",children:[t.jsxs("p",{className:"text-sm text-[#4A4A4A] text-center",children:["Выберите показатели для отслеживания (",i.length,")"]}),t.jsxs("div",{className:"space-y-5",children:[t.jsxs("div",{children:[t.jsx("h3",{className:"text-sm font-semibold text-[#4A4A4A] mb-2",children:"Показатели ухода"}),x(F,i,$,{isDisabled:U=>a.includes(U)})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-sm font-semibold text-[#4A4A4A] mb-2",children:"Физические показатели"}),x(H,i,$,{isDisabled:U=>a.includes(U)})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-sm font-semibold text-[#4A4A4A] mb-2",children:"Выделение мочи и кала"}),x(M,i,$,{isDisabled:U=>a.includes(U)})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-sm font-semibold text-[#4A4A4A] mb-2",children:"Тягостные симптомы"}),x(L,i,$,{isDisabled:U=>a.includes(U)})]})]}),t.jsxs("div",{className:"border-t border-gray-200 pt-5 space-y-3",children:[t.jsx("h3",{className:"text-sm font-semibold text-[#4A4A4A]",children:"Добавить свой показатель"}),t.jsx("div",{className:"flex flex-wrap gap-2",children:Vg.map(U=>{const Z=C===U.value;return t.jsx("button",{type:"button",onClick:()=>B(U.value),className:`px-4 py-2 rounded-full text-sm font-semibold transition-all duration-200 ${Z?"bg-gradient-to-r from-[#7DD3DC] to-[#5CBCC7] text-white shadow":"bg-white border-2 border-gray-300 text-[#4A4A4A] hover:border-[#7DD3DC]"}`,children:U.label},U.value)})}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(he,{value:I,onChange:U=>P(U.target.value),placeholder:"Название показателя",className:"flex-1"}),t.jsx(oe,{onClick:p,disabled:!I.trim(),className:"!px-8 !py-3 !text-xl !font-bold !min-w-[80px]",children:"+"})]})]}),t.jsx(oe,{onClick:()=>{I.trim()&&p(),w(!1)},className:"w-full",children:"Сохранить"})]})})]})},Wg=bt({firstName:ke().min(1,"Введите имя"),lastName:ke().min(1,"Введите фамилию"),phone:ke().min(10,"Введите телефон"),password:ke().min(6,"Пароль должен быть не менее 6 символов"),confirmPassword:ke().min(1,"Подтвердите пароль")}).refine(e=>e.password===e.confirmPassword,{message:"Пароли не совпадают",path:["confirmPassword"]}),No=e=>{let r=e.trim().replace(/\s+/g,"");return r?(r=r.replace(/[^\d+]/g,""),r.startsWith("+")?r:r.startsWith("8")?`+7${r.slice(1)}`:r.startsWith("7")?`+${r}`:r.startsWith("7")?r:`+7${r}`):""},qg=()=>{const e=rt(),[r]=Tr(),s=r.get("token")||"",a=(r.get("type")||"").toLowerCase(),[n,i]=u.useState(null),[o,c]=u.useState("loading"),[g,_]=u.useState(null),[y,D]=u.useState(null),[w,I]=u.useState(null),[P,C]=u.useState(!1),{register:B,handleSubmit:O,formState:{errors:$}}=xt({resolver:yt(Wg)});u.useEffect(()=>{if(a==="admin"&&(C(!0),i("caregiver")),!s){c("invalid"),_("Ссылка недействительна. Проверьте корректность приглашения.");return}(async()=>{try{console.log("ClientInviteRegisterPage: Validating token via RPC:",s);const{data:x,error:F}=await R.rpc("validate_invite_token",{p_token:s});if(console.log("ClientInviteRegisterPage: RPC result:",{validationResult:x,rpcError:F}),F){console.error("ClientInviteRegisterPage: RPC validation error:",F),c("invalid"),_("Пригласительная ссылка недействительна или была удалена.");return}if(!x){console.error("ClientInviteRegisterPage: RPC returned null/undefined"),c("invalid"),_("Пригласительная ссылка недействительна или была удалена.");return}if(!x.valid){console.log("ClientInviteRegisterPage: Token validation failed:",x.error),c("invalid"),_(x.error||"Пригласительная ссылка недействительна или была удалена.");return}const H=x.invite_type;if(H==="organization_client"){const v=!!(x.organization_client_invite_tokens&&Array.isArray(x.organization_client_invite_tokens)?x.organization_client_invite_tokens[0]:x.organization_client_invite_tokens)?.diary_id;i(v?"organization":"caregiver")}else H==="caregiver_client"?i("caregiver"):H==="admin_static"&&(C(!0),i("caregiver"));const M=x.organization_client_invite_tokens,L=x.caregiver_client_invite_tokens,U={id:x.id,token:x.token,invite_type:x.invite_type,expires_at:x.expires_at,used_at:x.used_at,revoked_at:x.revoked_at,organization_client_invite_tokens:Array.isArray(M)&&M.length>0?M[0]:M||null,caregiver_client_invite_tokens:Array.isArray(L)&&L.length>0?L[0]:L||null};D(U);const Z=U.organization_client_invite_tokens;if(H==="organization_client"&&Z?.diary_id){const{data:j,error:v}=await R.from("diaries").select(`
              id,
              patient_card_id,
              organization_id,
              caregiver_id,
              owner_client_id
            `).eq("id",Z.diary_id).single();!v&&j&&I(j)}c("form")}catch(x){console.error("Ошибка проверки пригласительной ссылки",x),c("invalid"),_("Не удалось проверить приглашение. Попробуйте позже.")}})()},[s,a]);const p=async f=>{if(!s||!y)return;c("processing"),_(null);const x=No(f.phone);if(!x){_("Введите корректный номер телефона"),c("form");return}try{const F=new AbortController,H=setTimeout(()=>F.abort(),P?12e4:45e3),M="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyAgCiAgICAicm9sZSI6ICJhbm9uIiwKICAgICJpc3MiOiAic3VwYWJhc2UtZGVtbyIsCiAgICAiaWF0IjogMTY0MTc2OTIwMCwKICAgICJleHAiOiAxNzk5NTM1NjAwCn0.dc_X5iR_VP_qT0zsiyj_I_OZ2T9FtRU2BBNWN8Bu4GE",L=hs("accept-invite");console.log("ClientInviteRegisterPage: Calling Edge Function:",L);const U=await fetch(L,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${M}`,apikey:M},signal:F.signal,mode:"cors",credentials:"omit",body:JSON.stringify({token:s,password:f.password,phone:x,firstName:f.firstName,lastName:f.lastName})});if(clearTimeout(H),!U.ok){const A=await U.text();console.error("Edge Function error:",U.status,A);let Y="Не удалось завершить регистрацию. Попробуйте ещё раз.";try{const ee=JSON.parse(A);Y=ee.message||ee.error||Y}catch{Y=A||Y}throw new Error(Y)}const Z=await U.json();if(!Z?.data?.loginEmail)throw new Error("Не удалось получить данные для входа. Попробуйте войти вручную.");const{error:j}=await R.auth.signInWithPassword({email:Z.data.loginEmail,password:f.password});if(j)throw console.error("Ошибка входа после регистрации:",j),new Error("Не удалось войти после регистрации. Попробуйте войти вручную.");const{data:{user:v},error:z}=await R.auth.getUser(),{data:{session:T}}=await R.auth.getSession();if(z||!v)throw console.error("Ошибка получения пользователя:",z),new Error("Не удалось получить данные пользователя. Попробуйте войти вручную.");const{setUser:J,setSession:W,setLoading:h}=Se.getState();T&&v&&(J(v),W(T),h(!1),Se.setState({isAuthenticated:!0,loading:!1})),console.log("✅ Регистрация клиента организации завершена успешно"),await new Promise(A=>setTimeout(A,200));try{e("/dashboard")}catch{window.location.href="/dashboard"}}catch(F){console.error("Ошибка регистрации клиента организации",F),F?.name==="AbortError"?_("Сервер не ответил вовремя. Попробуйте ещё раз."):_(F.message||"Не удалось завершить регистрацию. Попробуйте ещё раз."),c("form")}},k=async f=>{if(!s||!y)return;c("processing"),_(null);const x=No(f.phone);if(!x){_("Введите корректный номер телефона"),c("form");return}try{const F=new AbortController,H=setTimeout(()=>F.abort(),3e4),M="https://supabase.healapp.ru",L="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyAgCiAgICAicm9sZSI6ICJhbm9uIiwKICAgICJpc3MiOiAic3VwYWJhc2UtZGVtbyIsCiAgICAiaWF0IjogMTY0MTc2OTIwMCwKICAgICJleHAiOiAxNzk5NTM1NjAwCn0.dc_X5iR_VP_qT0zsiyj_I_OZ2T9FtRU2BBNWN8Bu4GE",Z=`${M.replace(/\/$/,"")}/functions/v1/accept-invite`;console.log(`ClientInviteRegisterPage: Calling Edge Function for ${P?"admin":"caregiver"}:`,Z);const j=await fetch(Z,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${L}`,apikey:L},signal:F.signal,mode:"cors",credentials:"omit",body:JSON.stringify({token:s,password:f.password,phone:x,firstName:f.firstName,lastName:f.lastName})});if(clearTimeout(H),!j.ok){const ee=await j.text();console.error("Edge Function error:",j.status,ee);let ae="Не удалось завершить регистрацию. Попробуйте ещё раз.";try{const ne=JSON.parse(ee);ae=ne.message||ne.error||ae}catch{ae=ee||ae}throw new Error(ae)}const v=await j.json();if(!v?.data?.loginEmail)throw new Error("Не удалось получить данные для входа. Попробуйте войти вручную.");const{error:z}=await R.auth.signInWithPassword({email:v.data.loginEmail,password:f.password});if(z)throw console.error("Ошибка входа после регистрации:",z),new Error("Не удалось войти после регистрации. Попробуйте войти вручную.");const{data:{user:T},error:J}=await R.auth.getUser(),{data:{session:W}}=await R.auth.getSession();if(J||!T)throw console.error("Ошибка получения пользователя:",J),new Error("Не удалось получить данные пользователя. Попробуйте войти вручную.");const{setUser:h,setSession:A,setLoading:Y}=Se.getState();W&&T&&(h(T),A(W),Y(!1),Se.setState({isAuthenticated:!0,loading:!1})),console.log("✅ Регистрация клиента сиделки завершена успешно"),await new Promise(ee=>setTimeout(ee,200));try{e("/dashboard")}catch{window.location.href="/dashboard"}}catch(F){console.error("Ошибка регистрации клиента сиделки",F),F?.name==="AbortError"?_("Сервер не ответил вовремя. Попробуйте ещё раз."):_(F.message||"Не удалось завершить регистрацию. Попробуйте ещё раз."),c("form")}};return o==="loading"?t.jsxs("div",{className:"space-y-4 text-center",children:[t.jsx("div",{className:"animate-spin w-12 h-12 border-4 border-[#7DD3DC] border-t-transparent rounded-full mx-auto"}),t.jsx("p",{className:"text-gray-600 text-sm",children:"Проверяем приглашение..."})]}):o==="invalid"&&g?t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"bg-white rounded-3xl shadow-sm p-6 space-y-3 text-center",children:[t.jsx("h1",{className:"text-xl font-semibold text-gray-dark",children:"Ссылка недоступна"}),t.jsx("p",{className:"text-sm text-gray-600 leading-relaxed",children:g})]}),t.jsx(oe,{onClick:()=>e("/login"),fullWidth:!0,children:"Перейти ко входу"})]}):!n||!y?t.jsxs("div",{className:"space-y-4 text-center",children:[t.jsx("div",{className:"animate-spin w-12 h-12 border-4 border-[#7DD3DC] border-t-transparent rounded-full mx-auto"}),t.jsx("p",{className:"text-gray-600 text-sm",children:"Загрузка..."})]}):n==="caregiver"?t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"bg-white rounded-3xl shadow-sm p-6 space-y-3 text-center",children:[t.jsx("h1",{className:"text-2xl font-semibold text-gray-dark",children:"Регистрация клиента"}),t.jsx("p",{className:"text-sm text-gray-600 leading-relaxed",children:"После регистрации вы сможете создать карточку подопечного и вести дневник вместе с приглашавшим специалистом."}),y?.caregiver_client_invite_tokens?.invited_client_name&&t.jsxs("p",{className:"text-sm text-[#4A4A4A]/70",children:["Пригласил: ",y.caregiver_client_invite_tokens.invited_client_name]})]}),t.jsxs("form",{onSubmit:O(k),className:"bg-white rounded-3xl shadow-sm p-6 space-y-5",children:[t.jsx(he,{label:"Имя",placeholder:"Введите имя",error:$.firstName?.message,fullWidth:!0,...B("firstName")}),t.jsx(he,{label:"Фамилия",placeholder:"Введите фамилию",error:$.lastName?.message,fullWidth:!0,...B("lastName")}),t.jsx(he,{label:"Телефон",placeholder:"+7 (___) ___-__-__",error:$.phone?.message,fullWidth:!0,...B("phone")}),t.jsx(he,{label:"Пароль",type:"password",placeholder:"Введите пароль",error:$.password?.message,helperText:"Минимум 6 символов",fullWidth:!0,...B("password")}),t.jsx(he,{label:"Подтвердите пароль",type:"password",placeholder:"Повторите пароль",error:$.confirmPassword?.message,fullWidth:!0,...B("confirmPassword")}),g&&t.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-xl text-sm text-red-600",children:g}),t.jsx(oe,{type:"submit",fullWidth:!0,isLoading:o==="processing",children:"Завершить регистрацию"})]}),t.jsxs("div",{className:"bg-white rounded-3xl shadow-sm p-5 space-y-3 text-sm text-gray-600",children:[t.jsx("p",{className:"text-center text-gray-500",children:"Если регистрация уже выполнена, войдите с помощью телефона и пароля на странице входа."}),t.jsx(oe,{variant:"outline",onClick:()=>e("/login"),fullWidth:!0,children:"Перейти ко входу"})]})]}):!y||!w?null:t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"bg-white rounded-3xl shadow-sm p-6 space-y-3 text-center",children:[t.jsx("h1",{className:"text-2xl font-semibold text-gray-dark",children:"Регистрация клиента"}),t.jsx("p",{className:"text-sm text-gray-600 leading-relaxed",children:"После регистрации вы получите доступ к дневнику и сможете управлять правами доступа."})]}),t.jsxs("form",{onSubmit:O(p),className:"bg-white rounded-3xl shadow-sm p-6 space-y-5",children:[t.jsx(he,{label:"Имя",placeholder:"Введите имя",error:$.firstName?.message,fullWidth:!0,...B("firstName")}),t.jsx(he,{label:"Фамилия",placeholder:"Введите фамилию",error:$.lastName?.message,fullWidth:!0,...B("lastName")}),t.jsx(he,{label:"Телефон",placeholder:"+7 (___) ___-__-__",error:$.phone?.message,fullWidth:!0,...B("phone")}),t.jsx(he,{label:"Пароль",type:"password",placeholder:"Введите пароль",error:$.password?.message,helperText:"Минимум 6 символов",fullWidth:!0,...B("password")}),t.jsx(he,{label:"Подтвердите пароль",type:"password",placeholder:"Повторите пароль",error:$.confirmPassword?.message,fullWidth:!0,...B("confirmPassword")}),g&&t.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-xl text-sm text-red-600",children:g}),t.jsx(oe,{type:"submit",fullWidth:!0,isLoading:o==="processing",children:"Завершить регистрацию"})]}),t.jsxs("div",{className:"bg-white rounded-3xl shadow-sm p-5 space-y-3 text-sm text-gray-600",children:[t.jsx("p",{className:"text-center text-gray-500",children:"Если регистрация уже выполнена, войдите с помощью телефона и пароля на странице входа."}),t.jsx(oe,{variant:"outline",onClick:()=>e("/login"),fullWidth:!0,children:"Перейти ко входу"})]})]})},Ws="admin_panel_access_granted",qs="admin_panel_token",Ba="b8f56f5c-62f1-45d9-9e5a-e8bbfdadcf0f",Jg=()=>u.useMemo(()=>{const e=[];return e.length===0?e.push(Ba):e.includes(Ba)||e.push(Ba),Array.from(new Set(e))},[]),Qg=()=>{const e=Jg(),[r,s]=Tr(),a=rt(),n=lc(),[i,o]=u.useState("checking"),[c,g]=u.useState(null),[_,y]=u.useState(!1),D=n.pathname==="/admin",w=r.get("token");u.useEffect(()=>{const P=localStorage.getItem(Ws),C=localStorage.getItem(qs);if(P==="true"&&C&&e.includes(C)){o("authorized"),g(null);return}if(w){if(e.includes(w)){localStorage.setItem(Ws,"true"),localStorage.setItem(qs,w);const B=new URLSearchParams(r);B.delete("token"),s(B,{replace:!0}),o("authorized"),g(null)}else localStorage.removeItem(Ws),localStorage.removeItem(qs),o("denied"),g("Недействительный токен доступа. Убедитесь, что используете актуальную ссылку админ-панели.");return}o("denied"),g("Для доступа к админ-панели добавьте параметр token=ВАШ_ТОКЕН в адресную строку.")},[e,s,w,r,n.pathname]);const I=()=>{localStorage.removeItem(Ws),localStorage.removeItem(qs),o("denied"),g("Доступ закрыт. Чтобы вернуться, используйте токен из ссылки админ-панели."),a("/",{replace:!0})};return u.useEffect(()=>{y(!1)},[n.pathname]),i==="checking"?t.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-100 px-4",children:t.jsxs("div",{className:"text-center space-y-4",children:[t.jsx("div",{className:"animate-spin w-12 h-12 border-4 border-[#55ACBF] border-t-transparent rounded-full mx-auto"}),t.jsx("p",{className:"text-sm text-gray-600",children:"Проверяем права доступа…"})]})}):i==="denied"?t.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-100 px-4",children:t.jsxs("div",{className:"max-w-md w-full bg-white rounded-3xl shadow-lg p-8 space-y-6 text-center",children:[t.jsxs("div",{children:[t.jsx("h1",{className:"text-2xl font-bold text-gray-800 mb-2",children:"Доступ ограничен"}),c&&t.jsx("p",{className:"text-sm text-gray-600",children:c})]}),t.jsxs("div",{className:"space-y-3",children:[t.jsx(oe,{onClick:()=>a("/",{replace:!0}),fullWidth:!0,children:"Вернуться на главную"}),t.jsxs("p",{className:"text-xs text-gray-500",children:["Администратор получает доступ только по постоянной ссылке с токеном. Добавьте параметр",t.jsx("span",{className:"font-semibold",children:" token"})," в URL и перезагрузите страницу."]})]})]})}):t.jsxs("div",{className:"min-h-screen bg-gray-50",children:[t.jsxs("header",{className:"bg-white border-b border-gray-200",children:[t.jsxs("div",{className:"max-w-6xl mx-auto px-4 sm:px-6 py-4 flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[!D&&t.jsx("button",{onClick:()=>a("/admin"),className:"flex items-center justify-center w-9 h-9 rounded-full border border-gray-200 bg-white text-gray-600 hover:text-[#0A6D83] hover:border-[#55ACBF] transition-colors","aria-label":"Вернуться на главную панель",children:"←"}),t.jsxs("div",{children:[t.jsx("p",{className:"text-xs uppercase tracking-wide text-gray-400",children:"Административная панель"}),t.jsx("h1",{className:"text-xl font-bold text-gray-800",children:"Управление платформой"})]})]}),t.jsxs("div",{className:"flex items-center gap-4",children:[t.jsxs("button",{type:"button",className:"sm:hidden inline-flex items-center justify-center w-10 h-10 rounded-full border border-gray-200 bg-white text-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#55ACBF]",onClick:()=>y(P=>!P),"aria-label":"Открыть меню разделов",children:[t.jsx("span",{className:"sr-only",children:"Меню"}),t.jsx("svg",{className:"w-5 h-5",viewBox:"0 0 24 24",fill:"none",children:t.jsx("path",{d:"M4 7h16M4 12h16M4 17h16",stroke:"currentColor",strokeWidth:1.5,strokeLinecap:"round"})})]}),t.jsxs("nav",{className:"hidden sm:flex items-center gap-3 text-sm",children:[t.jsx(Bt,{to:"/admin",end:!0,className:({isActive:P})=>`px-3 py-2 rounded-lg transition-colors ${P?"bg-[#55ACBF]/10 text-[#0A6D83] font-medium":"text-gray-500 hover:text-gray-700"}`,children:"Главная"}),t.jsx(Bt,{to:"/admin/invites",className:({isActive:P})=>`px-3 py-2 rounded-lg transition-colors ${P?"bg-[#55ACBF]/10 text-[#0A6D83] font-medium":"text-gray-500 hover:text-gray-700"}`,children:"Пригласительные"}),t.jsx(Bt,{to:"/admin/users",className:({isActive:P})=>`px-3 py-2 rounded-lg transition-colors ${P?"bg-[#55ACBF]/10 text-[#0A6D83] font-medium":"text-gray-500 hover:text-gray-700"}`,children:"Пользователи"}),t.jsx(Bt,{to:"/admin/support",className:({isActive:P})=>`px-3 py-2 rounded-lg transition-colors ${P?"bg-[#55ACBF]/10 text-[#0A6D83] font-medium":"text-gray-500 hover:text-gray-700"}`,children:"Поддержка"}),t.jsx(Bt,{to:"/admin/monitoring",className:({isActive:P})=>`px-3 py-2 rounded-lg transition-colors ${P?"bg-[#55ACBF]/10 text-[#0A6D83] font-medium":"text-gray-500 hover:text-gray-700"}`,children:"Мониторинг"})]}),t.jsx(oe,{variant:"outline",size:"sm",onClick:I,children:"Выйти"})]})]}),_&&t.jsx("div",{className:"sm:hidden border-t border-gray-200 bg-white",children:t.jsxs("nav",{className:"px-4 py-3 space-y-2 text-sm",children:[t.jsx(Bt,{to:"/admin",end:!0,className:({isActive:P})=>`block px-3 py-2 rounded-lg transition-colors ${P?"bg-[#55ACBF]/10 text-[#0A6D83] font-medium":"text-gray-500 hover:text-gray-700"}`,children:"Главная"}),t.jsx(Bt,{to:"/admin/invites",className:({isActive:P})=>`block px-3 py-2 rounded-lg transition-colors ${P?"bg-[#55ACBF]/10 text-[#0A6D83] font-medium":"text-gray-500 hover:text-gray-700"}`,children:"Пригласительные"}),t.jsx(Bt,{to:"/admin/users",className:({isActive:P})=>`block px-3 py-2 rounded-lg transition-colors ${P?"bg-[#55ACBF]/10 text-[#0A6D83] font-medium":"text-gray-500 hover:text-gray-700"}`,children:"Пользователи"}),t.jsx(Bt,{to:"/admin/support",className:({isActive:P})=>`block px-3 py-2 rounded-lg transition-colors ${P?"bg-[#55ACBF]/10 text-[#0A6D83] font-medium":"text-gray-500 hover:text-gray-700"}`,children:"Поддержка"}),t.jsx(Bt,{to:"/admin/monitoring",className:({isActive:P})=>`block px-3 py-2 rounded-lg transition-colors ${P?"bg-[#55ACBF]/10 text-[#0A6D83] font-medium":"text-gray-500 hover:text-gray-700"}`,children:"Мониторинг"})]})})]}),t.jsx("main",{className:"max-w-6xl mx-auto px-4 sm:px-6 py-8",children:t.jsx(un,{})})]})},Kg=[{to:"/admin/invites",title:"Пригласительные ссылки",description:"Создание и контроль одноразовых ссылок для организаций, сотрудников и клиентов."},{to:"/admin/users",title:"Пользователи и роли",description:"Просмотр организаций, сотрудников и клиентов, анализ их активности."},{to:"/admin/support",title:"Помощь пользователям",description:"Инструменты службы поддержки: просмотр дневников, правка данных и журнал действий."},{to:"/admin/monitoring",title:"Мониторинг и статистика",description:"Показатели активности системы, проблемные события и аудит действий."}],Gg=()=>t.jsxs("div",{className:"space-y-8",children:[t.jsx("div",{className:"space-y-3",children:t.jsx("h2",{className:"text-2xl font-bold text-gray-800",children:"Обзор панели управления"})}),t.jsx("div",{className:"grid gap-4 md:grid-cols-2 xl:grid-cols-3",children:Kg.map(e=>t.jsx(cc,{to:e.to,className:"group relative h-full bg-white border border-gray-200 rounded-3xl p-6 shadow-sm hover:shadow-lg transition-shadow",children:t.jsxs("div",{className:"flex flex-col h-full space-y-4",children:[t.jsx("div",{className:"flex items-center justify-between",children:t.jsx("h3",{className:"text-lg font-semibold text-gray-800 group-hover:text-[#0A6D83] transition-colors",children:e.title})}),t.jsx("p",{className:"text-sm text-gray-600 flex-1 leading-relaxed",children:e.description}),t.jsx("span",{className:"text-sm font-medium text-[#0A6D83] group-hover:translate-x-1 transition-transform",children:"Перейти →"})]})},e.to))})]}),Hg=()=>typeof window<"u"?window.location.origin:"",Va=(e,r)=>{const s=Hg();switch(e){case"organization":return`${s}/register?token=${r}`;case"privateCaregiver":return`${s}/register?token=${r}`;case"employee":return`${s}/register?org_token=${r}`;case"client":default:return`${s}/client-invite?token=${r}`}},Za=[{value:"organization",label:"Организация"},{value:"employee",label:"Сотрудник организации"},{value:"client",label:"Клиент"},{value:"privateCaregiver",label:"Частная сиделка"}],Yg=e=>{switch(e){case"organization":return"Организация";case"employee":return"Сотрудник";case"privateCaregiver":return"Частная сиделка";case"client":default:return"Клиент"}},Xg=e=>{if(e==="organization")return"organization";if(e==="privateCaregiver")return"private_caregiver";if(e==="client")return"admin_static";throw new Error(`Неподдерживаемый тип для админской панели: ${e}`)},ep=()=>{const[e,r]=u.useState("organization"),[s,a]=u.useState(!1),[n,i]=u.useState(null),[o,c]=u.useState("all"),[g,_]=u.useState([]),[y,D]=u.useState(!0),[w,I]=u.useState(null);u.useEffect(()=>{const p=async()=>{D(!0),I(null);const f=Cr||R;if(!Cr){I("Для загрузки приглашений требуется VITE_SUPABASE_SERVICE_ROLE_KEY в .env.local"),D(!1);return}try{const{data:x,error:F}=await f.from("invite_tokens").select(`
            id,
            token,
            invite_type,
            created_at,
            used_at,
            used_by,
            revoked_at,
            expires_at,
            organization_registration_invite_tokens (
              organization_type,
              invited_email,
              invited_name
            ),
            private_caregiver_registration_invite_tokens (
              invited_email,
              invited_name
            ),
            organization_invite_tokens (
              organization_id,
              employee_role
            ),
            organization_client_invite_tokens (
              organization_id
            ),
            caregiver_client_invite_tokens (
              caregiver_id
            )
          `).order("created_at",{ascending:!1});if(F){console.error("Ошибка загрузки приглашений:",F),I("Не удалось загрузить приглашения");return}if(!x){_([]);return}const H=x.map(M=>{const L=!!M.revoked_at,U=!!M.used_at,Z=M.expires_at?new Date(M.expires_at)<new Date:!1,j=L?"revoked":U?"used":Z?"expired":"active",v=Va(M.invite_type==="organization"?"organization":M.invite_type==="private_caregiver"?"privateCaregiver":M.invite_type==="organization_employee"?"employee":"client",M.token);if(M.invite_type==="organization"){const T=Array.isArray(M.organization_registration_invite_tokens)?M.organization_registration_invite_tokens[0]:M.organization_registration_invite_tokens;return{id:M.id,token:M.token,created_at:M.created_at,link:v,used_at:M.used_at,used_by:M.used_by,status:j,source:"supabase",invite_type:"organization",organization_type:T?.organization_type||null,invited_email:T?.invited_email||null,invited_name:T?.invited_name||null}}if(M.invite_type==="private_caregiver"){const T=Array.isArray(M.private_caregiver_registration_invite_tokens)?M.private_caregiver_registration_invite_tokens[0]:M.private_caregiver_registration_invite_tokens;return{id:M.id,token:M.token,created_at:M.created_at,link:v,used_at:M.used_at,used_by:M.used_by,status:j,source:"supabase",invite_type:"private_caregiver",invited_email:T?.invited_email||null,invited_name:T?.invited_name||null}}if(M.invite_type==="organization_employee"){const T=Array.isArray(M.organization_invite_tokens)?M.organization_invite_tokens[0]:M.organization_invite_tokens;return{id:M.id,token:M.token,created_at:M.created_at,link:v,used_at:M.used_at,used_by:M.used_by,status:j,source:"supabase",invite_type:"organization_employee",organization_id:T?.organization_id||null,employee_role:T?.employee_role||null}}const z=M.organization_client_invite_tokens||M.caregiver_client_invite_tokens||{};return{id:M.id,token:M.token,created_at:M.created_at,link:v,used_at:M.used_at,used_by:M.used_by,status:j,source:"supabase",invite_type:M.invite_type,organization_id:z.organization_id||null,caregiver_id:z.caregiver_id||null}});_(H)}catch(x){console.error("Ошибка при загрузке приглашений:",x),I("Произошла ошибка при загрузке данных")}finally{D(!1)}};p();const k=setInterval(()=>{p()},3e4);return()=>clearInterval(k)},[]);const P=u.useMemo(()=>g.filter(p=>o==="all"?!0:(p.invite_type==="organization"?"organization":p.invite_type==="private_caregiver"?"privateCaregiver":p.invite_type==="organization_employee"?"employee":"client")===o),[g,o]),C=u.useMemo(()=>{const p={total:g.length,active:0,used:0,byType:{organization:0,employee:0,client:0,privateCaregiver:0}};return g.forEach(k=>{const f=k.invite_type==="organization"?"organization":k.invite_type==="private_caregiver"?"privateCaregiver":k.invite_type==="organization_employee"?"employee":"client";p.byType[f]=(p.byType[f]||0)+1,k.status==="active"?p.active+=1:k.status==="used"&&(p.used+=1)}),p},[g]),B=async()=>{a(!0),i(null),I(null);try{const p=Xg(e),k={expires_in_hours:168};e==="organization"?k.organization_type="pension":e==="client"&&(k.organization_id=null,k.patient_card_id=null,k.diary_id=null);const f=localStorage.getItem("admin_panel_token");if(!f){I("Не найден админский токен. Обновите страницу с токеном в URL.");return}if(!"".split(",").map(z=>z.trim()).filter(Boolean).includes(f)&&f!=="b8f56f5c-62f1-45d9-9e5a-e8bbfdadcf0f"){I("Недействительный админский токен");return}const M=Cr||R;if(!Cr){I("Для создания приглашений требуется VITE_SUPABASE_SERVICE_ROLE_KEY в .env.local");return}const{data:L,error:U}=await M.rpc("generate_admin_invite_link",{invite_type:p,payload:k});if(U){console.error("Ошибка создания приглашения:",U),I(U.message||"Не удалось создать приглашение");return}if(!L){I("Не удалось создать приглашение");return}const Z={success:!0,invite:L},j=Va(e,Z.invite.token);i(j);const{data:v}=await M.from("invite_tokens").select("*").eq("id",Z.invite.id).single();if(v){const z=!!Z.invite.used_at,T=Z.invite.expires_at?new Date(Z.invite.expires_at)<new Date:!1,J=z?"used":T?"expired":"active",W={id:Z.invite.id,token:Z.invite.token,created_at:Z.invite.created_at,link:j,used_at:Z.invite.used_at,used_by:Z.invite.used_by,status:J,source:"supabase",invite_type:p,...e==="organization"?{organization_type:"pension"}:e==="privateCaregiver"?{invited_email:null,invited_name:null}:{}};_(h=>[W,...h])}}catch(p){console.error("Ошибка при создании приглашения:",p),I("Произошла ошибка при создании приглашения")}finally{a(!1)}},O=p=>{navigator.clipboard.writeText(p).catch(k=>{console.warn("Не удалось скопировать текст",k)})},$=async p=>{try{I(null);const k=localStorage.getItem("admin_panel_token");if(!k){I("Не найден админский токен. Обновите страницу с токеном в URL.");return}if(!"".split(",").map(M=>M.trim()).filter(Boolean).includes(k)&&k!=="b8f56f5c-62f1-45d9-9e5a-e8bbfdadcf0f"){I("Недостаточно прав для отзыва приглашения");return}if(!Cr){I("Для отзыва приглашений требуется VITE_SUPABASE_SERVICE_ROLE_KEY в .env.local");return}const{error:H}=await Cr.from("invite_tokens").delete().eq("id",p);if(H){console.error("Ошибка отзыва приглашения:",H),I(H.message||"Не удалось отозвать приглашение");return}_(M=>M.filter(L=>L.id!==p))}catch(k){console.error("Ошибка при отзыве приглашения:",k),I("Произошла ошибка при отзыве приглашения")}};return t.jsxs("div",{className:"space-y-6",children:[t.jsx("div",{className:"space-y-2",children:t.jsx("h2",{className:"text-2xl font-bold text-gray-800",children:"Управление пригласительными ссылками"})}),w&&t.jsx("div",{className:"bg-red-50 border border-red-200 rounded-xl p-4",children:t.jsx("p",{className:"text-red-800 text-sm",children:w})}),t.jsxs("div",{className:"bg-white border border-gray-200 rounded-3xl p-6 space-y-6 shadow-sm",children:[t.jsxs("section",{className:"grid gap-4 sm:grid-cols-2 lg:grid-cols-4",children:[t.jsxs("div",{className:"rounded-3xl border border-gray-200 p-5 shadow-sm",children:[t.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Всего ссылок"}),t.jsx("p",{className:"text-2xl font-semibold text-gray-800",children:C.total})]}),t.jsxs("div",{className:"rounded-3xl border border-gray-200 p-5 shadow-sm",children:[t.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Активные"}),t.jsx("p",{className:"text-2xl font-semibold text-green-700",children:C.active})]}),t.jsxs("div",{className:"rounded-3xl border border-gray-200 p-5 shadow-sm",children:[t.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Использованные"}),t.jsx("p",{className:"text-2xl font-semibold text-gray-800",children:C.used})]}),t.jsxs("div",{className:"rounded-3xl border border-gray-200 p-5 shadow-sm space-y-2",children:[t.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"По типам"}),t.jsx("div",{className:"space-y-1 text-sm text-gray-600",children:Object.keys(C.byType).map(p=>t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{children:Yg(p)}),t.jsx("span",{className:"font-medium text-gray-800",children:C.byType[p]})]},p))})]})]}),t.jsxs("section",{className:"space-y-4",children:[t.jsx("div",{children:t.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Создать приглашение"})}),t.jsx("div",{className:"flex flex-wrap gap-3",children:Za.filter(p=>p.value==="organization"||p.value==="privateCaregiver"||p.value==="client").map(p=>t.jsx("button",{onClick:()=>r(p.value),className:`px-4 py-2 rounded-full text-sm font-medium border transition-colors ${e===p.value?"bg-[#55ACBF]/10 text-[#0A6D83] border-[#55ACBF]":"text-gray-600 border-gray-200 hover:border-[#55ACBF]/50 hover:text-[#0A6D83]"}`,children:p.label},p.value))}),t.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-3 w-full",children:[t.jsx(oe,{onClick:B,isLoading:s,className:"sm:w-auto w-full",children:"Сгенерировать ссылку"}),n&&t.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-3 bg-[#F7FCFD] border border-[#55ACBF]/30 rounded-2xl px-4 py-3 text-sm w-full",children:[t.jsx("span",{className:"font-mono text-gray-700 break-all sm:max-w-md",children:n}),t.jsx(oe,{variant:"outline",size:"sm",onClick:()=>O(n),children:"Скопировать"})]})]})]}),t.jsxs("section",{className:"space-y-4",children:[t.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-3 justify-between",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("div",{children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Список приглашений"}),y&&t.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Загрузка..."})]}),t.jsx(oe,{variant:"outline",size:"sm",onClick:async()=>{D(!0),I(null);try{const{data:p,error:k}=await R.from("invite_tokens").select(`
                        *,
                        organization_registration_invite_tokens (
                          organization_type,
                          invited_email,
                          invited_name
                        ),
                        private_caregiver_registration_invite_tokens (
                          invited_email,
                          invited_name
                        ),
                        organization_invite_tokens (
                          organization_id,
                          employee_role
                        ),
                        organization_client_invite_tokens (
                          organization_id
                        ),
                        caregiver_client_invite_tokens (
                          caregiver_id
                        )
                      `).order("created_at",{ascending:!1});if(k){console.error("Ошибка загрузки приглашений:",k),I("Не удалось загрузить приглашения");return}if(!p){_([]);return}const f=p.map(x=>{const F=!!x.revoked_at,H=!!x.used_at,M=x.expires_at?new Date(x.expires_at)<new Date:!1,L=F?"revoked":H?"used":M?"expired":"active",U=Va(x.invite_type==="organization"?"organization":x.invite_type==="private_caregiver"?"privateCaregiver":x.invite_type==="organization_employee"?"employee":"client",x.token);if(x.invite_type==="organization"){const j=Array.isArray(x.organization_registration_invite_tokens)?x.organization_registration_invite_tokens[0]:x.organization_registration_invite_tokens;return{id:x.id,token:x.token,created_at:x.created_at,link:U,used_at:x.used_at,used_by:x.used_by,status:L,source:"supabase",invite_type:"organization",organization_type:j?.organization_type||null,invited_email:j?.invited_email||null,invited_name:j?.invited_name||null}}if(x.invite_type==="private_caregiver"){const j=Array.isArray(x.private_caregiver_registration_invite_tokens)?x.private_caregiver_registration_invite_tokens[0]:x.private_caregiver_registration_invite_tokens;return{id:x.id,token:x.token,created_at:x.created_at,link:U,used_at:x.used_at,used_by:x.used_by,status:L,source:"supabase",invite_type:"private_caregiver",invited_email:j?.invited_email||null,invited_name:j?.invited_name||null}}if(x.invite_type==="organization_employee"){const j=Array.isArray(x.organization_invite_tokens)?x.organization_invite_tokens[0]:x.organization_invite_tokens;return{id:x.id,token:x.token,created_at:x.created_at,link:U,used_at:x.used_at,used_by:x.used_by,status:L,source:"supabase",invite_type:"organization_employee",organization_id:j?.organization_id||null,employee_role:j?.employee_role||null}}const Z=Array.isArray(x.organization_client_invite_tokens)?x.organization_client_invite_tokens[0]:x.organization_client_invite_tokens||(Array.isArray(x.caregiver_client_invite_tokens)?x.caregiver_client_invite_tokens[0]:x.caregiver_client_invite_tokens);return{id:x.id,token:x.token,created_at:x.created_at,link:U,used_at:x.used_at,used_by:x.used_by,status:L,source:"supabase",invite_type:x.invite_type==="organization_client"?"organization_client":"caregiver_client"}});_(f)}catch(p){console.error("Ошибка при загрузке приглашений:",p),I("Произошла ошибка при загрузке приглашений")}finally{D(!1)}},children:"Обновить"})]}),t.jsx("div",{className:"flex flex-wrap items-center gap-2 text-xs font-medium",children:["all",...Za.map(p=>p.value)].map(p=>t.jsx("button",{onClick:()=>c(p),className:`px-3 py-1 rounded-full border transition-colors whitespace-normal text-left leading-tight max-w-[140px] ${o===p?"bg-[#55ACBF]/10 text-[#0A6D83] border-[#55ACBF]":"border-gray-200 text-gray-500 hover:text-[#0A6D83] hover:border-[#55ACBF]/40"}`,children:p==="all"?"Все":Za.find(k=>k.value===p)?.label||p},p))})]}),y?t.jsx("div",{className:"text-center py-10 text-gray-500",children:"Загрузка приглашений..."}):P.length===0?t.jsx("div",{className:"rounded-2xl border border-dashed border-gray-300 bg-white p-6 text-sm text-gray-500 text-center",children:"Приглашения не найдены"}):t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"overflow-hidden border border-gray-200 rounded-2xl overflow-x-auto hidden lg:block",children:t.jsxs("table",{className:"min-w-full divide-y divide-gray-200 text-sm",children:[t.jsx("thead",{className:"bg-[#F7FCFD] text-gray-500 uppercase tracking-wide text-xs",children:t.jsxs("tr",{children:[t.jsx("th",{className:"px-4 py-3 text-left",children:"Тип"}),t.jsx("th",{className:"px-4 py-3 text-left",children:"Ссылка"}),t.jsx("th",{className:"px-4 py-3 text-left",children:"Статус"}),t.jsx("th",{className:"px-4 py-3 text-left",children:"Создан"}),t.jsx("th",{className:"px-4 py-3 text-left",children:"Действия"})]})}),t.jsx("tbody",{className:"divide-y divide-gray-100 bg-white",children:P.map(p=>{const k=p.invite_type==="organization"?"Организация":p.invite_type==="private_caregiver"?"Частная сиделка":p.invite_type==="organization_employee"?"Сотрудник":"Клиент",f=p.status==="active"?"Активна":p.status==="used"?"Использована":p.status==="revoked"?"Отозвана":"Истекла";return t.jsxs("tr",{children:[t.jsx("td",{className:"px-4 py-3 text-gray-800",children:k}),t.jsx("td",{className:"px-4 py-3 text-gray-700",children:t.jsx("a",{href:p.link,target:"_blank",rel:"noreferrer",className:"text-[#0A6D83] underline hover:text-[#55ACBF] break-all",children:p.link})}),t.jsx("td",{className:"px-4 py-3",children:t.jsx("span",{className:`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold ${p.status==="active"?"bg-green-100 text-green-700":p.status==="used"?"bg-gray-200 text-gray-600":p.status==="revoked"?"bg-red-100 text-red-700":"bg-yellow-100 text-yellow-700"}`,children:f})}),t.jsx("td",{className:"px-4 py-3 text-gray-500",children:new Date(p.created_at).toLocaleString("ru-RU",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})}),t.jsx("td",{className:"px-4 py-3",children:t.jsxs("div",{className:"flex flex-wrap gap-2",children:[t.jsx(oe,{variant:"outline",size:"sm",onClick:()=>O(p.link),children:"Скопировать"}),p.status==="active"&&t.jsx(oe,{variant:"outline",size:"sm",onClick:()=>$(p.id),className:"text-red-600 border-red-300 hover:bg-red-50",children:"Отозвать"})]})})]},p.id)})})]})}),t.jsx("div",{className:"lg:hidden space-y-3",children:P.map(p=>{const k=p.invite_type==="organization"?"Организация":p.invite_type==="private_caregiver"?"Частная сиделка":p.invite_type==="organization_employee"?"Сотрудник":"Клиент",f=p.status==="active"?"Активна":p.status==="used"?"Использована":p.status==="revoked"?"Отозвана":"Истекла";return t.jsxs("div",{className:"rounded-2xl border border-gray-200 bg-white p-5 shadow-sm flex flex-col gap-3",children:[t.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[t.jsx("span",{className:"inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-[#F7FCFD] text-[#0A6D83] border border-[#55ACBF]/40",children:k}),t.jsx("span",{className:`inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold ${p.status==="active"?"bg-green-100 text-green-700":p.status==="used"?"bg-gray-100 text-gray-500":p.status==="revoked"?"bg-red-100 text-red-700":"bg-yellow-100 text-yellow-700"}`,children:f})]}),t.jsxs("div",{className:"space-y-2 text-sm text-gray-700",children:[t.jsxs("p",{className:"text-xs text-gray-400",children:["Создана: ",new Date(p.created_at).toLocaleString("ru-RU")]}),t.jsx("a",{href:p.link,target:"_blank",rel:"noreferrer",className:"text-[#0A6D83] underline hover:text-[#55ACBF] break-all text-sm",children:p.link})]}),t.jsxs("div",{className:"flex flex-col gap-2 text-sm",children:[t.jsx(oe,{variant:"outline",size:"sm",onClick:()=>O(p.link),children:"Скопировать ссылку"}),p.status==="active"&&t.jsx(oe,{size:"sm",variant:"outline",onClick:()=>$(p.id),className:"text-red-600 border-red-300 hover:bg-red-50",children:"Отозвать"})]})]},p.id)})})]})]})]})]})},Gt={all:"Все",organization:"Организации",employee:"Сотрудники организаций",privateCaregiver:"Частные сиделки",client:"Клиенты"},Wa={organization:1,employee:2,privateCaregiver:3,client:4,all:99},nr=e=>e==null?"":String(e),ko=(...e)=>{const r=new Set;return e.flat().forEach(s=>{Array.isArray(s)?s.forEach(a=>{a&&r.add(String(a))}):s&&r.add(String(s))}),Array.from(r)},Vt=(e,r)=>e==null||r===void 0||r===null?!1:String(e)===String(r),qa=e=>{switch(e){case"pension":return"Пансионат";case"patronage_agency":return"Патронажное агентство";case"caregiver":return"Частная сиделка";default:return e?String(e):null}},zr=e=>{const{full_name:r,name:s,first_name:a,last_name:n}=e;if(r&&String(r).trim().length>0)return String(r).trim();if(s&&String(s).trim().length>0)return String(s).trim();const i=`${a||""} ${n||""}`.trim();return i.length>0?i:""},tp=e=>{const r=e?.user_role||e?.role,s=e?.organization_type||e?.type;return r==="org_employee"||r==="employee"?"employee":r==="client"?"client":r==="caregiver"||s==="caregiver"?"privateCaregiver":r==="organization"||s==="pension"||s==="patronage_agency"?"organization":null},rp=()=>{const[e,r]=u.useState("all"),[s,a]=u.useState(""),[n,i]=u.useState(0),[o,c]=u.useState(null),[g,_]=u.useState(!1),[y,D]=u.useState(""),[w,I]=u.useState(null),[P,C]=u.useState(!0),[B,O]=u.useState({organizations:[],userProfiles:[],clients:[],diaries:[],patientCards:[],diaryEmployeeAccess:[]});u.useEffect(()=>{(async()=>{C(!0);try{const A=localStorage.getItem("admin_panel_token");if(!A){console.error("Не найден админский токен"),C(!1);return}const Y="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyAgCiAgICAicm9sZSI6ICJhbm9uIiwKICAgICJpc3MiOiAic3VwYWJhc2UtZGVtbyIsCiAgICAiaWF0IjogMTY0MTc2OTIwMCwKICAgICJleHAiOiAxNzk5NTM1NjAwCn0.dc_X5iR_VP_qT0zsiyj_I_OZ2T9FtRU2BBNWN8Bu4GE",ee=hs("admin-users-data"),ae=await fetch(`${ee}?admin_token=${encodeURIComponent(A)}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${Y}`,apikey:Y}});if(!ae.ok){const b=await ae.json().catch(()=>({error:"Неизвестная ошибка"}));console.error("Ошибка загрузки данных:",b),C(!1);return}const ne=await ae.json();if(!ne.success||!ne.data){console.error("Неверный формат ответа от Edge Function"),C(!1);return}console.log("✅ Загружены данные из Supabase:",{organizations:ne.data.organizations?.length||0,userProfiles:ne.data.userProfiles?.length||0,clients:ne.data.clients?.length||0,diaries:ne.data.diaries?.length||0,patientCards:ne.data.patientCards?.length||0,diaryEmployeeAccess:ne.data.diaryEmployeeAccess?.length||0}),ne.data.organizations?.length>0&&console.log("📋 Организации из БД:",ne.data.organizations),ne.data.userProfiles?.length>0&&console.log("👤 Профили пользователей из БД:",ne.data.userProfiles),ne.data.clients?.length>0&&console.log("🏥 Клиенты из БД:",ne.data.clients),O({organizations:ne.data.organizations||[],userProfiles:ne.data.userProfiles||[],clients:ne.data.clients||[],diaries:ne.data.diaries||[],patientCards:ne.data.patientCards||[],diaryEmployeeAccess:ne.data.diaryEmployeeAccess||[]})}catch(A){console.error("Ошибка загрузки данных из Supabase:",A)}finally{C(!1)}})()},[n]);const $=u.useMemo(()=>B.diaries,[n,B.diaries]),p=u.useMemo(()=>B.patientCards,[n,B.patientCards]),k=u.useMemo(()=>{const h=new Map;return p.forEach(A=>{const Y=nr(A?.id);Y&&h.set(Y,A)}),h},[p]),f=u.useMemo(()=>{const h={};return B.diaryEmployeeAccess.forEach(A=>{const Y=nr(A.diary_id);Y&&(h[Y]||(h[Y]=[]),h[Y].push(A))}),h},[n,B.diaryEmployeeAccess]),x=u.useMemo(()=>{const h=new Map,A=E=>{const fe=nr(E.id);if(!fe)return;const ye={id:fe,type:E.type,name:E.name||"Без имени",contact:E.contact??null,roleLabel:E.roleLabel??null,sources:ko(E.sources||[],[`${E.type}`]),diariesCount:E.diariesCount,relations:E.relations?E.relations.map(xe=>({...xe})):[],payload:E.payload??{}},ce=Wa[E.type],me=h.get(fe);if(!me){h.set(fe,{row:ye,priority:ce});return}const _e=ko(me.row.sources,ye.sources),De=[...me.row.relations||[]];if(ye.relations?.forEach(xe=>{const Ee=`${xe.label}:${xe.rawValue??xe.value}`;De.some(kt=>`${kt.label}:${kt.rawValue??kt.value}`===Ee)||De.push(xe)}),ce<me.priority){h.set(fe,{priority:ce,row:{...me.row,...ye,contact:ye.contact??me.row.contact,roleLabel:ye.roleLabel??me.row.roleLabel,sources:_e,relations:De,payload:{...me.row.payload,...ye.payload}}});return}if(ce===me.priority){h.set(fe,{priority:ce,row:{...me.row,contact:me.row.contact||ye.contact,roleLabel:me.row.roleLabel||ye.roleLabel,sources:_e,relations:De,payload:{...me.row.payload,...ye.payload}}});return}h.set(fe,{priority:me.priority,row:{...me.row,sources:_e,relations:De,contact:me.row.contact??ye.contact,roleLabel:me.row.roleLabel??ye.roleLabel,payload:{...ye.payload,...me.row.payload}}})};B.organizations.forEach((E,fe)=>{const ye=E.id||E.user_id||`org_${fe}`,ce=E.type;A(ce==="caregiver"?{id:ye,type:"privateCaregiver",name:E.name||zr(E)||"Частная сиделка",contact:E.phone||E.email||null,roleLabel:"Частная сиделка",relations:E.city?[{label:"Город",value:String(E.city),rawValue:String(E.city)}]:void 0,payload:E,sources:["supabase","organizations"]}:{id:ye,type:"organization",name:E.name||E.title||zr(E)||"Организация",contact:E.phone||E.email||null,roleLabel:qa(ce),payload:E,sources:["supabase","organizations"]})}),B.userProfiles.map(E=>({id:E.user_id,user_id:E.user_id,role:E.role,organization_id:E.organization_id,...E})).forEach((E,fe)=>{const ye=tp(E);if(!ye)return;const ce=E.id||E.user_id||E.userId||E.phone||E.email||`local_user_${fe}`,me=[];E.organization_id&&me.push({label:"Организация",value:String(E.organization_id),rawValue:String(E.organization_id)}),E.caregiver_id&&me.push({label:"Сиделка",value:String(E.caregiver_id),rawValue:String(E.caregiver_id)}),A({id:ce,type:ye,name:zr(E)||E.phone||E.email||"Без имени",contact:E.phone||E.email||null,roleLabel:ye==="organization"?qa(E.organization_type||E.type):ye==="employee"?E.role||"Сотрудник":ye==="privateCaregiver"?"Частная сиделка":void 0,relations:me.length?me:void 0,payload:E,sources:["supabase","user_profiles"]})}),B.userProfiles.filter(E=>E.role==="org_employee").map(E=>({user_id:E.user_id,id:E.user_id,organization_id:E.organization_id,employee_role:E.employee_role||"caregiver",role:E.employee_role||"caregiver",first_name:E.first_name,last_name:E.last_name,phone:E.phone,...E})).forEach((E,fe)=>{const ye=E.user_id||E.id||`employee_${fe}`;A({id:ye,type:"employee",name:zr(E)||E.phone||"Сотрудник без имени",contact:E.phone||E.email||null,roleLabel:E.role||E.employee_role||"Сотрудник",relations:E.organization_id?[{label:"Организация",value:String(E.organization_id),rawValue:String(E.organization_id)}]:void 0,payload:E,sources:["supabase","user_profiles"]})}),B.clients.map(E=>({user_id:E.user_id,id:E.user_id||E.id,first_name:E.first_name,last_name:E.last_name,phone:E.phone,caregiver_id:E.caregiver_id,organization_id:E.organization_id,...E})).forEach((E,fe)=>{const ye=E.user_id||E.id||`client_${fe}`,ce=[];E.caregiver_id&&ce.push({label:"Сиделка",value:String(E.caregiver_id),rawValue:String(E.caregiver_id)}),E.organization_id&&ce.push({label:"Организация",value:String(E.organization_id),rawValue:String(E.organization_id)}),A({id:ye,type:"client",name:zr(E)||E.phone||"Клиент",contact:E.phone||null,roleLabel:ce.length?ce.map(me=>me.label).join(" / "):void 0,relations:ce.length?ce:void 0,payload:E,sources:["supabase","clients"]})});const Q=Array.from(h.values()).map(E=>({...E.row,relations:E.row.relations?E.row.relations.filter((fe,ye,ce)=>fe.value&&ce.findIndex(me=>me.label===fe.label&&me.value===fe.value)===ye):void 0})).sort((E,fe)=>{const ye=Wa[E.type]-Wa[fe.type];return ye!==0?ye:E.name.localeCompare(fe.name,"ru")});return console.log("✅ Сформировано строк:",Q.length,"из них:",{organizations:Q.filter(E=>E.type==="organization").length,employees:Q.filter(E=>E.type==="employee").length,privateCaregivers:Q.filter(E=>E.type==="privateCaregiver").length,clients:Q.filter(E=>E.type==="client").length}),Q},[n,B]),F=u.useMemo(()=>{const h=new Map;return x.forEach(A=>h.set(String(A.id),A)),h},[x]),H=u.useMemo(()=>{const h=new Map;return x.filter(A=>A.type==="organization").forEach(A=>h.set(String(A.id),A.name)),h},[x]),M=u.useMemo(()=>{const h=new Map;return x.filter(A=>A.type==="organization").forEach(A=>{const Y=A.payload?.organization_type||A.payload?.type||A.payload?.role||A.payload?.org_type||null;Y&&h.set(String(A.id),String(Y))}),h},[x]),L=u.useMemo(()=>{const h=new Map;return x.filter(A=>A.type==="employee").forEach(A=>{const Y=A.payload?.organization_id||A.payload?.organizationId||A.payload?.org_id||A.payload?.organization||null,ee=A.relations?.find(ne=>ne.label==="Организация")?.value,ae=Y||ee;ae&&h.set(String(A.id),String(ae))}),h},[x]),U=u.useMemo(()=>$.map(h=>{const A=h.patient_card_id?nr(h.patient_card_id):null,Y=A?k.get(A):null,ee=h.owner_id||h.client_id,ae=ee?nr(ee):null,ne=h.organization_id?nr(h.organization_id):null,b=h.caregiver_id?nr(h.caregiver_id):null,Q=f?.[h.id],E=Array.isArray(Q)?Q.map(fe=>nr(fe?.user_id||fe?.id||fe)).filter(Boolean):[];return{...h,patientCardId:A,patientName:Y?.full_name||Y?.name||"—",ownerId:ae,ownerName:ae?F.get(ae)?.name||ae:null,ownerType:ae&&F.get(ae)?.type||null,organizationId:ne,organizationName:ne&&F.get(ne)?.name||null,organizationType:ne&&M.get(ne)||null,caregiverId:b,caregiverName:b&&F.get(b)?.name||null,assignedEmployees:E,createdAt:h.created_at}}),[$,f,M,k,F]),Z=u.useCallback(h=>{const A=String(h.id);switch(h.type){case"organization":return U.filter(Y=>Y.organizationId&&Vt(Y.organizationId,A)||Y.ownerId&&Vt(Y.ownerId,A));case"employee":{const Y=L.get(A);return U.filter(ee=>ee.assignedEmployees?.some(ne=>Vt(ne,A))?!0:Y&&ee.organizationId&&Vt(ee.organizationId,Y)&&!(ee.assignedEmployees&&ee.assignedEmployees.length>0)?(ee.organizationType||M.get(Y))==="pension":!1)}case"privateCaregiver":return U.filter(Y=>Y.caregiverId&&Vt(Y.caregiverId,A));case"client":return U.filter(Y=>Y.ownerId&&Vt(Y.ownerId,A)||Y.client_id&&Vt(Y.client_id,A));default:return[]}},[U,L,M]),j=u.useMemo(()=>x.map(h=>{const A=h.relations?.map(Y=>{const ee=Y.rawValue??Y.value,ae=(()=>{switch(Y.label){case"Сиделка":return"Приглашён сиделкой";case"Организация":return"Организация";case"Клиент":return"Клиент";case"Город":return"Город";default:return Y.label}})();let ne=Y.value;return Y.label==="Организация"?ne=(ee?F.get(String(ee)):void 0)?.name??H.get(String(ee))??(ee?`ID: ${ee}`:Y.value):(Y.label==="Сиделка"||Y.label==="Клиент")&&(ne=(ee?F.get(String(ee)):void 0)?.name??(ee?`ID: ${ee}`:Y.value)),{label:ae,value:ne,rawValue:ee}})||[];return{...h,relations:A.length?A:void 0,diariesCount:Z(h).length}}),[x,Z,H,F]),v=u.useMemo(()=>j.filter(h=>{if(e!=="all"&&h.type!==e)return!1;if(!s.trim())return!0;const A=s.trim().toLowerCase();return[h.name,h.contact||"",h.roleLabel||"",h.sources.join(" "),...h.relations?.map(ee=>`${ee.label} ${ee.value}`)||[]].join(" ").toLowerCase().includes(A)}),[e,j,s]),z=u.useMemo(()=>({all:j.length,organization:j.filter(A=>A.type==="organization").length,employee:j.filter(A=>A.type==="employee").length,privateCaregiver:j.filter(A=>A.type==="privateCaregiver").length,client:j.filter(A=>A.type==="client").length}),[j]),T=()=>{c(null),_(!1),D(""),I(null)},J=h=>{c(h),D(h.contact||""),I(null)},W=()=>{if(!o)return null;const h=Z(o),A=o.payload||{},Y=zr(A)||o.name,ae=(()=>{switch(o.type){case"organization":return{organizationType:A.type||A.organization_type,address:A.address,city:A.city,email:A.email||(o.contact?.includes("@")?o.contact:null),phone:A.phone||(o.contact?.includes("@")?null:o.contact),userId:A.user_id||o.id,organizationId:A.id,createdAt:A.created_at,updatedAt:A.updated_at};case"employee":return{firstName:A.first_name,lastName:A.last_name,phone:A.phone||o.contact,email:A.email||(o.contact?.includes("@")?o.contact:null),employeeRole:A.employee_role||A.role,organizationId:A.organization_id,userId:A.user_id||o.id,createdAt:A.created_at,updatedAt:A.updated_at};case"privateCaregiver":return{firstName:A.first_name,lastName:A.last_name,phone:A.phone||o.contact,email:A.email||(o.contact?.includes("@")?o.contact:null),city:A.city,userId:A.user_id||o.id,organizationId:A.id,createdAt:A.created_at,updatedAt:A.updated_at};case"client":return{firstName:A.first_name,lastName:A.last_name,phone:A.phone||o.contact,email:A.email||(o.contact?.includes("@")?o.contact:null),caregiverId:A.caregiver_id,organizationId:A.organization_id,userId:A.user_id||o.id,createdAt:A.created_at,updatedAt:A.updated_at};default:return{}}})(),ne=b=>{switch(o.type){case"organization":return b.ownerId&&Vt(b.ownerId,o.id)?"Владелец":"Организация с доступом";case"employee":return b.assignedEmployees?.some(E=>Vt(E,o.id))?"Назначен к дневнику":"Доступ по организации";case"privateCaregiver":return"Сиделка с доступом";case"client":return b.ownerId&&Vt(b.ownerId,o.id)?"Владелец":"Читатель";default:return""}};return t.jsx("div",{className:"fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center px-4",children:t.jsxs("div",{className:"bg-white rounded-3xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden flex flex-col",children:[t.jsxs("div",{className:"px-6 pb-5 pt-0 border-b border-gray-200 flex items-center justify-between gap-6",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx("p",{className:"text-xs uppercase text-gray-400",children:Gt[o.type]}),t.jsx("h2",{className:"text-xl font-semibold text-gray-800",children:o.name}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2 mt-3",children:[t.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded-full bg-[#55ACBF]/10 text-xs font-semibold text-[#0A6D83]",children:Gt[o.type]}),t.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded-full bg-gray-100 text-xs font-semibold text-gray-600",children:["Дневников: ",h.length]}),o.sources.map(b=>t.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded-full bg-gray-100 text-[11px] font-medium text-gray-600",children:b},`modal-chip-${b}`))]})]}),t.jsx("button",{onClick:T,className:"text-gray-500 hover:text-gray-700 text-lg",children:"✕"})]}),t.jsxs("div",{className:"px-6 py-5 overflow-y-auto space-y-6",children:[t.jsxs("section",{className:"space-y-3",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Профиль"}),t.jsxs("div",{className:"grid gap-3 sm:grid-cols-2",children:[t.jsxs("div",{className:"bg-gray-50 rounded-2xl p-4",children:[t.jsx("p",{className:"text-xs uppercase text-gray-500 mb-1",children:"Название / Имя"}),t.jsx("p",{className:"text-sm font-medium text-gray-800",children:Y||"—"}),o.type==="organization"&&ae.organizationType&&t.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Тип: ",qa(ae.organizationType)]}),(o.type==="employee"||o.type==="privateCaregiver"||o.type==="client")&&t.jsxs("div",{className:"mt-1 space-y-0.5",children:[ae.firstName&&t.jsxs("p",{className:"text-xs text-gray-500",children:["Имя: ",ae.firstName]}),ae.lastName&&t.jsxs("p",{className:"text-xs text-gray-500",children:["Фамилия: ",ae.lastName]})]})]}),t.jsx("div",{className:"bg-gray-50 rounded-2xl p-4 space-y-2",children:t.jsxs("div",{children:[t.jsx("p",{className:"text-xs uppercase text-gray-500 mb-1",children:"Контакты"}),t.jsxs("div",{className:"space-y-1",children:[ae.phone&&t.jsxs("p",{className:"text-sm text-gray-800",children:["📞 ",ae.phone]}),ae.email&&t.jsxs("p",{className:"text-sm text-gray-800",children:["✉️ ",ae.email]}),!ae.phone&&!ae.email&&t.jsx("p",{className:"text-sm text-gray-500",children:o.contact||"—"})]})]})}),t.jsxs("div",{className:"bg-gray-50 rounded-2xl p-4",children:[t.jsx("p",{className:"text-xs uppercase text-gray-500 mb-1",children:"Роль / Тип"}),t.jsx("p",{className:"text-sm font-medium text-gray-800",children:o.roleLabel||"—"}),o.type==="employee"&&ae.employeeRole&&t.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Должность: ",ae.employeeRole==="manager"?"Руководитель":ae.employeeRole==="caregiver"?"Сиделка":ae.employeeRole==="doctor"?"Врач":ae.employeeRole]})]}),o.type==="organization"&&t.jsxs(t.Fragment,{children:[ae.address&&t.jsxs("div",{className:"bg-gray-50 rounded-2xl p-4",children:[t.jsx("p",{className:"text-xs uppercase text-gray-500 mb-1",children:"Адрес"}),t.jsx("p",{className:"text-sm text-gray-800",children:ae.address})]}),ae.city&&t.jsxs("div",{className:"bg-gray-50 rounded-2xl p-4",children:[t.jsx("p",{className:"text-xs uppercase text-gray-500 mb-1",children:"Город"}),t.jsx("p",{className:"text-sm text-gray-800",children:ae.city})]})]}),o.type==="privateCaregiver"&&ae.city&&t.jsxs("div",{className:"bg-gray-50 rounded-2xl p-4",children:[t.jsx("p",{className:"text-xs uppercase text-gray-500 mb-1",children:"Город"}),t.jsx("p",{className:"text-sm text-gray-800",children:ae.city})]}),t.jsxs("div",{className:"bg-gray-50 rounded-2xl p-4",children:[t.jsx("p",{className:"text-xs uppercase text-gray-500 mb-1",children:"Идентификаторы"}),t.jsxs("div",{className:"space-y-1",children:[ae.userId&&t.jsxs("p",{className:"text-xs text-gray-600 break-all",children:["User ID: ",t.jsx("span",{className:"font-mono",children:ae.userId})]}),ae.organizationId&&o.type==="organization"&&t.jsxs("p",{className:"text-xs text-gray-600 break-all",children:["Org ID: ",t.jsx("span",{className:"font-mono",children:ae.organizationId})]}),ae.organizationId&&o.type==="employee"&&t.jsxs("p",{className:"text-xs text-gray-600 break-all",children:["Организация ID: ",t.jsx("span",{className:"font-mono",children:ae.organizationId})]})]})]}),(ae.createdAt||ae.updatedAt)&&t.jsxs("div",{className:"bg-gray-50 rounded-2xl p-4",children:[t.jsx("p",{className:"text-xs uppercase text-gray-500 mb-1",children:"Даты"}),t.jsxs("div",{className:"space-y-1",children:[ae.createdAt&&t.jsxs("p",{className:"text-xs text-gray-600",children:["Создан: ",new Date(ae.createdAt).toLocaleString("ru-RU")]}),ae.updatedAt&&t.jsxs("p",{className:"text-xs text-gray-600",children:["Обновлён: ",new Date(ae.updatedAt).toLocaleString("ru-RU")]})]})]}),t.jsxs("div",{className:"bg-gray-50 rounded-2xl p-4",children:[t.jsx("p",{className:"text-xs uppercase text-gray-500 mb-1",children:"Источник данных"}),t.jsx("div",{className:"flex flex-wrap gap-2 mt-1",children:o.sources.map(b=>t.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded-full bg-white text-xs font-medium text-[#0A6D83] border border-[#55ACBF]/40",children:b},b))})]})]})]}),o.relations&&o.relations.length>0&&t.jsxs("section",{className:"space-y-3",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Связанные сущности"}),t.jsx("div",{className:"grid gap-3 sm:grid-cols-2",children:o.relations.map(b=>{const Q=b.rawValue?F.get(String(b.rawValue)):void 0;return t.jsxs("div",{className:"bg-gray-50 rounded-2xl p-4",children:[t.jsx("p",{className:"text-xs uppercase text-gray-500 mb-1",children:b.label}),t.jsx("p",{className:"text-sm font-medium text-gray-800",children:b.value}),Q&&t.jsxs("div",{className:"mt-2 flex flex-wrap gap-1",children:[t.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded-full bg-white text-[10px] font-medium text-gray-600 border border-gray-200",children:Gt[Q.type]}),Q.contact&&t.jsx("span",{className:"text-[10px] text-gray-500",children:Q.contact})]})]},`relation-${b.label}-${b.value}`)})})]}),o.type==="client"&&t.jsxs("section",{className:"space-y-3",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Связи клиента"}),t.jsxs("div",{className:"grid gap-3 sm:grid-cols-2",children:[ae.caregiverId&&t.jsxs("div",{className:"bg-gray-50 rounded-2xl p-4",children:[t.jsx("p",{className:"text-xs uppercase text-gray-500 mb-1",children:"Приглашён сиделкой"}),(()=>{const b=F.get(String(ae.caregiverId));return b?t.jsxs(t.Fragment,{children:[t.jsx("p",{className:"text-sm font-medium text-gray-800",children:b.name}),b.contact&&t.jsx("p",{className:"text-xs text-gray-500 mt-1",children:b.contact})]}):t.jsxs("p",{className:"text-sm text-gray-600 break-all",children:["ID: ",t.jsx("span",{className:"font-mono",children:ae.caregiverId})]})})()]}),ae.organizationId&&t.jsxs("div",{className:"bg-gray-50 rounded-2xl p-4",children:[t.jsx("p",{className:"text-xs uppercase text-gray-500 mb-1",children:"Организация"}),(()=>{const b=F.get(String(ae.organizationId));return b?t.jsxs(t.Fragment,{children:[t.jsx("p",{className:"text-sm font-medium text-gray-800",children:b.name}),b.contact&&t.jsx("p",{className:"text-xs text-gray-500 mt-1",children:b.contact})]}):t.jsxs("p",{className:"text-sm text-gray-600 break-all",children:["ID: ",t.jsx("span",{className:"font-mono",children:ae.organizationId})]})})()]})]})]}),t.jsxs("section",{className:"space-y-3",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Доступ к дневникам"}),t.jsxs("span",{className:"text-sm text-gray-500",children:["Всего: ",h.length]})]}),t.jsx("div",{className:"border border-gray-200 rounded-2xl overflow-x-auto hidden md:block",children:t.jsxs("table",{className:"min-w-full divide-y divide-gray-200 text-sm",children:[t.jsx("thead",{className:"bg-[#F7FCFD] text-gray-500 uppercase tracking-wide text-xs",children:t.jsxs("tr",{children:[t.jsx("th",{className:"px-4 py-3 text-left",children:"ID дневника"}),t.jsx("th",{className:"px-4 py-3 text-left",children:"Подопечный"}),t.jsx("th",{className:"px-4 py-3 text-left",children:"Владелец"}),t.jsx("th",{className:"px-4 py-3 text-left",children:"Роль"}),t.jsx("th",{className:"px-4 py-3 text-left",children:"Организация"}),t.jsx("th",{className:"px-4 py-3 text-left",children:"Создан"})]})}),t.jsx("tbody",{className:"divide-y divide-gray-100 bg-white",children:h.length===0?t.jsx("tr",{children:t.jsx("td",{colSpan:6,className:"px-4 py-8 text-center text-sm text-gray-500",children:"Связанных дневников пока нет"})}):h.map(b=>t.jsxs("tr",{children:[t.jsx("td",{className:"px-4 py-3 font-mono text-xs text-gray-700 break-all",children:b.id}),t.jsx("td",{className:"px-4 py-3 text-gray-700",children:t.jsxs("div",{className:"space-y-1",children:[t.jsx("span",{className:"font-medium text-sm",children:b.patientName||"—"}),b.patientCardId&&t.jsxs("div",{className:"text-xs text-gray-400 break-all leading-tight",children:["Карточка:",t.jsx("div",{className:"mt-1",children:b.patientCardId})]})]})}),t.jsx("td",{className:"px-4 py-3 text-gray-700",children:t.jsxs("div",{className:"space-y-1",children:[t.jsx("span",{className:"font-medium text-sm",children:b.ownerName||"—"}),b.ownerType&&t.jsx("span",{className:"text-xs text-gray-400",children:Gt[b.ownerType]||b.ownerType})]})}),t.jsx("td",{className:"px-4 py-3 text-gray-600",children:t.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded-full bg-gray-100 text-xs font-medium text-gray-600",children:ne(b)})}),t.jsx("td",{className:"px-4 py-3 text-gray-600",children:b.organizationName?t.jsxs("div",{className:"space-y-1",children:[t.jsx("span",{className:"text-sm",children:b.organizationName}),b.organizationId&&t.jsxs("span",{className:"text-xs text-gray-400 break-all",children:["ID: ",b.organizationId]})]}):"—"}),t.jsx("td",{className:"px-4 py-3 text-gray-500",children:b.created_at?new Date(b.created_at).toLocaleString("ru-RU"):"—"})]},b.id))})]})}),t.jsx("div",{className:"md:hidden space-y-3",children:h.length===0?t.jsx("div",{className:"rounded-2xl border border-dashed border-gray-300 bg-white p-6 text-sm text-gray-500 text-center",children:"Связанных дневников пока нет"}):h.map(b=>t.jsxs("div",{className:"rounded-2xl border border-gray-200 bg-white p-5 flex flex-col gap-3",children:[t.jsxs("div",{className:"flex flex-wrap items-start justify-between gap-2",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-semibold text-gray-800",children:b.patientName||"Без названия"}),t.jsxs("p",{className:"text-xs text-gray-400 break-all mt-1",children:["Дневник: ",t.jsx("span",{className:"font-mono",children:b.id})]})]}),t.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded-full bg-gray-100 text-xs font-medium text-gray-600",children:ne(b)})]}),b.patientCardId&&t.jsxs("p",{className:"text-xs text-gray-500 break-all",children:["Карточка: ",t.jsx("span",{className:"font-mono",children:b.patientCardId})]}),t.jsxs("div",{className:"grid grid-cols-1 gap-2 text-sm text-gray-600",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-xs uppercase tracking-wide text-gray-500",children:"Владелец"}),t.jsx("p",{className:"font-medium",children:b.ownerName||"—"}),b.ownerType&&t.jsx("p",{className:"text-xs text-gray-400",children:Gt[b.ownerType]||b.ownerType})]}),t.jsxs("div",{children:[t.jsx("p",{className:"text-xs uppercase tracking-wide text-gray-500",children:"Организация"}),b.organizationName?t.jsxs(t.Fragment,{children:[t.jsx("p",{className:"font-medium",children:b.organizationName}),b.organizationId&&t.jsxs("p",{className:"text-xs text-gray-400 break-all",children:["ID: ",b.organizationId]})]}):t.jsx("p",{className:"text-gray-400",children:"—"})]}),t.jsxs("div",{children:[t.jsx("p",{className:"text-xs uppercase tracking-wide text-gray-500",children:"Создан"}),t.jsx("p",{children:b.created_at?new Date(b.created_at).toLocaleString("ru-RU"):"—"})]})]})]},`${o?.id}-diary-${b.id}`))})]}),t.jsxs("section",{className:"space-y-3",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Управление"}),t.jsx("div",{className:"bg-gray-50 rounded-2xl p-4",children:t.jsx("p",{className:"text-sm text-gray-600",children:"Функции управления пользователями будут доступны в следующих версиях админ-панели."})})]})]})]})})};return t.jsxs("div",{className:"space-y-8",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsx("h2",{className:"text-2xl font-bold text-gray-800",children:"Пользователи и доступы"}),t.jsx("p",{className:"text-sm text-gray-600 leading-relaxed max-w-3xl",children:"Просмотр организаций, сотрудников и клиентов, анализ их активности."})]}),t.jsx("div",{className:"grid gap-4 sm:grid-cols-2 lg:grid-cols-4",children:Object.keys(Gt).map(h=>t.jsxs("div",{role:"button",tabIndex:0,onClick:()=>r(h),onKeyDown:A=>{(A.key==="Enter"||A.key===" ")&&(A.preventDefault(),r(h))},className:`rounded-3xl border p-5 shadow-sm transition-colors cursor-pointer focus:outline-none focus:ring-2 focus:ring-[#55ACBF] focus:ring-offset-2 ${e===h?"border-[#55ACBF] bg-[#F7FCFD]":"border-gray-200 bg-white"}`,children:[t.jsxs("div",{className:"flex items-start justify-between gap-2",children:[t.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide",children:Gt[h]}),e===h&&t.jsx("span",{className:"text-[10px] font-semibold text-[#0A6D83] bg-[#0A6D83]/10 px-2 py-0.5 rounded-full",children:"Активно"})]}),t.jsx("p",{className:"text-2xl font-semibold text-gray-800 mt-1",children:h==="all"?z.all:z[h]}),t.jsx("p",{className:"text-[11px] text-gray-400 mt-2",children:h==="all"?"Всего профилей":h==="organization"?"Партнёрские организации":h==="employee"?"Внутренние специалисты":h==="privateCaregiver"?"Приглашённые частные сиделки":"Активные клиенты"})]},h))}),t.jsxs("div",{className:"bg-white border border-gray-200 rounded-3xl p-6 space-y-6 shadow-sm",children:[t.jsx("section",{className:"space-y-4",children:t.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-4 justify-between",children:[t.jsx(he,{value:s,onChange:h=>a(h.target.value),placeholder:"Поиск по имени, телефону, связям или источнику...",className:"sm:w-72 w-full"}),t.jsx("div",{className:"flex flex-wrap items-center gap-2 text-xs font-medium",children:Object.keys(Gt).map(h=>t.jsx("button",{onClick:()=>r(h),className:`px-3 py-1 rounded-full border transition-colors whitespace-normal text-left leading-tight max-w-[160px] ${e===h?"bg-[#55ACBF]/10 text-[#0A6D83] border-[#55ACBF]":"border-gray-200 text-gray-500 hover:text-[#0A6D83] hover:border-[#55ACBF]/40"}`,children:Gt[h]},h))}),t.jsx(oe,{variant:"outline",size:"sm",onClick:()=>{i(h=>h+1),C(!0)},className:"whitespace-nowrap",disabled:P,children:P?"Загрузка...":"Обновить данные"})]})}),t.jsxs("section",{className:"space-y-4",children:[t.jsx("div",{className:"overflow-hidden border border-gray-200 rounded-2xl overflow-x-auto hidden lg:block",children:t.jsxs("table",{className:"min-w-full divide-y divide-gray-200 text-sm",children:[t.jsx("thead",{className:"bg-[#F7FCFD] text-gray-500 uppercase tracking-wide text-xs",children:t.jsxs("tr",{children:[t.jsx("th",{className:"px-4 py-3 text-left",children:"Тип"}),t.jsx("th",{className:"px-4 py-3 text-left",children:"Имя"}),t.jsx("th",{className:"px-4 py-3 text-left",children:"Контакты"}),t.jsx("th",{className:"px-4 py-3 text-left",children:"Роль и связи"}),t.jsx("th",{className:"px-4 py-3 text-left",children:"Доступ к дневникам"}),t.jsx("th",{className:"px-4 py-3 text-left",children:"Источник данных"}),t.jsx("th",{className:"px-4 py-3 text-left",children:"Действия"})]})}),t.jsx("tbody",{className:"divide-y divide-gray-100 bg-white",children:v.length===0?t.jsx("tr",{children:t.jsx("td",{colSpan:7,className:"px-4 py-10 text-center text-sm text-gray-500",children:"Пользователи не найдены. Измените фильтр или обновите данные."})}):v.map(h=>t.jsxs("tr",{children:[t.jsx("td",{className:"px-4 py-3 text-gray-800",children:t.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-[#F7FCFD] text-[#0A6D83] border border-[#55ACBF]/40",children:h.type==="organization"?"Организация":h.type==="employee"?"Сотрудник":h.type==="privateCaregiver"?"Частная сиделка":"Клиент"})}),t.jsx("td",{className:"px-4 py-3 text-gray-800 font-medium",children:t.jsxs("div",{className:"space-y-1",children:[t.jsx("span",{children:h.name}),t.jsxs("span",{className:"text-xs text-gray-400 break-all",children:["ID: ",h.id]})]})}),t.jsx("td",{className:"px-4 py-3 text-gray-700",children:h.contact||"—"}),t.jsx("td",{className:"px-4 py-3 text-gray-600",children:t.jsxs("div",{className:"space-y-2",children:[t.jsx("p",{className:"text-sm font-medium text-gray-700",children:h.roleLabel?`Роль: ${h.roleLabel}`:"Роль не указана"}),h.relations&&h.relations.length>0?t.jsx("div",{className:"flex flex-wrap gap-1.5",children:h.relations.map(A=>t.jsxs("span",{className:"inline-flex items-center px-2.5 py-1 rounded-full text-[11px] text-[#0A6D83] bg-[#E5F4F7]",children:[A.label,": ",A.value]},`${h.id}-${A.label}-${A.value}`))}):t.jsx("span",{className:"text-xs text-gray-400",children:"Дополнительных связей нет"})]})}),t.jsx("td",{className:"px-4 py-3",children:t.jsx("span",{className:`inline-flex items-center justify-center min-w-[2.5rem] px-2 py-1 rounded-full text-xs font-semibold ${(h.diariesCount??0)>0?"bg-[#55ACBF]/10 text-[#0A6D83]":"bg-gray-100 text-gray-500"}`,children:h.diariesCount??0})}),t.jsx("td",{className:"px-4 py-3",children:t.jsx("div",{className:"flex flex-wrap gap-1",children:h.sources.map(A=>t.jsxs("span",{className:"inline-flex items-center gap-1 text-[11px] font-medium px-2 py-1 rounded-full bg-[#F1F5F9] text-gray-600 border border-slate-200",children:[t.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-gray-400"}),A]},`${h.id}-${A}`))})}),t.jsx("td",{className:"px-4 py-3",children:t.jsx(oe,{variant:"outline",size:"sm",onClick:()=>J(h),children:"Подробнее"})})]},`${h.type}-${h.id}`))})]})}),t.jsx("div",{className:"lg:hidden space-y-3",children:v.length===0?t.jsx("div",{className:"rounded-2xl border border-dashed border-gray-300 bg-white p-6 text-sm text-gray-500 text-center",children:"Пользователи не найдены. Измените фильтр или обновите данные."}):v.map(h=>t.jsxs("div",{className:"rounded-2xl border border-gray-200 bg-white p-5 shadow-sm flex flex-col gap-3",children:[t.jsxs("div",{className:"flex flex-wrap items-center gap-2 justify-between",children:[t.jsx("span",{className:"inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-[#F7FCFD] text-[#0A6D83] border border-[#55ACBF]/40",children:h.type==="organization"?"Организация":h.type==="employee"?"Сотрудник":h.type==="privateCaregiver"?"Частная сиделка":"Клиент"}),t.jsx("button",{onClick:()=>J(h),className:"text-xs font-semibold text-[#0A6D83] underline underline-offset-4",children:"Открыть профиль"})]}),t.jsxs("div",{className:"space-y-1.5",children:[t.jsx("p",{className:"text-base font-semibold text-gray-800",children:h.name}),t.jsxs("p",{className:"text-xs text-gray-400 break-all",children:["ID: ",h.id]}),t.jsx("p",{className:"text-sm text-gray-600",children:h.contact||"Контакты не указаны"})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx("p",{className:"text-xs uppercase tracking-wide text-gray-500",children:"Роль и связи"}),t.jsxs("div",{className:"space-y-1.5",children:[t.jsx("p",{className:"text-sm text-gray-700",children:h.roleLabel?`Роль: ${h.roleLabel}`:"Роль не указана"}),h.relations&&h.relations.length>0?t.jsx("div",{className:"flex flex-wrap gap-1.5",children:h.relations.map(A=>t.jsxs("span",{className:"inline-flex items-center px-2.5 py-1 rounded-full text-[11px] text-[#0A6D83] bg-[#E5F4F7]",children:[A.label,": ",A.value]},`${h.id}-${A.label}-${A.value}-card`))}):t.jsx("span",{className:"text-xs text-gray-400",children:"Дополнительных связей нет"})]})]}),t.jsxs("div",{className:"flex items-center justify-between text-xs text-gray-500",children:[t.jsxs("div",{children:["Доступ к дневникам:"," ",t.jsx("span",{className:"font-semibold text-[#0A6D83]",children:h.diariesCount??0})]}),t.jsxs("span",{className:"text-right max-w-[50%]",children:["Источники: ",h.sources.length?h.sources.join(", "):"—"]})]})]},`${h.type}-${h.id}-card`))})]})]}),W()]})},sp=e=>{switch(e){case"pension":return"Пансионат";case"patronage_agency":return"Патронажное агентство";case"caregiver":return"Частная сиделка";default:return e?String(e):null}},rs=e=>{const{full_name:r,name:s,first_name:a,last_name:n}=e||{};if(r&&String(r).trim().length>0)return String(r).trim();if(s&&String(s).trim().length>0)return String(s).trim();const i=`${a||""} ${n||""}`.trim();return i.length>0?i:""},Zt=e=>e==null?"":String(e),Ht=e=>{if(!e||typeof e!="object")return!1;const r=String(e.status??e.state??e.lifecycle??"").trim().toLowerCase();return!!(["deleted","archived","removed","inactive"].includes(r)||e.deleted===!0||e.is_deleted===!0||e.archived===!0||e.is_archived===!0||e.deleted_at||e.removed_at||e.archived_at)},ap=()=>{try{const e=localStorage.getItem("admin_support_audit");if(!e)return[];const r=JSON.parse(e);if(Array.isArray(r))return r}catch(e){console.warn("Не удалось загрузить журнал поддержки",e)}return[]},np=e=>({walk:"Прогулка",cognitive_games:"Когнитивные игры",diaper_change:"Смена подгузников",hygiene:"Гигиена",skin_moisturizing:"Увлажнение кожи",meal:"Прием пищи",medications:"Прием лекарств",vitamins:"Прием витаминов",sleep:"Сон",temperature:"Температура",blood_pressure:"Давление",breathing_rate:"Частота дыхания",pain_level:"Уровень боли",saturation:"Сатурация",blood_sugar:"Уровень сахара в крови",urination:"Выделение мочи",defecation:"Дефекация",nausea:"Тошнота",vomiting:"Рвота",shortness_of_breath:"Одышка",itching:"Зуд",cough:"Кашель",dry_mouth:"Сухость во рту",hiccups:"Икота",taste_disturbance:"Нарушение вкуса",support_note:"Запись поддержки"})[e]||e,ip={walks:"Ходит",sits:"Сидит",lies:"Лежит"},Ao=e=>{if(!e)return"—";try{return new Date(e).toLocaleString("ru-RU")}catch{return e}},Co=e=>{if(!e)return"";try{return new Date(e).toISOString().slice(0,10)}catch{return e}},op=()=>{const[e,r]=u.useState(""),[s,a]=u.useState(0),[n,i]=u.useState(null),[o,c]=u.useState("overview"),[g,_]=u.useState(!1),[y,D]=u.useState(null),[w,I]=u.useState(null),[P,C]=u.useState([]),[B,O]=u.useState({metricType:"",value:"",note:""}),[$,p]=u.useState(null),[k,f]=u.useState("all"),[x,F]=u.useState("desc"),[H,M]=u.useState(!0),[L,U]=u.useState({diaries:[],patientCards:[],organizations:[],userProfiles:[],clients:[],employees:[],privateCaregivers:[],metricValues:[],history:[]});u.useEffect(()=>{(async()=>{try{M(!0);const A=localStorage.getItem("admin_token")||"b8f56f5c-62f1-45d9-9e5a-e8bbfdadcf0f",Y="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyAgCiAgICAicm9sZSI6ICJhbm9uIiwKICAgICJpc3MiOiAic3VwYWJhc2UtZGVtbyIsCiAgICAiaWF0IjogMTY0MTc2OTIwMCwKICAgICJleHAiOiAxNzk5NTM1NjAwCn0.dc_X5iR_VP_qT0zsiyj_I_OZ2T9FtRU2BBNWN8Bu4GE",ee=hs("admin-support-data"),ae=await fetch(`${ee}?admin_token=${encodeURIComponent(A)}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${Y}`,apikey:Y}});if(!ae.ok){const b=await ae.json().catch(()=>({error:"Неизвестная ошибка"}));console.error("Ошибка загрузки данных:",b),M(!1);return}const ne=await ae.json();if(!ne.success||!ne.data){console.error("Неверный формат ответа от Edge Function"),M(!1);return}console.log("✅ Загружены данные из Supabase для поддержки:",{diaries:ne.data.diaries?.length||0,patientCards:ne.data.patientCards?.length||0,organizations:ne.data.organizations?.length||0,metricValues:ne.data.metricValues?.length||0,history:ne.data.history?.length||0}),U({diaries:ne.data.diaries||[],patientCards:ne.data.patientCards||[],organizations:ne.data.organizations||[],userProfiles:ne.data.userProfiles||[],clients:ne.data.clients||[],employees:ne.data.employees||[],privateCaregivers:ne.data.privateCaregivers||[],metricValues:ne.data.metricValues||[],history:ne.data.history||[]})}catch(A){console.error("Ошибка загрузки данных из Supabase:",A)}finally{M(!1)}})()},[s]);const Z=u.useMemo(()=>{const h=L.diaries.filter(ce=>!Ht(ce)),A=L.patientCards,Y=L.userProfiles,ee=L.clients,ae=L.employees,ne=L.organizations,b=L.privateCaregivers,Q=new Map;A.forEach(ce=>{Ht(ce)||Q.set(Zt(ce?.id),ce)});const E=ce=>{if(!ce)return null;const me=Zt(ce),_e=Y.find(Ae=>Zt(Ae?.user_id||Ae?.id)===me);if(_e&&!Ht(_e))return{id:me,name:rs(_e)||_e.phone||_e.email||`Пользователь ${me}`,contact:_e.phone||_e.email||"",role:_e.user_role||"Пользователь",source:"user_profiles",raw:_e};const De=ee.find(Ae=>Zt(Ae?.user_id||Ae?.id)===me);if(De&&!Ht(De))return{id:me,name:rs(De)||De.phone||`Клиент ${me}`,contact:De.phone||"",role:"Клиент",source:"clients",raw:De};const xe=ae.find(Ae=>Zt(Ae?.user_id||Ae?.id)===me);if(xe&&!Ht(xe))return{id:me,name:rs(xe)||xe.phone||`Сотрудник ${me}`,contact:xe.phone||xe.email||"",role:xe.role||"Сотрудник",source:"organization_employees",raw:xe};const Ee=b.find(Ae=>Zt(Ae?.user_id||Ae?.id)===me);return Ee&&!Ht(Ee)?{id:me,name:rs(Ee)||Ee.phone||`Сиделка ${me}`,contact:Ee.phone||Ee.email||"",role:"Частная сиделка",source:"private_caregiver_profiles",raw:Ee}:{id:me,name:`ID: ${me}`,contact:"",role:"",source:"unknown"}},fe=ce=>{if(!ce)return null;const me=Zt(ce),_e=ne.find(De=>{const xe=De?.id??De?.user_id;return Zt(xe)===me});return!_e||Ht(_e)?null:{id:me,name:_e.name||rs(_e)||`Организация ${me}`,contact:_e.phone||_e.email||"",typeLabel:sp(_e.type),raw:_e}},ye=[];return h.forEach(ce=>{if(Ht(ce))return;const me=Zt(ce?.id);if(!me)return;const _e=Zt(ce?.patient_card_id),De=_e?Q.get(_e):void 0;if(_e&&!De||De&&Ht(De))return;const xe=E(ce?.owner_id??ce?.client_id),Ee=E(ce?.caregiver_id),Ae=fe(ce?.organization_id),kt=De?.full_name||De?.name||xe?.name||ce?.patient_name||`Подопечный (${_e||"без карточки"})`;ye.push({id:me,createdAt:ce?.created_at||null,cardId:_e||null,patientName:kt,card:De,owner:xe,caregiver:Ee,organization:Ae,raw:ce})}),ye},[s,L]),j=u.useMemo(()=>{const h=Z.length,A=Z.filter(ae=>ae.organization).length,Y=Z.filter(ae=>ae.caregiver).length,ee=h-A;return{total:h,withOrg:A,withoutOrg:ee,withCaregiver:Y}},[Z]),v=u.useMemo(()=>{const h=Z.filter(ee=>{switch(k){case"with_org":return!!ee.organization;case"without_org":return!ee.organization;case"with_caregiver":return!!ee.caregiver;default:return!0}}),A=e.trim().toLowerCase();return(A?h.filter(ee=>[ee.id,ee.patientName,ee.cardId,ee.owner?.name,ee.owner?.contact,ee.organization?.name,ee.organization?.typeLabel,ee.caregiver?.name].join(" ").toLowerCase().includes(A)):h).slice().sort((ee,ae)=>{const ne=ee.createdAt?new Date(ee.createdAt).getTime():0,b=ae.createdAt?new Date(ae.createdAt).getTime():0;return x==="desc"?b-ne:ne-b})},[Z,e,k,x]);u.useEffect(()=>{if(v.length===0){i(null);return}(!n||!v.some(h=>h.id===n))&&(i(v[0].id),c("overview"))},[v,n]);const z=u.useMemo(()=>v.find(h=>h.id===n)||null,[v,n]);u.useEffect(()=>{if(!z){D(null),C([]);return}const h=z.card;D({full_name:h?.full_name||"",date_of_birth:Co(h?.date_of_birth),address:h?.address||"",entrance:h?.entrance||"",apartment:h?.apartment||"",gender:h?.gender==="female"?"female":"male",mobility:h?.mobility||"walks",has_pets:!!h?.has_pets,diagnoses:Array.isArray(h?.diagnoses)?h.diagnoses:[],services:Array.isArray(h?.services)?h.services:[],service_wishes:Array.isArray(h?.service_wishes)?h.service_wishes:[]});const A=L.history.filter(ee=>ee.diary_id===z.id).map(ee=>({id:ee.id,diary_id:ee.diary_id,metric_type:ee.metric_type||"support_note",value:ee.value||ee.details||"",created_at:ee.occurred_at||ee.created_at||new Date().toISOString()})),Y=L.metricValues.filter(ee=>ee.diary_id===z.id).map(ee=>({id:ee.id,diary_id:ee.diary_id,metric_type:ee.metric_type,value:typeof ee.value=="object"?JSON.stringify(ee.value):String(ee.value||""),created_at:ee.recorded_at||ee.created_at||new Date().toISOString()}));C([...A,...Y]),O({metricType:"",value:"",note:""}),I(null),p(null)},[z?.id,s,L.history,L.metricValues]);const T=u.useMemo(()=>ap(),[s]);u.useMemo(()=>T.filter(h=>z&&h.diaryId===z.id).sort((h,A)=>new Date(A.timestamp).getTime()-new Date(h.timestamp).getTime()),[T,z]);const J=(h,A=!1)=>{i(h),c("overview"),A&&_(!0)},W=()=>{_(!1)};return t.jsxs("div",{className:"space-y-8",children:[t.jsx("div",{className:"space-y-2",children:t.jsx("h2",{className:"text-2xl font-bold text-gray-800",children:"Помощь пользователям"})}),t.jsx("div",{className:"grid gap-3 sm:grid-cols-2 lg:grid-cols-4",children:[{label:"Всего дневников",value:j.total},{label:"С организациями",value:j.withOrg},{label:"С сиделками",value:j.withCaregiver},{label:"Без организации",value:j.withoutOrg}].map(h=>t.jsxs("div",{className:"bg-white border border-gray-200 rounded-2xl p-4 shadow-sm flex flex-col gap-1",children:[t.jsx("span",{className:"text-xs uppercase text-gray-400",children:h.label}),t.jsx("span",{className:"text-2xl font-semibold text-[#0A6D83]",children:h.value})]},h.label))}),H?t.jsx("div",{className:"bg-white border border-gray-200 rounded-3xl p-6 shadow-sm text-center text-gray-500",children:"Загрузка данных..."}):t.jsx("div",{className:"bg-white border border-gray-200 rounded-3xl p-6 shadow-sm space-y-6",children:t.jsxs("div",{className:"flex flex-col lg:flex-row gap-6",children:[t.jsxs("div",{className:"lg:w-1/3 space-y-4",children:[t.jsx(he,{value:e,onChange:h=>r(h.target.value),placeholder:"Поиск по ФИО, организации или ID дневника"}),t.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3 text-xs",children:[t.jsx("div",{className:"flex flex-wrap gap-2",children:[{value:"all",label:"Все"},{value:"with_org",label:"С организацией"},{value:"without_org",label:"Без организации"},{value:"with_caregiver",label:"С сиделкой"}].map(h=>t.jsx("button",{onClick:()=>f(h.value),className:`px-3 py-1 rounded-full border transition-colors ${k===h.value?"border-[#55ACBF] bg-[#55ACBF]/10 text-[#0A6D83] font-medium":"border-gray-200 text-gray-500 hover:border-[#55ACBF]/40"}`,type:"button",children:h.label},h.value))}),t.jsxs("button",{type:"button",onClick:()=>F(h=>h==="desc"?"asc":"desc"),className:"px-3 py-1 rounded-full border border-gray-200 text-gray-600 hover:border-[#55ACBF]/40 transition-colors",children:["Сортировка: ",x==="desc"?"сначала новые":"сначала старые"]})]}),t.jsxs("div",{className:"border border-gray-100 rounded-2xl divide-y divide-gray-100 max-h-[520px] overflow-y-auto",children:[v.length===0&&t.jsx("div",{className:"px-4 py-6 text-sm text-gray-500 text-center",children:"Дневники не найдены. Измените запрос поиска."}),v.map(h=>{const A=h.id===n;return t.jsx("button",{onClick:()=>J(h.id,!0),className:`w-full text-left px-4 py-4 transition-colors rounded-2xl border ${A?"border-[#55ACBF] bg-[#F7FCFD] shadow-sm":"border-transparent hover:border-[#55ACBF]/30 hover:bg-gray-50"}`,children:t.jsxs("div",{className:"space-y-1",children:[t.jsx("p",{className:"text-sm font-semibold text-gray-800",children:h.patientName}),t.jsxs("p",{className:"text-xs text-gray-500 break-all",children:["ID дневника: ",h.id]}),h.cardId&&t.jsxs("p",{className:"text-xs text-gray-500 break-all",children:["Карточка: ",h.cardId]}),t.jsxs("div",{className:"flex flex-wrap gap-1 text-[11px] text-gray-500",children:[h.owner&&t.jsxs("span",{children:["Владелец: ",h.owner.name]}),h.organization&&t.jsxs("span",{children:["Орг.: ",h.organization.name]})]})]})},h.id)})]})]}),t.jsx("div",{className:"lg:flex-1 bg-gray-50 rounded-3xl p-6 space-y-6 border border-gray-100",children:z?t.jsx(t.Fragment,{}):t.jsx("div",{className:"text-center text-sm text-gray-500 py-12",children:"Выберите дневник слева, чтобы просмотреть подробности."})})]})}),z&&g&&t.jsx("div",{className:"fixed inset-0 bg-black/40 z-50 flex items-center justify-center px-4",children:t.jsxs("div",{className:"bg-white rounded-3xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden flex flex-col",children:[t.jsxs("div",{className:"px-6 py-4 border-b border-gray-200 flex items-center justify-between gap-4",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-xs uppercase text-gray-400 mb-1",children:"Дневник здоровья"}),t.jsx("h2",{className:"text-xl font-semibold text-gray-800",children:z.patientName}),t.jsxs("div",{className:"flex flex-wrap gap-2 mt-2 text-xs text-gray-500",children:[t.jsxs("span",{children:["Дневник создан: ",Ao(z.createdAt)]}),z.organization?.name&&t.jsxs("span",{children:["Организация: ",z.organization.name]}),z.owner?.name&&t.jsxs("span",{children:["Владелец: ",z.owner.name]})]})]}),t.jsx("button",{type:"button",onClick:W,className:"text-gray-500 hover:text-gray-700 text-xl leading-none",children:"✕"})]}),t.jsxs("div",{className:"px-6 py-5 overflow-y-auto space-y-5",children:[t.jsxs("div",{className:"bg-gray-50 rounded-2xl p-4 space-y-2 text-sm text-gray-700",children:[t.jsx("h3",{className:"text-sm font-semibold text-gray-800",children:"Основная информация"}),t.jsxs("p",{children:[t.jsx("span",{className:"text-xs uppercase text-gray-400",children:"ID дневника: "}),t.jsx("span",{className:"break-all",children:z.id})]}),z.cardId&&t.jsxs("p",{children:[t.jsx("span",{className:"text-xs uppercase text-gray-400",children:"ID карточки: "}),t.jsx("span",{className:"break-all",children:z.cardId})]}),z.organization&&t.jsxs("p",{children:[t.jsx("span",{className:"text-xs uppercase text-gray-400",children:"Организация: "}),t.jsx("span",{children:z.organization.name})]}),z.caregiver&&t.jsxs("p",{children:[t.jsx("span",{className:"text-xs uppercase text-gray-400",children:"Сиделка: "}),t.jsx("span",{children:z.caregiver.name})]})]}),z.card&&t.jsxs("div",{className:"bg-gray-50 rounded-2xl p-4 space-y-2 text-sm text-gray-700",children:[t.jsx("h3",{className:"text-sm font-semibold text-gray-800",children:"Карточка подопечного"}),z.card.full_name&&t.jsxs("p",{children:[t.jsx("span",{className:"text-xs uppercase text-gray-400",children:"ФИО: "}),t.jsx("span",{children:z.card.full_name})]}),z.card.date_of_birth&&t.jsxs("p",{children:[t.jsx("span",{className:"text-xs uppercase text-gray-400",children:"Дата рождения: "}),t.jsx("span",{children:Co(z.card.date_of_birth)})]}),z.card.address&&t.jsxs("p",{children:[t.jsx("span",{className:"text-xs uppercase text-gray-400",children:"Адрес: "}),t.jsx("span",{children:z.card.address})]}),(z.card.entrance||z.card.apartment)&&t.jsxs("p",{children:[t.jsx("span",{className:"text-xs uppercase text-gray-400",children:"Подъезд / квартира: "}),t.jsxs("span",{children:[z.card.entrance&&`Подъезд ${z.card.entrance}`,z.card.entrance&&z.card.apartment&&", ",z.card.apartment&&`Кв. ${z.card.apartment}`]})]}),z.card.gender&&t.jsxs("p",{children:[t.jsx("span",{className:"text-xs uppercase text-gray-400",children:"Пол: "}),t.jsx("span",{children:z.card.gender==="female"?"Женский":z.card.gender==="male"?"Мужской":"Не указан"})]}),z.card.mobility&&t.jsxs("p",{children:[t.jsx("span",{className:"text-xs uppercase text-gray-400",children:"Мобильность: "}),t.jsx("span",{children:ip[z.card.mobility]||z.card.mobility})]}),t.jsxs("p",{children:[t.jsx("span",{className:"text-xs uppercase text-gray-400",children:"Домашние животные: "}),t.jsx("span",{children:z.card.has_pets?"Да":"Нет"})]}),z.card.diagnoses&&z.card.diagnoses.length>0&&t.jsxs("p",{children:[t.jsx("span",{className:"text-xs uppercase text-gray-400",children:"Диагнозы: "}),t.jsx("span",{children:z.card.diagnoses.join(", ")})]}),z.card.services&&z.card.services.length>0&&t.jsxs("p",{children:[t.jsx("span",{className:"text-xs uppercase text-gray-400",children:"Требуемые услуги: "}),t.jsx("span",{children:z.card.services.join(", ")})]}),z.card.service_wishes&&z.card.service_wishes.length>0&&t.jsxs("p",{children:[t.jsx("span",{className:"text-xs uppercase text-gray-400",children:"Пожелания по услугам: "}),t.jsx("span",{children:z.card.service_wishes.join(", ")})]})]}),P.length>0&&t.jsxs("div",{className:"bg-gray-50 rounded-2xl p-4 space-y-3 text-sm text-gray-700",children:[t.jsx("h3",{className:"text-sm font-semibold text-gray-800",children:"Последние записи"}),t.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:P.slice().sort((h,A)=>new Date(A.created_at).getTime()-new Date(h.created_at).getTime()).slice(0,10).map(h=>t.jsxs("div",{className:"border border-gray-100 rounded-2xl px-3 py-2 bg-white",children:[t.jsxs("div",{className:"flex items-center justify-between text-xs text-gray-400 mb-1",children:[t.jsx("span",{children:np(h.metric_type)}),t.jsx("span",{children:Ao(h.created_at)})]}),t.jsx("p",{className:"text-sm text-gray-700 whitespace-pre-wrap break-words",children:String(h.value||"")})]},h.id))})]})]})]})})]})},So=e=>({walk:"Прогулка",cognitive_games:"Когнитивные игры",diaper_change:"Смена подгузников",hygiene:"Гигиена",skin_moisturizing:"Увлажнение кожи",meal:"Прием пищи",medications:"Прием лекарств",vitamins:"Прием витаминов",sleep:"Сон",temperature:"Температура",blood_pressure:"Давление",breathing_rate:"Частота дыхания",pain_level:"Уровень боли",saturation:"Сатурация",blood_sugar:"Уровень сахара",urination:"Выделение мочи",defecation:"Дефекация",nausea:"Тошнота",vomiting:"Рвота",shortness_of_breath:"Одышка",itching:"Зуд",cough:"Кашель",dry_mouth:"Сухость во рту",hiccups:"Икота",taste_disturbance:"Нарушение вкуса",support_note:"Запись поддержки"})[e]||e,lp=e=>e.toLocaleDateString("ru-RU",{day:"2-digit",month:"2-digit"}),Do=(e=7)=>{const r=[],s=new Map,a=new Date;for(let n=e-1;n>=0;n--){const i=new Date(a);i.setDate(a.getDate()-n);const o=i.toISOString().slice(0,10),c={key:o,date:i,label:lp(i),value:0};r.push(c),s.set(o,c)}return{buckets:r,map:s}},zo=({data:e,height:r=380,color:s="#0A6D83"})=>{const n={top:24,right:24,bottom:96,left:68},i=640-n.left-n.right,o=r-n.top-n.bottom,c=Math.max(...e.map(P=>P.value),1),g=e.length>1?i/(e.length-1):i,[_,y]=u.useState(null),D=e.map((P,C)=>{const B=n.left+C*g,O=n.top+(c===0?o:o-Math.max(0,Math.min(1,P.value/c))*o);return{x:B,y:O,v:P.value,label:P.label}}),w=D.length>0?`M ${D[0].x},${D[0].y} `+D.slice(1).map(P=>`L ${P.x},${P.y}`).join(" "):"",I=[0,.25,.5,.75,1].map(P=>({y:n.top+o-P*o,v:Math.round(c*P)}));return t.jsxs("div",{className:"w-full relative",children:[_&&t.jsxs("div",{className:"absolute bg-white text-xs text-gray-700 border border-gray-200 shadow-md rounded-md px-2 py-1 pointer-events-none",style:{left:`calc(${_.x/640*100}% - 40px)`,top:Math.max(0,(_.y-28)/r*100)+"%"},children:[t.jsx("div",{className:"font-medium",children:_.value}),t.jsx("div",{className:"text-gray-500",children:_.label})]}),t.jsxs("svg",{viewBox:`0 0 640 ${r}`,className:"w-full h-96",children:[t.jsx("line",{x1:n.left,y1:n.top+o,x2:n.left+i,y2:n.top+o,stroke:"#E5E7EB",strokeWidth:2}),t.jsx("line",{x1:n.left,y1:n.top,x2:n.left,y2:n.top+o,stroke:"#E5E7EB",strokeWidth:2}),I.map((P,C)=>t.jsxs("g",{children:[t.jsx("line",{x1:n.left,y1:P.y,x2:n.left+i,y2:P.y,stroke:"#E9EEF5"}),t.jsx("text",{x:n.left-14,y:P.y+10,textAnchor:"end",fontSize:"20",fontWeight:"800",fill:"#0F172A",children:P.v})]},C)),t.jsx("path",{d:w,fill:"none",stroke:s,strokeWidth:4}),D.map((P,C)=>t.jsxs("g",{children:[t.jsx("circle",{cx:P.x,cy:P.y,r:7,fill:s,className:"cursor-pointer",onClick:()=>y({x:P.x,y:P.y,label:P.label,value:P.v})}),t.jsx("text",{x:P.x,y:n.top+o+30,textAnchor:"middle",fontSize:"20",fontWeight:"800",fill:"#0F172A",children:P.label}),t.jsx("text",{x:P.x,y:n.top+o+56,textAnchor:"middle",fontSize:"20",fill:"#0F172A",children:P.v})]},C))]})]})},cp=()=>{const[e,r]=u.useState(!0),[s,a]=u.useState(7),[n,i]=u.useState({diaries:[],patientCards:[],organizations:[],userProfiles:[],clients:[],employees:[],history:[],metricValues:[]});u.useEffect(()=>{(async()=>{try{r(!0);const O=localStorage.getItem("admin_token")||"b8f56f5c-62f1-45d9-9e5a-e8bbfdadcf0f",$="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyAgCiAgICAicm9sZSI6ICJhbm9uIiwKICAgICJpc3MiOiAic3VwYWJhc2UtZGVtbyIsCiAgICAiaWF0IjogMTY0MTc2OTIwMCwKICAgICJleHAiOiAxNzk5NTM1NjAwCn0.dc_X5iR_VP_qT0zsiyj_I_OZ2T9FtRU2BBNWN8Bu4GE",p=hs("admin-support-data"),k=await fetch(`${p}?admin_token=${encodeURIComponent(O)}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${$}`,apikey:$}});if(!k.ok){const x=await k.json().catch(()=>({error:"Неизвестная ошибка"}));console.error("Ошибка загрузки данных для мониторинга:",x),r(!1);return}const f=await k.json();if(!f.success||!f.data){console.error("Неверный формат ответа от Edge Function admin-support-data"),r(!1);return}i({diaries:f.data.diaries||[],patientCards:f.data.patientCards||[],organizations:f.data.organizations||[],userProfiles:f.data.userProfiles||[],clients:f.data.clients||[],employees:f.data.employees||[],history:f.data.history||[],metricValues:f.data.metricValues||[]})}catch(O){console.error("Ошибка загрузки данных мониторинга из Supabase:",O)}finally{r(!1)}})()},[]);const o=u.useMemo(()=>n.diaries,[n.diaries]),c=u.useMemo(()=>n.patientCards,[n.patientCards]),g=u.useMemo(()=>n.organizations,[n.organizations]),_=u.useMemo(()=>n.clients,[n.clients]),y=u.useMemo(()=>n.history,[n.history]),D=u.useMemo(()=>n.metricValues,[n.metricValues]),w=u.useMemo(()=>n.userProfiles.length+n.clients.length+n.employees.length,[n.userProfiles,n.clients,n.employees]),I=u.useMemo(()=>{const{buckets:B,map:O}=Do(s);return o.forEach($=>{const p=$?.created_at;if(!p)return;const k=new Date(p).toISOString().slice(0,10),f=O.get(k);f&&(f.value+=1)}),B},[o,s]),P=u.useMemo(()=>{const{buckets:B}=Do(s),O=new Map;return B.forEach($=>{O.set($.key,new Set)}),y.forEach($=>{if(!$?.occurred_at||!$?.diary_id)return;const p=new Date($.occurred_at).toISOString().slice(0,10),k=O.get(p);k&&k.add(String($.diary_id))}),D.forEach($=>{if(!$?.recorded_at||!$?.diary_id)return;const p=new Date($.recorded_at).toISOString().slice(0,10),k=O.get(p);k&&k.add(String($.diary_id))}),B.forEach($=>{const p=O.get($.key);$.value=p?p.size:0}),B},[y,D,s]),C=u.useMemo(()=>{const B=o.length,O=c.length,$=w,p=g.length,k=y.length+D.length,f=new Date,x=new Date(f.getFullYear(),f.getMonth(),f.getDate()).getTime();let F=0;return y.forEach(H=>{H?.occurred_at&&new Date(H.occurred_at).getTime()>=x&&(F+=1)}),D.forEach(H=>{H?.recorded_at&&new Date(H.recorded_at).getTime()>=x&&(F+=1)}),{diariesCount:B,cardsCount:O,usersCount:$,orgCount:p,totalEntries:k,todayEntries:F,created7Days:I.reduce((H,M)=>H+M.value,0),activeDiaries7Days:P.reduce((H,M)=>H+M.value,0)}},[o,c,w,g,y,D,I,P]);return u.useMemo(()=>{const B=[];return y.forEach(O=>{O?.occurred_at&&B.push({id:`history_${O.id}`,timestamp:O.occurred_at,action:"diary_history",details:So(O.metric_type||"support_note"),diaryId:O.diary_id})}),D.forEach(O=>{O?.recorded_at&&B.push({id:`metric_${O.id}`,timestamp:O.recorded_at,action:"metric_value",details:So(O.metric_type),diaryId:O.diary_id})}),B.sort((O,$)=>new Date($.timestamp).getTime()-new Date(O.timestamp).getTime()).slice(0,6)},[y,D]),t.jsxs("div",{className:"space-y-8",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsx("h2",{className:"text-2xl font-bold text-gray-800",children:"Мониторинг и статистика"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{type:"button",onClick:()=>a(7),className:`px-3 py-1 rounded-full text-sm border ${s===7?"bg-[#0A6D83] text-white border-[#0A6D83]":"bg-white text-gray-700 border-gray-300"}`,children:"7 дней"}),t.jsx("button",{type:"button",onClick:()=>a(30),className:`px-3 py-1 rounded-full text-sm border ${s===30?"bg-[#0A6D83] text-white border-[#0A6D83]":"bg-white text-gray-700 border-gray-300"}`,children:"30 дней"})]})]}),t.jsx("div",{className:"grid gap-4 sm:grid-cols-2 xl:grid-cols-3",children:[{title:"Активные дневники",value:C.diariesCount},{title:"Карточки подопечных",value:C.cardsCount},{title:"Пользователи и сотрудники",value:C.usersCount},{title:"Организации",value:C.orgCount},{title:"Новых дневников за 7 дней",value:C.created7Days},{title:"Активных дневников за 7 дней",value:C.activeDiaries7Days},{title:"Записей сегодня",value:C.todayEntries}].map(B=>t.jsxs("div",{className:"bg-white border border-gray-200 rounded-3xl p-6 shadow-sm",children:[t.jsx("p",{className:"text-xs uppercase text-gray-400",children:B.title}),t.jsx("p",{className:"text-2xl font-semibold text-[#0A6D83] mt-2",children:B.value})]},B.title))}),t.jsxs("div",{className:"grid gap-4 lg:grid-cols-2",children:[t.jsxs("div",{className:"bg-white border border-gray-200 rounded-3xl p-6 shadow-sm space-y-4",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("h3",{className:"text-lg font-semibold text-gray-800",children:["Новые дневники за ",s," дней"]}),t.jsxs("span",{className:"text-xs text-gray-400",children:["Всего: ",C.created7Days]})]}),t.jsx(zo,{data:I})]}),t.jsxs("div",{className:"bg-white border border-gray-200 rounded-3xl p-6 shadow-sm space-y-4",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("h3",{className:"text-lg font-semibold text-gray-800",children:["Активные дневники за ",s," дней"]}),t.jsxs("span",{className:"text-xs text-gray-400",children:["Всего: ",C.activeDiaries7Days]})]}),t.jsx(zo,{data:P}),t.jsx("p",{className:"text-xs text-gray-500",children:"Учитываются дневники, где за день была внесена минимум одна запись (любой показатель)."})]})]}),t.jsx("div",{className:"grid gap-4 lg:grid-cols-2",children:t.jsxs("div",{className:"bg-white border border-gray-200 rounded-3xl p-6 shadow-sm space-y-3",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Топ неактивных дневников"}),t.jsxs("p",{className:"text-xs text-gray-500",children:["Дневники без записей за последние ",s," дней. Помогает выявлять риски оттока."]}),t.jsx("div",{className:"space-y-2",children:(()=>{const B=Date.now(),O=new Map;y.forEach(k=>{if(!k?.diary_id||!k?.occurred_at)return;const f=new Date(k.occurred_at).getTime(),x=String(k.diary_id);O.set(x,Math.max(O.get(x)||0,f))}),D.forEach(k=>{if(!k?.diary_id||!k?.recorded_at)return;const f=new Date(k.recorded_at).getTime(),x=String(k.diary_id);O.set(x,Math.max(O.get(x)||0,f))});const p=o.map(k=>{const f=O.get(String(k.id))||0,x=k?.created_at?new Date(k.created_at).getTime():0,F=f||x,H=F?Math.floor((B-F)/(1e3*60*60*24)):s+1;return{id:k.id,name:k.name||k.id,lastAt:f?new Date(f):null,daysInactive:H}}).filter(k=>k.daysInactive>=s).sort((k,f)=>f.daysInactive-k.daysInactive).slice(0,8);return p.length===0?t.jsx("p",{className:"text-sm text-gray-500",children:"За выбранный период нет неактивных дневников."}):p.map(k=>{const f=o.find(U=>U.id===k.id)||{},x=g.find(U=>U.id===f.organization_id),F=_.find(U=>U.id===f.client_id),H=n.userProfiles?.find(U=>U.user_id===f.owner_id||U.id===f.user_id),M=x?.name||"Без организации",L=x?.phone||x?.contact_phone||F?.phone||F?.contact_phone||H?.phone||H?.contact_phone||"—";return t.jsx("div",{className:"bg-[#F7FCFD] rounded-2xl px-4 py-3",children:t.jsxs("div",{className:"flex items-center justify-between gap-3",children:[t.jsxs("div",{className:"min-w-0",children:[t.jsx("p",{className:"text-sm text-gray-800 truncate",children:k.name}),t.jsxs("p",{className:"text-xs text-gray-500 truncate",children:["Организация: ",M]}),t.jsxs("p",{className:"text-xs text-gray-500",children:["Телефон: ",L]}),t.jsxs("p",{className:"text-xs text-gray-500",children:["Последняя активность: ",k.lastAt?k.lastAt.toLocaleDateString("ru-RU"):"не было"]})]}),t.jsxs("span",{className:"shrink-0 text-xs font-semibold text-[#8A3A0A] bg-[#FDF3E7] px-3 py-1 rounded-full",children:[k.daysInactive," дн. без записей"]})]})},k.id)})})()})]})})]})},dp=()=>t.jsx(pt,{children:t.jsx(od,{})}),up=()=>t.jsx(pt,{children:t.jsx(ag,{})}),mp=()=>t.jsx(pt,{children:t.jsx(cg,{})}),hp=()=>t.jsx(pt,{children:t.jsx(pg,{})}),fp=()=>t.jsx(pt,{children:t.jsx(xg,{})}),gp=()=>t.jsx(pt,{children:t.jsx(bg,{})}),pp=()=>t.jsx(pt,{children:t.jsx(_g,{})});function xp(){return t.jsxs(dc,{children:[t.jsx(Te,{path:"/",element:t.jsx(ld,{})}),t.jsxs(Te,{element:t.jsx(id,{}),children:[t.jsx(Te,{path:"/login",element:t.jsx(Wf,{})}),t.jsx(Te,{path:"/register",element:t.jsx(Vf,{})}),t.jsx(Te,{path:"/email-confirmation",element:t.jsx(Jf,{})}),t.jsx(Te,{path:"/client-invite",element:t.jsx(qg,{})})]}),t.jsx(Te,{element:t.jsx(dp,{}),children:t.jsx(Te,{path:"/profile/setup",element:t.jsx(sg,{})})}),t.jsx(Te,{path:"/dashboard",element:t.jsx(pt,{children:t.jsx(hg,{})})}),t.jsx(Te,{path:"/profile",element:t.jsx(up,{})}),t.jsx(Te,{path:"/profile/edit",element:t.jsx(mp,{})}),t.jsx(Te,{path:"/profile/employees",element:t.jsx(hp,{})}),t.jsx(Te,{path:"/profile/patient-cards",element:t.jsx(fp,{})}),t.jsx(Te,{path:"/profile/patient-cards/new",element:t.jsx(pt,{children:t.jsx(Oa,{})})}),t.jsx(Te,{path:"/profile/patient-cards/edit",element:t.jsx(pt,{children:t.jsx(Oa,{})})}),t.jsx(Te,{path:"/profile/patient-cards/view",element:t.jsx(pt,{children:t.jsx(Oa,{})})}),t.jsx(Te,{path:"/profile/clients",element:t.jsx(gp,{})}),t.jsx(Te,{path:"/profile/invite-client",element:t.jsx(pp,{})}),t.jsx(Te,{path:"/diaries/new",element:t.jsx(pt,{children:t.jsx(vg,{})})}),t.jsx(Te,{path:"/diaries/:id",element:t.jsx(pt,{children:t.jsx(Fg,{})})}),t.jsx(Te,{path:"/diaries/:id/edit-metrics",element:t.jsx(pt,{children:t.jsx(Zg,{})})}),t.jsxs(Te,{path:"/admin",element:t.jsx(Qg,{}),children:[t.jsx(Te,{index:!0,element:t.jsx(Gg,{})}),t.jsx(Te,{path:"invites",element:t.jsx(ep,{})}),t.jsx(Te,{path:"users",element:t.jsx(rp,{})}),t.jsx(Te,{path:"support",element:t.jsx(op,{})}),t.jsx(Te,{path:"monitoring",element:t.jsx(cp,{})}),t.jsx(Te,{path:"*",element:t.jsx(Eo,{to:"/admin",replace:!0})})]})]})}const yp=new Lc;pc.createRoot(document.getElementById("root")).render(t.jsx(tt.StrictMode,{children:t.jsx(uc,{children:t.jsx(Uc,{client:yp,children:t.jsx(xp,{})})})}));
