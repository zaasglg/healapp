import{r as ic,b as oc,a as lc,c as u,R as tt,O as mn,N as Po,u as rt,d as Fr,e as Io,f as cc,h as Ut,L as dc,i as uc,j as Te,B as mc}from"./vendor-BLYH5sOE.js";import{c as $o}from"./supabase-CbeKR10q.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&a(o)}).observe(document,{childList:!0,subtree:!0});function s(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(n){if(n.ep)return;n.ep=!0;const i=s(n);fetch(n.href,i)}})();var Ia={exports:{}},es={};var pi;function hc(){if(pi)return es;pi=1;var e=ic(),r=Symbol.for("react.element"),s=Symbol.for("react.fragment"),a=Object.prototype.hasOwnProperty,n=e.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,i={key:!0,ref:!0,__self:!0,__source:!0};function o(c,g,_){var y,D={},w=null,I=null;_!==void 0&&(w=""+_),g.key!==void 0&&(w=""+g.key),g.ref!==void 0&&(I=g.ref);for(y in g)a.call(g,y)&&!i.hasOwnProperty(y)&&(D[y]=g[y]);if(c&&c.defaultProps)for(y in g=c.defaultProps,g)D[y]===void 0&&(D[y]=g[y]);return{$$typeof:r,type:c,key:w,ref:I,props:D,_owner:n.current}}return es.Fragment=s,es.jsx=o,es.jsxs=o,es}var xi;function fc(){return xi||(xi=1,Ia.exports=hc()),Ia.exports}var t=fc(),Rs={},yi;function gc(){if(yi)return Rs;yi=1;var e=oc();return Rs.createRoot=e.createRoot,Rs.hydrateRoot=e.hydrateRoot,Rs}var pc=gc();const xc=lc(pc);var us=class{constructor(){this.listeners=new Set,this.subscribe=this.subscribe.bind(this)}subscribe(e){return this.listeners.add(e),this.onSubscribe(),()=>{this.listeners.delete(e),this.onUnsubscribe()}}hasListeners(){return this.listeners.size>0}onSubscribe(){}onUnsubscribe(){}},yc={setTimeout:(e,r)=>setTimeout(e,r),clearTimeout:e=>clearTimeout(e),setInterval:(e,r)=>setInterval(e,r),clearInterval:e=>clearInterval(e)},bc=class{#e=yc;#t=!1;setTimeoutProvider(e){this.#e=e}setTimeout(e,r){return this.#e.setTimeout(e,r)}clearTimeout(e){this.#e.clearTimeout(e)}setInterval(e,r){return this.#e.setInterval(e,r)}clearInterval(e){this.#e.clearInterval(e)}},yr=new bc;function _c(e){setTimeout(e,0)}var _r=typeof window>"u"||"Deno"in globalThis;function ft(){}function vc(e,r){return typeof e=="function"?e(r):e}function Qa(e){return typeof e=="number"&&e>=0&&e!==1/0}function Mo(e,r){return Math.max(e+(r||0)-Date.now(),0)}function lr(e,r){return typeof e=="function"?e(r):e}function Dt(e,r){return typeof e=="function"?e(r):e}function bi(e,r){const{type:s="all",exact:a,fetchStatus:n,predicate:i,queryKey:o,stale:c}=e;if(o){if(a){if(r.queryHash!==hn(o,r.options))return!1}else if(!ls(r.queryKey,o))return!1}if(s!=="all"){const g=r.isActive();if(s==="active"&&!g||s==="inactive"&&g)return!1}return!(typeof c=="boolean"&&r.isStale()!==c||n&&n!==r.state.fetchStatus||i&&!i(r))}function _i(e,r){const{exact:s,status:a,predicate:n,mutationKey:i}=e;if(i){if(!r.options.mutationKey)return!1;if(s){if(os(r.options.mutationKey)!==os(i))return!1}else if(!ls(r.options.mutationKey,i))return!1}return!(a&&r.state.status!==a||n&&!n(r))}function hn(e,r){return(r?.queryKeyHashFn||os)(e)}function os(e){return JSON.stringify(e,(r,s)=>Ha(s)?Object.keys(s).sort().reduce((a,n)=>(a[n]=s[n],a),{}):s)}function ls(e,r){return e===r?!0:typeof e!=typeof r?!1:e&&r&&typeof e=="object"&&typeof r=="object"?Object.keys(r).every(s=>ls(e[s],r[s])):!1}var jc=Object.prototype.hasOwnProperty;function To(e,r){if(e===r)return e;const s=vi(e)&&vi(r);if(!s&&!(Ha(e)&&Ha(r)))return r;const n=(s?e:Object.keys(e)).length,i=s?r:Object.keys(r),o=i.length,c=s?new Array(o):{};let g=0;for(let _=0;_<o;_++){const y=s?_:i[_],D=e[y],w=r[y];if(D===w){c[y]=D,(s?_<n:jc.call(e,y))&&g++;continue}if(D===null||w===null||typeof D!="object"||typeof w!="object"){c[y]=w;continue}const I=To(D,w);c[y]=I,I===D&&g++}return n===o&&g===n?e:c}function Ka(e,r){if(!r||Object.keys(e).length!==Object.keys(r).length)return!1;for(const s in e)if(e[s]!==r[s])return!1;return!0}function vi(e){return Array.isArray(e)&&e.length===Object.keys(e).length}function Ha(e){if(!ji(e))return!1;const r=e.constructor;if(r===void 0)return!0;const s=r.prototype;return!(!ji(s)||!s.hasOwnProperty("isPrototypeOf")||Object.getPrototypeOf(e)!==Object.prototype)}function ji(e){return Object.prototype.toString.call(e)==="[object Object]"}function wc(e){return new Promise(r=>{yr.setTimeout(r,e)})}function Ga(e,r,s){return typeof s.structuralSharing=="function"?s.structuralSharing(e,r):s.structuralSharing!==!1?To(e,r):r}function Nc(e,r,s=0){const a=[...e,r];return s&&a.length>s?a.slice(1):a}function kc(e,r,s=0){const a=[r,...e];return s&&a.length>s?a.slice(0,-1):a}var fn=Symbol();function Fo(e,r){return!e.queryFn&&r?.initialPromise?()=>r.initialPromise:!e.queryFn||e.queryFn===fn?()=>Promise.reject(new Error(`Missing queryFn: '${e.queryHash}'`)):e.queryFn}function Cc(e,r){return typeof e=="function"?e(...r):!!e}var Sc=class extends us{#e;#t;#r;constructor(){super(),this.#r=e=>{if(!_r&&window.addEventListener){const r=()=>e();return window.addEventListener("visibilitychange",r,!1),()=>{window.removeEventListener("visibilitychange",r)}}}}onSubscribe(){this.#t||this.setEventListener(this.#r)}onUnsubscribe(){this.hasListeners()||(this.#t?.(),this.#t=void 0)}setEventListener(e){this.#r=e,this.#t?.(),this.#t=e(r=>{typeof r=="boolean"?this.setFocused(r):this.onFocus()})}setFocused(e){this.#e!==e&&(this.#e=e,this.onFocus())}onFocus(){const e=this.isFocused();this.listeners.forEach(r=>{r(e)})}isFocused(){return typeof this.#e=="boolean"?this.#e:globalThis.document?.visibilityState!=="hidden"}},gn=new Sc;function Ya(){let e,r;const s=new Promise((n,i)=>{e=n,r=i});s.status="pending",s.catch(()=>{});function a(n){Object.assign(s,n),delete s.resolve,delete s.reject}return s.resolve=n=>{a({status:"fulfilled",value:n}),e(n)},s.reject=n=>{a({status:"rejected",reason:n}),r(n)},s}var Ac=_c;function Dc(){let e=[],r=0,s=c=>{c()},a=c=>{c()},n=Ac;const i=c=>{r?e.push(c):n(()=>{s(c)})},o=()=>{const c=e;e=[],c.length&&n(()=>{a(()=>{c.forEach(g=>{s(g)})})})};return{batch:c=>{let g;r++;try{g=c()}finally{r--,r||o()}return g},batchCalls:c=>(...g)=>{i(()=>{c(...g)})},schedule:i,setNotifyFunction:c=>{s=c},setBatchNotifyFunction:c=>{a=c},setScheduler:c=>{n=c}}}var at=Dc(),Ec=class extends us{#e=!0;#t;#r;constructor(){super(),this.#r=e=>{if(!_r&&window.addEventListener){const r=()=>e(!0),s=()=>e(!1);return window.addEventListener("online",r,!1),window.addEventListener("offline",s,!1),()=>{window.removeEventListener("online",r),window.removeEventListener("offline",s)}}}}onSubscribe(){this.#t||this.setEventListener(this.#r)}onUnsubscribe(){this.hasListeners()||(this.#t?.(),this.#t=void 0)}setEventListener(e){this.#r=e,this.#t?.(),this.#t=e(this.setOnline.bind(this))}setOnline(e){this.#e!==e&&(this.#e=e,this.listeners.forEach(s=>{s(e)}))}isOnline(){return this.#e}},Ks=new Ec;function zc(e){return Math.min(1e3*2**e,3e4)}function Ro(e){return(e??"online")==="online"?Ks.isOnline():!0}var Xa=class extends Error{constructor(e){super("CancelledError"),this.revert=e?.revert,this.silent=e?.silent}};function Oo(e){let r=!1,s=0,a;const n=Ya(),i=()=>n.status!=="pending",o=S=>{if(!i()){const U=new Xa(S);w(U),e.onCancel?.(U)}},c=()=>{r=!0},g=()=>{r=!1},_=()=>gn.isFocused()&&(e.networkMode==="always"||Ks.isOnline())&&e.canRun(),y=()=>Ro(e.networkMode)&&e.canRun(),D=S=>{i()||(a?.(),n.resolve(S))},w=S=>{i()||(a?.(),n.reject(S))},I=()=>new Promise(S=>{a=U=>{(i()||_())&&S(U)},e.onPause?.()}).then(()=>{a=void 0,i()||e.onContinue?.()}),P=()=>{if(i())return;let S;const U=s===0?e.initialPromise:void 0;try{S=U??e.fn()}catch(O){S=Promise.reject(O)}Promise.resolve(S).then(D).catch(O=>{if(i())return;const $=e.retry??(_r?0:3),p=e.retryDelay??zc,k=typeof p=="function"?p(s,O):p,f=$===!0||typeof $=="number"&&s<$||typeof $=="function"&&$(s,O);if(r||!f){w(O);return}s++,e.onFail?.(s,O),wc(k).then(()=>_()?void 0:I()).then(()=>{r?w(O):P()})})};return{promise:n,status:()=>n.status,cancel:o,continue:()=>(a?.(),n),cancelRetry:c,continueRetry:g,canStart:y,start:()=>(y()?P():I().then(P),n)}}var Lo=class{#e;destroy(){this.clearGcTimeout()}scheduleGc(){this.clearGcTimeout(),Qa(this.gcTime)&&(this.#e=yr.setTimeout(()=>{this.optionalRemove()},this.gcTime))}updateGcTime(e){this.gcTime=Math.max(this.gcTime||0,e??(_r?1/0:300*1e3))}clearGcTimeout(){this.#e&&(yr.clearTimeout(this.#e),this.#e=void 0)}},Pc=class extends Lo{#e;#t;#r;#a;#s;#o;#i;constructor(e){super(),this.#i=!1,this.#o=e.defaultOptions,this.setOptions(e.options),this.observers=[],this.#a=e.client,this.#r=this.#a.getQueryCache(),this.queryKey=e.queryKey,this.queryHash=e.queryHash,this.#e=Ni(this.options),this.state=e.state??this.#e,this.scheduleGc()}get meta(){return this.options.meta}get promise(){return this.#s?.promise}setOptions(e){if(this.options={...this.#o,...e},this.updateGcTime(this.options.gcTime),this.state&&this.state.data===void 0){const r=Ni(this.options);r.data!==void 0&&(this.setState(wi(r.data,r.dataUpdatedAt)),this.#e=r)}}optionalRemove(){!this.observers.length&&this.state.fetchStatus==="idle"&&this.#r.remove(this)}setData(e,r){const s=Ga(this.state.data,e,this.options);return this.#n({data:s,type:"success",dataUpdatedAt:r?.updatedAt,manual:r?.manual}),s}setState(e,r){this.#n({type:"setState",state:e,setStateOptions:r})}cancel(e){const r=this.#s?.promise;return this.#s?.cancel(e),r?r.then(ft).catch(ft):Promise.resolve()}destroy(){super.destroy(),this.cancel({silent:!0})}reset(){this.destroy(),this.setState(this.#e)}isActive(){return this.observers.some(e=>Dt(e.options.enabled,this)!==!1)}isDisabled(){return this.getObserversCount()>0?!this.isActive():this.options.queryFn===fn||this.state.dataUpdateCount+this.state.errorUpdateCount===0}isStatic(){return this.getObserversCount()>0?this.observers.some(e=>lr(e.options.staleTime,this)==="static"):!1}isStale(){return this.getObserversCount()>0?this.observers.some(e=>e.getCurrentResult().isStale):this.state.data===void 0||this.state.isInvalidated}isStaleByTime(e=0){return this.state.data===void 0?!0:e==="static"?!1:this.state.isInvalidated?!0:!Mo(this.state.dataUpdatedAt,e)}onFocus(){this.observers.find(r=>r.shouldFetchOnWindowFocus())?.refetch({cancelRefetch:!1}),this.#s?.continue()}onOnline(){this.observers.find(r=>r.shouldFetchOnReconnect())?.refetch({cancelRefetch:!1}),this.#s?.continue()}addObserver(e){this.observers.includes(e)||(this.observers.push(e),this.clearGcTimeout(),this.#r.notify({type:"observerAdded",query:this,observer:e}))}removeObserver(e){this.observers.includes(e)&&(this.observers=this.observers.filter(r=>r!==e),this.observers.length||(this.#s&&(this.#i?this.#s.cancel({revert:!0}):this.#s.cancelRetry()),this.scheduleGc()),this.#r.notify({type:"observerRemoved",query:this,observer:e}))}getObserversCount(){return this.observers.length}invalidate(){this.state.isInvalidated||this.#n({type:"invalidate"})}async fetch(e,r){if(this.state.fetchStatus!=="idle"&&this.#s?.status()!=="rejected"){if(this.state.data!==void 0&&r?.cancelRefetch)this.cancel({silent:!0});else if(this.#s)return this.#s.continueRetry(),this.#s.promise}if(e&&this.setOptions(e),!this.options.queryFn){const c=this.observers.find(g=>g.options.queryFn);c&&this.setOptions(c.options)}const s=new AbortController,a=c=>{Object.defineProperty(c,"signal",{enumerable:!0,get:()=>(this.#i=!0,s.signal)})},n=()=>{const c=Fo(this.options,r),_=(()=>{const y={client:this.#a,queryKey:this.queryKey,meta:this.meta};return a(y),y})();return this.#i=!1,this.options.persister?this.options.persister(c,_,this):c(_)},o=(()=>{const c={fetchOptions:r,options:this.options,queryKey:this.queryKey,client:this.#a,state:this.state,fetchFn:n};return a(c),c})();this.options.behavior?.onFetch(o,this),this.#t=this.state,(this.state.fetchStatus==="idle"||this.state.fetchMeta!==o.fetchOptions?.meta)&&this.#n({type:"fetch",meta:o.fetchOptions?.meta}),this.#s=Oo({initialPromise:r?.initialPromise,fn:o.fetchFn,onCancel:c=>{c instanceof Xa&&c.revert&&this.setState({...this.#t,fetchStatus:"idle"}),s.abort()},onFail:(c,g)=>{this.#n({type:"failed",failureCount:c,error:g})},onPause:()=>{this.#n({type:"pause"})},onContinue:()=>{this.#n({type:"continue"})},retry:o.options.retry,retryDelay:o.options.retryDelay,networkMode:o.options.networkMode,canRun:()=>!0});try{const c=await this.#s.start();if(c===void 0)throw new Error(`${this.queryHash} data is undefined`);return this.setData(c),this.#r.config.onSuccess?.(c,this),this.#r.config.onSettled?.(c,this.state.error,this),c}catch(c){if(c instanceof Xa){if(c.silent)return this.#s.promise;if(c.revert){if(this.state.data===void 0)throw c;return this.state.data}}throw this.#n({type:"error",error:c}),this.#r.config.onError?.(c,this),this.#r.config.onSettled?.(this.state.data,c,this),c}finally{this.scheduleGc()}}#n(e){const r=s=>{switch(e.type){case"failed":return{...s,fetchFailureCount:e.failureCount,fetchFailureReason:e.error};case"pause":return{...s,fetchStatus:"paused"};case"continue":return{...s,fetchStatus:"fetching"};case"fetch":return{...s,...Bo(s.data,this.options),fetchMeta:e.meta??null};case"success":const a={...s,...wi(e.data,e.dataUpdatedAt),dataUpdateCount:s.dataUpdateCount+1,...!e.manual&&{fetchStatus:"idle",fetchFailureCount:0,fetchFailureReason:null}};return this.#t=e.manual?a:void 0,a;case"error":const n=e.error;return{...s,error:n,errorUpdateCount:s.errorUpdateCount+1,errorUpdatedAt:Date.now(),fetchFailureCount:s.fetchFailureCount+1,fetchFailureReason:n,fetchStatus:"idle",status:"error"};case"invalidate":return{...s,isInvalidated:!0};case"setState":return{...s,...e.state}}};this.state=r(this.state),at.batch(()=>{this.observers.forEach(s=>{s.onQueryUpdate()}),this.#r.notify({query:this,type:"updated",action:e})})}};function Bo(e,r){return{fetchFailureCount:0,fetchFailureReason:null,fetchStatus:Ro(r.networkMode)?"fetching":"paused",...e===void 0&&{error:null,status:"pending"}}}function wi(e,r){return{data:e,dataUpdatedAt:r??Date.now(),error:null,isInvalidated:!1,status:"success"}}function Ni(e){const r=typeof e.initialData=="function"?e.initialData():e.initialData,s=r!==void 0,a=s?typeof e.initialDataUpdatedAt=="function"?e.initialDataUpdatedAt():e.initialDataUpdatedAt:0;return{data:r,dataUpdateCount:0,dataUpdatedAt:s?a??Date.now():0,error:null,errorUpdateCount:0,errorUpdatedAt:0,fetchFailureCount:0,fetchFailureReason:null,fetchMeta:null,isInvalidated:!1,status:s?"success":"pending",fetchStatus:"idle"}}var Ic=class extends us{constructor(e,r){super(),this.options=r,this.#e=e,this.#n=null,this.#i=Ya(),this.bindMethods(),this.setOptions(r)}#e;#t=void 0;#r=void 0;#a=void 0;#s;#o;#i;#n;#g;#m;#h;#c;#d;#l;#f=new Set;bindMethods(){this.refetch=this.refetch.bind(this)}onSubscribe(){this.listeners.size===1&&(this.#t.addObserver(this),ki(this.#t,this.options)?this.#u():this.updateResult(),this.#b())}onUnsubscribe(){this.hasListeners()||this.destroy()}shouldFetchOnReconnect(){return en(this.#t,this.options,this.options.refetchOnReconnect)}shouldFetchOnWindowFocus(){return en(this.#t,this.options,this.options.refetchOnWindowFocus)}destroy(){this.listeners=new Set,this.#_(),this.#v(),this.#t.removeObserver(this)}setOptions(e){const r=this.options,s=this.#t;if(this.options=this.#e.defaultQueryOptions(e),this.options.enabled!==void 0&&typeof this.options.enabled!="boolean"&&typeof this.options.enabled!="function"&&typeof Dt(this.options.enabled,this.#t)!="boolean")throw new Error("Expected enabled to be a boolean or a callback that returns a boolean");this.#j(),this.#t.setOptions(this.options),r._defaulted&&!Ka(this.options,r)&&this.#e.getQueryCache().notify({type:"observerOptionsUpdated",query:this.#t,observer:this});const a=this.hasListeners();a&&Ci(this.#t,s,this.options,r)&&this.#u(),this.updateResult(),a&&(this.#t!==s||Dt(this.options.enabled,this.#t)!==Dt(r.enabled,this.#t)||lr(this.options.staleTime,this.#t)!==lr(r.staleTime,this.#t))&&this.#p();const n=this.#x();a&&(this.#t!==s||Dt(this.options.enabled,this.#t)!==Dt(r.enabled,this.#t)||n!==this.#l)&&this.#y(n)}getOptimisticResult(e){const r=this.#e.getQueryCache().build(this.#e,e),s=this.createResult(r,e);return Mc(this,s)&&(this.#a=s,this.#o=this.options,this.#s=this.#t.state),s}getCurrentResult(){return this.#a}trackResult(e,r){return new Proxy(e,{get:(s,a)=>(this.trackProp(a),r?.(a),a==="promise"&&(this.trackProp("data"),!this.options.experimental_prefetchInRender&&this.#i.status==="pending"&&this.#i.reject(new Error("experimental_prefetchInRender feature flag is not enabled"))),Reflect.get(s,a))})}trackProp(e){this.#f.add(e)}getCurrentQuery(){return this.#t}refetch({...e}={}){return this.fetch({...e})}fetchOptimistic(e){const r=this.#e.defaultQueryOptions(e),s=this.#e.getQueryCache().build(this.#e,r);return s.fetch().then(()=>this.createResult(s,r))}fetch(e){return this.#u({...e,cancelRefetch:e.cancelRefetch??!0}).then(()=>(this.updateResult(),this.#a))}#u(e){this.#j();let r=this.#t.fetch(this.options,e);return e?.throwOnError||(r=r.catch(ft)),r}#p(){this.#_();const e=lr(this.options.staleTime,this.#t);if(_r||this.#a.isStale||!Qa(e))return;const s=Mo(this.#a.dataUpdatedAt,e)+1;this.#c=yr.setTimeout(()=>{this.#a.isStale||this.updateResult()},s)}#x(){return(typeof this.options.refetchInterval=="function"?this.options.refetchInterval(this.#t):this.options.refetchInterval)??!1}#y(e){this.#v(),this.#l=e,!(_r||Dt(this.options.enabled,this.#t)===!1||!Qa(this.#l)||this.#l===0)&&(this.#d=yr.setInterval(()=>{(this.options.refetchIntervalInBackground||gn.isFocused())&&this.#u()},this.#l))}#b(){this.#p(),this.#y(this.#x())}#_(){this.#c&&(yr.clearTimeout(this.#c),this.#c=void 0)}#v(){this.#d&&(yr.clearInterval(this.#d),this.#d=void 0)}createResult(e,r){const s=this.#t,a=this.options,n=this.#a,i=this.#s,o=this.#o,g=e!==s?e.state:this.#r,{state:_}=e;let y={..._},D=!1,w;if(r._optimisticResults){const G=this.hasListeners(),M=!G&&ki(e,r),L=G&&Ci(e,s,r,a);(M||L)&&(y={...y,...Bo(_.data,e.options)}),r._optimisticResults==="isRestoring"&&(y.fetchStatus="idle")}let{error:I,errorUpdatedAt:P,status:S}=y;w=y.data;let U=!1;if(r.placeholderData!==void 0&&w===void 0&&S==="pending"){let G;n?.isPlaceholderData&&r.placeholderData===o?.placeholderData?(G=n.data,U=!0):G=typeof r.placeholderData=="function"?r.placeholderData(this.#h?.state.data,this.#h):r.placeholderData,G!==void 0&&(S="success",w=Ga(n?.data,G,r),D=!0)}if(r.select&&w!==void 0&&!U)if(n&&w===i?.data&&r.select===this.#g)w=this.#m;else try{this.#g=r.select,w=r.select(w),w=Ga(n?.data,w,r),this.#m=w,this.#n=null}catch(G){this.#n=G}this.#n&&(I=this.#n,w=this.#m,P=Date.now(),S="error");const O=y.fetchStatus==="fetching",$=S==="pending",p=S==="error",k=$&&O,f=w!==void 0,R={status:S,fetchStatus:y.fetchStatus,isPending:$,isSuccess:S==="success",isError:p,isInitialLoading:k,isLoading:k,data:w,dataUpdatedAt:y.dataUpdatedAt,error:I,errorUpdatedAt:P,failureCount:y.fetchFailureCount,failureReason:y.fetchFailureReason,errorUpdateCount:y.errorUpdateCount,isFetched:y.dataUpdateCount>0||y.errorUpdateCount>0,isFetchedAfterMount:y.dataUpdateCount>g.dataUpdateCount||y.errorUpdateCount>g.errorUpdateCount,isFetching:O,isRefetching:O&&!$,isLoadingError:p&&!f,isPaused:y.fetchStatus==="paused",isPlaceholderData:D,isRefetchError:p&&f,isStale:pn(e,r),refetch:this.refetch,promise:this.#i,isEnabled:Dt(r.enabled,e)!==!1};if(this.options.experimental_prefetchInRender){const G=B=>{R.status==="error"?B.reject(R.error):R.data!==void 0&&B.resolve(R.data)},M=()=>{const B=this.#i=R.promise=Ya();G(B)},L=this.#i;switch(L.status){case"pending":e.queryHash===s.queryHash&&G(L);break;case"fulfilled":(R.status==="error"||R.data!==L.value)&&M();break;case"rejected":(R.status!=="error"||R.error!==L.reason)&&M();break}}return R}updateResult(){const e=this.#a,r=this.createResult(this.#t,this.options);if(this.#s=this.#t.state,this.#o=this.options,this.#s.data!==void 0&&(this.#h=this.#t),Ka(r,e))return;this.#a=r;const s=()=>{if(!e)return!0;const{notifyOnChangeProps:a}=this.options,n=typeof a=="function"?a():a;if(n==="all"||!n&&!this.#f.size)return!0;const i=new Set(n??this.#f);return this.options.throwOnError&&i.add("error"),Object.keys(this.#a).some(o=>{const c=o;return this.#a[c]!==e[c]&&i.has(c)})};this.#w({listeners:s()})}#j(){const e=this.#e.getQueryCache().build(this.#e,this.options);if(e===this.#t)return;const r=this.#t;this.#t=e,this.#r=e.state,this.hasListeners()&&(r?.removeObserver(this),e.addObserver(this))}onQueryUpdate(){this.updateResult(),this.hasListeners()&&this.#b()}#w(e){at.batch(()=>{e.listeners&&this.listeners.forEach(r=>{r(this.#a)}),this.#e.getQueryCache().notify({query:this.#t,type:"observerResultsUpdated"})})}};function $c(e,r){return Dt(r.enabled,e)!==!1&&e.state.data===void 0&&!(e.state.status==="error"&&r.retryOnMount===!1)}function ki(e,r){return $c(e,r)||e.state.data!==void 0&&en(e,r,r.refetchOnMount)}function en(e,r,s){if(Dt(r.enabled,e)!==!1&&lr(r.staleTime,e)!=="static"){const a=typeof s=="function"?s(e):s;return a==="always"||a!==!1&&pn(e,r)}return!1}function Ci(e,r,s,a){return(e!==r||Dt(a.enabled,e)===!1)&&(!s.suspense||e.state.status!=="error")&&pn(e,s)}function pn(e,r){return Dt(r.enabled,e)!==!1&&e.isStaleByTime(lr(r.staleTime,e))}function Mc(e,r){return!Ka(e.getCurrentResult(),r)}function Si(e){return{onFetch:(r,s)=>{const a=r.options,n=r.fetchOptions?.meta?.fetchMore?.direction,i=r.state.data?.pages||[],o=r.state.data?.pageParams||[];let c={pages:[],pageParams:[]},g=0;const _=async()=>{let y=!1;const D=P=>{Object.defineProperty(P,"signal",{enumerable:!0,get:()=>(r.signal.aborted?y=!0:r.signal.addEventListener("abort",()=>{y=!0}),r.signal)})},w=Fo(r.options,r.fetchOptions),I=async(P,S,U)=>{if(y)return Promise.reject();if(S==null&&P.pages.length)return Promise.resolve(P);const $=(()=>{const x={client:r.client,queryKey:r.queryKey,pageParam:S,direction:U?"backward":"forward",meta:r.options.meta};return D(x),x})(),p=await w($),{maxPages:k}=r.options,f=U?kc:Nc;return{pages:f(P.pages,p,k),pageParams:f(P.pageParams,S,k)}};if(n&&i.length){const P=n==="backward",S=P?Tc:Ai,U={pages:i,pageParams:o},O=S(a,U);c=await I(U,O,P)}else{const P=e??i.length;do{const S=g===0?o[0]??a.initialPageParam:Ai(a,c);if(g>0&&S==null)break;c=await I(c,S),g++}while(g<P)}return c};r.options.persister?r.fetchFn=()=>r.options.persister?.(_,{client:r.client,queryKey:r.queryKey,meta:r.options.meta,signal:r.signal},s):r.fetchFn=_}}}function Ai(e,{pages:r,pageParams:s}){const a=r.length-1;return r.length>0?e.getNextPageParam(r[a],r,s[a],s):void 0}function Tc(e,{pages:r,pageParams:s}){return r.length>0?e.getPreviousPageParam?.(r[0],r,s[0],s):void 0}var Fc=class extends Lo{#e;#t;#r;#a;constructor(e){super(),this.#e=e.client,this.mutationId=e.mutationId,this.#r=e.mutationCache,this.#t=[],this.state=e.state||Rc(),this.setOptions(e.options),this.scheduleGc()}setOptions(e){this.options=e,this.updateGcTime(this.options.gcTime)}get meta(){return this.options.meta}addObserver(e){this.#t.includes(e)||(this.#t.push(e),this.clearGcTimeout(),this.#r.notify({type:"observerAdded",mutation:this,observer:e}))}removeObserver(e){this.#t=this.#t.filter(r=>r!==e),this.scheduleGc(),this.#r.notify({type:"observerRemoved",mutation:this,observer:e})}optionalRemove(){this.#t.length||(this.state.status==="pending"?this.scheduleGc():this.#r.remove(this))}continue(){return this.#a?.continue()??this.execute(this.state.variables)}async execute(e){const r=()=>{this.#s({type:"continue"})},s={client:this.#e,meta:this.options.meta,mutationKey:this.options.mutationKey};this.#a=Oo({fn:()=>this.options.mutationFn?this.options.mutationFn(e,s):Promise.reject(new Error("No mutationFn found")),onFail:(i,o)=>{this.#s({type:"failed",failureCount:i,error:o})},onPause:()=>{this.#s({type:"pause"})},onContinue:r,retry:this.options.retry??0,retryDelay:this.options.retryDelay,networkMode:this.options.networkMode,canRun:()=>this.#r.canRun(this)});const a=this.state.status==="pending",n=!this.#a.canStart();try{if(a)r();else{this.#s({type:"pending",variables:e,isPaused:n}),await this.#r.config.onMutate?.(e,this,s);const o=await this.options.onMutate?.(e,s);o!==this.state.context&&this.#s({type:"pending",context:o,variables:e,isPaused:n})}const i=await this.#a.start();return await this.#r.config.onSuccess?.(i,e,this.state.context,this,s),await this.options.onSuccess?.(i,e,this.state.context,s),await this.#r.config.onSettled?.(i,null,this.state.variables,this.state.context,this,s),await this.options.onSettled?.(i,null,e,this.state.context,s),this.#s({type:"success",data:i}),i}catch(i){try{throw await this.#r.config.onError?.(i,e,this.state.context,this,s),await this.options.onError?.(i,e,this.state.context,s),await this.#r.config.onSettled?.(void 0,i,this.state.variables,this.state.context,this,s),await this.options.onSettled?.(void 0,i,e,this.state.context,s),i}finally{this.#s({type:"error",error:i})}}finally{this.#r.runNext(this)}}#s(e){const r=s=>{switch(e.type){case"failed":return{...s,failureCount:e.failureCount,failureReason:e.error};case"pause":return{...s,isPaused:!0};case"continue":return{...s,isPaused:!1};case"pending":return{...s,context:e.context,data:void 0,failureCount:0,failureReason:null,error:null,isPaused:e.isPaused,status:"pending",variables:e.variables,submittedAt:Date.now()};case"success":return{...s,data:e.data,failureCount:0,failureReason:null,error:null,status:"success",isPaused:!1};case"error":return{...s,data:void 0,error:e.error,failureCount:s.failureCount+1,failureReason:e.error,isPaused:!1,status:"error"}}};this.state=r(this.state),at.batch(()=>{this.#t.forEach(s=>{s.onMutationUpdate(e)}),this.#r.notify({mutation:this,type:"updated",action:e})})}};function Rc(){return{context:void 0,data:void 0,error:null,failureCount:0,failureReason:null,isPaused:!1,status:"idle",variables:void 0,submittedAt:0}}var Oc=class extends us{constructor(e={}){super(),this.config=e,this.#e=new Set,this.#t=new Map,this.#r=0}#e;#t;#r;build(e,r,s){const a=new Fc({client:e,mutationCache:this,mutationId:++this.#r,options:e.defaultMutationOptions(r),state:s});return this.add(a),a}add(e){this.#e.add(e);const r=Os(e);if(typeof r=="string"){const s=this.#t.get(r);s?s.push(e):this.#t.set(r,[e])}this.notify({type:"added",mutation:e})}remove(e){if(this.#e.delete(e)){const r=Os(e);if(typeof r=="string"){const s=this.#t.get(r);if(s)if(s.length>1){const a=s.indexOf(e);a!==-1&&s.splice(a,1)}else s[0]===e&&this.#t.delete(r)}}this.notify({type:"removed",mutation:e})}canRun(e){const r=Os(e);if(typeof r=="string"){const a=this.#t.get(r)?.find(n=>n.state.status==="pending");return!a||a===e}else return!0}runNext(e){const r=Os(e);return typeof r=="string"?this.#t.get(r)?.find(a=>a!==e&&a.state.isPaused)?.continue()??Promise.resolve():Promise.resolve()}clear(){at.batch(()=>{this.#e.forEach(e=>{this.notify({type:"removed",mutation:e})}),this.#e.clear(),this.#t.clear()})}getAll(){return Array.from(this.#e)}find(e){const r={exact:!0,...e};return this.getAll().find(s=>_i(r,s))}findAll(e={}){return this.getAll().filter(r=>_i(e,r))}notify(e){at.batch(()=>{this.listeners.forEach(r=>{r(e)})})}resumePausedMutations(){const e=this.getAll().filter(r=>r.state.isPaused);return at.batch(()=>Promise.all(e.map(r=>r.continue().catch(ft))))}};function Os(e){return e.options.scope?.id}var Lc=class extends us{constructor(e={}){super(),this.config=e,this.#e=new Map}#e;build(e,r,s){const a=r.queryKey,n=r.queryHash??hn(a,r);let i=this.get(n);return i||(i=new Pc({client:e,queryKey:a,queryHash:n,options:e.defaultQueryOptions(r),state:s,defaultOptions:e.getQueryDefaults(a)}),this.add(i)),i}add(e){this.#e.has(e.queryHash)||(this.#e.set(e.queryHash,e),this.notify({type:"added",query:e}))}remove(e){const r=this.#e.get(e.queryHash);r&&(e.destroy(),r===e&&this.#e.delete(e.queryHash),this.notify({type:"removed",query:e}))}clear(){at.batch(()=>{this.getAll().forEach(e=>{this.remove(e)})})}get(e){return this.#e.get(e)}getAll(){return[...this.#e.values()]}find(e){const r={exact:!0,...e};return this.getAll().find(s=>bi(r,s))}findAll(e={}){const r=this.getAll();return Object.keys(e).length>0?r.filter(s=>bi(e,s)):r}notify(e){at.batch(()=>{this.listeners.forEach(r=>{r(e)})})}onFocus(){at.batch(()=>{this.getAll().forEach(e=>{e.onFocus()})})}onOnline(){at.batch(()=>{this.getAll().forEach(e=>{e.onOnline()})})}},Bc=class{#e;#t;#r;#a;#s;#o;#i;#n;constructor(e={}){this.#e=e.queryCache||new Lc,this.#t=e.mutationCache||new Oc,this.#r=e.defaultOptions||{},this.#a=new Map,this.#s=new Map,this.#o=0}mount(){this.#o++,this.#o===1&&(this.#i=gn.subscribe(async e=>{e&&(await this.resumePausedMutations(),this.#e.onFocus())}),this.#n=Ks.subscribe(async e=>{e&&(await this.resumePausedMutations(),this.#e.onOnline())}))}unmount(){this.#o--,this.#o===0&&(this.#i?.(),this.#i=void 0,this.#n?.(),this.#n=void 0)}isFetching(e){return this.#e.findAll({...e,fetchStatus:"fetching"}).length}isMutating(e){return this.#t.findAll({...e,status:"pending"}).length}getQueryData(e){const r=this.defaultQueryOptions({queryKey:e});return this.#e.get(r.queryHash)?.state.data}ensureQueryData(e){const r=this.defaultQueryOptions(e),s=this.#e.build(this,r),a=s.state.data;return a===void 0?this.fetchQuery(e):(e.revalidateIfStale&&s.isStaleByTime(lr(r.staleTime,s))&&this.prefetchQuery(r),Promise.resolve(a))}getQueriesData(e){return this.#e.findAll(e).map(({queryKey:r,state:s})=>{const a=s.data;return[r,a]})}setQueryData(e,r,s){const a=this.defaultQueryOptions({queryKey:e}),i=this.#e.get(a.queryHash)?.state.data,o=vc(r,i);if(o!==void 0)return this.#e.build(this,a).setData(o,{...s,manual:!0})}setQueriesData(e,r,s){return at.batch(()=>this.#e.findAll(e).map(({queryKey:a})=>[a,this.setQueryData(a,r,s)]))}getQueryState(e){const r=this.defaultQueryOptions({queryKey:e});return this.#e.get(r.queryHash)?.state}removeQueries(e){const r=this.#e;at.batch(()=>{r.findAll(e).forEach(s=>{r.remove(s)})})}resetQueries(e,r){const s=this.#e;return at.batch(()=>(s.findAll(e).forEach(a=>{a.reset()}),this.refetchQueries({type:"active",...e},r)))}cancelQueries(e,r={}){const s={revert:!0,...r},a=at.batch(()=>this.#e.findAll(e).map(n=>n.cancel(s)));return Promise.all(a).then(ft).catch(ft)}invalidateQueries(e,r={}){return at.batch(()=>(this.#e.findAll(e).forEach(s=>{s.invalidate()}),e?.refetchType==="none"?Promise.resolve():this.refetchQueries({...e,type:e?.refetchType??e?.type??"active"},r)))}refetchQueries(e,r={}){const s={...r,cancelRefetch:r.cancelRefetch??!0},a=at.batch(()=>this.#e.findAll(e).filter(n=>!n.isDisabled()&&!n.isStatic()).map(n=>{let i=n.fetch(void 0,s);return s.throwOnError||(i=i.catch(ft)),n.state.fetchStatus==="paused"?Promise.resolve():i}));return Promise.all(a).then(ft)}fetchQuery(e){const r=this.defaultQueryOptions(e);r.retry===void 0&&(r.retry=!1);const s=this.#e.build(this,r);return s.isStaleByTime(lr(r.staleTime,s))?s.fetch(r):Promise.resolve(s.state.data)}prefetchQuery(e){return this.fetchQuery(e).then(ft).catch(ft)}fetchInfiniteQuery(e){return e.behavior=Si(e.pages),this.fetchQuery(e)}prefetchInfiniteQuery(e){return this.fetchInfiniteQuery(e).then(ft).catch(ft)}ensureInfiniteQueryData(e){return e.behavior=Si(e.pages),this.ensureQueryData(e)}resumePausedMutations(){return Ks.isOnline()?this.#t.resumePausedMutations():Promise.resolve()}getQueryCache(){return this.#e}getMutationCache(){return this.#t}getDefaultOptions(){return this.#r}setDefaultOptions(e){this.#r=e}setQueryDefaults(e,r){this.#a.set(os(e),{queryKey:e,defaultOptions:r})}getQueryDefaults(e){const r=[...this.#a.values()],s={};return r.forEach(a=>{ls(e,a.queryKey)&&Object.assign(s,a.defaultOptions)}),s}setMutationDefaults(e,r){this.#s.set(os(e),{mutationKey:e,defaultOptions:r})}getMutationDefaults(e){const r=[...this.#s.values()],s={};return r.forEach(a=>{ls(e,a.mutationKey)&&Object.assign(s,a.defaultOptions)}),s}defaultQueryOptions(e){if(e._defaulted)return e;const r={...this.#r.queries,...this.getQueryDefaults(e.queryKey),...e,_defaulted:!0};return r.queryHash||(r.queryHash=hn(r.queryKey,r)),r.refetchOnReconnect===void 0&&(r.refetchOnReconnect=r.networkMode!=="always"),r.throwOnError===void 0&&(r.throwOnError=!!r.suspense),!r.networkMode&&r.persister&&(r.networkMode="offlineFirst"),r.queryFn===fn&&(r.enabled=!1),r}defaultMutationOptions(e){return e?._defaulted?e:{...this.#r.mutations,...e?.mutationKey&&this.getMutationDefaults(e.mutationKey),...e,_defaulted:!0}}clear(){this.#e.clear(),this.#t.clear()}},Uo=u.createContext(void 0),Rr=e=>{const r=u.useContext(Uo);if(!r)throw new Error("No QueryClient set, use QueryClientProvider to set one");return r},Uc=({client:e,children:r})=>(u.useEffect(()=>(e.mount(),()=>{e.unmount()}),[e]),t.jsx(Uo.Provider,{value:e,children:r})),Vo=u.createContext(!1),Vc=()=>u.useContext(Vo);Vo.Provider;function Zc(){let e=!1;return{clearReset:()=>{e=!1},reset:()=>{e=!0},isReset:()=>e}}var Wc=u.createContext(Zc()),qc=()=>u.useContext(Wc),Jc=(e,r)=>{(e.suspense||e.throwOnError||e.experimental_prefetchInRender)&&(r.isReset()||(e.retryOnMount=!1))},Qc=e=>{u.useEffect(()=>{e.clearReset()},[e])},Kc=({result:e,errorResetBoundary:r,throwOnError:s,query:a,suspense:n})=>e.isError&&!r.isReset()&&!e.isFetching&&a&&(n&&e.data===void 0||Cc(s,[e.error,a])),Hc=e=>{if(e.suspense){const s=n=>n==="static"?n:Math.max(n??1e3,1e3),a=e.staleTime;e.staleTime=typeof a=="function"?(...n)=>s(a(...n)):s(a),typeof e.gcTime=="number"&&(e.gcTime=Math.max(e.gcTime,1e3))}},Gc=(e,r)=>e.isLoading&&e.isFetching&&!r,Yc=(e,r)=>e?.suspense&&r.isPending,Di=(e,r,s)=>r.fetchOptimistic(e).catch(()=>{s.clearReset()});function Xc(e,r,s){const a=Vc(),n=qc(),i=Rr(),o=i.defaultQueryOptions(e);i.getDefaultOptions().queries?._experimental_beforeQuery?.(o),o._optimisticResults=a?"isRestoring":"optimistic",Hc(o),Jc(o,n),Qc(n);const c=!i.getQueryCache().get(o.queryHash),[g]=u.useState(()=>new r(i,o)),_=g.getOptimisticResult(o),y=!a&&e.subscribed!==!1;if(u.useSyncExternalStore(u.useCallback(D=>{const w=y?g.subscribe(at.batchCalls(D)):ft;return g.updateResult(),w},[g,y]),()=>g.getCurrentResult(),()=>g.getCurrentResult()),u.useEffect(()=>{g.setOptions(o)},[o,g]),Yc(o,_))throw Di(o,g,n);if(Kc({result:_,errorResetBoundary:n,throwOnError:o.throwOnError,query:i.getQueryCache().get(o.queryHash),suspense:o.suspense}))throw _.error;return i.getDefaultOptions().queries?._experimental_afterQuery?.(o,_),o.experimental_prefetchInRender&&!_r&&Gc(_,a)&&(c?Di(o,g,n):i.getQueryCache().get(o.queryHash)?.promise)?.catch(ft).finally(()=>{g.updateResult()}),o.notifyOnChangeProps?_:g.trackResult(_)}function ed(e,r){return Xc(e,Ic)}const Ei=e=>{let r;const s=new Set,a=(_,y)=>{const D=typeof _=="function"?_(r):_;if(!Object.is(D,r)){const w=r;r=y??(typeof D!="object"||D===null)?D:Object.assign({},r,D),s.forEach(I=>I(r,w))}},n=()=>r,c={setState:a,getState:n,getInitialState:()=>g,subscribe:_=>(s.add(_),()=>s.delete(_))},g=r=e(a,n,c);return c},td=(e=>e?Ei(e):Ei),rd=e=>e;function sd(e,r=rd){const s=tt.useSyncExternalStore(e.subscribe,tt.useCallback(()=>r(e.getState()),[e,r]),tt.useCallback(()=>r(e.getInitialState()),[e,r]));return tt.useDebugValue(s),s}const zi=e=>{const r=td(e),s=a=>sd(r,a);return Object.assign(s,r),s},ad=(e=>e?zi(e):zi),Zo="https://supabase.healapp.ru",nd="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyAgCiAgICAicm9sZSI6ICJhbm9uIiwKICAgICJpc3MiOiAic3VwYWJhc2UtZGVtbyIsCiAgICAiaWF0IjogMTY0MTc2OTIwMCwKICAgICJleHAiOiAxNzk5NTM1NjAwCn0.dc_X5iR_VP_qT0zsiyj_I_OZ2T9FtRU2BBNWN8Bu4GE",id="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyAgCiAgICAicm9sZSI6ICJzZXJ2aWNlX3JvbGUiLAogICAgImlzcyI6ICJzdXBhYmFzZS1kZW1vIiwKICAgICJpYXQiOiAxNjQxNzY5MjAwLAogICAgImV4cCI6IDE3OTk1MzU2MDAKfQ.DaYlNEoUrrEn2Ig7tqibS-PHK5vgusbcbo7X36XVt4Q",F=$o(Zo,nd),Ar=$o(Zo,id,{auth:{autoRefreshToken:!1,persistSession:!1}});console.warn("⚠️ Service Role Key detected. This should only be used in local development!");const Ae=ad(e=>({user:null,session:null,isAuthenticated:!1,loading:!0,setUser:r=>e({user:r,isAuthenticated:!!r}),setSession:r=>e({session:r,user:r?.user??null,isAuthenticated:!!r?.user}),setLoading:r=>e({loading:r}),checkAuth:async()=>{try{e({loading:!0});try{const{data:{session:a}}=await F.auth.getSession();if(a?.user){console.log("authStore.checkAuth: Found Supabase session:",{userId:a.user.id,email:a.user.email,organizationType:a.user.user_metadata?.organization_type,userRole:a.user.user_metadata?.user_role});const n=a.user.user_metadata?.organization_type;if(n&&["pension","patronage_agency","caregiver"].includes(n))if(a.user.email_confirmed_at!==null){localStorage.removeItem("current_user"),localStorage.removeItem("auth_token"),console.log("✅ authStore.checkAuth: Authenticated as ORGANIZATION/CAREGIVER via Supabase"),e({session:a,user:a.user,isAuthenticated:!0,loading:!1});return}else{console.log("⚠️ authStore.checkAuth: Email not confirmed for organization/caregiver"),e({session:null,user:null,isAuthenticated:!1,loading:!1});return}const i=a.user.user_metadata?.user_role,o=i==="org_employee";if(o||i==="client"){localStorage.removeItem("current_user"),localStorage.removeItem("auth_token"),console.log("✅ authStore.checkAuth: Authenticated as",o?"EMPLOYEE":"CLIENT","via Supabase"),e({session:a,user:a.user,isAuthenticated:!0,loading:!1});return}}else console.log("authStore.checkAuth: No Supabase session found")}catch(a){console.log("authStore.checkAuth: Supabase unavailable, checking localStorage:",a)}const r=localStorage.getItem("current_user"),s=localStorage.getItem("auth_token");if(console.log("authStore.checkAuth: Checking localStorage...",{hasCurrentUser:!!r,hasAuthToken:!!s,currentUserLength:r?.length||0}),r&&s&&r!=="{}")try{const a=JSON.parse(r),n=a.user_role||a.user_metadata?.user_role;if(console.log("authStore.checkAuth: Parsed localStorage user:",{id:a.id,role:n,phone:a.phone,caregiver_id:a.caregiver_id,organization_id:a.organization_id}),n==="client"||n==="org_employee"){console.log("✅ authStore.checkAuth: Loading",n==="client"?"CLIENT":"EMPLOYEE","from localStorage (legacy)"),e({session:{user:a,access_token:s},user:a,isAuthenticated:!0,loading:!1});return}else console.log("⚠️ authStore.checkAuth: User role not client or employee:",n)}catch(a){console.error("❌ authStore.checkAuth: Error parsing current_user:",a)}else console.log("authStore.checkAuth: No valid localStorage data found");e({session:null,user:null,isAuthenticated:!1,loading:!1})}catch(r){console.error("Error checking auth:",r),e({session:null,user:null,isAuthenticated:!1,loading:!1})}},logout:async()=>{try{localStorage.removeItem("current_user"),localStorage.removeItem("auth_token");try{await F.auth.signOut()}catch{}e({user:null,session:null,isAuthenticated:!1})}catch(r){console.error("Error logging out:",r)}}})),od=()=>t.jsxs("div",{className:"min-h-screen flex flex-col relative",children:[t.jsx("div",{className:"absolute inset-0 bg-blue-primary",children:t.jsx("div",{className:"absolute left-0 top-0 w-32 h-32 bg-blue-400 opacity-20 rounded-full -translate-x-1/2 -translate-y-1/2"})}),t.jsx("div",{className:"h-32 relative z-0",children:t.jsx("div",{className:"absolute inset-0 bg-blue-primary rounded-b-[40px]"})}),t.jsx("div",{className:"flex-1 bg-white rounded-t-[30px] -mt-8 relative z-10 px-4 pt-12 pb-8",children:t.jsx("div",{className:"max-w-md mx-auto",children:t.jsx(mn,{})})})]}),ld=()=>t.jsx("div",{className:"min-h-screen bg-white",children:t.jsx("main",{className:"w-full",children:t.jsx(mn,{})})}),pt=({children:e})=>{const{isAuthenticated:r,loading:s,checkAuth:a,session:n,user:i}=Ae();return u.useEffect(()=>{if(n&&i&&r){s&&(console.log("ProtectedRoute: Already authenticated, resetting loading"),Ae.getState().setLoading(!1));return}if(!n&&!i&&!r){console.log("ProtectedRoute: No session/user found, calling checkAuth()");const o=a(),c=setTimeout(()=>{console.warn("ProtectedRoute: checkAuth timeout, resetting loading"),Ae.getState().setLoading(!1)},5e3);o.then(()=>{clearTimeout(c)}).catch(g=>{clearTimeout(c),console.error("ProtectedRoute: checkAuth failed:",g),Ae.getState().setLoading(!1)})}else s&&(n||i)&&(console.log("ProtectedRoute: Resetting loading state (have session/user)"),Ae.getState().setLoading(!1))},[a,n,i,r,s]),s?t.jsxs("div",{className:"min-h-screen flex items-center justify-center",children:[t.jsx("div",{className:"animate-spin w-8 h-8 border-4 border-blue-primary border-t-transparent rounded-full"}),t.jsx("p",{className:"ml-4 text-gray-600",children:"Загрузка..."})]}):r?t.jsx(t.Fragment,{children:e}):(console.log("ProtectedRoute: Not authenticated, redirecting to /login"),t.jsx(Po,{to:"/login",replace:!0}))},oe=u.forwardRef(({variant:e="primary",size:r="md",isLoading:s=!1,fullWidth:a=!1,className:n="",disabled:i,children:o,...c},g)=>{const _="inline-flex items-center justify-center font-medium transition-transform duration-150 ease-out focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-[#55ACBF] disabled:opacity-50 disabled:cursor-not-allowed select-none touch-manipulation active:scale-95 min-h-[48px]",y={primary:"bg-gradient-to-r from-[#7DD3DC] to-[#5CBCC7] text-white hover:opacity-90 shadow-md hover:shadow-lg",secondary:"bg-gray-200 text-gray-dark hover:bg-gray-300",outline:"border-2 border-blue-primary text-blue-primary hover:bg-blue-50 bg-white"},D={sm:"px-4 py-2 text-sm rounded-2xl",md:"px-6 py-3 text-base rounded-2xl",lg:"px-6 py-4 text-base font-bold rounded-2xl"},w=a?"w-full":"";return t.jsx("button",{ref:g,className:`${_} ${y[e]} ${D[r]} ${w} ${n}`,disabled:i||s,...c,children:s?t.jsxs(t.Fragment,{children:[t.jsxs("svg",{className:"animate-spin -ml-1 mr-2 h-4 w-4 text-current",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[t.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),t.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Загрузка..."]}):o})});oe.displayName="Button";const he=u.forwardRef(({label:e,error:r,helperText:s,fullWidth:a=!1,className:n="",type:i="text",id:o,...c},g)=>{const _=o||e?.toLowerCase().replace(/\s+/g,"-"),y=a?"w-full":"";return t.jsxs("div",{className:`${y}`,children:[e&&t.jsx("label",{htmlFor:_,className:"block text-sm font-manrope font-normal text-gray-dark mb-2",children:e}),t.jsx("input",{ref:g,id:_,type:i,className:`
            block w-full px-4 py-3.5 
            border rounded-xl
            text-base font-manrope text-gray-dark placeholder-gray-400
            focus:outline-none focus:ring-2 focus:ring-offset-0
            transition-colors
            bg-[#F5F5F5]
            ${r?"border-red-500 focus:ring-red-500 focus:border-red-500":"border-transparent focus:ring-blue-primary focus:border-blue-primary"}
            disabled:bg-gray-100 disabled:cursor-not-allowed
            ${n}
          `,...c}),r&&t.jsx("p",{className:"mt-1 text-sm font-manrope text-red-600",children:r}),s&&!r&&t.jsx("p",{className:"mt-1 text-sm font-manrope text-gray-500",children:s})]})});he.displayName="Input";const Vt=({children:e,className:r="",onClick:s})=>{const a="bg-white rounded-xl border border-gray-200 p-4 shadow-sm transition-all",n=s?"cursor-pointer hover:shadow-md hover:border-blue-primary":"";return t.jsx("div",{className:`${a} ${n} ${r}`,onClick:s,children:e})},Hs=({isOpen:e,onClose:r,title:s,children:a,size:n="md"})=>{const i=u.useRef(null);if(u.useEffect(()=>{const c=g=>{i.current&&!i.current.contains(g.target)&&r()};return e&&(document.addEventListener("mousedown",c),document.body.style.overflow="hidden"),()=>{document.removeEventListener("mousedown",c),document.body.style.overflow="unset"}},[e,r]),u.useEffect(()=>{const c=g=>{g.key==="Escape"&&r()};return e&&document.addEventListener("keydown",c),()=>{document.removeEventListener("keydown",c)}},[e,r]),!e)return null;const o={sm:"sm:max-w-sm",md:"sm:max-w-md",lg:"sm:max-w-lg"};return t.jsx("div",{className:"fixed inset-0 z-50 flex items-start justify-center p-4 sm:p-6 bg-black/40 overflow-y-auto",children:t.jsxs("div",{ref:i,className:`relative mt-8 sm:mt-12 bg-white rounded-3xl shadow-xl w-full ${o[n]} max-h-[calc(100dvh-3rem)] sm:max-h-[90vh] overflow-y-auto`,children:[s&&t.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[t.jsx("h2",{className:"text-xl font-bold",style:{color:"#7DD3DC"},children:s}),t.jsx("button",{onClick:r,className:"p-2 text-gray-400 hover:text-gray-600 transition-colors","aria-label":"Закрыть",children:t.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),t.jsx("div",{className:"p-6",children:a})]})})},Wo=u.forwardRef(({label:e,error:r,helperText:s,fullWidth:a=!1,className:n="",id:i,options:o,...c},g)=>{const _=i||e?.toLowerCase().replace(/\s+/g,"-"),y=a?"w-full":"";return t.jsxs("div",{className:`${y}`,children:[e&&t.jsx("label",{htmlFor:_,className:"block text-sm font-manrope font-normal text-gray-dark mb-2",children:e}),t.jsx("select",{ref:g,id:_,className:`
            block w-full px-4 py-3.5 
            border rounded-xl
            text-base font-manrope text-gray-dark
            focus:outline-none focus:ring-2 focus:ring-offset-0
            transition-colors
            bg-[#F5F5F5]
            ${r?"border-red-500 focus:ring-red-500 focus:border-red-500":"border-transparent focus:ring-blue-primary focus:border-blue-primary"}
            disabled:bg-gray-100 disabled:cursor-not-allowed
            ${n}
          `,...c,children:o.map(D=>t.jsx("option",{value:D.value,children:D.label},D.value))}),r&&t.jsx("p",{className:"mt-1 text-sm font-manrope text-red-600",children:r}),s&&!r&&t.jsx("p",{className:"mt-1 text-sm font-manrope text-gray-500",children:s})]})});Wo.displayName="Select";const cd=u.forwardRef(({label:e,error:r,helperText:s,className:a="",id:n,...i},o)=>{const c=n||e?.toLowerCase().replace(/\s+/g,"-");return t.jsxs("div",{className:"flex items-start",children:[t.jsx("div",{className:"flex items-center h-5",children:t.jsx("input",{ref:o,id:c,type:"checkbox",className:`
              w-5 h-5
              rounded border-gray-300
              text-blue-primary
              focus:ring-2 focus:ring-blue-primary focus:ring-offset-0
              transition-colors
              cursor-pointer
              ${r?"border-red-500":""}
              ${a}
            `,...i})}),e&&t.jsxs("div",{className:"ml-3 flex-1",children:[t.jsx("label",{htmlFor:c,className:"text-sm font-manrope font-normal text-gray-dark cursor-pointer",children:e}),r&&t.jsx("p",{className:"mt-1 text-sm font-manrope text-red-600",children:r}),s&&!r&&t.jsx("p",{className:"mt-1 text-sm font-manrope text-gray-500",children:s})]})]})});cd.displayName="Checkbox";const dd=()=>{const e=rt(),r=()=>{const s="79145391376",a=encodeURIComponent("Здравствуйте! Хочу записаться на закрытое тестирование Дневника подопечного."),n=`https://wa.me/${s}?text=${a}`;window.open(n,"_blank")};return t.jsxs("div",{className:"min-h-screen bg-white",children:[t.jsxs("section",{className:"relative overflow-hidden bg-gradient-to-br from-[#7DD3DC] via-[#5CBCC7] to-[#55ACBF] text-white",children:[t.jsx("div",{className:"container mx-auto px-4 py-16 md:py-24 lg:py-32",children:t.jsxs("div",{className:"max-w-4xl mx-auto text-center",children:[t.jsx("h1",{className:"text-4xl md:text-5xl lg:text-6xl font-bold font-manrope mb-6 leading-tight",children:"Дневник здоровья"}),t.jsx("p",{className:"text-xl md:text-2xl font-sans mb-8 text-white/90 leading-relaxed",children:"Отслеживай динамику здоровья и улучшай состояние родственника"}),t.jsx("p",{className:"text-lg md:text-xl font-sans mb-10 text-white/80 max-w-2xl mx-auto leading-relaxed",children:"Цифровой дневник для записи показателей здоровья. Все данные в одном месте — видишь динамику, замечаешь изменения, принимаешь решения вовремя."}),t.jsxs("div",{className:"flex flex-col gap-4 justify-center items-center max-w-sm mx-auto",children:[t.jsx(oe,{size:"lg",variant:"secondary",onClick:r,className:"bg-white text-[#55ACBF] hover:bg-gray-50 w-full",fullWidth:!0,children:"Тестировать"}),t.jsxs("div",{className:"flex flex-col items-center w-full",children:[t.jsx(oe,{size:"lg",onClick:()=>e("/login"),className:"bg-transparent border-2 border-white text-white hover:bg-white/10 w-full",fullWidth:!0,children:"Войти"}),t.jsx("p",{className:"text-white/80 text-xs mt-2 text-center max-w-xs",children:"Доступно тем, кто зарегистрировался на закрытое тестирование"})]})]})]})}),t.jsxs("div",{className:"absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none",children:[t.jsx("div",{className:"absolute top-20 right-10 w-64 h-64 bg-white/10 rounded-full blur-3xl"}),t.jsx("div",{className:"absolute bottom-20 left-10 w-96 h-96 bg-white/5 rounded-full blur-3xl"})]})]}),t.jsx("section",{className:"py-16 md:py-24 bg-white",children:t.jsx("div",{className:"container mx-auto px-4",children:t.jsxs("div",{className:"max-w-4xl mx-auto",children:[t.jsx("h2",{className:"text-3xl md:text-4xl font-bold font-manrope text-gray-dark mb-8 text-center",children:"Как это работает?"}),t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"bg-gradient-to-r from-[#F5F9FA] to-white p-6 rounded-2xl border border-[#E5F0F2]",children:[t.jsxs("h3",{className:"text-xl font-bold font-manrope text-gray-dark mb-3 flex items-center gap-3",children:[t.jsx("span",{className:"w-8 h-8 bg-gradient-to-br from-[#7DD3DC] to-[#5CBCC7] rounded-full flex items-center justify-center text-white font-bold",children:"1"}),"Создаёшь карточку подопечного"]}),t.jsx("p",{className:"text-lg text-gray-700 font-sans leading-relaxed ml-11",children:"Заполняешь основные данные: имя, возраст, диагнозы. Это как медицинская карта, только проще."})]}),t.jsxs("div",{className:"bg-gradient-to-r from-[#F5F9FA] to-white p-6 rounded-2xl border border-[#E5F0F2]",children:[t.jsxs("h3",{className:"text-xl font-bold font-manrope text-gray-dark mb-3 flex items-center gap-3",children:[t.jsx("span",{className:"w-8 h-8 bg-gradient-to-br from-[#7DD3DC] to-[#5CBCC7] rounded-full flex items-center justify-center text-white font-bold",children:"2"}),"Записываешь показатели каждый день"]}),t.jsx("p",{className:"text-lg text-gray-700 font-sans leading-relaxed ml-11",children:"Температура, давление, пульс, сахар — всё в несколько нажатий. Можно добавить фото или голосовую заметку."})]}),t.jsxs("div",{className:"bg-gradient-to-r from-[#F5F9FA] to-white p-6 rounded-2xl border border-[#E5F0F2]",children:[t.jsxs("h3",{className:"text-xl font-bold font-manrope text-gray-dark mb-3 flex items-center gap-3",children:[t.jsx("span",{className:"w-8 h-8 bg-gradient-to-br from-[#7DD3DC] to-[#5CBCC7] rounded-full flex items-center justify-center text-white font-bold",children:"3"}),"Все видят актуальную информацию"]}),t.jsx("p",{className:"text-lg text-gray-700 font-sans leading-relaxed ml-11",children:"Сиделка записала давление утром — ты видишь это сразу. Врач может посмотреть графики за месяц. Всё синхронизируется автоматически."})]})]})]})})}),t.jsx("section",{className:"py-16 md:py-24 bg-gradient-to-b from-white to-[#F5F9FA]",children:t.jsxs("div",{className:"container mx-auto px-4",children:[t.jsx("h2",{className:"text-3xl md:text-4xl font-bold font-manrope text-gray-dark mb-4 text-center",children:"Для кого это?"}),t.jsx("p",{className:"text-lg text-gray-700 font-sans text-center mb-12 max-w-2xl mx-auto",children:"Дневник здоровья подходит разным людям, которые заботятся о здоровье близких"}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 max-w-6xl mx-auto",children:[t.jsxs(Vt,{className:"p-6 md:p-8 hover:shadow-lg transition-shadow",children:[t.jsx("div",{className:"w-16 h-16 bg-gradient-to-br from-[#7DD3DC] to-[#5CBCC7] rounded-full flex items-center justify-center mx-auto mb-6",children:t.jsx("svg",{className:"w-8 h-8 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})})}),t.jsx("h3",{className:"text-xl font-bold font-manrope text-gray-dark mb-4 text-center",children:"Для родственников"}),t.jsx("p",{className:"text-gray-700 font-sans leading-relaxed text-center",children:"Хочешь завести дневник для своего родственника? Теперь вся информация о его здоровье будет в одном месте. Ты всегда будешь знать, что происходит, даже если не можешь быть рядом каждый день."})]}),t.jsxs(Vt,{className:"p-6 md:p-8 hover:shadow-lg transition-shadow",children:[t.jsx("div",{className:"w-16 h-16 bg-gradient-to-br from-[#7DD3DC] to-[#5CBCC7] rounded-full flex items-center justify-center mx-auto mb-6",children:t.jsx("svg",{className:"w-8 h-8 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"})})}),t.jsx("h3",{className:"text-xl font-bold font-manrope text-gray-dark mb-4 text-center",children:"Для частных сиделок"}),t.jsx("p",{className:"text-gray-700 font-sans leading-relaxed text-center",children:"Хочешь повысить качество своих услуг и показать свою дисциплинированность? Веди дневник для каждого подопечного — клиенты увидят твою ответственность и профессионализм. Это выделит тебя среди других сиделок."})]}),t.jsxs(Vt,{className:"p-6 md:p-8 hover:shadow-lg transition-shadow",children:[t.jsx("div",{className:"w-16 h-16 bg-gradient-to-br from-[#7DD3DC] to-[#5CBCC7] rounded-full flex items-center justify-center mx-auto mb-6",children:t.jsx("svg",{className:"w-8 h-8 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"})})}),t.jsx("h3",{className:"text-xl font-bold font-manrope text-gray-dark mb-4 text-center",children:"Для агентств и пансионатов"}),t.jsx("p",{className:"text-gray-700 font-sans leading-relaxed text-center",children:"Нужен удобный инструмент для автоматизации процесса? Дневник здоровья позволит твоим клиентам не волноваться за своих родных — они всегда будут видеть актуальную информацию. Это повысит доверие и снизит количество звонков с вопросами."})]})]})]})}),t.jsx("section",{className:"py-16 md:py-24 bg-white",children:t.jsxs("div",{className:"container mx-auto px-4",children:[t.jsx("h2",{className:"text-3xl md:text-4xl font-bold font-manrope text-gray-dark mb-12 text-center",children:"Почему это важно?"}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-6xl mx-auto",children:[t.jsxs(Vt,{className:"text-center p-6",children:[t.jsx("div",{className:"w-16 h-16 bg-gradient-to-br from-[#7DD3DC] to-[#5CBCC7] rounded-full flex items-center justify-center mx-auto mb-4",children:t.jsx("svg",{className:"w-8 h-8 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})})}),t.jsx("h3",{className:"text-xl font-bold font-manrope text-gray-dark mb-3",children:"Полная картина"}),t.jsx("p",{className:"text-gray-700 font-sans",children:"Все данные в одном месте: показатели здоровья, медикаменты, процедуры и заметки от всех участников ухода"})]}),t.jsxs(Vt,{className:"text-center p-6",children:[t.jsx("div",{className:"w-16 h-16 bg-gradient-to-br from-[#7DD3DC] to-[#5CBCC7] rounded-full flex items-center justify-center mx-auto mb-4",children:t.jsx("svg",{className:"w-8 h-8 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})})}),t.jsx("h3",{className:"text-xl font-bold font-manrope text-gray-dark mb-3",children:"В режиме реального времени"}),t.jsx("p",{className:"text-gray-700 font-sans",children:"Мгновенная синхронизация данных между всеми участниками. Вы всегда в курсе текущего состояния подопечного"})]}),t.jsxs(Vt,{className:"text-center p-6",children:[t.jsx("div",{className:"w-16 h-16 bg-gradient-to-br from-[#7DD3DC] to-[#5CBCC7] rounded-full flex items-center justify-center mx-auto mb-4",children:t.jsx("svg",{className:"w-8 h-8 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"})})}),t.jsx("h3",{className:"text-xl font-bold font-manrope text-gray-dark mb-3",children:"Аналитика и отчёты"}),t.jsx("p",{className:"text-gray-700 font-sans",children:"Графики динамики показателей, экспорт данных в PDF и CSV. Вся информация структурирована и доступна для анализа"})]}),t.jsxs(Vt,{className:"text-center p-6",children:[t.jsx("div",{className:"w-16 h-16 bg-gradient-to-br from-[#7DD3DC] to-[#5CBCC7] rounded-full flex items-center justify-center mx-auto mb-4",children:t.jsx("svg",{className:"w-8 h-8 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"})})}),t.jsx("h3",{className:"text-xl font-bold font-manrope text-gray-dark mb-3",children:"Безопасность данных"}),t.jsx("p",{className:"text-gray-700 font-sans",children:"Гибкая система доступа: вы контролируете, кто может просматривать и редактировать данные о подопечном"})]}),t.jsxs(Vt,{className:"text-center p-6",children:[t.jsx("div",{className:"w-16 h-16 bg-gradient-to-br from-[#7DD3DC] to-[#5CBCC7] rounded-full flex items-center justify-center mx-auto mb-4",children:t.jsx("svg",{className:"w-8 h-8 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"})})}),t.jsx("h3",{className:"text-xl font-bold font-manrope text-gray-dark mb-3",children:"Мультимедиа"}),t.jsx("p",{className:"text-gray-700 font-sans",children:"Фото, видео и голосовые заметки — фиксируйте важные моменты и изменения состояния визуально"})]}),t.jsxs(Vt,{className:"text-center p-6",children:[t.jsx("div",{className:"w-16 h-16 bg-gradient-to-br from-[#7DD3DC] to-[#5CBCC7] rounded-full flex items-center justify-center mx-auto mb-4",children:t.jsx("svg",{className:"w-8 h-8 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"})})}),t.jsx("h3",{className:"text-xl font-bold font-manrope text-gray-dark mb-3",children:"Командная работа"}),t.jsx("p",{className:"text-gray-700 font-sans",children:"Объединяет родственников, сиделок, медсестёр и врачей. Каждый вносит свой вклад в общую картину"})]})]})]})}),t.jsx("section",{className:"py-16 md:py-24 bg-gradient-to-b from-white to-[#F5F9FA]",children:t.jsx("div",{className:"container mx-auto px-4",children:t.jsxs("div",{className:"max-w-4xl mx-auto",children:[t.jsx("h2",{className:"text-3xl md:text-4xl font-bold font-manrope text-gray-dark mb-12 text-center",children:"Основные возможности"}),t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"flex items-start gap-4",children:[t.jsx("div",{className:"flex-shrink-0 w-8 h-8 bg-gradient-to-br from-[#7DD3DC] to-[#5CBCC7] rounded-full flex items-center justify-center mt-1",children:t.jsx("svg",{className:"w-5 h-5 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-xl font-bold font-manrope text-gray-dark mb-2",children:"Структурированные показатели здоровья"}),t.jsx("p",{className:"text-gray-700 font-sans",children:"Температура, давление, пульс, сахар, вес и другие важные метрики. Настраиваемые наборы показателей для каждого подопечного"})]})]}),t.jsxs("div",{className:"flex items-start gap-4",children:[t.jsx("div",{className:"flex-shrink-0 w-8 h-8 bg-gradient-to-br from-[#7DD3DC] to-[#5CBCC7] rounded-full flex items-center justify-center mt-1",children:t.jsx("svg",{className:"w-5 h-5 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-xl font-bold font-manrope text-gray-dark mb-2",children:"Карточка подопечного"}),t.jsx("p",{className:"text-gray-700 font-sans",children:"Личные данные, диагнозы, мобильность и другая важная информация в структурированном виде"})]})]}),t.jsxs("div",{className:"flex items-start gap-4",children:[t.jsx("div",{className:"flex-shrink-0 w-8 h-8 bg-gradient-to-br from-[#7DD3DC] to-[#5CBCC7] rounded-full flex items-center justify-center mt-1",children:t.jsx("svg",{className:"w-5 h-5 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-xl font-bold font-manrope text-gray-dark mb-2",children:"Графики и аналитика"}),t.jsx("p",{className:"text-gray-700 font-sans",children:"Визуализация динамики показателей во времени. Отслеживание трендов и выявление закономерностей"})]})]}),t.jsxs("div",{className:"flex items-start gap-4",children:[t.jsx("div",{className:"flex-shrink-0 w-8 h-8 bg-gradient-to-br from-[#7DD3DC] to-[#5CBCC7] rounded-full flex items-center justify-center mt-1",children:t.jsx("svg",{className:"w-5 h-5 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-xl font-bold font-manrope text-gray-dark mb-2",children:"Экспорт данных"}),t.jsx("p",{className:"text-gray-700 font-sans",children:"Генерация отчётов в PDF и CSV форматах для передачи врачам или ведения документации"})]})]}),t.jsxs("div",{className:"flex items-start gap-4",children:[t.jsx("div",{className:"flex-shrink-0 w-8 h-8 bg-gradient-to-br from-[#7DD3DC] to-[#5CBCC7] rounded-full flex items-center justify-center mt-1",children:t.jsx("svg",{className:"w-5 h-5 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-xl font-bold font-manrope text-gray-dark mb-2",children:"Гибкая система доступа"}),t.jsx("p",{className:"text-gray-700 font-sans",children:"Пригласительные ссылки для организаций, сиделок и клиентов. Вы контролируете, кто имеет доступ к данным"})]})]})]})]})})}),t.jsx("section",{className:"py-16 md:py-24 bg-gradient-to-br from-[#F5F9FA] to-white",children:t.jsx("div",{className:"container mx-auto px-4",children:t.jsx("div",{className:"max-w-2xl mx-auto",children:t.jsxs(Vt,{className:"p-8 md:p-12 text-center",children:[t.jsxs("div",{className:"mb-8",children:[t.jsx("div",{className:"w-20 h-20 bg-gradient-to-br from-[#25D366] to-[#128C7E] rounded-full flex items-center justify-center mx-auto mb-6",children:t.jsx("svg",{className:"w-10 h-10 text-white",fill:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{d:"M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"})})}),t.jsx("h2",{className:"text-3xl md:text-4xl font-bold font-manrope text-gray-dark mb-4",children:"Записаться на закрытое тестирование"}),t.jsx("p",{className:"text-lg text-gray-700 font-sans mb-8 leading-relaxed",children:"Мы запускаем закрытое тестирование системы. Напишите нам, и мы отправим вам пригласительную ссылку для доступа к платформе."})]}),t.jsxs(oe,{size:"lg",fullWidth:!0,onClick:r,className:"bg-gradient-to-r from-[#25D366] to-[#128C7E] hover:from-[#20BA5A] hover:to-[#0F7A6D] text-white border-0 shadow-lg hover:shadow-xl",children:[t.jsx("svg",{className:"w-6 h-6 mr-2",fill:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{d:"M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"})}),"Связаться в WhatsApp"]}),t.jsxs("a",{href:"https://t.me/povelmar",target:"_blank",rel:"noopener noreferrer","aria-label":"Связаться в Telegram",title:"Связаться в Telegram",className:"mt-4 w-full inline-flex items-center justify-center gap-3 text-white rounded-2xl px-4 py-1 text-sm font-semibold border-0 shadow-lg hover:shadow-xl bg-gradient-to-r from-[#00aaff] to-[#0077cc] hover:from-[#2faaff] hover:to-[#006fa0]",children:[t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"size-12 mr-2 flex-shrink-0",viewBox:"0 0 32 32",fill:"none","aria-hidden":!0,children:t.jsx("path",{d:"M22.9866 10.2088C23.1112 9.40332 22.3454 8.76755 21.6292 9.082L7.36482 15.3448C6.85123 15.5703 6.8888 16.3483 7.42147 16.5179L10.3631 17.4547C10.9246 17.6335 11.5325 17.541 12.0228 17.2023L18.655 12.6203C18.855 12.4821 19.073 12.7665 18.9021 12.9426L14.1281 17.8646C13.665 18.3421 13.7569 19.1512 14.314 19.5005L19.659 22.8523C20.2585 23.2282 21.0297 22.8506 21.1418 22.1261L22.9866 10.2088Z",fill:"currentColor"})}),t.jsx("span",{children:"Связаться в Telegram"})]}),t.jsx("p",{className:"mt-6 text-sm text-gray-600 font-sans",children:"Нажав на кнопку, вы перейдёте в WhatsApp или Telegram для связи с нами"})]})})})}),t.jsx("footer",{className:"bg-gray-dark text-white py-12",children:t.jsx("div",{className:"container mx-auto px-4",children:t.jsxs("div",{className:"max-w-4xl mx-auto text-center",children:[t.jsx("h3",{className:"text-2xl font-bold font-manrope mb-4",children:"Дневник здоровья"}),t.jsx("p",{className:"text-gray-300 font-sans mb-6",children:"Простой способ следить за здоровьем близкого человека"}),t.jsx("div",{className:"mt-8 pt-8 border-t border-gray-600",children:t.jsxs("p",{className:"text-sm text-gray-400 font-sans",children:["© ",new Date().getFullYear()," Дневник здоровья. Все права защищены."]})})]})})})]})};var ms=e=>e.type==="checkbox",br=e=>e instanceof Date,gt=e=>e==null;const qo=e=>typeof e=="object";var Je=e=>!gt(e)&&!Array.isArray(e)&&qo(e)&&!br(e),ud=e=>Je(e)&&e.target?ms(e.target)?e.target.checked:e.target.value:e,md=e=>e.substring(0,e.search(/\.\d+(\.|$)/))||e,hd=(e,r)=>e.has(md(r)),fd=e=>{const r=e.constructor&&e.constructor.prototype;return Je(r)&&r.hasOwnProperty("isPrototypeOf")},xn=typeof window<"u"&&typeof window.HTMLElement<"u"&&typeof document<"u";function et(e){let r;const s=Array.isArray(e),a=typeof FileList<"u"?e instanceof FileList:!1;if(e instanceof Date)r=new Date(e);else if(!(xn&&(e instanceof Blob||a))&&(s||Je(e)))if(r=s?[]:Object.create(Object.getPrototypeOf(e)),!s&&!fd(e))r=e;else for(const n in e)e.hasOwnProperty(n)&&(r[n]=et(e[n]));else return e;return r}var sa=e=>/^\w*$/.test(e),Ze=e=>e===void 0,yn=e=>Array.isArray(e)?e.filter(Boolean):[],bn=e=>yn(e.replace(/["|']|\]/g,"").split(/\.|\[/)),pe=(e,r,s)=>{if(!r||!Je(e))return s;const a=(sa(r)?[r]:bn(r)).reduce((n,i)=>gt(n)?n:n[i],e);return Ze(a)||a===e?Ze(e[r])?s:e[r]:a},qt=e=>typeof e=="boolean",Fe=(e,r,s)=>{let a=-1;const n=sa(r)?[r]:bn(r),i=n.length,o=i-1;for(;++a<i;){const c=n[a];let g=s;if(a!==o){const _=e[c];g=Je(_)||Array.isArray(_)?_:isNaN(+n[a+1])?{}:[]}if(c==="__proto__"||c==="constructor"||c==="prototype")return;e[c]=g,e=e[c]}};const Pi={BLUR:"blur",FOCUS_OUT:"focusout"},Mt={onBlur:"onBlur",onChange:"onChange",onSubmit:"onSubmit",onTouched:"onTouched",all:"all"},Ht={max:"max",min:"min",maxLength:"maxLength",minLength:"minLength",pattern:"pattern",required:"required",validate:"validate"},gd=tt.createContext(null);gd.displayName="HookFormContext";var pd=(e,r,s,a=!0)=>{const n={defaultValues:r._defaultValues};for(const i in e)Object.defineProperty(n,i,{get:()=>{const o=i;return r._proxyFormState[o]!==Mt.all&&(r._proxyFormState[o]=!a||Mt.all),e[o]}});return n};const xd=typeof window<"u"?tt.useLayoutEffect:tt.useEffect;var Nt=e=>typeof e=="string",yd=(e,r,s,a,n)=>Nt(e)?(a&&r.watch.add(e),pe(s,e,n)):Array.isArray(e)?e.map(i=>(a&&r.watch.add(i),pe(s,i))):(a&&(r.watchAll=!0),s),tn=e=>gt(e)||!qo(e);function or(e,r,s=new WeakSet){if(tn(e)||tn(r))return e===r;if(br(e)&&br(r))return e.getTime()===r.getTime();const a=Object.keys(e),n=Object.keys(r);if(a.length!==n.length)return!1;if(s.has(e)||s.has(r))return!0;s.add(e),s.add(r);for(const i of a){const o=e[i];if(!n.includes(i))return!1;if(i!=="ref"){const c=r[i];if(br(o)&&br(c)||Je(o)&&Je(c)||Array.isArray(o)&&Array.isArray(c)?!or(o,c,s):o!==c)return!1}}return!0}var _n=(e,r,s,a,n)=>r?{...s[e],types:{...s[e]&&s[e].types?s[e].types:{},[a]:n||!0}}:{},as=e=>Array.isArray(e)?e:[e],Ii=()=>{let e=[];return{get observers(){return e},next:n=>{for(const i of e)i.next&&i.next(n)},subscribe:n=>(e.push(n),{unsubscribe:()=>{e=e.filter(i=>i!==n)}}),unsubscribe:()=>{e=[]}}};function Jo(e,r){const s={};for(const a in e)if(e.hasOwnProperty(a)){const n=e[a],i=r[a];if(n&&Je(n)&&i){const o=Jo(n,i);Je(o)&&(s[a]=o)}else e[a]&&(s[a]=i)}return s}var mt=e=>Je(e)&&!Object.keys(e).length,vn=e=>e.type==="file",Tt=e=>typeof e=="function",Gs=e=>{if(!xn)return!1;const r=e?e.ownerDocument:0;return e instanceof(r&&r.defaultView?r.defaultView.HTMLElement:HTMLElement)},Qo=e=>e.type==="select-multiple",jn=e=>e.type==="radio",bd=e=>jn(e)||ms(e),$a=e=>Gs(e)&&e.isConnected;function _d(e,r){const s=r.slice(0,-1).length;let a=0;for(;a<s;)e=Ze(e)?a++:e[r[a++]];return e}function vd(e){for(const r in e)if(e.hasOwnProperty(r)&&!Ze(e[r]))return!1;return!0}function qe(e,r){const s=Array.isArray(r)?r:sa(r)?[r]:bn(r),a=s.length===1?e:_d(e,s),n=s.length-1,i=s[n];return a&&delete a[i],n!==0&&(Je(a)&&mt(a)||Array.isArray(a)&&vd(a))&&qe(e,s.slice(0,-1)),e}var jd=e=>{for(const r in e)if(Tt(e[r]))return!0;return!1};function Ko(e){return Array.isArray(e)||Je(e)&&!jd(e)}function rn(e,r={}){for(const s in e)Ko(e[s])?(r[s]=Array.isArray(e[s])?[]:{},rn(e[s],r[s])):Ze(e[s])||(r[s]=!0);return r}function Pr(e,r,s){s||(s=rn(r));for(const a in e)Ko(e[a])?Ze(r)||tn(s[a])?s[a]=rn(e[a],Array.isArray(e[a])?[]:{}):Pr(e[a],gt(r)?{}:r[a],s[a]):s[a]=!or(e[a],r[a]);return s}const $i={value:!1,isValid:!1},Mi={value:!0,isValid:!0};var Ho=e=>{if(Array.isArray(e)){if(e.length>1){const r=e.filter(s=>s&&s.checked&&!s.disabled).map(s=>s.value);return{value:r,isValid:!!r.length}}return e[0].checked&&!e[0].disabled?e[0].attributes&&!Ze(e[0].attributes.value)?Ze(e[0].value)||e[0].value===""?Mi:{value:e[0].value,isValid:!0}:Mi:$i}return $i},Go=(e,{valueAsNumber:r,valueAsDate:s,setValueAs:a})=>Ze(e)?e:r?e===""?NaN:e&&+e:s&&Nt(e)?new Date(e):a?a(e):e;const Ti={isValid:!1,value:null};var Yo=e=>Array.isArray(e)?e.reduce((r,s)=>s&&s.checked&&!s.disabled?{isValid:!0,value:s.value}:r,Ti):Ti;function Fi(e){const r=e.ref;return vn(r)?r.files:jn(r)?Yo(e.refs).value:Qo(r)?[...r.selectedOptions].map(({value:s})=>s):ms(r)?Ho(e.refs).value:Go(Ze(r.value)?e.ref.value:r.value,e)}var wd=(e,r,s,a)=>{const n={};for(const i of e){const o=pe(r,i);o&&Fe(n,i,o._f)}return{criteriaMode:s,names:[...e],fields:n,shouldUseNativeValidation:a}},Ys=e=>e instanceof RegExp,ts=e=>Ze(e)?e:Ys(e)?e.source:Je(e)?Ys(e.value)?e.value.source:e.value:e,Ri=e=>({isOnSubmit:!e||e===Mt.onSubmit,isOnBlur:e===Mt.onBlur,isOnChange:e===Mt.onChange,isOnAll:e===Mt.all,isOnTouch:e===Mt.onTouched});const Oi="AsyncFunction";var Nd=e=>!!e&&!!e.validate&&!!(Tt(e.validate)&&e.validate.constructor.name===Oi||Je(e.validate)&&Object.values(e.validate).find(r=>r.constructor.name===Oi)),kd=e=>e.mount&&(e.required||e.min||e.max||e.maxLength||e.minLength||e.pattern||e.validate),Li=(e,r,s)=>!s&&(r.watchAll||r.watch.has(e)||[...r.watch].some(a=>e.startsWith(a)&&/^\.\w+/.test(e.slice(a.length))));const ns=(e,r,s,a)=>{for(const n of s||Object.keys(e)){const i=pe(e,n);if(i){const{_f:o,...c}=i;if(o){if(o.refs&&o.refs[0]&&r(o.refs[0],n)&&!a)return!0;if(o.ref&&r(o.ref,o.name)&&!a)return!0;if(ns(c,r))break}else if(Je(c)&&ns(c,r))break}}};function Bi(e,r,s){const a=pe(e,s);if(a||sa(s))return{error:a,name:s};const n=s.split(".");for(;n.length;){const i=n.join("."),o=pe(r,i),c=pe(e,i);if(o&&!Array.isArray(o)&&s!==i)return{name:s};if(c&&c.type)return{name:i,error:c};if(c&&c.root&&c.root.type)return{name:`${i}.root`,error:c.root};n.pop()}return{name:s}}var Cd=(e,r,s,a)=>{s(e);const{name:n,...i}=e;return mt(i)||Object.keys(i).length>=Object.keys(r).length||Object.keys(i).find(o=>r[o]===(!a||Mt.all))},Sd=(e,r,s)=>!e||!r||e===r||as(e).some(a=>a&&(s?a===r:a.startsWith(r)||r.startsWith(a))),Ad=(e,r,s,a,n)=>n.isOnAll?!1:!s&&n.isOnTouch?!(r||e):(s?a.isOnBlur:n.isOnBlur)?!e:(s?a.isOnChange:n.isOnChange)?e:!0,Dd=(e,r)=>!yn(pe(e,r)).length&&qe(e,r),Ed=(e,r,s)=>{const a=as(pe(e,s));return Fe(a,"root",r[s]),Fe(e,s,a),e};function Ui(e,r,s="validate"){if(Nt(e)||Array.isArray(e)&&e.every(Nt)||qt(e)&&!e)return{type:s,message:Nt(e)?e:"",ref:r}}var Dr=e=>Je(e)&&!Ys(e)?e:{value:e,message:""},Vi=async(e,r,s,a,n,i)=>{const{ref:o,refs:c,required:g,maxLength:_,minLength:y,min:D,max:w,pattern:I,validate:P,name:S,valueAsNumber:U,mount:O}=e._f,$=pe(s,S);if(!O||r.has(S))return{};const p=c?c[0]:o,k=Z=>{n&&p.reportValidity&&(p.setCustomValidity(qt(Z)?"":Z||""),p.reportValidity())},f={},x=jn(o),R=ms(o),G=x||R,M=(U||vn(o))&&Ze(o.value)&&Ze($)||Gs(o)&&o.value===""||$===""||Array.isArray($)&&!$.length,L=_n.bind(null,S,a,f),B=(Z,j,v,E=Ht.maxLength,T=Ht.minLength)=>{const J=Z?j:v;f[S]={type:Z?E:T,message:J,ref:o,...L(Z?E:T,J)}};if(i?!Array.isArray($)||!$.length:g&&(!G&&(M||gt($))||qt($)&&!$||R&&!Ho(c).isValid||x&&!Yo(c).isValid)){const{value:Z,message:j}=Nt(g)?{value:!!g,message:g}:Dr(g);if(Z&&(f[S]={type:Ht.required,message:j,ref:p,...L(Ht.required,j)},!a))return k(j),f}if(!M&&(!gt(D)||!gt(w))){let Z,j;const v=Dr(w),E=Dr(D);if(!gt($)&&!isNaN($)){const T=o.valueAsNumber||$&&+$;gt(v.value)||(Z=T>v.value),gt(E.value)||(j=T<E.value)}else{const T=o.valueAsDate||new Date($),J=C=>new Date(new Date().toDateString()+" "+C),W=o.type=="time",h=o.type=="week";Nt(v.value)&&$&&(Z=W?J($)>J(v.value):h?$>v.value:T>new Date(v.value)),Nt(E.value)&&$&&(j=W?J($)<J(E.value):h?$<E.value:T<new Date(E.value))}if((Z||j)&&(B(!!Z,v.message,E.message,Ht.max,Ht.min),!a))return k(f[S].message),f}if((_||y)&&!M&&(Nt($)||i&&Array.isArray($))){const Z=Dr(_),j=Dr(y),v=!gt(Z.value)&&$.length>+Z.value,E=!gt(j.value)&&$.length<+j.value;if((v||E)&&(B(v,Z.message,j.message),!a))return k(f[S].message),f}if(I&&!M&&Nt($)){const{value:Z,message:j}=Dr(I);if(Ys(Z)&&!$.match(Z)&&(f[S]={type:Ht.pattern,message:j,ref:o,...L(Ht.pattern,j)},!a))return k(j),f}if(P){if(Tt(P)){const Z=await P($,s),j=Ui(Z,p);if(j&&(f[S]={...j,...L(Ht.validate,j.message)},!a))return k(j.message),f}else if(Je(P)){let Z={};for(const j in P){if(!mt(Z)&&!a)break;const v=Ui(await P[j]($,s),p,j);v&&(Z={...v,...L(j,v.message)},k(v.message),a&&(f[S]=Z))}if(!mt(Z)&&(f[S]={ref:p,...Z},!a))return f}}return k(!0),f};const zd={mode:Mt.onSubmit,reValidateMode:Mt.onChange,shouldFocusError:!0};function Pd(e={}){let r={...zd,...e},s={submitCount:0,isDirty:!1,isReady:!1,isLoading:Tt(r.defaultValues),isValidating:!1,isSubmitted:!1,isSubmitting:!1,isSubmitSuccessful:!1,isValid:!1,touchedFields:{},dirtyFields:{},validatingFields:{},errors:r.errors||{},disabled:r.disabled||!1},a={},n=Je(r.defaultValues)||Je(r.values)?et(r.defaultValues||r.values)||{}:{},i=r.shouldUnregister?{}:et(n),o={action:!1,mount:!1,watch:!1},c={mount:new Set,disabled:new Set,unMount:new Set,array:new Set,watch:new Set},g,_=0;const y={isDirty:!1,dirtyFields:!1,validatingFields:!1,touchedFields:!1,isValidating:!1,isValid:!1,errors:!1};let D={...y};const w={array:Ii(),state:Ii()},I=r.criteriaMode===Mt.all,P=m=>A=>{clearTimeout(_),_=setTimeout(m,A)},S=async m=>{if(!r.disabled&&(y.isValid||D.isValid||m)){const A=r.resolver?mt((await R()).errors):await M(a,!0);A!==s.isValid&&w.state.next({isValid:A})}},U=(m,A)=>{!r.disabled&&(y.isValidating||y.validatingFields||D.isValidating||D.validatingFields)&&((m||Array.from(c.mount)).forEach(V=>{V&&(A?Fe(s.validatingFields,V,A):qe(s.validatingFields,V))}),w.state.next({validatingFields:s.validatingFields,isValidating:!mt(s.validatingFields)}))},O=(m,A=[],V,le,se=!0,ie=!0)=>{if(le&&V&&!r.disabled){if(o.action=!0,ie&&Array.isArray(pe(a,m))){const be=V(pe(a,m),le.argA,le.argB);se&&Fe(a,m,be)}if(ie&&Array.isArray(pe(s.errors,m))){const be=V(pe(s.errors,m),le.argA,le.argB);se&&Fe(s.errors,m,be),Dd(s.errors,m)}if((y.touchedFields||D.touchedFields)&&ie&&Array.isArray(pe(s.touchedFields,m))){const be=V(pe(s.touchedFields,m),le.argA,le.argB);se&&Fe(s.touchedFields,m,be)}(y.dirtyFields||D.dirtyFields)&&(s.dirtyFields=Pr(n,i)),w.state.next({name:m,isDirty:B(m,A),dirtyFields:s.dirtyFields,errors:s.errors,isValid:s.isValid})}else Fe(i,m,A)},$=(m,A)=>{Fe(s.errors,m,A),w.state.next({errors:s.errors})},p=m=>{s.errors=m,w.state.next({errors:s.errors,isValid:!1})},k=(m,A,V,le)=>{const se=pe(a,m);if(se){const ie=pe(i,m,Ze(V)?pe(n,m):V);Ze(ie)||le&&le.defaultChecked||A?Fe(i,m,A?ie:Fi(se._f)):v(m,ie),o.mount&&S()}},f=(m,A,V,le,se)=>{let ie=!1,be=!1;const $e={name:m};if(!r.disabled){if(!V||le){(y.isDirty||D.isDirty)&&(be=s.isDirty,s.isDirty=$e.isDirty=B(),ie=be!==$e.isDirty);const Me=or(pe(n,m),A);be=!!pe(s.dirtyFields,m),Me?qe(s.dirtyFields,m):Fe(s.dirtyFields,m,!0),$e.dirtyFields=s.dirtyFields,ie=ie||(y.dirtyFields||D.dirtyFields)&&be!==!Me}if(V){const Me=pe(s.touchedFields,m);Me||(Fe(s.touchedFields,m,V),$e.touchedFields=s.touchedFields,ie=ie||(y.touchedFields||D.touchedFields)&&Me!==V)}ie&&se&&w.state.next($e)}return ie?$e:{}},x=(m,A,V,le)=>{const se=pe(s.errors,m),ie=(y.isValid||D.isValid)&&qt(A)&&s.isValid!==A;if(r.delayError&&V?(g=P(()=>$(m,V)),g(r.delayError)):(clearTimeout(_),g=null,V?Fe(s.errors,m,V):qe(s.errors,m)),(V?!or(se,V):se)||!mt(le)||ie){const be={...le,...ie&&qt(A)?{isValid:A}:{},errors:s.errors,name:m};s={...s,...be},w.state.next(be)}},R=async m=>{U(m,!0);const A=await r.resolver(i,r.context,wd(m||c.mount,a,r.criteriaMode,r.shouldUseNativeValidation));return U(m),A},G=async m=>{const{errors:A}=await R(m);if(m)for(const V of m){const le=pe(A,V);le?Fe(s.errors,V,le):qe(s.errors,V)}else s.errors=A;return A},M=async(m,A,V={valid:!0})=>{for(const le in m){const se=m[le];if(se){const{_f:ie,...be}=se;if(ie){const $e=c.array.has(ie.name),Me=se._f&&Nd(se._f);Me&&y.validatingFields&&U([ie.name],!0);const ot=await Vi(se,c.disabled,i,I,r.shouldUseNativeValidation&&!A,$e);if(Me&&y.validatingFields&&U([ie.name]),ot[ie.name]&&(V.valid=!1,A))break;!A&&(pe(ot,ie.name)?$e?Ed(s.errors,ot,ie.name):Fe(s.errors,ie.name,ot[ie.name]):qe(s.errors,ie.name))}!mt(be)&&await M(be,A,V)}}return V.valid},L=()=>{for(const m of c.unMount){const A=pe(a,m);A&&(A._f.refs?A._f.refs.every(V=>!$a(V)):!$a(A._f.ref))&&z(m)}c.unMount=new Set},B=(m,A)=>!r.disabled&&(m&&A&&Fe(i,m,A),!or(C(),n)),Z=(m,A,V)=>yd(m,c,{...o.mount?i:Ze(A)?n:Nt(m)?{[m]:A}:A},V,A),j=m=>yn(pe(o.mount?i:n,m,r.shouldUnregister?pe(n,m,[]):[])),v=(m,A,V={})=>{const le=pe(a,m);let se=A;if(le){const ie=le._f;ie&&(!ie.disabled&&Fe(i,m,Go(A,ie)),se=Gs(ie.ref)&&gt(A)?"":A,Qo(ie.ref)?[...ie.ref.options].forEach(be=>be.selected=se.includes(be.value)):ie.refs?ms(ie.ref)?ie.refs.forEach(be=>{(!be.defaultChecked||!be.disabled)&&(Array.isArray(se)?be.checked=!!se.find($e=>$e===be.value):be.checked=se===be.value||!!se)}):ie.refs.forEach(be=>be.checked=be.value===se):vn(ie.ref)?ie.ref.value="":(ie.ref.value=se,ie.ref.type||w.state.next({name:m,values:et(i)})))}(V.shouldDirty||V.shouldTouch)&&f(m,se,V.shouldTouch,V.shouldDirty,!0),V.shouldValidate&&h(m)},E=(m,A,V)=>{for(const le in A){if(!A.hasOwnProperty(le))return;const se=A[le],ie=m+"."+le,be=pe(a,ie);(c.array.has(m)||Je(se)||be&&!be._f)&&!br(se)?E(ie,se,V):v(ie,se,V)}},T=(m,A,V={})=>{const le=pe(a,m),se=c.array.has(m),ie=et(A);Fe(i,m,ie),se?(w.array.next({name:m,values:et(i)}),(y.isDirty||y.dirtyFields||D.isDirty||D.dirtyFields)&&V.shouldDirty&&w.state.next({name:m,dirtyFields:Pr(n,i),isDirty:B(m,ie)})):le&&!le._f&&!gt(ie)?E(m,ie,V):v(m,ie,V),Li(m,c)&&w.state.next({...s,name:m}),w.state.next({name:o.mount?m:void 0,values:et(i)})},J=async m=>{o.mount=!0;const A=m.target;let V=A.name,le=!0;const se=pe(a,V),ie=Me=>{le=Number.isNaN(Me)||br(Me)&&isNaN(Me.getTime())||or(Me,pe(i,V,Me))},be=Ri(r.mode),$e=Ri(r.reValidateMode);if(se){let Me,ot;const Qt=A.type?Fi(se._f):ud(m),Pt=m.type===Pi.BLUR||m.type===Pi.FOCUS_OUT,Lr=!kd(se._f)&&!r.resolver&&!pe(s.errors,V)&&!se._f.deps||Ad(Pt,pe(s.touchedFields,V),s.isSubmitted,$e,be),Xt=Li(V,c,Pt);Fe(i,V,Qt),Pt?(!A||!A.readOnly)&&(se._f.onBlur&&se._f.onBlur(m),g&&g(0)):se._f.onChange&&se._f.onChange(m);const kr=f(V,Qt,Pt),Br=!mt(kr)||Xt;if(!Pt&&w.state.next({name:V,type:m.type,values:et(i)}),Lr)return(y.isValid||D.isValid)&&(r.mode==="onBlur"?Pt&&S():Pt||S()),Br&&w.state.next({name:V,...Xt?{}:kr});if(!Pt&&Xt&&w.state.next({...s}),r.resolver){const{errors:Ur}=await R([V]);if(ie(Qt),le){const ps=Bi(s.errors,a,V),xs=Bi(Ur,a,ps.name||V);Me=xs.error,V=xs.name,ot=mt(Ur)}}else U([V],!0),Me=(await Vi(se,c.disabled,i,I,r.shouldUseNativeValidation))[V],U([V]),ie(Qt),le&&(Me?ot=!1:(y.isValid||D.isValid)&&(ot=await M(a,!0)));le&&(se._f.deps&&(!Array.isArray(se._f.deps)||se._f.deps.length>0)&&h(se._f.deps),x(V,ot,Me,kr))}},W=(m,A)=>{if(pe(s.errors,A)&&m.focus)return m.focus(),1},h=async(m,A={})=>{let V,le;const se=as(m);if(r.resolver){const ie=await G(Ze(m)?m:se);V=mt(ie),le=m?!se.some(be=>pe(ie,be)):V}else m?(le=(await Promise.all(se.map(async ie=>{const be=pe(a,ie);return await M(be&&be._f?{[ie]:be}:be)}))).every(Boolean),!(!le&&!s.isValid)&&S()):le=V=await M(a);return w.state.next({...!Nt(m)||(y.isValid||D.isValid)&&V!==s.isValid?{}:{name:m},...r.resolver||!m?{isValid:V}:{},errors:s.errors}),A.shouldFocus&&!le&&ns(a,W,m?se:c.mount),le},C=(m,A)=>{let V={...o.mount?i:n};return A&&(V=Jo(A.dirtyFields?s.dirtyFields:s.touchedFields,V)),Ze(m)?V:Nt(m)?pe(V,m):m.map(le=>pe(V,le))},Y=(m,A)=>({invalid:!!pe((A||s).errors,m),isDirty:!!pe((A||s).dirtyFields,m),error:pe((A||s).errors,m),isValidating:!!pe(s.validatingFields,m),isTouched:!!pe((A||s).touchedFields,m)}),ee=m=>{m&&as(m).forEach(A=>qe(s.errors,A)),w.state.next({errors:m?s.errors:{}})},ae=(m,A,V)=>{const le=(pe(a,m,{_f:{}})._f||{}).ref,se=pe(s.errors,m)||{},{ref:ie,message:be,type:$e,...Me}=se;Fe(s.errors,m,{...Me,...A,ref:le}),w.state.next({name:m,errors:s.errors,isValid:!1}),V&&V.shouldFocus&&le&&le.focus&&le.focus()},ne=(m,A)=>Tt(m)?w.state.subscribe({next:V=>"values"in V&&m(Z(void 0,A),V)}):Z(m,A,!0),b=m=>w.state.subscribe({next:A=>{Sd(m.name,A.name,m.exact)&&Cd(A,m.formState||y,kt,m.reRenderRoot)&&m.callback({values:{...i},...s,...A,defaultValues:n})}}).unsubscribe,Q=m=>(o.mount=!0,D={...D,...m.formState},b({...m,formState:D})),z=(m,A={})=>{for(const V of m?as(m):c.mount)c.mount.delete(V),c.array.delete(V),A.keepValue||(qe(a,V),qe(i,V)),!A.keepError&&qe(s.errors,V),!A.keepDirty&&qe(s.dirtyFields,V),!A.keepTouched&&qe(s.touchedFields,V),!A.keepIsValidating&&qe(s.validatingFields,V),!r.shouldUnregister&&!A.keepDefaultValue&&qe(n,V);w.state.next({values:et(i)}),w.state.next({...s,...A.keepDirty?{isDirty:B()}:{}}),!A.keepIsValid&&S()},fe=({disabled:m,name:A})=>{(qt(m)&&o.mount||m||c.disabled.has(A))&&(m?c.disabled.add(A):c.disabled.delete(A))},ye=(m,A={})=>{let V=pe(a,m);const le=qt(A.disabled)||qt(r.disabled);return Fe(a,m,{...V||{},_f:{...V&&V._f?V._f:{ref:{name:m}},name:m,mount:!0,...A}}),c.mount.add(m),V?fe({disabled:qt(A.disabled)?A.disabled:r.disabled,name:m}):k(m,!0,A.value),{...le?{disabled:A.disabled||r.disabled}:{},...r.progressive?{required:!!A.required,min:ts(A.min),max:ts(A.max),minLength:ts(A.minLength),maxLength:ts(A.maxLength),pattern:ts(A.pattern)}:{},name:m,onChange:J,onBlur:J,ref:se=>{if(se){ye(m,A),V=pe(a,m);const ie=Ze(se.value)&&se.querySelectorAll&&se.querySelectorAll("input,select,textarea")[0]||se,be=bd(ie),$e=V._f.refs||[];if(be?$e.find(Me=>Me===ie):ie===V._f.ref)return;Fe(a,m,{_f:{...V._f,...be?{refs:[...$e.filter($a),ie,...Array.isArray(pe(n,m))?[{}]:[]],ref:{type:ie.type,name:m}}:{ref:ie}}}),k(m,!1,void 0,ie)}else V=pe(a,m,{}),V._f&&(V._f.mount=!1),(r.shouldUnregister||A.shouldUnregister)&&!(hd(c.array,m)&&o.action)&&c.unMount.add(m)}}},ce=()=>r.shouldFocusError&&ns(a,W,c.mount),me=m=>{qt(m)&&(w.state.next({disabled:m}),ns(a,(A,V)=>{const le=pe(a,V);le&&(A.disabled=le._f.disabled||m,Array.isArray(le._f.refs)&&le._f.refs.forEach(se=>{se.disabled=le._f.disabled||m}))},0,!1))},_e=(m,A)=>async V=>{let le;V&&(V.preventDefault&&V.preventDefault(),V.persist&&V.persist());let se=et(i);if(w.state.next({isSubmitting:!0}),r.resolver){const{errors:ie,values:be}=await R();s.errors=ie,se=et(be)}else await M(a);if(c.disabled.size)for(const ie of c.disabled)qe(se,ie);if(qe(s.errors,"root"),mt(s.errors)){w.state.next({errors:{}});try{await m(se,V)}catch(ie){le=ie}}else A&&await A({...s.errors},V),ce(),setTimeout(ce);if(w.state.next({isSubmitted:!0,isSubmitting:!1,isSubmitSuccessful:mt(s.errors)&&!le,submitCount:s.submitCount+1,errors:s.errors}),le)throw le},De=(m,A={})=>{pe(a,m)&&(Ze(A.defaultValue)?T(m,et(pe(n,m))):(T(m,A.defaultValue),Fe(n,m,et(A.defaultValue))),A.keepTouched||qe(s.touchedFields,m),A.keepDirty||(qe(s.dirtyFields,m),s.isDirty=A.defaultValue?B(m,et(pe(n,m))):B()),A.keepError||(qe(s.errors,m),y.isValid&&S()),w.state.next({...s}))},xe=(m,A={})=>{const V=m?et(m):n,le=et(V),se=mt(m),ie=se?n:le;if(A.keepDefaultValues||(n=V),!A.keepValues){if(A.keepDirtyValues){const be=new Set([...c.mount,...Object.keys(Pr(n,i))]);for(const $e of Array.from(be))pe(s.dirtyFields,$e)?Fe(ie,$e,pe(i,$e)):T($e,pe(ie,$e))}else{if(xn&&Ze(m))for(const be of c.mount){const $e=pe(a,be);if($e&&$e._f){const Me=Array.isArray($e._f.refs)?$e._f.refs[0]:$e._f.ref;if(Gs(Me)){const ot=Me.closest("form");if(ot){ot.reset();break}}}}if(A.keepFieldsRef)for(const be of c.mount)T(be,pe(ie,be));else a={}}i=r.shouldUnregister?A.keepDefaultValues?et(n):{}:et(ie),w.array.next({values:{...ie}}),w.state.next({values:{...ie}})}c={mount:A.keepDirtyValues?c.mount:new Set,unMount:new Set,array:new Set,disabled:new Set,watch:new Set,watchAll:!1,focus:""},o.mount=!y.isValid||!!A.keepIsValid||!!A.keepDirtyValues||!r.shouldUnregister&&!mt(ie),o.watch=!!r.shouldUnregister,w.state.next({submitCount:A.keepSubmitCount?s.submitCount:0,isDirty:se?!1:A.keepDirty?s.isDirty:!!(A.keepDefaultValues&&!or(m,n)),isSubmitted:A.keepIsSubmitted?s.isSubmitted:!1,dirtyFields:se?{}:A.keepDirtyValues?A.keepDefaultValues&&i?Pr(n,i):s.dirtyFields:A.keepDefaultValues&&m?Pr(n,m):A.keepDirty?s.dirtyFields:{},touchedFields:A.keepTouched?s.touchedFields:{},errors:A.keepErrors?s.errors:{},isSubmitSuccessful:A.keepIsSubmitSuccessful?s.isSubmitSuccessful:!1,isSubmitting:!1,defaultValues:n})},ze=(m,A)=>xe(Tt(m)?m(i):m,A),Ce=(m,A={})=>{const V=pe(a,m),le=V&&V._f;if(le){const se=le.refs?le.refs[0]:le.ref;se.focus&&(se.focus(),A.shouldSelect&&Tt(se.select)&&se.select())}},kt=m=>{s={...s,...m}},Ct={control:{register:ye,unregister:z,getFieldState:Y,handleSubmit:_e,setError:ae,_subscribe:b,_runSchema:R,_focusError:ce,_getWatch:Z,_getDirty:B,_setValid:S,_setFieldArray:O,_setDisabledField:fe,_setErrors:p,_getFieldArray:j,_reset:xe,_resetDefaultValues:()=>Tt(r.defaultValues)&&r.defaultValues().then(m=>{ze(m,r.resetOptions),w.state.next({isLoading:!1})}),_removeUnmounted:L,_disableForm:me,_subjects:w,_proxyFormState:y,get _fields(){return a},get _formValues(){return i},get _state(){return o},set _state(m){o=m},get _defaultValues(){return n},get _names(){return c},set _names(m){c=m},get _formState(){return s},get _options(){return r},set _options(m){r={...r,...m}}},subscribe:Q,trigger:h,register:ye,handleSubmit:_e,watch:ne,setValue:T,getValues:C,reset:ze,resetField:De,clearErrors:ee,unregister:z,setError:ae,setFocus:Ce,getFieldState:Y};return{...Ct,formControl:Ct}}function xt(e={}){const r=tt.useRef(void 0),s=tt.useRef(void 0),[a,n]=tt.useState({isDirty:!1,isValidating:!1,isLoading:Tt(e.defaultValues),isSubmitted:!1,isSubmitting:!1,isSubmitSuccessful:!1,isValid:!1,submitCount:0,dirtyFields:{},touchedFields:{},validatingFields:{},errors:e.errors||{},disabled:e.disabled||!1,isReady:!1,defaultValues:Tt(e.defaultValues)?void 0:e.defaultValues});if(!r.current)if(e.formControl)r.current={...e.formControl,formState:a},e.defaultValues&&!Tt(e.defaultValues)&&e.formControl.reset(e.defaultValues,e.resetOptions);else{const{formControl:o,...c}=Pd(e);r.current={...c,formState:a}}const i=r.current.control;return i._options=e,xd(()=>{const o=i._subscribe({formState:i._proxyFormState,callback:()=>n({...i._formState}),reRenderRoot:!0});return n(c=>({...c,isReady:!0})),i._formState.isReady=!0,o},[i]),tt.useEffect(()=>i._disableForm(e.disabled),[i,e.disabled]),tt.useEffect(()=>{e.mode&&(i._options.mode=e.mode),e.reValidateMode&&(i._options.reValidateMode=e.reValidateMode)},[i,e.mode,e.reValidateMode]),tt.useEffect(()=>{e.errors&&(i._setErrors(e.errors),i._focusError())},[i,e.errors]),tt.useEffect(()=>{e.shouldUnregister&&i._subjects.state.next({values:i._getWatch()})},[i,e.shouldUnregister]),tt.useEffect(()=>{if(i._proxyFormState.isDirty){const o=i._getDirty();o!==a.isDirty&&i._subjects.state.next({isDirty:o})}},[i,a.isDirty]),tt.useEffect(()=>{e.values&&!or(e.values,s.current)?(i._reset(e.values,{keepFieldsRef:!0,...i._options.resetOptions}),s.current=e.values,n(o=>({...o}))):i._resetDefaultValues()},[i,e.values]),tt.useEffect(()=>{i._state.mount||(i._setValid(),i._state.mount=!0),i._state.watch&&(i._state.watch=!1,i._subjects.state.next({...i._formState})),i._removeUnmounted()}),r.current.formState=pd(a,i),r.current}const Zi=(e,r,s)=>{if(e&&"reportValidity"in e){const a=pe(s,r);e.setCustomValidity(a&&a.message||""),e.reportValidity()}},sn=(e,r)=>{for(const s in r.fields){const a=r.fields[s];a&&a.ref&&"reportValidity"in a.ref?Zi(a.ref,s,e):a&&a.refs&&a.refs.forEach(n=>Zi(n,s,e))}},Wi=(e,r)=>{r.shouldUseNativeValidation&&sn(e,r);const s={};for(const a in e){const n=pe(r.fields,a),i=Object.assign(e[a]||{},{ref:n&&n.ref});if(Id(r.names||Object.keys(e),a)){const o=Object.assign({},pe(s,a));Fe(o,"root",i),Fe(s,a,o)}else Fe(s,a,i)}return s},Id=(e,r)=>{const s=qi(r);return e.some(a=>qi(a).match(`^${s}\\.\\d+`))};function qi(e){return e.replace(/\]|\[/g,"")}function te(e,r,s){function a(c,g){var _;Object.defineProperty(c,"_zod",{value:c._zod??{},enumerable:!1}),(_=c._zod).traits??(_.traits=new Set),c._zod.traits.add(e),r(c,g);for(const y in o.prototype)y in c||Object.defineProperty(c,y,{value:o.prototype[y].bind(c)});c._zod.constr=o,c._zod.def=g}const n=s?.Parent??Object;class i extends n{}Object.defineProperty(i,"name",{value:e});function o(c){var g;const _=s?.Parent?new i:this;a(_,c),(g=_._zod).deferred??(g.deferred=[]);for(const y of _._zod.deferred)y();return _}return Object.defineProperty(o,"init",{value:a}),Object.defineProperty(o,Symbol.hasInstance,{value:c=>s?.Parent&&c instanceof s.Parent?!0:c?._zod?.traits?.has(e)}),Object.defineProperty(o,"name",{value:e}),o}class $r extends Error{constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}}class Xo extends Error{constructor(r){super(`Encountered unidirectional transform during encode: ${r}`),this.name="ZodEncodeError"}}const el={};function vr(e){return el}function $d(e){const r=Object.values(e).filter(a=>typeof a=="number");return Object.entries(e).filter(([a,n])=>r.indexOf(+a)===-1).map(([a,n])=>n)}function an(e,r){return typeof r=="bigint"?r.toString():r}function wn(e){return{get value(){{const r=e();return Object.defineProperty(this,"value",{value:r}),r}}}}function Nn(e){return e==null}function kn(e){const r=e.startsWith("^")?1:0,s=e.endsWith("$")?e.length-1:e.length;return e.slice(r,s)}const Ji=Symbol("evaluating");function Re(e,r,s){let a;Object.defineProperty(e,r,{get(){if(a!==Ji)return a===void 0&&(a=Ji,a=s()),a},set(n){Object.defineProperty(e,r,{value:n})},configurable:!0})}function wr(e,r,s){Object.defineProperty(e,r,{value:s,writable:!0,enumerable:!0,configurable:!0})}function Nr(...e){const r={};for(const s of e){const a=Object.getOwnPropertyDescriptors(s);Object.assign(r,a)}return Object.defineProperties({},r)}function Qi(e){return JSON.stringify(e)}const tl="captureStackTrace"in Error?Error.captureStackTrace:(...e)=>{};function Xs(e){return typeof e=="object"&&e!==null&&!Array.isArray(e)}const Md=wn(()=>{if(typeof navigator<"u"&&navigator?.userAgent?.includes("Cloudflare"))return!1;try{const e=Function;return new e(""),!0}catch{return!1}});function cs(e){if(Xs(e)===!1)return!1;const r=e.constructor;if(r===void 0)return!0;const s=r.prototype;return!(Xs(s)===!1||Object.prototype.hasOwnProperty.call(s,"isPrototypeOf")===!1)}function rl(e){return cs(e)?{...e}:Array.isArray(e)?[...e]:e}const Td=new Set(["string","number","symbol"]);function aa(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function dr(e,r,s){const a=new e._zod.constr(r??e._zod.def);return(!r||s?.parent)&&(a._zod.parent=e),a}function ve(e){const r=e;if(!r)return{};if(typeof r=="string")return{error:()=>r};if(r?.message!==void 0){if(r?.error!==void 0)throw new Error("Cannot specify both `message` and `error` params");r.error=r.message}return delete r.message,typeof r.error=="string"?{...r,error:()=>r.error}:r}function Fd(e){return Object.keys(e).filter(r=>e[r]._zod.optin==="optional"&&e[r]._zod.optout==="optional")}function Rd(e,r){const s=e._zod.def,a=Nr(e._zod.def,{get shape(){const n={};for(const i in r){if(!(i in s.shape))throw new Error(`Unrecognized key: "${i}"`);r[i]&&(n[i]=s.shape[i])}return wr(this,"shape",n),n},checks:[]});return dr(e,a)}function Od(e,r){const s=e._zod.def,a=Nr(e._zod.def,{get shape(){const n={...e._zod.def.shape};for(const i in r){if(!(i in s.shape))throw new Error(`Unrecognized key: "${i}"`);r[i]&&delete n[i]}return wr(this,"shape",n),n},checks:[]});return dr(e,a)}function Ld(e,r){if(!cs(r))throw new Error("Invalid input to extend: expected a plain object");const s=e._zod.def.checks;if(s&&s.length>0)throw new Error("Object schemas containing refinements cannot be extended. Use `.safeExtend()` instead.");const n=Nr(e._zod.def,{get shape(){const i={...e._zod.def.shape,...r};return wr(this,"shape",i),i},checks:[]});return dr(e,n)}function Bd(e,r){if(!cs(r))throw new Error("Invalid input to safeExtend: expected a plain object");const s={...e._zod.def,get shape(){const a={...e._zod.def.shape,...r};return wr(this,"shape",a),a},checks:e._zod.def.checks};return dr(e,s)}function Ud(e,r){const s=Nr(e._zod.def,{get shape(){const a={...e._zod.def.shape,...r._zod.def.shape};return wr(this,"shape",a),a},get catchall(){return r._zod.def.catchall},checks:[]});return dr(e,s)}function Vd(e,r,s){const a=Nr(r._zod.def,{get shape(){const n=r._zod.def.shape,i={...n};if(s)for(const o in s){if(!(o in n))throw new Error(`Unrecognized key: "${o}"`);s[o]&&(i[o]=e?new e({type:"optional",innerType:n[o]}):n[o])}else for(const o in n)i[o]=e?new e({type:"optional",innerType:n[o]}):n[o];return wr(this,"shape",i),i},checks:[]});return dr(r,a)}function Zd(e,r,s){const a=Nr(r._zod.def,{get shape(){const n=r._zod.def.shape,i={...n};if(s)for(const o in s){if(!(o in i))throw new Error(`Unrecognized key: "${o}"`);s[o]&&(i[o]=new e({type:"nonoptional",innerType:n[o]}))}else for(const o in n)i[o]=new e({type:"nonoptional",innerType:n[o]});return wr(this,"shape",i),i},checks:[]});return dr(r,a)}function Ir(e,r=0){if(e.aborted===!0)return!0;for(let s=r;s<e.issues.length;s++)if(e.issues[s]?.continue!==!0)return!0;return!1}function sl(e,r){return r.map(s=>{var a;return(a=s).path??(a.path=[]),s.path.unshift(e),s})}function Ls(e){return typeof e=="string"?e:e?.message}function jr(e,r,s){const a={...e,path:e.path??[]};if(!e.message){const n=Ls(e.inst?._zod.def?.error?.(e))??Ls(r?.error?.(e))??Ls(s.customError?.(e))??Ls(s.localeError?.(e))??"Invalid input";a.message=n}return delete a.inst,delete a.continue,r?.reportInput||delete a.input,a}function Cn(e){return Array.isArray(e)?"array":typeof e=="string"?"string":"unknown"}function ds(...e){const[r,s,a]=e;return typeof r=="string"?{message:r,code:"custom",input:s,inst:a}:{...r}}const al=(e,r)=>{e.name="$ZodError",Object.defineProperty(e,"_zod",{value:e._zod,enumerable:!1}),Object.defineProperty(e,"issues",{value:r,enumerable:!1}),e.message=JSON.stringify(r,an,2),Object.defineProperty(e,"toString",{value:()=>e.message,enumerable:!1})},Sn=te("$ZodError",al),na=te("$ZodError",al,{Parent:Error});function Wd(e,r=s=>s.message){const s={},a=[];for(const n of e.issues)n.path.length>0?(s[n.path[0]]=s[n.path[0]]||[],s[n.path[0]].push(r(n))):a.push(r(n));return{formErrors:a,fieldErrors:s}}function qd(e,r=s=>s.message){const s={_errors:[]},a=n=>{for(const i of n.issues)if(i.code==="invalid_union"&&i.errors.length)i.errors.map(o=>a({issues:o}));else if(i.code==="invalid_key")a({issues:i.issues});else if(i.code==="invalid_element")a({issues:i.issues});else if(i.path.length===0)s._errors.push(r(i));else{let o=s,c=0;for(;c<i.path.length;){const g=i.path[c];c===i.path.length-1?(o[g]=o[g]||{_errors:[]},o[g]._errors.push(r(i))):o[g]=o[g]||{_errors:[]},o=o[g],c++}}};return a(e),s}const ia=e=>(r,s,a,n)=>{const i=a?Object.assign(a,{async:!1}):{async:!1},o=r._zod.run({value:s,issues:[]},i);if(o instanceof Promise)throw new $r;if(o.issues.length){const c=new(n?.Err??e)(o.issues.map(g=>jr(g,i,vr())));throw tl(c,n?.callee),c}return o.value},Jd=ia(na),oa=e=>async(r,s,a,n)=>{const i=a?Object.assign(a,{async:!0}):{async:!0};let o=r._zod.run({value:s,issues:[]},i);if(o instanceof Promise&&(o=await o),o.issues.length){const c=new(n?.Err??e)(o.issues.map(g=>jr(g,i,vr())));throw tl(c,n?.callee),c}return o.value},Qd=oa(na),la=e=>(r,s,a)=>{const n=a?{...a,async:!1}:{async:!1},i=r._zod.run({value:s,issues:[]},n);if(i instanceof Promise)throw new $r;return i.issues.length?{success:!1,error:new(e??Sn)(i.issues.map(o=>jr(o,n,vr())))}:{success:!0,data:i.value}},Kd=la(na),ca=e=>async(r,s,a)=>{const n=a?Object.assign(a,{async:!0}):{async:!0};let i=r._zod.run({value:s,issues:[]},n);return i instanceof Promise&&(i=await i),i.issues.length?{success:!1,error:new e(i.issues.map(o=>jr(o,n,vr())))}:{success:!0,data:i.value}},Hd=ca(na),Gd=e=>(r,s,a)=>{const n=a?Object.assign(a,{direction:"backward"}):{direction:"backward"};return ia(e)(r,s,n)},Yd=e=>(r,s,a)=>ia(e)(r,s,a),Xd=e=>async(r,s,a)=>{const n=a?Object.assign(a,{direction:"backward"}):{direction:"backward"};return oa(e)(r,s,n)},eu=e=>async(r,s,a)=>oa(e)(r,s,a),tu=e=>(r,s,a)=>{const n=a?Object.assign(a,{direction:"backward"}):{direction:"backward"};return la(e)(r,s,n)},ru=e=>(r,s,a)=>la(e)(r,s,a),su=e=>async(r,s,a)=>{const n=a?Object.assign(a,{direction:"backward"}):{direction:"backward"};return ca(e)(r,s,n)},au=e=>async(r,s,a)=>ca(e)(r,s,a),nu=/^[cC][^\s-]{8,}$/,iu=/^[0-9a-z]+$/,ou=/^[0-9A-HJKMNP-TV-Za-hjkmnp-tv-z]{26}$/,lu=/^[0-9a-vA-V]{20}$/,cu=/^[A-Za-z0-9]{27}$/,du=/^[a-zA-Z0-9_-]{21}$/,uu=/^P(?:(\d+W)|(?!.*W)(?=\d|T\d)(\d+Y)?(\d+M)?(\d+D)?(T(?=\d)(\d+H)?(\d+M)?(\d+([.,]\d+)?S)?)?)$/,mu=/^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12})$/,Ki=e=>e?new RegExp(`^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-${e}[0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12})$`):/^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-8][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/,hu=/^(?!\.)(?!.*\.\.)([A-Za-z0-9_'+\-\.]*)[A-Za-z0-9_+-]@([A-Za-z0-9][A-Za-z0-9\-]*\.)+[A-Za-z]{2,}$/,fu="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";function gu(){return new RegExp(fu,"u")}const pu=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,xu=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:))$/,yu=/^((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/([0-9]|[1-2][0-9]|3[0-2])$/,bu=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|::|([0-9a-fA-F]{1,4})?::([0-9a-fA-F]{1,4}:?){0,6})\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,_u=/^$|^(?:[0-9a-zA-Z+/]{4})*(?:(?:[0-9a-zA-Z+/]{2}==)|(?:[0-9a-zA-Z+/]{3}=))?$/,nl=/^[A-Za-z0-9_-]*$/,vu=/^(?=.{1,253}\.?$)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[-0-9a-zA-Z]{0,61}[0-9a-zA-Z])?)*\.?$/,ju=/^\+(?:[0-9]){6,14}[0-9]$/,il="(?:(?:\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-(?:(?:0[13578]|1[02])-(?:0[1-9]|[12]\\d|3[01])|(?:0[469]|11)-(?:0[1-9]|[12]\\d|30)|(?:02)-(?:0[1-9]|1\\d|2[0-8])))",wu=new RegExp(`^${il}$`);function ol(e){const r="(?:[01]\\d|2[0-3]):[0-5]\\d";return typeof e.precision=="number"?e.precision===-1?`${r}`:e.precision===0?`${r}:[0-5]\\d`:`${r}:[0-5]\\d\\.\\d{${e.precision}}`:`${r}(?::[0-5]\\d(?:\\.\\d+)?)?`}function Nu(e){return new RegExp(`^${ol(e)}$`)}function ku(e){const r=ol({precision:e.precision}),s=["Z"];e.local&&s.push(""),e.offset&&s.push("([+-](?:[01]\\d|2[0-3]):[0-5]\\d)");const a=`${r}(?:${s.join("|")})`;return new RegExp(`^${il}T(?:${a})$`)}const Cu=e=>{const r=e?`[\\s\\S]{${e?.minimum??0},${e?.maximum??""}}`:"[\\s\\S]*";return new RegExp(`^${r}$`)},Su=/^(?:true|false)$/i,Au=/^[^A-Z]*$/,Du=/^[^a-z]*$/,Jt=te("$ZodCheck",(e,r)=>{var s;e._zod??(e._zod={}),e._zod.def=r,(s=e._zod).onattach??(s.onattach=[])}),Eu=te("$ZodCheckMaxLength",(e,r)=>{var s;Jt.init(e,r),(s=e._zod.def).when??(s.when=a=>{const n=a.value;return!Nn(n)&&n.length!==void 0}),e._zod.onattach.push(a=>{const n=a._zod.bag.maximum??Number.POSITIVE_INFINITY;r.maximum<n&&(a._zod.bag.maximum=r.maximum)}),e._zod.check=a=>{const n=a.value;if(n.length<=r.maximum)return;const o=Cn(n);a.issues.push({origin:o,code:"too_big",maximum:r.maximum,inclusive:!0,input:n,inst:e,continue:!r.abort})}}),zu=te("$ZodCheckMinLength",(e,r)=>{var s;Jt.init(e,r),(s=e._zod.def).when??(s.when=a=>{const n=a.value;return!Nn(n)&&n.length!==void 0}),e._zod.onattach.push(a=>{const n=a._zod.bag.minimum??Number.NEGATIVE_INFINITY;r.minimum>n&&(a._zod.bag.minimum=r.minimum)}),e._zod.check=a=>{const n=a.value;if(n.length>=r.minimum)return;const o=Cn(n);a.issues.push({origin:o,code:"too_small",minimum:r.minimum,inclusive:!0,input:n,inst:e,continue:!r.abort})}}),Pu=te("$ZodCheckLengthEquals",(e,r)=>{var s;Jt.init(e,r),(s=e._zod.def).when??(s.when=a=>{const n=a.value;return!Nn(n)&&n.length!==void 0}),e._zod.onattach.push(a=>{const n=a._zod.bag;n.minimum=r.length,n.maximum=r.length,n.length=r.length}),e._zod.check=a=>{const n=a.value,i=n.length;if(i===r.length)return;const o=Cn(n),c=i>r.length;a.issues.push({origin:o,...c?{code:"too_big",maximum:r.length}:{code:"too_small",minimum:r.length},inclusive:!0,exact:!0,input:a.value,inst:e,continue:!r.abort})}}),da=te("$ZodCheckStringFormat",(e,r)=>{var s,a;Jt.init(e,r),e._zod.onattach.push(n=>{const i=n._zod.bag;i.format=r.format,r.pattern&&(i.patterns??(i.patterns=new Set),i.patterns.add(r.pattern))}),r.pattern?(s=e._zod).check??(s.check=n=>{r.pattern.lastIndex=0,!r.pattern.test(n.value)&&n.issues.push({origin:"string",code:"invalid_format",format:r.format,input:n.value,...r.pattern?{pattern:r.pattern.toString()}:{},inst:e,continue:!r.abort})}):(a=e._zod).check??(a.check=()=>{})}),Iu=te("$ZodCheckRegex",(e,r)=>{da.init(e,r),e._zod.check=s=>{r.pattern.lastIndex=0,!r.pattern.test(s.value)&&s.issues.push({origin:"string",code:"invalid_format",format:"regex",input:s.value,pattern:r.pattern.toString(),inst:e,continue:!r.abort})}}),$u=te("$ZodCheckLowerCase",(e,r)=>{r.pattern??(r.pattern=Au),da.init(e,r)}),Mu=te("$ZodCheckUpperCase",(e,r)=>{r.pattern??(r.pattern=Du),da.init(e,r)}),Tu=te("$ZodCheckIncludes",(e,r)=>{Jt.init(e,r);const s=aa(r.includes),a=new RegExp(typeof r.position=="number"?`^.{${r.position}}${s}`:s);r.pattern=a,e._zod.onattach.push(n=>{const i=n._zod.bag;i.patterns??(i.patterns=new Set),i.patterns.add(a)}),e._zod.check=n=>{n.value.includes(r.includes,r.position)||n.issues.push({origin:"string",code:"invalid_format",format:"includes",includes:r.includes,input:n.value,inst:e,continue:!r.abort})}}),Fu=te("$ZodCheckStartsWith",(e,r)=>{Jt.init(e,r);const s=new RegExp(`^${aa(r.prefix)}.*`);r.pattern??(r.pattern=s),e._zod.onattach.push(a=>{const n=a._zod.bag;n.patterns??(n.patterns=new Set),n.patterns.add(s)}),e._zod.check=a=>{a.value.startsWith(r.prefix)||a.issues.push({origin:"string",code:"invalid_format",format:"starts_with",prefix:r.prefix,input:a.value,inst:e,continue:!r.abort})}}),Ru=te("$ZodCheckEndsWith",(e,r)=>{Jt.init(e,r);const s=new RegExp(`.*${aa(r.suffix)}$`);r.pattern??(r.pattern=s),e._zod.onattach.push(a=>{const n=a._zod.bag;n.patterns??(n.patterns=new Set),n.patterns.add(s)}),e._zod.check=a=>{a.value.endsWith(r.suffix)||a.issues.push({origin:"string",code:"invalid_format",format:"ends_with",suffix:r.suffix,input:a.value,inst:e,continue:!r.abort})}}),Ou=te("$ZodCheckOverwrite",(e,r)=>{Jt.init(e,r),e._zod.check=s=>{s.value=r.tx(s.value)}});class Lu{constructor(r=[]){this.content=[],this.indent=0,this&&(this.args=r)}indented(r){this.indent+=1,r(this),this.indent-=1}write(r){if(typeof r=="function"){r(this,{execution:"sync"}),r(this,{execution:"async"});return}const a=r.split(`
`).filter(o=>o),n=Math.min(...a.map(o=>o.length-o.trimStart().length)),i=a.map(o=>o.slice(n)).map(o=>" ".repeat(this.indent*2)+o);for(const o of i)this.content.push(o)}compile(){const r=Function,s=this?.args,n=[...(this?.content??[""]).map(i=>`  ${i}`)];return new r(...s,n.join(`
`))}}const Bu={major:4,minor:1,patch:12},Qe=te("$ZodType",(e,r)=>{var s;e??(e={}),e._zod.def=r,e._zod.bag=e._zod.bag||{},e._zod.version=Bu;const a=[...e._zod.def.checks??[]];e._zod.traits.has("$ZodCheck")&&a.unshift(e);for(const n of a)for(const i of n._zod.onattach)i(e);if(a.length===0)(s=e._zod).deferred??(s.deferred=[]),e._zod.deferred?.push(()=>{e._zod.run=e._zod.parse});else{const n=(o,c,g)=>{let _=Ir(o),y;for(const D of c){if(D._zod.def.when){if(!D._zod.def.when(o))continue}else if(_)continue;const w=o.issues.length,I=D._zod.check(o);if(I instanceof Promise&&g?.async===!1)throw new $r;if(y||I instanceof Promise)y=(y??Promise.resolve()).then(async()=>{await I,o.issues.length!==w&&(_||(_=Ir(o,w)))});else{if(o.issues.length===w)continue;_||(_=Ir(o,w))}}return y?y.then(()=>o):o},i=(o,c,g)=>{if(Ir(o))return o.aborted=!0,o;const _=n(c,a,g);if(_ instanceof Promise){if(g.async===!1)throw new $r;return _.then(y=>e._zod.parse(y,g))}return e._zod.parse(_,g)};e._zod.run=(o,c)=>{if(c.skipChecks)return e._zod.parse(o,c);if(c.direction==="backward"){const _=e._zod.parse({value:o.value,issues:[]},{...c,skipChecks:!0});return _ instanceof Promise?_.then(y=>i(y,o,c)):i(_,o,c)}const g=e._zod.parse(o,c);if(g instanceof Promise){if(c.async===!1)throw new $r;return g.then(_=>n(_,a,c))}return n(g,a,c)}}e["~standard"]={validate:n=>{try{const i=Kd(e,n);return i.success?{value:i.data}:{issues:i.error?.issues}}catch{return Hd(e,n).then(o=>o.success?{value:o.data}:{issues:o.error?.issues})}},vendor:"zod",version:1}}),An=te("$ZodString",(e,r)=>{Qe.init(e,r),e._zod.pattern=[...e?._zod.bag?.patterns??[]].pop()??Cu(e._zod.bag),e._zod.parse=(s,a)=>{if(r.coerce)try{s.value=String(s.value)}catch{}return typeof s.value=="string"||s.issues.push({expected:"string",code:"invalid_type",input:s.value,inst:e}),s}}),Be=te("$ZodStringFormat",(e,r)=>{da.init(e,r),An.init(e,r)}),Uu=te("$ZodGUID",(e,r)=>{r.pattern??(r.pattern=mu),Be.init(e,r)}),Vu=te("$ZodUUID",(e,r)=>{if(r.version){const a={v1:1,v2:2,v3:3,v4:4,v5:5,v6:6,v7:7,v8:8}[r.version];if(a===void 0)throw new Error(`Invalid UUID version: "${r.version}"`);r.pattern??(r.pattern=Ki(a))}else r.pattern??(r.pattern=Ki());Be.init(e,r)}),Zu=te("$ZodEmail",(e,r)=>{r.pattern??(r.pattern=hu),Be.init(e,r)}),Wu=te("$ZodURL",(e,r)=>{Be.init(e,r),e._zod.check=s=>{try{const a=s.value.trim(),n=new URL(a);r.hostname&&(r.hostname.lastIndex=0,r.hostname.test(n.hostname)||s.issues.push({code:"invalid_format",format:"url",note:"Invalid hostname",pattern:vu.source,input:s.value,inst:e,continue:!r.abort})),r.protocol&&(r.protocol.lastIndex=0,r.protocol.test(n.protocol.endsWith(":")?n.protocol.slice(0,-1):n.protocol)||s.issues.push({code:"invalid_format",format:"url",note:"Invalid protocol",pattern:r.protocol.source,input:s.value,inst:e,continue:!r.abort})),r.normalize?s.value=n.href:s.value=a;return}catch{s.issues.push({code:"invalid_format",format:"url",input:s.value,inst:e,continue:!r.abort})}}}),qu=te("$ZodEmoji",(e,r)=>{r.pattern??(r.pattern=gu()),Be.init(e,r)}),Ju=te("$ZodNanoID",(e,r)=>{r.pattern??(r.pattern=du),Be.init(e,r)}),Qu=te("$ZodCUID",(e,r)=>{r.pattern??(r.pattern=nu),Be.init(e,r)}),Ku=te("$ZodCUID2",(e,r)=>{r.pattern??(r.pattern=iu),Be.init(e,r)}),Hu=te("$ZodULID",(e,r)=>{r.pattern??(r.pattern=ou),Be.init(e,r)}),Gu=te("$ZodXID",(e,r)=>{r.pattern??(r.pattern=lu),Be.init(e,r)}),Yu=te("$ZodKSUID",(e,r)=>{r.pattern??(r.pattern=cu),Be.init(e,r)}),Xu=te("$ZodISODateTime",(e,r)=>{r.pattern??(r.pattern=ku(r)),Be.init(e,r)}),em=te("$ZodISODate",(e,r)=>{r.pattern??(r.pattern=wu),Be.init(e,r)}),tm=te("$ZodISOTime",(e,r)=>{r.pattern??(r.pattern=Nu(r)),Be.init(e,r)}),rm=te("$ZodISODuration",(e,r)=>{r.pattern??(r.pattern=uu),Be.init(e,r)}),sm=te("$ZodIPv4",(e,r)=>{r.pattern??(r.pattern=pu),Be.init(e,r),e._zod.onattach.push(s=>{const a=s._zod.bag;a.format="ipv4"})}),am=te("$ZodIPv6",(e,r)=>{r.pattern??(r.pattern=xu),Be.init(e,r),e._zod.onattach.push(s=>{const a=s._zod.bag;a.format="ipv6"}),e._zod.check=s=>{try{new URL(`http://[${s.value}]`)}catch{s.issues.push({code:"invalid_format",format:"ipv6",input:s.value,inst:e,continue:!r.abort})}}}),nm=te("$ZodCIDRv4",(e,r)=>{r.pattern??(r.pattern=yu),Be.init(e,r)}),im=te("$ZodCIDRv6",(e,r)=>{r.pattern??(r.pattern=bu),Be.init(e,r),e._zod.check=s=>{const a=s.value.split("/");try{if(a.length!==2)throw new Error;const[n,i]=a;if(!i)throw new Error;const o=Number(i);if(`${o}`!==i)throw new Error;if(o<0||o>128)throw new Error;new URL(`http://[${n}]`)}catch{s.issues.push({code:"invalid_format",format:"cidrv6",input:s.value,inst:e,continue:!r.abort})}}});function ll(e){if(e==="")return!0;if(e.length%4!==0)return!1;try{return atob(e),!0}catch{return!1}}const om=te("$ZodBase64",(e,r)=>{r.pattern??(r.pattern=_u),Be.init(e,r),e._zod.onattach.push(s=>{s._zod.bag.contentEncoding="base64"}),e._zod.check=s=>{ll(s.value)||s.issues.push({code:"invalid_format",format:"base64",input:s.value,inst:e,continue:!r.abort})}});function lm(e){if(!nl.test(e))return!1;const r=e.replace(/[-_]/g,a=>a==="-"?"+":"/"),s=r.padEnd(Math.ceil(r.length/4)*4,"=");return ll(s)}const cm=te("$ZodBase64URL",(e,r)=>{r.pattern??(r.pattern=nl),Be.init(e,r),e._zod.onattach.push(s=>{s._zod.bag.contentEncoding="base64url"}),e._zod.check=s=>{lm(s.value)||s.issues.push({code:"invalid_format",format:"base64url",input:s.value,inst:e,continue:!r.abort})}}),dm=te("$ZodE164",(e,r)=>{r.pattern??(r.pattern=ju),Be.init(e,r)});function um(e,r=null){try{const s=e.split(".");if(s.length!==3)return!1;const[a]=s;if(!a)return!1;const n=JSON.parse(atob(a));return!("typ"in n&&n?.typ!=="JWT"||!n.alg||r&&(!("alg"in n)||n.alg!==r))}catch{return!1}}const mm=te("$ZodJWT",(e,r)=>{Be.init(e,r),e._zod.check=s=>{um(s.value,r.alg)||s.issues.push({code:"invalid_format",format:"jwt",input:s.value,inst:e,continue:!r.abort})}}),hm=te("$ZodBoolean",(e,r)=>{Qe.init(e,r),e._zod.pattern=Su,e._zod.parse=(s,a)=>{if(r.coerce)try{s.value=!!s.value}catch{}const n=s.value;return typeof n=="boolean"||s.issues.push({expected:"boolean",code:"invalid_type",input:n,inst:e}),s}}),fm=te("$ZodUnknown",(e,r)=>{Qe.init(e,r),e._zod.parse=s=>s}),gm=te("$ZodNever",(e,r)=>{Qe.init(e,r),e._zod.parse=(s,a)=>(s.issues.push({expected:"never",code:"invalid_type",input:s.value,inst:e}),s)});function Hi(e,r,s){e.issues.length&&r.issues.push(...sl(s,e.issues)),r.value[s]=e.value}const pm=te("$ZodArray",(e,r)=>{Qe.init(e,r),e._zod.parse=(s,a)=>{const n=s.value;if(!Array.isArray(n))return s.issues.push({expected:"array",code:"invalid_type",input:n,inst:e}),s;s.value=Array(n.length);const i=[];for(let o=0;o<n.length;o++){const c=n[o],g=r.element._zod.run({value:c,issues:[]},a);g instanceof Promise?i.push(g.then(_=>Hi(_,s,o))):Hi(g,s,o)}return i.length?Promise.all(i).then(()=>s):s}});function ea(e,r,s,a){e.issues.length&&r.issues.push(...sl(s,e.issues)),e.value===void 0?s in a&&(r.value[s]=void 0):r.value[s]=e.value}function cl(e){const r=Object.keys(e.shape);for(const a of r)if(!e.shape?.[a]?._zod?.traits?.has("$ZodType"))throw new Error(`Invalid element at key "${a}": expected a Zod schema`);const s=Fd(e.shape);return{...e,keys:r,keySet:new Set(r),numKeys:r.length,optionalKeys:new Set(s)}}function dl(e,r,s,a,n,i){const o=[],c=n.keySet,g=n.catchall._zod,_=g.def.type;for(const y of Object.keys(r)){if(c.has(y))continue;if(_==="never"){o.push(y);continue}const D=g.run({value:r[y],issues:[]},a);D instanceof Promise?e.push(D.then(w=>ea(w,s,y,r))):ea(D,s,y,r)}return o.length&&s.issues.push({code:"unrecognized_keys",keys:o,input:r,inst:i}),e.length?Promise.all(e).then(()=>s):s}const xm=te("$ZodObject",(e,r)=>{if(Qe.init(e,r),!Object.getOwnPropertyDescriptor(r,"shape")?.get){const c=r.shape;Object.defineProperty(r,"shape",{get:()=>{const g={...c};return Object.defineProperty(r,"shape",{value:g}),g}})}const a=wn(()=>cl(r));Re(e._zod,"propValues",()=>{const c=r.shape,g={};for(const _ in c){const y=c[_]._zod;if(y.values){g[_]??(g[_]=new Set);for(const D of y.values)g[_].add(D)}}return g});const n=Xs,i=r.catchall;let o;e._zod.parse=(c,g)=>{o??(o=a.value);const _=c.value;if(!n(_))return c.issues.push({expected:"object",code:"invalid_type",input:_,inst:e}),c;c.value={};const y=[],D=o.shape;for(const w of o.keys){const P=D[w]._zod.run({value:_[w],issues:[]},g);P instanceof Promise?y.push(P.then(S=>ea(S,c,w,_))):ea(P,c,w,_)}return i?dl(y,_,c,g,a.value,e):y.length?Promise.all(y).then(()=>c):c}}),ym=te("$ZodObjectJIT",(e,r)=>{xm.init(e,r);const s=e._zod.parse,a=wn(()=>cl(r)),n=w=>{const I=new Lu(["shape","payload","ctx"]),P=a.value,S=p=>{const k=Qi(p);return`shape[${k}]._zod.run({ value: input[${k}], issues: [] }, ctx)`};I.write("const input = payload.value;");const U=Object.create(null);let O=0;for(const p of P.keys)U[p]=`key_${O++}`;I.write("const newResult = {};");for(const p of P.keys){const k=U[p],f=Qi(p);I.write(`const ${k} = ${S(p)};`),I.write(`
        if (${k}.issues.length) {
          payload.issues = payload.issues.concat(${k}.issues.map(iss => ({
            ...iss,
            path: iss.path ? [${f}, ...iss.path] : [${f}]
          })));
        }
        
        
        if (${k}.value === undefined) {
          if (${f} in input) {
            newResult[${f}] = undefined;
          }
        } else {
          newResult[${f}] = ${k}.value;
        }
        
      `)}I.write("payload.value = newResult;"),I.write("return payload;");const $=I.compile();return(p,k)=>$(w,p,k)};let i;const o=Xs,c=!el.jitless,_=c&&Md.value,y=r.catchall;let D;e._zod.parse=(w,I)=>{D??(D=a.value);const P=w.value;return o(P)?c&&_&&I?.async===!1&&I.jitless!==!0?(i||(i=n(r.shape)),w=i(w,I),y?dl([],P,w,I,D,e):w):s(w,I):(w.issues.push({expected:"object",code:"invalid_type",input:P,inst:e}),w)}});function Gi(e,r,s,a){for(const i of e)if(i.issues.length===0)return r.value=i.value,r;const n=e.filter(i=>!Ir(i));return n.length===1?(r.value=n[0].value,n[0]):(r.issues.push({code:"invalid_union",input:r.value,inst:s,errors:e.map(i=>i.issues.map(o=>jr(o,a,vr())))}),r)}const bm=te("$ZodUnion",(e,r)=>{Qe.init(e,r),Re(e._zod,"optin",()=>r.options.some(n=>n._zod.optin==="optional")?"optional":void 0),Re(e._zod,"optout",()=>r.options.some(n=>n._zod.optout==="optional")?"optional":void 0),Re(e._zod,"values",()=>{if(r.options.every(n=>n._zod.values))return new Set(r.options.flatMap(n=>Array.from(n._zod.values)))}),Re(e._zod,"pattern",()=>{if(r.options.every(n=>n._zod.pattern)){const n=r.options.map(i=>i._zod.pattern);return new RegExp(`^(${n.map(i=>kn(i.source)).join("|")})$`)}});const s=r.options.length===1,a=r.options[0]._zod.run;e._zod.parse=(n,i)=>{if(s)return a(n,i);let o=!1;const c=[];for(const g of r.options){const _=g._zod.run({value:n.value,issues:[]},i);if(_ instanceof Promise)c.push(_),o=!0;else{if(_.issues.length===0)return _;c.push(_)}}return o?Promise.all(c).then(g=>Gi(g,n,e,i)):Gi(c,n,e,i)}}),_m=te("$ZodIntersection",(e,r)=>{Qe.init(e,r),e._zod.parse=(s,a)=>{const n=s.value,i=r.left._zod.run({value:n,issues:[]},a),o=r.right._zod.run({value:n,issues:[]},a);return i instanceof Promise||o instanceof Promise?Promise.all([i,o]).then(([g,_])=>Yi(s,g,_)):Yi(s,i,o)}});function nn(e,r){if(e===r)return{valid:!0,data:e};if(e instanceof Date&&r instanceof Date&&+e==+r)return{valid:!0,data:e};if(cs(e)&&cs(r)){const s=Object.keys(r),a=Object.keys(e).filter(i=>s.indexOf(i)!==-1),n={...e,...r};for(const i of a){const o=nn(e[i],r[i]);if(!o.valid)return{valid:!1,mergeErrorPath:[i,...o.mergeErrorPath]};n[i]=o.data}return{valid:!0,data:n}}if(Array.isArray(e)&&Array.isArray(r)){if(e.length!==r.length)return{valid:!1,mergeErrorPath:[]};const s=[];for(let a=0;a<e.length;a++){const n=e[a],i=r[a],o=nn(n,i);if(!o.valid)return{valid:!1,mergeErrorPath:[a,...o.mergeErrorPath]};s.push(o.data)}return{valid:!0,data:s}}return{valid:!1,mergeErrorPath:[]}}function Yi(e,r,s){if(r.issues.length&&e.issues.push(...r.issues),s.issues.length&&e.issues.push(...s.issues),Ir(e))return e;const a=nn(r.value,s.value);if(!a.valid)throw new Error(`Unmergable intersection. Error path: ${JSON.stringify(a.mergeErrorPath)}`);return e.value=a.data,e}const vm=te("$ZodEnum",(e,r)=>{Qe.init(e,r);const s=$d(r.entries),a=new Set(s);e._zod.values=a,e._zod.pattern=new RegExp(`^(${s.filter(n=>Td.has(typeof n)).map(n=>typeof n=="string"?aa(n):n.toString()).join("|")})$`),e._zod.parse=(n,i)=>{const o=n.value;return a.has(o)||n.issues.push({code:"invalid_value",values:s,input:o,inst:e}),n}}),jm=te("$ZodTransform",(e,r)=>{Qe.init(e,r),e._zod.parse=(s,a)=>{if(a.direction==="backward")throw new Xo(e.constructor.name);const n=r.transform(s.value,s);if(a.async)return(n instanceof Promise?n:Promise.resolve(n)).then(o=>(s.value=o,s));if(n instanceof Promise)throw new $r;return s.value=n,s}});function Xi(e,r){return e.issues.length&&r===void 0?{issues:[],value:void 0}:e}const wm=te("$ZodOptional",(e,r)=>{Qe.init(e,r),e._zod.optin="optional",e._zod.optout="optional",Re(e._zod,"values",()=>r.innerType._zod.values?new Set([...r.innerType._zod.values,void 0]):void 0),Re(e._zod,"pattern",()=>{const s=r.innerType._zod.pattern;return s?new RegExp(`^(${kn(s.source)})?$`):void 0}),e._zod.parse=(s,a)=>{if(r.innerType._zod.optin==="optional"){const n=r.innerType._zod.run(s,a);return n instanceof Promise?n.then(i=>Xi(i,s.value)):Xi(n,s.value)}return s.value===void 0?s:r.innerType._zod.run(s,a)}}),Nm=te("$ZodNullable",(e,r)=>{Qe.init(e,r),Re(e._zod,"optin",()=>r.innerType._zod.optin),Re(e._zod,"optout",()=>r.innerType._zod.optout),Re(e._zod,"pattern",()=>{const s=r.innerType._zod.pattern;return s?new RegExp(`^(${kn(s.source)}|null)$`):void 0}),Re(e._zod,"values",()=>r.innerType._zod.values?new Set([...r.innerType._zod.values,null]):void 0),e._zod.parse=(s,a)=>s.value===null?s:r.innerType._zod.run(s,a)}),km=te("$ZodDefault",(e,r)=>{Qe.init(e,r),e._zod.optin="optional",Re(e._zod,"values",()=>r.innerType._zod.values),e._zod.parse=(s,a)=>{if(a.direction==="backward")return r.innerType._zod.run(s,a);if(s.value===void 0)return s.value=r.defaultValue,s;const n=r.innerType._zod.run(s,a);return n instanceof Promise?n.then(i=>eo(i,r)):eo(n,r)}});function eo(e,r){return e.value===void 0&&(e.value=r.defaultValue),e}const Cm=te("$ZodPrefault",(e,r)=>{Qe.init(e,r),e._zod.optin="optional",Re(e._zod,"values",()=>r.innerType._zod.values),e._zod.parse=(s,a)=>(a.direction==="backward"||s.value===void 0&&(s.value=r.defaultValue),r.innerType._zod.run(s,a))}),Sm=te("$ZodNonOptional",(e,r)=>{Qe.init(e,r),Re(e._zod,"values",()=>{const s=r.innerType._zod.values;return s?new Set([...s].filter(a=>a!==void 0)):void 0}),e._zod.parse=(s,a)=>{const n=r.innerType._zod.run(s,a);return n instanceof Promise?n.then(i=>to(i,e)):to(n,e)}});function to(e,r){return!e.issues.length&&e.value===void 0&&e.issues.push({code:"invalid_type",expected:"nonoptional",input:e.value,inst:r}),e}const Am=te("$ZodCatch",(e,r)=>{Qe.init(e,r),Re(e._zod,"optin",()=>r.innerType._zod.optin),Re(e._zod,"optout",()=>r.innerType._zod.optout),Re(e._zod,"values",()=>r.innerType._zod.values),e._zod.parse=(s,a)=>{if(a.direction==="backward")return r.innerType._zod.run(s,a);const n=r.innerType._zod.run(s,a);return n instanceof Promise?n.then(i=>(s.value=i.value,i.issues.length&&(s.value=r.catchValue({...s,error:{issues:i.issues.map(o=>jr(o,a,vr()))},input:s.value}),s.issues=[]),s)):(s.value=n.value,n.issues.length&&(s.value=r.catchValue({...s,error:{issues:n.issues.map(i=>jr(i,a,vr()))},input:s.value}),s.issues=[]),s)}}),Dm=te("$ZodPipe",(e,r)=>{Qe.init(e,r),Re(e._zod,"values",()=>r.in._zod.values),Re(e._zod,"optin",()=>r.in._zod.optin),Re(e._zod,"optout",()=>r.out._zod.optout),Re(e._zod,"propValues",()=>r.in._zod.propValues),e._zod.parse=(s,a)=>{if(a.direction==="backward"){const i=r.out._zod.run(s,a);return i instanceof Promise?i.then(o=>Bs(o,r.in,a)):Bs(i,r.in,a)}const n=r.in._zod.run(s,a);return n instanceof Promise?n.then(i=>Bs(i,r.out,a)):Bs(n,r.out,a)}});function Bs(e,r,s){return e.issues.length?(e.aborted=!0,e):r._zod.run({value:e.value,issues:e.issues},s)}const Em=te("$ZodReadonly",(e,r)=>{Qe.init(e,r),Re(e._zod,"propValues",()=>r.innerType._zod.propValues),Re(e._zod,"values",()=>r.innerType._zod.values),Re(e._zod,"optin",()=>r.innerType._zod.optin),Re(e._zod,"optout",()=>r.innerType._zod.optout),e._zod.parse=(s,a)=>{if(a.direction==="backward")return r.innerType._zod.run(s,a);const n=r.innerType._zod.run(s,a);return n instanceof Promise?n.then(ro):ro(n)}});function ro(e){return e.value=Object.freeze(e.value),e}const zm=te("$ZodCustom",(e,r)=>{Jt.init(e,r),Qe.init(e,r),e._zod.parse=(s,a)=>s,e._zod.check=s=>{const a=s.value,n=r.fn(a);if(n instanceof Promise)return n.then(i=>so(i,s,a,e));so(n,s,a,e)}});function so(e,r,s,a){if(!e){const n={code:"custom",input:s,inst:a,path:[...a._zod.def.path??[]],continue:!a._zod.def.abort};a._zod.def.params&&(n.params=a._zod.def.params),r.issues.push(ds(n))}}class Pm{constructor(){this._map=new WeakMap,this._idmap=new Map}add(r,...s){const a=s[0];if(this._map.set(r,a),a&&typeof a=="object"&&"id"in a){if(this._idmap.has(a.id))throw new Error(`ID ${a.id} already exists in the registry`);this._idmap.set(a.id,r)}return this}clear(){return this._map=new WeakMap,this._idmap=new Map,this}remove(r){const s=this._map.get(r);return s&&typeof s=="object"&&"id"in s&&this._idmap.delete(s.id),this._map.delete(r),this}get(r){const s=r._zod.parent;if(s){const a={...this.get(s)??{}};delete a.id;const n={...a,...this._map.get(r)};return Object.keys(n).length?n:void 0}return this._map.get(r)}has(r){return this._map.has(r)}}function Im(){return new Pm}const Us=Im();function $m(e,r){return new e({type:"string",...ve(r)})}function Mm(e,r){return new e({type:"string",format:"email",check:"string_format",abort:!1,...ve(r)})}function ao(e,r){return new e({type:"string",format:"guid",check:"string_format",abort:!1,...ve(r)})}function Tm(e,r){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,...ve(r)})}function Fm(e,r){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v4",...ve(r)})}function Rm(e,r){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v6",...ve(r)})}function Om(e,r){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v7",...ve(r)})}function Lm(e,r){return new e({type:"string",format:"url",check:"string_format",abort:!1,...ve(r)})}function Bm(e,r){return new e({type:"string",format:"emoji",check:"string_format",abort:!1,...ve(r)})}function Um(e,r){return new e({type:"string",format:"nanoid",check:"string_format",abort:!1,...ve(r)})}function Vm(e,r){return new e({type:"string",format:"cuid",check:"string_format",abort:!1,...ve(r)})}function Zm(e,r){return new e({type:"string",format:"cuid2",check:"string_format",abort:!1,...ve(r)})}function Wm(e,r){return new e({type:"string",format:"ulid",check:"string_format",abort:!1,...ve(r)})}function qm(e,r){return new e({type:"string",format:"xid",check:"string_format",abort:!1,...ve(r)})}function Jm(e,r){return new e({type:"string",format:"ksuid",check:"string_format",abort:!1,...ve(r)})}function Qm(e,r){return new e({type:"string",format:"ipv4",check:"string_format",abort:!1,...ve(r)})}function Km(e,r){return new e({type:"string",format:"ipv6",check:"string_format",abort:!1,...ve(r)})}function Hm(e,r){return new e({type:"string",format:"cidrv4",check:"string_format",abort:!1,...ve(r)})}function Gm(e,r){return new e({type:"string",format:"cidrv6",check:"string_format",abort:!1,...ve(r)})}function Ym(e,r){return new e({type:"string",format:"base64",check:"string_format",abort:!1,...ve(r)})}function Xm(e,r){return new e({type:"string",format:"base64url",check:"string_format",abort:!1,...ve(r)})}function eh(e,r){return new e({type:"string",format:"e164",check:"string_format",abort:!1,...ve(r)})}function th(e,r){return new e({type:"string",format:"jwt",check:"string_format",abort:!1,...ve(r)})}function rh(e,r){return new e({type:"string",format:"datetime",check:"string_format",offset:!1,local:!1,precision:null,...ve(r)})}function sh(e,r){return new e({type:"string",format:"date",check:"string_format",...ve(r)})}function ah(e,r){return new e({type:"string",format:"time",check:"string_format",precision:null,...ve(r)})}function nh(e,r){return new e({type:"string",format:"duration",check:"string_format",...ve(r)})}function ih(e,r){return new e({type:"boolean",...ve(r)})}function oh(e){return new e({type:"unknown"})}function lh(e,r){return new e({type:"never",...ve(r)})}function ul(e,r){return new Eu({check:"max_length",...ve(r),maximum:e})}function ta(e,r){return new zu({check:"min_length",...ve(r),minimum:e})}function ml(e,r){return new Pu({check:"length_equals",...ve(r),length:e})}function ch(e,r){return new Iu({check:"string_format",format:"regex",...ve(r),pattern:e})}function dh(e){return new $u({check:"string_format",format:"lowercase",...ve(e)})}function uh(e){return new Mu({check:"string_format",format:"uppercase",...ve(e)})}function mh(e,r){return new Tu({check:"string_format",format:"includes",...ve(r),includes:e})}function hh(e,r){return new Fu({check:"string_format",format:"starts_with",...ve(r),prefix:e})}function fh(e,r){return new Ru({check:"string_format",format:"ends_with",...ve(r),suffix:e})}function hs(e){return new Ou({check:"overwrite",tx:e})}function gh(e){return hs(r=>r.normalize(e))}function ph(){return hs(e=>e.trim())}function xh(){return hs(e=>e.toLowerCase())}function yh(){return hs(e=>e.toUpperCase())}function bh(e,r,s){return new e({type:"array",element:r,...ve(s)})}function _h(e,r,s){return new e({type:"custom",check:"custom",fn:r,...ve(s)})}function vh(e){const r=jh(s=>(s.addIssue=a=>{if(typeof a=="string")s.issues.push(ds(a,s.value,r._zod.def));else{const n=a;n.fatal&&(n.continue=!1),n.code??(n.code="custom"),n.input??(n.input=s.value),n.inst??(n.inst=r),n.continue??(n.continue=!r._zod.def.abort),s.issues.push(ds(n))}},e(s.value,s)));return r}function jh(e,r){const s=new Jt({check:"custom",...ve(r)});return s._zod.check=e,s}function no(e,r){try{var s=e()}catch(a){return r(a)}return s&&s.then?s.then(void 0,r):s}function wh(e,r){for(var s={};e.length;){var a=e[0],n=a.code,i=a.message,o=a.path.join(".");if(!s[o])if("unionErrors"in a){var c=a.unionErrors[0].errors[0];s[o]={message:c.message,type:c.code}}else s[o]={message:i,type:n};if("unionErrors"in a&&a.unionErrors.forEach(function(y){return y.errors.forEach(function(D){return e.push(D)})}),r){var g=s[o].types,_=g&&g[a.code];s[o]=_n(o,r,s,n,_?[].concat(_,a.message):a.message)}e.shift()}return s}function Nh(e,r){for(var s={};e.length;){var a=e[0],n=a.code,i=a.message,o=a.path.join(".");if(!s[o])if(a.code==="invalid_union"&&a.errors.length>0){var c=a.errors[0][0];s[o]={message:c.message,type:c.code}}else s[o]={message:i,type:n};if(a.code==="invalid_union"&&a.errors.forEach(function(y){return y.forEach(function(D){return e.push(D)})}),r){var g=s[o].types,_=g&&g[a.code];s[o]=_n(o,r,s,n,_?[].concat(_,a.message):a.message)}e.shift()}return s}function yt(e,r,s){if(s===void 0&&(s={}),(function(a){return"_def"in a&&typeof a._def=="object"&&"typeName"in a._def})(e))return function(a,n,i){try{return Promise.resolve(no(function(){return Promise.resolve(e[s.mode==="sync"?"parse":"parseAsync"](a,r)).then(function(o){return i.shouldUseNativeValidation&&sn({},i),{errors:{},values:s.raw?Object.assign({},a):o}})},function(o){if((function(c){return Array.isArray(c?.issues)})(o))return{values:{},errors:Wi(wh(o.errors,!i.shouldUseNativeValidation&&i.criteriaMode==="all"),i)};throw o}))}catch(o){return Promise.reject(o)}};if((function(a){return"_zod"in a&&typeof a._zod=="object"})(e))return function(a,n,i){try{return Promise.resolve(no(function(){return Promise.resolve((s.mode==="sync"?Jd:Qd)(e,a,r)).then(function(o){return i.shouldUseNativeValidation&&sn({},i),{errors:{},values:s.raw?Object.assign({},a):o}})},function(o){if((function(c){return c instanceof Sn})(o))return{values:{},errors:Wi(Nh(o.issues,!i.shouldUseNativeValidation&&i.criteriaMode==="all"),i)};throw o}))}catch(o){return Promise.reject(o)}};throw new Error("Invalid input: not a Zod schema")}const kh=te("ZodISODateTime",(e,r)=>{Xu.init(e,r),Ue.init(e,r)});function Ch(e){return rh(kh,e)}const Sh=te("ZodISODate",(e,r)=>{em.init(e,r),Ue.init(e,r)});function Ah(e){return sh(Sh,e)}const Dh=te("ZodISOTime",(e,r)=>{tm.init(e,r),Ue.init(e,r)});function Eh(e){return ah(Dh,e)}const zh=te("ZodISODuration",(e,r)=>{rm.init(e,r),Ue.init(e,r)});function Ph(e){return nh(zh,e)}const Ih=(e,r)=>{Sn.init(e,r),e.name="ZodError",Object.defineProperties(e,{format:{value:s=>qd(e,s)},flatten:{value:s=>Wd(e,s)},addIssue:{value:s=>{e.issues.push(s),e.message=JSON.stringify(e.issues,an,2)}},addIssues:{value:s=>{e.issues.push(...s),e.message=JSON.stringify(e.issues,an,2)}},isEmpty:{get(){return e.issues.length===0}}})},zt=te("ZodError",Ih,{Parent:Error}),$h=ia(zt),Mh=oa(zt),Th=la(zt),Fh=ca(zt),Rh=Gd(zt),Oh=Yd(zt),Lh=Xd(zt),Bh=eu(zt),Uh=tu(zt),Vh=ru(zt),Zh=su(zt),Wh=au(zt),Ge=te("ZodType",(e,r)=>(Qe.init(e,r),e.def=r,e.type=r.type,Object.defineProperty(e,"_def",{value:r}),e.check=(...s)=>e.clone(Nr(r,{checks:[...r.checks??[],...s.map(a=>typeof a=="function"?{_zod:{check:a,def:{check:"custom"},onattach:[]}}:a)]})),e.clone=(s,a)=>dr(e,s,a),e.brand=()=>e,e.register=((s,a)=>(s.add(e,a),e)),e.parse=(s,a)=>$h(e,s,a,{callee:e.parse}),e.safeParse=(s,a)=>Th(e,s,a),e.parseAsync=async(s,a)=>Mh(e,s,a,{callee:e.parseAsync}),e.safeParseAsync=async(s,a)=>Fh(e,s,a),e.spa=e.safeParseAsync,e.encode=(s,a)=>Rh(e,s,a),e.decode=(s,a)=>Oh(e,s,a),e.encodeAsync=async(s,a)=>Lh(e,s,a),e.decodeAsync=async(s,a)=>Bh(e,s,a),e.safeEncode=(s,a)=>Uh(e,s,a),e.safeDecode=(s,a)=>Vh(e,s,a),e.safeEncodeAsync=async(s,a)=>Zh(e,s,a),e.safeDecodeAsync=async(s,a)=>Wh(e,s,a),e.refine=(s,a)=>e.check(Tf(s,a)),e.superRefine=s=>e.check(Ff(s)),e.overwrite=s=>e.check(hs(s)),e.optional=()=>lo(e),e.nullable=()=>co(e),e.nullish=()=>lo(co(e)),e.nonoptional=s=>Df(e,s),e.array=()=>Qs(e),e.or=s=>bf([e,s]),e.and=s=>vf(e,s),e.transform=s=>uo(e,wf(s)),e.default=s=>Cf(e,s),e.prefault=s=>Af(e,s),e.catch=s=>zf(e,s),e.pipe=s=>uo(e,s),e.readonly=()=>$f(e),e.describe=s=>{const a=e.clone();return Us.add(a,{description:s}),a},Object.defineProperty(e,"description",{get(){return Us.get(e)?.description},configurable:!0}),e.meta=(...s)=>{if(s.length===0)return Us.get(e);const a=e.clone();return Us.add(a,s[0]),a},e.isOptional=()=>e.safeParse(void 0).success,e.isNullable=()=>e.safeParse(null).success,e)),hl=te("_ZodString",(e,r)=>{An.init(e,r),Ge.init(e,r);const s=e._zod.bag;e.format=s.format??null,e.minLength=s.minimum??null,e.maxLength=s.maximum??null,e.regex=(...a)=>e.check(ch(...a)),e.includes=(...a)=>e.check(mh(...a)),e.startsWith=(...a)=>e.check(hh(...a)),e.endsWith=(...a)=>e.check(fh(...a)),e.min=(...a)=>e.check(ta(...a)),e.max=(...a)=>e.check(ul(...a)),e.length=(...a)=>e.check(ml(...a)),e.nonempty=(...a)=>e.check(ta(1,...a)),e.lowercase=a=>e.check(dh(a)),e.uppercase=a=>e.check(uh(a)),e.trim=()=>e.check(ph()),e.normalize=(...a)=>e.check(gh(...a)),e.toLowerCase=()=>e.check(xh()),e.toUpperCase=()=>e.check(yh())}),qh=te("ZodString",(e,r)=>{An.init(e,r),hl.init(e,r),e.email=s=>e.check(Mm(Jh,s)),e.url=s=>e.check(Lm(Qh,s)),e.jwt=s=>e.check(th(df,s)),e.emoji=s=>e.check(Bm(Kh,s)),e.guid=s=>e.check(ao(io,s)),e.uuid=s=>e.check(Tm(Vs,s)),e.uuidv4=s=>e.check(Fm(Vs,s)),e.uuidv6=s=>e.check(Rm(Vs,s)),e.uuidv7=s=>e.check(Om(Vs,s)),e.nanoid=s=>e.check(Um(Hh,s)),e.guid=s=>e.check(ao(io,s)),e.cuid=s=>e.check(Vm(Gh,s)),e.cuid2=s=>e.check(Zm(Yh,s)),e.ulid=s=>e.check(Wm(Xh,s)),e.base64=s=>e.check(Ym(of,s)),e.base64url=s=>e.check(Xm(lf,s)),e.xid=s=>e.check(qm(ef,s)),e.ksuid=s=>e.check(Jm(tf,s)),e.ipv4=s=>e.check(Qm(rf,s)),e.ipv6=s=>e.check(Km(sf,s)),e.cidrv4=s=>e.check(Hm(af,s)),e.cidrv6=s=>e.check(Gm(nf,s)),e.e164=s=>e.check(eh(cf,s)),e.datetime=s=>e.check(Ch(s)),e.date=s=>e.check(Ah(s)),e.time=s=>e.check(Eh(s)),e.duration=s=>e.check(Ph(s))});function ke(e){return $m(qh,e)}const Ue=te("ZodStringFormat",(e,r)=>{Be.init(e,r),hl.init(e,r)}),Jh=te("ZodEmail",(e,r)=>{Zu.init(e,r),Ue.init(e,r)}),io=te("ZodGUID",(e,r)=>{Uu.init(e,r),Ue.init(e,r)}),Vs=te("ZodUUID",(e,r)=>{Vu.init(e,r),Ue.init(e,r)}),Qh=te("ZodURL",(e,r)=>{Wu.init(e,r),Ue.init(e,r)}),Kh=te("ZodEmoji",(e,r)=>{qu.init(e,r),Ue.init(e,r)}),Hh=te("ZodNanoID",(e,r)=>{Ju.init(e,r),Ue.init(e,r)}),Gh=te("ZodCUID",(e,r)=>{Qu.init(e,r),Ue.init(e,r)}),Yh=te("ZodCUID2",(e,r)=>{Ku.init(e,r),Ue.init(e,r)}),Xh=te("ZodULID",(e,r)=>{Hu.init(e,r),Ue.init(e,r)}),ef=te("ZodXID",(e,r)=>{Gu.init(e,r),Ue.init(e,r)}),tf=te("ZodKSUID",(e,r)=>{Yu.init(e,r),Ue.init(e,r)}),rf=te("ZodIPv4",(e,r)=>{sm.init(e,r),Ue.init(e,r)}),sf=te("ZodIPv6",(e,r)=>{am.init(e,r),Ue.init(e,r)}),af=te("ZodCIDRv4",(e,r)=>{nm.init(e,r),Ue.init(e,r)}),nf=te("ZodCIDRv6",(e,r)=>{im.init(e,r),Ue.init(e,r)}),of=te("ZodBase64",(e,r)=>{om.init(e,r),Ue.init(e,r)}),lf=te("ZodBase64URL",(e,r)=>{cm.init(e,r),Ue.init(e,r)}),cf=te("ZodE164",(e,r)=>{dm.init(e,r),Ue.init(e,r)}),df=te("ZodJWT",(e,r)=>{mm.init(e,r),Ue.init(e,r)}),uf=te("ZodBoolean",(e,r)=>{hm.init(e,r),Ge.init(e,r)});function mf(e){return ih(uf,e)}const hf=te("ZodUnknown",(e,r)=>{fm.init(e,r),Ge.init(e,r)});function oo(){return oh(hf)}const ff=te("ZodNever",(e,r)=>{gm.init(e,r),Ge.init(e,r)});function gf(e){return lh(ff,e)}const pf=te("ZodArray",(e,r)=>{pm.init(e,r),Ge.init(e,r),e.element=r.element,e.min=(s,a)=>e.check(ta(s,a)),e.nonempty=s=>e.check(ta(1,s)),e.max=(s,a)=>e.check(ul(s,a)),e.length=(s,a)=>e.check(ml(s,a)),e.unwrap=()=>e.element});function Qs(e,r){return bh(pf,e,r)}const xf=te("ZodObject",(e,r)=>{ym.init(e,r),Ge.init(e,r),Re(e,"shape",()=>r.shape),e.keyof=()=>ln(Object.keys(e._zod.def.shape)),e.catchall=s=>e.clone({...e._zod.def,catchall:s}),e.passthrough=()=>e.clone({...e._zod.def,catchall:oo()}),e.loose=()=>e.clone({...e._zod.def,catchall:oo()}),e.strict=()=>e.clone({...e._zod.def,catchall:gf()}),e.strip=()=>e.clone({...e._zod.def,catchall:void 0}),e.extend=s=>Ld(e,s),e.safeExtend=s=>Bd(e,s),e.merge=s=>Ud(e,s),e.pick=s=>Rd(e,s),e.omit=s=>Od(e,s),e.partial=(...s)=>Vd(fl,e,s[0]),e.required=(...s)=>Zd(gl,e,s[0])});function bt(e,r){const s={type:"object",shape:e??{},...ve(r)};return new xf(s)}const yf=te("ZodUnion",(e,r)=>{bm.init(e,r),Ge.init(e,r),e.options=r.options});function bf(e,r){return new yf({type:"union",options:e,...ve(r)})}const _f=te("ZodIntersection",(e,r)=>{_m.init(e,r),Ge.init(e,r)});function vf(e,r){return new _f({type:"intersection",left:e,right:r})}const on=te("ZodEnum",(e,r)=>{vm.init(e,r),Ge.init(e,r),e.enum=r.entries,e.options=Object.values(r.entries);const s=new Set(Object.keys(r.entries));e.extract=(a,n)=>{const i={};for(const o of a)if(s.has(o))i[o]=r.entries[o];else throw new Error(`Key ${o} not found in enum`);return new on({...r,checks:[],...ve(n),entries:i})},e.exclude=(a,n)=>{const i={...r.entries};for(const o of a)if(s.has(o))delete i[o];else throw new Error(`Key ${o} not found in enum`);return new on({...r,checks:[],...ve(n),entries:i})}});function ln(e,r){const s=Array.isArray(e)?Object.fromEntries(e.map(a=>[a,a])):e;return new on({type:"enum",entries:s,...ve(r)})}const jf=te("ZodTransform",(e,r)=>{jm.init(e,r),Ge.init(e,r),e._zod.parse=(s,a)=>{if(a.direction==="backward")throw new Xo(e.constructor.name);s.addIssue=i=>{if(typeof i=="string")s.issues.push(ds(i,s.value,r));else{const o=i;o.fatal&&(o.continue=!1),o.code??(o.code="custom"),o.input??(o.input=s.value),o.inst??(o.inst=e),s.issues.push(ds(o))}};const n=r.transform(s.value,s);return n instanceof Promise?n.then(i=>(s.value=i,s)):(s.value=n,s)}});function wf(e){return new jf({type:"transform",transform:e})}const fl=te("ZodOptional",(e,r)=>{wm.init(e,r),Ge.init(e,r),e.unwrap=()=>e._zod.def.innerType});function lo(e){return new fl({type:"optional",innerType:e})}const Nf=te("ZodNullable",(e,r)=>{Nm.init(e,r),Ge.init(e,r),e.unwrap=()=>e._zod.def.innerType});function co(e){return new Nf({type:"nullable",innerType:e})}const kf=te("ZodDefault",(e,r)=>{km.init(e,r),Ge.init(e,r),e.unwrap=()=>e._zod.def.innerType,e.removeDefault=e.unwrap});function Cf(e,r){return new kf({type:"default",innerType:e,get defaultValue(){return typeof r=="function"?r():rl(r)}})}const Sf=te("ZodPrefault",(e,r)=>{Cm.init(e,r),Ge.init(e,r),e.unwrap=()=>e._zod.def.innerType});function Af(e,r){return new Sf({type:"prefault",innerType:e,get defaultValue(){return typeof r=="function"?r():rl(r)}})}const gl=te("ZodNonOptional",(e,r)=>{Sm.init(e,r),Ge.init(e,r),e.unwrap=()=>e._zod.def.innerType});function Df(e,r){return new gl({type:"nonoptional",innerType:e,...ve(r)})}const Ef=te("ZodCatch",(e,r)=>{Am.init(e,r),Ge.init(e,r),e.unwrap=()=>e._zod.def.innerType,e.removeCatch=e.unwrap});function zf(e,r){return new Ef({type:"catch",innerType:e,catchValue:typeof r=="function"?r:()=>r})}const Pf=te("ZodPipe",(e,r)=>{Dm.init(e,r),Ge.init(e,r),e.in=r.in,e.out=r.out});function uo(e,r){return new Pf({type:"pipe",in:e,out:r})}const If=te("ZodReadonly",(e,r)=>{Em.init(e,r),Ge.init(e,r),e.unwrap=()=>e._zod.def.innerType});function $f(e){return new If({type:"readonly",innerType:e})}const Mf=te("ZodCustom",(e,r)=>{zm.init(e,r),Ge.init(e,r)});function Tf(e,r={}){return _h(Mf,e,r)}function Ff(e){return vh(e)}function Rf(){return"https://supabase.healapp.ru"}function Of(){const e=Rf();return e.includes(":54327")?e.replace(":54327",":54325"):e.replace(/\/$/,"")}function fs(e){return`${Of().replace(/\/$/,"")}/functions/v1/${e}`}const Lf=bt({email:ke().email("Некорректный email адрес"),password:ke().min(6,"Пароль должен содержать минимум 6 символов"),confirmPassword:ke()}).refine(e=>e.password===e.confirmPassword,{message:"Пароли не совпадают",path:["confirmPassword"]}),Bf=bt({phone:ke().min(10,"Введите номер телефона"),password:ke().min(6,"Пароль должен содержать минимум 6 символов"),confirmPassword:ke().min(1,"Подтвердите пароль")}).refine(e=>e.password===e.confirmPassword,{message:"Пароли не совпадают",path:["confirmPassword"]}),Uf={admin:"Администратор",manager:"Руководитель",caregiver:"Сиделка",doctor:"Врач"},Vf=e=>{let r=e.trim().replace(/\s+/g,"");return r?(r=r.replace(/[^\d+]/g,""),r.startsWith("+")?r:r.startsWith("8")?`+7${r.slice(1)}`:r.startsWith("7")?`+${r}`:r.startsWith("7")?r:`+7${r}`):""},Zf=()=>{const e=rt(),r=Rr(),[s]=Fr(),a=s.get("token"),n=s.get("org_token"),i=s.get("client_token"),o=s.get("diary"),c=!!a,g=!!n;if(u.useEffect(()=>{if(!i)return;const E=new URLSearchParams;E.set("token",i),o&&E.set("diary",o),e(`/client-invite?${E.toString()}`,{replace:!0})},[i,o,e]),i)return null;const[_,y]=u.useState(null),[D,w]=u.useState(c?null:!1),[I,P]=u.useState(!1),[S,U]=u.useState(null),[O,$]=u.useState(null),[p,k]=u.useState(g?"checking":"form"),[f,x]=u.useState(null),{register:R,handleSubmit:G,formState:{errors:M}}=xt({resolver:yt(Lf)}),{register:L,handleSubmit:B,formState:{errors:Z}}=xt({resolver:yt(Bf)});u.useEffect(()=>{if(i)return;if(!c&&!g){w(!1),U("Регистрация доступна только по пригласительной ссылке");return}(async()=>{try{w(!0)}catch{w(!1),U("Недействительный токен приглашения")}})()},[i,c,a]),u.useEffect(()=>{if(!g||i||!n)return;k("checking"),$(null),(async()=>{try{const{data:T,error:J}=await F.from("invite_tokens").select(`
            id,
            token,
            invite_type,
            expires_at,
            used_at,
            revoked_at,
            organization_invite_tokens (
              organization_id,
              organization_type,
              employee_role
            )
          `).eq("token",n).eq("invite_type","organization_employee").is("revoked_at",null).single();if(J||!T){k("invalid"),$("Пригласительная ссылка недействительна или была удалена.");return}if(T.used_at){k("invalid"),$("Эта пригласительная ссылка уже была использована.");return}if(T.expires_at&&new Date(T.expires_at)<new Date){k("invalid"),$("Срок действия пригласительной ссылки истек.");return}const W=Array.isArray(T.organization_invite_tokens)?T.organization_invite_tokens[0]:T.organization_invite_tokens;x({token:T.token,organization_id:W?.organization_id,organization_type:W?.organization_type,role:W?.employee_role}),k("form")}catch(T){console.error("Ошибка проверки пригласительной ссылки сотрудника",T),k("invalid"),$("Не удалось проверить пригласительную ссылку. Попробуйте позже.")}})()},[g,n,i]);const j=async E=>{if(!a){U("Регистрация доступна только по пригласительной ссылке");return}if(!_){U("Выберите тип организации");return}P(!0),U(null);try{const{data:T,error:J}=await F.auth.signUp({email:E.email,password:E.password,options:{data:{organization_type:_,invite_token:a||void 0}}});if(J)throw J;if(T.user){const{setUser:W,setSession:h}=Ae.getState();if(T.session&&(W(T.user),h(T.session),await F.auth.setSession({access_token:T.session.access_token,refresh_token:T.session.refresh_token})),a){console.log("[RegisterPage] Помечаем токен как использованный:",{token:a,userId:T.user.id});try{const{data:C,error:Y}=await F.rpc("mark_invite_token_used",{p_token:a,p_user_id:T.user.id});Y?console.error("[RegisterPage] Ошибка пометки токена как использованного:",Y):C?console.log("[RegisterPage] ✅ Токен успешно помечен как использованный"):console.warn("[RegisterPage] ⚠️ Токен не найден или уже использован:",a)}catch(C){console.error("[RegisterPage] Ошибка при пометке токена:",C)}}else console.log("[RegisterPage] Регистрация без токена приглашения");try{const C="organization",{error:Y}=await F.rpc("create_user_profile",{p_role:C});Y?console.error("Ошибка создания user_profiles через RPC:",Y):console.log("✅ user_profiles создан с ролью:",C)}catch(C){console.error("Ошибка создания user_profiles:",C)}if(T.user.email_confirmed_at){try{const{data:C,error:Y}=await F.rpc("process_pending_diary_access",{p_user_id:T.user.id});!Y&&C?.success_count>0&&(console.log("[RegisterPage] Обработано pending токенов:",C.success_count),await r.invalidateQueries({queryKey:["dashboard-diaries"]}))}catch(C){console.error("[RegisterPage] Ошибка обработки pending токенов:",C)}e("/profile/setup")}else e(`/email-confirmation?email=${encodeURIComponent(T.user.email||"")}`)}}catch(T){U(T.message||"Ошибка при регистрации. Попробуйте ещё раз.")}finally{P(!1)}},v=async E=>{if(!(!g||!n||!f)){P(!0),$(null);try{const T=Vf(E.phone);if(!T){$("Введите корректный номер телефона"),P(!1);return}const J="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyAgCiAgICAicm9sZSI6ICJhbm9uIiwKICAgICJpc3MiOiAic3VwYWJhc2UtZGVtbyIsCiAgICAiaWF0IjogMTY0MTc2OTIwMCwKICAgICJleHAiOiAxNzk5NTM1NjAwCn0.dc_X5iR_VP_qT0zsiyj_I_OZ2T9FtRU2BBNWN8Bu4GE",W=fs("accept-invite");console.log("Calling Edge Function:",W);const h=await fetch(W,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${J}`,apikey:J},body:JSON.stringify({token:n,password:E.password,phone:T,firstName:"",lastName:""})});if(!h.ok){const ce=await h.text();console.error("Edge Function error:",h.status,ce);let me="Не удалось завершить регистрацию. Попробуйте ещё раз.";try{const _e=JSON.parse(ce);me=_e.message||_e.error||me}catch{me=ce||me}throw h.status===409&&(me="Пользователь с этим телефоном уже зарегистрирован. Используйте правильный пароль для входа или обратитесь к администратору."),new Error(me)}const C=await h.json();if(!C?.data)throw new Error("Не удалось получить данные после регистрации. Попробуйте войти вручную.");if(C.data.loginEmail&&!C.data.session)try{const{data:ce,error:me}=await F.auth.signInWithPassword({email:C.data.loginEmail,password:E.password});if(me||!ce.session)throw new Error("Не удалось войти. Проверьте пароль или обратитесь к администратору.");const{setUser:_e,setSession:De,setLoading:xe}=Ae.getState();_e(ce.user),De(ce.session),xe(!1),Ae.setState({isAuthenticated:!0}),e("/profile/setup");return}catch(ce){throw new Error(ce.message||"Не удалось войти. Попробуйте войти вручную.")}if(!C?.data?.session)throw new Error("Не удалось получить сессию после регистрации. Попробуйте войти вручную.");const{error:Y}=await F.auth.setSession({access_token:C.data.session.access_token,refresh_token:C.data.session.refresh_token});if(console.log("Session set, sessionError:",Y),Y)throw console.error("Ошибка установки сессии:",Y),new Error("Не удалось установить сессию. Попробуйте войти вручную.");const{data:{user:ee},error:ae}=await F.auth.getUser(),{data:{session:ne}}=await F.auth.getSession();if(ae||!ee)throw console.error("Ошибка получения пользователя:",ae),new Error("Не удалось получить данные пользователя. Попробуйте войти вручную.");const{data:{user:b}}=await F.auth.getUser(),Q=b||ee;console.log("RegisterPage: User metadata after registration:",{role:Q.user_metadata?.role,user_role:Q.user_metadata?.user_role,organization_id:Q.user_metadata?.organization_id});const{setUser:z,setSession:fe,setLoading:ye}=Ae.getState();if(ne&&Q?(console.log("RegisterPage: Setting auth state directly:",{userId:Q.id,email:Q.email,role:Q.user_metadata?.role,user_role:Q.user_metadata?.user_role,organization_id:Q.user_metadata?.organization_id,hasSession:!!ne}),z(Q),fe(ne),ye(!1),Ae.setState({isAuthenticated:!0,loading:!1}),console.log("RegisterPage: Auth state set, isAuthenticated:",Ae.getState().isAuthenticated)):console.error("RegisterPage: Missing session or user:",{hasSession:!!ne,hasUser:!!Q}),console.log("✅ Регистрация сотрудника завершена успешно"),console.log("Final auth state:",{isAuthenticated:Ae.getState().isAuthenticated,hasUser:!!Ae.getState().user,hasSession:!!Ae.getState().session,userRole:Ae.getState().user?.user_metadata?.role,userRoleAlt:Ae.getState().user?.user_metadata?.user_role,organizationId:Ae.getState().user?.user_metadata?.organization_id}),await new Promise(ce=>setTimeout(ce,200)),Q?.id)try{const{data:ce,error:me}=await F.rpc("process_pending_diary_access",{p_user_id:Q.id});!me&&ce?.success_count>0&&(console.log("[RegisterPage] Обработано pending токенов:",ce.success_count),await r.invalidateQueries({queryKey:["dashboard-diaries"]}))}catch(ce){console.error("[RegisterPage] Ошибка обработки pending токенов:",ce)}e("/profile/setup")}catch(T){console.error("Ошибка регистрации по приглашению организации",T),$(T.message||"Не удалось завершить регистрацию. Попробуйте ещё раз.")}finally{P(!1)}}};return g?p==="checking"?t.jsxs("div",{className:"text-center py-8",children:[t.jsx("div",{className:"animate-spin w-12 h-12 border-4 border-blue-primary border-t-transparent rounded-full mx-auto mb-4"}),t.jsx("p",{className:"text-gray-600",children:"Проверяем пригласительную ссылку..."})]}):p==="invalid"?t.jsxs("div",{className:"text-center",children:[t.jsxs("div",{className:"mb-6",children:[t.jsx("div",{className:"w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4",children:t.jsx("svg",{className:"w-8 h-8 text-red-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),t.jsx("h1",{className:"text-2xl font-bold text-gray-dark mb-3",children:"Недействительная ссылка"}),t.jsx("p",{className:"text-gray-600 text-sm mb-6",children:O||"Эта пригласительная ссылка недействительна или уже была использована."})]}),t.jsx(oe,{onClick:()=>e("/login"),fullWidth:!0,size:"lg",children:"Войти в систему"})]}):t.jsxs("div",{children:[t.jsx("h1",{className:"text-[32px] font-bold text-gray-dark mb-2 text-center",children:"Регистрация сотрудника"}),t.jsx("p",{className:"text-gray-600 text-center text-sm mb-6",children:"Введите номер телефона и придумайте пароль, чтобы получить доступ к дневникам организации."}),f?.role&&t.jsxs("p",{className:"text-center text-sm text-gray-500 mb-6",children:["Ваша роль: ",Uf[f.role]||"Сотрудник"]}),t.jsxs("form",{onSubmit:B(v),className:"space-y-5",children:[t.jsx(he,{label:"Введите номер телефона",type:"tel",placeholder:"Номер телефона",error:Z.phone?.message,fullWidth:!0,...L("phone")}),t.jsx(he,{label:"Придумайте пароль",type:"password",placeholder:"Пароль",error:Z.password?.message,helperText:"Минимум 6 символов",fullWidth:!0,...L("password")}),t.jsx(he,{label:"Подтвердите пароль",type:"password",placeholder:"Повторите пароль",error:Z.confirmPassword?.message,fullWidth:!0,...L("confirmPassword")}),O&&t.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-xl",children:t.jsx("p",{className:"text-sm text-red-600",children:O})}),t.jsx(oe,{type:"submit",fullWidth:!0,isLoading:I,size:"lg",children:"Завершить регистрацию"})]})]}):D===!1?t.jsxs("div",{className:"text-center",children:[t.jsxs("div",{className:"mb-6",children:[t.jsx("div",{className:"w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4",children:t.jsx("svg",{className:"w-8 h-8 text-red-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),t.jsx("h1",{className:"text-2xl font-bold text-gray-dark mb-3",children:"Недействительная ссылка"}),t.jsx("p",{className:"text-gray-600 text-sm mb-4",children:S||"Эта ссылка для регистрации недействительна или уже использована."}),t.jsx("p",{className:"text-gray-600 text-sm mb-4",children:"Для регистрации необходимо записаться на закрытое тестирование."}),t.jsx("p",{className:"text-gray-600 text-sm mb-6",children:"Свяжитесь с нами в WhatsApp, и мы отправим вам пригласительную ссылку для доступа к платформе."})]}),t.jsxs("div",{className:"flex flex-col items-center gap-3",children:[t.jsx("a",{href:`https://wa.me/79145391376?text=${encodeURIComponent("Здравствуйте! Хочу записаться на закрытое тестирование Дневника подопечного. Нужна пригласительная ссылка для регистрации.")}`,target:"_blank",rel:"noreferrer",className:"w-full",children:t.jsxs(oe,{fullWidth:!0,size:"lg",className:"bg-gradient-to-r from-[#25D366] to-[#128C7E] hover:from-[#20BA5A] hover:to-[#0F7A6D] text-white border-0 shadow-lg hover:shadow-xl",children:[t.jsx("svg",{className:"w-5 h-5 mr-2",fill:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{d:"M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"})}),"Связаться с нами в WhatsApp"]})}),t.jsx(oe,{onClick:()=>e("/login"),size:"lg",fullWidth:!0,variant:"outline",children:"Войти в систему"}),t.jsx(oe,{onClick:()=>e("/"),size:"lg",fullWidth:!0,variant:"outline",children:"На главную"})]})]}):D===null?t.jsxs("div",{className:"text-center py-8",children:[t.jsx("div",{className:"animate-spin w-12 h-12 border-4 border-blue-primary border-t-transparent rounded-full mx-auto mb-4"}),t.jsx("p",{className:"text-gray-600",children:"Проверка приглашения..."})]}):!c&&!g?t.jsxs("div",{className:"text-center",children:[t.jsxs("div",{className:"mb-6",children:[t.jsx("h1",{className:"text-2xl font-bold text-gray-dark mb-3",children:"Регистрация по приглашению"}),t.jsx("p",{className:"text-gray-600 text-sm mb-4",children:"Для регистрации необходимо записаться на закрытое тестирование."}),t.jsx("p",{className:"text-gray-600 text-sm mb-4",children:"Свяжитесь с нами в WhatsApp, и мы отправим вам пригласительную ссылку для доступа к платформе."}),t.jsxs("p",{className:"text-gray-500 text-sm mb-6",children:["Если у вас уже есть аккаунт, вы можете"," ",t.jsx("button",{onClick:()=>e("/login"),className:"text-blue-primary font-semibold underline decoration-1 hover:text-blue-600",children:"войти в систему"}),"."]})]}),t.jsxs("div",{className:"flex flex-col items-center gap-3",children:[t.jsx("a",{href:`https://wa.me/79145391376?text=${encodeURIComponent("Здравствуйте! Хочу записаться на закрытое тестирование Дневника подопечного. Нужна пригласительная ссылка для регистрации.")}`,target:"_blank",rel:"noreferrer",className:"w-full",children:t.jsxs(oe,{fullWidth:!0,size:"lg",className:"bg-gradient-to-r from-[#25D366] to-[#128C7E] hover:from-[#20BA5A] hover:to-[#0F7A6D] text-white border-0 shadow-lg hover:shadow-xl",children:[t.jsx("svg",{className:"w-5 h-5 mr-2",fill:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{d:"M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"})}),"Связаться с нами в WhatsApp"]})}),t.jsx(oe,{onClick:()=>e("/login"),size:"lg",fullWidth:!0,variant:"outline",children:"Войти в систему"}),t.jsx(oe,{onClick:()=>e("/"),size:"lg",fullWidth:!0,variant:"outline",children:"На главную"})]})]}):_?t.jsxs("div",{children:[t.jsxs("button",{onClick:()=>y(null),className:"flex items-center gap-2 text-blue-primary hover:text-blue-600 mb-6 text-sm font-medium transition-colors",children:[t.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})}),"Назад к выбору типа"]}),t.jsx("h1",{className:"text-3xl font-bold text-gray-dark mb-2 text-center",children:"Регистрация"}),t.jsx("p",{className:"text-gray-600 mb-6 text-center text-sm",children:_==="pension"?"Пансионат":_==="patronage_agency"?"Патронажное агентство":"Частная сиделка"}),t.jsxs("form",{onSubmit:G(j),className:"space-y-5",children:[t.jsx(he,{label:"Введите почту",type:"email",placeholder:"Почта",error:M.email?.message,fullWidth:!0,...R("email")}),t.jsx(he,{label:"Придумайте пароль",type:"password",placeholder:"Пароль",error:M.password?.message,helperText:"Минимум 6 символов",fullWidth:!0,...R("password")}),t.jsx(he,{label:"Подтвердите пароль",type:"password",placeholder:"Повторите пароль",error:M.confirmPassword?.message,fullWidth:!0,...R("confirmPassword")}),S&&t.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-xl",children:t.jsx("p",{className:"text-sm text-red-600",children:S})}),t.jsx(oe,{type:"submit",fullWidth:!0,isLoading:I,size:"lg",children:"Зарегистрироваться"}),t.jsxs("p",{className:"text-center text-sm text-gray-600 mt-4",children:["Если уже есть аккаунт, нажмите"," ",t.jsx("button",{type:"button",onClick:()=>e("/login"),className:"text-gray-dark font-semibold underline",children:"Войти"})]})]})]}):t.jsxs("div",{children:[t.jsx("h1",{className:"text-3xl font-bold text-gray-dark mb-2 text-center",children:"Регистрация"}),t.jsx("p",{className:"text-gray-600 mb-8 text-center text-sm",children:"Выберите тип вашей организации"}),t.jsxs("div",{className:"space-y-4",children:[t.jsxs("button",{onClick:()=>y("pension"),className:"w-full p-6 bg-gradient-to-br from-[#55ACBF] to-[#4A9BAD] rounded-2xl shadow-md hover:shadow-xl transition-all text-white text-left transform hover:scale-[1.02] active:scale-[0.98]",children:[t.jsx("h3",{className:"font-bold text-xl mb-2",children:"Пансионат"}),t.jsx("p",{className:"text-sm text-white/90",children:"Учреждение для ухода за подопечными"})]}),t.jsxs("button",{onClick:()=>y("patronage_agency"),className:"w-full p-6 bg-gradient-to-br from-[#4A9BAD] to-[#3D8291] rounded-2xl shadow-md hover:shadow-xl transition-all text-white text-left transform hover:scale-[1.02] active:scale-[0.98]",children:[t.jsx("h3",{className:"font-bold text-xl mb-2",children:"Патронажное агентство"}),t.jsx("p",{className:"text-sm text-white/90",children:"Агентство по предоставлению услуг ухода"})]}),t.jsxs("button",{onClick:()=>y("caregiver"),className:"w-full p-6 bg-gradient-to-br from-[#3D8291] to-[#2F6A78] rounded-2xl shadow-md hover:shadow-xl transition-all text-white text-left transform hover:scale-[1.02] active:scale-[0.98]",children:[t.jsx("h3",{className:"font-bold text-xl mb-2",children:"Частная сиделка"}),t.jsx("p",{className:"text-sm text-white/90",children:"Индивидуальный специалист по уходу"})]})]})]})},Et=e=>{if(!e)return"Произошла неизвестная ошибка";const r=e.message||e.toString();return r.includes("Failed to fetch")||r.includes("fetch")?"Ошибка подключения к серверу. Проверьте интернет-соединение и попробуйте ещё раз.":r.includes("Invalid login credentials")?"Неверный email/телефон или пароль":r.includes("Email not confirmed")?"Email не подтвержден. Проверьте почту и подтвердите регистрацию.":r.includes("Phone signups are disabled")?'Регистрация по телефону отключена в настройках Supabase. Включите "Phone Auth" в Authentication → Settings.':r.includes("User already registered")?"Пользователь с таким email уже зарегистрирован":r.includes("Password should be at least")?"Пароль должен содержать минимум 6 символов":r.includes("Invalid email")?"Некорректный email адрес":r.includes("JWT")?"Ошибка авторизации. Попробуйте войти заново.":r.includes("Network")?"Ошибка сети. Проверьте подключение к интернету.":r.includes("Missing Supabase")?"Ошибка конфигурации. Обратитесь к администратору.":"Произошла ошибка. Попробуйте ещё раз или обратитесь в поддержку."},Wf=bt({login:ke().min(1,"Введите email или номер телефона"),password:ke().min(1,"Введите пароль")}),qf=()=>{const e=rt(),r=Rr(),[s,a]=u.useState(!1),[n,i]=u.useState(null),{register:o,handleSubmit:c,formState:{errors:g}}=xt({resolver:yt(Wf)}),_=async y=>{if(a(!0),i(null),y.login.includes("@"))try{localStorage.removeItem("current_user"),localStorage.removeItem("auth_token");try{await F.auth.signOut()}catch{}const w=await F.auth.signInWithPassword({email:y.login,password:y.password});if(w.error)throw w.error;if(w.data.user){const{setUser:I,setSession:P}=Ae.getState();I(w.data.user),P(w.data.session),console.log("Logged in as organization:",w.data.user.email);try{const{data:S,error:U}=await F.rpc("process_pending_diary_access",{p_user_id:w.data.user.id});!U&&S?.success_count>0&&(console.log("[LoginPage] Обработано pending токенов:",S.success_count),await r.invalidateQueries({queryKey:["dashboard-diaries"]}))}catch(S){console.error("[LoginPage] Ошибка обработки pending токенов:",S)}e("/dashboard")}}catch(w){i(Et(w))}finally{a(!1)}else try{let w=y.login.trim().replace(/\s/g,"");w.startsWith("+")||(w.startsWith("7")?w="+"+w:w.startsWith("8")?w="+7"+w.substring(1):w="+7"+w.replace(/\D/g,""));const I=w.replace(/[^0-9]/g,"");console.log("LoginPage: Phone normalization:",{original:y.login,formatted:w,sanitized:I});try{console.log("LoginPage: Searching user by phone:",I);const{data:U,error:O}=await F.rpc("find_user_email_by_phone",{p_phone:I});if(O?console.error("LoginPage: RPC find_user_email_by_phone error:",O):console.log("LoginPage: RPC find_user_email_by_phone result:",U),!O&&U&&U.length>0){const $=U[0];console.log("LoginPage: ✅ Found user by phone:",{user_id:$.user_id,email:$.email,user_role:$.user_role,organization_type:$.organization_type});const p=await F.auth.signInWithPassword({email:$.email,password:y.password});if(!p.error&&p.data.user){console.log("LoginPage: ✅ Successfully logged in as:",p.data.user.email);const{setUser:k,setSession:f}=Ae.getState();k(p.data.user),f(p.data.session);try{const{data:x,error:R}=await F.rpc("process_pending_diary_access",{p_user_id:p.data.user.id});!R&&x?.success_count>0&&(console.log("[LoginPage] Обработано pending токенов:",x.success_count),await r.invalidateQueries({queryKey:["dashboard-diaries"]}))}catch(x){console.error("[LoginPage] Ошибка обработки pending токенов:",x)}e("/dashboard");return}else throw console.error("LoginPage: ❌ User found but password incorrect:",p.error),p.error||new Error("Неверный пароль")}else console.log("LoginPage: No user found by phone, trying fallback method")}catch(U){console.error("LoginPage: RPC find_user_email_by_phone exception:",U)}const P=[`admin-${I}@diary.local`,`organization_employee-${I}@diary.local`,`organization_client-${I}@diary.local`,`caregiver_client-${I}@diary.local`];console.log("LoginPage: Trying email variants (fallback):",P);let S=null;for(const U of P)try{console.log("LoginPage: Attempting login with:",U);const O=await F.auth.signInWithPassword({email:U,password:y.password});if(O.error)console.log("LoginPage: ❌ Login failed with",U,":",O.error.message),S=O.error;else if(O.data.user){console.log("LoginPage: ✅ Successfully logged in as:",O.data.user.email);const{setUser:$,setSession:p}=Ae.getState();$(O.data.user),p(O.data.session);try{const{data:k,error:f}=await F.rpc("process_pending_diary_access",{p_user_id:O.data.user.id});!f&&k?.success_count>0&&(console.log("[LoginPage] Обработано pending токенов:",k.success_count),await r.invalidateQueries({queryKey:["dashboard-diaries"]}))}catch(k){console.error("[LoginPage] Ошибка обработки pending токенов:",k)}e("/dashboard");return}}catch(O){console.log("LoginPage: ❌ Exception with",U,":",O.message),S=O}if(S)throw console.error("LoginPage: All login attempts failed, last error:",S),S}catch(w){i(Et(w))}finally{a(!1)}};return t.jsxs("div",{children:[t.jsx("h1",{className:"text-[32px] font-bold text-gray-dark mb-10 text-center",children:"Войти"}),t.jsxs("form",{onSubmit:c(_),className:"space-y-6 mt-4",children:[t.jsx(he,{label:"Введите email или номер телефона",type:"text",placeholder:"Email или номер телефона",error:g.login?.message,fullWidth:!0,...o("login")}),t.jsx(he,{label:"Введите пароль",type:"password",placeholder:"Пароль",error:g.password?.message,fullWidth:!0,...o("password")}),n&&t.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-xl",children:t.jsx("p",{className:"text-sm font-manrope text-red-600",children:n})}),t.jsx(oe,{type:"submit",fullWidth:!0,isLoading:s,size:"lg",className:"mt-6",children:"Войти"}),t.jsxs("p",{className:"text-center text-sm font-manrope text-gray-600 mt-6 leading-relaxed",children:["Если еще нет аккаунта, нажмите"," ",t.jsx("button",{type:"button",onClick:()=>e("/register"),className:"text-gray-dark font-semibold underline decoration-1",children:"Регистрация"})]})]})]})},Jf=bt({code:ke().min(6,"Код должен содержать 8 символов").max(8,"Код должен содержать 8 символов")}),Qf=()=>{const e=rt(),r=Rr(),[s]=Fr(),{user:a}=Ae(),n=s.get("email")||a?.email||"",[i,o]=u.useState(!1),[c,g]=u.useState(!1),[_,y]=u.useState(null),[D,w]=u.useState(null),{register:I,handleSubmit:P,formState:{errors:S}}=xt({resolver:yt(Jf)});u.useEffect(()=>{(async()=>{a&&a.email_confirmed_at&&e("/profile/setup")})()},[a,e]);const U=async $=>{o(!0),y(null),w(null);try{const{data:p,error:k}=await F.auth.verifyOtp({email:n,token:$.code,type:"email"});if(k)throw k;if(p.user){w("Email успешно подтвержден!"),localStorage.removeItem("current_user"),localStorage.removeItem("auth_token");const{setSession:f,checkAuth:x}=Ae.getState(),{data:{session:R}}=await F.auth.getSession();if(R){if(f(R),await x(),R.user?.id)try{const{data:G,error:M}=await F.rpc("process_pending_diary_access",{p_user_id:R.user.id});!M&&G?.success_count>0&&(console.log("[EmailConfirmationPage] Обработано pending токенов:",G.success_count),await r.invalidateQueries({queryKey:["dashboard-diaries"]}))}catch(G){console.error("[EmailConfirmationPage] Ошибка обработки pending токенов:",G)}setTimeout(()=>{e("/profile/setup",{replace:!0})},1500)}else throw new Error("Не удалось создать сессию после подтверждения email")}}catch(p){y(Et(p))}finally{o(!1)}},O=async()=>{if(!n){y("Email не указан");return}g(!0),y(null);try{const{error:$}=await F.auth.resend({type:"signup",email:n});if($)throw $;w("Код подтверждения отправлен на вашу почту!"),setTimeout(()=>w(null),5e3)}catch($){y(Et($))}finally{g(!1)}};return t.jsxs("div",{className:"max-w-md mx-auto px-4 py-8",children:[t.jsx("h1",{className:"text-[32px] font-bold text-gray-dark mb-2 text-center",children:"Подтверждение email"}),t.jsx("p",{className:"text-gray-600 mb-8 text-center text-sm font-manrope",children:"Мы отправили код подтверждения на вашу почту"}),n&&t.jsx("p",{className:"text-center text-sm font-manrope text-gray-600 mb-6",children:n}),D&&t.jsx("div",{className:"mb-6 p-3 bg-green-50 border border-green-200 rounded-xl",children:t.jsx("p",{className:"text-sm font-manrope text-green-600",children:D})}),t.jsxs("form",{onSubmit:P(U),className:"space-y-6",children:[t.jsx(he,{label:"Введите код подтверждения",placeholder:"00000000",maxLength:8,error:S.code?.message,fullWidth:!0,className:"text-center text-2xl tracking-widest font-mono",...I("code")}),_&&t.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-xl",children:t.jsx("p",{className:"text-sm font-manrope text-red-600",children:_})}),t.jsx(oe,{type:"submit",fullWidth:!0,isLoading:i,size:"lg",children:"Подтвердить"}),t.jsx("div",{className:"text-center",children:t.jsx("button",{type:"button",onClick:O,disabled:c,className:"text-sm font-manrope text-blue-primary hover:text-blue-600 underline disabled:opacity-50 disabled:cursor-not-allowed",children:c?"Отправка...":"Отправить код повторно"})})]})]})},Dn=["organization_invite_tokens","employee_invite_tokens","local_employee_invite_tokens"],cn=Dn[0],En=()=>typeof window<"u"&&typeof window.localStorage<"u",Kf=()=>typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`invite_${Date.now()}_${Math.random().toString(16).slice(2)}`,Hf=e=>{if(!e)return new Date().toISOString();const r=new Date(e);return Number.isNaN(r.getTime())?new Date().toISOString():r.toISOString()},Gf=e=>{if(!e)return null;try{return JSON.parse(e)}catch(r){return console.warn("inviteStorage: не удалось распарсить JSON",r),null}},Yf=e=>{if(!e||typeof e!="object"&&typeof e!="function")return null;const r=new Date().toISOString(),s=e.token?String(e.token):e.id?String(e.id):"";if(!s)return null;const a=e.id?String(e.id):s||Kf(),n=Hf(e.created_at??e.createdAt??r),i={id:a,token:s,organization_id:e.organization_id??e.organizationId??e.owner_id??e.ownerId??e.caregiver_id??null,role:e.role??e.employee_role??e.employeeRole??null,created_at:n,used_at:e.used_at??e.usedAt??null,used_by:e.used_by??e.usedBy??null,link:e.link??e.direct_link??e.url??void 0};return Object.keys(e).forEach(o=>{o in i||(i[o]=e[o])}),i},Xf=()=>{if(!En())return{key:cn,tokens:[]};for(const e of Dn){const r=Gf(window.localStorage.getItem(e));if(Array.isArray(r)){const s=r.map(Yf).filter(a=>!!a);return{key:e,tokens:s}}}return{key:cn,tokens:[]}},mo=(e,r=cn)=>{if(En())try{const s=JSON.stringify(e);window.localStorage.setItem(r,s),Dn.forEach(a=>{a!==r&&window.localStorage.getItem(a)!==null&&window.localStorage.removeItem(a)})}catch(s){console.warn("inviteStorage: не удалось сохранить токены",s)}},ho=()=>{if(!En())return[];const{key:e,tokens:r}=Xf();return r.length?(mo(r,e),r):(mo([],e),[])},eg=bt({firstName:ke().min(1,"Введите имя"),lastName:ke().min(1,"Введите фамилию"),phone:ke().min(1,"Введите номер телефона"),city:ke().min(1,"Введите город")}),tg=bt({name:ke().min(1,"Введите название организации"),phone:ke().min(1,"Введите номер телефона"),address:ke().min(1,"Введите адрес организации")}),rg=bt({firstName:ke().min(1,"Введите имя"),lastName:ke().min(1,"Введите фамилию")}),sg=bt({firstName:ke().min(1,"Введите имя"),lastName:ke().min(1,"Введите фамилию")}),ag=()=>{const e=rt(),r=Rr(),{user:s}=Ae(),[a,n]=u.useState(null),[i,o]=u.useState(!1),[c,g]=u.useState(!1),[_,y]=u.useState(null),[D,w]=u.useState(null),[I,P]=u.useState(!1),[S,U]=u.useState(null),[O,$]=u.useState(!0),p=u.useRef(!1);u.useEffect(()=>{(async()=>{let v=null,E;console.log("ProfileSetupPage: Starting user type check...");try{const W=localStorage.getItem("current_user");if(console.log("ProfileSetupPage: localStorage current_user:",W),W&&W!=="{}"){if(v=JSON.parse(W),E=v.user_role||v.user_metadata?.user_role,console.log("ProfileSetupPage: Parsed localStorage user:",{id:v.id,role:E,caregiver_id:v.caregiver_id,organization_id:v.organization_id,phone:v.phone}),E==="client"&&v.id){console.log("✅ ProfileSetupPage: Detected CLIENT from localStorage");try{const{data:h,error:C}=await F.from("clients").select("first_name, last_name").eq("user_id",v.id).single();if(!C&&h&&h.first_name&&h.last_name){console.log("ProfileSetupPage: Client profile already filled, redirecting to dashboard"),e("/dashboard");return}}catch(h){console.error("ProfileSetupPage: Error checking client profile:",h)}g(!0),w({caregiver_id:v.caregiver_id,organization_id:v.organization_id,patient_card_id:v.patient_card_id,diary_id:v.diary_id}),$(!1),p.current=!0;return}if(E==="org_employee"&&v.id&&v.organization_id){console.log("✅ ProfileSetupPage: Detected EMPLOYEE from localStorage"),o(!0),y(v.organization_id),$(!1),p.current=!0;return}}}catch(W){console.error("ProfileSetupPage: Error parsing localStorage:",W)}if(p.current){console.log("ProfileSetupPage: Already checked, skipping...");return}if(i||c||a){console.log("ProfileSetupPage: Type already determined:",{isEmployee:i,isClient:c,organizationType:a}),$(!1),p.current=!0;return}if(p.current=!0,!s){console.log("ProfileSetupPage: No user in authStore, but localStorage user was found - using it"),(!v?.id||!E||E!=="client"&&E!=="org_employee")&&(console.log("ProfileSetupPage: No valid user found, redirecting to login"),e("/login"));return}console.log("ProfileSetupPage: Checking user from authStore:",{id:s.id,email:s.email,phone:s.phone,user_role:s.user_role,user_metadata_role:s.user_metadata?.role,user_metadata_user_role:s.user_metadata?.user_role,organization_type:s.user_metadata?.organization_type});let T=s.user_role||s.user_metadata?.user_role||s.user_metadata?.role;if(!T)try{console.log("ProfileSetupPage: Role not found in metadata, loading from user_profiles...");const{data:W,error:h}=await F.from("user_profiles").select("role, organization_id").eq("user_id",s.id).single();!h&&W?(T=W.role,console.log("ProfileSetupPage: Loaded role from user_profiles:",T,"organization_id:",W.organization_id),T==="org_employee"&&W.organization_id&&(console.log("ProfileSetupPage: Setting organization_id from user_profiles:",W.organization_id),y(W.organization_id))):h&&console.error("ProfileSetupPage: Error loading user_profiles:",h)}catch(W){console.error("ProfileSetupPage: Error loading from user_profiles:",W)}if(console.log("ProfileSetupPage: Final userRole:",T),T==="client"){console.log("✅ ProfileSetupPage: Detected CLIENT from authStore");try{const{data:W,error:h}=await F.from("clients").select("first_name, last_name").eq("user_id",s.id).single();if(!h&&W&&W.first_name&&W.last_name){console.log("ProfileSetupPage: Client profile already filled, redirecting to dashboard"),e("/dashboard");return}}catch(W){console.error("ProfileSetupPage: Error checking client profile:",W)}g(!0),w({caregiver_id:s.caregiver_id||s.user_metadata?.caregiver_id||v?.caregiver_id,organization_id:s.organization_id||s.user_metadata?.organization_id||v?.organization_id,patient_card_id:s.patient_card_id||s.user_metadata?.patient_card_id||v?.patient_card_id,diary_id:s.diary_id||s.user_metadata?.diary_id||v?.diary_id}),$(!1);return}const J=s.user_metadata?.organization_type;if(console.log("ProfileSetupPage: Checking organization_type:",J),J&&["pension","patronage_agency","caregiver"].includes(J)){if(console.log("✅ ProfileSetupPage: Detected ORGANIZATION/CAREGIVER:",J),!s.email_confirmed_at){console.log("Email not confirmed, redirecting to email confirmation"),p.current=!1,e(`/email-confirmation?email=${encodeURIComponent(s.email||"")}`);return}n(J),$(!1);return}if(T==="org_employee"){let W=s.organization_id||s.user_metadata?.organization_id||v?.organization_id;if(!W||W==="temp")try{console.log("ProfileSetupPage: organization_id not found, loading from DB...");const{data:h}=await F.from("user_profiles").select("organization_id").eq("user_id",s.id).single();if(h?.organization_id)W=h.organization_id,console.log("ProfileSetupPage: Loaded organization_id from user_profiles:",W);else{const{data:C}=await F.from("organization_employees").select("organization_id").eq("user_id",s.id).single();C?.organization_id&&(W=C.organization_id,console.log("ProfileSetupPage: Loaded organization_id from organization_employees:",W))}}catch(h){console.error("ProfileSetupPage: Error loading organization_id:",h)}if(console.log("ProfileSetupPage: Checking employee, orgId:",W),W&&W!=="temp"){console.log("✅ ProfileSetupPage: Detected EMPLOYEE with orgId:",W),o(!0),y(W),$(!1),p.current=!0;return}else console.warn("ProfileSetupPage: Employee detected but no organization_id found")}console.error("❌ ProfileSetupPage: Could not determine user type:",{userRole:T,localStorageUserRole:E,userType:J,email:s.email,phone:s.phone,hasLocalStorageData:!!v?.id}),U("Не удалось определить тип пользователя. Проверьте данные регистрации."),$(!1),setTimeout(()=>{p.current=!1,e("/register")},3e3)})()},[]);const k=xt({resolver:yt(eg)}),f=xt({resolver:yt(tg)}),x=xt({resolver:yt(rg)}),R=xt({resolver:yt(sg)}),G=async j=>{if(!(!s||!a)){P(!0),U(null);try{try{const{error:v}=await F.rpc("create_user_profile",{p_role:"organization"});v&&v.code!=="23505"&&console.warn("Не удалось создать/обновить user_profiles через RPC:",v);const{data:E,error:T}=await F.rpc("create_organization",{p_organization_type:a,p_name:`${j.firstName} ${j.lastName}`,p_phone:j.phone,p_address:null});if(T)throw T;if(E?.id){const{error:J}=await F.from("organizations").update({first_name:j.firstName,last_name:j.lastName,city:j.city}).eq("id",E.id);J&&console.warn("Не удалось обновить дополнительные поля организации:",J)}await F.auth.updateUser({data:{organization_type:a,firstName:j.firstName,lastName:j.lastName,phone:j.phone,city:j.city}})}catch(v){console.error("Ошибка создания организации:",v);const{error:E}=await F.auth.updateUser({data:{profile_data:{firstName:j.firstName,lastName:j.lastName,phone:j.phone,city:j.city},organization_type:a}});if(E)throw E}if(s?.id)try{console.log("[ProfileSetupPage] Обработка pending токенов доступа к дневникам после создания организации"),await new Promise(T=>setTimeout(T,500));const{data:v,error:E}=await F.rpc("process_pending_diary_access",{p_user_id:s.id});if(!E&&v)if(console.log("[ProfileSetupPage] Результат обработки pending токенов:",v),v.success_count>0){console.log("[ProfileSetupPage] Успешно обработано токенов:",v.success_count),await r.invalidateQueries({queryKey:["dashboard-diaries"]}),e("/dashboard",{replace:!0});return}else v.error_count>0&&console.log("[ProfileSetupPage] Некоторые токены не удалось обработать:",v.errors);else E&&console.error("[ProfileSetupPage] Ошибка обработки pending токенов:",E)}catch(v){console.error("[ProfileSetupPage] Ошибка обработки pending токенов:",v)}e("/dashboard")}catch(v){U(Et(v))}finally{P(!1)}}},M=async j=>{if(!(!s||!D)){P(!0),U(null);try{const v=s.phone||s.user_metadata?.phone_for_login||s.user_metadata?.phone||null,{data:E,error:T}=await F.from("clients").select("id").eq("user_id",s.id).single();if(T&&T.code!=="PGRST116")throw console.error("Ошибка проверки клиента:",T),T;if(E){const{error:J}=await F.from("clients").update({first_name:j.firstName,last_name:j.lastName,phone:v,invited_by_caregiver_id:D.caregiver_id||null,invited_by_organization_id:D.organization_id||null}).eq("user_id",s.id);if(J)throw console.error("Ошибка обновления клиента:",J),J}else{const{error:J}=await F.from("clients").insert({user_id:s.id,first_name:j.firstName,last_name:j.lastName,phone:v,invited_by_caregiver_id:D.caregiver_id||null,invited_by_organization_id:D.organization_id||null});if(J)throw console.error("Ошибка создания клиента:",J),J}await F.auth.updateUser({data:{firstName:j.firstName,lastName:j.lastName,phone:v}}),console.log("✅ Профиль клиента сохранен в Supabase"),e("/profile")}catch(v){console.error("Ошибка сохранения профиля клиента:",v),U(Et(v)||"Не удалось сохранить профиль. Попробуйте ещё раз.")}finally{P(!1)}}},L=async j=>{if(s){P(!0),U(null);try{let v=s.organization_id||s.user_metadata?.organization_id||_;const E=s.organization_invite_token||s.user_metadata?.organization_invite_token;if((!v||v==="temp")&&E){const b=ho().find(Q=>Q.token===E);b&&b.organization_id&&(v=b.organization_id,console.log("Found organization_id from token:",v))}(!v||v==="temp")&&(console.warn("Warning: organization_id is still temp, employee may not be linked to organization"),v="temp"),console.log("Saving employee with organization_id:",v,"user_id:",s.id);let T=s.employee_role||s.user_metadata?.employee_role||null;if(!T)try{const{data:ne}=await F.from("organization_employees").select("role").eq("user_id",s.id).single();ne?.role&&(T=ne.role,console.log("ProfileSetupPage: Loaded role from organization_employees:",T))}catch(ne){console.error("ProfileSetupPage: Error loading role from organization_employees:",ne)}let J=s.organization_type||s.user_metadata?.organization_type||a||null;if(!J&&E){const b=ho().find(Q=>Q.token===E);b?.organization_type&&(J=b.organization_type)}const W=s.phone||s.user_metadata?.phone_for_login||s.user_metadata?.phone||null;try{console.log("ProfileSetupPage: Saving employee to Supabase:",{user_id:s.id,organization_id:v,first_name:j.firstName,last_name:j.lastName,phone:W,role:T});const{data:ne,error:b}=await F.from("organization_employees").select("id").eq("user_id",s.id).single();if(b&&b.code!=="PGRST116"&&console.error("ProfileSetupPage: Error checking existing employee:",b),ne){const{error:Q}=await F.from("organization_employees").update({first_name:j.firstName,last_name:j.lastName,phone:W||null}).eq("user_id",s.id);if(Q)throw console.error("ProfileSetupPage: Error updating employee in Supabase:",Q),Q;console.log("✅ ProfileSetupPage: Employee updated in Supabase")}else{const{error:Q}=await F.from("organization_employees").insert({user_id:s.id,organization_id:v,first_name:j.firstName,last_name:j.lastName,phone:W||null,role:T||"caregiver"});if(Q)throw console.error("ProfileSetupPage: Error inserting employee in Supabase:",Q),Q;console.log("✅ ProfileSetupPage: Employee created in Supabase")}}catch(ne){console.error("ProfileSetupPage: Database error:",ne),U("Не удалось сохранить в базу данных. Данные сохранены локально.")}const h=JSON.parse(localStorage.getItem("local_employees")||"[]"),C=h.findIndex(ne=>ne.user_id===s.id),Y={user_id:s.id,organization_id:v,organization_type:J,first_name:j.firstName,last_name:j.lastName,phone:W,role:T,organization_invite_token:E,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};C!==-1?h[C]={...h[C],...Y}:h.push(Y),localStorage.setItem("local_employees",JSON.stringify(h));const ee=JSON.parse(localStorage.getItem("current_user")||"{}");ee.organization_id=v,ee.organization_type=J,ee.profile_data={firstName:j.firstName,lastName:j.lastName,phone:W,organization_id:v,organization_type:J},localStorage.setItem("current_user",JSON.stringify(ee));const{setUser:ae}=Ae.getState();ae({...s,...ee}),e("/dashboard")}catch{U("Не удалось сохранить профиль. Попробуйте ещё раз.")}finally{P(!1)}}},B=async j=>{if(!(!s||!a)){P(!0),U(null);try{try{const{error:v}=await F.rpc("create_organization",{p_organization_type:a,p_name:j.name,p_phone:j.phone,p_address:j.address});if(v)throw v;await F.auth.updateUser({data:{organization_type:a,name:j.name,phone:j.phone,address:j.address}})}catch(v){console.error("Ошибка создания организации:",v);const{error:E}=await F.auth.updateUser({data:{profile_data:{name:j.name,phone:j.phone,address:j.address},organization_type:a}});if(E)throw E}e("/dashboard")}catch(v){U(Et(v))}finally{P(!1)}}};if(O)return t.jsx("div",{className:"min-h-screen flex items-center justify-center",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"animate-spin w-12 h-12 border-4 border-blue-primary border-t-transparent rounded-full mx-auto mb-4"}),t.jsx("p",{className:"text-gray-600",children:"Загрузка..."})]})});if(!i&&!c&&!a)return t.jsx("div",{className:"min-h-screen flex items-center justify-center px-4",children:t.jsxs("div",{className:"text-center max-w-md",children:[t.jsx("div",{className:"w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4",children:t.jsx("svg",{className:"w-8 h-8 text-red-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),t.jsx("h1",{className:"text-2xl font-bold text-gray-dark mb-3",children:"Ошибка"}),t.jsx("p",{className:"text-gray-600 text-sm font-manrope mb-6",children:S||"Не удалось определить тип пользователя. Пожалуйста, зарегистрируйтесь заново."}),t.jsx(oe,{onClick:()=>e("/register"),fullWidth:!0,size:"lg",children:"Вернуться к регистрации"})]})});if(c)return t.jsxs("div",{className:"max-w-md mx-auto px-4 py-8",children:[t.jsx("h1",{className:"text-[32px] font-bold text-gray-dark mb-2 text-center",children:"Заполнить профиль"}),t.jsx("p",{className:"text-gray-600 mb-8 text-center text-sm font-manrope",children:"Клиент"}),t.jsxs("form",{onSubmit:R.handleSubmit(M),className:"space-y-6",children:[t.jsx(he,{label:"Имя",placeholder:"Введите имя",error:R.formState.errors.firstName?.message,fullWidth:!0,...R.register("firstName")}),t.jsx(he,{label:"Фамилия",placeholder:"Введите фамилию",error:R.formState.errors.lastName?.message,fullWidth:!0,...R.register("lastName")}),S&&t.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-xl",children:t.jsx("p",{className:"text-sm font-manrope text-red-600",children:S})}),t.jsx(oe,{type:"submit",fullWidth:!0,isLoading:I,size:"lg",children:"Сохранить профиль"})]})]});if(i)return t.jsxs("div",{className:"max-w-md mx-auto px-4 py-8",children:[t.jsx("h1",{className:"text-[32px] font-bold text-gray-dark mb-2 text-center",children:"Заполнить профиль"}),t.jsx("p",{className:"text-gray-600 mb-8 text-center text-sm font-manrope",children:"Сотрудник организации"}),t.jsxs("form",{onSubmit:x.handleSubmit(L),className:"space-y-6",children:[t.jsx(he,{label:"Имя",placeholder:"Введите имя",error:x.formState.errors.firstName?.message,fullWidth:!0,...x.register("firstName")}),t.jsx(he,{label:"Фамилия",placeholder:"Введите фамилию",error:x.formState.errors.lastName?.message,fullWidth:!0,...x.register("lastName")}),S&&t.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-xl",children:t.jsx("p",{className:"text-sm font-manrope text-red-600",children:S})}),t.jsx(oe,{type:"submit",fullWidth:!0,isLoading:I,size:"lg",children:"Сохранить профиль"})]})]});if(a==="caregiver")return t.jsxs("div",{className:"max-w-md mx-auto px-4 py-8",children:[t.jsx("h1",{className:"text-[32px] font-bold text-gray-dark mb-2 text-center",children:"Заполнить профиль"}),t.jsx("p",{className:"text-gray-600 mb-8 text-center text-sm font-manrope",children:"Частная сиделка"}),t.jsxs("form",{onSubmit:k.handleSubmit(G),className:"space-y-6",children:[t.jsx(he,{label:"Имя",placeholder:"Введите имя",error:k.formState.errors.firstName?.message,fullWidth:!0,...k.register("firstName")}),t.jsx(he,{label:"Фамилия",placeholder:"Введите фамилию",error:k.formState.errors.lastName?.message,fullWidth:!0,...k.register("lastName")}),t.jsx(he,{label:"Номер телефона",type:"tel",placeholder:"+7 (999) 123-45-67",error:k.formState.errors.phone?.message,helperText:"Номер телефона нужен для связи с поддержкой в WhatsApp",fullWidth:!0,...k.register("phone")}),t.jsx(he,{label:"Город",placeholder:"Введите город",error:k.formState.errors.city?.message,fullWidth:!0,...k.register("city")}),S&&t.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-xl",children:t.jsx("p",{className:"text-sm font-manrope text-red-600",children:S})}),t.jsx(oe,{type:"submit",fullWidth:!0,isLoading:I,size:"lg",children:"Сохранить профиль"})]})]});const Z=a==="pension"?"Пансионат":"Патронажное агентство";return t.jsxs("div",{className:"max-w-md mx-auto px-4 py-8",children:[t.jsx("h1",{className:"text-[32px] font-bold text-gray-dark mb-2 text-center",children:"Заполнить профиль"}),t.jsx("p",{className:"text-gray-600 mb-8 text-center text-sm font-manrope",children:Z}),t.jsxs("form",{onSubmit:f.handleSubmit(B),className:"space-y-6",children:[t.jsx(he,{label:"Название организации",placeholder:"Введите название организации",error:f.formState.errors.name?.message,fullWidth:!0,...f.register("name")}),t.jsx(he,{label:"Номер телефона",type:"tel",placeholder:"+7 (999) 123-45-67",error:f.formState.errors.phone?.message,helperText:"Номер телефона нужен для связи с поддержкой в WhatsApp",fullWidth:!0,...f.register("phone")}),t.jsx(he,{label:"Адрес организации",placeholder:"Введите адрес места нахождения организации",error:f.formState.errors.address?.message,fullWidth:!0,...f.register("address")}),S&&t.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-xl",children:t.jsx("p",{className:"text-sm text-red-600",children:S})}),t.jsx(oe,{type:"submit",fullWidth:!0,isLoading:I,size:"lg",children:"Сохранить профиль"})]})]})},ng=()=>{const e=rt(),{user:r}=Ae(),[s,a]=u.useState(null),[n,i]=u.useState(null),[o,c]=u.useState(!0),[g,_]=u.useState(!1),y=u.useRef(null);if(u.useEffect(()=>{(async()=>{if(!r){e("/login");return}try{const p=r.user_metadata?.organization_type;if(p&&["pension","patronage_agency","caregiver"].includes(p)){a(p);try{const{data:x,error:R}=await F.from("organizations").select("*").eq("user_id",r.id).single();if(!R&&x){i({name:x.name||"",type:p,phone:x.phone||null,city:x.city||null,address:x.address||null,firstName:x.first_name||null,lastName:x.last_name||null,avatar_url:x.avatar_url||null}),c(!1);return}}catch(x){console.error("Ошибка загрузки организации из БД:",x)}const f=r.user_metadata?.profile_data||r.user_metadata;f&&i({name:p==="caregiver"?`${f.firstName||f.first_name||""} ${f.lastName||f.last_name||""}`.trim():f.name||"",type:p,phone:f.phone||null,city:f.city||null,address:f.address||null,firstName:f.firstName||f.first_name||null,lastName:f.lastName||f.last_name||null}),c(!1);return}let k=r.user_role||r.user_metadata?.user_role||r.user_metadata?.role;if(!k)try{console.log("ProfilePage: Role not found in metadata, loading from user_profiles...");const{data:f,error:x}=await F.from("user_profiles").select("role").eq("user_id",r.id).maybeSingle();!x&&f?.role?(k=f.role,console.log("ProfilePage: Loaded role from user_profiles:",k)):x&&x.code!=="PGRST116"&&console.error("ProfilePage: Error loading from user_profiles:",x)}catch(f){console.error("ProfilePage: Error loading from user_profiles:",f)}if(console.log("ProfilePage: Final userRole:",k),k==="client"){a("client");try{const{data:f,error:x}=await F.from("clients").select("first_name, last_name, phone, avatar_url").eq("user_id",r.id).single();if(!x&&f){const R=f.phone||r.phone||r.user_metadata?.phone||null;i({name:`${f.first_name||""} ${f.last_name||""}`.trim(),type:"client",firstName:f.first_name,lastName:f.last_name,phone:R,avatar_url:f.avatar_url||null}),c(!1),console.log("✅ ProfilePage: Client profile loaded from Supabase");return}}catch(f){console.error("Error loading client from Supabase:",f)}try{const x=JSON.parse(localStorage.getItem("local_clients")||"[]").find(R=>R.user_id===r.id);if(x){const R=r.phone||r.user_metadata?.phone||x.phone||null;i({name:`${x.first_name||""} ${x.last_name||""}`.trim(),type:"client",firstName:x.first_name,lastName:x.last_name,phone:R}),c(!1),console.log("✅ ProfilePage: Client profile loaded from localStorage");return}}catch(f){console.log("Error loading client from localStorage:",f)}try{const f=JSON.parse(localStorage.getItem("current_user")||"{}");if(f.profile_data){const x=r.phone||r.user_metadata?.phone||f.profile_data.phone||f.phone||null;i({name:`${f.profile_data.firstName||""} ${f.profile_data.lastName||""}`.trim(),type:"client",firstName:f.profile_data.firstName,lastName:f.profile_data.lastName,phone:x}),c(!1),console.log("✅ ProfilePage: Client profile loaded from current_user");return}}catch(f){console.log("Error loading client from current_user:",f)}c(!1);return}if(k==="org_employee"){console.log("ProfilePage: Detected org_employee, loading profile...");try{const x=JSON.parse(localStorage.getItem("local_employees")||"[]").find(R=>R.user_id===r.id);if(x){if(!x.first_name&&!x.last_name){console.log("ProfilePage: Employee in localStorage has no first_name/last_name, redirecting to setup"),e("/profile/setup");return}const R=r.phone||r.user_metadata?.phone_for_login||r.user_metadata?.phone||x.phone||null;i({name:`${x.first_name||""} ${x.last_name||""}`.trim(),type:"employee",firstName:x.first_name,lastName:x.last_name,phone:R}),a("employee"),c(!1),console.log("✅ ProfilePage: Employee profile loaded from localStorage");return}}catch(f){console.log("Error loading from localStorage:",f)}try{const f=JSON.parse(localStorage.getItem("current_user")||"{}");if(f.profile_data){if(!f.profile_data.firstName&&!f.profile_data.lastName){console.log("ProfilePage: current_user profile_data has no firstName/lastName, redirecting to setup"),e("/profile/setup");return}const x=r.phone||r.user_metadata?.phone_for_login||r.user_metadata?.phone||f.profile_data.phone||null;i({name:`${f.profile_data.firstName||""} ${f.profile_data.lastName||""}`.trim(),type:"employee",firstName:f.profile_data.firstName,lastName:f.profile_data.lastName,phone:x}),a("employee"),c(!1),console.log("✅ ProfilePage: Employee profile loaded from current_user");return}}catch(f){console.log("Error loading from current_user:",f)}try{const f=new Promise((M,L)=>setTimeout(()=>L(new Error("Timeout")),2e3)),x=F.from("organization_employees").select("*").eq("user_id",r.id).single(),{data:R,error:G}=await Promise.race([x,f]);if(console.log("ProfilePage: DB query result:",{data:R,error:G,hasData:!!R}),!G&&R){const M=r.phone||r.user_metadata?.phone_for_login||r.user_metadata?.phone||R.phone||null;let L=null;try{const{data:B}=await F.from("user_profiles").select("avatar_url").eq("user_id",r.id).maybeSingle();L=B?.avatar_url||null}catch(B){console.log("Error loading avatar from user_profiles:",B)}if(console.log("ProfilePage: Employee data from DB:",{first_name:R.first_name,last_name:R.last_name,phone:M,hasFirstName:!!R.first_name,hasLastName:!!R.last_name}),!R.first_name&&!R.last_name){console.log("ProfilePage: Employee has no first_name/last_name, redirecting to setup"),e("/profile/setup");return}i({name:`${R.first_name||""} ${R.last_name||""}`.trim(),type:"employee",firstName:R.first_name,lastName:R.last_name,phone:M,avatar_url:L}),a("employee"),c(!1),console.log("✅ ProfilePage: Employee profile loaded successfully from DB");return}else if(G){if(console.error("ProfilePage: DB error:",G),G.code==="PGRST116"){console.log("ProfilePage: Employee record not found (PGRST116), redirecting to setup"),e("/profile/setup");return}console.log("ProfilePage: DB error (not PGRST116), trying metadata fallback")}}catch{console.log("DB query timeout or error, using metadata");const x=r.phone||r.user_metadata?.phone_for_login||r.user_metadata?.phone||null,R=r.user_metadata?.profile_data||r.profile_data;if(R)i({name:`${R.firstName||""} ${R.lastName||""}`.trim(),type:"employee",firstName:R.firstName,lastName:R.lastName,phone:x}),a("employee"),console.log("✅ ProfilePage: Employee profile loaded from metadata fallback");else{console.log("ProfilePage: No employee data found, redirecting to setup"),e("/profile/setup");return}}c(!1);return}}catch(p){console.error("Error loading profile:",p)}finally{c(!1)}})()},[r,e]),o)return t.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-100",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"animate-spin w-12 h-12 border-4 border-blue-primary border-t-transparent rounded-full mx-auto mb-4"}),t.jsx("p",{className:"text-gray-600",children:"Загрузка профиля..."})]})});if(!s||!n)return t.jsx("div",{className:"min-h-screen flex items-center justify-center px-4 bg-gray-100",children:t.jsxs("div",{className:"text-center max-w-md",children:[t.jsx("div",{className:"w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4",children:t.jsx("svg",{className:"w-8 h-8 text-red-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),t.jsx("h1",{className:"text-2xl font-bold text-gray-dark mb-3",children:"Ошибка"}),t.jsx("p",{className:"text-gray-600 text-sm mb-6",children:"Не удалось загрузить профиль. Пожалуйста, заполните профиль сначала."}),t.jsx(oe,{onClick:()=>e("/profile/setup"),fullWidth:!0,size:"lg",children:"Заполнить профиль"})]})});const D=s==="pension"||s==="patronage_agency",w=s==="employee",I=s==="client",P=s==="caregiver",S=(w||I)&&n.firstName?n.firstName:n.name,U=()=>{y.current?.click()},O=async $=>{const p=$.target.files?.[0];if(!(!p||!r)){if(!p.type.startsWith("image/")){alert("Пожалуйста, выберите изображение");return}if(p.size>5*1024*1024){alert("Размер файла не должен превышать 5MB");return}_(!0);try{const k=p.name.split(".").pop(),x=`${r.id}-${Date.now()}.${k}`;console.log('ProfilePage: Uploading avatar to bucket "avatars", filePath:',x);const{data:R,error:G}=await F.storage.from("avatars").upload(x,p,{cacheControl:"3600",upsert:!0});if(G){console.error("ProfilePage: Upload error:",G),console.error("ProfilePage: Upload error details:",{message:G.message,statusCode:G.statusCode,error:G.error});let L="Не удалось загрузить аватар. ";throw G.message?.includes("Bucket not found")||G.message?.includes("not found")?L+='Bucket "avatars" не найден. Убедитесь, что bucket создан в Supabase Storage.':G.message?.includes("row-level security")||G.message?.includes("RLS")?L+="Нет прав на загрузку файла. Обратитесь к администратору для настройки политик Storage.":G.message?.includes("JWT")?L+="Ошибка аутентификации. Попробуйте выйти и войти снова.":G.message?.includes("size")||G.message?.includes("limit")?L+="Файл слишком большой. Максимальный размер: 5MB.":L+=G.message||"Попробуйте еще раз.",new Error(L)}console.log("ProfilePage: File uploaded successfully:",R);const{data:{publicUrl:M}}=F.storage.from("avatars").getPublicUrl(x);if(console.log("ProfilePage: Public URL generated:",M),D){const{error:L}=await F.from("organizations").update({avatar_url:M}).eq("user_id",r.id);if(L)throw L}else if(w){const{error:L}=await F.from("user_profiles").update({avatar_url:M}).eq("user_id",r.id);if(L)throw L}else if(I){const{error:L}=await F.from("clients").update({avatar_url:M}).eq("user_id",r.id);if(L)throw L}i(L=>L?{...L,avatar_url:M}:null)}catch(k){console.error("Ошибка загрузки аватара:",k),alert("Не удалось загрузить аватар. Попробуйте еще раз.")}finally{_(!1),y.current&&(y.current.value="")}}};return t.jsxs("div",{className:"min-h-screen bg-gray-100 flex flex-col",children:[t.jsx("header",{className:"bg-white",children:t.jsxs("div",{className:"flex items-center px-4 py-3 relative",children:[t.jsx("button",{onClick:()=>e("/dashboard"),className:"mr-4 p-2 -ml-2","aria-label":"Назад",children:t.jsx("img",{src:"/icons/Иконка стрелка.png",alt:"Назад",className:"w-6 h-6 object-contain"})}),t.jsx("h1",{className:"absolute left-1/2 transform -translate-x-1/2 text-lg font-bold text-gray-dark",children:"Профиль"})]})}),t.jsxs("div",{className:"flex-1 max-w-md mx-auto w-full px-4 pb-0",children:[t.jsx("div",{className:"bg-white rounded-3xl shadow-md p-4 mb-6 mt-4",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("div",{className:"flex flex-col items-center flex-shrink-0",children:[t.jsxs("div",{onClick:U,className:"w-16 h-16 rounded-full flex items-center justify-center overflow-hidden cursor-pointer relative group bg-gray-100",children:[n.avatar_url?t.jsx("img",{src:n.avatar_url,alt:"Аватар",className:"w-full h-full object-cover"}):t.jsx("img",{src:"/icons/Иконка профиль.png",alt:"Профиль",className:"w-full h-full object-contain"}),g&&t.jsx("div",{className:"absolute inset-0 bg-black/50 flex items-center justify-center",children:t.jsx("div",{className:"animate-spin w-6 h-6 border-2 border-white border-t-transparent rounded-full"})}),!g&&t.jsx("div",{className:"absolute inset-0 bg-black/0 group-hover:bg-black/30 flex items-center justify-center transition-colors",children:t.jsxs("svg",{className:"w-6 h-6 text-white opacity-0 group-hover:opacity-100 transition-opacity",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"}),t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 13a3 3 0 11-6 0 3 3 0 016 0z"})]})})]}),t.jsx("input",{ref:y,type:"file",accept:"image/*",onChange:O,className:"hidden"})]}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("h2",{className:"text-xl font-bold text-gray-dark mb-1.5",children:S}),n.phone&&t.jsx("p",{className:"text-xs font-manrope text-gray-600 mb-1.5",children:n.phone}),D&&n.address&&t.jsx("p",{className:"text-xs font-manrope text-gray-600 mb-2",children:n.address}),!D&&!w&&n.city&&t.jsxs("p",{className:"text-xs font-manrope text-gray-600 mb-2",children:["г. ",n.city]}),t.jsx("button",{onClick:()=>e("/profile/edit"),className:"px-3 py-1.5 text-white rounded-lg text-xs font-manrope font-normal hover:opacity-90 transition-opacity",style:{background:"linear-gradient(135deg, #7DD3DC 0%, #5CBCC7 100%)"},children:"Настройки"})]})]})}),t.jsxs("div",{className:"mb-0",children:[t.jsx("h3",{className:"text-2xl font-bold text-gray-dark mb-6 mt-2",children:"Управление профилем"}),t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{onClick:()=>e("/dashboard"),className:"bg-white rounded-2xl shadow-md p-5 flex items-center justify-between cursor-pointer active:bg-gray-50 transition-colors",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx("p",{className:"text-lg font-bold text-gray-dark mb-1",children:"Мои дневники"}),t.jsx("p",{className:"text-xs font-manrope text-gray-500",children:"Просмотр и управление"})]}),t.jsx("img",{src:"/icons/иконка маленькая стрелка.png",alt:"",className:"w-5 h-5 ml-4 flex-shrink-0 object-contain"})]}),t.jsxs("div",{onClick:()=>e("/profile/patient-cards"),className:"bg-white rounded-2xl shadow-md p-5 flex items-center justify-between cursor-pointer active:bg-gray-50 transition-colors",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx("p",{className:"text-lg font-bold text-gray-dark mb-1",children:"Карточки подопечных"}),t.jsx("p",{className:"text-xs font-manrope text-gray-500",children:w?"Просмотр":"Просмотр и редактирование"})]}),t.jsx("img",{src:"/icons/иконка маленькая стрелка.png",alt:"",className:"w-5 h-5 ml-4 flex-shrink-0 object-contain"})]}),D&&!w&&!I&&t.jsxs("div",{onClick:()=>e("/profile/employees"),className:"bg-white rounded-2xl shadow-md p-5 flex items-center justify-between cursor-pointer active:bg-gray-50 transition-colors",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx("p",{className:"text-lg font-bold text-gray-dark mb-1",children:"Сотрудники"}),t.jsx("p",{className:"text-xs font-manrope text-gray-500",children:"Управление командой"})]}),t.jsx("img",{src:"/icons/иконка маленькая стрелка.png",alt:"",className:"w-5 h-5 ml-4 flex-shrink-0 object-contain"})]}),D&&!w&&!I&&t.jsxs("div",{onClick:()=>e("/profile/clients"),className:"bg-white rounded-2xl shadow-md p-5 flex items-center justify-between cursor-pointer active:bg-gray-50 transition-colors",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx("p",{className:"text-lg font-bold text-gray-dark mb-1",children:"Клиенты"}),t.jsx("p",{className:"text-xs font-manrope text-gray-500",children:"Список клиентов организации"})]}),t.jsx("img",{src:"/icons/иконка маленькая стрелка.png",alt:"",className:"w-5 h-5 ml-4 flex-shrink-0 object-contain"})]}),P&&!I&&!w&&t.jsxs("div",{onClick:()=>e("/profile/invite-client"),className:"bg-white rounded-2xl shadow-md p-5 flex items-center justify-between cursor-pointer active:bg-gray-50 transition-colors",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx("p",{className:"text-lg font-bold text-gray-dark mb-1",children:"Пригласить клиента"}),t.jsx("p",{className:"text-xs font-manrope text-gray-500",children:"Создать пригласительную ссылку"})]}),t.jsx("img",{src:"/icons/иконка маленькая стрелка.png",alt:"",className:"w-5 h-5 ml-4 flex-shrink-0 object-contain"})]})]})]})]}),t.jsx("div",{className:"mt-8 flex-1 flex flex-col justify-end",children:t.jsx("div",{className:"bg-white rounded-t-[30px] pb-8 pt-6 max-w-md mx-auto w-full",children:t.jsx("div",{className:"px-4",children:t.jsx("button",{onClick:()=>{window.open("https://wa.me/79145391376","_blank")},className:"w-full py-3.5 px-6 rounded-3xl text-white font-manrope font-bold text-base shadow-lg active:opacity-90 transition-opacity",style:{background:"#55ACBF"},children:"Связаться с поддержкой"})})})})]})},ig=bt({firstName:ke().min(1,"Введите имя"),lastName:ke().min(1,"Введите фамилию"),phone:ke().min(1,"Введите номер телефона"),city:ke().min(1,"Введите город")}),og=bt({name:ke().min(1,"Введите название организации"),phone:ke().min(1,"Введите номер телефона"),address:ke().min(1,"Введите адрес организации")}),lg=bt({firstName:ke().min(1,"Введите имя"),lastName:ke().min(1,"Введите фамилию")}),cg=bt({firstName:ke().min(1,"Введите имя"),lastName:ke().min(1,"Введите фамилию")}),dg=()=>{const e=rt(),{user:r,logout:s}=Ae(),[a,n]=u.useState(null),[i,o]=u.useState(!1),[c,g]=u.useState(!0),[_,y]=u.useState(null),[D,w]=u.useState(null),[I,P]=u.useState(null),[S,U]=u.useState(!1),O=u.useRef(null),$=xt({resolver:yt(ig)}),p=xt({resolver:yt(og)}),k=xt({resolver:yt(lg)}),f=xt({resolver:yt(cg)});u.useEffect(()=>{(async()=>{if(!r){e("/login");return}try{const v=r.user_metadata?.organization_type;if(v&&["pension","patronage_agency","caregiver"].includes(v)){n(v);try{const{data:J,error:W}=await F.from("organizations").select("*").eq("user_id",r.id).single();if(!W&&J){P(J.avatar_url||null),v==="caregiver"?$.reset({firstName:J.first_name||"",lastName:J.last_name||"",phone:J.phone||"",city:J.city||""}):p.reset({name:J.name||"",phone:J.phone||"",address:J.address||""}),g(!1);return}}catch(J){console.error("Ошибка загрузки организации из БД:",J)}const T=r.user_metadata?.profile_data||r.user_metadata;T&&(v==="caregiver"?$.reset({firstName:T.firstName||T.first_name||"",lastName:T.lastName||T.last_name||"",phone:T.phone||"",city:T.city||""}):p.reset({name:T.name||"",phone:T.phone||"",address:T.address||""})),g(!1);return}let E=r.user_role||r.user_metadata?.user_role||r.user_metadata?.role;if(!E)try{console.log("ProfileEditPage: Role not found in metadata, loading from user_profiles...");const{data:T,error:J}=await F.from("user_profiles").select("role").eq("user_id",r.id).single();!J&&T&&(E=T.role,console.log("ProfileEditPage: Loaded role from user_profiles:",E))}catch(T){console.error("ProfileEditPage: Error loading from user_profiles:",T)}if(console.log("ProfileEditPage: Final userRole:",E),E==="client"){n("client");try{const{data:T,error:J}=await F.from("clients").select("first_name, last_name").eq("user_id",r.id).single();if(!J&&T){f.reset({firstName:T.first_name||"",lastName:T.last_name||""}),g(!1),console.log("✅ ProfileEditPage: Client profile loaded from Supabase");return}else if(J&&J.code==="PGRST116"){console.log("ProfileEditPage: Client record not found, using empty values"),f.reset({firstName:"",lastName:""}),g(!1);return}else J&&(console.error("Error loading client from Supabase:",J),y("Не удалось загрузить профиль клиента"))}catch(T){console.error("Error loading client from Supabase:",T),y("Ошибка при загрузке профиля")}f.reset({firstName:"",lastName:""}),g(!1);return}if(E==="org_employee"){console.log("ProfileEditPage: Detected org_employee, loading profile..."),n("employee");try{const{data:T,error:J}=await F.from("organization_employees").select("first_name, last_name").eq("user_id",r.id).single();if(console.log("ProfileEditPage: DB query result:",{data:T,error:J,hasData:!!T}),!J&&T){k.reset({firstName:T.first_name||"",lastName:T.last_name||""}),g(!1),console.log("✅ ProfileEditPage: Employee profile loaded from Supabase");return}else if(J&&J.code==="PGRST116"){console.log("ProfileEditPage: Employee record not found, using empty values"),k.reset({firstName:"",lastName:""}),g(!1);return}else J&&(console.error("ProfileEditPage: DB error:",J),y("Не удалось загрузить профиль сотрудника"))}catch(T){console.error("ProfileEditPage: Error loading employee from Supabase:",T),y("Ошибка при загрузке профиля")}k.reset({firstName:"",lastName:""}),g(!1);return}}catch(v){y(Et(v))}finally{g(!1)}})()},[r,e,$,p,k,f]);const x=async j=>{if(!(!r||!a)){o(!0),y(null),w(null);try{try{const{error:v}=await F.from("organizations").update({first_name:j.firstName,last_name:j.lastName,name:`${j.firstName} ${j.lastName}`,phone:j.phone,city:j.city}).eq("user_id",r.id);if(v)throw v;w("Профиль успешно обновлен!"),setTimeout(()=>{e("/profile")},2e3)}catch{const{error:E}=await F.auth.updateUser({data:{profile_data:{firstName:j.firstName,lastName:j.lastName,phone:j.phone,city:j.city}}});if(E)throw E;w("Профиль успешно обновлен!"),setTimeout(()=>{e("/profile")},2e3)}}catch(v){y(Et(v))}finally{o(!1)}}},R=async j=>{if(r){o(!0),y(null),w(null);try{const{error:v}=await F.from("clients").update({first_name:j.firstName,last_name:j.lastName}).eq("user_id",r.id);if(v)throw console.error("Error updating client in Supabase:",v),v;console.log("✅ ProfileEditPage: Client profile updated in Supabase"),await F.auth.updateUser({data:{firstName:j.firstName,lastName:j.lastName}}),w("Профиль успешно обновлен!"),setTimeout(()=>{e("/profile")},2e3)}catch(v){console.error("Error saving client profile:",v),y(Et(v)||"Не удалось сохранить изменения. Попробуйте ещё раз.")}finally{o(!1)}}},G=async j=>{if(r){o(!0),y(null),w(null);try{let v=r.organization_id||r.user_metadata?.organization_id;if(!v||v==="temp")try{const{data:W}=await F.from("user_profiles").select("organization_id").eq("user_id",r.id).single();if(W?.organization_id)v=W.organization_id;else{const{data:h}=await F.from("organization_employees").select("organization_id").eq("user_id",r.id).single();h?.organization_id&&(v=h.organization_id)}}catch(W){console.error("ProfileEditPage: Error loading organization_id:",W)}(!v||v==="temp")&&(console.warn("ProfileEditPage: organization_id is still temp, using fallback"),v="temp");const E=r.phone||r.user_metadata?.phone_for_login||r.user_metadata?.phone||null;console.log("ProfileEditPage: Saving employee to Supabase:",{user_id:r.id,organization_id:v,first_name:j.firstName,last_name:j.lastName,phone:E});const{data:T,error:J}=await F.from("organization_employees").select("id").eq("user_id",r.id).single();if(J&&J.code!=="PGRST116")throw console.error("ProfileEditPage: Error checking existing employee:",J),J;if(T){const{error:W}=await F.from("organization_employees").update({first_name:j.firstName,last_name:j.lastName,phone:E||null}).eq("user_id",r.id);if(W)throw console.error("ProfileEditPage: Error updating employee in Supabase:",W),W;console.log("✅ ProfileEditPage: Employee updated in Supabase")}else{const{error:W}=await F.from("organization_employees").insert({user_id:r.id,organization_id:v!=="temp"?v:null,first_name:j.firstName,last_name:j.lastName,phone:E||null,role:"caregiver"});if(W)throw console.error("ProfileEditPage: Error inserting employee in Supabase:",W),W;console.log("✅ ProfileEditPage: Employee created in Supabase")}w("Профиль успешно обновлен!"),setTimeout(()=>{e("/profile")},2e3)}catch(v){y(Et(v))}finally{o(!1)}}},M=()=>{O.current?.click()},L=async j=>{const v=j.target.files?.[0];if(!(!v||!r)){if(!v.type.startsWith("image/")){alert("Пожалуйста, выберите изображение");return}if(v.size>5*1024*1024){alert("Размер файла не должен превышать 5MB");return}U(!0),y(null);try{const E=v.name.split(".").pop(),J=`${r.id}-${Date.now()}.${E}`;console.log('ProfileEditPage: Uploading avatar to bucket "avatars", filePath:',J);const{data:W,error:h}=await F.storage.from("avatars").upload(J,v,{cacheControl:"3600",upsert:!0});if(h){console.error("ProfileEditPage: Upload error:",h),console.error("ProfileEditPage: Upload error details:",{message:h.message,statusCode:h.statusCode,error:h.error});let ee="Не удалось загрузить аватар. ";throw h.message?.includes("Bucket not found")||h.message?.includes("not found")?ee+='Bucket "avatars" не найден. Убедитесь, что bucket создан в Supabase Storage.':h.message?.includes("row-level security")||h.message?.includes("RLS")?ee+="Нет прав на загрузку файла. Обратитесь к администратору для настройки политик Storage.":h.message?.includes("JWT")?ee+="Ошибка аутентификации. Попробуйте выйти и войти снова.":h.message?.includes("size")||h.message?.includes("limit")?ee+="Файл слишком большой. Максимальный размер: 5MB.":ee+=h.message||"Попробуйте еще раз.",new Error(ee)}console.log("ProfileEditPage: File uploaded successfully:",W);const{data:{publicUrl:C}}=F.storage.from("avatars").getPublicUrl(J);console.log("ProfileEditPage: Public URL generated:",C);const{error:Y}=await F.from("organizations").update({avatar_url:C}).eq("user_id",r.id);if(Y)throw Y;P(C),w("Аватар успешно загружен!")}catch(E){console.error("Ошибка загрузки аватара:",E),y("Не удалось загрузить аватар. Попробуйте еще раз.")}finally{U(!1),O.current&&(O.current.value="")}}},B=async j=>{if(!r||!a){console.error("ProfileEditPage: Missing user or organizationType",{user:!!r,organizationType:a}),y("Ошибка: не удалось определить пользователя или тип организации");return}o(!0),y(null),w(null),console.log("ProfileEditPage: Starting save organization profile",{userId:r.id,organizationType:a,data:{name:j.name,phone:j.phone,address:j.address,hasAvatar:!!I}});try{const v={name:j.name.trim(),phone:j.phone.trim(),address:j.address.trim()};I&&(v.avatar_url=I),console.log("ProfileEditPage: Updating organization with data:",v);const{data:E,error:T}=await F.from("organizations").select("id, name, phone, address").eq("user_id",r.id).single();if(T&&T.code!=="PGRST116")throw console.error("ProfileEditPage: Error checking existing organization:",T),new Error(`Ошибка проверки записи: ${T.message}`);if(!E)throw console.error("ProfileEditPage: Organization not found for user_id:",r.id),new Error("Организация не найдена. Обратитесь в поддержку.");console.log("ProfileEditPage: Existing organization found:",E);const{data:J,error:W}=await F.from("organizations").update(v).eq("user_id",r.id).select();if(W)throw console.error("ProfileEditPage: Error updating organization:",W),console.error("ProfileEditPage: Update error details:",{code:W.code,message:W.message,details:W.details,hint:W.hint}),W;if(!J||J.length===0)throw console.error("ProfileEditPage: No data returned after update"),new Error("Не удалось обновить профиль. Попробуйте еще раз.");console.log("✅ ProfileEditPage: Organization profile updated successfully:",J[0]),w("Профиль успешно обновлен!"),setTimeout(()=>{e("/profile")},2e3)}catch(v){console.error("ProfileEditPage: Error saving organization profile:",v);const E=v?.message||Et(v)||"Не удалось сохранить изменения. Попробуйте ещё раз.";y(E),o(!1)}};if(c)return t.jsx("div",{className:"min-h-screen flex items-center justify-center",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"animate-spin w-12 h-12 border-4 border-blue-primary border-t-transparent rounded-full mx-auto mb-4"}),t.jsx("p",{className:"text-gray-600",children:"Загрузка профиля..."})]})});if(!a)return t.jsx("div",{className:"min-h-screen flex items-center justify-center px-4",children:t.jsxs("div",{className:"text-center max-w-md",children:[t.jsx("div",{className:"w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4",children:t.jsx("svg",{className:"w-8 h-8 text-red-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),t.jsx("h1",{className:"text-2xl font-bold text-gray-dark mb-3",children:"Ошибка"}),t.jsx("p",{className:"text-gray-600 text-sm font-manrope mb-6",children:_||"Не удалось загрузить профиль. Пожалуйста, заполните профиль сначала."}),t.jsx(oe,{onClick:()=>e("/profile/setup"),fullWidth:!0,size:"lg",children:"Заполнить профиль"})]})});if(a==="client")return t.jsxs("div",{className:"min-h-screen bg-gray-100",children:[t.jsx("header",{className:"bg-white",children:t.jsxs("div",{className:"flex items-center px-4 py-3 relative",children:[t.jsx("button",{onClick:()=>e("/profile"),className:"mr-4 p-2 -ml-2","aria-label":"Назад",children:t.jsx("img",{src:"/icons/Иконка стрелка.png",alt:"Назад",className:"w-6 h-6 object-contain"})}),t.jsx("h1",{className:"absolute left-1/2 transform -translate-x-1/2 text-lg font-bold text-gray-dark",children:"Настройки"})]})}),t.jsxs("div",{className:"max-w-md mx-auto px-4 py-8",children:[t.jsxs("h2",{className:"text-[32px] font-bold text-gray-dark mb-2 text-center",children:[t.jsx("span",{className:"block",children:"Редактирование"}),t.jsx("span",{className:"block",children:"профиля"})]}),t.jsx("p",{className:"text-gray-600 mb-8 text-center text-sm font-manrope",children:"Клиент"}),D&&t.jsx("div",{className:"mb-6 p-3 bg-green-50 border border-green-200 rounded-xl",children:t.jsx("p",{className:"text-sm font-manrope text-green-600",children:D})}),t.jsx("div",{className:"bg-white rounded-3xl shadow-md p-6",children:t.jsxs("form",{onSubmit:f.handleSubmit(R),className:"space-y-6",children:[t.jsx(he,{label:"Имя",placeholder:"Введите имя",error:f.formState.errors.firstName?.message,fullWidth:!0,...f.register("firstName")}),t.jsx(he,{label:"Фамилия",placeholder:"Введите фамилию",error:f.formState.errors.lastName?.message,fullWidth:!0,...f.register("lastName")}),_&&t.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-xl",children:t.jsx("p",{className:"text-sm font-manrope text-red-600",children:_})}),t.jsx(oe,{type:"submit",fullWidth:!0,isLoading:i,size:"lg",children:"Сохранить изменения"})]})}),t.jsx("div",{className:"mt-6",children:t.jsx("button",{onClick:async()=>{confirm("Вы уверены, что хотите выйти из аккаунта?")&&(await s(),e("/login"))},className:"w-full py-3.5 px-6 rounded-3xl text-white font-manrope font-bold text-base shadow-lg active:opacity-90 transition-opacity",style:{background:"#EF4444"},children:"Выйти из аккаунта"})})]})]});if(a==="employee")return t.jsxs("div",{className:"min-h-screen bg-gray-100",children:[t.jsx("header",{className:"bg-white",children:t.jsxs("div",{className:"flex items-center px-4 py-3 relative",children:[t.jsx("button",{onClick:()=>e("/profile"),className:"mr-4 p-2 -ml-2","aria-label":"Назад",children:t.jsx("img",{src:"/icons/Иконка стрелка.png",alt:"Назад",className:"w-6 h-6 object-contain"})}),t.jsx("h1",{className:"absolute left-1/2 transform -translate-x-1/2 text-lg font-bold text-gray-dark",children:"Настройки"})]})}),t.jsxs("div",{className:"max-w-md mx-auto px-4 py-8",children:[t.jsxs("h2",{className:"text-[32px] font-bold text-gray-dark mb-2 text-center",children:[t.jsx("span",{className:"block",children:"Редактирование"}),t.jsx("span",{className:"block",children:"профиля"})]}),t.jsx("p",{className:"text-gray-600 mb-8 text-center text-sm font-manrope",children:"Сотрудник организации"}),D&&t.jsx("div",{className:"mb-6 p-3 bg-green-50 border border-green-200 rounded-xl",children:t.jsx("p",{className:"text-sm font-manrope text-green-600",children:D})}),t.jsx("div",{className:"bg-white rounded-3xl shadow-md p-6",children:t.jsxs("form",{onSubmit:k.handleSubmit(G),className:"space-y-6",children:[t.jsx(he,{label:"Имя",placeholder:"Введите имя",error:k.formState.errors.firstName?.message,fullWidth:!0,...k.register("firstName")}),t.jsx(he,{label:"Фамилия",placeholder:"Введите фамилию",error:k.formState.errors.lastName?.message,fullWidth:!0,...k.register("lastName")}),_&&t.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-xl",children:t.jsx("p",{className:"text-sm font-manrope text-red-600",children:_})}),t.jsx(oe,{type:"submit",fullWidth:!0,isLoading:i,size:"lg",children:"Сохранить изменения"})]})}),t.jsx("div",{className:"mt-6",children:t.jsx("button",{onClick:async()=>{confirm("Вы уверены, что хотите выйти из аккаунта?")&&(await s(),e("/login"))},className:"w-full py-3.5 px-6 rounded-3xl text-white font-manrope font-bold text-base shadow-lg active:opacity-90 transition-opacity",style:{background:"#EF4444"},children:"Выйти из аккаунта"})})]})]});if(a==="caregiver")return t.jsxs("div",{className:"min-h-screen bg-gray-100",children:[t.jsx("header",{className:"bg-white",children:t.jsxs("div",{className:"flex items-center px-4 py-3 relative",children:[t.jsx("button",{onClick:()=>e("/profile"),className:"mr-4 p-2 -ml-2","aria-label":"Назад",children:t.jsx("img",{src:"/icons/Иконка стрелка.png",alt:"Назад",className:"w-6 h-6 object-contain"})}),t.jsx("h1",{className:"absolute left-1/2 transform -translate-x-1/2 text-lg font-bold text-gray-dark",children:"Настройки"})]})}),t.jsxs("div",{className:"max-w-md mx-auto px-4 py-8",children:[t.jsx("h2",{className:"text-[32px] font-bold text-gray-dark mb-2 text-center",children:"Редактирование профиля"}),t.jsx("p",{className:"text-gray-600 mb-8 text-center text-sm font-manrope",children:"Частная сиделка"}),D&&t.jsx("div",{className:"mb-6 p-3 bg-green-50 border border-green-200 rounded-xl",children:t.jsx("p",{className:"text-sm font-manrope text-green-600",children:D})}),t.jsx("div",{className:"bg-white rounded-3xl shadow-md p-6",children:t.jsxs("form",{onSubmit:$.handleSubmit(x),className:"space-y-6",children:[t.jsx(he,{label:"Имя",placeholder:"Введите имя",error:$.formState.errors.firstName?.message,fullWidth:!0,...$.register("firstName")}),t.jsx(he,{label:"Фамилия",placeholder:"Введите фамилию",error:$.formState.errors.lastName?.message,fullWidth:!0,...$.register("lastName")}),t.jsx(he,{label:"Номер телефона",type:"tel",placeholder:"+7 (999) 123-45-67",error:$.formState.errors.phone?.message,helperText:"Номер телефона нужен для связи с поддержкой в WhatsApp",fullWidth:!0,...$.register("phone")}),t.jsx(he,{label:"Город",placeholder:"Введите город",error:$.formState.errors.city?.message,fullWidth:!0,...$.register("city")}),_&&t.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-xl",children:t.jsx("p",{className:"text-sm font-manrope text-red-600",children:_})}),t.jsx(oe,{type:"submit",fullWidth:!0,isLoading:i,size:"lg",children:"Сохранить изменения"})]})}),t.jsx("div",{className:"mt-6",children:t.jsx("button",{onClick:async()=>{confirm("Вы уверены, что хотите выйти из аккаунта?")&&(await s(),e("/login"))},className:"w-full py-3.5 px-6 rounded-3xl text-white font-manrope font-bold text-base shadow-lg active:opacity-90 transition-opacity",style:{background:"#EF4444"},children:"Выйти из аккаунта"})})]})]});const Z=a==="pension"?"Пансионат":"Патронажное агентство";return t.jsxs("div",{className:"min-h-screen bg-gray-100",children:[t.jsx("header",{className:"bg-white",children:t.jsxs("div",{className:"flex items-center px-4 py-3 relative",children:[t.jsx("button",{onClick:()=>e("/profile"),className:"mr-4 p-2 -ml-2","aria-label":"Назад",children:t.jsx("img",{src:"/icons/Иконка стрелка.png",alt:"Назад",className:"w-6 h-6 object-contain"})}),t.jsx("h1",{className:"absolute left-1/2 transform -translate-x-1/2 text-lg font-bold text-gray-dark",children:"Настройки"})]})}),t.jsxs("div",{className:"max-w-md mx-auto px-4 py-8",children:[t.jsx("h2",{className:"text-[32px] font-bold text-gray-dark mb-2 text-center",children:"Редактирование профиля"}),t.jsx("p",{className:"text-gray-600 mb-8 text-center text-sm font-manrope",children:Z}),D&&t.jsx("div",{className:"mb-6 p-3 bg-green-50 border border-green-200 rounded-xl",children:t.jsx("p",{className:"text-sm text-green-600",children:D})}),t.jsx("div",{className:"bg-white rounded-3xl shadow-md p-6",children:t.jsxs("form",{onSubmit:p.handleSubmit(B),className:"space-y-6",children:[t.jsxs("div",{className:"flex flex-col items-center mb-6",children:[t.jsxs("div",{onClick:M,className:"w-24 h-24 rounded-full flex items-center justify-center overflow-hidden cursor-pointer relative group bg-gray-100 mb-2",children:[I?t.jsx("img",{src:I,alt:"Аватар",className:"w-full h-full object-cover"}):t.jsx("img",{src:"/icons/Иконка профиль.png",alt:"Профиль",className:"w-full h-full object-contain"}),S&&t.jsx("div",{className:"absolute inset-0 bg-black/50 flex items-center justify-center",children:t.jsx("div",{className:"animate-spin w-8 h-8 border-2 border-white border-t-transparent rounded-full"})}),!S&&t.jsx("div",{className:"absolute inset-0 bg-black/0 group-hover:bg-black/30 flex items-center justify-center transition-colors",children:t.jsxs("svg",{className:"w-8 h-8 text-white opacity-0 group-hover:opacity-100 transition-opacity",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"}),t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 13a3 3 0 11-6 0 3 3 0 016 0z"})]})})]}),t.jsx("button",{type:"button",onClick:M,className:"text-sm text-gray-600 hover:text-gray-800 transition-colors",disabled:S,children:S?"Загрузка...":"Выбрать аватар"}),t.jsx("input",{ref:O,type:"file",accept:"image/*",onChange:L,className:"hidden"})]}),t.jsx(he,{label:"Название организации",placeholder:"Введите название организации",error:p.formState.errors.name?.message,fullWidth:!0,...p.register("name")}),t.jsx(he,{label:"Номер телефона",type:"tel",placeholder:"+7 (999) 123-45-67",error:p.formState.errors.phone?.message,helperText:"Номер телефона нужен для связи с поддержкой в WhatsApp",fullWidth:!0,...p.register("phone")}),t.jsx(he,{label:"Адрес организации",placeholder:"Введите адрес места нахождения организации",error:p.formState.errors.address?.message,fullWidth:!0,...p.register("address")}),_&&t.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-xl",children:t.jsx("p",{className:"text-sm text-red-600",children:_})}),t.jsx(oe,{type:"submit",fullWidth:!0,isLoading:i,size:"lg",children:"Сохранить изменения"})]})}),t.jsx("div",{className:"mt-6",children:t.jsx("button",{onClick:async()=>{confirm("Вы уверены, что хотите выйти из аккаунта?")&&(await s(),e("/login"))},className:"w-full py-3.5 px-6 rounded-3xl text-white font-manrope font-bold text-base shadow-lg active:opacity-90 transition-opacity",style:{background:"#EF4444"},children:"Выйти из аккаунта"})})]})]})},gs=async e=>{try{const{data:r,error:s}=await F.from("organization_employees").select("role").eq("user_id",e).single();return s||!r?null:r.role||null}catch(r){return console.error("Ошибка получения роли сотрудника:",r),null}},zn=async e=>{if(!e)return!1;const r=e.user_metadata?.organization_type;if(r&&["pension","patronage_agency","caregiver"].includes(r))return!0;const s=e.user_metadata?.user_role||e.user_metadata?.role;if(s==="client")return!0;if(s==="org_employee"){const a=await gs(e.id);return a==="admin"||a==="manager"}return!1},Pn=async e=>{if(!e)return!1;const r=e.user_metadata?.organization_type;if(r&&["pension","patronage_agency","caregiver"].includes(r))return!0;const s=e.user_metadata?.user_role||e.user_metadata?.role;if(s==="client")return!0;if(s==="org_employee"){const a=await gs(e.id);return a==="admin"||a==="manager"}return!1},ug=async e=>{if(!e)return!1;const r=e.user_metadata?.organization_type;return r&&["pension","patronage_agency"].includes(r)?!0:(e.user_metadata?.user_role||e.user_metadata?.role)==="org_employee"?await gs(e.id)==="manager":!1},mg=async e=>{if(!e)return!1;const r=e.user_metadata?.organization_type;return r&&["pension","patronage_agency"].includes(r)?!0:(e.user_metadata?.user_role||e.user_metadata?.role)==="org_employee"?await gs(e.id)==="manager":!1},pl=async e=>{if(!e)return!1;const r=e.user_metadata?.organization_type;if(r&&["pension","patronage_agency"].includes(r))return!0;const s=e.user_metadata?.user_role||e.user_metadata?.role;if(s==="client")return!0;if(s==="org_employee"){const a=await gs(e.id);return a==="admin"||a==="manager"}return!1},hg=e=>{const r=(Array.isArray(e.patient_card)?e.patient_card[0]:e.patient_card)||e.patient_cards?.[0]||null;return{id:e.id,created_at:e.created_at,status:e.status??"active",patient_card:r?{id:r.id,full_name:r.full_name??"",date_of_birth:r.date_of_birth??null,address:r.address??r.metadata?.address??null}:null}},fo=e=>{if(!e)return null;const r=new Date(e);if(Number.isNaN(r.getTime()))return null;const s=new Date;let a=s.getFullYear()-r.getFullYear();const n=s.getMonth()-r.getMonth();return(n<0||n===0&&s.getDate()<r.getDate())&&(a-=1),a},fg=()=>{const e=rt(),{user:r}=Ae(),[s,a]=u.useState(""),[n,i]=u.useState(r?.user_metadata?.user_role),[o,c]=u.useState(!1);u.useEffect(()=>{(async()=>{if(!r?.id)return;const k=r.user_metadata?.user_role||r.user_metadata?.role;if(k){i(k);return}try{const{data:f,error:x}=await F.from("user_profiles").select("role").eq("user_id",r.id).maybeSingle();!x&&f?.role?i(f.role):x&&x.code!=="PGRST116"&&console.error("Ошибка загрузки роли пользователя:",x)}catch(f){console.error("Ошибка загрузки роли пользователя:",f)}})()},[r]),u.useEffect(()=>{(async()=>{if(!r){c(!1);return}try{const k=await zn(r);c(k)}catch(k){console.error("Ошибка проверки прав на создание:",k),c(!1)}})()},[r]);const g=r?.user_metadata?.organization_type,_=n==="org_employee",y=g==="caregiver"||n==="organization"&&g==="caregiver",{data:D=[],isLoading:w,isError:I,error:P,refetch:S}=ed({queryKey:["dashboard-diaries",r?.id],enabled:!!r,queryFn:async()=>{if(!r)return[];if(console.log("[DashboardPage] Загрузка дневников для пользователя:",{user_id:r.id,userRole:n,organizationType:g,isCaregiver:y}),y){const{data:f,error:x}=await F.from("organizations").select("id, user_id, organization_type").eq("user_id",r.id).eq("organization_type","caregiver").maybeSingle();console.log("[DashboardPage] Данные организации-сиделки:",f,"Ошибка:",x),f&&console.log("[DashboardPage] ID организации-сиделки:",f.id)}const{data:p,error:k}=await F.from("diaries").select(`
            id,
            created_at,
          status,
            caregiver_id,
          organization_id,
          patient_card:patient_card_id (
            id,
            full_name,
            date_of_birth,
            metadata
          )
        `).order("created_at",{ascending:!1});if(k)throw console.error("[DashboardPage] Ошибка загрузки дневников:",k),console.error("[DashboardPage] Детали ошибки:",{message:k.message,details:k.details,hint:k.hint,code:k.code}),k;return console.log("[DashboardPage] Загружено дневников:",p?.length||0),p&&p.length>0?console.log("[DashboardPage] Детали загруженных дневников:",p.map(f=>({id:f.id,caregiver_id:f.caregiver_id,organization_id:f.organization_id,patient_card:f.patient_card}))):(console.log("[DashboardPage] Дневники не загружены. Возможные причины:"),console.log("[DashboardPage] - RLS политики блокируют доступ"),console.log("[DashboardPage] - has_diary_access возвращает false"),console.log("[DashboardPage] - current_organization_id не совпадает с caregiver_id")),p?p.map(hg):[]},retry:1,staleTime:1e3*30}),U=u.useMemo(()=>{const p=s.trim().toLowerCase();return p?D.filter(k=>(k.patient_card?.full_name?.toLowerCase()??"").includes(p)):D},[D,s]),O=()=>{o&&e("/diaries/new")},$=p=>{e(`/diaries/${p}`)};return t.jsxs("div",{className:"min-h-screen bg-gray-100",children:[t.jsxs("div",{className:"max-w-md mx-auto px-4 pt-4 pb-24",children:[t.jsxs("div",{className:"flex items-center justify-between mb-6",children:[t.jsx("h1",{className:"text-2xl font-bold text-gray-dark",children:"Мои дневники"}),t.jsx("button",{onClick:()=>e("/profile"),className:"w-10 h-10 rounded-full flex items-center justify-center hover:opacity-80 transition-opacity flex-shrink-0",children:t.jsx("img",{src:"/icons/Иконка профиль.png",alt:"Профиль",className:"w-10 h-10"})})]}),I&&t.jsxs("div",{className:"rounded-2xl bg-red-50 border border-red-100 px-4 py-3 text-sm text-red-600 mb-6",children:["Не удалось загрузить дневники."," ",t.jsx("button",{onClick:()=>S(),className:"underline font-semibold hover:text-red-700",children:"Повторить попытку"}),t.jsx("pre",{className:"text-xs text-red-400 mt-2 whitespace-pre-wrap break-words",children:String(P?.message??"")})]}),!w&&D.length>0&&!I&&t.jsx("div",{className:"mb-6",children:t.jsx(he,{placeholder:"Поиск по имени подопечного...",value:s,onChange:p=>a(p.target.value),fullWidth:!0})}),w&&t.jsxs("div",{className:"flex items-center justify-center py-12",children:[t.jsx("div",{className:"animate-spin w-8 h-8 border-4 border-blue-primary border-t-transparent rounded-full"}),t.jsx("p",{className:"ml-4 font-manrope text-gray-600",children:"Загрузка дневников..."})]}),!w&&D.length===0&&!I&&t.jsxs("div",{className:"text-center py-8",children:[t.jsx("div",{className:"w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6",style:{background:"linear-gradient(180deg, #7DD3DC 0%, #5CBCC7 100%)"},children:t.jsx("svg",{className:"w-12 h-12 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})})}),t.jsx("h2",{className:"text-xl font-bold text-gray-dark mb-2",children:"У вас пока нет дневников"}),t.jsx("p",{className:"text-sm font-manrope text-gray-600 mb-6",children:y?"Здесь появится дневник здоровья после того, как клиент зарегистрируется и создаст его.":_?"Организация ещё не создала дневники. Как только доступ появится, вы увидите их здесь.":"Создайте первый дневник для подопечного"})]}),!w&&U.length>0&&!I&&t.jsx("div",{className:"space-y-3",children:U.map(p=>t.jsxs("div",{onClick:()=>$(p.id),className:"bg-white rounded-2xl shadow-md p-5 flex items-center justify-between cursor-pointer active:bg-gray-50 transition-colors",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx("h3",{className:"text-lg font-bold text-gray-dark mb-1",children:p.patient_card?.full_name||"Неизвестный"}),t.jsxs("div",{className:"text-sm text-gray-600 space-y-0.5",children:[fo(p.patient_card?.date_of_birth??null)!==null&&t.jsxs("p",{children:["Возраст: ",fo(p.patient_card?.date_of_birth??null)]}),t.jsxs("p",{children:["Адрес: ",p.patient_card?.address||"Адрес не указан"]})]})]}),t.jsx("img",{src:"/icons/иконка маленькая стрелка.png",alt:"",className:"w-5 h-5 ml-4 flex-shrink-0 object-contain"})]},p.id))}),!w&&D.length>0&&U.length===0&&!I&&t.jsx("div",{className:"text-center py-12",children:t.jsxs("p",{className:"font-manrope text-gray-600",children:['Дневники по запросу "',s,'" не найдены']})})]}),!w&&!I&&o&&t.jsx("div",{className:"fixed bottom-0 left-0 right-0 bg-gray-100 p-4 shadow-lg max-w-md mx-auto",children:t.jsx(oe,{onClick:O,fullWidth:!0,children:"+ Создать новый дневник"})})]})},go=[{value:"admin",label:"Администратор"},{value:"manager",label:"Руководитель"},{value:"caregiver",label:"Сиделка"},{value:"doctor",label:"Врач"}],rs={admin:"Администратор",manager:"Руководитель",caregiver:"Сиделка",doctor:"Врач"},gg={admin:"Создание дневников и карточек подопечных, изменение и заполнение дневников",manager:"Создание дневников и карточек, редактирование, раздача доступа клиентам, управление доступом сотрудников, заполнение дневников",caregiver:"Просмотр и заполнение назначенных дневников",doctor:"Просмотр и заполнение назначенных дневников"},Ma=e=>{if(!e)return"Неизвестно";const r=new Date(e);return Number.isNaN(r.getTime())?"Неизвестно":r.toLocaleString("ru-RU",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})},Ta=e=>typeof window>"u"?e:`${window.location.origin}/register?org_token=${e}`,Fa=e=>{if(e==null)return null;const r=String(e);return r==="null"||r==="undefined"||r.trim()===""?null:r},pg=e=>e==="pension"||e==="patronage_agency",xg=()=>{const e=rt(),{user:r}=Ae(),[s,a]=u.useState(null),[n,i]=u.useState(!0),[o,c]=u.useState(null),[g,_]=u.useState([]),[y,D]=u.useState([]),[w,I]=u.useState(!1),[P,S]=u.useState(go[0]?.value??"caregiver"),[U,O]=u.useState(null),[$,p]=u.useState(null),k=u.useCallback(async L=>{if(!L){_([]);return}try{const{data:B,error:Z}=await F.from("organization_employees").select(`
            user_id,
            organization_id,
            first_name,
            last_name,
            phone,
            role,
            created_at,
            organizations!inner (
              organization_type
            )
          `).eq("organization_id",L);if(Z){console.error("Ошибка загрузки сотрудников:",Z),_([]);return}_((B||[]).map(j=>({user_id:j.user_id,organization_id:j.organization_id,organization_type:j.organizations?.organization_type||null,first_name:j.first_name||"",last_name:j.last_name||"",phone:j.phone||null,role:j.role||null,created_at:j.created_at})))}catch(B){console.error("Не удалось загрузить сотрудников:",B),_([])}},[]),f=u.useCallback(async L=>{if(!L){console.log("[EmployeesPage] loadInvites: orgId is null, clearing invites"),D([]);return}console.log("[EmployeesPage] loadInvites: Loading invites for orgId:",L);try{const{data:B,error:Z}=await F.from("invite_tokens").select(`
            id,
            token,
            invite_type,
            created_at,
            expires_at,
            used_at,
            revoked_at,
            organization_invite_tokens (
              organization_id,
              organization_type,
              employee_role
            )
          `).eq("invite_type","organization_employee").is("revoked_at",null).order("created_at",{ascending:!1});if(Z){console.error("[EmployeesPage] Ошибка загрузки приглашений:",Z),D([]);return}console.log("[EmployeesPage] Загружено приглашений (до фильтрации):",B?.length||0,B);const j=(B||[]).map(T=>{const J=Array.isArray(T.organization_invite_tokens)?T.organization_invite_tokens[0]:T.organization_invite_tokens;return{id:T.id,token:T.token,invite_type:T.invite_type,created_at:T.created_at,expires_at:T.expires_at,used_at:T.used_at,revoked_at:T.revoked_at,organization_invite_tokens:J}}).filter(T=>{const J=T.organization_invite_tokens?.organization_id,W=J===L;return W||console.log("[EmployeesPage] Приглашение отфильтровано:",{inviteId:T.id,inviteOrgId:J,expectedOrgId:L}),W});console.log("[EmployeesPage] Отфильтровано приглашений:",j.length);const v=j.filter(T=>!T.used_at),E=j.filter(T=>T.used_at);if(console.log("[EmployeesPage] Активных приглашений:",v.length),console.log("[EmployeesPage] Использованных приглашений:",E.length),E.length>0){const T=E.reduce((J,W)=>J?W.used_at?J.used_at?new Date(W.used_at)>new Date(J.used_at)?W:J:W:J:W,E[0]);p({role:T?.organization_invite_tokens?.employee_role||null,used_at:T?.used_at||null})}D(v)}catch(B){console.error("[EmployeesPage] Не удалось загрузить приглашения:",B),D([])}},[]);u.useEffect(()=>{if(!r){e("/login");return}const L=r.user_metadata?.organization_type??null,B=r.user_metadata?.user_role;if(!pg(L))if(B==="org_employee"){(async()=>{try{const{data:v,error:E}=await F.from("organization_employees").select("role, organization_id").eq("user_id",r.id).maybeSingle();!E&&v&&(v.role==="manager"||v.role==="admin")?console.log("[EmployeesPage] Manager/Admin access granted:",v.role):(e("/dashboard"),i(!1))}catch(v){console.error("[EmployeesPage] Error checking employee role:",v),e("/dashboard"),i(!1)}})();return}else{c("Эта страница доступна только организациям и руководителям."),i(!1);return}(async()=>{if(B==="org_employee"){try{const{data:j,error:v}=await F.from("organization_employees").select("organization_id").eq("user_id",r.id).maybeSingle();if(!v&&j?.organization_id)return console.log("[EmployeesPage] Loaded organization_id from organization_employees:",j.organization_id),j.organization_id}catch(j){console.error("[EmployeesPage] Error loading organization_id from organization_employees:",j)}return null}if(!L)return null;try{const{data:j,error:v}=await F.from("organizations").select("id").eq("user_id",r.id).single();if(v&&v.code==="PGRST116"){const{data:E,error:T}=await F.rpc("create_organization",{p_organization_type:L,p_name:r.user_metadata?.name||r.email||"Организация",p_phone:r.user_metadata?.phone||r.email||"",p_address:r.user_metadata?.address||null});return T?(console.error("Ошибка создания записи организации через RPC:",T),c("Не удалось создать запись организации. Обратитесь в поддержку."),null):(console.log("✅ Организация создана через RPC:",E),E?.id||null)}else{if(v)return console.error("Ошибка проверки организации:",v),null;if(j?.id)return console.log("✅ Организация найдена в БД:",j.id),j.id}}catch(j){return console.error("Ошибка при проверке организации:",j),null}return null})().then(j=>{if(!j){console.warn("[EmployeesPage] Не удалось получить organization_id"),i(!1);return}console.log("[EmployeesPage] Используем organization_id:",j);const v=Fa(j),E=Fa(r.organization_id)||Fa(r.user_metadata?.organization_id),T=v||E;a(T);const J=async()=>{console.log("[EmployeesPage] Загрузка данных для organization_id:",T);try{await Promise.all([k(T),f(T)])}catch(h){console.error("[EmployeesPage] Ошибка при загрузке данных:",h)}finally{i(!1)}};J();const W=setInterval(()=>{console.log("[EmployeesPage] Автоматическое обновление списка сотрудников и приглашений"),J()},3e3);return()=>{clearInterval(W)}}).catch(j=>{console.error("[EmployeesPage] Ошибка при загрузке организации:",j),i(!1)})},[r,e,k,f]),u.useEffect(()=>{if(!$)return;const L=setTimeout(()=>p(null),5e3);return()=>clearTimeout(L)},[$]);const x=async L=>{try{const B=Ta(L);await navigator.clipboard.writeText(B),O(L),setTimeout(()=>O(null),2e3)}catch(B){console.warn("Не удалось скопировать ссылку",B),c("Не удалось скопировать ссылку. Попробуйте ещё раз.")}},R=async L=>{if(!(!L||!window.confirm("Удалить сотрудника и отозвать его доступ?")))try{const{error:Z}=await F.from("organization_employees").delete().eq("user_id",L).eq("organization_id",s);if(Z){console.error("Ошибка удаления сотрудника:",Z),c("Не удалось удалить сотрудника. Попробуйте позже.");return}await k(s)}catch(Z){console.error("Не удалось удалить сотрудника",Z),c("Не удалось удалить сотрудника. Попробуйте позже.")}},G=async L=>{if(window.confirm("Удалить пригласительную ссылку?"))try{const{error:Z}=await F.rpc("revoke_invite_link",{p_invite_id:L});if(Z){console.error("Ошибка отзыва приглашения:",Z),c("Не удалось отозвать приглашение. Попробуйте позже.");return}await f(s)}catch(Z){console.error("Ошибка при отзыве приглашения:",Z),c("Не удалось отозвать приглашение. Попробуйте позже.")}},M=async()=>{if(!s){c("Не удалось определить организацию. Обновите страницу и попробуйте снова.");return}I(!0),c(null);try{const{data:L,error:B}=await F.rpc("generate_invite_link",{invite_type:"organization_employee",payload:{employee_role:P}});if(B){console.error("Ошибка создания приглашения:",B),c(B.message||"Не удалось создать пригласительную ссылку. Попробуйте позже.");return}if(!L||!L.token){c("Не удалось создать пригласительную ссылку. Попробуйте позже.");return}const Z=Ta(L.token);await f(s),O(L.token),await navigator.clipboard.writeText(Z),setTimeout(()=>O(null),2e3)}catch(L){console.error("Не удалось создать пригласительную ссылку",L),c("Не удалось создать пригласительную ссылку. Попробуйте позже.")}finally{I(!1)}};return n?t.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-100",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"animate-spin w-12 h-12 border-4 border-blue-primary border-t-transparent rounded-full mx-auto mb-4"}),t.jsx("p",{className:"text-gray-600",children:"Загрузка сотрудников..."})]})}):o&&!s?t.jsx("div",{className:"min-h-screen flex items-center justify-center px-4 bg-gray-100",children:t.jsxs("div",{className:"max-w-sm text-center",children:[t.jsx("div",{className:"w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4",children:t.jsx("svg",{className:"w-8 h-8 text-red-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),t.jsx("h1",{className:"text-2xl font-bold text-gray-dark mb-3",children:"Нет доступа"}),t.jsx("p",{className:"text-sm text-gray-600 mb-6",children:o}),t.jsx(oe,{onClick:()=>e("/profile"),fullWidth:!0,size:"lg",children:"Вернуться в профиль"})]})}):t.jsxs("div",{className:"min-h-screen bg-gray-100 flex flex-col",children:[t.jsx("header",{className:"bg-white",children:t.jsxs("div",{className:"flex items-center px-4 py-3 relative",children:[t.jsx("button",{onClick:()=>e("/profile"),className:"mr-4 p-2 -ml-2","aria-label":"Назад",children:t.jsx("img",{src:"/icons/Иконка стрелка.png",alt:"Назад",className:"w-6 h-6 object-contain"})}),t.jsx("h1",{className:"absolute left-1/2 transform -translate-x-1/2 text-lg font-bold text-gray-dark",children:"Сотрудники"}),s&&t.jsx("button",{onClick:()=>{i(!0),Promise.all([k(s),f(s)]).finally(()=>i(!1))},className:"ml-auto p-2","aria-label":"Обновить",title:"Обновить список",children:t.jsx("svg",{className:"w-5 h-5 text-gray-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})})})]})}),t.jsxs("main",{className:"flex-1 w-full max-w-md mx-auto px-4 pb-10",children:[o&&s&&t.jsx("div",{className:"bg-red-50 border border-red-200 text-sm text-red-600 rounded-xl p-3 mt-4",children:o}),$&&t.jsxs("div",{className:"mt-4 bg-green-50 border border-green-200 text-sm text-green-700 rounded-xl p-3",children:[t.jsx("p",{className:"font-semibold",children:"Сотрудник успешно зарегистрировался"}),t.jsxs("p",{className:"mt-1 text-xs text-green-600",children:["Роль: ",rs[$.role||""]||"Сотрудник",", время: ",$.used_at?Ma($.used_at):"Неизвестно"]})]}),t.jsxs("section",{className:"mt-6 bg-white rounded-2xl shadow-md p-6",children:[t.jsx("h2",{className:"text-xl font-bold text-gray-dark mb-4",children:"Пригласить специалиста"}),t.jsxs("div",{className:"space-y-4",children:[t.jsx(Wo,{label:"Выберите роль",fullWidth:!0,value:P,onChange:L=>S(L.target.value),options:go}),P&&t.jsxs("div",{className:"bg-gray-50 rounded-xl p-3 border border-gray-200",children:[t.jsx("p",{className:"text-xs font-semibold text-gray-700 mb-1",children:rs[P]?`Права ${rs[P].toLowerCase()}:`:"Права доступа:"}),t.jsx("p",{className:"text-xs text-gray-600",children:gg[P]||"Права не определены"})]}),t.jsx(oe,{onClick:M,fullWidth:!0,size:"lg",isLoading:w,disabled:w,children:w?"Создание ссылки...":"Создать пригласительную ссылку"}),t.jsx("p",{className:"text-xs text-gray-500",children:"Ссылка создаётся мгновенно и автоматически копируется. Передайте её сотруднику в удобном мессенджере."})]})]}),t.jsxs("section",{className:"mt-6",children:[t.jsx("h2",{className:"text-lg font-semibold text-gray-dark mb-3",children:"Активные приглашения"}),y.length===0?t.jsx("div",{className:"bg-white rounded-2xl shadow-sm px-4 py-6 text-center text-sm text-gray-500",children:"Активных приглашений нет. Создайте новую ссылку, чтобы пригласить специалиста."}):t.jsx("div",{className:"space-y-4",children:y.map(L=>{const B=L.token,Z=Ta(L.token),j=L.organization_invite_tokens?.employee_role||"";return t.jsx("div",{className:"bg-white rounded-2xl shadow-sm p-4",children:t.jsxs("div",{className:"flex justify-between items-start gap-3",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-semibold text-gray-dark",children:rs[j]||"Сотрудник"}),t.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Создано: ",Ma(L.created_at)]}),t.jsx("p",{className:"text-xs text-gray-500 break-all mt-2",children:Z})]}),t.jsxs("div",{className:"flex flex-col gap-2 min-w-[96px]",children:[t.jsx(oe,{size:"sm",onClick:()=>x(B),children:U===B?"Скопировано":"Скопировать"}),t.jsx(oe,{size:"sm",variant:"secondary",onClick:()=>G(L.id),children:"Удалить"})]})]})},L.id)})})]}),t.jsxs("section",{className:"mt-8 pb-4",children:[t.jsx("h2",{className:"text-lg font-semibold text-gray-dark mb-3",children:"Сотрудники"}),g.length===0?t.jsx("div",{className:"bg-white rounded-2xl shadow-sm px-4 py-6 text-center text-sm text-gray-500",children:"Пока нет сотрудников. Отправьте приглашение, чтобы добавить специалиста в команду."}):t.jsx("div",{className:"space-y-4",children:g.map(L=>t.jsx("div",{className:"bg-white rounded-2xl shadow-md p-4",children:t.jsxs("div",{className:"flex justify-between gap-3",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-semibold text-gray-dark",children:L.first_name||L.last_name?`${L.first_name??""} ${L.last_name??""}`.trim():"Без имени"}),t.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Роль: ",rs[L.role||""]||"Сотрудник организации"]}),L.phone&&t.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Телефон: ",L.phone]}),t.jsxs("p",{className:"text-xs text-gray-400 mt-1",children:["В организации: ",Ma(L.created_at)]})]}),t.jsx(oe,{size:"sm",variant:"secondary",onClick:()=>R(L.user_id),children:"Удалить"})]})},L.user_id))})]})]})]})},yg=()=>{const e=rt(),{user:r}=Ae(),[s,a]=u.useState([]),[n,i]=u.useState(!0);u.useEffect(()=>{if(!r){e("/login");return}(async()=>{try{i(!0);let S=F.from("patient_cards").select("id, client_id, full_name, date_of_birth, gender, diagnoses, mobility, metadata, created_at");const{data:U,error:O}=await S.order("created_at",{ascending:!1});if(O){console.error("Error loading patient cards from Supabase:",O),a([]);return}const $=(U||[]).map(p=>({id:p.id,client_id:p.client_id,full_name:p.full_name,date_of_birth:p.date_of_birth,address:p.metadata?.address||null,gender:p.gender||"male",diagnoses:Array.isArray(p.diagnoses)?p.diagnoses:[],mobility:p.mobility||"walks",metadata:p.metadata}));a($)}catch(S){console.error("Error loading patient cards:",S),a([])}finally{i(!1)}})()},[r,e]);const[o,c]=u.useState(!1),[g,_]=u.useState(!1);u.useEffect(()=>{(async()=>{if(!r){c(!1),_(!1);return}try{const[S,U]=await Promise.all([zn(r),Pn(r)]);c(S),_(U)}catch(S){console.error("Ошибка проверки прав доступа:",S),c(!1),_(!1)}})()},[r]);const y=()=>o,D=()=>g,w=P=>{if(!P)return null;const S=new Date(P),U=new Date;let O=U.getFullYear()-S.getFullYear();const $=U.getMonth()-S.getMonth();return($<0||$===0&&U.getDate()<S.getDate())&&O--,O};if(n)return t.jsx("div",{className:"min-h-screen bg-gray-100 flex items-center justify-center",children:t.jsx("p",{className:"text-gray-600",children:"Загрузка..."})});const I=y();return t.jsxs("div",{className:"min-h-screen bg-gray-100 pb-32",children:[t.jsx("header",{className:"bg-white shadow-sm",children:t.jsxs("div",{className:"flex items-center px-4 py-3",children:[t.jsx("button",{onClick:()=>e("/profile"),className:"flex items-center justify-center w-6 h-6 mr-3","aria-label":"Назад",children:t.jsx("img",{src:"/icons/Иконка стрелка.png",alt:"Назад",className:"w-full h-full object-contain"})}),t.jsx("h1",{className:"text-lg font-bold text-[#4A4A4A]",children:"Карточки подопечных"})]})}),t.jsx("div",{className:"px-4 py-6 max-w-md mx-auto",children:s.length===0?t.jsx("div",{className:"flex flex-col items-center justify-center min-h-[60vh]",children:t.jsx("p",{className:"text-center text-gray-600 px-8 mb-8 leading-relaxed",children:I?"Для доступа к дневнику подопечного, сначала заполните карточку подопечного по кнопке ниже":"Карточки подопечных пока не назначены. Обратитесь к администратору или клиенту, чтобы получить доступ."})}):t.jsx("div",{className:"space-y-4",children:s.map(P=>{const S=w(P.date_of_birth);return t.jsxs("button",{onClick:()=>{D()?e(`/profile/patient-cards/edit?id=${P.id}`):e(`/profile/patient-cards/view?id=${P.id}&mode=view`)},className:"w-full bg-white rounded-2xl p-5 shadow-sm hover:shadow-md transition-shadow flex items-center justify-between min-h-[100px]",children:[t.jsxs("div",{className:"text-left flex-1",children:[t.jsx("h3",{className:"text-lg font-bold text-[#4A4A4A] mb-1",children:P.full_name}),S&&t.jsxs("p",{className:"text-sm text-gray-500 mb-0.5",children:["Возраст: ",S]}),P.address&&t.jsxs("p",{className:"text-sm text-gray-500",children:["Адрес: ",P.address]})]}),t.jsx("img",{src:"/icons/иконка маленькая стрелка.png",alt:"",className:"w-4 h-4"})]},P.id)})})}),I&&t.jsx("div",{className:"fixed bottom-0 left-0 right-0 p-4 max-w-md mx-auto",children:t.jsx("button",{onClick:()=>e("/profile/patient-cards/new"),className:"w-full bg-gradient-to-r from-[#7DD3DC] to-[#5CBCC7] text-white font-bold py-4 rounded-full shadow-lg",children:s.length===0?"+ Добавить карточку":"Создать новую карточку"})})]})},dn=["male","female"],un=["walks","sits","lies"],bg=bt({full_name:ke().min(1,"Введите ФИО"),date_of_birth:ke().optional(),address:ke().optional(),entrance:ke().optional(),apartment:ke().optional(),gender:ln(dn),has_pets:mf(),diagnoses:Qs(ke()),mobility:ln(un),services:Qs(ke()),service_wishes:Qs(ke())}),Ra=["Деменция","Паркинсон","Альцгеймер","Инсульт","Инфаркт","Перелом шейки бедра"],Oa=["Растирание конечностей","Развивающие игры","Интересный досуг","Напоминать о приеме лекарств","Помощь в кормлении","Мерять давление","Уборка","Стирка","Уколы","Капельницы","Лечение пролежней","Перевязки"],La=()=>{const e=rt(),[r]=Fr(),{user:s}=Ae(),a=r.get("id"),n=r.get("mode")||"edit",i=!!a,o=n==="view",[c,g]=u.useState(null),[_,y]=u.useState(""),[D,w]=u.useState(""),[I,P]=u.useState(""),[S,U]=u.useState(!1),O=s?.user_metadata?.role||s?.user_metadata?.user_role||null,$=s?.user_metadata?.organization_type||null,p=O==="client",k=$==="pension",[f,x]=u.useState(!1),[R,G]=u.useState(!0);u.useEffect(()=>{(async()=>{if(o){x(!1),G(!1);return}try{const A=await Pn(s);x(A)}catch(A){console.error("Ошибка проверки прав доступа:",A),x(!1)}finally{G(!1)}})()},[s,o]);const M=()=>f,{register:L,handleSubmit:B,formState:{errors:Z,isSubmitting:j},setValue:v,watch:E,reset:T,getValues:J}=xt({resolver:yt(bg),defaultValues:{full_name:"",date_of_birth:"",address:"",entrance:"",apartment:"",diagnoses:[],services:[],service_wishes:[],gender:"male",has_pets:!1,mobility:"walks"}}),W=a?`patient_card_draft_${s?.id||"anonymous"}_${a}`:`patient_card_draft_${s?.id||"anonymous"}_new`,h=E("diagnoses")??[],C=E("services")??[],Y=E("service_wishes")??[],ee=E("gender")??dn[0],ae=E("has_pets")??!1,ne=E("mobility")??un[0],b=m=>(m??[]).filter(A=>typeof A=="string"&&A.trim().length>0),Q=m=>({full_name:m.full_name??"",date_of_birth:m.date_of_birth??"",address:m.address??"",entrance:m.entrance??"",apartment:m.apartment??"",gender:m.gender??dn[0],has_pets:m.has_pets??!1,diagnoses:b(m.diagnoses),services:b(m.services),service_wishes:b(m.service_wishes),mobility:m.mobility??un[0]});u.useEffect(()=>{(async()=>{let A={};if(i&&a)try{console.log("PatientCardFormPage: Loading card data for edit mode, cardId:",a);const{data:V,error:le}=await F.from("patient_cards").select("*").eq("id",a).single();if(le){console.error("PatientCardFormPage: Error loading card from Supabase:",le),alert("Ошибка загрузки карточки: "+le.message);return}if(V){console.log("PatientCardFormPage: Card loaded successfully:",V);const se=V.metadata||{};A={full_name:V.full_name||"",date_of_birth:V.date_of_birth||"",address:se.address||"",entrance:se.entrance||"",apartment:se.apartment||"",gender:V.gender||"male",has_pets:se.has_pets||!1,diagnoses:Array.isArray(V.diagnoses)?V.diagnoses:[],services:Array.isArray(se.services)?se.services:[],service_wishes:Array.isArray(se.service_wishes)?se.service_wishes:[],mobility:V.mobility||"walks"},console.log("PatientCardFormPage: Initial values prepared:",A)}}catch(V){console.error("PatientCardFormPage: Error loading patient card from Supabase:",V),alert("Ошибка загрузки карточки");return}if(!i){const V=localStorage.getItem(W);if(V)try{const le=JSON.parse(V);A={...A,...le},console.log("PatientCardFormPage: Loaded draft from localStorage")}catch(le){console.warn("PatientCardFormPage: Не удалось загрузить черновик карточки",le)}}console.log("PatientCardFormPage: Resetting form with values:",A),T(Q(A))})()},[i,a,T,W]),u.useEffect(()=>{const m=E(A=>{localStorage.setItem(W,JSON.stringify(Q(A)))});return()=>m.unsubscribe()},[E,W]),u.useEffect(()=>{k&&v("has_pets",!1,{shouldValidate:!0})},[k,v]);const z=m=>{const A=h;A.includes(m)?v("diagnoses",A.filter(V=>V!==m)):v("diagnoses",[...A,m])},fe=m=>{const A=C;A.includes(m)?v("services",A.filter(V=>V!==m),{shouldDirty:!0,shouldTouch:!0,shouldValidate:!0}):v("services",[...A,m],{shouldDirty:!0,shouldTouch:!0,shouldValidate:!0})},ye=()=>{_.trim()&&!h.includes(_.trim())&&(v("diagnoses",[...h,_.trim()],{shouldDirty:!0,shouldTouch:!0,shouldValidate:!0}),y(""))},ce=()=>{D.trim()&&!C.includes(D.trim())&&(v("services",[...C,D.trim()],{shouldDirty:!0,shouldTouch:!0,shouldValidate:!0}),w(""))},me=()=>{I.trim()&&!Y.includes(I.trim())&&(v("service_wishes",[...Y,I.trim()],{shouldDirty:!0,shouldTouch:!0,shouldValidate:!0}),P(""))},_e=m=>{v("diagnoses",h.filter(A=>A!==m),{shouldDirty:!0,shouldTouch:!0,shouldValidate:!0})},De=m=>{v("services",C.filter(A=>A!==m),{shouldDirty:!0,shouldTouch:!0,shouldValidate:!0})},xe=m=>{v("service_wishes",Y.filter(A=>A!==m),{shouldDirty:!0,shouldTouch:!0,shouldValidate:!0})},ze=async()=>{if(!s)return null;if((s.user_metadata?.role||s.user_metadata?.user_role)==="client")try{const{data:A,error:V}=await F.from("clients").select("id").eq("user_id",s.id).single();if(!V&&A)return A.id}catch(A){console.error("Error resolving client_id:",A)}return($==="pension"||$==="patronage_agency")&&console.log("PatientCardFormPage: Organization creating card without client_id (will be set when client registers)"),null},Ce=()=>{if(!M())return;const m=Q(J());localStorage.setItem(W,JSON.stringify(m))},kt=async m=>{if(console.log("PatientCardFormPage: onSubmit called",{canEdit:M(),user:s?.id,userRole:O,isEditMode:i,cardId:a}),!M()||!s){console.log("PatientCardFormPage: Cannot edit or no user");return}_.trim()&&!h.includes(_.trim())&&ye(),D.trim()&&!C.includes(D.trim())&&ce(),I.trim()&&!Y.includes(I.trim())&&me(),await new Promise(A=>setTimeout(A,100)),m.diagnoses=E("diagnoses"),m.services=E("services"),m.service_wishes=E("service_wishes");try{let A=null;if(i&&a){console.log("PatientCardFormPage: Edit mode, loading existing card");const{data:se,error:ie}=await F.from("patient_cards").select("client_id").eq("id",a).single();if(ie){console.error("PatientCardFormPage: Error loading existing card:",ie),alert("Ошибка при загрузке карточки: "+ie.message);return}se&&(A=se.client_id,console.log("PatientCardFormPage: Found client_id from existing card:",A))}else console.log("PatientCardFormPage: Create mode, resolving client_id"),A=await ze(),console.log("PatientCardFormPage: Resolved client_id:",A);if(!A&&O==="client"){console.error("PatientCardFormPage: client_id is null for client user",{userRole:O,organizationType:$,isEditMode:i}),alert("Не удалось определить клиента. Пожалуйста, войдите в систему заново.");return}!A&&($==="pension"||$==="patronage_agency")&&console.log("PatientCardFormPage: Creating card without client_id (organization will invite client later)");const V={};k?V.has_pets=!1:(m.address&&(V.address=m.address),m.entrance&&(V.entrance=m.entrance),m.apartment&&(V.apartment=m.apartment),V.has_pets=m.has_pets||!1),m.services&&m.services.length>0&&(V.services=m.services),m.service_wishes&&m.service_wishes.length>0&&(V.service_wishes=m.service_wishes);const le={client_id:A,full_name:m.full_name,date_of_birth:m.date_of_birth||null,gender:m.gender,diagnoses:m.diagnoses||[],mobility:m.mobility,metadata:Object.keys(V).length>0?V:null,created_by:s.id};if(i&&a){const{error:se}=await F.from("patient_cards").update(le).eq("id",a);if(se){console.error("Error updating patient card:",se),alert("Ошибка при обновлении карточки: "+se.message);return}}else{const{error:se}=await F.from("patient_cards").insert(le);if(se){console.error("Error creating patient card:",se),alert("Ошибка при создании карточки: "+se.message);return}}localStorage.removeItem(W),e("/profile/patient-cards")}catch(A){console.error("Error saving patient card:",A),alert("Ошибка при сохранении карточки")}},Or=async()=>{if(!(!a||!confirm("Вы уверены, что хотите удалить эту карточку?"))){U(!0);try{const{error:m}=await F.from("patient_cards").delete().eq("id",a);if(m){console.error("Error deleting patient card:",m),alert("Ошибка при удалении карточки: "+m.message);return}localStorage.removeItem(W),e("/profile/patient-cards")}catch(m){console.error("Error deleting patient card:",m),alert("Ошибка при удалении карточки")}finally{U(!1)}}},Ct=m=>{c===m?(m==="diagnoses"&&_.trim()&&!h.includes(_.trim())&&ye(),m==="services"&&(D.trim()&&!C.includes(D.trim())&&ce(),I.trim()&&!Y.includes(I.trim())&&me()),Ce(),g(null)):g(m)};return t.jsxs("div",{className:"min-h-screen bg-gray-100 pb-32",children:[t.jsx("header",{className:"bg-white shadow-sm",children:t.jsxs("div",{className:"flex items-center px-4 py-3",children:[t.jsx("button",{onClick:()=>e("/profile/patient-cards"),className:"flex items-center justify-center w-6 h-6 mr-3","aria-label":"Назад",children:t.jsx("img",{src:"/icons/Иконка стрелка.png",alt:"Назад",className:"w-full h-full object-contain"})}),t.jsx("h1",{className:"text-lg font-bold text-[#4A4A4A]",children:o?"Просмотр карточки":i?"Редактировать карточку":"Новая карточка пациента"})]})}),t.jsxs("div",{className:"px-4 py-6 max-w-md mx-auto",children:[t.jsxs("h2",{className:"text-2xl font-bold text-[#4A4A4A] text-center mb-8",children:["Заполните данные",t.jsx("br",{}),"пациента"]}),t.jsxs("form",{id:"patient-card-form",onSubmit:m=>{B(kt)(m)},className:"space-y-4",children:[t.jsxs("div",{className:"bg-gradient-to-br from-[#A0E7E5] to-[#7DD3DC] rounded-3xl overflow-hidden",children:[t.jsxs("button",{type:"button",onClick:()=>Ct("personal"),className:"w-full px-6 py-5",children:[t.jsx("h3",{className:"text-xl font-bold mb-1 text-[#4A4A4A]",children:"Личные данные"}),c!=="personal"&&t.jsx("p",{className:"text-sm mb-3 text-[#4A4A4A]",children:"ФИО, дата рождения, адрес, пол, животные"}),t.jsx("div",{className:"flex justify-center",children:t.jsx("img",{src:"/icons/иконка маленькая стрелка.png",alt:"",className:`w-4 h-4 transition-transform duration-200 ${c==="personal"?"-rotate-90":"rotate-90"}`,style:{filter:"brightness(0) saturate(100%) invert(29%) sepia(0%) saturate(0%) hue-rotate(174deg) brightness(95%) contrast(88%)"}})})]}),c==="personal"&&t.jsxs("div",{className:"px-6 pb-6 space-y-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"text-sm font-semibold text-[#4A4A4A] mb-2 block",children:"ФИО пациента"}),t.jsx(he,{placeholder:"Введите ФИО пациента",...L("full_name"),error:Z.full_name?.message,className:"bg-white",disabled:!M()})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-sm font-semibold text-[#4A4A4A] mb-2 block",children:"Дата рождения пациента"}),t.jsx(he,{placeholder:"Введите дату рождения пациента",type:"date",...L("date_of_birth"),className:"bg-white",disabled:!M()})]}),!k&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{children:[t.jsx("label",{className:"text-sm font-semibold text-[#4A4A4A] mb-2 block",children:"Адрес пациента"}),t.jsx(he,{placeholder:"Введите адрес пациента",...L("address"),className:"bg-white",disabled:!M()})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"text-sm font-semibold text-[#4A4A4A] mb-2 block",children:"Подъезд"}),t.jsx(he,{placeholder:"№ подъезда",...L("entrance"),className:"bg-white",disabled:!M()})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-sm font-semibold text-[#4A4A4A] mb-2 block",children:"Квартира"}),t.jsx(he,{placeholder:"№ квартиры",...L("apartment"),className:"bg-white",disabled:!M()})]})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-sm font-semibold text-[#4A4A4A] mb-2 block",children:"Выберите пол пациента"}),t.jsxs("div",{className:"flex gap-3",children:[t.jsx("button",{type:"button",onClick:()=>M()&&v("gender","male"),disabled:!M(),className:`flex-1 py-3 rounded-2xl text-sm font-bold transition-all ${ee==="male"?"bg-[#4A9BAD] text-white":"bg-white text-[#4A4A4A]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:"Мужской"}),t.jsx("button",{type:"button",onClick:()=>M()&&v("gender","female"),disabled:!M(),className:`flex-1 py-3 rounded-2xl text-sm font-bold transition-all ${ee==="female"?"bg-[#4A9BAD] text-white":"bg-white text-[#4A4A4A]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:"Женский"})]})]}),!k&&t.jsxs("div",{children:[t.jsx("label",{className:"text-sm font-semibold text-[#4A4A4A] mb-2 block",children:"Есть ли домашние животные?"}),t.jsxs("div",{className:"flex gap-3",children:[t.jsx("button",{type:"button",onClick:()=>{M()&&v("has_pets",!1)},disabled:!M(),className:`flex-1 py-3 rounded-2xl text-sm font-bold transition-all ${ae===!1?"bg-[#4A9BAD] text-white":"bg-white text-[#4A4A4A]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:"Нет"}),t.jsx("button",{type:"button",onClick:()=>{M()&&v("has_pets",!0)},disabled:!M(),className:`flex-1 py-3 rounded-2xl text-sm font-bold transition-all ${ae===!0?"bg-[#4A9BAD] text-white":"bg-white text-[#4A4A4A]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:"Да"})]})]}),M()&&t.jsx(oe,{type:"button",onClick:()=>Ct("personal"),className:"w-full !bg-[#4A9BAD] !text-white font-bold",children:"Готово"})]})]}),t.jsxs("div",{className:"bg-gradient-to-br from-[#5CBCC7] to-[#3D8A9C] rounded-3xl overflow-hidden",children:[t.jsxs("button",{type:"button",onClick:()=>Ct("diagnoses"),className:"w-full px-6 py-5 text-white",children:[t.jsx("h3",{className:"text-xl font-bold mb-1",children:"Болезни"}),c!=="diagnoses"&&t.jsx("p",{className:"text-sm opacity-90 mb-3",children:"Деменция, паркинсон, инсульт, инфаркт и т.д."}),t.jsx("div",{className:"flex justify-center",children:t.jsx("img",{src:"/icons/иконка маленькая стрелка.png",alt:"",className:`w-4 h-4 filter brightness-0 invert transition-transform duration-200 ${c==="diagnoses"?"-rotate-90":"rotate-90"}`})})]}),c==="diagnoses"&&t.jsxs("div",{className:"px-6 pb-6 space-y-4",children:[M()&&t.jsx("p",{className:"text-sm text-white font-semibold",children:"Выберите болезни, если есть"}),t.jsx("div",{className:"flex flex-wrap gap-2",children:Ra.map(m=>t.jsx("button",{type:"button",onClick:()=>M()&&z(m),disabled:!M(),className:`px-4 py-2 rounded-2xl text-sm font-bold transition-all ${h.includes(m)?"bg-[#A0D9E3] text-[#4A4A4A]":"bg-white text-[#4A4A4A]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:m},m))}),h.filter(m=>!Ra.includes(m)).length>0&&t.jsxs("div",{className:"space-y-2",children:[t.jsx("p",{className:"text-sm text-white font-semibold",children:"Добавленные болезни:"}),h.filter(m=>!Ra.includes(m)).map(m=>t.jsxs("div",{className:"flex items-center justify-between bg-white/20 rounded-2xl px-4 py-2",children:[t.jsx("span",{className:"text-white font-medium text-sm",children:m}),M()&&t.jsx("button",{type:"button",onClick:()=>_e(m),className:"text-white hover:text-red-300 ml-2",children:t.jsx("span",{className:"text-lg",children:"🗑"})})]},m))]}),M()&&t.jsxs("div",{className:"flex gap-2",children:[t.jsx(he,{value:_,onChange:m=>y(m.target.value),placeholder:"Добавить болезнь не из списка",className:"flex-1 bg-white"}),t.jsx(oe,{type:"button",onClick:ye,className:"!bg-[#A0D9E3] !text-[#4A4A4A] !px-8 !py-3 !text-2xl !font-bold !min-w-[60px]",children:"+"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-sm font-semibold text-white mb-2 block",children:"Мобильность"}),t.jsx("div",{className:"flex gap-2",children:[{value:"walks",label:"Ходит"},{value:"sits",label:"Сидит"},{value:"lies",label:"Лежит"}].map(m=>t.jsx("button",{type:"button",onClick:()=>{M()&&v("mobility",m.value,{shouldDirty:!0,shouldTouch:!0,shouldValidate:!0})},disabled:!M(),className:`flex-1 py-2 rounded-2xl text-sm font-bold transition-all ${ne===m.value?"bg-[#A0D9E3] text-[#4A4A4A]":"bg-white text-[#4A4A4A]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:m.label},m.value))})]}),M()&&t.jsx(oe,{type:"button",onClick:()=>Ct("diagnoses"),className:"w-full !bg-[#A0D9E3] !text-[#4A4A4A] font-bold",children:"Готово"})]})]}),t.jsxs("div",{className:"bg-gradient-to-br from-[#3D8A9C] to-[#2A6B7A] rounded-3xl overflow-hidden",children:[t.jsxs("button",{type:"button",onClick:()=>Ct("services"),className:"w-full px-6 py-5 text-white",children:[t.jsx("h3",{className:"text-xl font-bold mb-1",children:"Требуемые услуги"}),c!=="services"&&t.jsx("p",{className:"text-sm opacity-90 mb-3",children:"Уколы, стирка, уборка, мерять давление и т.д."}),t.jsx("div",{className:"flex justify-center",children:t.jsx("img",{src:"/icons/иконка маленькая стрелка.png",alt:"",className:`w-4 h-4 filter brightness-0 invert transition-transform duration-200 ${c==="services"?"-rotate-90":"rotate-90"}`})})]}),c==="services"&&t.jsxs("div",{className:"px-6 pb-6 space-y-4",children:[t.jsx("div",{className:"flex flex-wrap gap-2",children:Oa.map(m=>t.jsx("button",{type:"button",onClick:()=>M()&&fe(m),disabled:!M(),className:`px-4 py-2 rounded-2xl text-sm font-bold transition-all ${C.includes(m)?"bg-[#A0D9E3] text-[#4A4A4A]":"bg-white text-[#4A4A4A]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:m},m))}),C.filter(m=>!Oa.includes(m)).length>0&&t.jsxs("div",{className:"space-y-2",children:[t.jsx("p",{className:"text-sm text-white font-semibold",children:"Добавленные услуги:"}),C.filter(m=>!Oa.includes(m)).map(m=>t.jsxs("div",{className:"flex items-center justify-between bg-white/20 rounded-2xl px-4 py-2",children:[t.jsx("span",{className:"text-white font-medium text-sm",children:m}),M()&&t.jsx("button",{type:"button",onClick:()=>De(m),className:"text-white hover:text-red-300 ml-2",children:t.jsx("span",{className:"text-lg",children:"🗑"})})]},m))]}),Y.length>0&&t.jsxs("div",{className:"space-y-2",children:[t.jsx("p",{className:"text-sm text-white font-semibold",children:"Добавленные пожелания:"}),Y.map(m=>t.jsxs("div",{className:"flex items-center justify-between bg-white/20 rounded-2xl px-4 py-2",children:[t.jsx("span",{className:"text-white font-medium text-sm",children:m}),M()&&t.jsx("button",{type:"button",onClick:()=>xe(m),className:"text-white hover:text-red-300 ml-2",children:t.jsx("span",{className:"text-lg",children:"🗑"})})]},m))]}),M()&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"flex gap-2",children:[t.jsx(he,{value:D,onChange:m=>w(m.target.value),placeholder:"Добавить свою услугу",className:"flex-1 bg-white"}),t.jsx(oe,{type:"button",onClick:ce,className:"!bg-[#A0D9E3] !text-[#4A4A4A] !px-8 !py-3 !text-2xl !font-bold !min-w-[60px]",children:"+"})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(he,{value:I,onChange:m=>P(m.target.value),placeholder:"Добавить пожелание",className:"flex-1 bg-white"}),t.jsx(oe,{type:"button",onClick:me,className:"!bg-[#A0D9E3] !text-[#4A4A4A] !px-8 !py-3 !text-2xl !font-bold !min-w-[60px]",children:"+"})]}),t.jsx(oe,{type:"button",onClick:()=>Ct("services"),className:"w-full !bg-[#A0D9E3] !text-[#4A4A4A] font-bold",children:"Готово"})]})]})]})]})]}),t.jsx("div",{className:"fixed bottom-0 left-0 right-0 bg-[#F3F4F6] pb-6 pt-4 px-4 z-10",children:t.jsxs("div",{className:"max-w-md mx-auto",children:[t.jsx(oe,{type:"button",onClick:()=>{console.log("=== Кнопка Сохранить нажата ==="),console.log("errors:",Z),console.log("isSubmitting:",j),console.log("canEdit():",M()),B(m=>(console.log("Валидация прошла успешно"),kt(m)),m=>{console.log("Ошибки валидации:",m);const A=[];m.full_name&&A.push("ФИО пациента"),m.gender&&A.push("Пол пациента"),m.mobility&&A.push("Мобильность"),m.has_pets&&A.push("Наличие животных"),m.address&&A.push("Адрес"),m.entrance&&A.push("Подъезд"),m.apartment&&A.push("Квартира"),alert(`Пожалуйста, заполните обязательные поля:

`+A.join(`
`))})()},disabled:j||!M(),className:"w-full !bg-gradient-to-r !from-[#7DD3DC] !to-[#5CBCC7] !text-white font-bold py-3.5 !rounded-3xl",children:j?"Сохранение...":"Сохранить"}),M()&&i&&!p&&t.jsx("button",{onClick:Or,disabled:S,className:"w-full mt-4 text-sm font-semibold text-[#4A4A4A] disabled:opacity-50",children:S?"Удаление...":"Отвязать карточку"})]})})]})},_g=()=>{const e=rt(),{user:r}=Ae(),[s,a]=u.useState([]),[n,i]=u.useState(!0);return u.useEffect(()=>{(async()=>{if(!r){e("/login");return}try{let c=null;try{const y=new Promise((P,S)=>setTimeout(()=>S(new Error("Timeout")),2e3)),D=F.from("organizations").select("id").eq("user_id",r.id).single(),{data:w,error:I}=await Promise.race([D,y]);if(!I&&w)c=w.id;else{console.log("Organization not found or timeout, using localStorage"),i(!1);return}}catch{console.log("DB query timeout or error, using localStorage"),i(!1);return}const{data:g,error:_}=await F.from("clients").select("id, first_name, last_name, phone, created_at, user_id").eq("invited_by_organization_id",c).order("created_at",{ascending:!1});if(_)console.error("Ошибка загрузки клиентов:",_),a([]);else{const y=(g||[]).map(D=>({id:D.id,first_name:D.first_name||"",last_name:D.last_name||"",phone:D.phone||"",created_at:D.created_at}));a(y),console.log("[ClientsPage] Загружено клиентов:",y.length)}}catch(c){console.error("Error loading clients:",c)}finally{i(!1)}})()},[r,e]),n?t.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-100",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"animate-spin w-12 h-12 border-4 border-blue-primary border-t-transparent rounded-full mx-auto mb-4"}),t.jsx("p",{className:"text-gray-600",children:"Загрузка клиентов..."})]})}):t.jsxs("div",{className:"min-h-screen bg-gray-100 flex flex-col",children:[t.jsx("header",{className:"bg-white",children:t.jsxs("div",{className:"flex items-center px-4 py-3 relative",children:[t.jsx("button",{onClick:()=>e("/profile"),className:"mr-4 p-2 -ml-2","aria-label":"Назад",children:t.jsx("img",{src:"/icons/Иконка стрелка.png",alt:"Назад",className:"w-6 h-6 object-contain"})}),t.jsx("h1",{className:"absolute left-1/2 transform -translate-x-1/2 text-lg font-bold text-gray-dark",children:"Клиенты"})]})}),t.jsx("div",{className:"flex-1 max-w-md mx-auto w-full px-4 pb-8",children:t.jsx("div",{className:"mt-6",children:s.length===0?t.jsxs("div",{className:"bg-white rounded-2xl shadow-md p-8 text-center",children:[t.jsx("p",{className:"text-gray-600 mb-4",children:"Список клиентов пуст"}),t.jsx("p",{className:"text-sm text-gray-500",children:"Клиенты появятся здесь после того, как они зарегистрируются по вашей пригласительной ссылке"})]}):t.jsx("div",{className:"space-y-4",children:s.map(o=>{const c=o.created_at?new Date(o.created_at).toLocaleDateString("ru-RU",{year:"numeric",month:"long",day:"numeric"}):null;return t.jsx("div",{className:"bg-white rounded-2xl shadow-md p-5",children:t.jsx("div",{className:"flex items-center justify-between",children:t.jsxs("div",{className:"flex-1",children:[t.jsxs("p",{className:"text-lg font-bold text-gray-dark mb-1",children:[o.first_name," ",o.last_name]}),o.phone&&t.jsx("p",{className:"text-xs font-manrope text-gray-500 mb-1",children:o.phone}),c&&t.jsxs("p",{className:"text-xs font-manrope text-gray-400",children:["Зарегистрирован: ",c]})]})})},o.id)})})})})]})},vg=()=>{const e=rt(),{user:r}=Ae(),[s,a]=u.useState(null),[n,i]=u.useState(!1),[o,c]=u.useState(!1),[g,_]=u.useState(!1);u.useEffect(()=>{if(!r){e("/login");return}if(r.user_metadata?.organization_type!=="caregiver"){e("/profile");return}},[r,e]);const y=async()=>{if(r){i(!0);try{const{data:P,error:S}=await F.from("organizations").select("id").eq("user_id",r.id).eq("organization_type","caregiver").single();if(S&&S.code==="PGRST116"){console.log("InviteClientPage: Организация не найдена, создаем через RPC");const{data:p,error:k}=await F.rpc("create_organization",{p_organization_type:"caregiver",p_name:`${r.user_metadata?.firstName||""} ${r.user_metadata?.lastName||""}`.trim()||r.email||"Сиделка",p_phone:r.user_metadata?.phone||r.email||"",p_address:null});if(k){console.error("Ошибка создания организации через RPC:",k),alert("Не удалось создать запись организации. Обратитесь в поддержку."),i(!1);return}console.log("✅ Организация создана через RPC:",p)}else if(S){console.error("Ошибка проверки организации:",S),alert("Ошибка при проверке организации. Попробуйте позже."),i(!1);return}const{data:U,error:O}=await F.rpc("generate_invite_link",{invite_type:"caregiver_client",payload:{}});if(O||!U){console.error("Error creating invite token via RPC:",O),alert(O?.message||"Ошибка при создании ссылки. Попробуйте позже."),i(!1);return}const $=`${window.location.origin}/client-invite?token=${U.token}`;a($),console.log("✅ Пригласительная ссылка создана:",$)}catch(P){console.error("Error creating invite link:",P),alert("Ошибка при создании ссылки. Попробуйте позже.")}finally{i(!1)}}},D=async()=>{if(s)try{await navigator.clipboard.writeText(s),c(!0),setTimeout(()=>c(!1),2e3)}catch(P){console.error("Error copying to clipboard:",P),alert("Не удалось скопировать ссылку")}},w=()=>`Приглашаю вас в удобную систему для отслеживания здоровья вашего родственника! ${s}`,I=P=>{if(!s)return;const S=w();let U="";switch(P){case"whatsapp":U=`https://wa.me/?text=${encodeURIComponent(S)}`;break;case"telegram":U=`https://t.me/share/url?url=${encodeURIComponent(s)}&text=${encodeURIComponent(S)}`;break;case"max":U=`https://web.max.ru/share?text=${encodeURIComponent(S)}`;break}U&&(window.open(U,"_blank"),_(!1))};return t.jsxs("div",{className:"min-h-screen bg-gray-100 flex flex-col",children:[t.jsx("header",{className:"bg-white",children:t.jsxs("div",{className:"flex items-center px-4 py-3 relative",children:[t.jsx("button",{onClick:()=>e("/profile"),className:"mr-4 p-2 -ml-2","aria-label":"Назад",children:t.jsx("img",{src:"/icons/Иконка стрелка.png",alt:"Назад",className:"w-6 h-6 object-contain"})}),t.jsx("h1",{className:"absolute left-1/2 transform -translate-x-1/2 text-lg font-bold text-gray-dark",children:"Пригласить клиента"})]})}),t.jsx("div",{className:"flex-1 max-w-md mx-auto w-full px-4 pb-8",children:t.jsx("div",{className:"mt-6",children:t.jsxs("div",{className:"bg-white rounded-2xl shadow-md p-6",children:[t.jsx("h2",{className:"text-xl font-bold text-gray-dark mb-4",children:"Создать пригласительную ссылку"}),t.jsx("p",{className:"text-sm text-gray-600 mb-6",children:"Создайте ссылку для приглашения клиента. Клиент сможет зарегистрироваться и создать карточку подопечного."}),s?t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"bg-gray-50 rounded-xl p-4",children:[t.jsx("p",{className:"text-xs font-manrope text-gray-500 mb-2",children:"Пригласительная ссылка:"}),t.jsx("p",{className:"text-sm font-mono text-gray-800 break-all",children:s})]}),t.jsxs("div",{className:"space-y-3",children:[t.jsx(oe,{onClick:D,variant:"outline",fullWidth:!0,children:o?"Скопировано!":"Копировать ссылку"}),t.jsx(oe,{onClick:()=>_(!0),fullWidth:!0,children:"Поделиться в мессенджере"})]}),t.jsx(oe,{onClick:()=>{a(null),c(!1)},variant:"outline",fullWidth:!0,children:"Создать новую ссылку"})]}):t.jsx(oe,{onClick:y,disabled:n,fullWidth:!0,size:"lg",children:n?"Создание ссылки...":"Создать ссылку"})]})})}),g&&t.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",onClick:()=>_(!1),children:t.jsxs("div",{className:"bg-white rounded-2xl p-6 max-w-sm w-full",onClick:P=>P.stopPropagation(),children:[t.jsx("h3",{className:"text-lg font-bold text-gray-dark mb-4",children:"Выберите мессенджер"}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("button",{onClick:()=>I("whatsapp"),className:"w-full p-4 bg-[#25D366] text-white rounded-xl font-medium hover:bg-opacity-90 transition-opacity flex items-center justify-center gap-2",children:[t.jsx("svg",{className:"w-6 h-6",fill:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{d:"M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"})}),"WhatsApp"]}),t.jsxs("button",{onClick:()=>I("telegram"),className:"w-full p-4 bg-[#0088cc] text-white rounded-xl font-medium hover:bg-opacity-90 transition-opacity flex items-center justify-center gap-2",children:[t.jsx("svg",{className:"w-6 h-6",fill:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{d:"M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"})}),"Telegram"]}),t.jsxs("button",{onClick:()=>I("max"),className:"w-full p-4 bg-[#00A3FF] text-white rounded-xl font-medium hover:bg-opacity-90 transition-opacity flex items-center justify-center gap-2",children:[t.jsx("div",{className:"w-6 h-6 rounded-full bg-white flex items-center justify-center",children:t.jsx("span",{className:"text-[#00A3FF] font-bold text-sm",children:"M"})}),"Макс"]})]}),t.jsx("button",{onClick:()=>_(!1),className:"mt-4 w-full p-3 bg-gray-200 text-gray-dark hover:bg-gray-300 transition-colors rounded-2xl font-medium",children:"Отмена"})]})})]})},po=[{value:"walk",label:"Прогулка"},{value:"cognitive_games",label:"Когнитивные игры"},{value:"diaper_change",label:"Смена подгузников"},{value:"hygiene",label:"Гигиена"},{value:"skin_moisturizing",label:"Увлажнение кожи"},{value:"meal",label:"Прием пищи"},{value:"medications",label:"Прием лекарств"},{value:"vitamins",label:"Прием витаминов"},{value:"sleep",label:"Сон"}],xo=[{value:"temperature",label:"Температура"},{value:"blood_pressure",label:"Артериальное давление"},{value:"breathing_rate",label:"Частота дыхания"},{value:"pain_level",label:"Уровень боли"},{value:"saturation",label:"Сатурация"},{value:"blood_sugar",label:"Уровень сахара в крови"}],yo=[{value:"urination",label:"Выпито/выделено и цвет мочи"},{value:"defecation",label:"Дефекация"}],bo=[{value:"nausea",label:"Тошнота"},{value:"vomiting",label:"Рвота"},{value:"shortness_of_breath",label:"Одышка"},{value:"itching",label:"Зуд"},{value:"cough",label:"Кашель"},{value:"dry_mouth",label:"Сухость во рту"},{value:"hiccups",label:"Икота"},{value:"taste_disturbance",label:"Нарушение вкуса"}],jg=()=>{const e=rt(),{user:r}=Ae(),[s,a]=u.useState(1),[n,i]=u.useState(null),[o,c]=u.useState([]),[g,_]=u.useState([]),[y,D]=u.useState([]),[w,I]=u.useState(!1),[P,S]=u.useState(!1),[U,O]=u.useState([]),[$,p]=u.useState([]),[k,f]=u.useState([]),[x,R]=u.useState([]),[G,M]=u.useState(""),[L,B]=u.useState(""),[Z,j]=u.useState(""),[v,E]=u.useState("");u.useEffect(()=>{if(!r){e("/login");return}(async()=>{try{if(!await zn(r)){alert("У вас нет прав на создание дневников. Обратитесь к администратору организации."),e("/dashboard");return}}catch(z){console.error("Ошибка проверки прав на создание дневников:",z),alert("Ошибка проверки прав доступа"),e("/dashboard");return}})(),(async()=>{try{const z=r.user_metadata?.user_role,fe=r.user_metadata?.organization_type;let ye=F.from("patient_cards").select("*");z==="client"&&(ye=ye.eq("client_id",r.id));const{data:ce,error:me}=await ye;if(me){console.error("Ошибка загрузки карточек:",me),alert("Не удалось загрузить карточки подопечных. Попробуйте позже."),c([]);return}const{data:_e,error:De}=await F.from("diaries").select("patient_card_id, status").eq("status","active");if(De){console.error("Ошибка загрузки дневников:",De),c((ce||[]).map(Ce=>({id:Ce.id,client_id:Ce.client_id||"",full_name:Ce.full_name,date_of_birth:Ce.date_of_birth,gender:Ce.gender,diagnoses:Array.isArray(Ce.diagnoses)?Ce.diagnoses:[],mobility:Ce.mobility})));return}const xe=new Set((_e||[]).map(Ce=>Ce.patient_card_id).filter(Boolean)),ze=(ce||[]).filter(Ce=>!xe.has(Ce.id)).map(Ce=>({id:Ce.id,client_id:Ce.client_id||"",full_name:Ce.full_name,date_of_birth:Ce.date_of_birth,gender:Ce.gender,diagnoses:Array.isArray(Ce.diagnoses)?Ce.diagnoses:[],mobility:Ce.mobility}));c(ze)}catch(z){console.error("Error loading patient cards:",z),alert("Не удалось загрузить карточки подопечных. Попробуйте позже."),c([])}})()},[r,e]);const T=b=>{_(Q=>Q.includes(b)?Q.filter(z=>z!==b):Q.length<3?[...Q,b]:Q)},J=b=>{D(Q=>Q.includes(b)?Q.filter(z=>z!==b):[...Q,b])},W=()=>{G.trim()&&!U.includes(G.trim())&&(O([...U,G.trim()]),M(""))},h=()=>{L.trim()&&!$.includes(L.trim())&&(p([...$,L.trim()]),B(""))},C=()=>{Z.trim()&&!k.includes(Z.trim())&&(f([...k,Z.trim()]),j(""))},Y=()=>{v.trim()&&!x.includes(v.trim())&&(R([...x,v.trim()]),E(""))},ee=(b,Q)=>{b==="care"?(O(U.filter(z=>z!==Q)),_(g.filter(z=>z!==`custom_care_${Q}`)),D(y.filter(z=>z!==`custom_care_${Q}`))):b==="physical"?(p($.filter(z=>z!==Q)),_(g.filter(z=>z!==`custom_physical_${Q}`)),D(y.filter(z=>z!==`custom_physical_${Q}`))):b==="excretion"?(f(k.filter(z=>z!==Q)),_(g.filter(z=>z!==`custom_excretion_${Q}`)),D(y.filter(z=>z!==`custom_excretion_${Q}`))):(R(x.filter(z=>z!==Q)),_(g.filter(z=>z!==`custom_symptom_${Q}`)),D(y.filter(z=>z!==`custom_symptom_${Q}`)))},ae=()=>{s===2?(window.scrollTo({top:0,behavior:"smooth"}),a(1)):e("/dashboard")},ne=async()=>{if(g.length===0&&y.length===0){alert("Необходимо выбрать хотя бы один показатель");return}if(!n||!r)return;if(!o.find(Q=>Q.id===n)){alert("Не удалось найти выбранную карточку подопечного");return}try{const Q=r.user_metadata?.user_role,z=r.user_metadata?.organization_type;let fe=null;if(z==="pension"||z==="patronage_agency")fe=r.id;else if(Q==="org_employee")try{const{data:xe,error:ze}=await F.from("organization_employees").select("organization_id").eq("user_id",r.id).maybeSingle();!ze&&xe&&(fe=xe.organization_id)}catch(xe){console.error("Ошибка загрузки organization_id для сотрудника:",xe)}let ye=null;if(z==="caregiver")try{const{data:xe,error:ze}=await F.from("organizations").select("id").eq("user_id",r.id).eq("type","caregiver").maybeSingle();!ze&&xe?(ye=xe.id,console.log("[CreateDiaryPage] Загружен caregiver_id для сиделки:",ye)):ze&&console.error("Ошибка загрузки caregiver_id для сиделки:",ze)}catch(xe){console.error("Ошибка загрузки caregiver_id для сиделки:",xe)}else if(Q==="client")try{const{data:xe,error:ze}=await F.from("clients").select("invited_by_caregiver_id").eq("user_id",r.id).maybeSingle();!ze&&xe&&(ye=xe.invited_by_caregiver_id)}catch(xe){console.error("Ошибка загрузки caregiver_id для клиента:",xe)}const ce=xe=>xe.startsWith("custom_care_")?{label:xe.replace("custom_care_",""),category:"care"}:xe.startsWith("custom_physical_")?{label:xe.replace("custom_physical_",""),category:"physical"}:xe.startsWith("custom_excretion_")?{label:xe.replace("custom_excretion_",""),category:"excretion"}:xe.startsWith("custom_symptom_")?{label:xe.replace("custom_symptom_",""),category:"symptom"}:{},me=[...g.map(xe=>({metric_key:xe,is_pinned:!0,metadata:ce(xe)})),...y.map(xe=>({metric_key:xe,is_pinned:!1,metadata:ce(xe)}))],{data:_e,error:De}=await F.rpc("create_diary",{p_patient_card_id:n,p_metrics:me,p_organization_id:fe,p_organization_type:z??null,p_caregiver_id:ye});if(De){console.error("Ошибка создания дневника:",De),alert(De.message||"Ошибка при создании дневника");return}if(!_e||!_e.id){alert("Не удалось создать дневник. Попробуйте позже.");return}e(`/diaries/${_e.id}`)}catch(Q){console.error("Error creating diary:",Q),alert("Ошибка при создании дневника")}};return t.jsxs("div",{className:"min-h-screen bg-gray-100",children:[t.jsx("header",{className:"bg-white shadow-sm sticky top-0 z-10",children:t.jsx("div",{className:"flex items-center justify-between px-4 py-3",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("button",{onClick:ae,className:"-ml-2 flex items-center justify-center w-6 h-6","aria-label":"Назад",children:t.jsx("img",{src:"/icons/Иконка стрелка.png",alt:"Назад",className:"w-full h-full object-contain"})}),t.jsx("h1",{className:"text-lg font-bold text-gray-dark",children:s===1?"Выберите карточку подопечного":"Выберите показатели"})]})})}),t.jsxs("div",{className:"px-4 py-6 max-w-md mx-auto pb-24",children:[s===1&&t.jsx("div",{className:"space-y-4",children:o.length===0?t.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-2xl p-6 text-center",children:[t.jsx("p",{className:"text-red-800 font-semibold mb-2",children:"Нет доступных карточек"}),t.jsx("p",{className:"text-red-600 text-sm mb-4",children:"Создайте карточку подопечного, чтобы начать вести дневник"}),t.jsx(oe,{onClick:()=>e("/profile/patient-cards/new"),children:"Создать новую карточку"})]}):t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-2xl p-4 mb-4",children:t.jsx("p",{className:"text-blue-800 text-sm text-center",children:"Выберите карточку подопечного, для которого вы хотите создать дневник"})}),o.map(b=>t.jsx("button",{onClick:()=>{i(b.id),window.scrollTo({top:0,behavior:"smooth"}),a(2)},className:`w-full bg-white rounded-2xl p-4 shadow-sm text-left transition-all relative ${n===b.id?"border-2 border-[#7DD3DC]":"border-2 border-transparent hover:border-gray-200"}`,children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx("h3",{className:"text-lg font-bold text-gray-dark mb-2",children:b.full_name}),b.date_of_birth&&t.jsxs("p",{className:"text-sm text-gray-600",children:["Дата рождения: ",new Date(b.date_of_birth).toLocaleDateString("ru-RU")]}),t.jsxs("p",{className:"text-sm text-gray-600",children:["Пол: ",b.gender==="male"?"Мужской":"Женский"]})]}),t.jsx("img",{src:"/icons/иконка маленькая стрелка.png",alt:"",className:"w-4 h-4 ml-4"})]})},b.id))]})}),s===2&&t.jsxs("div",{className:"space-y-6",children:[t.jsx("div",{className:"bg-transparent border border-[#7DD3DC] rounded-2xl p-3",children:t.jsxs("p",{className:"text-[#4A4A4A] text-xs text-center font-medium",children:["Для ",t.jsx("strong",{children:"закрепленных показателей"})," лучше выбирать показатели, которые нужно замерять через определенный промежуток времени: давление, пульс, температура и др."]})}),t.jsxs("div",{className:"bg-gradient-to-r from-[#7DD3DC] to-[#5CBCC7] rounded-3xl p-6 shadow-md",children:[t.jsx("h2",{className:"text-xl font-bold text-white mb-3 text-center",children:"Закрепленные показатели"}),t.jsx("p",{className:"text-sm text-white opacity-90 mb-4 text-center",children:"Выберите до 3-х показателей для быстрого доступа с таймером заполнения"}),t.jsxs(oe,{variant:"outline",className:"w-full !bg-white !text-[#5CBCC7] !border-none",onClick:()=>I(!0),children:["Выбрать (",g.length,"/3)"]})]}),t.jsxs("div",{className:"bg-white rounded-3xl p-6 shadow-md border-2 border-gray-300",children:[t.jsx("h2",{className:"text-xl font-bold text-gray-dark mb-3 text-center",children:"Все показатели"}),t.jsx("p",{className:"text-sm text-gray-600 mb-4 text-center",children:"Выберите остальные показатели для отслеживания"}),t.jsxs(oe,{variant:"outline",className:"w-full",onClick:()=>S(!0),children:["Выбрать (",y.length,")"]})]}),t.jsx(oe,{onClick:ne,disabled:g.length===0&&y.length===0,className:"w-full",children:"Создать дневник"})]})]}),t.jsx(Hs,{isOpen:w,onClose:()=>I(!1),title:"Выбор показателей (закрепленных)",children:t.jsxs("div",{className:"space-y-6",children:[t.jsx("p",{className:"text-sm text-gray-600 text-center",children:"Чтобы закрепить параметры которые важно не забывать отслеживать - нажмите на него и нажмите на кнопку выбрать, доступно не более 3 параметров"}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-bold text-gray-dark mb-3",children:"Показатели ухода"}),t.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-3",children:[po.map(b=>t.jsx("button",{type:"button",onClick:()=>T(b.value),disabled:!g.includes(b.value)&&g.length>=3,className:`px-4 py-3 rounded-3xl text-sm font-semibold transition-all ${g.includes(b.value)?"bg-[#A0D9E3] text-[#4A4A4A] border-2 border-[#A0D9E3]":"bg-white text-[#4A4A4A] border-2 border-[#7DD3DC]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:b.label},b.value)),U.map(b=>t.jsxs("div",{className:"relative",children:[t.jsx("button",{type:"button",onClick:()=>T(`custom_care_${b}`),disabled:!g.includes(`custom_care_${b}`)&&g.length>=3,className:`w-full px-4 py-3 rounded-3xl text-sm font-semibold transition-all ${g.includes(`custom_care_${b}`)?"bg-[#A0D9E3] text-[#4A4A4A] border-2 border-[#A0D9E3]":"bg-white text-[#4A4A4A] border-2 border-[#7DD3DC]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:b}),t.jsx("button",{type:"button",onClick:()=>ee("care",b),className:"absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs flex items-center justify-center",children:"×"})]},b))]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(he,{value:G,onChange:b=>M(b.target.value),placeholder:"Добавить показатель не из списка",className:"flex-1 bg-white"}),t.jsx(oe,{type:"button",onClick:W,className:"!bg-[#7DD3DC] !text-white px-6",children:"+"})]})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-bold text-gray-dark mb-3",children:"Физические показатели"}),t.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-3",children:[xo.map(b=>t.jsx("button",{type:"button",onClick:()=>T(b.value),disabled:!g.includes(b.value)&&g.length>=3,className:`px-4 py-3 rounded-3xl text-sm font-semibold transition-all ${g.includes(b.value)?"bg-[#A0D9E3] text-[#4A4A4A] border-2 border-[#A0D9E3]":"bg-white text-[#4A4A4A] border-2 border-[#7DD3DC]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:b.label},b.value)),$.map(b=>t.jsxs("div",{className:"relative",children:[t.jsx("button",{type:"button",onClick:()=>T(`custom_physical_${b}`),disabled:!g.includes(`custom_physical_${b}`)&&g.length>=3,className:`w-full px-4 py-3 rounded-3xl text-sm font-semibold transition-all ${g.includes(`custom_physical_${b}`)?"bg-[#A0D9E3] text-[#4A4A4A] border-2 border-[#A0D9E3]":"bg-white text-[#4A4A4A] border-2 border-[#7DD3DC]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:b}),t.jsx("button",{type:"button",onClick:()=>ee("physical",b),className:"absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs flex items-center justify-center",children:"×"})]},b))]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(he,{value:L,onChange:b=>B(b.target.value),placeholder:"Добавить показатель не из списка",className:"flex-1 bg-white"}),t.jsx(oe,{type:"button",onClick:h,className:"!bg-[#7DD3DC] !text-white px-6",children:"+"})]})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-bold text-gray-dark mb-3",children:"Выделение мочи и кала"}),t.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-3",children:[yo.map(b=>t.jsx("button",{type:"button",onClick:()=>T(b.value),disabled:!g.includes(b.value)&&g.length>=3,className:`px-4 py-3 rounded-3xl text-sm font-semibold transition-all ${g.includes(b.value)?"bg-[#A0D9E3] text-[#4A4A4A] border-2 border-[#A0D9E3]":"bg-white text-[#4A4A4A] border-2 border-[#7DD3DC]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:b.label},b.value)),k.map(b=>t.jsxs("div",{className:"relative",children:[t.jsx("button",{type:"button",onClick:()=>T(`custom_excretion_${b}`),disabled:!g.includes(`custom_excretion_${b}`)&&g.length>=3,className:`w-full px-4 py-3 rounded-3xl text-sm font-semibold transition-all ${g.includes(`custom_excretion_${b}`)?"bg-[#A0D9E3] text-[#4A4A4A] border-2 border-[#A0D9E3]":"bg-white text-[#4A4A4A] border-2 border-[#7DD3DC]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:b}),t.jsx("button",{type:"button",onClick:()=>ee("excretion",b),className:"absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs flex items-center justify-center",children:"×"})]},b))]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(he,{value:Z,onChange:b=>j(b.target.value),placeholder:"Добавить показатель не из списка",className:"flex-1 bg-white"}),t.jsx(oe,{type:"button",onClick:C,className:"!bg-[#7DD3DC] !text-white px-6",children:"+"})]})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-bold text-gray-dark mb-3",children:"Тягостные симптомы"}),t.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-3",children:[bo.map(b=>t.jsx("button",{type:"button",onClick:()=>T(b.value),disabled:!g.includes(b.value)&&g.length>=3,className:`px-4 py-3 rounded-3xl text-sm font-semibold transition-all ${g.includes(b.value)?"bg-[#A0D9E3] text-[#4A4A4A] border-2 border-[#A0D9E3]":"bg-white text-[#4A4A4A] border-2 border-[#7DD3DC]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:b.label},b.value)),x.map(b=>t.jsxs("div",{className:"relative",children:[t.jsx("button",{type:"button",onClick:()=>T(`custom_symptom_${b}`),disabled:!g.includes(`custom_symptom_${b}`)&&g.length>=3,className:`w-full px-4 py-3 rounded-3xl text-sm font-semibold transition-all ${g.includes(`custom_symptom_${b}`)?"bg-[#A0D9E3] text-[#4A4A4A] border-2 border-[#A0D9E3]":"bg-white text-[#4A4A4A] border-2 border-[#7DD3DC]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:b}),t.jsx("button",{type:"button",onClick:()=>ee("symptom",b),className:"absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs flex items-center justify-center",children:"×"})]},b))]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(he,{value:v,onChange:b=>E(b.target.value),placeholder:"Добавить показатель не из списка",className:"flex-1 bg-white"}),t.jsx(oe,{type:"button",onClick:Y,className:"!bg-[#7DD3DC] !text-white px-6",children:"+"})]})]}),t.jsx(oe,{onClick:()=>I(!1),className:"w-full !bg-gradient-to-r !from-[#7DD3DC] !to-[#5CBCC7] !text-white font-bold py-4 !rounded-3xl",children:"Выбрать"})]})}),t.jsx(Hs,{isOpen:P,onClose:()=>S(!1),title:"Выбор показателей",children:t.jsxs("div",{className:"space-y-6",children:[t.jsx("p",{className:"text-sm text-gray-600 text-center",children:"Чтобы выбрать индивидуальные параметры которые важно отслеживать - нажмите на него и после выбора всех необходимых нажмите на кнопку выбрать"}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-bold text-gray-dark mb-3",children:"Показатели ухода"}),t.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-3",children:[po.map(b=>t.jsx("button",{type:"button",onClick:()=>J(b.value),disabled:g.includes(b.value),className:`px-4 py-3 rounded-3xl text-sm font-semibold transition-all ${y.includes(b.value)?"bg-[#A0D9E3] text-[#4A4A4A] border-2 border-[#A0D9E3]":g.includes(b.value)?"bg-gray-200 text-gray-500 border-2 border-gray-300":"bg-white text-[#4A4A4A] border-2 border-[#7DD3DC]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:b.label},b.value)),U.map(b=>t.jsxs("div",{className:"relative",children:[t.jsx("button",{type:"button",onClick:()=>J(`custom_care_${b}`),disabled:g.includes(`custom_care_${b}`),className:`w-full px-4 py-3 rounded-3xl text-sm font-semibold transition-all ${y.includes(`custom_care_${b}`)?"bg-[#A0D9E3] text-[#4A4A4A] border-2 border-[#A0D9E3]":g.includes(`custom_care_${b}`)?"bg-gray-200 text-gray-500 border-2 border-gray-300":"bg-white text-[#4A4A4A] border-2 border-[#7DD3DC]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:b}),t.jsx("button",{type:"button",onClick:()=>ee("care",b),className:"absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs flex items-center justify-center",children:"×"})]},`custom_care_${b}`))]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(he,{value:G,onChange:b=>M(b.target.value),placeholder:"Добавить показатель не из списка",className:"flex-1 bg-white"}),t.jsx(oe,{type:"button",onClick:W,className:"!bg-[#7DD3DC] !text-white px-6",children:"+"})]})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-bold text-gray-dark mb-3",children:"Физические показатели"}),t.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-3",children:[xo.map(b=>t.jsx("button",{type:"button",onClick:()=>J(b.value),disabled:g.includes(b.value),className:`px-4 py-3 rounded-3xl text-sm font-semibold transition-all ${y.includes(b.value)?"bg-[#A0D9E3] text-[#4A4A4A] border-2 border-[#A0D9E3]":g.includes(b.value)?"bg-gray-200 text-gray-500 border-2 border-gray-300":"bg-white text-[#4A4A4A] border-2 border-[#7DD3DC]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:b.label},b.value)),$.map(b=>t.jsxs("div",{className:"relative",children:[t.jsx("button",{type:"button",onClick:()=>J(`custom_physical_${b}`),disabled:g.includes(`custom_physical_${b}`),className:`w-full px-4 py-3 rounded-3xl text-sm font-semibold transition-all ${y.includes(`custom_physical_${b}`)?"bg-[#A0D9E3] text-[#4A4A4A] border-2 border-[#A0D9E3]":g.includes(`custom_physical_${b}`)?"bg-gray-200 text-gray-500 border-2 border-gray-300":"bg-white text-[#4A4A4A] border-2 border-[#7DD3DC]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:b}),t.jsx("button",{type:"button",onClick:()=>ee("physical",b),className:"absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs flex items-center justify-center",children:"×"})]},`custom_physical_${b}`))]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(he,{value:L,onChange:b=>B(b.target.value),placeholder:"Добавить показатель не из списка",className:"flex-1 bg-white"}),t.jsx(oe,{type:"button",onClick:h,className:"!bg-[#7DD3DC] !text-white px-6",children:"+"})]})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-bold text-gray-dark mb-3",children:"Выделение мочи и кала"}),t.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-3",children:[yo.map(b=>t.jsx("button",{type:"button",onClick:()=>J(b.value),disabled:g.includes(b.value),className:`px-4 py-3 rounded-3xl text-sm font-semibold transition-all ${y.includes(b.value)?"bg-[#A0D9E3] text-[#4A4A4A] border-2 border-[#A0D9E3]":g.includes(b.value)?"bg-gray-200 text-gray-500 border-2 border-gray-300":"bg-white text-[#4A4A4A] border-2 border-[#7DD3DC]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:b.label},b.value)),k.map(b=>t.jsxs("div",{className:"relative",children:[t.jsx("button",{type:"button",onClick:()=>J(`custom_excretion_${b}`),disabled:g.includes(`custom_excretion_${b}`),className:`w-full px-4 py-3 rounded-3xl text-sm font-semibold transition-all ${y.includes(`custom_excretion_${b}`)?"bg-[#A0D9E3] text-[#4A4A4A] border-2 border-[#A0D9E3]":g.includes(`custom_excretion_${b}`)?"bg-gray-200 text-gray-500 border-2 border-gray-300":"bg-white text-[#4A4A4A] border-2 border-[#7DD3DC]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:b}),t.jsx("button",{type:"button",onClick:()=>ee("excretion",b),className:"absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs flex items-center justify-center",children:"×"})]},`custom_excretion_${b}`))]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(he,{value:Z,onChange:b=>j(b.target.value),placeholder:"Добавить показатель не из списка",className:"flex-1 bg-white"}),t.jsx(oe,{type:"button",onClick:C,className:"!bg-[#7DD3DC] !text-white px-6",children:"+"})]})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-bold text-gray-dark mb-3",children:"Тягостные симптомы"}),t.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-3",children:[bo.map(b=>t.jsx("button",{type:"button",onClick:()=>J(b.value),disabled:g.includes(b.value),className:`px-4 py-3 rounded-3xl text-sm font-semibold transition-all ${y.includes(b.value)?"bg-[#A0D9E3] text-[#4A4A4A] border-2 border-[#A0D9E3]":g.includes(b.value)?"bg-gray-200 text-gray-500 border-2 border-gray-300":"bg-white text-[#4A4A4A] border-2 border-[#7DD3DC]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:b.label},b.value)),x.map(b=>t.jsxs("div",{className:"relative",children:[t.jsx("button",{type:"button",onClick:()=>J(`custom_symptom_${b}`),disabled:g.includes(`custom_symptom_${b}`),className:`w-full px-4 py-3 rounded-3xl text-sm font-semibold transition-all ${y.includes(`custom_symptom_${b}`)?"bg-[#A0D9E3] text-[#4A4A4A] border-2 border-[#A0D9E3]":g.includes(`custom_symptom_${b}`)?"bg-gray-200 text-gray-500 border-2 border-gray-300":"bg-white text-[#4A4A4A] border-2 border-[#7DD3DC]"} disabled:opacity-50 disabled:cursor-not-allowed`,children:b}),t.jsx("button",{type:"button",onClick:()=>ee("symptom",b),className:"absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs flex items-center justify-center",children:"×"})]},`custom_symptom_${b}`))]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(he,{value:v,onChange:b=>E(b.target.value),placeholder:"Добавить показатель не из списка",className:"flex-1 bg-white"}),t.jsx(oe,{type:"button",onClick:Y,className:"!bg-[#7DD3DC] !text-white px-6",children:"+"})]})]}),t.jsx(oe,{onClick:()=>S(!1),className:"w-full !bg-gradient-to-r !from-[#7DD3DC] !to-[#5CBCC7] !text-white font-bold py-4 !rounded-3xl",children:"Выбрать"})]})}),s===1&&o.length>0&&t.jsx("div",{className:"fixed bottom-0 left-0 right-0 bg-white pb-6 pt-4 px-4 z-10 shadow-lg border-t border-gray-200",children:t.jsx("div",{className:"max-w-md mx-auto",children:t.jsx(oe,{onClick:()=>e("/profile/patient-cards/new"),className:"w-full !bg-gradient-to-r !from-[#7DD3DC] !to-[#5CBCC7] !text-white font-bold py-4 !rounded-3xl text-base shadow-md",children:"Создать новую карточку"})})})]})};function Mr(e){if(!e)return"07:00";const r=e.split(":");return r.length>=2?`${r[0].padStart(2,"0")}:${r[1].padStart(2,"0")}`:"07:00"}function ra(e){if(!e)return"07:00:00";const r=e.split(":");return r.length===2?`${r[0].padStart(2,"0")}:${r[1].padStart(2,"0")}:00`:r.length===3?e:"07:00:00"}async function In(e){const{data:r,error:s}=await F.from("route_templates").select("*").eq("diary_id",e).order("created_at",{ascending:!0});return s?(console.error("[routeService] fetchRouteTemplates error:",s),[]):(r&&r.length&&console.log("[routeService] fetchRouteTemplates: found",r.length,"templates for diary",e),r||[])}async function xl(e){if(!e.length)return[];const{data:r,error:s}=await F.from("route_template_slots").select("*").in("template_id",e).order("position",{ascending:!0});return s?(console.error("[routeService] fetchRouteSlots error:",s),[]):(r&&r.length&&console.log("[routeService] fetchRouteSlots: found",r.length,"slots for templates",e),(r||[]).map(a=>({...a,from_time:Mr(a.from_time),to_time:Mr(a.to_time)})))}async function wg(e,r){if(!e.length)return[];let s=F.from("route_assignments").select("*").in("template_id",e);r&&(s=s.or(`event_date.is.null,event_date.eq.${r}`));const{data:a,error:n}=await s;return n?(console.error("[routeService] fetchRouteAssignments error:",n),[]):a||[]}async function Ng(e,r){if(!e.length)return[];const{data:s,error:a}=await F.from("route_events").select("*").in("slot_id",e).eq("event_date",r).order("created_at",{ascending:!1});return a?(console.error("[routeService] fetchRouteEvents error:",a),[]):(s||[]).map(n=>({...n,event_from:Mr(n.event_from),event_to:Mr(n.event_to)}))}async function _o(e,r,s){const a=await In(e);if(!a.length)return[];const n=a.map(O=>O.id),i=new Map(a.map(O=>[O.id,O])),o=await xl(n);if(!o.length)return[];const _=(new Date(r).getDay()+6)%7,y=o.filter(O=>O.day_of_week===null||O.day_of_week===_);if(!y.length)return[];const D=y.map(O=>O.id),w=await wg(n,r),I=new Map;w.forEach(O=>{const $=I.get(O.slot_id);$?O.event_date&&!$.event_date&&I.set(O.slot_id,O):I.set(O.slot_id,O)});const P=await Ng(D,r),S=new Map;P.forEach(O=>{S.has(O.slot_id)||S.set(O.slot_id,O)});const U=[];for(const O of y){const $=i.get(O.template_id);if(!$)continue;const p=I.get(O.id),k=S.get(O.id),f=p?.assigned_employee_id||O.default_assigned_employee;U.push({template_id:$.id,slot_id:O.id,diary_id:$.diary_id,title:$.title,metric_type:$.metric_type,description:$.description,day_of_week:O.day_of_week,from_time:O.from_time,to_time:O.to_time,position:O.position,assigned_employee_id:f||null,allow_multiple_assignments:O.allow_multiple_assignments,event_id:k?.id||null,status:k?.status||null,performed_by:k?.performed_by||null,performed_at:k?.performed_at||null,reason:k?.reason||null,comment:k?.comment||null})}return U.sort((O,$)=>{const p=Tr(O.from_time),k=Tr($.from_time);return p-k}),U}function Tr(e){const[r,s]=e.split(":").map(Number);return(r||0)*60+(s||0)}function yl(e){const r=(e%1440+1440)%1440,s=Math.floor(r/60),a=r%60;return`${String(s).padStart(2,"0")}:${String(a).padStart(2,"0")}`}async function kg(e,r,s,a,n,i,o){try{const{data:c}=await F.from("route_templates").select("id").eq("diary_id",e).eq("metric_type",r).limit(1);let g;if(c&&c.length>0)g=c[0].id,await F.from("route_templates").update({title:s,updated_at:new Date().toISOString()}).eq("id",g),await F.from("route_template_slots").delete().eq("template_id",g);else{const{data:D,error:w}=await F.from("route_templates").insert({diary_id:e,metric_type:r,title:s,created_by:i,organization_id:o||null,visible_to:"organization"}).select("id").single();if(w||!D)return console.error("[routeService] saveRouteTemplate: failed to create template",w),null;g=D.id}const _=[];let y=0;for(const D of a)for(const w of n){const I=w.from||"07:00";let P=w.to??I,S=Tr(I),U=Tr(P);U<=S&&(U=S+1,P=yl(U)),_.push({template_id:g,day_of_week:D,from_time:ra(I),to_time:ra(P),position:y++})}if(_.length>0){const{data:D,error:w}=await F.from("route_template_slots").insert(_).select("id");return w?(console.error("[routeService] saveRouteTemplate: failed to create slots",w),null):{templateId:g,slotIds:(D||[]).map(I=>I.id)}}return{templateId:g,slotIds:[]}}catch(c){return console.error("[routeService] saveRouteTemplate error:",c),null}}async function Cg(e){const r=e.eventFrom||"07:00";let s=e.eventTo??r,a=Tr(r),n=Tr(s);n<=a&&(n=a+1,s=yl(n));const{data:i,error:o}=await F.from("route_events").insert({template_id:e.templateId,slot_id:e.slotId,event_date:e.eventDate,event_from:ra(r),event_to:ra(s),status:e.status,performed_by:e.performedBy||null,performed_at:e.status==="done"?new Date().toISOString():null,reason:e.reason||null,comment:null,created_by:e.createdBy}).select().single();return o?(console.error("[routeService] createRouteEvent error:",o),null):i?{...i,event_from:Mr(i.event_from),event_to:Mr(i.event_to)}:null}function Sg(e,r){const s={};for(const a of e){if(!a.metric_type)continue;const n=r.filter(c=>c.template_id===a.id);if(!n.length)continue;const i=new Set,o=new Map;for(const c of n){c.day_of_week!==null&&i.add(c.day_of_week);const g=`${c.from_time}_${c.to_time}`;o.has(g)||o.set(g,{from:c.from_time,to:c.to_time})}s[a.metric_type]={days:Array.from(i).sort((c,g)=>c-g),times:Array.from(o.values())}}return s}async function Ag(e){const r=await In(e);if(!r.length)return{};const s=r.map(n=>n.id),a=await xl(s);return Sg(r,a)}const Dg=()=>{const[e,r]=u.useState(()=>typeof window<"u"?window.innerWidth:1920);return u.useEffect(()=>{if(typeof window>"u")return;const s=()=>{r(window.innerWidth)};return window.addEventListener("resize",s),()=>window.removeEventListener("resize",s)},[]),e},Eg=({metricType:e,metricLabel:r,lastValue:s,onSave:a,onClose:n,initialTimes:i})=>{const o=u.useMemo(()=>!i||i.length===0?[]:Array.from(new Set(i)).sort(),[i]),[c,g]=u.useState(""),[_,y]=u.useState(()=>i&&i.length>0?[...i].sort():[]),[D,w]=u.useState(()=>i&&i.length>0?[...i].sort()[0]:""),[I,P]=u.useState("Выберите время"),S=u.useRef(!1),U=u.useRef({timeInput:"",times:[],value:"",metricType:""});u.useEffect(()=>{if(i&&i.length>0){const R=[...i].sort();y(R),w(R[0])}else y([]),w(""),P("Выберите время")},[i]),u.useEffect(()=>{U.current={timeInput:D,times:_,value:c,metricType:e},D&&D.trim()!==""&&!_.includes(D)?S.current=!0:(D===""||_.includes(D))&&(S.current=!1)},[D,_,c,e]),u.useEffect(()=>{const R=()=>{const M=U.current;if(S.current&&M.timeInput&&M.timeInput.trim()!==""&&!M.times.includes(M.timeInput)){const L=Array.from(new Set([...M.times,M.timeInput])).sort(),B={value:"",frequency:L.length,reminderStart:L[0]??"",reminderEnd:L[L.length-1]??"",times:L};try{a(M.metricType,B)}catch(Z){console.error("Ошибка сохранения при размонтировании:",Z)}}},G=()=>{R()};return window.addEventListener("beforeunload",G),()=>{window.removeEventListener("beforeunload",G),R()}},[a]);const O=async()=>{let R=[..._];D&&D.trim()!==""&&!R.includes(D)&&(R=Array.from(new Set([...R,D])).sort(),y(R));const G=R.length>0?Array.from(new Set(R)).sort():[],M=c.trim()==="",L=G.length===o.length&&G.every((Z,j)=>Z===o[j]);if(M&&L){n();return}const B={value:c,frequency:G.length,reminderStart:G[0]??"",reminderEnd:G[G.length-1]??"",times:G};try{await a(e,B),S.current=!1,g(""),y(G),w(G[0]??"")}catch(Z){console.error("Ошибка сохранения:",Z)}},$=u.useMemo(()=>_.length===0?[]:Array.from(new Set(_)).sort(),[_]),p=()=>{if($.length===0){P("Выберите время");return}const R=new Date,G=R.getHours()*60+R.getMinutes(),M=$.find(v=>{const[E,T]=v.split(":").map(Number);return E*60+T>G});let L;if(M){const[v,E]=M.split(":").map(Number);L=v*60+E-G}else{const[v,E]=$[0].split(":").map(Number);L=v*60+E+(1440-G)}const B=Math.floor(L/60),Z=L%60,j=(B?`${String(B).padStart(2,"0")}:`:"00:")+String(Z).padStart(2,"0");P(j)};u.useEffect(()=>{p();const R=setInterval(p,60*1e3);return()=>clearInterval(R)},[$]);const k=s||"--",x=Dg()<388;return t.jsxs("div",{className:"bg-gradient-to-br from-[#61B4C6] to-[#317799] rounded-2xl text-white shadow-md grid gap-3 overflow-hidden h-full",style:{gridTemplateColumns:x?"clamp(80px, calc((100% - 16px) / 3), 120px) 1fr":"calc((100% - 24px) / 3) 1fr",minHeight:x?"120px":"140px",padding:x?"8px":"12px",borderRadius:x?"12px":"16px",gap:x?"8px":"12px"},children:[t.jsxs("div",{className:"flex flex-col items-center text-white text-center h-full justify-between min-w-0",style:{fontFamily:"Manrope, sans-serif"},children:[t.jsx("div",{className:"text-base font-bold w-full text-center mb-2",style:{minHeight:x?"32px":"38px",lineHeight:"1.1",display:"flex",alignItems:"center",justifyContent:"center",fontSize:x?"12px":"16px"},children:r}),t.jsx("div",{className:"flex items-center justify-center w-full",style:{height:x?"70px":"90px"},children:t.jsxs("div",{className:"relative flex items-center justify-center",style:{width:x?"70px":"100px",height:x?"70px":"100px",minWidth:x?"70px":"100px",minHeight:x?"70px":"100px"},children:[t.jsxs("svg",{className:"absolute inset-0 w-full h-full",viewBox:"0 0 100 100",preserveAspectRatio:"xMidYMid meet",children:[t.jsx("circle",{cx:"50",cy:"50",r:"42",fill:"url(#circleGradient)",opacity:"0.85"}),t.jsx("circle",{cx:"50",cy:"50",r:"40",fill:"none",stroke:"#ffffff",strokeOpacity:"0.35",strokeWidth:"6",strokeDasharray:"8 8"}),t.jsx("defs",{children:t.jsxs("radialGradient",{id:"circleGradient",cx:"50%",cy:"50%",r:"50%",children:[t.jsx("stop",{offset:"0%",stopColor:"rgba(255,255,255,0.25)"}),t.jsx("stop",{offset:"100%",stopColor:"rgba(0,0,0,0.15)"})]})})]}),t.jsx("div",{className:"relative z-10 flex items-center justify-center text-center",style:{fontFamily:"Manrope, sans-serif",fontWeight:800,fontSize:typeof k=="string"&&k.length<=5?x?"24px":"32px":typeof k=="string"&&k.length<=8?x?"20px":"28px":x?"16px":"22px",color:"#FFFFFF",textShadow:"0 2px 6px rgba(0, 0, 0, 0.25)",minWidth:x?"48px":"64px",padding:x?"0 4px":"0 6px",wordBreak:"break-word"},children:k})]})}),t.jsxs("div",{className:"w-full space-y-1.5 mt-2",children:[t.jsx("div",{className:"text-xs opacity-90 text-center",style:{fontSize:x?"10px":"12px"},children:_.length===0?"Выберите время":`Заполнить через: ${I}`}),t.jsx("button",{onClick:O,className:"w-full text-xs text-white py-1.5 bg-[#4A4A4A] rounded-xl",style:{borderRadius:"12px",fontSize:x?"10px":"12px",paddingTop:x?"4px":"6px",paddingBottom:x?"4px":"6px"},children:"Сохранить"})]})]}),t.jsxs("div",{className:"flex flex-col justify-between gap-1.5 min-w-0 h-full",children:[t.jsxs("div",{className:"rounded-2xl bg-gradient-to-r from-[#7DCAD6] to-[#55ACBF] px-3 py-1.5 w-full",style:{borderRadius:x?"12px":"16px",padding:x?"8px 12px":"12px"},children:[t.jsx("p",{className:"text-[11px] font-semibold mb-1",style:{fontFamily:"Manrope, sans-serif",fontSize:x?"10px":"11px",marginBottom:"4px"},children:"Заполните:"}),t.jsx(he,{type:"text",value:c,onChange:R=>g(R.target.value),placeholder:"Внесите замер",className:"w-full bg-white text-[#4A4A4A] text-xs h-7 rounded-xl px-2.5",style:{fontSize:x?"10px":"12px",height:x?"24px":"28px",padding:x?"4px 10px":"6px 10px",borderRadius:x?"10px":"12px"}})]}),t.jsxs("div",{className:"rounded-2xl bg-gradient-to-r from-[#7DCAD6] to-[#55ACBF] px-3 py-1.5 w-full space-y-2",style:{borderRadius:x?"12px":"16px",padding:x?"8px 12px":"12px",gap:"8px"},children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("p",{className:"text-[11px] font-semibold",style:{fontFamily:"Manrope, sans-serif",fontSize:x?"10px":"11px"},children:"Время заполнения:"}),t.jsxs("span",{className:"text-[11px] opacity-80 whitespace-nowrap",style:{fontFamily:"Manrope, sans-serif",fontSize:x?"10px":"11px"},children:[$.length," ",$.length===1?"раз в день":"раза в день"]})]}),t.jsx("div",{className:"flex flex-wrap gap-2",children:$.map(R=>t.jsxs("span",{className:"inline-flex items-center gap-1 bg-white text-[#4A4A4A] text-xs px-2.5 py-1 rounded-xl",style:{fontSize:x?"10px":"12px",padding:"4px 10px",borderRadius:x?"10px":"12px",gap:"4px"},children:[R,t.jsx("button",{type:"button",onClick:()=>y(G=>{const M=G.filter(L=>L!==R);return M.length===0?(w(""),[]):(M.includes(D)||w(M[0]),M)}),className:"text-[#4A4A4A] text-xs leading-none",style:{fontSize:x?"10px":"12px"},children:"×"})]},R))}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(he,{type:"time",value:D,onChange:R=>w(R.target.value),className:"bg-white text-[#4A4A4A] text-xs h-7 rounded-xl px-2.5 flex-1",style:{fontSize:x?"10px":"12px",height:x?"24px":"28px",padding:x?"4px 10px":"6px 10px",borderRadius:x?"10px":"12px"}}),t.jsx("button",{type:"button",onClick:async()=>{if(!D)return;const R=Array.from(new Set([..._,D])).sort();y(R),w(""),S.current=!1;const G={value:"",frequency:R.length,reminderStart:R[0]??"",reminderEnd:R[R.length-1]??"",times:R};try{await a(e,G)}catch(M){console.error("Ошибка сохранения времени:",M)}},className:"bg-[#A0D9E3] text-[#4A4A4A] text-xl font-bold rounded-xl flex items-center justify-center p-0 border-0 cursor-pointer hover:opacity-80 transition-opacity flex-shrink-0",style:{width:x?"28px":"35px",height:x?"28px":"35px",fontSize:x?"18px":"24px",borderRadius:x?"10px":"12px"},children:"+"})]})]})]})]})},zg=()=>{const[e,r]=u.useState(()=>typeof window<"u"?window.innerWidth:1920);return u.useEffect(()=>{if(typeof window>"u")return;const s=()=>{r(window.innerWidth)};return window.addEventListener("resize",s),()=>window.removeEventListener("resize",s)},[]),e},cr=1440,is=e=>{if(!e||typeof e!="string")return 0;const[r,s]=e.split(":"),a=Number(r),n=Number(s);return Number.isNaN(a)||Number.isNaN(n)?0:((a*60+n)%cr+cr)%cr},vo=e=>{const r=(e%cr+cr)%cr,s=Math.floor(r/60),a=r%60;return`${String(s).padStart(2,"0")}:${String(a).padStart(2,"0")}`},Pg=(e,r,s)=>{const a=Math.max(1,Math.floor(e||1)),n=is(r||"09:00");if(a===1)return[vo(n)];let i=is(s||"21:00");i<=n&&(i+=cr);const o=Math.max(1,Math.floor((i-n)/(a-1)));return Array.from({length:a},(c,g)=>vo(n+g*o))},xr=e=>{const r=typeof e?.reminderStart=="string"?e.reminderStart:"09:00",s=typeof e?.reminderEnd=="string"?e.reminderEnd:"21:00";let a=[];return Array.isArray(e?.times)?a=Array.from(new Set(e.times.map(n=>String(n??"").slice(0,5)).filter(n=>!!n&&n.includes(":")))).sort():typeof e?.frequency=="number"&&e.frequency>0&&(a=Pg(Math.floor(e.frequency),r,s)),a.length===0?{frequency:0,reminderStart:"",reminderEnd:"",times:[]}:(a=Array.from(new Set(a)).sort(),{frequency:a.length,reminderStart:a[0],reminderEnd:a[a.length-1],times:a})},Ig=e=>{if(!e||typeof e!="object")return null;const r=e.id??e.value_id??crypto.randomUUID(),s=e.diary_id??e.diaryId,a=e.metric_type??e.metricType,n=e.created_at??e.createdAt;if(!r||!s||!a||!n)return null;let i;try{i=new Date(n).toISOString()}catch{i=new Date().toISOString()}return{id:String(r),diary_id:String(s),metric_type:String(a),value:e.value,created_at:i}},Er=e=>{const r=new Map;return e.forEach(s=>{const a=Ig(s);if(!a)return;const n=typeof a.value=="object"?JSON.stringify(a.value):String(a.value??""),i=new Date(a.created_at).toISOString().slice(0,19)+"Z",o=`${a.metric_type}_${n}_${i}`;r.has(o)||r.set(o,a)}),Array.from(r.values()).sort((s,a)=>new Date(a.created_at).getTime()-new Date(s.created_at).getTime())},Ba=async(e,r)=>{try{const s=r?new Date(r).toISOString().split("T")[0]:void 0,{data:a,error:n}=await F.rpc("get_diary_history",{p_diary_id:e,p_date:s||null});return n?(console.error("Ошибка загрузки истории:",n),[]):(a||[]).map(i=>{const o=i.payload||{};let c=o.value;return o.value&&typeof o.value=="object"&&"value"in o.value&&(c=o.value.value),{id:o.metric_id||`value_${Date.now()}_${Math.random()}`,diary_id:e,metric_type:o.metric_key||"",value:c||null,created_at:i.occurred_at||new Date().toISOString()}})}catch(s){return console.error("Ошибка загрузки истории:",s),[]}},$g={walk:{variant:"boolean",description:"Отметьте, состоялась ли прогулка у подопечного."},cognitive_games:{variant:"options",description:"Выберите проведённую активность или добавьте свою.",options:["Чтение","Настольные игры","Пазлы","Разговор","Музыка"]},diaper_change:{variant:"boolean",description:"Отметьте, была ли выполнена смена подгузника."},hygiene:{variant:"boolean",description:"Отметьте, проводилась ли гигиена."},skin_moisturizing:{variant:"boolean",description:"Отметьте, было ли увлажнение кожи."},meal:{variant:"text",description:"Опишите, что ели и как прошёл приём пищи.",placeholder:"Например: завтрак — овсянка, чай"},medications:{variant:"text",description:"Укажите, какие лекарства были приняты.",placeholder:"Например: принимаем Энап 5 мг"},vitamins:{variant:"text",description:"Укажите витамины/БАДы и особенности приёма.",placeholder:"Например: витамин D 1000 МЕ"},sleep:{variant:"text",description:"Опишите длительность и качество сна.",placeholder:"Например: спал c 22:30 до 07:00, крепко"},temperature:{variant:"numeric",description:"Запишите измеренную температуру тела.",unit:"°C",min:30,max:45,step:.1},blood_pressure:{variant:"pressure",description:"Укажите систолическое и диастолическое давление, при необходимости пульс."},breathing_rate:{variant:"numeric",description:"Количество вдохов в минуту.",unit:"вдох/мин",min:5,max:60},pulse:{variant:"numeric",description:"Укажите частоту пульса.",unit:"уд/мин",min:20,max:220,step:1},pain_level:{variant:"pain",description:"Оцените уровень боли по шкале от 0 до 10 и опишите, что беспокоит."},saturation:{variant:"numeric",description:"Укажите уровень сатурации кислорода.",unit:"%",min:50,max:100},blood_sugar:{variant:"numeric",description:"Укажите уровень сахара в крови.",unit:"ммоль/л",min:1,max:30,step:.1},urination:{variant:"urination",description:"Отметьте количество выпитой жидкости, выделенной мочи и её цвет."},defecation:{variant:"boolean",description:"Зафиксируйте, была ли дефекация."},nausea:{variant:"boolean",description:"Отметьте, была ли тошнота."},vomiting:{variant:"boolean",description:"Отметьте, была ли рвота."},shortness_of_breath:{variant:"boolean",description:"Зафиксируйте появление одышки."},itching:{variant:"boolean",description:"Зафиксируйте наличие зуда."},cough:{variant:"boolean",description:"Отметьте появление кашля."},dry_mouth:{variant:"boolean",description:"Отметьте ощущение сухости во рту."},hiccups:{variant:"boolean",description:"Зафиксируйте, была ли икота."},taste_disturbance:{variant:"boolean",description:"Отметьте нарушение вкуса."}},jo=[{value:"walk",label:"Прогулка"},{value:"cognitive_games",label:"Когнитивные игры"},{value:"diaper_change",label:"Смена подгузников"},{value:"hygiene",label:"Гигиена"},{value:"skin_moisturizing",label:"Увлажнение кожи"},{value:"meal",label:"Прием пищи"},{value:"medications",label:"Прием лекарств"},{value:"vitamins",label:"Прием витаминов"}],Zs=[{value:"temperature",label:"Температура"},{value:"blood_pressure",label:"Артериальное давление"},{value:"breathing_rate",label:"Частота дыхания"},{value:"pain_level",label:"Уровень боли"},{value:"saturation",label:"Сатурация"},{value:"blood_sugar",label:"Уровень сахара в крови"},{value:"urination",label:"Выпито/выделено и цвет мочи"},{value:"defecation",label:"Дефекация"},{value:"pulse",label:"Пульс"}],wo=[{value:"urination",label:"Выпито/выделено и цвет мочи"},{value:"defecation",label:"Дефекация"}],No=[{value:"nausea",label:"Тошнота"},{value:"vomiting",label:"Рвота"},{value:"shortness_of_breath",label:"Одышка"},{value:"itching",label:"Зуд"},{value:"cough",label:"Кашель"},{value:"dry_mouth",label:"Сухость во рту"},{value:"hiccups",label:"Икота"},{value:"taste_disturbance",label:"Нарушение вкуса"}],Mg=[{value:"walks",label:"Ходит"},{value:"sits",label:"Сидит"},{value:"lies",label:"Лежит"}],Tg=e=>{if(e.startsWith("custom_"))return{variant:"text",description:"Запишите значение показателя.",placeholder:"Введите значение"};const r={variant:"boolean",description:"Зафиксируйте состояние показателя."};return $g[e]||r},Fg=()=>new Date().toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"}),Ua=e=>{const r=e.getTimezoneOffset();return new Date(e.getTime()-r*60*1e3).toISOString().slice(0,10)},Ws=e=>e?new Date(`${e}T00:00:00`):new Date,Rg=({isOpen:e,metricType:r,metricLabel:s,onClose:a,onSave:n})=>{const i=u.useRef(null),o=Tg(r),[c,g]=u.useState(null),[_,y]=u.useState(""),[D,w]=u.useState(""),[I,P]=u.useState(""),[S,U]=u.useState(""),[O,$]=u.useState(0),[p,k]=u.useState(""),[f,x]=u.useState(""),[R,G]=u.useState(""),[M,L]=u.useState(""),[B,Z]=u.useState(""),[j,v]=u.useState([]),[E,T]=u.useState([]),[J,W]=u.useState(""),[h,C]=u.useState(""),Y=u.useMemo(()=>{const Q=o.options||[],z=E.filter(fe=>!Q.includes(fe));return[...Q,...z]},[o.options,E]);if(u.useEffect(()=>{e&&(g(null),y(""),w(""),P(""),U(""),$(3),k(""),x(""),G(""),L(""),Z(""),v([]),T([]),W(""),C(""))},[e,r]),u.useEffect(()=>{const Q=fe=>{i.current&&!i.current.contains(fe.target)&&a()},z=fe=>{fe.key==="Escape"&&a()};return e&&(document.addEventListener("mousedown",Q),document.addEventListener("keydown",z),document.body.style.overflow="hidden"),()=>{document.removeEventListener("mousedown",Q),document.removeEventListener("keydown",z),document.body.style.overflow="unset"}},[e,a]),!e)return null;const ee=()=>{const Q=J.trim();Q&&(v(z=>Array.from(new Set([...z,Q]))),T(z=>Array.from(new Set([...z,Q]))),W(""))},ae=Q=>{v(z=>z.includes(Q)?z.filter(fe=>fe!==Q):[...z,Q])},ne=()=>{switch(o.variant){case"boolean":return c!==null;case"numeric":return _.trim().length>0;case"pressure":return D.trim().length>0&&I.trim().length>0;case"pain":return O>=0;case"urination":return f.trim().length>0||R.trim().length>0||M!=="";case"options":return j.length>0||h.trim().length>0;case"text":return h.trim().length>0;default:return!1}},b=()=>{const Q=Fg();let z="";switch(o.variant){case"boolean":z=`${c?"Было":"Не было"} · ${Q}`;break;case"numeric":{const fe=o.unit?` ${o.unit}`:"";z=`${_}${fe} · ${Q}`;break}case"pressure":{const fe=`${D}/${I}`,ye=S?` · Пульс ${S}`:"";z=`${fe}${ye} · ${Q}`;break}case"pain":{const fe=p.trim()?` · ${p.trim()}`:"";z=`Боль ${O}/10${fe} · ${Q}`;break}case"urination":{const fe=[];f.trim()&&fe.push(`Выпито ${f.trim()} мл`),R.trim()&&fe.push(`Выделено ${R.trim()} мл`),M&&fe.push(`Цвет: ${M}`),B.trim()&&fe.push(B.trim()),z=`${fe.join(" / ")} · ${Q}`;break}case"options":{const fe=[...j];h.trim()&&fe.push(h.trim()),z=`${fe.join(", ")} · ${Q}`;break}case"text":{z=`${h.trim()} · ${Q}`;break}default:z=""}n(z),a()};return t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 px-4",children:t.jsxs("div",{ref:i,className:"w-full max-w-sm rounded-[28px] bg-white shadow-[0_20px_60px_rgba(0,0,0,0.18)] p-6 space-y-6",children:[t.jsxs("div",{className:"text-center space-y-2",children:[t.jsx("h2",{className:"text-xl font-semibold text-[#4A4A4A]",children:s}),o.description&&t.jsx("p",{className:"text-sm text-gray-500 leading-relaxed",children:o.description}),t.jsx("p",{className:"text-xs text-gray-400",children:"Время заполнения фиксируется автоматически"})]}),o.variant==="boolean"&&t.jsx("div",{className:"flex items-center justify-between gap-3",children:[{label:"Было",value:!0},{label:"Не было",value:!1}].map(Q=>{const z=c===Q.value;return t.jsx("button",{onClick:()=>g(Q.value),className:`flex-1 rounded-2xl py-3 text-sm font-semibold transition-all ${z?"bg-gradient-to-r from-[#7DD3DC] to-[#5CBCC7] text-white shadow-md":"bg-white text-[#4A4A4A] border border-[#7DD3DC]"}`,children:Q.label},Q.label)})}),o.variant==="numeric"&&t.jsx("div",{className:"space-y-3",children:t.jsxs("label",{className:"text-sm font-medium text-[#4A4A4A]",children:["Значение",t.jsx(he,{type:"number",value:_,onChange:Q=>y(Q.target.value),min:o.min,max:o.max,step:o.step,className:"mt-2"})]})}),o.variant==="pressure"&&t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Систолическое"}),t.jsx(he,{type:"number",value:D,onChange:Q=>w(Q.target.value),className:"mt-1"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Диастолическое"}),t.jsx(he,{type:"number",value:I,onChange:Q=>P(Q.target.value),className:"mt-1"})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Пульс (опционально)"}),t.jsx(he,{type:"number",value:S,onChange:Q=>U(Q.target.value),className:"mt-1"})]})]}),o.variant==="pain"&&t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-sm text-gray-500",children:"Нет боли"}),t.jsx("span",{className:"text-sm font-semibold text-[#4A4A4A]",children:O}),t.jsx("span",{className:"text-sm text-gray-500",children:"Сильная боль"})]}),t.jsx("input",{type:"range",min:0,max:10,value:O,onChange:Q=>$(Number(Q.target.value)),className:"w-full accent-[#7DD3DC]"}),t.jsx("textarea",{value:p,onChange:Q=>k(Q.target.value),placeholder:"Что болит или беспокоит?",className:"w-full min-h-[72px] rounded-2xl border border-gray-200 px-4 py-3 text-sm focus:border-[#7DD3DC] focus:outline-none"})]}),o.variant==="urination"&&t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Выпито (мл)"}),t.jsx(he,{type:"number",value:f,onChange:Q=>x(Q.target.value),className:"mt-1"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Выделено (мл)"}),t.jsx(he,{type:"number",value:R,onChange:Q=>G(Q.target.value),className:"mt-1"})]}),t.jsx("div",{className:"flex gap-2",children:["светлая","нормальная","тёмная"].map(Q=>{const z=M===Q;return t.jsx("button",{onClick:()=>L(Q),className:`flex-1 rounded-2xl py-2 text-xs font-semibold capitalize transition-all ${z?"bg-gradient-to-r from-[#7DD3DC] to-[#5CBCC7] text-white shadow-md":"bg-white text-[#4A4A4A] border border-[#7DD3DC]"}`,children:Q},Q)})}),t.jsx("textarea",{value:B,onChange:Q=>Z(Q.target.value),placeholder:"Комментарий (опционально)",className:"w-full min-h-[68px] rounded-2xl border border-gray-200 px-4 py-3 text-sm focus:border-[#7DD3DC] focus:outline-none"})]}),o.variant==="options"&&t.jsxs("div",{className:"space-y-4",children:[Y.length>0&&t.jsx("div",{className:"flex flex-wrap gap-2",children:Y.map(Q=>{const z=j.includes(Q);return t.jsx("button",{onClick:()=>ae(Q),className:`px-4 py-2 rounded-2xl text-xs font-semibold transition-all ${z?"bg-gradient-to-r from-[#7DD3DC] to-[#5CBCC7] text-white shadow-md":"bg-white text-[#4A4A4A] border border-[#7DD3DC]"}`,children:Q},Q)})}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(he,{value:J,onChange:Q=>W(Q.target.value),placeholder:"Своя активность"}),t.jsx("button",{onClick:ee,className:"px-4 py-2 rounded-2xl bg-[#7DD3DC] text-white text-sm font-semibold hover:opacity-90 transition-opacity",children:"Добавить"})]}),t.jsx("textarea",{value:h,onChange:Q=>C(Q.target.value),placeholder:"Комментарий (опционально)",className:"w-full min-h-[68px] rounded-2xl border border-gray-200 px-4 py-3 text-sm focus:border-[#7DD3DC] focus:outline-none"})]}),o.variant==="text"&&t.jsx("div",{className:"space-y-3",children:t.jsx(he,{type:"text",value:h,onChange:Q=>C(Q.target.value),placeholder:o.placeholder||"Введите значение",className:"w-full"})}),t.jsxs("div",{className:"flex items-center gap-3 pt-2",children:[t.jsx("button",{onClick:a,className:"flex-1 rounded-2xl bg-gray-200 text-[#4A4A4A] font-semibold py-3 hover:bg-gray-300 transition-colors",children:"Отмена"}),t.jsx("button",{onClick:b,disabled:!ne(),className:"flex-1 rounded-2xl bg-gradient-to-r from-[#7DD3DC] to-[#5CBCC7] text-white font-semibold py-3 shadow-md disabled:opacity-60 disabled:cursor-not-allowed transition-opacity",children:"Сохранить"})]})]})})},Og=()=>{const{id:e}=Io(),r=rt(),s=Rr(),{user:a}=Ae(),[n]=Fr(),i=typeof window<"u"?window.location.origin:"",o=u.useMemo(()=>{const l=d=>{if(d==null)return null;const N=String(d);return N==="null"||N==="undefined"||N.trim()===""?null:N};try{const d=JSON.parse(localStorage.getItem("current_user")||"{}");return d&&typeof d=="object"&&("organization_id"in d&&(d.organization_id=l(d.organization_id)),"caregiver_id"in d&&(d.caregiver_id=l(d.caregiver_id))),d}catch(d){return console.warn("Не удалось прочитать current_user",d),{}}},[]),[c,g]=u.useState(o.user_role||a?.user_metadata?.user_role||null);u.useEffect(()=>{(async()=>{if(!c&&a?.id)try{const{data:d,error:N}=await F.from("user_profiles").select("role").eq("user_id",a.id).single();!N&&d?.role?(console.log("[DiaryPage] Загружена роль из user_profiles:",d.role),g(d.role)):N&&console.error("[DiaryPage] Ошибка загрузки роли из user_profiles:",N)}catch(d){console.error("Ошибка загрузки роли из user_profiles:",d)}})()},[a?.id,c]);const _=o.organization_type||a?.user_metadata?.organization_type,y=_==="pension"||_==="patronage_agency",D=c==="client",w=_==="caregiver",I=c==="org_employee",P=y&&!I,S=a?.id||o.id||o.user_id||o.user?.id||o.user_metadata?.user_id||null,U=l=>{if(l==null)return null;const d=String(l);return d==="null"||d==="undefined"||d.trim()===""?null:d},O=U(o.organization_id||a?.user_metadata?.organization_id||a?.organization_id),$=U(o.caregiver_id||a?.user_metadata?.caregiver_id||a?.caregiver_id),p=O||(P?S:null),k=u.useMemo(()=>Ua(new Date),[]),[f,x]=u.useState(null),[R,G]=u.useState(null),[M,L]=u.useState([]),[B,Z]=u.useState([]),[j,v]=u.useState("diary"),[E,T]=u.useState(null),[J,W]=u.useState(!1),[h,C]=u.useState({}),[Y,ee]=u.useState(null),[ae,ne]=u.useState(!1),[b,Q]=u.useState(!1),[z,fe]=u.useState(!1),[ye,ce]=u.useState([]),me=l=>{ce(d=>d.includes(l)?d.filter(N=>N!==l):[...d,l])},[_e,De]=u.useState(()=>jo),xe=u.useRef(new Set(jo.map(l=>l.value))),[ze,Ce]=u.useState(""),[kt,Or]=u.useState(()=>Zs),Ct=u.useRef(new Set(Zs.map(l=>l.value))),[m,A]=u.useState(""),V=()=>{const l=m.trim();if(!l)return;const d=se(l);Or(N=>{if(N.some(K=>K.value===d)){const K=`${d}_${Date.now().toString(36)}`;return[...N,{value:K,label:l}]}return[...N,{value:d,label:l}]}),ce(N=>N.includes(d)?N:[...N,d]),A("")},le=l=>{l.key==="Enter"&&(l.preventDefault(),V())},se=l=>{let d=l.toLowerCase().trim().replace(/\s+/g,"_").replace(/[^\w\u0400-\u04FF0-9_]/g,"").slice(0,60);return d||(d=`custom_${Date.now().toString(36)}`),d},ie=()=>{const l=ze.trim();if(!l)return;const d=se(l);De(N=>{if(N.some(K=>K.value===d)){const K=`${d}_${Date.now().toString(36)}`;return[...N,{value:K,label:l}]}return[...N,{value:d,label:l}]}),ce(N=>N.includes(d)?N:[...N,d]),Ce("")},be=l=>{l.key==="Enter"&&(l.preventDefault(),ie())},$e=l=>{xe.current.has(l)||(De(d=>d.filter(N=>N.value!==l)),ce(d=>d.filter(N=>N!==l)))},Me=l=>{Ct.current.has(l)||(Or(d=>d.filter(N=>N.value!==l)),ce(d=>d.filter(N=>N!==l)))},[ot,Qt]=u.useState(!1),[Pt,Lr]=u.useState(null),[Xt,kr]=u.useState({}),[Br,Ur]=u.useState([]),[ps,xs]=u.useState([]),[bl,$n]=u.useState(!1),_l=async(l,d)=>{if(e&&S){const N=nt(l),K=await kg(e,l,N,d.days,d.times,S,ut||null);K?console.log("[DiaryPage] route schedule saved to DB:",l,K):console.warn("[DiaryPage] Failed to save route schedule to DB, falling back to localStorage")}kr(N=>({...N,[l]:d})),console.log("[DiaryPage] route schedule updated:",l,d)};u.useEffect(()=>{if(!e)return;(async()=>{try{const d=await Ag(e);kr(d),console.log("[DiaryPage] Loaded routeSchedules from Supabase",d)}catch(d){console.warn("[DiaryPage] Failed to load routeSchedules from Supabase",d)}})()},[e]),u.useEffect(()=>{if(!z||!e)return;(async()=>{$n(!0);try{const d=await In(e);xs(d),console.log("[DiaryPage] Loaded route templates:",d)}catch(d){console.warn("[DiaryPage] Failed to load route templates",d)}finally{$n(!1)}})()},[e,z]);const vl=({isOpen:l,metric:d,onClose:N,onSave:K})=>{const[q,ge]=u.useState([!1,!1,!1,!1,!1,!1,!1]),[H,X]=u.useState([]),[ue,Ee]=u.useState("07:00"),[Oe,de]=u.useState("07:00"),[re,we]=u.useState(null),[Ne,je]=u.useState(!1);if(u.useEffect(()=>{!l||!d||(Array.isArray(d)?we(d[0]||null):we(d),je(!1))},[l,d]),u.useEffect(()=>{if(!l||!re)return;const Se=Xt[re]||{days:[],times:[]},Ve=[!1,!1,!1,!1,!1,!1,!1];(Se.days||[]).forEach(ht=>{ht>=0&&ht<7&&(Ve[ht]=!0)}),ge(Ve);const Xr=(Se.times||[]).map(ht=>ht?typeof ht=="string"?{from:ht,to:ht}:typeof ht=="object"&&"from"in ht&&"to"in ht?{from:ht.from||"07:00",to:ht.to||ht.from||"07:00"}:{from:"07:00",to:"07:00"}:{from:"07:00",to:"07:00"});X(Xr),Ee("07:00"),de("07:00")},[l,re]),!l||!d)return null;const Le=Se=>{ge(Ve=>{const He=[...Ve];return He[Se]=!He[Se],He})},Pe=()=>{if(!ue||!Oe)return;H.some(Ve=>Ve.from===ue&&Ve.to===Oe)||X(Ve=>[...Ve,{from:ue,to:Oe}]),Ee("07:00"),de("07:00")},Xe=Se=>X(Ve=>Ve.filter(He=>!(He.from===Se.from&&He.to===Se.to))),Ie=()=>{const Ve={days:q.map((He,Xr)=>He?Xr:-1).filter(He=>He!==-1),times:H};Array.isArray(d)&&Ne?d.forEach(He=>K(He,Ve)):Array.isArray(d)&&re?K(re,Ve):typeof d=="string"&&K(d,Ve),N()},Bt=["ПН","ВТ","СР","ЧТ","ПТ","СБ","ВС"];return t.jsx("div",{className:"fixed inset-0 z-60 flex items-center justify-center bg-black/40 px-4",children:t.jsxs("div",{className:"w-full max-w-sm rounded-[28px] bg-white p-6 space-y-4",children:[t.jsxs("div",{className:"text-center",children:[t.jsx("h2",{className:"text-2xl font-bold text-[#25ADB8]",children:"Настройте манипуляцию"}),t.jsx("div",{className:"text-xl font-semibold mt-1",children:Array.isArray(d)?t.jsx("div",{className:"flex flex-wrap gap-2 justify-center",children:d.map(Se=>t.jsx("button",{type:"button",onClick:()=>we(Se),className:`px-3 py-2 rounded-2xl text-sm font-semibold ${re===Se?"bg-[#CFF6F8] text-[#0A6D83] shadow-md":"bg-white border border-gray-200 text-[#4A4A4A]"}`,children:nt(Se)},Se))}):nt(d)})]}),t.jsx("div",{children:t.jsx("div",{className:"flex flex-wrap gap-2 justify-center",children:Bt.map((Se,Ve)=>t.jsx("button",{type:"button",onClick:()=>Le(Ve),className:`px-3 py-2 rounded-2xl text-sm font-semibold ${q[Ve]?"bg-[#CFF6F8] text-[#0A6D83] shadow-md":"bg-white border border-gray-200 text-[#4A4A4A]"}`,children:Se},Se))})}),t.jsxs("div",{children:[t.jsx("div",{className:"flex flex-wrap gap-2 mb-2",children:H.map(Se=>t.jsxs("div",{className:"inline-flex items-center gap-2 bg-gray-100 rounded-full px-3 py-2",children:[t.jsxs("span",{className:"text-sm font-medium",children:[Se.from,Se.from!==Se.to?` — ${Se.to}`:""]}),t.jsx("button",{onClick:()=>Xe(Se),className:"text-xs text-red-500",children:"×"})]},`${Se.from}_${Se.to}`))}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"time",value:ue,onChange:Se=>Ee(Se.target.value),className:"rounded-xl border border-gray-200 px-3 py-2"}),t.jsx("span",{className:"text-gray-400",children:"—"}),t.jsx("input",{type:"time",value:Oe,onChange:Se=>de(Se.target.value),className:"rounded-xl border border-gray-200 px-3 py-2"}),t.jsx("button",{onClick:Pe,className:"w-12 h-12 rounded-xl bg-[#2AA6B1] text-white",children:"+"})]})]}),Array.isArray(d)&&t.jsx("div",{className:"flex items-center justify-center gap-3 pt-2",children:t.jsxs("label",{className:"inline-flex items-center gap-2 text-sm",children:[t.jsx("input",{type:"checkbox",checked:Ne,onChange:Se=>je(Se.target.checked)}),t.jsx("span",{children:"Применить ко всем выбранным"})]})}),t.jsxs("div",{className:"flex items-center gap-3 justify-center pt-2",children:[t.jsx("button",{onClick:Ie,className:"px-6 py-3 rounded-2xl bg-[#55ACBF] text-white font-semibold",children:"Сохранить"}),t.jsx("button",{onClick:N,className:"px-6 py-3 rounded-2xl bg-gray-200 text-[#4A4A4A] font-semibold",children:"Отмена"})]})]})})},[ua,jl]=u.useState(null),[St,ys]=u.useState(null),[Mn,Tn]=u.useState(null),[Cr,bs]=u.useState({}),[Fn,ma]=u.useState(()=>new Date),Ft=u.useRef(null),er=u.useRef(null),[Ke,wl]=u.useState(k),[ha,_s]=u.useState(!1),[_t,fa]=u.useState(()=>Ws(k)),ga=u.useRef(null);u.useEffect(()=>{if(!e||!Ke)return;(async()=>{try{const d=await _o(e,Ke);Ur(d),console.log("[DiaryPage] Loaded routeSlotsForDate from Supabase",d)}catch(d){console.warn("[DiaryPage] Failed to load routeSlotsForDate",d)}})()},[e,Ke]);const[Ye,tr]=u.useState(null),[rr,Rt]=u.useState(null),[vs,Sr]=u.useState([]),[Vr,Nl]=u.useState(!1),[js,Rn]=u.useState("card"),lt=zg()<388,nt=l=>{if(l.startsWith("custom_")){const N=M.find(q=>q.metric_type===l);if(N){const q=N.metadata||{};return q.label?q.label:l.replace("custom_care_","").replace("custom_physical_","").replace("custom_excretion_","").replace("custom_symptom_","")||l}return l.replace("custom_care_","").replace("custom_physical_","").replace("custom_excretion_","").replace("custom_symptom_","")||l}return{walk:"Прогулка",cognitive_games:"Когнитивные игры",diaper_change:"Смена подгузников",hygiene:"Гигиена",skin_moisturizing:"Увлажнение кожи",meal:"Прием пищи",medications:"Прием лекарств",vitamins:"Прием витаминов",sleep:"Сон",temperature:"Температура",blood_pressure:"Давление",pulse:"Пульс",breathing_rate:"Частота дыхания",pain_level:"Уровень боли",saturation:"Сатурация",blood_sugar:"Уровень сахара в крови",urination:"Выпито/выделено и цвет мочи",defecation:"Дефекация",nausea:"Тошнота",vomiting:"Рвота",shortness_of_breath:"Одышка",itching:"Зуд",cough:"Кашель",dry_mouth:"Сухость во рту",hiccups:"Икота",taste_disturbance:"Нарушение вкуса"}[l]||l},ur=u.useMemo(()=>{if(!Ke)return[];if(Br.length>0)return Br.map(q=>({metric:q.metric_type||q.title,label:q.title||nt(q.metric_type||""),from:q.from_time,to:q.to_time,startMinutes:is(q.from_time),slotId:q.slot_id,templateId:q.template_id,status:q.status,eventId:q.event_id,performedBy:q.performed_by,performedAt:q.performed_at,reason:q.reason,comment:q.comment,assignedEmployeeId:q.assigned_employee_id}));const N=(Ws(Ke).getDay()+6)%7,K=[];return Object.entries(Xt||{}).forEach(([q,ge])=>{if(!ge||!Array.isArray(ge.days)||!ge.days.includes(N))return;(Array.isArray(ge.times)?ge.times:[]).forEach(X=>{const ue=X&&X.from||X||"07:00",Ee=X&&X.to||X||ue,Oe=is(ue);K.push({metric:q,label:nt(q),from:ue,to:Ee,startMinutes:Oe})})}),K.sort((q,ge)=>q.startMinutes-ge.startMinutes),K},[Xt,Br,Ke,M]),vt=u.useMemo(()=>_||f?.organization_type||o.organization_type||null,[_,f?.organization_type,o.organization_type]),[On,Zr]=u.useState(null),[Ln,ct]=u.useState(null),[st,mr]=u.useState({fullName:"",dateOfBirth:"",address:"",diagnoses:"",mobility:"walks"}),[Ot,ws]=u.useState([]),[Bn,Ns]=u.useState([]),[hr,Un]=u.useState(!1),[Vn,pa]=u.useState(!1),[It,kl]=u.useState([]),[ks,Cs]=u.useState([]),[Wr,qr]=u.useState(null),[jt,Ss]=u.useState([]),[Jr,As]=u.useState(""),[Cl,Zn]=u.useState(!1),xa=async l=>{if(!l?.accepted_by){Rt(null);return}try{const{data:d,error:N}=await F.from("clients").select("*").eq("user_id",l.accepted_by).maybeSingle();N?(console.warn("Ошибка загрузки клиента:",N),Rt(null)):Rt(d?{user_id:d.user_id,first_name:d.first_name||"",last_name:d.last_name||""}:null)}catch(d){console.warn("Не удалось загрузить данные клиента",d),Rt(null)}};u.useEffect(()=>{const l=setInterval(()=>{ma(new Date)},6e4);return()=>clearInterval(l)},[]),u.useEffect(()=>{if(!w||!S)return;(async()=>{try{const{data:d,error:N}=await F.from("organizations").select("id").eq("user_id",S).eq("organization_type","caregiver").maybeSingle();!N&&d?(console.log("[DiaryPage] Загружен ID организации-сиделки:",d.id),jl(d.id)):N&&console.error("[DiaryPage] Ошибка загрузки ID организации-сиделки:",N)}catch(d){console.error("[DiaryPage] Ошибка загрузки ID организации-сиделки:",d)}})()},[w,S]);const Qr=u.useMemo(()=>$||(w?ua:null),[$,w,ua]),[dt,Wn]=u.useState(null),[ya,qn]=u.useState(null);u.useEffect(()=>{if(!S){Wn(null),qn(null);return}(async()=>{if(I)try{const{data:d,error:N}=await F.from("organization_employees").select("organization_id").eq("user_id",S).maybeSingle();!N&&d?.organization_id&&(Wn(d.organization_id),console.log("[DiaryPage] Loaded employee organization_id:",d.organization_id))}catch(d){console.error("[DiaryPage] Error loading employee organization_id:",d)}if(P&&!O)try{const{data:d,error:N}=await F.from("organizations").select("id").eq("user_id",S).maybeSingle();!N&&d?.id&&(qn(d.id),console.log("[DiaryPage] Loaded organization_id from organizations table:",d.id))}catch(d){console.error("[DiaryPage] Error loading organization_id:",d)}})()},[I,P,S,O]);const ut=u.useMemo(()=>I&&dt?dt:P&&ya?ya:p,[I,P,dt,ya,p]);u.useEffect(()=>{if(!e)return;(async()=>{try{const{data:d,error:N}=await F.from("diary_client_links").select("*").eq("diary_id",e).maybeSingle();if(N){console.error("Ошибка загрузки ссылки для клиента:",N),tr(null),Rt(null);return}if(d){const q={link:d.token?`${i}/client-invite?diary=${e}&token=${d.token}`:"",created_at:d.accepted_at||new Date().toISOString(),token:d.token||"",diary_id:d.diary_id,patient_card_id:f?.patient_card_id??null,organization_id:f?.organization_id??p??null,accepted_by:d.accepted_by||null,accepted_at:d.accepted_at||null,client_id:d.client_id||null};tr(q),xa(q)}else tr(null),Rt(null)}catch(d){console.error("Ошибка загрузки ссылки для клиента:",d),tr(null),Rt(null)}})()},[e,f?.patient_card_id,f?.organization_id,p,ut,dt,I]),u.useEffect(()=>{if(console.log("[DiaryPage] useEffect для загрузки клиентов:",{id:e,isOrganization:y,organizationType:_,userRole:c}),!e){console.log("[DiaryPage] Пропуск загрузки клиентов: нет id");return}if(!y&&!I){console.log("[DiaryPage] Пропуск загрузки клиентов: не организация и не сотрудник",{isOrganization:y,isOrgEmployee:I,organizationType:_});return}(async()=>{try{if(I&&!sr.canManageClientAccess){console.log("[DiaryPage] Пропуск загрузки клиентов: руководитель без прав на управление клиентами"),Cs([]);return}const d=I?dt||ut||f?.organization_id:f?.organization_id||p;console.log("[DiaryPage] Загрузка приглашенных клиентов для дневника:",e,"organization_id:",d);const{data:N,error:K}=await F.from("diary_client_links").select("token, accepted_at, client_id, accepted_by").eq("diary_id",e);console.log("[DiaryPage] Загружено diary_client_links:",N?.length||0,"Ошибка:",K);const{data:q,error:ge}=await F.from("invite_tokens").select(`
            id,
            token,
            used_at,
            used_by,
            revoked_at,
            created_at,
            organization_client_invite_tokens (
              invite_id,
              diary_id,
              organization_id,
              invited_client_phone,
              invited_client_name,
              metadata
            )
          `).eq("invite_type","organization_client").order("created_at",{ascending:!1});console.log("[DiaryPage] Загружено приглашений:",q?.length||0,"Ошибка:",ge),q&&q.length>0&&console.log("[DiaryPage] Детали загруженных приглашений:",q.map(de=>({token:de.token,used_at:de.used_at,used_by:de.used_by,invite_type:de.invite_type})));const H=new Map;!K&&N&&N.length>0&&(N.forEach(de=>{H.set(de.token,{accepted_at:de.accepted_at,client_id:de.client_id,accepted_by:de.accepted_by}),console.log("[DiaryPage] Добавлена ссылка в карту:",{token:de.token,client_id:de.client_id,accepted_at:de.accepted_at,accepted_by:de.accepted_by})}),console.log("[DiaryPage] Создана карта токенов из diary_client_links:",H.size));let X={};const ue=new Map,Ee=new Set;!ge&&q&&q.length>0&&q.forEach(de=>{const re=Array.isArray(de.organization_client_invite_tokens)?de.organization_client_invite_tokens.find(we=>we.diary_id===e):de.organization_client_invite_tokens?.diary_id===e?de.organization_client_invite_tokens:null;if(re){const we=re.diary_id===e,Ne=I?dt||ut||f?.organization_id||p:f?.organization_id||p,je=!Ne||!re.organization_id||re.organization_id===Ne;we||je?(ue.set(de.token,{invite_id:de.id,used_at:de.used_at,used_by:de.used_by,created_at:de.created_at,invited_client_phone:re.invited_client_phone,invited_client_name:re.invited_client_name,organization_id:re.organization_id}),de.used_at&&de.used_by?(Ee.add(de.used_by),console.log("[DiaryPage] ✅ Найдено использованное приглашение:",{token:de.token,used_at:de.used_at,used_by:de.used_by,invite_id:de.id,diary_id:re.diary_id,isForCurrentDiary:we})):console.log("[DiaryPage] ⚠️ Приглашение не использовано или нет used_by:",{token:de.token,used_at:de.used_at,used_by:de.used_by,invite_id:de.id,diary_id:re.diary_id,isForCurrentDiary:we})):console.log("[DiaryPage] Пропуск приглашения: organization_id не совпадает и не для текущего дневника",{invite_id:de.id,invite_org_id:re.organization_id,current_org_id:p,diary_id:re.diary_id,current_diary_id:e})}});const Oe=Array.from(ue.entries()).filter(([,de])=>de.used_at&&!de.used_by);if(Oe.length>0&&(console.log("[DiaryPage] ⚠️ Найдены использованные приглашения без used_by (возможно, RLS блокирует):",Oe.length),console.log("[DiaryPage] Детали приглашений без used_by:",Oe.map(([de,re])=>({token:de,used_at:re.used_at})))),Ee.size>0){console.log("[DiaryPage] Восстанавливаем данные для использованных приглашений, used_by:",Array.from(Ee));const{data:de,error:re}=await F.from("clients").select("id, user_id, first_name, last_name, phone, invited_by_organization_id").in("user_id",Array.from(Ee));if(console.log("[DiaryPage] Загружено зарегистрированных клиентов по used_by:",de?.length||0,"Ошибка:",re),!re&&de&&de.length>0){const we=new Map(de.map(Ne=>[Ne.user_id,Ne]));ue.forEach((Ne,je)=>{if(Ne.used_by&&Ne.used_at){const Le=we.get(Ne.used_by);if(Le){const Pe=I?dt||ut||f?.organization_id||p:f?.organization_id||p;if(!Pe||!Ne.organization_id||Ne.organization_id===Pe||Le.invited_by_organization_id===Pe){const Ie=H.get(je);Ie?(Ie.client_id=Le.id,Ie.accepted_by=Ne.used_by,Ie.accepted_at=Ne.used_at,console.log("[DiaryPage] Восстановлены данные для существующей записи:",{token:je,client_id:Le.id,accepted_by:Ne.used_by,accepted_at:Ne.used_at})):(H.set(je,{client_id:Le.id,accepted_by:Ne.used_by,accepted_at:Ne.used_at}),console.log("[DiaryPage] Создана новая запись в linksMap для токена:",je))}}}}),de.forEach(Ne=>{X[Ne.id]||(X[Ne.id]={first_name:Ne.first_name||void 0,last_name:Ne.last_name||void 0,user_id:Ne.user_id||void 0,phone:Ne.phone||void 0},console.log("[DiaryPage] Добавлены данные восстановленного клиента в clientsData:",Ne.id))})}}if(H.size>0||ue.size>0){const de=new Set,re=new Set;H.forEach(je=>{je.client_id&&de.add(je.client_id),je.accepted_by&&re.add(je.accepted_by)}),ue.forEach(je=>{je.used_by&&je.used_at&&re.add(je.used_by)}),console.log("[DiaryPage] ID зарегистрированных клиентов из client_id:",Array.from(de)),console.log("[DiaryPage] User ID из accepted_by и used_by:",Array.from(re));let we={};if(re.size>0){const je=Array.from(re);console.log("[DiaryPage] Загружаем клиентов по accepted_by (user_id)");const{data:Le,error:Pe}=await F.from("clients").select("id, user_id, first_name, last_name, phone").in("user_id",je);if(console.log("[DiaryPage] Загружено клиентов по user_id:",Le?.length||0,"Ошибка:",Pe),!Pe&&Le&&Le.length>0){const Xe=new Map(Le.map(Ie=>[Ie.user_id,Ie.id]));H.forEach((Ie,Bt)=>{if(!Ie.client_id&&Ie.accepted_by){const Se=Xe.get(Ie.accepted_by);Se&&(Ie.client_id=Se,de.add(Se),console.log("[DiaryPage] Найден client_id для токена:",Bt,"client_id:",Se))}}),Le.forEach(Ie=>{we[Ie.id]={first_name:Ie.first_name||void 0,last_name:Ie.last_name||void 0,user_id:Ie.user_id||void 0,phone:Ie.phone||void 0}})}}if(de.size>0){const je=Array.from(de),{data:Le,error:Pe}=await F.from("clients").select("id, first_name, last_name, user_id, phone").in("id",je);console.log("[DiaryPage] Загружено клиентов из БД:",Le?.length||0,"Ошибка:",Pe),!Pe&&Le&&Le.length>0&&Le.forEach(Xe=>{we[Xe.id]={first_name:Xe.first_name||void 0,last_name:Xe.last_name||void 0,user_id:Xe.user_id||void 0,phone:Xe.phone||void 0}})}const Ne=[];H.forEach((je,Le)=>{const Pe=ue.get(Le),Xe=je.client_id;let Ie=Xe?we[Xe]:null;if(!Xe&&Pe?.used_by&&Object.values(we).find(He=>He.user_id===Pe.used_by)){const He=Object.keys(we).find(Xr=>we[Xr].user_id===Pe.used_by);He&&(Ie=we[He],je.client_id=He)}const Bt=je.accepted_at||Pe?.used_at||null,Se=je.accepted_by||Pe?.used_by||null;Ne.push({invite_id:Pe?.invite_id||`link_${Le}`,token:Le,client_id:Xe||Se&&Object.keys(we).find(Ve=>we[Ve].user_id===Se)||null,invited_client_phone:Pe?.invited_client_phone||Ie?.phone||null,invited_client_name:Pe?.invited_client_name||Ie&&`${Ie.first_name||""} ${Ie.last_name||""}`.trim()||null,used_at:Pe?.used_at||null,used_by:Pe?.used_by||null,accepted_at:Bt,accepted_by:Se,created_at:Pe?.created_at||Bt||new Date().toISOString(),registered_client_name:Ie&&`${Ie.first_name||""} ${Ie.last_name||""}`.trim()||void 0,registered_client_phone:Ie?.phone||void 0,registered_client_user_id:Ie?.user_id||void 0})}),ue.forEach((je,Le)=>{if(!H.has(Le)){let Pe=null,Xe=null;if(je.used_by&&je.used_at){const Ie=Object.values(we).find(Bt=>Bt.user_id===je.used_by);Ie&&(Xe=Object.keys(we).find(Bt=>we[Bt].user_id===je.used_by)||null,Pe=Ie)}Ne.push({invite_id:je.invite_id,token:Le,client_id:Xe,invited_client_phone:je.invited_client_phone||Pe?.phone||null,invited_client_name:je.invited_client_name||Pe&&`${Pe.first_name||""} ${Pe.last_name||""}`.trim()||null,used_at:je.used_at||null,used_by:je.used_by||null,accepted_at:je.used_at||null,accepted_by:je.used_by||null,created_at:je.created_at,registered_client_name:Pe&&`${Pe.first_name||""} ${Pe.last_name||""}`.trim()||void 0,registered_client_phone:Pe?.phone||void 0,registered_client_user_id:Pe?.user_id||void 0})}}),console.log("[DiaryPage] Итоговый список клиентов:",Ne.length),Cs(Ne)}else console.log("[DiaryPage] Нет данных о клиентах"),Cs([])}catch(d){console.error("Ошибка загрузки приглашенных клиентов:",d),Cs([])}})()},[e,y,I,p,ut,dt,f?.organization_id,Ye?.accepted_by]),u.useEffect(()=>{if(!e)return;(async()=>{try{const{data:d,error:N}=await F.from("diary_external_access_links").select("*").eq("diary_id",e).is("revoked_at",null).order("created_at",{ascending:!1});if(N){console.error("Ошибка загрузки внешних ссылок:",N),Sr([]);return}if(d&&d.length>0){const K=d.map(q=>({id:q.id,token:q.link_token,link:`${i}/diaries/${e}?access=${q.link_token}`,invited_email:q.invited_email||null,invited_phone:q.invited_phone||null,expires_at:q.expires_at||null,created_at:q.created_at}));Sr(K)}else Sr([])}catch(d){console.error("Ошибка загрузки внешних ссылок:",d),Sr([])}})()},[e]),u.useEffect(()=>{if(!ha)return;const l=N=>{ga.current&&!ga.current.contains(N.target)&&_s(!1)},d=N=>{N.key==="Escape"&&_s(!1)};return document.addEventListener("mousedown",l),document.addEventListener("keydown",d),()=>{document.removeEventListener("mousedown",l),document.removeEventListener("keydown",d)}},[ha]),u.useEffect(()=>()=>{Ft.current&&(window.clearTimeout(Ft.current),Ft.current=null),er.current&&(cancelAnimationFrame(er.current),er.current=null)},[]);const Sl=u.useMemo(()=>{const l=(de,re)=>!!de&&!!re&&String(de)===String(re);if(!f)return{hasBaseAccess:!1,isOwner:!1,isClientAccess:!1,organizationAccountAccess:!1,organizationEmployeeAccess:!1,caregiverAccess:!1,canManageDiarySettings:!1,canEditCardSettings:!1,canManageMetricsSettings:!1,canManageAccessSettings:!1};const d=l(f.owner_id,S);let N=!1;c==="client"?(console.log("[DiaryPage] Проверка доступа клиента:",{diaryId:f.id,diaryClientId:f.client_id,userId:S,organizationClientLink:Ye?.accepted_by}),f.id&&(N=!0,console.log("[DiaryPage] ✅ Клиент имеет доступ через RLS (дневник загружен)")),Ye?.accepted_by===S&&(N=!0,console.log("[DiaryPage] ✅ Клиент имеет доступ через organizationClientLink"))):console.log("[DiaryPage] ⚠️ userRole не является client:",c,"userId:",S);const K=P&&(l(f.organization_id,ut||p)||l(f.organization_id,S)||!f.organization_id&&l(f.owner_id,ut||p)||!f.organization_id&&l(f.owner_id,S)),q=jt.map(de=>de.user_id),ge=vt==="patronage_agency";let H=!1;if(I&&S){const de=jt.find(re=>re.user_id===S);if(de&&(de.role==="admin"||de.role==="manager"))H=!0;else{const re=It.find(we=>we.user_id===S);re&&(re.role==="admin"||re.role==="manager")&&(H=!0)}}const X=!ge||H||(S?q.includes(S):!1),ue=I&&(l(f.organization_id,dt||O||ut||p)||!f.organization_id&&l(f.owner_id,dt||O||ut||p))&&X,Ee=(w||!!Qr)&&l(f.caregiver_id,Qr),Oe=d||N||K||ue||Ee;return console.log("[DiaryPage] accessState calculation:",{isOwner:d,isClientAccess:N,organizationAccountAccess:K,organizationEmployeeAccess:ue,caregiverAccess:Ee,hasBaseAccess:Oe,userRole:c,userId:S,diaryId:f.id,diaryClientId:f.client_id}),{hasBaseAccess:Oe,isOwner:d,isClientAccess:N,organizationAccountAccess:K,organizationEmployeeAccess:ue,caregiverAccess:Ee,canManageDiarySettings:d||K,canEditCardSettings:d||N||K,canManageMetricsSettings:d||N||K||Ee,canManageAccessSettings:d||N||K}},[f,S,c,p,ut,O,dt,Qr,ua,P,I,w,jt,It,_,vt,Ye]),ba=async()=>{if(!(!f||!e))try{const{data:l,error:d}=await F.from("diary_employee_access").select("user_id, revoked_at").eq("diary_id",e);if(d)return console.error("Ошибка загрузки назначенных сотрудников:",d),[];const N=(l||[]).filter(X=>vt==="pension"?!0:!X.revoked_at);if(N.length===0&&vt!=="pension")return[];const K=N.map(X=>X.user_id).filter(Boolean);if(K.length===0&&vt!=="pension")return[];const{data:q,error:ge}=await F.from("organization_employees").select(`
          user_id,
          first_name,
          last_name,
          role,
          organization_id,
          organizations (
            organization_type
          )
        `).in("user_id",K.length>0?K:[]);if(ge)return console.error("Ошибка загрузки данных сотрудников:",ge),[];const H=new Map(N.map(X=>[X.user_id,X.revoked_at]));return(q||[]).map(X=>({user_id:X.user_id,first_name:X.first_name||"",last_name:X.last_name||"",role:X.role||"",organization_type:X.organizations?.organization_type||null,revoked_at:H.get(X.user_id)||null}))}catch(l){return console.error("Ошибка загрузки назначенных сотрудников:",l),[]}};u.useEffect(()=>{if(!f)return;Zn(!1),(async()=>{let d=[];d=await ba()||[];let K=[];if(P||I)try{let H=U(f.organization_id);if(!H)if(I&&dt)H=dt,console.log("[DiaryPage] Using employeeOrganizationId:",H);else if(S){if(I){const{data:X,error:ue}=await F.from("organization_employees").select("organization_id").eq("user_id",S).maybeSingle();!ue&&X?.organization_id&&(H=X.organization_id,console.log("[DiaryPage] Loaded organization_id from organization_employees:",H))}if(!H){const{data:X,error:ue}=await F.from("organizations").select("id").eq("user_id",S).single();!ue&&X?.id?(H=X.id,console.log("[DiaryPage] Loaded organization_id from organizations table:",H)):(H=U(ut||p),console.log("[DiaryPage] Using finalEffectiveOrganizationId/effectiveOrganizationId as fallback:",H))}}else H=U(ut||p);if(H){console.log("[DiaryPage] Loading employees for organization_id:",H);const{data:X,error:ue}=await F.from("organization_employees").select(`
                user_id,
                first_name,
                last_name,
                role,
                organizations!inner (
                  organization_type
                )
              `).eq("organization_id",H);ue?console.error("[DiaryPage] Error loading employees:",ue):X&&(console.log("[DiaryPage] Loaded employees:",X.length),K=X.map(Ee=>({user_id:Ee.user_id,first_name:Ee.first_name||"",last_name:Ee.last_name||"",role:Ee.role||"",organization_type:Ee.organizations?.organization_type||null})))}else console.warn("[DiaryPage] No organization_id found for loading employees");K.length===0&&console.warn("[DiaryPage] Сотрудники не найдены для организации:",{orgId:H,effectiveOrganizationId:p,diaryOrganizationId:f.organization_id,userId:S})}catch(H){console.error("[DiaryPage] Не удалось загрузить сотрудников организации",H),K=[]}kl(K);let q=null,ge=!1;if((P||I)&&vt==="pension"&&e){const{data:H}=await F.from("diary_employee_access").select("user_id").eq("diary_id",e).limit(1);ge=(H?.length||0)>0}if((P||I)&&vt==="pension"&&d.length===0&&K.length>0&&!ge)d=K,q=K,console.log("[DiaryPage] auto-assign all employees for pension",q);else if((P||I)&&K.length>0){const H=d.filter(X=>K.some(ue=>ue.user_id===X.user_id));H.length!==d.length&&(d=H,q=H,console.log("[DiaryPage] cleaned assignment list",{normalizedAssignments:d}))}if(q)try{if(vt==="pension")for(const H of q)try{await F.rpc("assign_employee_to_diary",{p_diary_id:f.id,p_user_id:H.user_id})}catch(X){console.warn("Не удалось назначить доступ сотруднику:",X)}}catch(H){console.warn("Не удалось сохранить доступ сотрудников организации",H)}Ss(d),Zn(!0)})()},[f,P,I,_,p,S,e]),u.useEffect(()=>{f&&console.log("[DiaryPage] assignedEmployees changed",jt)},[jt,f]);const Kr=u.useMemo(()=>{const l=new Map;return jt.forEach(d=>{l.set(String(d.user_id),d)}),It.forEach(d=>{const N=String(d.user_id);l.has(N)&&l.set(N,{user_id:d.user_id,first_name:d.first_name,last_name:d.last_name,role:d.role,organization_type:d.organization_type||l.get(N)?.organization_type||null})}),Array.from(l.values())},[jt,It]),{hasBaseAccess:Ds,organizationAccountAccess:fr,organizationEmployeeAccess:Es,caregiverAccess:Jn,canEditCardSettings:Al,canManageMetricsSettings:Dl,canManageAccessSettings:El}=Sl,[sr,_a]=u.useState({canEditCard:!1,canManageMetrics:!1,canManageClientAccess:!1,canManageEmployeeAccess:!1});u.useEffect(()=>{(async()=>{if(!a||!I){_a({canEditCard:!1,canManageMetrics:!1,canManageClientAccess:!1,canManageEmployeeAccess:!1});return}try{const[d,N,K,q]=await Promise.all([Pn(a),ug(a),mg(a),pl(a)]);_a({canEditCard:d,canManageMetrics:q,canManageClientAccess:N,canManageEmployeeAccess:K})}catch(d){console.error("Ошибка проверки прав сотрудника:",d),_a({canEditCard:!1,canManageMetrics:!1,canManageClientAccess:!1,canManageEmployeeAccess:!1})}})()},[a,I]);const At=Al||I&&sr.canEditCard,it=Dl||I&&sr.canManageMetrics,$t=I?sr.canManageClientAccess||sr.canManageEmployeeAccess:El;u.useEffect(()=>{f&&console.log("[DiaryPage] access state",{diaryId:f.id,owner_id:f.owner_id,client_id:f.client_id,organization_id:f.organization_id,caregiver_id:f.caregiver_id,userId:S,effectiveOrganizationId:p,userOrganizationId:O,effectiveCaregiverId:Qr,roles:{isOrganization:y,isOrgEmployee:I,isCaregiver:w,isClient:D},organizationAccountAccess:fr,organizationEmployeeAccess:Es,caregiverAccess:Jn,hasBaseAccess:Ds})},[f,S,p,O,Qr,y,I,w,D,fr,Es,Jn,Ds]);const gr=u.useMemo(()=>[At?{id:"card",label:"Карточка"}:null,it?{id:"metrics",label:"Показатели"}:null,$t?{id:"access",label:"Доступ"}:null].filter(Boolean),[At,it,$t]);u.useEffect(()=>{if(!Vr)return;Zr(null),ct(null),console.log("[DiaryPage] Settings modal opened",{sections:gr.map(d=>d.id),canEditCardSettings:At,canManageMetricsSettings:it,canManageAccessSettings:$t}),gr.length>0&&Rn(d=>gr.some(N=>N.id===d)?d:gr[0].id),R&&mr({fullName:R.full_name,dateOfBirth:R.date_of_birth||"",address:R.address||"",diagnoses:Array.isArray(R.diagnoses)?R.diagnoses.join(", "):"",mobility:R.mobility});const l=Array.from(new Set(M.map(d=>d.metric_type)));ws(l),Ns(M.filter(d=>d.is_pinned).map(d=>d.metric_type).filter(d=>l.includes(d)))},[Vr,R,M,gr,At,it,$t]),u.useEffect(()=>{if(!Vr)return;const l=document.body.style.overflow;return document.body.style.overflow="hidden",()=>{document.body.style.overflow=l}},[Vr]);const wt=Ds,zl=l=>{f&&(console.log("[DiaryPage] persistAssignedEmployees",{diaryId:f.id,next:l}),Ss(l))},va=async l=>{if(!f||!e)return;const d=l||Jr;if(!d){console.warn("[DiaryPage] handleAddEmployeeAccess: targetId is empty");return}const N=q=>String(q),K=jt.find(q=>N(q.user_id)===N(d));if(K&&!K.revoked_at){l||As(""),console.log("[DiaryPage] handleAddEmployeeAccess: already has active access",{targetId:d});return}try{const{error:q}=await F.rpc("assign_employee_to_diary",{p_diary_id:e,p_user_id:d});if(q){console.error("Ошибка назначения доступа:",q),alert(q.message||"Не удалось назначить доступ. Попробуйте позже.");return}const ge=await ba();Ss(ge||[]),l||As(""),ct(null),console.log("[DiaryPage] Доступ сотрудника предоставлен, список обновлен")}catch(q){console.error("Ошибка назначения доступа:",q),alert("Не удалось назначить доступ. Попробуйте позже.")}},Qn=async l=>{if(!(!f||!e||!window.confirm("Убрать доступ у сотрудника к этому дневнику?")))try{const{error:N}=await F.rpc("remove_employee_from_diary",{p_diary_id:e,p_user_id:l});if(N){console.error("Ошибка отзыва доступа:",N),alert("Не удалось отозвать доступ. Попробуйте позже.");return}const K=await ba();Ss(K||[]),console.log("[DiaryPage] Доступ сотрудника отозван, список обновлен")}catch(N){console.error("Ошибка отзыва доступа:",N),alert("Не удалось отозвать доступ. Попробуйте позже.")}},zs=async l=>{if(!(!f||!e||!window.confirm(l==="caregiver"?"Вы уверены, что хотите отозвать доступ у сиделки?":"Вы уверены, что хотите отозвать доступ у организации?")))try{const N=l==="caregiver"?"caregiver_id":"organization_id",{error:K}=await F.from("diaries").update({[N]:null}).eq("id",e);if(K){console.error("Ошибка отзыва доступа:",K),alert("Не удалось отозвать доступ. Попробуйте позже.");return}if(x({...f,[N]:null}),l==="caregiver")console.log("[DiaryPage] Доступ сиделки отозван, дневник и карточка остаются у клиента");else if(l==="organization"){qr(null),zl([]);try{const{error:q}=await F.from("diary_client_links").delete().eq("diary_id",e);q&&console.warn("Не удалось удалить ссылку клиента при отзыве доступа организации:",q)}catch(q){console.warn("Не удалось очистить ссылку клиента при удалении доступа организации",q)}tr(null),Rt(null)}alert("Доступ успешно отозван")}catch(N){console.error("Ошибка отзыва доступа:",N),alert("Не удалось отозвать доступ. Попробуйте позже.")}};u.useEffect(()=>{if(!a){const K=n.get("client"),q=n.get("access");K?r(`/client-invite?diary=${e}&token=${K}`,{replace:!0}):(q&&(async()=>{try{await F.rpc("register_diary_access_attempt",{p_link_token:q,p_user_id:null,p_user_email:null,p_user_phone:null})}catch(H){console.error("[DiaryPage] Ошибка регистрации попытки принять приглашение:",H)}})(),r("/login"));return}(async()=>{if(e)try{const{data:K,error:q}=await F.from("diaries").select("*").eq("id",e).single();if(q||!K){console.error("Ошибка загрузки дневника:",q),console.error("Детали ошибки:",{code:q?.code,message:q?.message,details:q?.details,hint:q?.hint,userId:a?.id,userRole:c}),(q?.code==="PGRST301"||q?.message?.includes("permission")||q?.message?.includes("access"))&&console.error("Доступ заблокирован RLS. Проверьте has_diary_access для этого дневника."),alert("Не удалось загрузить дневник. Попробуйте позже."),r("/dashboard");return}const ge={id:K.id,owner_id:K.created_by||K.owner_client_id||"",client_id:K.owner_client_id||null,patient_card_id:K.patient_card_id,caregiver_id:K.caregiver_id,organization_id:K.organization_id,organization_type:K.organization_type||_||o.organization_type||null,created_at:K.created_at};if(x(ge),ge.organization_id)try{const{data:H,error:X}=await F.from("organizations").select("id, name, type").eq("id",ge.organization_id).single();qr(!X&&H?{id:H.id,name:H.name||"Организация",type:H.type}:null)}catch(H){console.error("Ошибка загрузки информации об организации:",H),qr(null)}else qr(null);if(ge.patient_card_id){const{data:H,error:X}=await F.from("patient_cards").select("*").eq("id",ge.patient_card_id).single();if(!X&&H){const ue={id:H.id,client_id:H.client_id||"",full_name:H.full_name,date_of_birth:H.date_of_birth,gender:H.gender,diagnoses:Array.isArray(H.diagnoses)?H.diagnoses:[],mobility:H.mobility,address:H.metadata?.address||null};G(ue)}else console.error("Ошибка загрузки карточки:",X),alert("Не удалось загрузить карточку подопечного.")}}catch(K){console.error("Ошибка загрузки дневника:",K),r("/dashboard")}})();const d=async()=>{if(e)try{const{data:K,error:q}=await F.from("diary_metrics").select("*").eq("diary_id",e);if(q)console.error("Ошибка загрузки метрик:",q),L([]),bs({});else{const ge=(K||[]).map(X=>({id:X.id,diary_id:X.diary_id,metric_type:X.metric_key,is_pinned:X.is_pinned,settings:X.metadata?.settings||void 0,metadata:X.metadata||{}}));L(ge);const H={};ge.forEach(X=>{X.settings&&(H[X.metric_type]=xr(X.settings))}),bs(H)}}catch(K){console.error("Ошибка загрузки метрик:",K)}},N=async()=>{if(e)try{const{data:K,error:q}=await F.from("diary_metric_values").select("*").eq("diary_id",e).order("recorded_at",{ascending:!1}).limit(100);if(q)console.error("Ошибка загрузки значений метрик:",q),Z([]);else{const ge=(K||[]).map(X=>{let ue=X.value;return X.value&&typeof X.value=="object"&&"value"in X.value&&(ue=X.value.value),{id:X.id,diary_id:X.diary_id,metric_type:X.metric_key,value:ue,created_at:X.recorded_at||X.created_at}}),H=Er(ge);Z(H)}}catch(K){console.error("Ошибка загрузки значений метрик:",K)}};d(),N(),ma(new Date)},[e,a,r,n]),u.useEffect(()=>{if(!e||!a)return;const l=n.get("access");if(!l)return;(async()=>{try{console.log("[DiaryPage] Обработка токена доступа к дневнику:",l);const N=a.user_metadata?.user_role||a.user_metadata?.role,K=a.user_metadata?.organization_type;if(!(N==="organization"||N==="org_employee")&&!(K==="caregiver")){if(console.log("[DiaryPage] Пользователь не является организацией, сиделкой или сотрудником, пропускаем обработку токена"),K==="caregiver"){console.log("[DiaryPage] Сиделка еще не создала организацию, регистрируем попытку для обработки после создания профиля");try{await F.rpc("register_diary_access_attempt",{p_link_token:l,p_user_id:a.id,p_user_email:a.email||null,p_user_phone:a.user_metadata?.phone||null})}catch(ue){console.error("[DiaryPage] Ошибка регистрации попытки:",ue)}r("/profile/setup",{replace:!0})}return}const{data:H,error:X}=await F.rpc("accept_diary_access_token",{p_link_token:l});if(X){if(console.error("[DiaryPage] Ошибка привязки дневника по токену:",X),X.message?.includes("Организация не найдена")||X.message?.includes("не удалось определить организацию")){console.log("[DiaryPage] Организация не найдена, регистрируем попытку для обработки после создания профиля");try{await F.rpc("register_diary_access_attempt",{p_link_token:l,p_user_id:a.id,p_user_email:a.email||null,p_user_phone:a.user_metadata?.phone||null})}catch(ue){console.error("[DiaryPage] Ошибка регистрации попытки:",ue)}r("/profile/setup",{replace:!0});return}alert("Ошибка привязки дневника: "+X.message);return}if(H?.success)console.log("[DiaryPage] Дневник успешно привязан:",H),await s.invalidateQueries({queryKey:["dashboard-diaries"]}),alert("Доступ к дневнику получен! Дневник добавлен в ваш список."),r("/dashboard",{replace:!0});else{if(console.error("[DiaryPage] Ошибка привязки дневника:",H?.error),H?.error?.includes("Организация не найдена")||H?.error?.includes("не удалось определить организацию")){console.log("[DiaryPage] Организация не найдена, регистрируем попытку для обработки после создания профиля");try{await F.rpc("register_diary_access_attempt",{p_link_token:l,p_user_id:a.id,p_user_email:a.email||null,p_user_phone:a.user_metadata?.phone||null})}catch(ue){console.error("[DiaryPage] Ошибка регистрации попытки:",ue)}r("/profile/setup",{replace:!0});return}alert("Ошибка привязки дневника: "+(H?.error||"Неизвестная ошибка"))}}catch(N){console.error("[DiaryPage] Ошибка обработки токена доступа:",N),alert("Ошибка обработки токена доступа")}})()},[e,a,n,r]),u.useEffect(()=>{if(!e||!a||!f)return;const l=n.get("client");if(!l)return;(async()=>{try{const{data:N,error:K}=await F.from("diary_client_links").select("*").eq("diary_id",e).eq("token",l).maybeSingle();if(K){console.error("Ошибка проверки приглашения:",K),alert("Ошибка проверки ссылки приглашения"),r(`/diaries/${e}`,{replace:!0});return}if(!N){alert("Ссылка приглашения недействительна или устарела"),r(`/diaries/${e}`,{replace:!0});return}if(N.accepted_by&&N.accepted_by!==a.id){alert("Эта ссылка уже была использована другим пользователем"),r(`/diaries/${e}`,{replace:!0});return}const{data:q,error:ge}=await F.from("clients").select("id").eq("user_id",a.id).single();if(ge||!q){alert("Ошибка: не удалось определить клиента"),r(`/diaries/${e}`,{replace:!0});return}const H=q.id,{error:X}=await F.from("diary_client_links").update({client_id:H,accepted_by:a.id,accepted_at:new Date().toISOString()}).eq("diary_id",e).eq("token",l);if(X){console.error("Ошибка обновления diary_client_links:",X),alert("Ошибка при принятии приглашения"),r(`/diaries/${e}`,{replace:!0});return}const{data:ue,error:Ee}=await F.from("diaries").select("*").eq("id",e).single();if(!Ee&&ue&&x(ue),ue?.patient_card_id){const{data:de,error:re}=await F.from("patient_cards").select("*").eq("id",ue.patient_card_id).single();!re&&de&&G(de)}const Oe={link:`${i}/client-invite?diary=${e}&token=${l}`,created_at:N.accepted_at||new Date().toISOString(),token:l,diary_id:e,patient_card_id:f.patient_card_id,organization_id:f.organization_id??p??null,accepted_by:a.id,accepted_at:new Date().toISOString(),client_id:H};tr(Oe),xa(Oe),alert("Дневник успешно привязан к вашему аккаунту. Вы можете управлять доступом и делиться дневником со специалистами."),r(`/diaries/${e}`,{replace:!0})}catch(N){console.error("Ошибка при принятии приглашения:",N),alert("Ошибка при принятии приглашения"),r(`/diaries/${e}`,{replace:!0})}})()},[e,a,f,n,r,p]);const Hr=l=>{C(d=>({...d,[l]:!d[l]}))},Kn=M.filter(l=>l.is_pinned),Ps=l=>{if(l.startsWith("custom_")){const d=M.find(N=>N.metric_type===l);if(d)return(d?.metadata||{}).category||null;if(l.startsWith("custom_care_"))return"care";if(l.startsWith("custom_physical_"))return"physical";if(l.startsWith("custom_excretion_"))return"excretion";if(l.startsWith("custom_symptom_"))return"symptom"}return["walk","cognitive_games","diaper_change","hygiene","skin_moisturizing","meal","medications","vitamins","sleep"].includes(l)?"care":["temperature","blood_pressure","breathing_rate","pain_level","saturation","blood_sugar"].includes(l)?"physical":["urination","defecation"].includes(l)?"excretion":["nausea","vomiting","shortness_of_breath","itching","cough","dry_mouth","hiccups","taste_disturbance"].includes(l)?"symptom":null},Hn=M.filter(l=>!l.is_pinned&&Ps(l.metric_type)==="care"),Gn=M.filter(l=>!l.is_pinned&&Ps(l.metric_type)==="physical"),Yn=M.filter(l=>!l.is_pinned&&Ps(l.metric_type)==="excretion"),Xn=M.filter(l=>!l.is_pinned&&Ps(l.metric_type)==="symptom"),ei=l=>{const d=B.filter(H=>H.metric_type===l).sort((H,X)=>new Date(X.created_at).getTime()-new Date(H.created_at).getTime());if(d.length===0)return null;const N=d[0];if(typeof N.value=="boolean")return N.value?"✓":"✗";const K=String(N.value??"").trim();return K&&K.split(`
`)[0].replace(/\s*\d{1,2}:\d{2}$/,"").trim()||null},Pl=l=>{if(!l||l.length===0)return"Выберите время";const d=Fn.getHours()*60+Fn.getMinutes(),N=l.map(is).sort((X,ue)=>X-ue),K=N.find(X=>X>d),q=K!==void 0?K-d:N[0]+cr-d,ge=Math.floor(q/60),H=q%60;return`${String(ge).padStart(2,"0")}:${String(H).padStart(2,"0")}`},Il=l=>{const d=Cr[l];return!d||!d.times?.length?"Выберите время":Pl(d.times)},ja=520,[ti,wa]=u.useState([]);u.useEffect(()=>{(async()=>{if(!e||!Ke){wa([]);return}try{const d=await Ba(e,Ke);wa(d)}catch(d){console.error("Ошибка загрузки истории для даты:",d),wa([])}})()},[e,Ke]);const ri=u.useMemo(()=>{if(!Ke)return[];const l=Ws(Ke);return Er([...B,...ti]).filter(N=>{const K=new Date(N.created_at);return K.getFullYear()===l.getFullYear()&&K.getMonth()===l.getMonth()&&K.getDate()===l.getDate()}).map((N,K)=>{let q=new Date(N.created_at).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"}),ge;if(typeof N.value=="string"){const X=N.value.split(" · ").map(ue=>ue.trim()).filter(Boolean);if(X.length>1){const ue=X[X.length-1];/^\d{1,2}:\d{2}$/.test(ue)&&(q=ue.padStart(5,"0"),X.pop())}ge=X.join(" · ")||"--"}else typeof N.value=="boolean"?ge=N.value?"Было":"Не было":ge=`${N.value}`;const H=`${N.id}_${N.metric_type}_${N.created_at}_${K}`;return{...N,label:nt(N.metric_type),time:q,displayValue:ge,uniqueKey:H}})},[B,ti,Ke]),Na=u.useMemo(()=>{const l={};return ri.forEach(d=>{l[d.metric_type]||(l[d.metric_type]={metricType:d.metric_type,label:d.label,items:[]}),l[d.metric_type].items.push(d)}),Object.values(l).sort((d,N)=>d.label.localeCompare(N.label))},[ri]),si=u.useMemo(()=>({medications:Na.filter(l=>["medications","vitamins"].includes(l.metricType)).map(l=>({...l,items:l.items.sort((d,N)=>new Date(N.created_at).getTime()-new Date(d.created_at).getTime())})),others:Na.filter(l=>!["medications","vitamins"].includes(l.metricType)).map(l=>({...l,items:l.items.sort((d,N)=>new Date(N.created_at).getTime()-new Date(d.created_at).getTime())}))}),[Na]),ai=si.medications,ni=si.others,ii=u.useMemo(()=>Ws(Ke),[Ke]),$l=u.useMemo(()=>{const d=ii.toLocaleDateString("ru-RU",{weekday:"long",day:"numeric",month:"long",year:"numeric"}).replace(/\s?г\./,"г").replace(/\s?г$/,"г");return d.charAt(0).toUpperCase()+d.slice(1)},[ii]),Ml=u.useMemo(()=>{const l=new Date(_t.getFullYear(),_t.getMonth(),1),d=new Date(_t.getFullYear(),_t.getMonth()+1,0).getDate(),N=(l.getDay()+6)%7,K=Math.ceil((N+d)/7)*7,q=Ua(new Date);return Array.from({length:K},(ge,H)=>{const X=new Date(l);X.setDate(X.getDate()+H-N);const ue=Ua(X);return{date:X,key:ue,label:X.getDate(),isCurrentMonth:X.getMonth()===_t.getMonth(),isSelected:ue===Ke,isToday:ue===q}})},[_t,Ke]),Tl=u.useMemo(()=>{const l=_t.toLocaleDateString("ru-RU",{month:"long"}).replace(" г.","");return`${l.charAt(0).toUpperCase()+l.slice(1)} ${_t.getFullYear()}`},[_t]),ka=u.useMemo(()=>{const l=[{id:"diary",label:"Дневник"},{id:"history",label:"История"},{id:"route",label:"Маршрутный лист"}];return(y||I&&sr.canManageClientAccess)&&l.push({id:"client",label:"Клиент"}),D&&l.push({id:"share",label:"Поделиться"}),l},[y,I,sr.canManageClientAccess,D]),Kt=u.useMemo(()=>ka.map(l=>l.id),[ka]),oi=u.useCallback(l=>{if(Kt.length<=1)return;const d=Kt.indexOf(j);if(d===-1)return;const N=l==="next"?d+1:d-1;N<0||N>=Kt.length||v(Kt[N])},[Kt,j]),pr=u.useRef(null),Fl=u.useCallback(l=>{if(Kt.length<=1)return;const d=l.touches[0];pr.current={startX:d.clientX,startY:d.clientY,active:!0}},[Kt.length]),Rl=u.useCallback(l=>{if(!pr.current||!pr.current.active)return;const d=l.touches[0];Math.abs(d.clientY-pr.current.startY)>45&&(pr.current.active=!1)},[]),Ol=u.useCallback(l=>{const d=pr.current;if(pr.current=null,!d||!d.active||Kt.length<=1)return;const K=l.changedTouches[0].clientX-d.startX;Math.abs(K)<60||oi(K<0?"next":"prev")},[oi,Kt.length]),li=u.useMemo(()=>new Set([..._e.map(l=>l.value),...Zs.map(l=>l.value),...wo.map(l=>l.value),...No.map(l=>l.value)]),[_e]),ci=u.useMemo(()=>Ot.filter(l=>!li.has(l)),[Ot,li]),di=(l,d)=>{Ft.current&&(window.clearTimeout(Ft.current),Ft.current=null),er.current&&(cancelAnimationFrame(er.current),er.current=null),Tn(d),ee(l),er.current=requestAnimationFrame(()=>{ne(!0),er.current=null})},Is=()=>{Y&&Mn!==null&&ys({type:Y,index:Mn,direction:"fromPanel"}),ne(!1),Ft.current&&window.clearTimeout(Ft.current),Ft.current=window.setTimeout(()=>{ee(null),Tn(null),ys(null),Ft.current=null},ja)},Ll=(l,d)=>{if(!wt||St)return;const N=()=>{d===0?di(l.metric_type,d):(ys({type:l.metric_type,index:d,direction:"toPanel"}),window.setTimeout(()=>{ys(null),di(l.metric_type,d)},ja))};Y?Y===l.metric_type&&ae?Is():(Is(),window.setTimeout(()=>{N()},ja)):N()},$s=l=>{wt&&(T({type:l,label:nt(l)}),W(!0))},[Bl,Gr]=u.useState(!1),[We,ar]=u.useState(null),[Lt,nr]=u.useState(null),[Ul,Ms]=u.useState(!1),[Vl,Ca]=u.useState(!1),[ui,Sa]=u.useState(""),[Zl,Aa]=u.useState(!1),[mi,Da]=u.useState(""),Wl=(l,d)=>{wt&&(ar({type:l,label:nt(l)}),nr(d||null),Gr(!0))},ql=()=>{Gr(!1),ar(null),nr(null)},Jl=async()=>{We&&(Gr(!1),Ms(!0))},Ts=async(l,d,N)=>{if(!Lt?.slotId||!Lt?.templateId||!e||!S||!Ke)return console.warn("[DiaryPage] Cannot save route event: missing slot/template/diary info"),!1;const K=await Cg({templateId:Lt.templateId,slotId:Lt.slotId,eventDate:Ke,eventFrom:Lt.from,eventTo:Lt.to,status:l,performedBy:S,reason:d||null,createdBy:S});if(K){console.log("[DiaryPage] Route event saved to DB:",K);const q=await _o(e,Ke);return Ur(q),!0}return!1},Ql=async()=>{if(We)try{Lt?.slotId&&await Ts("done"),await Fs(We.type,!0)}finally{Ms(!1),ar(null),nr(null)}},Kl=async()=>{if(We)try{Lt?.slotId&&await Ts("not_done","Отмечено как не выполнено"),await Fs(We.type,!1)}finally{Ms(!1),ar(null),nr(null)}},Hl=()=>{We&&(Gr(!1),Aa(!0))},Gl=async()=>{if(We){try{Lt?.slotId&&await Ts("not_done",mi||"Не указана причина")}catch(l){console.warn("[DiaryPage] Failed to save cancel event to DB",l)}await Fs(We.type,!1),Aa(!1),Da(""),ar(null),nr(null)}},hi=()=>{Aa(!1),Da(""),ar(null),nr(null)},Yl=()=>{We&&(Gr(!1),Ca(!0))},Xl=async()=>{if(We){try{Lt?.slotId&&await Ts("rescheduled",ui||"Не указана причина")}catch(l){console.warn("[DiaryPage] Failed to save reschedule event to DB",l)}Ca(!1),Lr(We.type),Qt(!0),Sa(""),ar(null),nr(null)}},fi=()=>{Ca(!1),Sa(""),ar(null),nr(null)},Fs=async(l,d)=>{if(e)try{const{data:N,error:K}=await F.rpc("save_metric_value",{p_diary_id:e,p_metric_key:l,p_value:typeof d=="object"?d:{value:d},p_recorded_at:new Date().toISOString(),p_metadata:{}});if(K){console.error("Ошибка сохранения метрики:",K),alert("Не удалось сохранить значение метрики. Попробуйте позже.");return}const q={id:N?.id||`value_${Date.now()}`,diary_id:e,metric_type:l,value:typeof d=="object"?d.value:d,created_at:N?.recorded_at||new Date().toISOString()},ge=Er([...B,q]);Z(ge),setTimeout(async()=>{try{const H=new Date().toISOString().split("T")[0],X=await Ba(e,H),{data:ue,error:Ee}=await F.from("diary_metric_values").select("*").eq("diary_id",e).order("recorded_at",{ascending:!1}).limit(100);if(!Ee&&ue){const Oe=(ue||[]).map(re=>{let we=re.value;return re.value&&typeof re.value=="object"&&"value"in re.value&&(we=re.value.value),{id:re.id,diary_id:re.diary_id,metric_type:re.metric_key,value:we,created_at:re.recorded_at||re.created_at}}),de=Er([...Oe,...X]);Z(de)}}catch(H){console.error("Ошибка перезагрузки значений:",H)}},500)}catch(N){console.error("Ошибка сохранения метрики:",N)}},gi=async()=>{if(!e||!f?.patient_card_id){alert("Не удалось создать ссылку: отсутствует карточка подопечного");return}try{const l=I?dt||ut||f.organization_id:f.organization_id||p,{data:d,error:N}=await F.rpc("generate_invite_link",{invite_type:"organization_client",payload:{patient_card_id:f.patient_card_id,diary_id:e,organization_id:l}});if(N){console.error("Ошибка создания приглашения клиента:",N),alert("Ошибка создания ссылки: "+N.message);return}if(!d||!d.token){alert("Ошибка создания ссылки: токен не получен");return}const{error:K}=await F.from("diary_client_links").upsert({diary_id:e,client_id:null,token:d.token,accepted_by:null,accepted_at:null},{onConflict:"diary_id"});K&&console.error("Ошибка создания записи в diary_client_links:",K);const q=`${i}/client-invite?diary=${e}&token=${d.token}`,ge=I?dt||ut||f.organization_id:f.organization_id||p,H={link:q,created_at:d.created_at||new Date().toISOString(),token:d.token,diary_id:e,patient_card_id:f.patient_card_id,organization_id:ge??null,accepted_by:null,accepted_at:null};tr(H),Rt(null);const{data:X}=await F.from("diary_client_links").select("*").eq("diary_id",e).maybeSingle();if(X){const ue={...H,accepted_by:X.accepted_by,accepted_at:X.accepted_at,client_id:X.client_id};tr(ue),xa(ue)}setTimeout(()=>{},500)}catch(l){console.error("Ошибка создания ссылки для клиента:",l),alert("Ошибка создания ссылки")}},Ea=async l=>{try{await navigator.clipboard.writeText(l),alert("Ссылка скопирована")}catch(d){console.error("Clipboard error",d),prompt("Скопируйте ссылку вручную",l)}},za=(l,d)=>{const N=`${d}
${l}`,K=`https://wa.me/?text=${encodeURIComponent(N)}`;window.open(K,"_blank","noopener,noreferrer")},ec=async()=>{if(!(!e||!a))try{const l=crypto.randomUUID(),d=`${i}/diaries/${e}?access=${l}`,{data:N,error:K}=await F.from("diary_external_access_links").insert({diary_id:e,link_token:l,created_by:a.id}).select().single();if(K){console.error("Ошибка создания внешней ссылки:",K),alert("Ошибка создания ссылки: "+K.message);return}const q={id:N.id,token:N.link_token,link:d,invited_email:N.invited_email||null,invited_phone:N.invited_phone||null,expires_at:N.expires_at||null,created_at:N.created_at};Sr([...vs,q])}catch(l){console.error("Ошибка создания внешней ссылки:",l),alert("Ошибка создания ссылки")}},tc=async l=>{if(e)try{const{error:d}=await F.from("diary_external_access_links").update({revoked_at:new Date().toISOString()}).eq("id",l).eq("diary_id",e);if(d){console.error("Ошибка отзыва внешней ссылки:",d),alert("Ошибка отзыва ссылки: "+d.message);return}Sr(vs.filter(N=>N.id!==l))}catch(d){console.error("Ошибка отзыва внешней ссылки:",d),alert("Ошибка отзыва ссылки")}},rc=async(l,d)=>{if(!e)return;const N=d.value!==void 0&&d.value!==null&&String(d.value).trim()!=="";let K=null;if(N){const ge=new Date,H=new Date(ge.getTime()-2e3),X=B.find(ue=>ue.metric_type===l&&String(ue.value)===String(d.value)&&new Date(ue.created_at)>H);if(X)console.log("[DiaryPage] Пропускаем сохранение: обнаружено дублирование значения",{metricType:l,value:d.value,recentValue:X});else try{const{data:ue,error:Ee}=await F.rpc("save_metric_value",{p_diary_id:e,p_metric_key:l,p_value:typeof d.value=="object"?d.value:{value:d.value},p_recorded_at:new Date().toISOString(),p_metadata:{}});if(Ee){console.error("Ошибка сохранения значения метрики:",Ee),alert("Не удалось сохранить значение метрики. Попробуйте позже.");return}K={id:ue?.id||`value_${Date.now()}`,diary_id:e,metric_type:l,value:typeof d.value=="object"?d.value.value:d.value,created_at:ue?.recorded_at||new Date().toISOString()}}catch(ue){console.error("Ошибка сохранения значения метрики:",ue),alert("Не удалось сохранить значение метрики. Попробуйте позже.");return}}const q={frequency:d.frequency,reminderStart:d.reminderStart,reminderEnd:d.reminderEnd,times:d.times};try{const{data:ge,error:H}=await F.from("diary_metrics").select("id, metadata").eq("diary_id",e).eq("metric_key",l).maybeSingle();if(H&&H.code!=="PGRST116")console.error("Ошибка поиска метрики для сохранения настроек:",H);else if(ge){const ue={...ge.metadata||{},settings:xr(q)},{error:Ee}=await F.from("diary_metrics").update({metadata:ue}).eq("id",ge.id);Ee?(console.error("Ошибка сохранения настроек метрики:",Ee),alert("Не удалось сохранить настройки метрики. Попробуйте позже.")):L(Oe=>Oe.map(de=>de.metric_type===l?{...de,settings:xr(q)}:de))}else console.warn("Метрика не найдена для сохранения настроек:",l),alert("Метрика не найдена. Сначала добавьте метрику в дневник.")}catch(ge){console.error("Ошибка сохранения настроек метрики:",ge),alert("Не удалось сохранить настройки метрики. Попробуйте позже.")}if(N&&K){const ge=Er([...B,K]);Z(ge),setTimeout(async()=>{try{const H=new Date().toISOString().split("T")[0],X=await Ba(e,H),{data:ue,error:Ee}=await F.from("diary_metric_values").select("*").eq("diary_id",e).order("recorded_at",{ascending:!1}).limit(100);if(!Ee&&ue){const Oe=(ue||[]).map(re=>{let we=re.value;return re.value&&typeof re.value=="object"&&"value"in re.value&&(we=re.value.value),{id:re.id,diary_id:re.diary_id,metric_type:re.metric_key,value:we,created_at:re.recorded_at||re.created_at}}),de=Er([...Oe,...X]);Z(de)}}catch(H){console.error("Ошибка перезагрузки значений:",H)}},500)}bs(ge=>({...ge,[l]:xr(q)})),ma(new Date),Y===l&&N&&Is()},Pa=()=>{Nl(!1),Zr(null),ct(null)},Yr=l=>{ws(d=>d.includes(l)?(Ns(N=>N.filter(K=>K!==l)),d.filter(N=>N!==l)):(ct(null),[...d,l]))},sc=l=>{Ns(d=>d.includes(l)?d.filter(N=>N!==l):d.length>=3?(ct("Можно закрепить не более трёх показателей"),d):(ct(null),ws(N=>N.includes(l)?N:[...N,l]),[...d,l]))},ac=()=>{if(!(!At||!R)){if(ct(null),!st.fullName.trim()){ct("Введите ФИО подопечного");return}Un(!0);try{const l=JSON.parse(localStorage.getItem("patient_cards")||"[]"),d=st.diagnoses?st.diagnoses.split(",").map(H=>H.trim()).filter(Boolean):[],N=st.mobility==="walks"||st.mobility==="sits"||st.mobility==="lies"?st.mobility:R.mobility,K={...R,full_name:st.fullName.trim(),date_of_birth:st.dateOfBirth?st.dateOfBirth:null,address:st.address?st.address.trim():null,diagnoses:d,mobility:N},q=l.map(H=>H.id===R.id?K:H);localStorage.setItem("patient_cards",JSON.stringify(q));const ge=localStorage.getItem("current_user");if(ge)try{const H=JSON.parse(ge),X={...H,user_metadata:{...H.user_metadata||{},patient_cards:q}};localStorage.setItem("current_user",JSON.stringify(X))}catch(H){console.warn("Не удалось обновить current_user при сохранении карточки",H)}G(K),mr({fullName:K.full_name,dateOfBirth:K.date_of_birth||"",address:K.address||"",diagnoses:K.diagnoses.join(", "),mobility:K.mobility}),Zr("Карточка подопечного обновлена")}catch(l){console.error("Error updating patient card from settings:",l),ct("Не удалось сохранить изменения карточки")}finally{Un(!1)}}},nc=async()=>{if(!it||!e)return;ct(null);const l=Array.from(new Set(Ot));if(l.length===0){ct("Выберите минимум один показатель");return}const d=Bn.filter(N=>l.includes(N));if(d.length>3){ct("Можно закрепить не более трёх показателей");return}Ns(d),ws(l),pa(!0);try{const{data:N,error:K}=await F.from("diary_metrics").select("*").eq("diary_id",e);if(K){console.error("Ошибка загрузки метрик:",K),ct("Не удалось загрузить показатели"),pa(!1);return}const q=new Map(M.map(re=>[re.metric_type,re])),ge=new Map((N||[]).map(re=>[re.metric_key,re])),H=[];d.forEach(re=>{const we=ge.get(re),je=q.get(re)?.settings||Cr[re];H.push({id:we?.id,diary_id:e,metric_key:re,is_pinned:!0,metadata:je?{settings:xr(je)}:void 0})}),l.filter(re=>!d.includes(re)).forEach(re=>{const we=ge.get(re),je=q.get(re)?.settings||Cr[re];H.push({id:we?.id,diary_id:e,metric_key:re,is_pinned:!1,metadata:je?{settings:xr(je)}:void 0})});const X=M.map(re=>re.metric_type).filter(re=>!l.includes(re));if(X.length>0){const{error:re}=await F.from("diary_metrics").delete().eq("diary_id",e).in("metric_key",X);re&&console.error("Ошибка удаления метрик:",re)}const ue=H.map(async re=>{if(re.id){const{error:we}=await F.from("diary_metrics").update({is_pinned:re.is_pinned,metadata:re.metadata||{}}).eq("id",re.id);we&&console.error("Ошибка обновления метрики:",we)}else{const{error:we}=await F.from("diary_metrics").insert({diary_id:re.diary_id,metric_key:re.metric_key,is_pinned:re.is_pinned,metadata:re.metadata||{}});we&&console.error("Ошибка создания метрики:",we)}});await Promise.all(ue);const Ee={...Cr};X.forEach(re=>{Ee[re]&&delete Ee[re]});const{data:Oe,error:de}=await F.from("diary_metrics").select("*").eq("diary_id",e);if(!de&&Oe){const re=Oe.map(Ne=>({id:Ne.id,diary_id:Ne.diary_id,metric_type:Ne.metric_key,is_pinned:Ne.is_pinned,settings:Ne.metadata?.settings||void 0}));L(re);const we={};re.forEach(Ne=>{Ne.settings&&(we[Ne.metric_type]=xr(Ne.settings))}),bs({...we,...Ee})}else console.error("Ошибка перезагрузки метрик:",de),alert("Не удалось обновить метрики. Попробуйте обновить страницу.");Zr("Показатели обновлены")}catch(N){console.error("Error updating diary metrics from settings:",N),ct("Не удалось сохранить показатели")}finally{pa(!1)}};return!f||!R?t.jsx("div",{className:"min-h-screen bg-gray-100 flex items-center justify-center",children:t.jsx("p",{className:"text-gray-600",children:"Загрузка..."})}):!Cl&&I&&_==="patronage_agency"?t.jsx("div",{className:"min-h-screen bg-gray-100 flex items-center justify-center",children:t.jsx("p",{className:"text-gray-600",children:"Загрузка доступа..."})}):Ds?t.jsxs("div",{className:"min-h-screen bg-gray-100",children:[t.jsx("header",{className:"bg-white shadow-sm",children:t.jsxs("div",{className:"flex items-center justify-between px-4 py-3",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("button",{onClick:()=>r("/dashboard"),className:"-ml-2 flex items-center justify-center w-6 h-6","aria-label":"Назад",children:t.jsx("img",{src:"/icons/Иконка стрелка.png",alt:"Назад",className:"w-full h-full object-contain"})}),t.jsx("h1",{className:"text-lg font-bold text-gray-dark",children:"Дневник здоровья"})]}),t.jsx("span",{className:"w-9 h-9"})]})}),t.jsx("div",{className:"bg-white border-b border-gray-200",children:t.jsx("div",{className:"flex",role:"tablist","aria-label":"Разделы дневника",children:ka.map(l=>t.jsx("button",{type:"button",onClick:()=>v(l.id),role:"tab","aria-selected":j===l.id,className:`flex-1 py-3.5 text-base font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-[#55ACBF] ${j===l.id?"text-gray-dark border-b-2 border-[#7DD3DC]":"text-gray-400"}`,children:l.label},l.id))})}),t.jsxs("div",{className:"px-4 py-6 max-w-md mx-auto pb-6",onTouchStart:Fl,onTouchMove:Rl,onTouchEnd:Ol,children:[j==="diary"&&t.jsxs("div",{className:"space-y-6",children:[Kn.length>0&&t.jsxs("div",{children:[t.jsx("h2",{className:"text-xl font-bold text-gray-dark mb-4",children:"Закрепленные показатели"}),t.jsxs("div",{className:"relative",children:[t.jsx("div",{className:`grid grid-cols-3 gap-3 transition-opacity duration-300 ${ae?"opacity-0 pointer-events-none":"opacity-100"}`,style:{gap:lt?"8px":"12px"},children:Kn.map((l,d)=>{const K=ei(l.metric_type)||"--",q=St?.type===l.metric_type,H={transform:`translate3d(${q&&(St.direction==="toPanel"||St.direction==="fromPanel")?St.index===1?"calc(-100% - 12px)":St.index===2?"calc(-200% - 24px)":"0":"0"}, 0, 0)`,transition:"transform 480ms cubic-bezier(0.2, 0.8, 0.2, 1), opacity 240ms ease",zIndex:q?10:"auto"};return St&&St.type!==l.metric_type&&(H.opacity=ae?0:1),t.jsxs("button",{onClick:()=>Ll(l,d),className:`bg-gradient-to-br from-[#61B4C6] to-[#317799] rounded-2xl text-white text-center shadow-md flex flex-col items-center w-full min-w-0 ${wt?"":"opacity-60 cursor-not-allowed"}`,style:{fontFamily:"Manrope, sans-serif",padding:lt?"8px":"12px",borderRadius:lt?"12px":"16px",...H},disabled:!wt||!!St&&St.type!==l.metric_type,children:[t.jsx("div",{className:"text-base font-bold w-full text-center mb-2",style:{fontFamily:"Manrope, sans-serif",fontWeight:700,minHeight:lt?"32px":"38px",lineHeight:"1.1",display:"flex",alignItems:"center",justifyContent:"center",fontSize:lt?"12px":"16px"},children:nt(l.metric_type)}),t.jsx("div",{className:"flex items-center justify-center w-full",style:{height:lt?"70px":"90px"},children:t.jsxs("div",{className:"relative flex items-center justify-center",style:{width:lt?"70px":"90px",height:lt?"70px":"90px",minWidth:lt?"70px":"90px",minHeight:lt?"70px":"90px"},children:[t.jsx("svg",{className:"absolute inset-0 w-full h-full",viewBox:"0 0 90 90",preserveAspectRatio:"xMidYMid meet",children:t.jsx("circle",{cx:"45",cy:"45",r:"38",fill:"none",stroke:"#4A4A4A",strokeWidth:"3",strokeDasharray:"4 4",opacity:"0.9"})}),t.jsx("div",{className:"text-2xl font-bold relative z-10 text-center",style:{fontFamily:"Manrope, sans-serif",fontWeight:700,fontSize:lt?"18px":"24px"},children:K})]})}),t.jsxs("div",{className:"w-full space-y-1.5 mt-2",children:[t.jsx("div",{className:"text-xs opacity-90 text-center",style:{fontFamily:"Manrope, sans-serif",fontWeight:400,fontSize:lt?"10px":"12px"},children:Cr[l.metric_type]?.times?.length?`Заполнить через: ${Il(l.metric_type)}`:"Выберите время"}),t.jsx("div",{className:"w-full text-xs text-white py-1.5 text-center",style:{fontFamily:"Manrope, sans-serif",fontWeight:400,backgroundColor:"#4A4A4A",borderRadius:"12px",fontSize:lt?"10px":"12px",paddingTop:lt?"4px":"6px",paddingBottom:lt?"4px":"6px"},children:"Заполнить"})]})]},l.id)})}),Y&&t.jsx("div",{className:`absolute inset-0 w-full h-full origin-left transition-transform duration-[600ms] cubic-bezier(0.2, 0.8, 0.2, 1) shadow-lg ${ae?"scale-x-100":"scale-x-0"}`,style:{transformOrigin:"left center",zIndex:20},children:t.jsx(Eg,{metricType:Y,metricLabel:nt(Y),lastValue:ei(Y),onSave:rc,onClose:Is,initialTimes:Cr[Y]?.times},Y)})]})]}),t.jsxs("div",{className:"mt-8",children:[t.jsx("h2",{className:"text-xl font-bold text-gray-dark mb-4",children:"Все показатели"}),Hn.length>0&&t.jsxs("div",{className:"bg-white rounded-3xl shadow-sm mb-4 overflow-hidden",children:[t.jsxs("button",{onClick:()=>Hr("care"),className:"w-full px-6 py-5 flex flex-col items-center justify-center",children:[t.jsx("h3",{className:"text-xl font-bold text-gray-dark text-center mb-2",children:"Показатели ухода"}),t.jsx("p",{className:"text-sm text-gray-500 text-center mb-3",children:"Прогулка, когнитивные игры, гигиена, сон и т.д."}),t.jsx("img",{src:"/icons/иконка маленькая стрелка.png",alt:"Раскрыть",className:`w-4 h-4 transition-transform ${h.care?"-rotate-90":"rotate-90"}`})]}),h.care&&t.jsx("div",{className:"px-5 pb-5 pt-1 border-t border-gray-100",children:t.jsx("div",{className:"grid grid-cols-2 gap-3 mt-4",children:Hn.map(l=>t.jsx("button",{onClick:()=>$s(l.metric_type),disabled:!wt,className:`py-3 px-4 border-2 border-[#7DD3DC] text-gray-dark rounded-2xl font-medium text-sm transition-colors ${wt?"hover:bg-[#7DD3DC] hover:text-white":"opacity-60 cursor-not-allowed"}`,children:nt(l.metric_type)},l.id))})})]}),Gn.length>0&&t.jsxs("div",{className:"bg-white rounded-3xl shadow-sm mb-4 overflow-hidden",children:[t.jsxs("button",{onClick:()=>Hr("physical"),className:"w-full px-6 py-5 flex flex-col items-center justify-center",children:[t.jsx("h3",{className:"text-xl font-bold text-gray-dark text-center mb-2",children:"Физические показатели"}),t.jsx("p",{className:"text-sm text-gray-500 text-center mb-3",children:"Температура, давление, сатурация и т.д."}),t.jsx("img",{src:"/icons/иконка маленькая стрелка.png",alt:"Раскрыть",className:`w-4 h-4 transition-transform ${h.physical?"-rotate-90":"rotate-90"}`})]}),h.physical&&t.jsx("div",{className:"px-5 pb-5 pt-1 border-t border-gray-100",children:t.jsx("div",{className:"grid grid-cols-2 gap-3 mt-4",children:Gn.map(l=>t.jsx("button",{onClick:()=>$s(l.metric_type),disabled:!wt,className:`py-3 px-4 border-2 border-[#7DD3DC] text-gray-dark rounded-2xl font-medium text-sm transition-colors ${wt?"hover:bg-[#7DD3DC] hover:text-white":"opacity-60 cursor-not-allowed"}`,children:nt(l.metric_type)},l.id))})})]}),Yn.length>0&&t.jsxs("div",{className:"bg-white rounded-3xl shadow-sm mb-4 overflow-hidden",children:[t.jsxs("button",{onClick:()=>Hr("excretion"),className:"w-full px-6 py-5 flex flex-col items-center justify-center",children:[t.jsx("h3",{className:"text-xl font-bold text-gray-dark text-center mb-2",children:"Выделение мочи и кала"}),t.jsx("p",{className:"text-sm text-gray-500 text-center mb-3",children:"Выпито/выделено, цвет мочи и дефекация"}),t.jsx("img",{src:"/icons/иконка маленькая стрелка.png",alt:"Раскрыть",className:`w-4 h-4 transition-transform ${h.excretion?"-rotate-90":"rotate-90"}`})]}),h.excretion&&t.jsx("div",{className:"px-5 pb-5 pt-1 border-t border-gray-100",children:t.jsx("div",{className:"grid grid-cols-1 gap-3 mt-4",children:Yn.map(l=>t.jsx("button",{onClick:()=>$s(l.metric_type),disabled:!wt,className:`py-3 px-4 border-2 border-[#7DD3DC] text-gray-dark rounded-2xl font-medium text-sm transition-colors ${wt?"hover:bg-[#7DD3DC] hover:text-white":"opacity-60 cursor-not-allowed"}`,children:nt(l.metric_type)},l.id))})})]}),Xn.length>0&&t.jsxs("div",{className:"bg-white rounded-3xl shadow-sm mb-4 overflow-hidden",children:[t.jsxs("button",{onClick:()=>Hr("symptoms"),className:"w-full px-6 py-5 flex flex-col items-center justify-center",children:[t.jsx("h3",{className:"text-xl font-bold text-gray-dark text-center mb-2",children:"Тягостные симптомы"}),t.jsx("p",{className:"text-sm text-gray-500 text-center mb-3",children:"Рвота, тошнота, зуд, кашель, одышка и т.д."}),t.jsx("img",{src:"/icons/иконка маленькая стрелка.png",alt:"Раскрыть",className:`w-4 h-4 transition-transform ${h.symptoms?"-rotate-90":"rotate-90"}`})]}),h.symptoms&&t.jsx("div",{className:"px-5 pb-5 pt-1 border-t border-gray-100",children:t.jsx("div",{className:"grid grid-cols-2 gap-3 mt-4",children:Xn.map(l=>t.jsx("button",{onClick:()=>$s(l.metric_type),disabled:!wt,className:`py-3 px-4 border-2 border-[#7DD3DC] text-gray-dark rounded-2xl font-medium text-sm transition-colors ${wt?"hover:bg-[#7DD3DC] hover:text-white":"opacity-60 cursor-not-allowed"}`,children:nt(l.metric_type)},l.id))})})]})]}),t.jsxs("div",{className:"mt-6 space-y-3",children:[it&&t.jsx("button",{onClick:()=>r(`/diaries/${e}/edit-metrics`),className:"w-full bg-white rounded-3xl shadow-sm px-5 py-3 text-center",children:t.jsx("h3",{className:"text-base font-bold text-[#7DD3DC]",children:"Изменить показатели"})}),$t&&t.jsxs("div",{className:"bg-white rounded-3xl shadow-sm overflow-hidden",children:[t.jsxs("button",{onClick:()=>Hr("accessManagement"),className:"w-full px-4 py-2 flex flex-col items-center justify-center",children:[t.jsx("h3",{className:"text-sm font-bold text-red-600 text-center mb-1.5",children:"Управление доступом"}),t.jsx("img",{src:"/icons/иконка маленькая стрелка.png",alt:"Раскрыть",className:`w-3 h-3 transition-transform ${h.accessManagement?"-rotate-90":"rotate-90"}`})]}),h.accessManagement&&t.jsxs("div",{className:"px-4 py-3 border-t border-gray-100 space-y-4",children:[vt==="patronage_agency"&&(P||I)&&t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-semibold text-gray-700 mb-2",children:"Добавить специалиста"}),It.filter(l=>!jt.some(d=>d.user_id===l.user_id)).length===0?t.jsx("p",{className:"text-xs text-gray-500",children:"Все специалисты уже имеют доступ или отсутствуют в списке."}):t.jsxs("div",{className:"flex gap-2",children:[t.jsxs("select",{value:Jr,onChange:l=>As(l.target.value),className:"flex-1 rounded-2xl border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:border-[#7DD3DC] bg-white",children:[t.jsx("option",{value:"",children:"Выберите специалиста"}),It.filter(l=>!jt.some(d=>d.user_id===l.user_id)).map(l=>t.jsxs("option",{value:l.user_id,children:[`${l.first_name||""} ${l.last_name||""}`.trim()||l.user_id," ",l.role?`(${l.role})`:""]},l.user_id))]}),t.jsx("button",{onClick:()=>va(),disabled:!Jr,className:"px-4 py-2 rounded-2xl bg-gradient-to-r from-[#7DD3DC] to-[#5CBCC7] text-white text-sm font-semibold disabled:opacity-60 disabled:cursor-not-allowed transition-opacity",children:"Добавить"})]})]}),t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-semibold text-gray-700 mb-2",children:"Специалисты с доступом:"}),Kr.length===0?t.jsx("p",{className:"text-sm text-gray-500",children:"Нет назначенных специалистов"}):t.jsx("div",{className:"space-y-2",children:Kr.map(l=>t.jsxs("div",{className:"flex items-center justify-between py-2 border-b border-gray-100",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-gray-800",children:`${l.first_name||""} ${l.last_name||""}`.trim()||l.user_id}),l.role&&t.jsx("p",{className:"text-xs text-gray-500",children:l.role})]}),t.jsx("button",{onClick:()=>Qn(l.user_id),className:"text-red-600 hover:text-red-700 text-lg","aria-label":"Удалить доступ специалиста",children:"🗑️"})]},l.user_id))})]})]}),vt==="pension"&&(P||I)&&It.length>0&&t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-semibold text-gray-700 mb-2",children:"Добавить специалиста"}),It.filter(l=>!jt.some(d=>d.user_id===l.user_id)).length===0?t.jsx("p",{className:"text-xs text-gray-500",children:"Все специалисты уже имеют доступ или отсутствуют в списке."}):t.jsxs("div",{className:"flex gap-2",children:[t.jsxs("select",{value:Jr,onChange:l=>As(l.target.value),className:"flex-1 rounded-2xl border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:border-[#7DD3DC] bg-white",children:[t.jsx("option",{value:"",children:"Выберите специалиста"}),It.filter(l=>!jt.some(d=>d.user_id===l.user_id)).map(l=>t.jsxs("option",{value:l.user_id,children:[`${l.first_name||""} ${l.last_name||""}`.trim()||l.user_id," ",l.role?`(${l.role})`:""]},l.user_id))]}),t.jsx("button",{onClick:()=>va(),disabled:!Jr,className:"px-4 py-2 rounded-2xl bg-gradient-to-r from-[#7DD3DC] to-[#5CBCC7] text-white text-sm font-semibold disabled:opacity-60 disabled:cursor-not-allowed transition-opacity",children:"Добавить"})]})]}),t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-semibold text-gray-700 mb-2",children:"Сотрудники организации"}),t.jsx("div",{className:"space-y-2",children:It.map(l=>{let d=!0;return vt==="pension"?d=!jt.find(K=>K.user_id===l.user_id&&K.revoked_at):d=Kr.some(N=>N.user_id===l.user_id),t.jsxs("div",{className:"flex items-center justify-between py-2 border-b border-gray-100",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-gray-800",children:`${l.first_name||""} ${l.last_name||""}`.trim()||l.user_id}),l.role&&t.jsx("p",{className:"text-xs text-gray-500",children:l.role}),d&&t.jsx("p",{className:"text-xs text-green-600 mt-1",children:"✓ Доступ предоставлен"}),!d&&t.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"Нет доступа"})]}),d?t.jsx("button",{onClick:()=>Qn(l.user_id),className:"text-red-600 hover:text-red-700 text-lg","aria-label":"Удалить доступ специалиста",title:"Убрать доступ",children:"🗑️"}):t.jsx("button",{onClick:()=>va(l.user_id),className:"text-[#7DD3DC] hover:text-[#5CBCC7] text-lg","aria-label":"Добавить доступ специалиста",title:"Добавить доступ",children:"➕"})]},`pension-${l.user_id}`)})}),t.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"Вы можете добавлять и убирать доступ у сотрудников пансионата."})]})]}),t.jsxs("div",{className:"space-y-3",children:[t.jsx("p",{className:"text-sm font-semibold text-gray-700",children:"Текущий доступ"}),fr&&t.jsxs("div",{className:"py-2 border-b border-gray-100",children:[t.jsx("p",{className:"text-sm text-gray-800",children:"Организация (этот аккаунт)"}),t.jsx("p",{className:"text-xs text-gray-500",children:f?.organization_id?`ID: ${f.organization_id}`:"ID не указан"})]}),Es&&!fr&&t.jsxs("div",{className:"py-2 border-b border-gray-100",children:[t.jsx("p",{className:"text-sm text-gray-800",children:"Сотрудник организации"}),t.jsxs("p",{className:"text-xs text-gray-500",children:["Доступ предоставлен организацией (ID: ",f?.organization_id||"—",")"]})]}),vt==="patronage_agency"&&fr&&Kr.length===0&&t.jsx("p",{className:"text-xs text-gray-500",children:"Нет назначенных специалистов"}),vt==="pension"&&fr&&It.length===0&&t.jsx("p",{className:"text-xs text-gray-500",children:"Все сотрудники пансионата имеют доступ к дневнику автоматически."}),f?.caregiver_id&&t.jsxs("div",{className:"flex items-center justify-between py-2 border-b border-gray-100",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-gray-800",children:"Частная сиделка"}),t.jsxs("p",{className:"text-xs text-gray-500",children:["ID: ",f.caregiver_id]})]}),$t&&t.jsx("button",{onClick:()=>zs("caregiver"),className:"text-red-600 hover:text-red-700 text-lg","aria-label":"Удалить доступ сиделки",children:"🗑️"})]}),f?.organization_id&&$t&&t.jsxs("div",{className:"flex items-center justify-between py-2 border-b border-gray-100",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-gray-800",children:Wr?.name||"Организация"}),t.jsxs("p",{className:"text-xs text-gray-500",children:[Wr?.type==="patronage_agency"?"Патронажное агентство":Wr?.type==="pension"?"Пансионат":"Организация",Wr?.id&&` (ID: ${Wr.id})`]})]}),t.jsx("button",{onClick:()=>zs("organization"),className:"text-red-600 hover:text-red-700 text-lg","aria-label":"Удалить доступ организации",title:"Отвязать дневник от организации",children:"🗑️"})]}),!f?.organization_id&&!f?.caregiver_id&&(_!=="patronage_agency"||Kr.length===0)&&t.jsx("p",{className:"text-sm text-gray-500 text-center",children:"Нет активных доступов"}),!$t&&!fr&&!Es&&t.jsx("p",{className:"text-xs text-gray-500 text-center",children:"У вас нет прав для изменения доступа"})]})]})]})]})]}),j==="history"&&t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"relative",ref:ga,children:[t.jsxs("div",{className:"bg-white rounded-[32px] shadow-[0_14px_35px_rgba(9,109,131,0.08)] px-6 py-6 text-center space-y-3",children:[t.jsx("p",{className:"text-xs text-[#4A4A4A] uppercase tracking-wide",children:"Нажмите, чтобы выбрать дату истории заполнения"}),t.jsx("button",{onClick:()=>_s(l=>!l),className:"w-full","aria-label":"Выбрать дату",children:t.jsxs("div",{className:"relative bg-gradient-to-b from-[#F6FEFF] via-[#F0FBFD] to-[#E6F8FA] border border-[#C5EEF2] rounded-[28px] px-5 py-4 shadow-[0_12px_30px_rgba(9,109,131,0.08)]",children:[t.jsx("p",{className:"text-[20px] font-semibold text-[#0A6D83]",children:$l}),t.jsx("p",{className:"text-xs text-[#7BA0A6] mt-1",children:"Отчёт будет построен за этот день"})]})})]}),ha&&t.jsx("div",{className:"absolute left-0 right-0 mt-4 z-30",children:t.jsxs("div",{className:"bg-white rounded-[32px] shadow-[0_26px_45px_rgba(9,109,131,0.18)] px-6 py-6",children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsx("button",{onClick:()=>fa(new Date(_t.getFullYear(),_t.getMonth()-1,1)),className:"p-2 rounded-full bg-[#F3FBFD] text-[#0A6D83] hover:bg-[#E8F7FA] transition","aria-label":"Предыдущий месяц",children:"‹"}),t.jsx("div",{className:"text-[#0A6D83] font-semibold text-base",children:Tl}),t.jsx("button",{onClick:()=>fa(new Date(_t.getFullYear(),_t.getMonth()+1,1)),className:"p-2 rounded-full bg-[#F3FBFD] text-[#0A6D83] hover:bg-[#E8F7FA] transition","aria-label":"Следующий месяц",children:"›"})]}),t.jsx("div",{className:"grid grid-cols-7 gap-2 text-xs font-semibold text-[#7BA0A6] mb-3",children:["ПН","ВТ","СР","ЧТ","ПТ","СБ","ВС"].map(l=>t.jsx("div",{className:"text-center uppercase tracking-wide",children:l},l))}),t.jsx("div",{className:"grid grid-cols-7 gap-2",children:Ml.map(l=>t.jsx("button",{onClick:()=>{wl(l.key),fa(new Date(l.date.getFullYear(),l.date.getMonth(),1)),_s(!1)},className:`h-10 w-10 rounded-full flex items-center justify-center text-sm transition ${l.isSelected?"bg-gradient-to-r from-[#7DD3DC] to-[#5CBCC7] text-white shadow-md":l.isCurrentMonth?"text-[#0A6D83]":"text-[#B6C9CD]"} ${l.isToday&&!l.isSelected?"border border-[#7DD3DC]":""}`,"aria-label":`Выбрать ${l.key}`,children:l.label},`${l.key}-${l.label}`))}),t.jsx("div",{className:"flex justify-center mt-4",children:t.jsx("div",{className:"w-0 h-0 border-l-[12px] border-r-[12px] border-l-transparent border-r-transparent border-t-white"})})]})})]}),t.jsxs("div",{className:"bg-[#E8F9FB] rounded-[32px] px-5 py-6 space-y-6",children:[t.jsxs("div",{children:[t.jsx("h3",{className:"text-base font-semibold text-[#4A4A4A] mb-3",children:"Принятые лекарства и витамины"}),t.jsx("div",{className:"bg-white/85 rounded-[24px] px-4 py-4 space-y-2",children:ai.length>0?ai.map(l=>t.jsxs("div",{className:"space-y-2",children:[t.jsx("p",{className:"text-xs font-semibold text-[#0A6D83] uppercase tracking-wide pl-1",children:l.label}),l.items.map((d,N)=>t.jsxs("div",{className:"bg-white border border-[#7DD3DC] rounded-full px-4 py-2 text-sm text-[#4A4A4A] flex items-center justify-between gap-3",children:[t.jsx("span",{className:"flex-1 whitespace-normal break-words leading-tight",children:d.displayValue&&d.displayValue!=="--"?d.displayValue:d.label}),t.jsx("span",{className:"text-xs text-[#0A6D83] font-semibold whitespace-nowrap self-center",children:d.time})]},d.uniqueKey||`${d.id}_${d.metric_type}_${d.created_at}_${N}`))]},l.metricType)):t.jsx("p",{className:"text-sm text-[#7BA0A6] text-center",children:"Нет записей за эту дату"})})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-base font-semibold text-[#4A4A4A] mb-3",children:"Отчёт за сегодня"}),t.jsx("div",{className:"bg-white/85 rounded-[24px] px-4 py-4 space-y-2",children:ni.length>0?ni.map(l=>t.jsxs("div",{className:"space-y-2",children:[t.jsx("p",{className:"text-xs font-semibold text-[#0A6D83] uppercase tracking-wide pl-1",children:l.label}),l.items.map((d,N)=>t.jsxs("div",{className:"bg-white border border-[#7DD3DC] rounded-full px-4 py-2 text-sm text-[#4A4A4A] flex items-center justify-between gap-3",children:[t.jsx("span",{className:"flex-1 whitespace-normal break-words leading-tight",children:d.displayValue&&d.displayValue!=="--"?d.displayValue:""}),t.jsx("span",{className:"text-xs text-[#0A6D83] font-semibold whitespace-nowrap self-center",children:d.time})]},d.uniqueKey||`${d.id}_${d.metric_type}_${d.created_at}_${N}`))]},l.metricType)):t.jsx("p",{className:"text-sm text-[#7BA0A6] text-center",children:"Нет записей за эту дату"})})]})]})]}),j==="route"&&t.jsxs("div",{className:"space-y-6",children:[(!ur||ur.length===0)&&t.jsx("div",{className:"bg-white rounded-[20px] shadow-[0_12px_30px_rgba(9,109,131,0.06)] px-6 py-5",children:t.jsx("p",{className:"text-sm text-[#4A4A4A] leading-relaxed",children:"Маршрутный лист показывает, какие манипуляции нужно выполнять с подопечным, когда и с какой периодичностью (ежедневно, раз в неделю). Можно составить вручную или воспользоваться ИИ, который предложит готовый вариант на основе дневника динамики ухода. С маршрутным листом легко согласовать, изменить и отслеживать выполнение всех процедур."})}),t.jsx("h2",{className:"text-2xl font-bold text-gray-dark",children:"Настроить маршрутный лист"}),ur&&ur.length>0&&t.jsxs("div",{className:"bg-white rounded-3xl shadow-sm mb-4 overflow-hidden p-4",children:[t.jsx("h2",{className:"text-xl font-bold text-gray-dark mb-3 text-center",children:"Манипуляции на сегодня"}),t.jsx("div",{className:"max-w-md mx-auto",children:t.jsx("div",{className:"border rounded-lg overflow-hidden",children:Array.from({length:14}).map((l,d)=>{const N=7+d,K=ur.filter(q=>Math.floor(q.startMinutes/60)===N);return t.jsxs("div",{className:"flex items-start gap-3 py-2 px-3 border-b last:border-b-0",children:[t.jsxs("div",{className:"w-16 text-sm text-gray-500",children:[String(N).padStart(2,"0"),":00"]}),t.jsx("div",{className:"flex-1 min-h-[40px]",children:K.length===0?t.jsx("div",{className:"text-xs text-gray-300",children:" "}):t.jsx("div",{className:"flex flex-col gap-2",children:K.map(q=>{const H=(()=>{if(!q.status)return{bg:"bg-[#CFF6F8]",text:"text-[#0A6D83]",btnBg:"bg-[#2AA6B1]",btnText:"Заполнить"};switch(q.status){case"done":return{bg:"bg-green-100",text:"text-green-800",btnBg:"bg-green-600",btnText:"✓ Выполнено"};case"not_done":return{bg:"bg-red-100",text:"text-red-800",btnBg:"bg-red-500",btnText:"✗ Не выполнено"};case"rescheduled":return{bg:"bg-yellow-100",text:"text-yellow-800",btnBg:"bg-yellow-600",btnText:"↻ Перенесено"};case"cancelled":return{bg:"bg-gray-200",text:"text-gray-600",btnBg:"bg-gray-500",btnText:"Отменено"};case"missed":return{bg:"bg-orange-100",text:"text-orange-800",btnBg:"bg-orange-500",btnText:"Просрочено"};default:return{bg:"bg-[#CFF6F8]",text:"text-[#0A6D83]",btnBg:"bg-[#2AA6B1]",btnText:"Заполнить"}}})(),X=q.status==="done"||q.status==="not_done"||q.status==="cancelled";return t.jsxs("div",{className:`inline-flex items-center justify-between ${H.bg} ${H.text} rounded-md px-3 py-2 shadow-sm`,children:[t.jsxs("div",{className:"flex flex-col",children:[t.jsx("div",{className:"text-sm font-semibold",children:q.label}),t.jsxs("div",{className:`text-xs ${H.text} opacity-80`,children:[q.from,q.from!==q.to?` — ${q.to}`:""]}),q.reason&&t.jsxs("div",{className:`text-xs ${H.text} opacity-70 mt-1`,children:["Причина: ",q.reason]})]}),X?t.jsx("span",{className:`ml-3 text-xs ${H.btnBg} text-white rounded-md px-2 py-1`,children:H.btnText}):t.jsx("button",{onClick:()=>Wl(q.metric,{slotId:q.slotId,templateId:q.templateId,from:q.from,to:q.to}),className:`ml-3 text-xs text-white ${H.btnBg} rounded-md px-2 py-1`,children:H.btnText})]},`${q.metric}_${q.from}`)})})})]},N)})})}),t.jsx("div",{className:"mt-4 flex justify-center",children:t.jsx("button",{type:"button",onClick:()=>fe(!0),className:"px-8 py-2.5 rounded-full bg-[#4A4A4A] text-white text-sm font-semibold shadow-sm hover:opacity-90 transition-opacity",children:"Изменить"})})]}),(!ur||ur.length===0)&&t.jsxs("div",{className:"bg-white rounded-2xl shadow-sm p-6",children:[t.jsx("p",{className:"text-base text-gray-700 mb-6",children:"Добавьте манипуляции вручную или с помощью ИИ"}),t.jsxs("div",{className:"flex flex-col items-center gap-3",children:[t.jsx("button",{type:"button",onClick:()=>Q(!0),className:"px-6 py-2 rounded-full bg-[#4A4A4A] text-white text-sm font-semibold shadow-sm hover:opacity-90",children:"Добавить"}),t.jsx("button",{type:"button",onClick:()=>Q(!0),className:"px-6 py-2 rounded-full bg-gradient-to-r from-[#0A6D83] to-[#2A9DB0] text-white text-sm font-semibold shadow-sm hover:opacity-90",children:"Добавить с ИИ"})]})]})]}),b&&t.jsxs("div",{className:"fixed inset-0 z-50",children:[t.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:()=>Q(!1)}),t.jsx("div",{className:"absolute left-0 right-0 bottom-0 mx-auto w-full max-w-3xl",children:t.jsxs("div",{className:"bg-white rounded-t-3xl shadow-lg p-4 pb-6 max-h-[80vh] overflow-auto transform transition-transform duration-200 ease-out",children:[t.jsx("div",{className:"w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-3"}),t.jsxs("div",{className:"flex items-center justify-center mb-2 text-center relative",children:[t.jsx("h3",{className:"text-3xl font-black text-[#25ADB8]",children:"Выбор манипуляций"}),t.jsx("button",{onClick:()=>Q(!1),"aria-label":"Закрыть",className:"text-2xl absolute right-0",children:"×"})]}),t.jsx("p",{className:"text-sm text-gray-600 mb-4 text-center border-t border-gray-100 pt-4",children:"Чтобы выбрать манипуляции, которые необходимо выполнять специалисту, выберите их, укажите дни, по которым нужно проводить а также порядок выполнения."}),t.jsx("h3",{className:"text-2xl font-black text-[#4A4A4A] text-center mb-5",children:"Манипуляции ухода"}),t.jsx("div",{className:"grid grid-cols-2 gap-3",children:_e.map(l=>t.jsxs("div",{className:"relative",children:[t.jsx("button",{onClick:()=>me(l.value),className:`w-full py-3 px-4 rounded-xl shadow-sm border border-[#25ACB7] text-sm font-medium text-center ${ye.includes(l.value)?"bg-[#CFF6F8] border-[#0A6D83]":"bg-white border-gray-200"}`,children:l.label}),!xe.current.has(l.value)&&t.jsx("button",{onClick:d=>{d.stopPropagation(),$e(l.value)},"aria-label":`Удалить ${l.label}`,className:"absolute top-1 right-1 text-xs text-red-500 bg-white rounded-full w-6 h-6 flex items-center justify-center shadow-sm",title:"Удалить",children:"×"})]},l.value))}),t.jsxs("div",{className:"mt-6 w-full flex items-center gap-3",children:[t.jsx("input",{value:ze,onChange:l=>Ce(l.target.value),onKeyDown:be,className:"flex-1 rounded-xl border border-gray-200 px-6 py-2.5 text-lg text-gray-700 bg-white shadow-inner",placeholder:"Добавить показатель","aria-label":"Добавить показатель"}),t.jsx("button",{onClick:ie,disabled:!ze.trim(),className:`w-12 h-12 rounded-xl text-white flex items-center justify-center ${ze.trim()?"bg-[#2AA6B1]":"bg-gray-300 cursor-not-allowed"} shadow-md`,"aria-label":"Добавить",children:"+"})]}),t.jsxs("div",{className:"mt-6",children:[t.jsx("h3",{className:"text-2xl font-black text-[#4A4A4A] text-center mb-5",children:"Физические манипуляции"}),t.jsx("div",{className:"grid grid-cols-2 gap-3 mb-4",children:kt.map(l=>t.jsxs("div",{className:"relative",children:[t.jsx("button",{onClick:()=>me(l.value),className:`w-full py-3 px-4 rounded-xl shadow-sm border border-[#25ACB7] text-sm font-medium text-center ${ye.includes(l.value)?"bg-[#CFF6F8] border-[#0A6D83]":"bg-white border-gray-200"}`,children:l.label}),!Ct.current.has(l.value)&&t.jsx("button",{onClick:d=>{d.stopPropagation(),Me(l.value)},"aria-label":`Удалить ${l.label}`,className:"absolute top-1 right-1 text-xs text-red-500 bg-white rounded-full w-6 h-6 flex items-center justify-center shadow-sm",title:"Удалить",children:"×"})]},l.value))}),t.jsxs("div",{className:"mt-2 w-full flex items-center gap-3",children:[t.jsx("input",{value:m,onChange:l=>A(l.target.value),onKeyDown:le,className:"flex-1 rounded-xl border border-gray-200 px-6 py-2.5 text-lg text-gray-700 bg-white shadow-inner",placeholder:"Добавить показатель","aria-label":"Добавить показатель"}),t.jsx("button",{onClick:V,disabled:!m.trim(),className:`w-12 h-12 rounded-xl text-white flex items-center justify-center ${m.trim()?"bg-[#2AA6B1]":"bg-gray-300 cursor-not-allowed"} shadow-md`,"aria-label":"Добавить",children:"+"})]})]}),t.jsx("div",{className:"mt-6",children:t.jsx("div",{className:"flex justify-center",children:t.jsx("button",{onClick:()=>{if(!ye||ye.length===0){alert("Выберите манипуляцию");return}Lr([...ye]),Q(!1),Qt(!0)},className:"px-20 py-4 rounded-2xl bg-[#55ACBF] text-white",children:"Выбрать"})})})]})})]}),z&&t.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:[t.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:()=>fe(!1)}),t.jsx("div",{className:"relative w-full max-w-md",children:t.jsxs("div",{className:"bg-white rounded-3xl shadow-lg p-6 max-h-[80vh] overflow-auto transform transition-transform duration-200 ease-out",children:[t.jsxs("div",{className:"flex items-center justify-center mb-4 text-center relative",children:[t.jsx("h3",{className:"text-2xl font-black text-[#25ADB8]",children:"Редактировать манипуляции"}),t.jsx("button",{onClick:()=>fe(!1),"aria-label":"Закрыть",className:"text-2xl absolute right-0 text-gray-400 hover:text-gray-600",children:"×"})]}),t.jsx("p",{className:"text-sm text-gray-600 mb-6 text-center",children:"Выберите манипуляцию для редактирования"}),t.jsx("div",{className:"space-y-4",children:bl?t.jsx("p",{className:"text-sm text-gray-500 text-center py-8",children:"Загрузка..."}):ps.length===0?t.jsx("p",{className:"text-sm text-gray-500 text-center py-8",children:"Нет настроенных манипуляций"}):t.jsx("div",{className:"space-y-2",children:ps.map(l=>{const d=l.metric_type||"",N=Xt[d];return t.jsx("button",{onClick:()=>{Lr([d]),fe(!1),Qt(!0)},className:"w-full py-3 px-4 rounded-xl bg-white border-2 border-[#25ACB7] text-left hover:bg-[#CFF6F8] transition-colors",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx("p",{className:"text-sm font-semibold text-gray-800",children:l.title}),t.jsx("p",{className:"text-xs text-gray-500 mt-1",children:N?`${N.days?.length||0} дней, ${N.times?.length||0} времён`:"Не настроено"})]}),t.jsx("svg",{className:"w-5 h-5 text-[#25ACB7]",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})})]})},l.id)})})}),t.jsxs("div",{className:"mt-6 flex justify-center gap-3",children:[t.jsx("button",{onClick:()=>fe(!1),className:"px-8 py-3 rounded-2xl bg-gray-200 text-[#4A4A4A] font-semibold",children:"Отмена"}),t.jsx("button",{onClick:()=>{fe(!1),Q(!0)},className:"px-8 py-3 rounded-2xl bg-[#4A4A4A] text-white font-semibold",children:"Добавить манипуляции"})]})]})})]}),j==="client"&&(y||I&&sr.canManageClientAccess)&&t.jsxs("div",{className:"space-y-5",children:[!Ye?.accepted_by&&t.jsxs("div",{className:"bg-white rounded-3xl shadow-sm p-6 space-y-3",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-dark text-center",children:"Поделитесь дневником с клиентом"}),t.jsx("p",{className:"text-sm text-gray-600 text-center",children:"Отправьте ссылку клиенту, чтобы он получил доступ к карточке подопечного и дневнику. Ссылка сохранится в его личном кабинете."})]}),(ks.length>0||Ye)&&t.jsxs("div",{className:"bg-white rounded-3xl shadow-sm p-5 space-y-3",children:[t.jsx("h3",{className:"text-sm font-semibold text-gray-700 mb-3",children:"Приглашенные клиенты"}),ks.length===0&&Ye&&t.jsx("p",{className:"text-xs text-gray-500 mb-3",children:"Есть активная ссылка, но список приглашений пуст. Создайте новую ссылку для приглашения клиента."}),ks.length>0&&t.jsx("div",{className:"space-y-2",children:ks.map(l=>{const d=!!(l.accepted_at||l.used_at)&&!!(l.accepted_by||l.used_by||l.client_id),N=l.registered_client_name||l.invited_client_name||"Клиент",K=l.registered_client_phone||l.invited_client_phone||null,q=l.accepted_at||l.used_at;return console.log("[DiaryPage] Статус клиента:",{token:l.token,isRegistered:d,accepted_at:l.accepted_at,used_at:l.used_at,accepted_by:l.accepted_by,used_by:l.used_by,client_id:l.client_id,registrationDate:q,clientName:N}),t.jsx("div",{className:"flex items-center justify-between py-3 px-3 border border-gray-100 rounded-2xl bg-gray-50",children:t.jsxs("div",{className:"flex-1",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[t.jsx("p",{className:"text-sm font-semibold text-gray-800",children:N}),d&&t.jsx("span",{className:"inline-flex items-center rounded-full bg-green-100 text-green-700 text-xs font-semibold px-2 py-0.5",children:"✓ Зарегистрирован"}),!d&&l.used_at&&t.jsx("span",{className:"inline-flex items-center rounded-full bg-yellow-100 text-yellow-700 text-xs font-semibold px-2 py-0.5",children:"⚠ Использован"}),!d&&!l.used_at&&t.jsx("span",{className:"inline-flex items-center rounded-full bg-gray-100 text-gray-600 text-xs font-semibold px-2 py-0.5",children:"Ожидает"})]}),K&&t.jsx("p",{className:"text-xs text-gray-500 mb-1",children:K}),d&&q&&t.jsxs("p",{className:"text-xs text-gray-400",children:["Подключен ",new Date(q).toLocaleDateString("ru-RU",{day:"2-digit",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})]}),!d&&l.created_at&&t.jsxs("p",{className:"text-xs text-gray-400",children:["Приглашение отправлено ",new Date(l.created_at).toLocaleDateString("ru-RU",{day:"2-digit",month:"long",year:"numeric"})]})]})},l.invite_id)})})]}),Ye?t.jsxs("div",{className:"bg-white rounded-3xl shadow-sm p-5 space-y-3",children:[t.jsxs("div",{className:"text-xs text-gray-400",children:["Ссылка создана"," ",new Date(Ye.created_at).toLocaleDateString("ru-RU",{day:"2-digit",month:"long",year:"numeric"})]}),Ye.accepted_by?t.jsxs("div",{className:"text-xs text-green-600",children:["Клиент подключил дневник"," ",Ye.accepted_at?new Date(Ye.accepted_at).toLocaleString("ru-RU",{day:"2-digit",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"}):""]}):t.jsx("div",{className:"text-xs text-[#7BA0A6]",children:"После перехода по ссылке дневник привяжется к аккаунту клиента, и он сможет управлять доступом."}),!Ye.accepted_by&&t.jsx("div",{className:"bg-gray-100 rounded-2xl px-3 py-2 text-sm text-gray-700 break-all",children:Ye.link}),Ye.accepted_by&&rr?t.jsxs("div",{className:"border border-gray-100 rounded-2xl px-4 py-3 space-y-3 bg-[#F8FEFF]",children:[t.jsxs("div",{className:"flex items-start justify-between gap-3",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-semibold text-gray-800",children:`${rr.first_name||""} ${rr.last_name||""}`.trim()||"Клиент"}),rr.phone&&t.jsx("p",{className:"text-xs text-gray-500",children:rr.phone})]}),t.jsx("span",{className:"inline-flex items-center rounded-full bg-[#E3F6F8] text-[#0A6D83] text-xs font-semibold px-3 py-1",children:"Клиент подключен"})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx("p",{className:"text-xs text-gray-500",children:"Скопируйте ссылку, чтобы клиент мог быстро войти в свой аккаунт."}),t.jsx("div",{className:"bg-white rounded-2xl px-3 py-2 text-sm text-gray-700 break-all border border-[#CDEBF0]",children:`${i}/login?client_id=${rr.user_id}`}),t.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row",children:[t.jsx(oe,{onClick:()=>Ea(`${i}/login?client_id=${rr.user_id}`),fullWidth:!0,children:"Скопировать ссылку входа"}),t.jsx(oe,{variant:"outline",onClick:()=>za(`${i}/login?client_id=${rr.user_id}`,"Здравствуйте! Вот ссылка для входа в ваш дневник:"),fullWidth:!0,children:"Отправить в WhatsApp"})]})]})]}):null,!Ye.accepted_by&&t.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row",children:[t.jsx(oe,{onClick:()=>Ea(Ye.link),fullWidth:!0,children:"Скопировать ссылку"}),t.jsx(oe,{variant:"outline",onClick:()=>za(Ye.link,"Здравствуйте! Мы подготовили доступ к дневнику вашего близкого. Перейдите по ссылке:"),fullWidth:!0,children:"Отправить в WhatsApp"})]}),t.jsx("p",{className:"text-xs text-gray-400",children:"При необходимости вы можете сгенерировать новую ссылку — старая станет недействительной."}),t.jsx(oe,{variant:"secondary",onClick:gi,className:"w-full",children:"Создать новую ссылку"})]}):t.jsxs("div",{className:"bg-white rounded-3xl shadow-sm p-6 text-center space-y-4",children:[t.jsx("p",{className:"text-sm text-gray-600",children:"Пока ссылка не создана. Нажмите кнопку ниже, чтобы сформировать персональную ссылку для клиента."}),t.jsx(oe,{onClick:gi,children:"Создать ссылку"})]})]}),j==="share"&&D&&t.jsxs("div",{className:"space-y-5",children:[t.jsxs("div",{className:"bg-white rounded-3xl shadow-sm p-6 space-y-3",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-dark text-center",children:"Поделитесь доступом к дневнику"}),t.jsx("p",{className:"text-sm text-gray-600 text-center leading-relaxed",children:"Отправьте ссылку сиделке или доверенному человеку, чтобы они могли заполнять и просматривать дневник. После перехода по ссылке дневник появится у них в списке, пока вы не отмените доступ."})]}),t.jsxs("div",{className:"bg-white rounded-3xl shadow-sm p-5 space-y-4",children:[t.jsx(oe,{onClick:ec,fullWidth:!0,children:"Создать ссылку для сиделки"}),vs.length===0?t.jsx("p",{className:"text-sm text-gray-500 text-center",children:"Активных ссылок пока нет — создайте первую, чтобы поделиться доступом с сиделкой."}):t.jsx("div",{className:"space-y-4",children:vs.sort((l,d)=>new Date(d.created_at).getTime()-new Date(l.created_at).getTime()).map(l=>t.jsxs("div",{className:"border border-gray-100 rounded-2xl px-4 py-3 space-y-3",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("span",{className:"text-xs text-gray-400",children:["Создано"," ",new Date(l.created_at).toLocaleDateString("ru-RU",{day:"2-digit",month:"long",year:"numeric"})]}),t.jsx("button",{onClick:()=>tc(l.id),className:"text-sm text-red-500 hover:text-red-600",children:"Отменить доступ"})]}),t.jsx("div",{className:"bg-gray-100 rounded-2xl px-3 py-2 text-sm text-gray-700 break-all",children:l.link}),t.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row",children:[t.jsx(oe,{onClick:()=>Ea(l.link||""),fullWidth:!0,children:"Скопировать"}),t.jsx(oe,{variant:"outline",onClick:()=>za(l.link||"","Я делюсь доступом к дневнику подопечного. Перейдите по ссылке:"),fullWidth:!0,children:"Отправить в WhatsApp"})]})]},l.id))})]})]})]}),Vr&&t.jsxs("div",{className:"fixed inset-0 z-50 flex items-end justify-center bg-black/40 backdrop-blur-[2px]",children:[t.jsx("div",{className:"absolute inset-0",onClick:Pa}),t.jsxs("div",{className:"relative w-full max-w-md bg-white rounded-t-[32px] px-5 pt-6 pb-8 max-h-[90vh] overflow-y-auto",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("h2",{className:"text-lg font-bold text-gray-dark",children:"Настройки дневника"}),t.jsx("button",{onClick:Pa,className:"w-9 h-9 rounded-full flex items-center justify-center bg-gray-100 text-gray-600","aria-label":"Закрыть окно настроек",type:"button",children:"✕"})]}),gr.length>1&&t.jsx("div",{className:"flex gap-2 mt-5",children:gr.map(l=>t.jsx("button",{onClick:()=>{Rn(l.id),ct(null),Zr(null)},type:"button",className:`flex-1 rounded-2xl py-2 text-sm font-semibold transition-colors ${js===l.id?"bg-gradient-to-r from-[#7DD3DC] to-[#5CBCC7] text-white shadow-md":"bg-gray-100 text-gray-600"}`,children:l.label},l.id))}),On&&t.jsx("div",{className:"mt-4 rounded-2xl bg-[#E6F7F9] text-[#0A6D83] text-sm px-4 py-3",children:On}),Ln&&t.jsx("div",{className:"mt-4 rounded-2xl bg-red-50 text-red-600 text-sm px-4 py-3",children:Ln}),js==="card"&&t.jsxs("div",{className:"mt-5 space-y-4",children:[!At&&t.jsx("p",{className:"text-sm text-gray-500",children:"Только владелец дневника может редактировать карточку подопечного."}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"text-xs uppercase tracking-wide text-gray-500",children:"ФИО"}),t.jsx(he,{value:st.fullName,onChange:l=>mr(d=>({...d,fullName:l.target.value})),disabled:!At||hr,className:"mt-1"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-xs uppercase tracking-wide text-gray-500",children:"Дата рождения"}),t.jsx(he,{type:"date",value:st.dateOfBirth,onChange:l=>mr(d=>({...d,dateOfBirth:l.target.value})),disabled:!At||hr,className:"mt-1"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-xs uppercase tracking-wide text-gray-500",children:"Адрес"}),t.jsx(he,{value:st.address,onChange:l=>mr(d=>({...d,address:l.target.value})),disabled:!At||hr,className:"mt-1"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-xs uppercase tracking-wide text-gray-500",children:"Диагнозы"}),t.jsx("textarea",{value:st.diagnoses,onChange:l=>mr(d=>({...d,diagnoses:l.target.value})),disabled:!At||hr,placeholder:"Перечислите через запятую",className:"mt-1 w-full rounded-2xl border border-gray-200 px-4 py-3 text-sm focus:border-[#7DD3DC] focus:outline-none min-h-[72px]"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-xs uppercase tracking-wide text-gray-500",children:"Мобильность"}),t.jsx("select",{value:st.mobility,onChange:l=>mr(d=>({...d,mobility:l.target.value==="walks"||l.target.value==="sits"||l.target.value==="lies"?l.target.value:d.mobility})),disabled:!At||hr,className:"mt-1 w-full rounded-2xl border border-gray-200 px-4 py-3 text-sm focus:border-[#7DD3DC] focus:outline-none bg-white",children:Mg.map(l=>t.jsx("option",{value:l.value,children:l.label},l.value))})]})]}),At&&t.jsx("button",{type:"button",onClick:ac,disabled:hr,className:"w-full rounded-2xl bg-gradient-to-r from-[#7DD3DC] to-[#5CBCC7] text-white font-semibold py-3 shadow-md disabled:opacity-60 disabled:cursor-not-allowed transition-opacity",children:hr?"Сохранение...":"Сохранить изменения"})]}),js==="metrics"&&t.jsxs("div",{className:"mt-5 space-y-5",children:[!it&&t.jsx("p",{className:"text-sm text-gray-500",children:"Только владелец или организация могут изменять список показателей."}),t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-semibold text-gray-dark",children:"Показатели ухода"}),t.jsx("div",{className:"space-y-2 mt-2",children:_e.map(l=>{const d=Ot.includes(l.value);return t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("label",{className:"flex items-center gap-3 text-sm text-gray-700",children:[t.jsx("input",{type:"checkbox",className:"w-4 h-4 accent-[#55ACBF]",checked:d,onChange:()=>Yr(l.value),disabled:!it}),l.label]}),it&&!xe.current.has(l.value)&&t.jsx("button",{onClick:()=>$e(l.value),className:"text-red-500 text-sm px-2 py-1","aria-label":`Удалить ${l.label}`,title:"Удалить",children:"🗑"})]},l.value)})})]}),t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-semibold text-gray-dark",children:"Физические показатели"}),t.jsx("div",{className:"space-y-2 mt-2",children:Zs.map(l=>{const d=Ot.includes(l.value);return t.jsxs("label",{className:"flex items-center gap-3 text-sm text-gray-700",children:[t.jsx("input",{type:"checkbox",className:"w-4 h-4 accent-[#55ACBF]",checked:d,onChange:()=>Yr(l.value),disabled:!it}),l.label]},l.value)})})]}),t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-semibold text-gray-dark",children:"Выделение мочи и кала"}),t.jsx("div",{className:"space-y-2 mt-2",children:wo.map(l=>{const d=Ot.includes(l.value);return t.jsxs("label",{className:"flex items-center gap-3 text-sm text-gray-700",children:[t.jsx("input",{type:"checkbox",className:"w-4 h-4 accent-[#55ACBF]",checked:d,onChange:()=>Yr(l.value),disabled:!it}),l.label]},l.value)})})]}),t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-semibold text-gray-dark",children:"Тягостные симптомы"}),t.jsx("div",{className:"space-y-2 mt-2",children:No.map(l=>{const d=Ot.includes(l.value);return t.jsxs("label",{className:"flex items-center gap-3 text-sm text-gray-700",children:[t.jsx("input",{type:"checkbox",className:"w-4 h-4 accent-[#55ACBF]",checked:d,onChange:()=>Yr(l.value),disabled:!it}),l.label]},l.value)})})]}),ci.length>0&&t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-semibold text-gray-dark",children:"Пользовательские показатели"}),t.jsx("div",{className:"space-y-2 mt-2",children:ci.map(l=>{const d=Ot.includes(l);return t.jsxs("label",{className:"flex items-center gap-3 text-sm text-gray-700",children:[t.jsx("input",{type:"checkbox",className:"w-4 h-4 accent-[#55ACBF]",checked:d,onChange:()=>Yr(l),disabled:!it}),nt(l)]},l)})})]})]}),t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-semibold text-gray-dark",children:"Закрепленные показатели (до 3)"}),t.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:Ot.length===0?t.jsx("p",{className:"text-xs text-gray-500",children:"Сначала выберите показатели выше."}):Ot.map(l=>{const d=Bn.includes(l);return t.jsx("button",{type:"button",onClick:()=>sc(l),disabled:!it,className:`px-3 py-1.5 rounded-full text-xs font-semibold transition-colors ${d?"bg-gradient-to-r from-[#7DD3DC] to-[#5CBCC7] text-white shadow-md":"bg-gray-100 text-gray-600"} ${it?"":"cursor-not-allowed opacity-60"}`,children:nt(l)},l)})})]}),it&&t.jsx("button",{type:"button",onClick:nc,disabled:Vn,className:"w-full rounded-2xl bg-gradient-to-r from-[#7DD3DC] to-[#5CBCC7] text-white font-semibold py-3 shadow-md disabled:opacity-60 disabled:cursor-not-allowed transition-opacity",children:Vn?"Сохранение...":"Сохранить показатели"})]}),js==="access"&&t.jsxs("div",{className:"mt-5 space-y-4",children:[!$t&&t.jsx("p",{className:"text-sm text-gray-500",children:"Управлять доступом может только владелец дневника."}),t.jsxs("div",{className:"rounded-2xl bg-[#F5FBFC] px-4 py-4 space-y-2",children:[t.jsx("p",{className:"text-sm font-semibold text-gray-dark",children:"Сиделка"}),t.jsx("p",{className:"text-sm text-gray-600",children:f.caregiver_id?`Доступ предоставлен (ID: ${f.caregiver_id})`:"Сиделка не привязана"}),f.caregiver_id&&$t&&t.jsx("button",{type:"button",onClick:()=>zs("caregiver"),className:"text-sm font-semibold text-red-600 hover:text-red-700",children:"Отозвать доступ сиделки"})]}),t.jsxs("div",{className:"rounded-2xl bg-[#F5FBFC] px-4 py-4 space-y-2",children:[t.jsx("p",{className:"text-sm font-semibold text-gray-dark",children:"Организация"}),t.jsx("p",{className:"text-sm text-gray-600",children:f.organization_id?`Доступ предоставлен (ID: ${f.organization_id})`:"Организация не привязана"}),f.organization_id&&$t&&t.jsx("button",{type:"button",onClick:()=>zs("organization"),className:"text-sm font-semibold text-red-600 hover:text-red-700",children:"Отозвать доступ организации"})]}),t.jsx("p",{className:"text-xs text-gray-500",children:"Чтобы выдать доступ, поделитесь ссылкой во вкладке «Поделиться» или отправьте приглашение из раздела «Клиент»."})]}),t.jsx("button",{type:"button",onClick:Pa,className:"mt-6 w-full rounded-2xl bg-gray-200 text-gray-700 font-semibold py-3 hover:bg-gray-300 transition-colors",children:"Закрыть"})]})]}),ot&&Pt&&t.jsx(vl,{isOpen:ot,metric:Pt,onClose:()=>Qt(!1),onSave:_l}),Bl&&We&&t.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[t.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:ql}),t.jsxs("div",{className:"relative bg-white rounded-2xl w-80 max-w-full p-6 text-center shadow-lg",children:[t.jsx("h3",{className:"text-2xl font-bold text-[#25ADB8] mb-2",children:We.label}),t.jsx("p",{className:"text-sm text-gray-700 mb-4",children:"Выберите действие"}),t.jsxs("div",{className:"space-y-3",children:[t.jsx("button",{onClick:Jl,className:"w-full py-2 rounded-md bg-[#2AA6B1] text-white font-semibold",children:"Задача выполнена"}),t.jsx("button",{onClick:Yl,className:"w-full py-2 rounded-md bg-[#FB923C] text-white font-semibold",children:"Перенести задачу"}),t.jsx("button",{onClick:Hl,className:"w-full py-2 rounded-md bg-[#EF4444] text-white font-semibold",children:"Задача не выполнена"})]})]})]}),Ul&&We&&t.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[t.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:()=>Ms(!1)}),t.jsxs("div",{className:"relative bg-white rounded-2xl w-80 max-w-full p-6 text-center shadow-lg",children:[t.jsx("h3",{className:"text-2xl font-bold text-[#25ADB8] mb-2",children:We.label}),t.jsxs("p",{className:"text-sm text-gray-700 mb-4",children:["Отметьте, состоялась ли ",We.label.toLowerCase()," у подопечного"]}),t.jsxs("div",{className:"flex gap-3 justify-center",children:[t.jsx("button",{onClick:Ql,className:"px-4 py-2 rounded-full bg-[#2AA6B1] text-white font-semibold",children:"Было"}),t.jsx("button",{onClick:Kl,className:"px-4 py-2 rounded-full bg-white border border-[#D1E8EA] text-gray-700 font-semibold",children:"Не было"})]})]})]}),Vl&&We&&t.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[t.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:fi}),t.jsxs("div",{className:"relative bg-white rounded-2xl w-80 max-w-full p-6 text-center shadow-lg",children:[t.jsx("h3",{className:"text-2xl font-bold text-[#25ADB8] mb-2",children:We.label}),t.jsx("p",{className:"text-sm text-gray-700 mb-4",children:"Напишите причину переноса манипуляции"}),t.jsx("textarea",{value:ui,onChange:l=>Sa(l.target.value),placeholder:"Напишите причину",className:"w-full mb-4 p-3 border rounded-md text-sm resize-none h-24"}),t.jsxs("div",{className:"flex gap-3 justify-center",children:[t.jsx("button",{onClick:Xl,className:"px-4 py-2 rounded-full bg-[#2AA6B1] text-white font-semibold",children:"Сохранить"}),t.jsx("button",{onClick:fi,className:"px-4 py-2 rounded-full bg-white border border-[#D1E8EA] text-gray-700 font-semibold",children:"Отмена"})]})]})]}),Zl&&We&&t.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[t.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:hi}),t.jsxs("div",{className:"relative bg-white rounded-2xl w-80 max-w-full p-6 text-center shadow-lg",children:[t.jsx("h3",{className:"text-2xl font-bold text-[#25ADB8] mb-2",children:We.label}),t.jsx("p",{className:"text-sm text-gray-700 mb-4",children:"Напишите причину отмены задачи"}),t.jsx("textarea",{value:mi,onChange:l=>Da(l.target.value),placeholder:"Напишите причину",className:"w-full mb-4 p-3 border rounded-md text-sm resize-none h-24"}),t.jsxs("div",{className:"flex gap-3 justify-center",children:[t.jsx("button",{onClick:Gl,className:"px-4 py-2 rounded-full bg-[#2AA6B1] text-white font-semibold",children:"Сохранить"}),t.jsx("button",{onClick:hi,className:"px-4 py-2 rounded-full bg-white border border-[#D1E8EA] text-gray-700 font-semibold",children:"Отмена"})]})]})]}),E&&t.jsx(Rg,{isOpen:J,metricType:E.type,metricLabel:E.label,onClose:()=>{W(!1),T(null)},onSave:l=>{Fs(E.type,l)}})]}):t.jsx("div",{className:"min-h-screen bg-gray-100 flex items-center justify-center px-4",children:t.jsxs("div",{className:"bg-white rounded-3xl shadow-sm px-6 py-8 text-center max-w-xs",children:[t.jsx("h2",{className:"text-lg font-bold text-gray-dark mb-2",children:"Нет доступа"}),t.jsx("p",{className:"text-sm text-gray-500",children:"У вас нет прав для просмотра этого дневника. Обратитесь к владельцу для получения доступа."})]})})},Lg=[{value:"walk",label:"Прогулка"},{value:"cognitive_games",label:"Когнитивные игры"},{value:"diaper_change",label:"Смена подгузников"},{value:"hygiene",label:"Гигиена"},{value:"skin_moisturizing",label:"Увлажнение кожи"},{value:"meal",label:"Прием пищи"},{value:"medications",label:"Прием лекарств"},{value:"vitamins",label:"Прием витаминов"},{value:"sleep",label:"Сон"}],Bg=[{value:"temperature",label:"Температура"},{value:"blood_pressure",label:"Артериальное давление"},{value:"breathing_rate",label:"Частота дыхания"},{value:"pain_level",label:"Уровень боли"},{value:"saturation",label:"Сатурация"},{value:"blood_sugar",label:"Уровень сахара в крови"}],Ug=[{value:"urination",label:"Выпито/выделено и цвет мочи"},{value:"defecation",label:"Дефекация"}],Vg=[{value:"nausea",label:"Тошнота"},{value:"vomiting",label:"Рвота"},{value:"shortness_of_breath",label:"Одышка"},{value:"itching",label:"Зуд"},{value:"cough",label:"Кашель"},{value:"dry_mouth",label:"Сухость во рту"},{value:"hiccups",label:"Икота"},{value:"taste_disturbance",label:"Нарушение вкуса"}],Zg=[{value:"care",label:"Уход"},{value:"physical",label:"Физические"},{value:"excretion",label:"Выделения"},{value:"symptom",label:"Симптомы"}],Wg=()=>{const{id:e}=Io(),r=rt(),{user:s}=Ae(),[a,n]=u.useState([]),[i,o]=u.useState([]),[c,g]=u.useState([]),[_,y]=u.useState(!1),[D,w]=u.useState(!1),[I,P]=u.useState(""),[S,U]=u.useState("care");u.useEffect(()=>{if(!s||!e){r("/login");return}(async()=>{if(!s){r("/login");return}try{if(!await pl(s)){alert("У вас нет прав на редактирование показателей дневника"),r(`/diaries/${e}`);return}}catch(j){console.error("Ошибка проверки прав доступа:",j),alert("Ошибка проверки прав доступа"),r(`/diaries/${e}`);return}})(),(async()=>{if(e)try{const{data:j,error:v}=await F.from("diary_metrics").select("id, metric_key, is_pinned, metadata").eq("diary_id",e);if(v){console.error("Ошибка загрузки метрик:",v),n([]),o([]),g([]);return}if(!j||j.length===0){n([]),o([]),g([]);return}const E=[],T=[],J=[];j.forEach(W=>{const h=W.metric_key;if(h.startsWith("custom_")||W.metadata&&typeof W.metadata=="object"&&"is_custom"in W.metadata){const Y=W.metadata?.label||h.replace("custom_",""),ee=W.metadata?.category||"care";J.push({id:h,diary_id:e,label:Y,category:ee}),W.is_pinned?E.push(h):T.push(h)}else W.is_pinned?E.push(h):T.push(h)}),n(E),o(T),g(J)}catch(j){console.error("Ошибка загрузки метрик:",j),n([]),o([]),g([])}})()},[e,s,r]);const O=B=>{n(Z=>Z.includes(B)?Z.filter(j=>j!==B):Z.length<3?[...Z,B]:Z)},$=B=>{o(Z=>Z.includes(B)?Z.filter(j=>j!==B):[...Z,B])},p=()=>{if(!e)return;const B=I.trim();if(!B)return;const Z=`custom_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,j={id:Z,diary_id:e,label:B,category:S};g(v=>[...v,j]),o(v=>[...new Set([...v,Z])]),P("")},k=async()=>{if(e){if(I.trim()&&(p(),await new Promise(B=>setTimeout(B,150))),a.length===0&&i.length===0){alert("Необходимо выбрать хотя бы один показатель");return}try{const{data:B,error:Z}=await F.from("diary_metrics").select("*").eq("diary_id",e);if(Z){console.error("Ошибка загрузки метрик:",Z),alert("Не удалось загрузить показатели. Попробуйте позже.");return}const j=new Map((B||[]).map(J=>[J.metric_key,J])),v=Array.from(new Set([...a,...i])),E=[];a.forEach(J=>{const W=j.get(J),h=c.find(C=>C.id===J);E.push({id:W?.id,diary_id:e,metric_key:J,is_pinned:!0,metadata:h?{label:h.label,category:h.category,is_custom:!0,...W?.metadata&&typeof W.metadata=="object"?{settings:W.metadata.settings}:{}}:W?.metadata||{}})}),i.forEach(J=>{const W=j.get(J),h=c.find(C=>C.id===J);E.push({id:W?.id,diary_id:e,metric_key:J,is_pinned:!1,metadata:h?{label:h.label,category:h.category,is_custom:!0,...W?.metadata&&typeof W.metadata=="object"?{settings:W.metadata.settings}:{}}:W?.metadata||{}})});const T=Array.from(j.keys()).filter(J=>!v.includes(J));if(T.length>0){const{error:J}=await F.from("diary_metrics").delete().eq("diary_id",e).in("metric_key",T);J&&console.error("Ошибка удаления метрик:",J)}if(E.length>0){const J=E.map(async W=>{if(W.id){const{error:h}=await F.from("diary_metrics").update({is_pinned:W.is_pinned,metadata:W.metadata||{}}).eq("id",W.id);if(h)throw console.error("Ошибка обновления метрики:",h),h}else{const{error:h}=await F.from("diary_metrics").insert({diary_id:W.diary_id,metric_key:W.metric_key,is_pinned:W.is_pinned,metadata:W.metadata||{}});if(h)throw console.error("Ошибка создания метрики:",h),h}});try{await Promise.all(J)}catch(W){console.error("Ошибка сохранения метрик:",W),W?.code==="42501"||W?.message?.includes("permission")||W?.message?.includes("policy")?alert("У вас нет прав на редактирование показателей этого дневника. Обратитесь к владельцу для получения доступа."):alert("Ошибка при сохранении показателей. Попробуйте позже.");return}}alert("Показатели успешно обновлены"),setTimeout(()=>{r(`/diaries/${e}`)},500)}catch(B){console.error("Ошибка сохранения метрик:",B),alert("Ошибка при сохранении показателей. Попробуйте позже.")}}},f=(B,Z)=>{let j="px-4 py-2 rounded-full text-sm font-semibold transition-all duration-200 ";return Z?j+="bg-gray-200 text-gray-400 border border-gray-200 cursor-not-allowed":B?j+="bg-gradient-to-r from-[#7DD3DC] to-[#5CBCC7] text-white shadow border border-transparent":j+="bg-white text-[#4A4A4A] border-2 border-gray-300 hover:border-[#7DD3DC]",j},x=(B,Z,j,v)=>t.jsx("div",{className:"flex flex-wrap gap-2",children:B.map(E=>{const T=Z.includes(E.value),J=v?.isDisabled?v.isDisabled(E.value,T):!1;return t.jsx("button",{type:"button",onClick:()=>{J||j(E.value)},className:f(T,J),disabled:J,children:E.label},E.value)})}),R=[...Lg,...c.filter(B=>B.category==="care").map(B=>({value:B.id,label:B.label}))],G=[...Bg,...c.filter(B=>B.category==="physical").map(B=>({value:B.id,label:B.label}))],M=[...Ug,...c.filter(B=>B.category==="excretion").map(B=>({value:B.id,label:B.label}))],L=[...Vg,...c.filter(B=>B.category==="symptom").map(B=>({value:B.id,label:B.label}))];return t.jsxs("div",{className:"min-h-screen bg-gray-100 pb-24",children:[t.jsx("header",{className:"bg-white shadow-sm sticky top-0 z-10",children:t.jsx("div",{className:"flex items-center justify-between px-4 py-3",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("button",{onClick:()=>r(`/diaries/${e}`),className:"-ml-2 flex items-center justify-center w-6 h-6","aria-label":"Назад",children:t.jsx("img",{src:"/icons/Иконка стрелка.png",alt:"Назад",className:"w-full h-full object-contain"})}),t.jsx("h1",{className:"text-lg font-bold text-gray-dark",children:"Изменить показатели"})]})})}),t.jsxs("div",{className:"px-4 py-6 max-w-md mx-auto",children:[t.jsx("div",{className:"mb-6",children:t.jsxs("div",{className:"bg-gradient-to-r from-[#7DD3DC] to-[#5CBCC7] rounded-3xl p-6 shadow-md",children:[t.jsx("h2",{className:"text-xl font-bold text-[#4A4A4A] mb-3 text-center",children:"Закрепленные показатели"}),t.jsx("p",{className:"text-sm text-[#4A4A4A] mb-4 text-center",children:"Выберите до 3-х показателей для быстрого доступа"}),t.jsxs(oe,{variant:"outline",className:"w-full !bg-[#4A4A4A] !text-white !border-none",onClick:()=>y(!0),children:["Изменить (",a.length,"/3)"]})]})}),t.jsx("div",{className:"mb-6",children:t.jsxs("div",{className:"bg-white rounded-3xl p-6 shadow-md border-2 border-gray-300",children:[t.jsx("h2",{className:"text-xl font-bold text-gray-dark mb-3 text-center",children:"Все показатели"}),t.jsx("p",{className:"text-sm text-gray-600 mb-4 text-center",children:"Выберите остальные показатели для отслеживания"}),t.jsxs(oe,{variant:"outline",className:"w-full",onClick:()=>w(!0),children:["Изменить (",i.length,")"]})]})}),t.jsx(oe,{onClick:k,disabled:a.length===0&&i.length===0,className:"w-full",children:"Сохранить изменения"})]}),t.jsx(Hs,{isOpen:_,onClose:()=>y(!1),title:"Закрепленные показатели",children:t.jsxs("div",{className:"space-y-6",children:[t.jsxs("p",{className:"text-sm text-[#4A4A4A] text-center",children:["Выберите до 3-х показателей для быстрого доступа (",a.length,"/3)"]}),t.jsxs("div",{className:"space-y-5",children:[t.jsxs("div",{children:[t.jsx("h3",{className:"text-sm font-semibold text-[#4A4A4A] mb-2",children:"Показатели ухода"}),x(R,a,O,{isDisabled:(B,Z)=>!Z&&a.length>=3})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-sm font-semibold text-[#4A4A4A] mb-2",children:"Физические показатели"}),x(G,a,O,{isDisabled:(B,Z)=>!Z&&a.length>=3})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-sm font-semibold text-[#4A4A4A] mb-2",children:"Выделение мочи и кала"}),x(M,a,O,{isDisabled:(B,Z)=>!Z&&a.length>=3})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-sm font-semibold text-[#4A4A4A] mb-2",children:"Тягостные симптомы"}),x(L,a,O,{isDisabled:(B,Z)=>!Z&&a.length>=3})]})]}),t.jsx(oe,{onClick:()=>{I.trim()&&p(),y(!1)},className:"w-full",children:"Сохранить"})]})}),t.jsx(Hs,{isOpen:D,onClose:()=>w(!1),title:"Все показатели",children:t.jsxs("div",{className:"space-y-6",children:[t.jsxs("p",{className:"text-sm text-[#4A4A4A] text-center",children:["Выберите показатели для отслеживания (",i.length,")"]}),t.jsxs("div",{className:"space-y-5",children:[t.jsxs("div",{children:[t.jsx("h3",{className:"text-sm font-semibold text-[#4A4A4A] mb-2",children:"Показатели ухода"}),x(R,i,$,{isDisabled:B=>a.includes(B)})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-sm font-semibold text-[#4A4A4A] mb-2",children:"Физические показатели"}),x(G,i,$,{isDisabled:B=>a.includes(B)})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-sm font-semibold text-[#4A4A4A] mb-2",children:"Выделение мочи и кала"}),x(M,i,$,{isDisabled:B=>a.includes(B)})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-sm font-semibold text-[#4A4A4A] mb-2",children:"Тягостные симптомы"}),x(L,i,$,{isDisabled:B=>a.includes(B)})]})]}),t.jsxs("div",{className:"border-t border-gray-200 pt-5 space-y-3",children:[t.jsx("h3",{className:"text-sm font-semibold text-[#4A4A4A]",children:"Добавить свой показатель"}),t.jsx("div",{className:"flex flex-wrap gap-2",children:Zg.map(B=>{const Z=S===B.value;return t.jsx("button",{type:"button",onClick:()=>U(B.value),className:`px-4 py-2 rounded-full text-sm font-semibold transition-all duration-200 ${Z?"bg-gradient-to-r from-[#7DD3DC] to-[#5CBCC7] text-white shadow":"bg-white border-2 border-gray-300 text-[#4A4A4A] hover:border-[#7DD3DC]"}`,children:B.label},B.value)})}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(he,{value:I,onChange:B=>P(B.target.value),placeholder:"Название показателя",className:"flex-1"}),t.jsx(oe,{onClick:p,disabled:!I.trim(),className:"!px-8 !py-3 !text-xl !font-bold !min-w-[80px]",children:"+"})]})]}),t.jsx(oe,{onClick:()=>{I.trim()&&p(),w(!1)},className:"w-full",children:"Сохранить"})]})})]})},qg=bt({firstName:ke().min(1,"Введите имя"),lastName:ke().min(1,"Введите фамилию"),phone:ke().min(10,"Введите телефон"),password:ke().min(6,"Пароль должен быть не менее 6 символов"),confirmPassword:ke().min(1,"Подтвердите пароль")}).refine(e=>e.password===e.confirmPassword,{message:"Пароли не совпадают",path:["confirmPassword"]}),ko=e=>{let r=e.trim().replace(/\s+/g,"");return r?(r=r.replace(/[^\d+]/g,""),r.startsWith("+")?r:r.startsWith("8")?`+7${r.slice(1)}`:r.startsWith("7")?`+${r}`:r.startsWith("7")?r:`+7${r}`):""},Jg=()=>{const e=rt(),[r]=Fr(),s=r.get("token")||"",a=(r.get("type")||"").toLowerCase(),[n,i]=u.useState(null),[o,c]=u.useState("loading"),[g,_]=u.useState(null),[y,D]=u.useState(null),[w,I]=u.useState(null),[P,S]=u.useState(!1),{register:U,handleSubmit:O,formState:{errors:$}}=xt({resolver:yt(qg)});u.useEffect(()=>{if(a==="admin"&&(S(!0),i("caregiver")),!s){c("invalid"),_("Ссылка недействительна. Проверьте корректность приглашения.");return}(async()=>{try{console.log("ClientInviteRegisterPage: Validating token via RPC:",s);const{data:x,error:R}=await F.rpc("validate_invite_token",{p_token:s});if(console.log("ClientInviteRegisterPage: RPC result:",{validationResult:x,rpcError:R}),R){console.error("ClientInviteRegisterPage: RPC validation error:",R),c("invalid"),_("Пригласительная ссылка недействительна или была удалена.");return}if(!x){console.error("ClientInviteRegisterPage: RPC returned null/undefined"),c("invalid"),_("Пригласительная ссылка недействительна или была удалена.");return}if(!x.valid){console.log("ClientInviteRegisterPage: Token validation failed:",x.error),c("invalid"),_(x.error||"Пригласительная ссылка недействительна или была удалена.");return}const G=x.invite_type;if(G==="organization_client"){const v=!!(x.organization_client_invite_tokens&&Array.isArray(x.organization_client_invite_tokens)?x.organization_client_invite_tokens[0]:x.organization_client_invite_tokens)?.diary_id;i(v?"organization":"caregiver")}else G==="caregiver_client"?i("caregiver"):G==="admin_static"&&(S(!0),i("caregiver"));const M=x.organization_client_invite_tokens,L=x.caregiver_client_invite_tokens,B={id:x.id,token:x.token,invite_type:x.invite_type,expires_at:x.expires_at,used_at:x.used_at,revoked_at:x.revoked_at,organization_client_invite_tokens:Array.isArray(M)&&M.length>0?M[0]:M||null,caregiver_client_invite_tokens:Array.isArray(L)&&L.length>0?L[0]:L||null};D(B);const Z=B.organization_client_invite_tokens;if(G==="organization_client"&&Z?.diary_id){const{data:j,error:v}=await F.from("diaries").select(`
              id,
              patient_card_id,
              organization_id,
              caregiver_id,
              owner_client_id
            `).eq("id",Z.diary_id).single();!v&&j&&I(j)}c("form")}catch(x){console.error("Ошибка проверки пригласительной ссылки",x),c("invalid"),_("Не удалось проверить приглашение. Попробуйте позже.")}})()},[s,a]);const p=async f=>{if(!s||!y)return;c("processing"),_(null);const x=ko(f.phone);if(!x){_("Введите корректный номер телефона"),c("form");return}try{const R=new AbortController,G=setTimeout(()=>R.abort(),P?12e4:45e3),M="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyAgCiAgICAicm9sZSI6ICJhbm9uIiwKICAgICJpc3MiOiAic3VwYWJhc2UtZGVtbyIsCiAgICAiaWF0IjogMTY0MTc2OTIwMCwKICAgICJleHAiOiAxNzk5NTM1NjAwCn0.dc_X5iR_VP_qT0zsiyj_I_OZ2T9FtRU2BBNWN8Bu4GE",L=fs("accept-invite");console.log("ClientInviteRegisterPage: Calling Edge Function:",L);const B=await fetch(L,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${M}`,apikey:M},signal:R.signal,mode:"cors",credentials:"omit",body:JSON.stringify({token:s,password:f.password,phone:x,firstName:f.firstName,lastName:f.lastName})});if(clearTimeout(G),!B.ok){const C=await B.text();console.error("Edge Function error:",B.status,C);let Y="Не удалось завершить регистрацию. Попробуйте ещё раз.";try{const ee=JSON.parse(C);Y=ee.message||ee.error||Y}catch{Y=C||Y}throw new Error(Y)}const Z=await B.json();if(!Z?.data?.loginEmail)throw new Error("Не удалось получить данные для входа. Попробуйте войти вручную.");const{error:j}=await F.auth.signInWithPassword({email:Z.data.loginEmail,password:f.password});if(j)throw console.error("Ошибка входа после регистрации:",j),new Error("Не удалось войти после регистрации. Попробуйте войти вручную.");const{data:{user:v},error:E}=await F.auth.getUser(),{data:{session:T}}=await F.auth.getSession();if(E||!v)throw console.error("Ошибка получения пользователя:",E),new Error("Не удалось получить данные пользователя. Попробуйте войти вручную.");const{setUser:J,setSession:W,setLoading:h}=Ae.getState();T&&v&&(J(v),W(T),h(!1),Ae.setState({isAuthenticated:!0,loading:!1})),console.log("✅ Регистрация клиента организации завершена успешно"),await new Promise(C=>setTimeout(C,200));try{e("/dashboard")}catch{window.location.href="/dashboard"}}catch(R){console.error("Ошибка регистрации клиента организации",R),R?.name==="AbortError"?_("Сервер не ответил вовремя. Попробуйте ещё раз."):_(R.message||"Не удалось завершить регистрацию. Попробуйте ещё раз."),c("form")}},k=async f=>{if(!s||!y)return;c("processing"),_(null);const x=ko(f.phone);if(!x){_("Введите корректный номер телефона"),c("form");return}try{const R=new AbortController,G=setTimeout(()=>R.abort(),3e4),M="https://supabase.healapp.ru",L="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyAgCiAgICAicm9sZSI6ICJhbm9uIiwKICAgICJpc3MiOiAic3VwYWJhc2UtZGVtbyIsCiAgICAiaWF0IjogMTY0MTc2OTIwMCwKICAgICJleHAiOiAxNzk5NTM1NjAwCn0.dc_X5iR_VP_qT0zsiyj_I_OZ2T9FtRU2BBNWN8Bu4GE",Z=`${M.replace(/\/$/,"")}/functions/v1/accept-invite`;console.log(`ClientInviteRegisterPage: Calling Edge Function for ${P?"admin":"caregiver"}:`,Z);const j=await fetch(Z,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${L}`,apikey:L},signal:R.signal,mode:"cors",credentials:"omit",body:JSON.stringify({token:s,password:f.password,phone:x,firstName:f.firstName,lastName:f.lastName})});if(clearTimeout(G),!j.ok){const ee=await j.text();console.error("Edge Function error:",j.status,ee);let ae="Не удалось завершить регистрацию. Попробуйте ещё раз.";try{const ne=JSON.parse(ee);ae=ne.message||ne.error||ae}catch{ae=ee||ae}throw new Error(ae)}const v=await j.json();if(!v?.data?.loginEmail)throw new Error("Не удалось получить данные для входа. Попробуйте войти вручную.");const{error:E}=await F.auth.signInWithPassword({email:v.data.loginEmail,password:f.password});if(E)throw console.error("Ошибка входа после регистрации:",E),new Error("Не удалось войти после регистрации. Попробуйте войти вручную.");const{data:{user:T},error:J}=await F.auth.getUser(),{data:{session:W}}=await F.auth.getSession();if(J||!T)throw console.error("Ошибка получения пользователя:",J),new Error("Не удалось получить данные пользователя. Попробуйте войти вручную.");const{setUser:h,setSession:C,setLoading:Y}=Ae.getState();W&&T&&(h(T),C(W),Y(!1),Ae.setState({isAuthenticated:!0,loading:!1})),console.log("✅ Регистрация клиента сиделки завершена успешно"),await new Promise(ee=>setTimeout(ee,200));try{e("/dashboard")}catch{window.location.href="/dashboard"}}catch(R){console.error("Ошибка регистрации клиента сиделки",R),R?.name==="AbortError"?_("Сервер не ответил вовремя. Попробуйте ещё раз."):_(R.message||"Не удалось завершить регистрацию. Попробуйте ещё раз."),c("form")}};return o==="loading"?t.jsxs("div",{className:"space-y-4 text-center",children:[t.jsx("div",{className:"animate-spin w-12 h-12 border-4 border-[#7DD3DC] border-t-transparent rounded-full mx-auto"}),t.jsx("p",{className:"text-gray-600 text-sm",children:"Проверяем приглашение..."})]}):o==="invalid"&&g?t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"bg-white rounded-3xl shadow-sm p-6 space-y-3 text-center",children:[t.jsx("h1",{className:"text-xl font-semibold text-gray-dark",children:"Ссылка недоступна"}),t.jsx("p",{className:"text-sm text-gray-600 leading-relaxed",children:g})]}),t.jsx(oe,{onClick:()=>e("/login"),fullWidth:!0,children:"Перейти ко входу"})]}):!n||!y?t.jsxs("div",{className:"space-y-4 text-center",children:[t.jsx("div",{className:"animate-spin w-12 h-12 border-4 border-[#7DD3DC] border-t-transparent rounded-full mx-auto"}),t.jsx("p",{className:"text-gray-600 text-sm",children:"Загрузка..."})]}):n==="caregiver"?t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"bg-white rounded-3xl shadow-sm p-6 space-y-3 text-center",children:[t.jsx("h1",{className:"text-2xl font-semibold text-gray-dark",children:"Регистрация клиента"}),t.jsx("p",{className:"text-sm text-gray-600 leading-relaxed",children:"После регистрации вы сможете создать карточку подопечного и вести дневник вместе с приглашавшим специалистом."}),y?.caregiver_client_invite_tokens?.invited_client_name&&t.jsxs("p",{className:"text-sm text-[#4A4A4A]/70",children:["Пригласил: ",y.caregiver_client_invite_tokens.invited_client_name]})]}),t.jsxs("form",{onSubmit:O(k),className:"bg-white rounded-3xl shadow-sm p-6 space-y-5",children:[t.jsx(he,{label:"Имя",placeholder:"Введите имя",error:$.firstName?.message,fullWidth:!0,...U("firstName")}),t.jsx(he,{label:"Фамилия",placeholder:"Введите фамилию",error:$.lastName?.message,fullWidth:!0,...U("lastName")}),t.jsx(he,{label:"Телефон",placeholder:"+7 (___) ___-__-__",error:$.phone?.message,fullWidth:!0,...U("phone")}),t.jsx(he,{label:"Пароль",type:"password",placeholder:"Введите пароль",error:$.password?.message,helperText:"Минимум 6 символов",fullWidth:!0,...U("password")}),t.jsx(he,{label:"Подтвердите пароль",type:"password",placeholder:"Повторите пароль",error:$.confirmPassword?.message,fullWidth:!0,...U("confirmPassword")}),g&&t.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-xl text-sm text-red-600",children:g}),t.jsx(oe,{type:"submit",fullWidth:!0,isLoading:o==="processing",children:"Завершить регистрацию"})]}),t.jsxs("div",{className:"bg-white rounded-3xl shadow-sm p-5 space-y-3 text-sm text-gray-600",children:[t.jsx("p",{className:"text-center text-gray-500",children:"Если регистрация уже выполнена, войдите с помощью телефона и пароля на странице входа."}),t.jsx(oe,{variant:"outline",onClick:()=>e("/login"),fullWidth:!0,children:"Перейти ко входу"})]})]}):!y||!w?null:t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"bg-white rounded-3xl shadow-sm p-6 space-y-3 text-center",children:[t.jsx("h1",{className:"text-2xl font-semibold text-gray-dark",children:"Регистрация клиента"}),t.jsx("p",{className:"text-sm text-gray-600 leading-relaxed",children:"После регистрации вы получите доступ к дневнику и сможете управлять правами доступа."})]}),t.jsxs("form",{onSubmit:O(p),className:"bg-white rounded-3xl shadow-sm p-6 space-y-5",children:[t.jsx(he,{label:"Имя",placeholder:"Введите имя",error:$.firstName?.message,fullWidth:!0,...U("firstName")}),t.jsx(he,{label:"Фамилия",placeholder:"Введите фамилию",error:$.lastName?.message,fullWidth:!0,...U("lastName")}),t.jsx(he,{label:"Телефон",placeholder:"+7 (___) ___-__-__",error:$.phone?.message,fullWidth:!0,...U("phone")}),t.jsx(he,{label:"Пароль",type:"password",placeholder:"Введите пароль",error:$.password?.message,helperText:"Минимум 6 символов",fullWidth:!0,...U("password")}),t.jsx(he,{label:"Подтвердите пароль",type:"password",placeholder:"Повторите пароль",error:$.confirmPassword?.message,fullWidth:!0,...U("confirmPassword")}),g&&t.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-xl text-sm text-red-600",children:g}),t.jsx(oe,{type:"submit",fullWidth:!0,isLoading:o==="processing",children:"Завершить регистрацию"})]}),t.jsxs("div",{className:"bg-white rounded-3xl shadow-sm p-5 space-y-3 text-sm text-gray-600",children:[t.jsx("p",{className:"text-center text-gray-500",children:"Если регистрация уже выполнена, войдите с помощью телефона и пароля на странице входа."}),t.jsx(oe,{variant:"outline",onClick:()=>e("/login"),fullWidth:!0,children:"Перейти ко входу"})]})]})},qs="admin_panel_access_granted",Js="admin_panel_token",Va="b8f56f5c-62f1-45d9-9e5a-e8bbfdadcf0f",Qg=()=>u.useMemo(()=>{const e=[];return e.length===0?e.push(Va):e.includes(Va)||e.push(Va),Array.from(new Set(e))},[]),Kg=()=>{const e=Qg(),[r,s]=Fr(),a=rt(),n=cc(),[i,o]=u.useState("checking"),[c,g]=u.useState(null),[_,y]=u.useState(!1),D=n.pathname==="/admin",w=r.get("token");u.useEffect(()=>{const P=localStorage.getItem(qs),S=localStorage.getItem(Js);if(P==="true"&&S&&e.includes(S)){o("authorized"),g(null);return}if(w){if(e.includes(w)){localStorage.setItem(qs,"true"),localStorage.setItem(Js,w);const U=new URLSearchParams(r);U.delete("token"),s(U,{replace:!0}),o("authorized"),g(null)}else localStorage.removeItem(qs),localStorage.removeItem(Js),o("denied"),g("Недействительный токен доступа. Убедитесь, что используете актуальную ссылку админ-панели.");return}o("denied"),g("Для доступа к админ-панели добавьте параметр token=ВАШ_ТОКЕН в адресную строку.")},[e,s,w,r,n.pathname]);const I=()=>{localStorage.removeItem(qs),localStorage.removeItem(Js),o("denied"),g("Доступ закрыт. Чтобы вернуться, используйте токен из ссылки админ-панели."),a("/",{replace:!0})};return u.useEffect(()=>{y(!1)},[n.pathname]),i==="checking"?t.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-100 px-4",children:t.jsxs("div",{className:"text-center space-y-4",children:[t.jsx("div",{className:"animate-spin w-12 h-12 border-4 border-[#55ACBF] border-t-transparent rounded-full mx-auto"}),t.jsx("p",{className:"text-sm text-gray-600",children:"Проверяем права доступа…"})]})}):i==="denied"?t.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-100 px-4",children:t.jsxs("div",{className:"max-w-md w-full bg-white rounded-3xl shadow-lg p-8 space-y-6 text-center",children:[t.jsxs("div",{children:[t.jsx("h1",{className:"text-2xl font-bold text-gray-800 mb-2",children:"Доступ ограничен"}),c&&t.jsx("p",{className:"text-sm text-gray-600",children:c})]}),t.jsxs("div",{className:"space-y-3",children:[t.jsx(oe,{onClick:()=>a("/",{replace:!0}),fullWidth:!0,children:"Вернуться на главную"}),t.jsxs("p",{className:"text-xs text-gray-500",children:["Администратор получает доступ только по постоянной ссылке с токеном. Добавьте параметр",t.jsx("span",{className:"font-semibold",children:" token"})," в URL и перезагрузите страницу."]})]})]})}):t.jsxs("div",{className:"min-h-screen bg-gray-50",children:[t.jsxs("header",{className:"bg-white border-b border-gray-200",children:[t.jsxs("div",{className:"max-w-6xl mx-auto px-4 sm:px-6 py-4 flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[!D&&t.jsx("button",{onClick:()=>a("/admin"),className:"flex items-center justify-center w-9 h-9 rounded-full border border-gray-200 bg-white text-gray-600 hover:text-[#0A6D83] hover:border-[#55ACBF] transition-colors","aria-label":"Вернуться на главную панель",children:"←"}),t.jsxs("div",{children:[t.jsx("p",{className:"text-xs uppercase tracking-wide text-gray-400",children:"Административная панель"}),t.jsx("h1",{className:"text-xl font-bold text-gray-800",children:"Управление платформой"})]})]}),t.jsxs("div",{className:"flex items-center gap-4",children:[t.jsxs("button",{type:"button",className:"sm:hidden inline-flex items-center justify-center w-10 h-10 rounded-full border border-gray-200 bg-white text-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#55ACBF]",onClick:()=>y(P=>!P),"aria-label":"Открыть меню разделов",children:[t.jsx("span",{className:"sr-only",children:"Меню"}),t.jsx("svg",{className:"w-5 h-5",viewBox:"0 0 24 24",fill:"none",children:t.jsx("path",{d:"M4 7h16M4 12h16M4 17h16",stroke:"currentColor",strokeWidth:1.5,strokeLinecap:"round"})})]}),t.jsxs("nav",{className:"hidden sm:flex items-center gap-3 text-sm",children:[t.jsx(Ut,{to:"/admin",end:!0,className:({isActive:P})=>`px-3 py-2 rounded-lg transition-colors ${P?"bg-[#55ACBF]/10 text-[#0A6D83] font-medium":"text-gray-500 hover:text-gray-700"}`,children:"Главная"}),t.jsx(Ut,{to:"/admin/invites",className:({isActive:P})=>`px-3 py-2 rounded-lg transition-colors ${P?"bg-[#55ACBF]/10 text-[#0A6D83] font-medium":"text-gray-500 hover:text-gray-700"}`,children:"Пригласительные"}),t.jsx(Ut,{to:"/admin/users",className:({isActive:P})=>`px-3 py-2 rounded-lg transition-colors ${P?"bg-[#55ACBF]/10 text-[#0A6D83] font-medium":"text-gray-500 hover:text-gray-700"}`,children:"Пользователи"}),t.jsx(Ut,{to:"/admin/support",className:({isActive:P})=>`px-3 py-2 rounded-lg transition-colors ${P?"bg-[#55ACBF]/10 text-[#0A6D83] font-medium":"text-gray-500 hover:text-gray-700"}`,children:"Поддержка"}),t.jsx(Ut,{to:"/admin/monitoring",className:({isActive:P})=>`px-3 py-2 rounded-lg transition-colors ${P?"bg-[#55ACBF]/10 text-[#0A6D83] font-medium":"text-gray-500 hover:text-gray-700"}`,children:"Мониторинг"})]}),t.jsx(oe,{variant:"outline",size:"sm",onClick:I,children:"Выйти"})]})]}),_&&t.jsx("div",{className:"sm:hidden border-t border-gray-200 bg-white",children:t.jsxs("nav",{className:"px-4 py-3 space-y-2 text-sm",children:[t.jsx(Ut,{to:"/admin",end:!0,className:({isActive:P})=>`block px-3 py-2 rounded-lg transition-colors ${P?"bg-[#55ACBF]/10 text-[#0A6D83] font-medium":"text-gray-500 hover:text-gray-700"}`,children:"Главная"}),t.jsx(Ut,{to:"/admin/invites",className:({isActive:P})=>`block px-3 py-2 rounded-lg transition-colors ${P?"bg-[#55ACBF]/10 text-[#0A6D83] font-medium":"text-gray-500 hover:text-gray-700"}`,children:"Пригласительные"}),t.jsx(Ut,{to:"/admin/users",className:({isActive:P})=>`block px-3 py-2 rounded-lg transition-colors ${P?"bg-[#55ACBF]/10 text-[#0A6D83] font-medium":"text-gray-500 hover:text-gray-700"}`,children:"Пользователи"}),t.jsx(Ut,{to:"/admin/support",className:({isActive:P})=>`block px-3 py-2 rounded-lg transition-colors ${P?"bg-[#55ACBF]/10 text-[#0A6D83] font-medium":"text-gray-500 hover:text-gray-700"}`,children:"Поддержка"}),t.jsx(Ut,{to:"/admin/monitoring",className:({isActive:P})=>`block px-3 py-2 rounded-lg transition-colors ${P?"bg-[#55ACBF]/10 text-[#0A6D83] font-medium":"text-gray-500 hover:text-gray-700"}`,children:"Мониторинг"})]})})]}),t.jsx("main",{className:"max-w-6xl mx-auto px-4 sm:px-6 py-8",children:t.jsx(mn,{})})]})},Hg=[{to:"/admin/invites",title:"Пригласительные ссылки",description:"Создание и контроль одноразовых ссылок для организаций, сотрудников и клиентов."},{to:"/admin/users",title:"Пользователи и роли",description:"Просмотр организаций, сотрудников и клиентов, анализ их активности."},{to:"/admin/support",title:"Помощь пользователям",description:"Инструменты службы поддержки: просмотр дневников, правка данных и журнал действий."},{to:"/admin/monitoring",title:"Мониторинг и статистика",description:"Показатели активности системы, проблемные события и аудит действий."}],Gg=()=>t.jsxs("div",{className:"space-y-8",children:[t.jsx("div",{className:"space-y-3",children:t.jsx("h2",{className:"text-2xl font-bold text-gray-800",children:"Обзор панели управления"})}),t.jsx("div",{className:"grid gap-4 md:grid-cols-2 xl:grid-cols-3",children:Hg.map(e=>t.jsx(dc,{to:e.to,className:"group relative h-full bg-white border border-gray-200 rounded-3xl p-6 shadow-sm hover:shadow-lg transition-shadow",children:t.jsxs("div",{className:"flex flex-col h-full space-y-4",children:[t.jsx("div",{className:"flex items-center justify-between",children:t.jsx("h3",{className:"text-lg font-semibold text-gray-800 group-hover:text-[#0A6D83] transition-colors",children:e.title})}),t.jsx("p",{className:"text-sm text-gray-600 flex-1 leading-relaxed",children:e.description}),t.jsx("span",{className:"text-sm font-medium text-[#0A6D83] group-hover:translate-x-1 transition-transform",children:"Перейти →"})]})},e.to))})]}),Yg=()=>typeof window<"u"?window.location.origin:"",Za=(e,r)=>{const s=Yg();switch(e){case"organization":return`${s}/register?token=${r}`;case"privateCaregiver":return`${s}/register?token=${r}`;case"employee":return`${s}/register?org_token=${r}`;case"client":default:return`${s}/client-invite?token=${r}`}},Wa=[{value:"organization",label:"Организация"},{value:"employee",label:"Сотрудник организации"},{value:"client",label:"Клиент"},{value:"privateCaregiver",label:"Частная сиделка"}],Xg=e=>{switch(e){case"organization":return"Организация";case"employee":return"Сотрудник";case"privateCaregiver":return"Частная сиделка";case"client":default:return"Клиент"}},ep=e=>{if(e==="organization")return"organization";if(e==="privateCaregiver")return"private_caregiver";if(e==="client")return"admin_static";throw new Error(`Неподдерживаемый тип для админской панели: ${e}`)},tp=()=>{const[e,r]=u.useState("organization"),[s,a]=u.useState(!1),[n,i]=u.useState(null),[o,c]=u.useState("all"),[g,_]=u.useState([]),[y,D]=u.useState(!0),[w,I]=u.useState(null);u.useEffect(()=>{const p=async()=>{D(!0),I(null);const f=Ar||F;if(!Ar){I("Для загрузки приглашений требуется VITE_SUPABASE_SERVICE_ROLE_KEY в .env.local"),D(!1);return}try{const{data:x,error:R}=await f.from("invite_tokens").select(`
            id,
            token,
            invite_type,
            created_at,
            used_at,
            used_by,
            revoked_at,
            expires_at,
            organization_registration_invite_tokens (
              organization_type,
              invited_email,
              invited_name
            ),
            private_caregiver_registration_invite_tokens (
              invited_email,
              invited_name
            ),
            organization_invite_tokens (
              organization_id,
              employee_role
            ),
            organization_client_invite_tokens (
              organization_id
            ),
            caregiver_client_invite_tokens (
              caregiver_id
            )
          `).order("created_at",{ascending:!1});if(R){console.error("Ошибка загрузки приглашений:",R),I("Не удалось загрузить приглашения");return}if(!x){_([]);return}const G=x.map(M=>{const L=!!M.revoked_at,B=!!M.used_at,Z=M.expires_at?new Date(M.expires_at)<new Date:!1,j=L?"revoked":B?"used":Z?"expired":"active",v=Za(M.invite_type==="organization"?"organization":M.invite_type==="private_caregiver"?"privateCaregiver":M.invite_type==="organization_employee"?"employee":"client",M.token);if(M.invite_type==="organization"){const T=Array.isArray(M.organization_registration_invite_tokens)?M.organization_registration_invite_tokens[0]:M.organization_registration_invite_tokens;return{id:M.id,token:M.token,created_at:M.created_at,link:v,used_at:M.used_at,used_by:M.used_by,status:j,source:"supabase",invite_type:"organization",organization_type:T?.organization_type||null,invited_email:T?.invited_email||null,invited_name:T?.invited_name||null}}if(M.invite_type==="private_caregiver"){const T=Array.isArray(M.private_caregiver_registration_invite_tokens)?M.private_caregiver_registration_invite_tokens[0]:M.private_caregiver_registration_invite_tokens;return{id:M.id,token:M.token,created_at:M.created_at,link:v,used_at:M.used_at,used_by:M.used_by,status:j,source:"supabase",invite_type:"private_caregiver",invited_email:T?.invited_email||null,invited_name:T?.invited_name||null}}if(M.invite_type==="organization_employee"){const T=Array.isArray(M.organization_invite_tokens)?M.organization_invite_tokens[0]:M.organization_invite_tokens;return{id:M.id,token:M.token,created_at:M.created_at,link:v,used_at:M.used_at,used_by:M.used_by,status:j,source:"supabase",invite_type:"organization_employee",organization_id:T?.organization_id||null,employee_role:T?.employee_role||null}}const E=M.organization_client_invite_tokens||M.caregiver_client_invite_tokens||{};return{id:M.id,token:M.token,created_at:M.created_at,link:v,used_at:M.used_at,used_by:M.used_by,status:j,source:"supabase",invite_type:M.invite_type,organization_id:E.organization_id||null,caregiver_id:E.caregiver_id||null}});_(G)}catch(x){console.error("Ошибка при загрузке приглашений:",x),I("Произошла ошибка при загрузке данных")}finally{D(!1)}};p();const k=setInterval(()=>{p()},3e4);return()=>clearInterval(k)},[]);const P=u.useMemo(()=>g.filter(p=>o==="all"?!0:(p.invite_type==="organization"?"organization":p.invite_type==="private_caregiver"?"privateCaregiver":p.invite_type==="organization_employee"?"employee":"client")===o),[g,o]),S=u.useMemo(()=>{const p={total:g.length,active:0,used:0,byType:{organization:0,employee:0,client:0,privateCaregiver:0}};return g.forEach(k=>{const f=k.invite_type==="organization"?"organization":k.invite_type==="private_caregiver"?"privateCaregiver":k.invite_type==="organization_employee"?"employee":"client";p.byType[f]=(p.byType[f]||0)+1,k.status==="active"?p.active+=1:k.status==="used"&&(p.used+=1)}),p},[g]),U=async()=>{a(!0),i(null),I(null);try{const p=ep(e),k={expires_in_hours:168};e==="organization"?k.organization_type="pension":e==="client"&&(k.organization_id=null,k.patient_card_id=null,k.diary_id=null);const f=localStorage.getItem("admin_panel_token");if(!f){I("Не найден админский токен. Обновите страницу с токеном в URL.");return}if(!"".split(",").map(E=>E.trim()).filter(Boolean).includes(f)&&f!=="b8f56f5c-62f1-45d9-9e5a-e8bbfdadcf0f"){I("Недействительный админский токен");return}const M=Ar||F;if(!Ar){I("Для создания приглашений требуется VITE_SUPABASE_SERVICE_ROLE_KEY в .env.local");return}const{data:L,error:B}=await M.rpc("generate_admin_invite_link",{invite_type:p,payload:k});if(B){console.error("Ошибка создания приглашения:",B),I(B.message||"Не удалось создать приглашение");return}if(!L){I("Не удалось создать приглашение");return}const Z={success:!0,invite:L},j=Za(e,Z.invite.token);i(j);const{data:v}=await M.from("invite_tokens").select("*").eq("id",Z.invite.id).single();if(v){const E=!!Z.invite.used_at,T=Z.invite.expires_at?new Date(Z.invite.expires_at)<new Date:!1,J=E?"used":T?"expired":"active",W={id:Z.invite.id,token:Z.invite.token,created_at:Z.invite.created_at,link:j,used_at:Z.invite.used_at,used_by:Z.invite.used_by,status:J,source:"supabase",invite_type:p,...e==="organization"?{organization_type:"pension"}:e==="privateCaregiver"?{invited_email:null,invited_name:null}:{}};_(h=>[W,...h])}}catch(p){console.error("Ошибка при создании приглашения:",p),I("Произошла ошибка при создании приглашения")}finally{a(!1)}},O=p=>{navigator.clipboard.writeText(p).catch(k=>{console.warn("Не удалось скопировать текст",k)})},$=async p=>{try{I(null);const k=localStorage.getItem("admin_panel_token");if(!k){I("Не найден админский токен. Обновите страницу с токеном в URL.");return}if(!"".split(",").map(M=>M.trim()).filter(Boolean).includes(k)&&k!=="b8f56f5c-62f1-45d9-9e5a-e8bbfdadcf0f"){I("Недостаточно прав для отзыва приглашения");return}if(!Ar){I("Для отзыва приглашений требуется VITE_SUPABASE_SERVICE_ROLE_KEY в .env.local");return}const{error:G}=await Ar.from("invite_tokens").delete().eq("id",p);if(G){console.error("Ошибка отзыва приглашения:",G),I(G.message||"Не удалось отозвать приглашение");return}_(M=>M.filter(L=>L.id!==p))}catch(k){console.error("Ошибка при отзыве приглашения:",k),I("Произошла ошибка при отзыве приглашения")}};return t.jsxs("div",{className:"space-y-6",children:[t.jsx("div",{className:"space-y-2",children:t.jsx("h2",{className:"text-2xl font-bold text-gray-800",children:"Управление пригласительными ссылками"})}),w&&t.jsx("div",{className:"bg-red-50 border border-red-200 rounded-xl p-4",children:t.jsx("p",{className:"text-red-800 text-sm",children:w})}),t.jsxs("div",{className:"bg-white border border-gray-200 rounded-3xl p-6 space-y-6 shadow-sm",children:[t.jsxs("section",{className:"grid gap-4 sm:grid-cols-2 lg:grid-cols-4",children:[t.jsxs("div",{className:"rounded-3xl border border-gray-200 p-5 shadow-sm",children:[t.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Всего ссылок"}),t.jsx("p",{className:"text-2xl font-semibold text-gray-800",children:S.total})]}),t.jsxs("div",{className:"rounded-3xl border border-gray-200 p-5 shadow-sm",children:[t.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Активные"}),t.jsx("p",{className:"text-2xl font-semibold text-green-700",children:S.active})]}),t.jsxs("div",{className:"rounded-3xl border border-gray-200 p-5 shadow-sm",children:[t.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Использованные"}),t.jsx("p",{className:"text-2xl font-semibold text-gray-800",children:S.used})]}),t.jsxs("div",{className:"rounded-3xl border border-gray-200 p-5 shadow-sm space-y-2",children:[t.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"По типам"}),t.jsx("div",{className:"space-y-1 text-sm text-gray-600",children:Object.keys(S.byType).map(p=>t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{children:Xg(p)}),t.jsx("span",{className:"font-medium text-gray-800",children:S.byType[p]})]},p))})]})]}),t.jsxs("section",{className:"space-y-4",children:[t.jsx("div",{children:t.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Создать приглашение"})}),t.jsx("div",{className:"flex flex-wrap gap-3",children:Wa.filter(p=>p.value==="organization"||p.value==="privateCaregiver"||p.value==="client").map(p=>t.jsx("button",{onClick:()=>r(p.value),className:`px-4 py-2 rounded-full text-sm font-medium border transition-colors ${e===p.value?"bg-[#55ACBF]/10 text-[#0A6D83] border-[#55ACBF]":"text-gray-600 border-gray-200 hover:border-[#55ACBF]/50 hover:text-[#0A6D83]"}`,children:p.label},p.value))}),t.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-3 w-full",children:[t.jsx(oe,{onClick:U,isLoading:s,className:"sm:w-auto w-full",children:"Сгенерировать ссылку"}),n&&t.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-3 bg-[#F7FCFD] border border-[#55ACBF]/30 rounded-2xl px-4 py-3 text-sm w-full",children:[t.jsx("span",{className:"font-mono text-gray-700 break-all sm:max-w-md",children:n}),t.jsx(oe,{variant:"outline",size:"sm",onClick:()=>O(n),children:"Скопировать"})]})]})]}),t.jsxs("section",{className:"space-y-4",children:[t.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-3 justify-between",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("div",{children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Список приглашений"}),y&&t.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Загрузка..."})]}),t.jsx(oe,{variant:"outline",size:"sm",onClick:async()=>{D(!0),I(null);try{const{data:p,error:k}=await F.from("invite_tokens").select(`
                        *,
                        organization_registration_invite_tokens (
                          organization_type,
                          invited_email,
                          invited_name
                        ),
                        private_caregiver_registration_invite_tokens (
                          invited_email,
                          invited_name
                        ),
                        organization_invite_tokens (
                          organization_id,
                          employee_role
                        ),
                        organization_client_invite_tokens (
                          organization_id
                        ),
                        caregiver_client_invite_tokens (
                          caregiver_id
                        )
                      `).order("created_at",{ascending:!1});if(k){console.error("Ошибка загрузки приглашений:",k),I("Не удалось загрузить приглашения");return}if(!p){_([]);return}const f=p.map(x=>{const R=!!x.revoked_at,G=!!x.used_at,M=x.expires_at?new Date(x.expires_at)<new Date:!1,L=R?"revoked":G?"used":M?"expired":"active",B=Za(x.invite_type==="organization"?"organization":x.invite_type==="private_caregiver"?"privateCaregiver":x.invite_type==="organization_employee"?"employee":"client",x.token);if(x.invite_type==="organization"){const j=Array.isArray(x.organization_registration_invite_tokens)?x.organization_registration_invite_tokens[0]:x.organization_registration_invite_tokens;return{id:x.id,token:x.token,created_at:x.created_at,link:B,used_at:x.used_at,used_by:x.used_by,status:L,source:"supabase",invite_type:"organization",organization_type:j?.organization_type||null,invited_email:j?.invited_email||null,invited_name:j?.invited_name||null}}if(x.invite_type==="private_caregiver"){const j=Array.isArray(x.private_caregiver_registration_invite_tokens)?x.private_caregiver_registration_invite_tokens[0]:x.private_caregiver_registration_invite_tokens;return{id:x.id,token:x.token,created_at:x.created_at,link:B,used_at:x.used_at,used_by:x.used_by,status:L,source:"supabase",invite_type:"private_caregiver",invited_email:j?.invited_email||null,invited_name:j?.invited_name||null}}if(x.invite_type==="organization_employee"){const j=Array.isArray(x.organization_invite_tokens)?x.organization_invite_tokens[0]:x.organization_invite_tokens;return{id:x.id,token:x.token,created_at:x.created_at,link:B,used_at:x.used_at,used_by:x.used_by,status:L,source:"supabase",invite_type:"organization_employee",organization_id:j?.organization_id||null,employee_role:j?.employee_role||null}}const Z=Array.isArray(x.organization_client_invite_tokens)?x.organization_client_invite_tokens[0]:x.organization_client_invite_tokens||(Array.isArray(x.caregiver_client_invite_tokens)?x.caregiver_client_invite_tokens[0]:x.caregiver_client_invite_tokens);return{id:x.id,token:x.token,created_at:x.created_at,link:B,used_at:x.used_at,used_by:x.used_by,status:L,source:"supabase",invite_type:x.invite_type==="organization_client"?"organization_client":"caregiver_client"}});_(f)}catch(p){console.error("Ошибка при загрузке приглашений:",p),I("Произошла ошибка при загрузке приглашений")}finally{D(!1)}},children:"Обновить"})]}),t.jsx("div",{className:"flex flex-wrap items-center gap-2 text-xs font-medium",children:["all",...Wa.map(p=>p.value)].map(p=>t.jsx("button",{onClick:()=>c(p),className:`px-3 py-1 rounded-full border transition-colors whitespace-normal text-left leading-tight max-w-[140px] ${o===p?"bg-[#55ACBF]/10 text-[#0A6D83] border-[#55ACBF]":"border-gray-200 text-gray-500 hover:text-[#0A6D83] hover:border-[#55ACBF]/40"}`,children:p==="all"?"Все":Wa.find(k=>k.value===p)?.label||p},p))})]}),y?t.jsx("div",{className:"text-center py-10 text-gray-500",children:"Загрузка приглашений..."}):P.length===0?t.jsx("div",{className:"rounded-2xl border border-dashed border-gray-300 bg-white p-6 text-sm text-gray-500 text-center",children:"Приглашения не найдены"}):t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"overflow-hidden border border-gray-200 rounded-2xl overflow-x-auto hidden lg:block",children:t.jsxs("table",{className:"min-w-full divide-y divide-gray-200 text-sm",children:[t.jsx("thead",{className:"bg-[#F7FCFD] text-gray-500 uppercase tracking-wide text-xs",children:t.jsxs("tr",{children:[t.jsx("th",{className:"px-4 py-3 text-left",children:"Тип"}),t.jsx("th",{className:"px-4 py-3 text-left",children:"Ссылка"}),t.jsx("th",{className:"px-4 py-3 text-left",children:"Статус"}),t.jsx("th",{className:"px-4 py-3 text-left",children:"Создан"}),t.jsx("th",{className:"px-4 py-3 text-left",children:"Действия"})]})}),t.jsx("tbody",{className:"divide-y divide-gray-100 bg-white",children:P.map(p=>{const k=p.invite_type==="organization"?"Организация":p.invite_type==="private_caregiver"?"Частная сиделка":p.invite_type==="organization_employee"?"Сотрудник":"Клиент",f=p.status==="active"?"Активна":p.status==="used"?"Использована":p.status==="revoked"?"Отозвана":"Истекла";return t.jsxs("tr",{children:[t.jsx("td",{className:"px-4 py-3 text-gray-800",children:k}),t.jsx("td",{className:"px-4 py-3 text-gray-700",children:t.jsx("a",{href:p.link,target:"_blank",rel:"noreferrer",className:"text-[#0A6D83] underline hover:text-[#55ACBF] break-all",children:p.link})}),t.jsx("td",{className:"px-4 py-3",children:t.jsx("span",{className:`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold ${p.status==="active"?"bg-green-100 text-green-700":p.status==="used"?"bg-gray-200 text-gray-600":p.status==="revoked"?"bg-red-100 text-red-700":"bg-yellow-100 text-yellow-700"}`,children:f})}),t.jsx("td",{className:"px-4 py-3 text-gray-500",children:new Date(p.created_at).toLocaleString("ru-RU",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})}),t.jsx("td",{className:"px-4 py-3",children:t.jsxs("div",{className:"flex flex-wrap gap-2",children:[t.jsx(oe,{variant:"outline",size:"sm",onClick:()=>O(p.link),children:"Скопировать"}),p.status==="active"&&t.jsx(oe,{variant:"outline",size:"sm",onClick:()=>$(p.id),className:"text-red-600 border-red-300 hover:bg-red-50",children:"Отозвать"})]})})]},p.id)})})]})}),t.jsx("div",{className:"lg:hidden space-y-3",children:P.map(p=>{const k=p.invite_type==="organization"?"Организация":p.invite_type==="private_caregiver"?"Частная сиделка":p.invite_type==="organization_employee"?"Сотрудник":"Клиент",f=p.status==="active"?"Активна":p.status==="used"?"Использована":p.status==="revoked"?"Отозвана":"Истекла";return t.jsxs("div",{className:"rounded-2xl border border-gray-200 bg-white p-5 shadow-sm flex flex-col gap-3",children:[t.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[t.jsx("span",{className:"inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-[#F7FCFD] text-[#0A6D83] border border-[#55ACBF]/40",children:k}),t.jsx("span",{className:`inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold ${p.status==="active"?"bg-green-100 text-green-700":p.status==="used"?"bg-gray-100 text-gray-500":p.status==="revoked"?"bg-red-100 text-red-700":"bg-yellow-100 text-yellow-700"}`,children:f})]}),t.jsxs("div",{className:"space-y-2 text-sm text-gray-700",children:[t.jsxs("p",{className:"text-xs text-gray-400",children:["Создана: ",new Date(p.created_at).toLocaleString("ru-RU")]}),t.jsx("a",{href:p.link,target:"_blank",rel:"noreferrer",className:"text-[#0A6D83] underline hover:text-[#55ACBF] break-all text-sm",children:p.link})]}),t.jsxs("div",{className:"flex flex-col gap-2 text-sm",children:[t.jsx(oe,{variant:"outline",size:"sm",onClick:()=>O(p.link),children:"Скопировать ссылку"}),p.status==="active"&&t.jsx(oe,{size:"sm",variant:"outline",onClick:()=>$(p.id),className:"text-red-600 border-red-300 hover:bg-red-50",children:"Отозвать"})]})]},p.id)})})]})]})]})]})},Gt={all:"Все",organization:"Организации",employee:"Сотрудники организаций",privateCaregiver:"Частные сиделки",client:"Клиенты"},qa={organization:1,employee:2,privateCaregiver:3,client:4,all:99},ir=e=>e==null?"":String(e),Co=(...e)=>{const r=new Set;return e.flat().forEach(s=>{Array.isArray(s)?s.forEach(a=>{a&&r.add(String(a))}):s&&r.add(String(s))}),Array.from(r)},Zt=(e,r)=>e==null||r===void 0||r===null?!1:String(e)===String(r),Ja=e=>{switch(e){case"pension":return"Пансионат";case"patronage_agency":return"Патронажное агентство";case"caregiver":return"Частная сиделка";default:return e?String(e):null}},zr=e=>{const{full_name:r,name:s,first_name:a,last_name:n}=e;if(r&&String(r).trim().length>0)return String(r).trim();if(s&&String(s).trim().length>0)return String(s).trim();const i=`${a||""} ${n||""}`.trim();return i.length>0?i:""},rp=e=>{const r=e?.user_role||e?.role,s=e?.organization_type||e?.type;return r==="org_employee"||r==="employee"?"employee":r==="client"?"client":r==="caregiver"||s==="caregiver"?"privateCaregiver":r==="organization"||s==="pension"||s==="patronage_agency"?"organization":null},sp=()=>{const[e,r]=u.useState("all"),[s,a]=u.useState(""),[n,i]=u.useState(0),[o,c]=u.useState(null),[g,_]=u.useState(!1),[y,D]=u.useState(""),[w,I]=u.useState(null),[P,S]=u.useState(!0),[U,O]=u.useState({organizations:[],userProfiles:[],clients:[],diaries:[],patientCards:[],diaryEmployeeAccess:[]});u.useEffect(()=>{(async()=>{S(!0);try{const C=localStorage.getItem("admin_panel_token");if(!C){console.error("Не найден админский токен"),S(!1);return}const Y="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyAgCiAgICAicm9sZSI6ICJhbm9uIiwKICAgICJpc3MiOiAic3VwYWJhc2UtZGVtbyIsCiAgICAiaWF0IjogMTY0MTc2OTIwMCwKICAgICJleHAiOiAxNzk5NTM1NjAwCn0.dc_X5iR_VP_qT0zsiyj_I_OZ2T9FtRU2BBNWN8Bu4GE",ee=fs("admin-users-data"),ae=await fetch(`${ee}?admin_token=${encodeURIComponent(C)}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${Y}`,apikey:Y}});if(!ae.ok){const b=await ae.json().catch(()=>({error:"Неизвестная ошибка"}));console.error("Ошибка загрузки данных:",b),S(!1);return}const ne=await ae.json();if(!ne.success||!ne.data){console.error("Неверный формат ответа от Edge Function"),S(!1);return}console.log("✅ Загружены данные из Supabase:",{organizations:ne.data.organizations?.length||0,userProfiles:ne.data.userProfiles?.length||0,clients:ne.data.clients?.length||0,diaries:ne.data.diaries?.length||0,patientCards:ne.data.patientCards?.length||0,diaryEmployeeAccess:ne.data.diaryEmployeeAccess?.length||0}),ne.data.organizations?.length>0&&console.log("📋 Организации из БД:",ne.data.organizations),ne.data.userProfiles?.length>0&&console.log("👤 Профили пользователей из БД:",ne.data.userProfiles),ne.data.clients?.length>0&&console.log("🏥 Клиенты из БД:",ne.data.clients),O({organizations:ne.data.organizations||[],userProfiles:ne.data.userProfiles||[],clients:ne.data.clients||[],diaries:ne.data.diaries||[],patientCards:ne.data.patientCards||[],diaryEmployeeAccess:ne.data.diaryEmployeeAccess||[]})}catch(C){console.error("Ошибка загрузки данных из Supabase:",C)}finally{S(!1)}})()},[n]);const $=u.useMemo(()=>U.diaries,[n,U.diaries]),p=u.useMemo(()=>U.patientCards,[n,U.patientCards]),k=u.useMemo(()=>{const h=new Map;return p.forEach(C=>{const Y=ir(C?.id);Y&&h.set(Y,C)}),h},[p]),f=u.useMemo(()=>{const h={};return U.diaryEmployeeAccess.forEach(C=>{const Y=ir(C.diary_id);Y&&(h[Y]||(h[Y]=[]),h[Y].push(C))}),h},[n,U.diaryEmployeeAccess]),x=u.useMemo(()=>{const h=new Map,C=z=>{const fe=ir(z.id);if(!fe)return;const ye={id:fe,type:z.type,name:z.name||"Без имени",contact:z.contact??null,roleLabel:z.roleLabel??null,sources:Co(z.sources||[],[`${z.type}`]),diariesCount:z.diariesCount,relations:z.relations?z.relations.map(xe=>({...xe})):[],payload:z.payload??{}},ce=qa[z.type],me=h.get(fe);if(!me){h.set(fe,{row:ye,priority:ce});return}const _e=Co(me.row.sources,ye.sources),De=[...me.row.relations||[]];if(ye.relations?.forEach(xe=>{const ze=`${xe.label}:${xe.rawValue??xe.value}`;De.some(kt=>`${kt.label}:${kt.rawValue??kt.value}`===ze)||De.push(xe)}),ce<me.priority){h.set(fe,{priority:ce,row:{...me.row,...ye,contact:ye.contact??me.row.contact,roleLabel:ye.roleLabel??me.row.roleLabel,sources:_e,relations:De,payload:{...me.row.payload,...ye.payload}}});return}if(ce===me.priority){h.set(fe,{priority:ce,row:{...me.row,contact:me.row.contact||ye.contact,roleLabel:me.row.roleLabel||ye.roleLabel,sources:_e,relations:De,payload:{...me.row.payload,...ye.payload}}});return}h.set(fe,{priority:me.priority,row:{...me.row,sources:_e,relations:De,contact:me.row.contact??ye.contact,roleLabel:me.row.roleLabel??ye.roleLabel,payload:{...ye.payload,...me.row.payload}}})};U.organizations.forEach((z,fe)=>{const ye=z.id||z.user_id||`org_${fe}`,ce=z.type;C(ce==="caregiver"?{id:ye,type:"privateCaregiver",name:z.name||zr(z)||"Частная сиделка",contact:z.phone||z.email||null,roleLabel:"Частная сиделка",relations:z.city?[{label:"Город",value:String(z.city),rawValue:String(z.city)}]:void 0,payload:z,sources:["supabase","organizations"]}:{id:ye,type:"organization",name:z.name||z.title||zr(z)||"Организация",contact:z.phone||z.email||null,roleLabel:Ja(ce),payload:z,sources:["supabase","organizations"]})}),U.userProfiles.map(z=>({id:z.user_id,user_id:z.user_id,role:z.role,organization_id:z.organization_id,...z})).forEach((z,fe)=>{const ye=rp(z);if(!ye)return;const ce=z.id||z.user_id||z.userId||z.phone||z.email||`local_user_${fe}`,me=[];z.organization_id&&me.push({label:"Организация",value:String(z.organization_id),rawValue:String(z.organization_id)}),z.caregiver_id&&me.push({label:"Сиделка",value:String(z.caregiver_id),rawValue:String(z.caregiver_id)}),C({id:ce,type:ye,name:zr(z)||z.phone||z.email||"Без имени",contact:z.phone||z.email||null,roleLabel:ye==="organization"?Ja(z.organization_type||z.type):ye==="employee"?z.role||"Сотрудник":ye==="privateCaregiver"?"Частная сиделка":void 0,relations:me.length?me:void 0,payload:z,sources:["supabase","user_profiles"]})}),U.userProfiles.filter(z=>z.role==="org_employee").map(z=>({user_id:z.user_id,id:z.user_id,organization_id:z.organization_id,employee_role:z.employee_role||"caregiver",role:z.employee_role||"caregiver",first_name:z.first_name,last_name:z.last_name,phone:z.phone,...z})).forEach((z,fe)=>{const ye=z.user_id||z.id||`employee_${fe}`;C({id:ye,type:"employee",name:zr(z)||z.phone||"Сотрудник без имени",contact:z.phone||z.email||null,roleLabel:z.role||z.employee_role||"Сотрудник",relations:z.organization_id?[{label:"Организация",value:String(z.organization_id),rawValue:String(z.organization_id)}]:void 0,payload:z,sources:["supabase","user_profiles"]})}),U.clients.map(z=>({user_id:z.user_id,id:z.user_id||z.id,first_name:z.first_name,last_name:z.last_name,phone:z.phone,caregiver_id:z.caregiver_id,organization_id:z.organization_id,...z})).forEach((z,fe)=>{const ye=z.user_id||z.id||`client_${fe}`,ce=[];z.caregiver_id&&ce.push({label:"Сиделка",value:String(z.caregiver_id),rawValue:String(z.caregiver_id)}),z.organization_id&&ce.push({label:"Организация",value:String(z.organization_id),rawValue:String(z.organization_id)}),C({id:ye,type:"client",name:zr(z)||z.phone||"Клиент",contact:z.phone||null,roleLabel:ce.length?ce.map(me=>me.label).join(" / "):void 0,relations:ce.length?ce:void 0,payload:z,sources:["supabase","clients"]})});const Q=Array.from(h.values()).map(z=>({...z.row,relations:z.row.relations?z.row.relations.filter((fe,ye,ce)=>fe.value&&ce.findIndex(me=>me.label===fe.label&&me.value===fe.value)===ye):void 0})).sort((z,fe)=>{const ye=qa[z.type]-qa[fe.type];return ye!==0?ye:z.name.localeCompare(fe.name,"ru")});return console.log("✅ Сформировано строк:",Q.length,"из них:",{organizations:Q.filter(z=>z.type==="organization").length,employees:Q.filter(z=>z.type==="employee").length,privateCaregivers:Q.filter(z=>z.type==="privateCaregiver").length,clients:Q.filter(z=>z.type==="client").length}),Q},[n,U]),R=u.useMemo(()=>{const h=new Map;return x.forEach(C=>h.set(String(C.id),C)),h},[x]),G=u.useMemo(()=>{const h=new Map;return x.filter(C=>C.type==="organization").forEach(C=>h.set(String(C.id),C.name)),h},[x]),M=u.useMemo(()=>{const h=new Map;return x.filter(C=>C.type==="organization").forEach(C=>{const Y=C.payload?.organization_type||C.payload?.type||C.payload?.role||C.payload?.org_type||null;Y&&h.set(String(C.id),String(Y))}),h},[x]),L=u.useMemo(()=>{const h=new Map;return x.filter(C=>C.type==="employee").forEach(C=>{const Y=C.payload?.organization_id||C.payload?.organizationId||C.payload?.org_id||C.payload?.organization||null,ee=C.relations?.find(ne=>ne.label==="Организация")?.value,ae=Y||ee;ae&&h.set(String(C.id),String(ae))}),h},[x]),B=u.useMemo(()=>$.map(h=>{const C=h.patient_card_id?ir(h.patient_card_id):null,Y=C?k.get(C):null,ee=h.owner_id||h.client_id,ae=ee?ir(ee):null,ne=h.organization_id?ir(h.organization_id):null,b=h.caregiver_id?ir(h.caregiver_id):null,Q=f?.[h.id],z=Array.isArray(Q)?Q.map(fe=>ir(fe?.user_id||fe?.id||fe)).filter(Boolean):[];return{...h,patientCardId:C,patientName:Y?.full_name||Y?.name||"—",ownerId:ae,ownerName:ae?R.get(ae)?.name||ae:null,ownerType:ae&&R.get(ae)?.type||null,organizationId:ne,organizationName:ne&&R.get(ne)?.name||null,organizationType:ne&&M.get(ne)||null,caregiverId:b,caregiverName:b&&R.get(b)?.name||null,assignedEmployees:z,createdAt:h.created_at}}),[$,f,M,k,R]),Z=u.useCallback(h=>{const C=String(h.id);switch(h.type){case"organization":return B.filter(Y=>Y.organizationId&&Zt(Y.organizationId,C)||Y.ownerId&&Zt(Y.ownerId,C));case"employee":{const Y=L.get(C);return B.filter(ee=>ee.assignedEmployees?.some(ne=>Zt(ne,C))?!0:Y&&ee.organizationId&&Zt(ee.organizationId,Y)&&!(ee.assignedEmployees&&ee.assignedEmployees.length>0)?(ee.organizationType||M.get(Y))==="pension":!1)}case"privateCaregiver":return B.filter(Y=>Y.caregiverId&&Zt(Y.caregiverId,C));case"client":return B.filter(Y=>Y.ownerId&&Zt(Y.ownerId,C)||Y.client_id&&Zt(Y.client_id,C));default:return[]}},[B,L,M]),j=u.useMemo(()=>x.map(h=>{const C=h.relations?.map(Y=>{const ee=Y.rawValue??Y.value,ae=(()=>{switch(Y.label){case"Сиделка":return"Приглашён сиделкой";case"Организация":return"Организация";case"Клиент":return"Клиент";case"Город":return"Город";default:return Y.label}})();let ne=Y.value;return Y.label==="Организация"?ne=(ee?R.get(String(ee)):void 0)?.name??G.get(String(ee))??(ee?`ID: ${ee}`:Y.value):(Y.label==="Сиделка"||Y.label==="Клиент")&&(ne=(ee?R.get(String(ee)):void 0)?.name??(ee?`ID: ${ee}`:Y.value)),{label:ae,value:ne,rawValue:ee}})||[];return{...h,relations:C.length?C:void 0,diariesCount:Z(h).length}}),[x,Z,G,R]),v=u.useMemo(()=>j.filter(h=>{if(e!=="all"&&h.type!==e)return!1;if(!s.trim())return!0;const C=s.trim().toLowerCase();return[h.name,h.contact||"",h.roleLabel||"",h.sources.join(" "),...h.relations?.map(ee=>`${ee.label} ${ee.value}`)||[]].join(" ").toLowerCase().includes(C)}),[e,j,s]),E=u.useMemo(()=>({all:j.length,organization:j.filter(C=>C.type==="organization").length,employee:j.filter(C=>C.type==="employee").length,privateCaregiver:j.filter(C=>C.type==="privateCaregiver").length,client:j.filter(C=>C.type==="client").length}),[j]),T=()=>{c(null),_(!1),D(""),I(null)},J=h=>{c(h),D(h.contact||""),I(null)},W=()=>{if(!o)return null;const h=Z(o),C=o.payload||{},Y=zr(C)||o.name,ae=(()=>{switch(o.type){case"organization":return{organizationType:C.type||C.organization_type,address:C.address,city:C.city,email:C.email||(o.contact?.includes("@")?o.contact:null),phone:C.phone||(o.contact?.includes("@")?null:o.contact),userId:C.user_id||o.id,organizationId:C.id,createdAt:C.created_at,updatedAt:C.updated_at};case"employee":return{firstName:C.first_name,lastName:C.last_name,phone:C.phone||o.contact,email:C.email||(o.contact?.includes("@")?o.contact:null),employeeRole:C.employee_role||C.role,organizationId:C.organization_id,userId:C.user_id||o.id,createdAt:C.created_at,updatedAt:C.updated_at};case"privateCaregiver":return{firstName:C.first_name,lastName:C.last_name,phone:C.phone||o.contact,email:C.email||(o.contact?.includes("@")?o.contact:null),city:C.city,userId:C.user_id||o.id,organizationId:C.id,createdAt:C.created_at,updatedAt:C.updated_at};case"client":return{firstName:C.first_name,lastName:C.last_name,phone:C.phone||o.contact,email:C.email||(o.contact?.includes("@")?o.contact:null),caregiverId:C.caregiver_id,organizationId:C.organization_id,userId:C.user_id||o.id,createdAt:C.created_at,updatedAt:C.updated_at};default:return{}}})(),ne=b=>{switch(o.type){case"organization":return b.ownerId&&Zt(b.ownerId,o.id)?"Владелец":"Организация с доступом";case"employee":return b.assignedEmployees?.some(z=>Zt(z,o.id))?"Назначен к дневнику":"Доступ по организации";case"privateCaregiver":return"Сиделка с доступом";case"client":return b.ownerId&&Zt(b.ownerId,o.id)?"Владелец":"Читатель";default:return""}};return t.jsx("div",{className:"fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center px-4",children:t.jsxs("div",{className:"bg-white rounded-3xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden flex flex-col",children:[t.jsxs("div",{className:"px-6 pb-5 pt-0 border-b border-gray-200 flex items-center justify-between gap-6",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx("p",{className:"text-xs uppercase text-gray-400",children:Gt[o.type]}),t.jsx("h2",{className:"text-xl font-semibold text-gray-800",children:o.name}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2 mt-3",children:[t.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded-full bg-[#55ACBF]/10 text-xs font-semibold text-[#0A6D83]",children:Gt[o.type]}),t.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded-full bg-gray-100 text-xs font-semibold text-gray-600",children:["Дневников: ",h.length]}),o.sources.map(b=>t.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded-full bg-gray-100 text-[11px] font-medium text-gray-600",children:b},`modal-chip-${b}`))]})]}),t.jsx("button",{onClick:T,className:"text-gray-500 hover:text-gray-700 text-lg",children:"✕"})]}),t.jsxs("div",{className:"px-6 py-5 overflow-y-auto space-y-6",children:[t.jsxs("section",{className:"space-y-3",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Профиль"}),t.jsxs("div",{className:"grid gap-3 sm:grid-cols-2",children:[t.jsxs("div",{className:"bg-gray-50 rounded-2xl p-4",children:[t.jsx("p",{className:"text-xs uppercase text-gray-500 mb-1",children:"Название / Имя"}),t.jsx("p",{className:"text-sm font-medium text-gray-800",children:Y||"—"}),o.type==="organization"&&ae.organizationType&&t.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Тип: ",Ja(ae.organizationType)]}),(o.type==="employee"||o.type==="privateCaregiver"||o.type==="client")&&t.jsxs("div",{className:"mt-1 space-y-0.5",children:[ae.firstName&&t.jsxs("p",{className:"text-xs text-gray-500",children:["Имя: ",ae.firstName]}),ae.lastName&&t.jsxs("p",{className:"text-xs text-gray-500",children:["Фамилия: ",ae.lastName]})]})]}),t.jsx("div",{className:"bg-gray-50 rounded-2xl p-4 space-y-2",children:t.jsxs("div",{children:[t.jsx("p",{className:"text-xs uppercase text-gray-500 mb-1",children:"Контакты"}),t.jsxs("div",{className:"space-y-1",children:[ae.phone&&t.jsxs("p",{className:"text-sm text-gray-800",children:["📞 ",ae.phone]}),ae.email&&t.jsxs("p",{className:"text-sm text-gray-800",children:["✉️ ",ae.email]}),!ae.phone&&!ae.email&&t.jsx("p",{className:"text-sm text-gray-500",children:o.contact||"—"})]})]})}),t.jsxs("div",{className:"bg-gray-50 rounded-2xl p-4",children:[t.jsx("p",{className:"text-xs uppercase text-gray-500 mb-1",children:"Роль / Тип"}),t.jsx("p",{className:"text-sm font-medium text-gray-800",children:o.roleLabel||"—"}),o.type==="employee"&&ae.employeeRole&&t.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Должность: ",ae.employeeRole==="manager"?"Руководитель":ae.employeeRole==="caregiver"?"Сиделка":ae.employeeRole==="doctor"?"Врач":ae.employeeRole]})]}),o.type==="organization"&&t.jsxs(t.Fragment,{children:[ae.address&&t.jsxs("div",{className:"bg-gray-50 rounded-2xl p-4",children:[t.jsx("p",{className:"text-xs uppercase text-gray-500 mb-1",children:"Адрес"}),t.jsx("p",{className:"text-sm text-gray-800",children:ae.address})]}),ae.city&&t.jsxs("div",{className:"bg-gray-50 rounded-2xl p-4",children:[t.jsx("p",{className:"text-xs uppercase text-gray-500 mb-1",children:"Город"}),t.jsx("p",{className:"text-sm text-gray-800",children:ae.city})]})]}),o.type==="privateCaregiver"&&ae.city&&t.jsxs("div",{className:"bg-gray-50 rounded-2xl p-4",children:[t.jsx("p",{className:"text-xs uppercase text-gray-500 mb-1",children:"Город"}),t.jsx("p",{className:"text-sm text-gray-800",children:ae.city})]}),t.jsxs("div",{className:"bg-gray-50 rounded-2xl p-4",children:[t.jsx("p",{className:"text-xs uppercase text-gray-500 mb-1",children:"Идентификаторы"}),t.jsxs("div",{className:"space-y-1",children:[ae.userId&&t.jsxs("p",{className:"text-xs text-gray-600 break-all",children:["User ID: ",t.jsx("span",{className:"font-mono",children:ae.userId})]}),ae.organizationId&&o.type==="organization"&&t.jsxs("p",{className:"text-xs text-gray-600 break-all",children:["Org ID: ",t.jsx("span",{className:"font-mono",children:ae.organizationId})]}),ae.organizationId&&o.type==="employee"&&t.jsxs("p",{className:"text-xs text-gray-600 break-all",children:["Организация ID: ",t.jsx("span",{className:"font-mono",children:ae.organizationId})]})]})]}),(ae.createdAt||ae.updatedAt)&&t.jsxs("div",{className:"bg-gray-50 rounded-2xl p-4",children:[t.jsx("p",{className:"text-xs uppercase text-gray-500 mb-1",children:"Даты"}),t.jsxs("div",{className:"space-y-1",children:[ae.createdAt&&t.jsxs("p",{className:"text-xs text-gray-600",children:["Создан: ",new Date(ae.createdAt).toLocaleString("ru-RU")]}),ae.updatedAt&&t.jsxs("p",{className:"text-xs text-gray-600",children:["Обновлён: ",new Date(ae.updatedAt).toLocaleString("ru-RU")]})]})]}),t.jsxs("div",{className:"bg-gray-50 rounded-2xl p-4",children:[t.jsx("p",{className:"text-xs uppercase text-gray-500 mb-1",children:"Источник данных"}),t.jsx("div",{className:"flex flex-wrap gap-2 mt-1",children:o.sources.map(b=>t.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded-full bg-white text-xs font-medium text-[#0A6D83] border border-[#55ACBF]/40",children:b},b))})]})]})]}),o.relations&&o.relations.length>0&&t.jsxs("section",{className:"space-y-3",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Связанные сущности"}),t.jsx("div",{className:"grid gap-3 sm:grid-cols-2",children:o.relations.map(b=>{const Q=b.rawValue?R.get(String(b.rawValue)):void 0;return t.jsxs("div",{className:"bg-gray-50 rounded-2xl p-4",children:[t.jsx("p",{className:"text-xs uppercase text-gray-500 mb-1",children:b.label}),t.jsx("p",{className:"text-sm font-medium text-gray-800",children:b.value}),Q&&t.jsxs("div",{className:"mt-2 flex flex-wrap gap-1",children:[t.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded-full bg-white text-[10px] font-medium text-gray-600 border border-gray-200",children:Gt[Q.type]}),Q.contact&&t.jsx("span",{className:"text-[10px] text-gray-500",children:Q.contact})]})]},`relation-${b.label}-${b.value}`)})})]}),o.type==="client"&&t.jsxs("section",{className:"space-y-3",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Связи клиента"}),t.jsxs("div",{className:"grid gap-3 sm:grid-cols-2",children:[ae.caregiverId&&t.jsxs("div",{className:"bg-gray-50 rounded-2xl p-4",children:[t.jsx("p",{className:"text-xs uppercase text-gray-500 mb-1",children:"Приглашён сиделкой"}),(()=>{const b=R.get(String(ae.caregiverId));return b?t.jsxs(t.Fragment,{children:[t.jsx("p",{className:"text-sm font-medium text-gray-800",children:b.name}),b.contact&&t.jsx("p",{className:"text-xs text-gray-500 mt-1",children:b.contact})]}):t.jsxs("p",{className:"text-sm text-gray-600 break-all",children:["ID: ",t.jsx("span",{className:"font-mono",children:ae.caregiverId})]})})()]}),ae.organizationId&&t.jsxs("div",{className:"bg-gray-50 rounded-2xl p-4",children:[t.jsx("p",{className:"text-xs uppercase text-gray-500 mb-1",children:"Организация"}),(()=>{const b=R.get(String(ae.organizationId));return b?t.jsxs(t.Fragment,{children:[t.jsx("p",{className:"text-sm font-medium text-gray-800",children:b.name}),b.contact&&t.jsx("p",{className:"text-xs text-gray-500 mt-1",children:b.contact})]}):t.jsxs("p",{className:"text-sm text-gray-600 break-all",children:["ID: ",t.jsx("span",{className:"font-mono",children:ae.organizationId})]})})()]})]})]}),t.jsxs("section",{className:"space-y-3",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Доступ к дневникам"}),t.jsxs("span",{className:"text-sm text-gray-500",children:["Всего: ",h.length]})]}),t.jsx("div",{className:"border border-gray-200 rounded-2xl overflow-x-auto hidden md:block",children:t.jsxs("table",{className:"min-w-full divide-y divide-gray-200 text-sm",children:[t.jsx("thead",{className:"bg-[#F7FCFD] text-gray-500 uppercase tracking-wide text-xs",children:t.jsxs("tr",{children:[t.jsx("th",{className:"px-4 py-3 text-left",children:"ID дневника"}),t.jsx("th",{className:"px-4 py-3 text-left",children:"Подопечный"}),t.jsx("th",{className:"px-4 py-3 text-left",children:"Владелец"}),t.jsx("th",{className:"px-4 py-3 text-left",children:"Роль"}),t.jsx("th",{className:"px-4 py-3 text-left",children:"Организация"}),t.jsx("th",{className:"px-4 py-3 text-left",children:"Создан"})]})}),t.jsx("tbody",{className:"divide-y divide-gray-100 bg-white",children:h.length===0?t.jsx("tr",{children:t.jsx("td",{colSpan:6,className:"px-4 py-8 text-center text-sm text-gray-500",children:"Связанных дневников пока нет"})}):h.map(b=>t.jsxs("tr",{children:[t.jsx("td",{className:"px-4 py-3 font-mono text-xs text-gray-700 break-all",children:b.id}),t.jsx("td",{className:"px-4 py-3 text-gray-700",children:t.jsxs("div",{className:"space-y-1",children:[t.jsx("span",{className:"font-medium text-sm",children:b.patientName||"—"}),b.patientCardId&&t.jsxs("div",{className:"text-xs text-gray-400 break-all leading-tight",children:["Карточка:",t.jsx("div",{className:"mt-1",children:b.patientCardId})]})]})}),t.jsx("td",{className:"px-4 py-3 text-gray-700",children:t.jsxs("div",{className:"space-y-1",children:[t.jsx("span",{className:"font-medium text-sm",children:b.ownerName||"—"}),b.ownerType&&t.jsx("span",{className:"text-xs text-gray-400",children:Gt[b.ownerType]||b.ownerType})]})}),t.jsx("td",{className:"px-4 py-3 text-gray-600",children:t.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded-full bg-gray-100 text-xs font-medium text-gray-600",children:ne(b)})}),t.jsx("td",{className:"px-4 py-3 text-gray-600",children:b.organizationName?t.jsxs("div",{className:"space-y-1",children:[t.jsx("span",{className:"text-sm",children:b.organizationName}),b.organizationId&&t.jsxs("span",{className:"text-xs text-gray-400 break-all",children:["ID: ",b.organizationId]})]}):"—"}),t.jsx("td",{className:"px-4 py-3 text-gray-500",children:b.created_at?new Date(b.created_at).toLocaleString("ru-RU"):"—"})]},b.id))})]})}),t.jsx("div",{className:"md:hidden space-y-3",children:h.length===0?t.jsx("div",{className:"rounded-2xl border border-dashed border-gray-300 bg-white p-6 text-sm text-gray-500 text-center",children:"Связанных дневников пока нет"}):h.map(b=>t.jsxs("div",{className:"rounded-2xl border border-gray-200 bg-white p-5 flex flex-col gap-3",children:[t.jsxs("div",{className:"flex flex-wrap items-start justify-between gap-2",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-semibold text-gray-800",children:b.patientName||"Без названия"}),t.jsxs("p",{className:"text-xs text-gray-400 break-all mt-1",children:["Дневник: ",t.jsx("span",{className:"font-mono",children:b.id})]})]}),t.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded-full bg-gray-100 text-xs font-medium text-gray-600",children:ne(b)})]}),b.patientCardId&&t.jsxs("p",{className:"text-xs text-gray-500 break-all",children:["Карточка: ",t.jsx("span",{className:"font-mono",children:b.patientCardId})]}),t.jsxs("div",{className:"grid grid-cols-1 gap-2 text-sm text-gray-600",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-xs uppercase tracking-wide text-gray-500",children:"Владелец"}),t.jsx("p",{className:"font-medium",children:b.ownerName||"—"}),b.ownerType&&t.jsx("p",{className:"text-xs text-gray-400",children:Gt[b.ownerType]||b.ownerType})]}),t.jsxs("div",{children:[t.jsx("p",{className:"text-xs uppercase tracking-wide text-gray-500",children:"Организация"}),b.organizationName?t.jsxs(t.Fragment,{children:[t.jsx("p",{className:"font-medium",children:b.organizationName}),b.organizationId&&t.jsxs("p",{className:"text-xs text-gray-400 break-all",children:["ID: ",b.organizationId]})]}):t.jsx("p",{className:"text-gray-400",children:"—"})]}),t.jsxs("div",{children:[t.jsx("p",{className:"text-xs uppercase tracking-wide text-gray-500",children:"Создан"}),t.jsx("p",{children:b.created_at?new Date(b.created_at).toLocaleString("ru-RU"):"—"})]})]})]},`${o?.id}-diary-${b.id}`))})]}),t.jsxs("section",{className:"space-y-3",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Управление"}),t.jsx("div",{className:"bg-gray-50 rounded-2xl p-4",children:t.jsx("p",{className:"text-sm text-gray-600",children:"Функции управления пользователями будут доступны в следующих версиях админ-панели."})})]})]})]})})};return t.jsxs("div",{className:"space-y-8",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsx("h2",{className:"text-2xl font-bold text-gray-800",children:"Пользователи и доступы"}),t.jsx("p",{className:"text-sm text-gray-600 leading-relaxed max-w-3xl",children:"Просмотр организаций, сотрудников и клиентов, анализ их активности."})]}),t.jsx("div",{className:"grid gap-4 sm:grid-cols-2 lg:grid-cols-4",children:Object.keys(Gt).map(h=>t.jsxs("div",{role:"button",tabIndex:0,onClick:()=>r(h),onKeyDown:C=>{(C.key==="Enter"||C.key===" ")&&(C.preventDefault(),r(h))},className:`rounded-3xl border p-5 shadow-sm transition-colors cursor-pointer focus:outline-none focus:ring-2 focus:ring-[#55ACBF] focus:ring-offset-2 ${e===h?"border-[#55ACBF] bg-[#F7FCFD]":"border-gray-200 bg-white"}`,children:[t.jsxs("div",{className:"flex items-start justify-between gap-2",children:[t.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide",children:Gt[h]}),e===h&&t.jsx("span",{className:"text-[10px] font-semibold text-[#0A6D83] bg-[#0A6D83]/10 px-2 py-0.5 rounded-full",children:"Активно"})]}),t.jsx("p",{className:"text-2xl font-semibold text-gray-800 mt-1",children:h==="all"?E.all:E[h]}),t.jsx("p",{className:"text-[11px] text-gray-400 mt-2",children:h==="all"?"Всего профилей":h==="organization"?"Партнёрские организации":h==="employee"?"Внутренние специалисты":h==="privateCaregiver"?"Приглашённые частные сиделки":"Активные клиенты"})]},h))}),t.jsxs("div",{className:"bg-white border border-gray-200 rounded-3xl p-6 space-y-6 shadow-sm",children:[t.jsx("section",{className:"space-y-4",children:t.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-4 justify-between",children:[t.jsx(he,{value:s,onChange:h=>a(h.target.value),placeholder:"Поиск по имени, телефону, связям или источнику...",className:"sm:w-72 w-full"}),t.jsx("div",{className:"flex flex-wrap items-center gap-2 text-xs font-medium",children:Object.keys(Gt).map(h=>t.jsx("button",{onClick:()=>r(h),className:`px-3 py-1 rounded-full border transition-colors whitespace-normal text-left leading-tight max-w-[160px] ${e===h?"bg-[#55ACBF]/10 text-[#0A6D83] border-[#55ACBF]":"border-gray-200 text-gray-500 hover:text-[#0A6D83] hover:border-[#55ACBF]/40"}`,children:Gt[h]},h))}),t.jsx(oe,{variant:"outline",size:"sm",onClick:()=>{i(h=>h+1),S(!0)},className:"whitespace-nowrap",disabled:P,children:P?"Загрузка...":"Обновить данные"})]})}),t.jsxs("section",{className:"space-y-4",children:[t.jsx("div",{className:"overflow-hidden border border-gray-200 rounded-2xl overflow-x-auto hidden lg:block",children:t.jsxs("table",{className:"min-w-full divide-y divide-gray-200 text-sm",children:[t.jsx("thead",{className:"bg-[#F7FCFD] text-gray-500 uppercase tracking-wide text-xs",children:t.jsxs("tr",{children:[t.jsx("th",{className:"px-4 py-3 text-left",children:"Тип"}),t.jsx("th",{className:"px-4 py-3 text-left",children:"Имя"}),t.jsx("th",{className:"px-4 py-3 text-left",children:"Контакты"}),t.jsx("th",{className:"px-4 py-3 text-left",children:"Роль и связи"}),t.jsx("th",{className:"px-4 py-3 text-left",children:"Доступ к дневникам"}),t.jsx("th",{className:"px-4 py-3 text-left",children:"Источник данных"}),t.jsx("th",{className:"px-4 py-3 text-left",children:"Действия"})]})}),t.jsx("tbody",{className:"divide-y divide-gray-100 bg-white",children:v.length===0?t.jsx("tr",{children:t.jsx("td",{colSpan:7,className:"px-4 py-10 text-center text-sm text-gray-500",children:"Пользователи не найдены. Измените фильтр или обновите данные."})}):v.map(h=>t.jsxs("tr",{children:[t.jsx("td",{className:"px-4 py-3 text-gray-800",children:t.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-[#F7FCFD] text-[#0A6D83] border border-[#55ACBF]/40",children:h.type==="organization"?"Организация":h.type==="employee"?"Сотрудник":h.type==="privateCaregiver"?"Частная сиделка":"Клиент"})}),t.jsx("td",{className:"px-4 py-3 text-gray-800 font-medium",children:t.jsxs("div",{className:"space-y-1",children:[t.jsx("span",{children:h.name}),t.jsxs("span",{className:"text-xs text-gray-400 break-all",children:["ID: ",h.id]})]})}),t.jsx("td",{className:"px-4 py-3 text-gray-700",children:h.contact||"—"}),t.jsx("td",{className:"px-4 py-3 text-gray-600",children:t.jsxs("div",{className:"space-y-2",children:[t.jsx("p",{className:"text-sm font-medium text-gray-700",children:h.roleLabel?`Роль: ${h.roleLabel}`:"Роль не указана"}),h.relations&&h.relations.length>0?t.jsx("div",{className:"flex flex-wrap gap-1.5",children:h.relations.map(C=>t.jsxs("span",{className:"inline-flex items-center px-2.5 py-1 rounded-full text-[11px] text-[#0A6D83] bg-[#E5F4F7]",children:[C.label,": ",C.value]},`${h.id}-${C.label}-${C.value}`))}):t.jsx("span",{className:"text-xs text-gray-400",children:"Дополнительных связей нет"})]})}),t.jsx("td",{className:"px-4 py-3",children:t.jsx("span",{className:`inline-flex items-center justify-center min-w-[2.5rem] px-2 py-1 rounded-full text-xs font-semibold ${(h.diariesCount??0)>0?"bg-[#55ACBF]/10 text-[#0A6D83]":"bg-gray-100 text-gray-500"}`,children:h.diariesCount??0})}),t.jsx("td",{className:"px-4 py-3",children:t.jsx("div",{className:"flex flex-wrap gap-1",children:h.sources.map(C=>t.jsxs("span",{className:"inline-flex items-center gap-1 text-[11px] font-medium px-2 py-1 rounded-full bg-[#F1F5F9] text-gray-600 border border-slate-200",children:[t.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-gray-400"}),C]},`${h.id}-${C}`))})}),t.jsx("td",{className:"px-4 py-3",children:t.jsx(oe,{variant:"outline",size:"sm",onClick:()=>J(h),children:"Подробнее"})})]},`${h.type}-${h.id}`))})]})}),t.jsx("div",{className:"lg:hidden space-y-3",children:v.length===0?t.jsx("div",{className:"rounded-2xl border border-dashed border-gray-300 bg-white p-6 text-sm text-gray-500 text-center",children:"Пользователи не найдены. Измените фильтр или обновите данные."}):v.map(h=>t.jsxs("div",{className:"rounded-2xl border border-gray-200 bg-white p-5 shadow-sm flex flex-col gap-3",children:[t.jsxs("div",{className:"flex flex-wrap items-center gap-2 justify-between",children:[t.jsx("span",{className:"inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-[#F7FCFD] text-[#0A6D83] border border-[#55ACBF]/40",children:h.type==="organization"?"Организация":h.type==="employee"?"Сотрудник":h.type==="privateCaregiver"?"Частная сиделка":"Клиент"}),t.jsx("button",{onClick:()=>J(h),className:"text-xs font-semibold text-[#0A6D83] underline underline-offset-4",children:"Открыть профиль"})]}),t.jsxs("div",{className:"space-y-1.5",children:[t.jsx("p",{className:"text-base font-semibold text-gray-800",children:h.name}),t.jsxs("p",{className:"text-xs text-gray-400 break-all",children:["ID: ",h.id]}),t.jsx("p",{className:"text-sm text-gray-600",children:h.contact||"Контакты не указаны"})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx("p",{className:"text-xs uppercase tracking-wide text-gray-500",children:"Роль и связи"}),t.jsxs("div",{className:"space-y-1.5",children:[t.jsx("p",{className:"text-sm text-gray-700",children:h.roleLabel?`Роль: ${h.roleLabel}`:"Роль не указана"}),h.relations&&h.relations.length>0?t.jsx("div",{className:"flex flex-wrap gap-1.5",children:h.relations.map(C=>t.jsxs("span",{className:"inline-flex items-center px-2.5 py-1 rounded-full text-[11px] text-[#0A6D83] bg-[#E5F4F7]",children:[C.label,": ",C.value]},`${h.id}-${C.label}-${C.value}-card`))}):t.jsx("span",{className:"text-xs text-gray-400",children:"Дополнительных связей нет"})]})]}),t.jsxs("div",{className:"flex items-center justify-between text-xs text-gray-500",children:[t.jsxs("div",{children:["Доступ к дневникам:"," ",t.jsx("span",{className:"font-semibold text-[#0A6D83]",children:h.diariesCount??0})]}),t.jsxs("span",{className:"text-right max-w-[50%]",children:["Источники: ",h.sources.length?h.sources.join(", "):"—"]})]})]},`${h.type}-${h.id}-card`))})]})]}),W()]})},ap=e=>{switch(e){case"pension":return"Пансионат";case"patronage_agency":return"Патронажное агентство";case"caregiver":return"Частная сиделка";default:return e?String(e):null}},ss=e=>{const{full_name:r,name:s,first_name:a,last_name:n}=e||{};if(r&&String(r).trim().length>0)return String(r).trim();if(s&&String(s).trim().length>0)return String(s).trim();const i=`${a||""} ${n||""}`.trim();return i.length>0?i:""},Wt=e=>e==null?"":String(e),Yt=e=>{if(!e||typeof e!="object")return!1;const r=String(e.status??e.state??e.lifecycle??"").trim().toLowerCase();return!!(["deleted","archived","removed","inactive"].includes(r)||e.deleted===!0||e.is_deleted===!0||e.archived===!0||e.is_archived===!0||e.deleted_at||e.removed_at||e.archived_at)},np=()=>{try{const e=localStorage.getItem("admin_support_audit");if(!e)return[];const r=JSON.parse(e);if(Array.isArray(r))return r}catch(e){console.warn("Не удалось загрузить журнал поддержки",e)}return[]},ip=e=>({walk:"Прогулка",cognitive_games:"Когнитивные игры",diaper_change:"Смена подгузников",hygiene:"Гигиена",skin_moisturizing:"Увлажнение кожи",meal:"Прием пищи",medications:"Прием лекарств",vitamins:"Прием витаминов",sleep:"Сон",temperature:"Температура",blood_pressure:"Давление",breathing_rate:"Частота дыхания",pain_level:"Уровень боли",saturation:"Сатурация",blood_sugar:"Уровень сахара в крови",urination:"Выделение мочи",defecation:"Дефекация",nausea:"Тошнота",vomiting:"Рвота",shortness_of_breath:"Одышка",itching:"Зуд",cough:"Кашель",dry_mouth:"Сухость во рту",hiccups:"Икота",taste_disturbance:"Нарушение вкуса",support_note:"Запись поддержки"})[e]||e,op={walks:"Ходит",sits:"Сидит",lies:"Лежит"},So=e=>{if(!e)return"—";try{return new Date(e).toLocaleString("ru-RU")}catch{return e}},Ao=e=>{if(!e)return"";try{return new Date(e).toISOString().slice(0,10)}catch{return e}},lp=()=>{const[e,r]=u.useState(""),[s,a]=u.useState(0),[n,i]=u.useState(null),[o,c]=u.useState("overview"),[g,_]=u.useState(!1),[y,D]=u.useState(null),[w,I]=u.useState(null),[P,S]=u.useState([]),[U,O]=u.useState({metricType:"",value:"",note:""}),[$,p]=u.useState(null),[k,f]=u.useState("all"),[x,R]=u.useState("desc"),[G,M]=u.useState(!0),[L,B]=u.useState({diaries:[],patientCards:[],organizations:[],userProfiles:[],clients:[],employees:[],privateCaregivers:[],metricValues:[],history:[]});u.useEffect(()=>{(async()=>{try{M(!0);const C=localStorage.getItem("admin_token")||"b8f56f5c-62f1-45d9-9e5a-e8bbfdadcf0f",Y="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyAgCiAgICAicm9sZSI6ICJhbm9uIiwKICAgICJpc3MiOiAic3VwYWJhc2UtZGVtbyIsCiAgICAiaWF0IjogMTY0MTc2OTIwMCwKICAgICJleHAiOiAxNzk5NTM1NjAwCn0.dc_X5iR_VP_qT0zsiyj_I_OZ2T9FtRU2BBNWN8Bu4GE",ee=fs("admin-support-data"),ae=await fetch(`${ee}?admin_token=${encodeURIComponent(C)}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${Y}`,apikey:Y}});if(!ae.ok){const b=await ae.json().catch(()=>({error:"Неизвестная ошибка"}));console.error("Ошибка загрузки данных:",b),M(!1);return}const ne=await ae.json();if(!ne.success||!ne.data){console.error("Неверный формат ответа от Edge Function"),M(!1);return}console.log("✅ Загружены данные из Supabase для поддержки:",{diaries:ne.data.diaries?.length||0,patientCards:ne.data.patientCards?.length||0,organizations:ne.data.organizations?.length||0,metricValues:ne.data.metricValues?.length||0,history:ne.data.history?.length||0}),B({diaries:ne.data.diaries||[],patientCards:ne.data.patientCards||[],organizations:ne.data.organizations||[],userProfiles:ne.data.userProfiles||[],clients:ne.data.clients||[],employees:ne.data.employees||[],privateCaregivers:ne.data.privateCaregivers||[],metricValues:ne.data.metricValues||[],history:ne.data.history||[]})}catch(C){console.error("Ошибка загрузки данных из Supabase:",C)}finally{M(!1)}})()},[s]);const Z=u.useMemo(()=>{const h=L.diaries.filter(ce=>!Yt(ce)),C=L.patientCards,Y=L.userProfiles,ee=L.clients,ae=L.employees,ne=L.organizations,b=L.privateCaregivers,Q=new Map;C.forEach(ce=>{Yt(ce)||Q.set(Wt(ce?.id),ce)});const z=ce=>{if(!ce)return null;const me=Wt(ce),_e=Y.find(Ce=>Wt(Ce?.user_id||Ce?.id)===me);if(_e&&!Yt(_e))return{id:me,name:ss(_e)||_e.phone||_e.email||`Пользователь ${me}`,contact:_e.phone||_e.email||"",role:_e.user_role||"Пользователь",source:"user_profiles",raw:_e};const De=ee.find(Ce=>Wt(Ce?.user_id||Ce?.id)===me);if(De&&!Yt(De))return{id:me,name:ss(De)||De.phone||`Клиент ${me}`,contact:De.phone||"",role:"Клиент",source:"clients",raw:De};const xe=ae.find(Ce=>Wt(Ce?.user_id||Ce?.id)===me);if(xe&&!Yt(xe))return{id:me,name:ss(xe)||xe.phone||`Сотрудник ${me}`,contact:xe.phone||xe.email||"",role:xe.role||"Сотрудник",source:"organization_employees",raw:xe};const ze=b.find(Ce=>Wt(Ce?.user_id||Ce?.id)===me);return ze&&!Yt(ze)?{id:me,name:ss(ze)||ze.phone||`Сиделка ${me}`,contact:ze.phone||ze.email||"",role:"Частная сиделка",source:"private_caregiver_profiles",raw:ze}:{id:me,name:`ID: ${me}`,contact:"",role:"",source:"unknown"}},fe=ce=>{if(!ce)return null;const me=Wt(ce),_e=ne.find(De=>{const xe=De?.id??De?.user_id;return Wt(xe)===me});return!_e||Yt(_e)?null:{id:me,name:_e.name||ss(_e)||`Организация ${me}`,contact:_e.phone||_e.email||"",typeLabel:ap(_e.type),raw:_e}},ye=[];return h.forEach(ce=>{if(Yt(ce))return;const me=Wt(ce?.id);if(!me)return;const _e=Wt(ce?.patient_card_id),De=_e?Q.get(_e):void 0;if(_e&&!De||De&&Yt(De))return;const xe=z(ce?.owner_id??ce?.client_id),ze=z(ce?.caregiver_id),Ce=fe(ce?.organization_id),kt=De?.full_name||De?.name||xe?.name||ce?.patient_name||`Подопечный (${_e||"без карточки"})`;ye.push({id:me,createdAt:ce?.created_at||null,cardId:_e||null,patientName:kt,card:De,owner:xe,caregiver:ze,organization:Ce,raw:ce})}),ye},[s,L]),j=u.useMemo(()=>{const h=Z.length,C=Z.filter(ae=>ae.organization).length,Y=Z.filter(ae=>ae.caregiver).length,ee=h-C;return{total:h,withOrg:C,withoutOrg:ee,withCaregiver:Y}},[Z]),v=u.useMemo(()=>{const h=Z.filter(ee=>{switch(k){case"with_org":return!!ee.organization;case"without_org":return!ee.organization;case"with_caregiver":return!!ee.caregiver;default:return!0}}),C=e.trim().toLowerCase();return(C?h.filter(ee=>[ee.id,ee.patientName,ee.cardId,ee.owner?.name,ee.owner?.contact,ee.organization?.name,ee.organization?.typeLabel,ee.caregiver?.name].join(" ").toLowerCase().includes(C)):h).slice().sort((ee,ae)=>{const ne=ee.createdAt?new Date(ee.createdAt).getTime():0,b=ae.createdAt?new Date(ae.createdAt).getTime():0;return x==="desc"?b-ne:ne-b})},[Z,e,k,x]);u.useEffect(()=>{if(v.length===0){i(null);return}(!n||!v.some(h=>h.id===n))&&(i(v[0].id),c("overview"))},[v,n]);const E=u.useMemo(()=>v.find(h=>h.id===n)||null,[v,n]);u.useEffect(()=>{if(!E){D(null),S([]);return}const h=E.card;D({full_name:h?.full_name||"",date_of_birth:Ao(h?.date_of_birth),address:h?.address||"",entrance:h?.entrance||"",apartment:h?.apartment||"",gender:h?.gender==="female"?"female":"male",mobility:h?.mobility||"walks",has_pets:!!h?.has_pets,diagnoses:Array.isArray(h?.diagnoses)?h.diagnoses:[],services:Array.isArray(h?.services)?h.services:[],service_wishes:Array.isArray(h?.service_wishes)?h.service_wishes:[]});const C=L.history.filter(ee=>ee.diary_id===E.id).map(ee=>({id:ee.id,diary_id:ee.diary_id,metric_type:ee.metric_type||"support_note",value:ee.value||ee.details||"",created_at:ee.occurred_at||ee.created_at||new Date().toISOString()})),Y=L.metricValues.filter(ee=>ee.diary_id===E.id).map(ee=>({id:ee.id,diary_id:ee.diary_id,metric_type:ee.metric_type,value:typeof ee.value=="object"?JSON.stringify(ee.value):String(ee.value||""),created_at:ee.recorded_at||ee.created_at||new Date().toISOString()}));S([...C,...Y]),O({metricType:"",value:"",note:""}),I(null),p(null)},[E?.id,s,L.history,L.metricValues]);const T=u.useMemo(()=>np(),[s]);u.useMemo(()=>T.filter(h=>E&&h.diaryId===E.id).sort((h,C)=>new Date(C.timestamp).getTime()-new Date(h.timestamp).getTime()),[T,E]);const J=(h,C=!1)=>{i(h),c("overview"),C&&_(!0)},W=()=>{_(!1)};return t.jsxs("div",{className:"space-y-8",children:[t.jsx("div",{className:"space-y-2",children:t.jsx("h2",{className:"text-2xl font-bold text-gray-800",children:"Помощь пользователям"})}),t.jsx("div",{className:"grid gap-3 sm:grid-cols-2 lg:grid-cols-4",children:[{label:"Всего дневников",value:j.total},{label:"С организациями",value:j.withOrg},{label:"С сиделками",value:j.withCaregiver},{label:"Без организации",value:j.withoutOrg}].map(h=>t.jsxs("div",{className:"bg-white border border-gray-200 rounded-2xl p-4 shadow-sm flex flex-col gap-1",children:[t.jsx("span",{className:"text-xs uppercase text-gray-400",children:h.label}),t.jsx("span",{className:"text-2xl font-semibold text-[#0A6D83]",children:h.value})]},h.label))}),G?t.jsx("div",{className:"bg-white border border-gray-200 rounded-3xl p-6 shadow-sm text-center text-gray-500",children:"Загрузка данных..."}):t.jsx("div",{className:"bg-white border border-gray-200 rounded-3xl p-6 shadow-sm space-y-6",children:t.jsxs("div",{className:"flex flex-col lg:flex-row gap-6",children:[t.jsxs("div",{className:"lg:w-1/3 space-y-4",children:[t.jsx(he,{value:e,onChange:h=>r(h.target.value),placeholder:"Поиск по ФИО, организации или ID дневника"}),t.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3 text-xs",children:[t.jsx("div",{className:"flex flex-wrap gap-2",children:[{value:"all",label:"Все"},{value:"with_org",label:"С организацией"},{value:"without_org",label:"Без организации"},{value:"with_caregiver",label:"С сиделкой"}].map(h=>t.jsx("button",{onClick:()=>f(h.value),className:`px-3 py-1 rounded-full border transition-colors ${k===h.value?"border-[#55ACBF] bg-[#55ACBF]/10 text-[#0A6D83] font-medium":"border-gray-200 text-gray-500 hover:border-[#55ACBF]/40"}`,type:"button",children:h.label},h.value))}),t.jsxs("button",{type:"button",onClick:()=>R(h=>h==="desc"?"asc":"desc"),className:"px-3 py-1 rounded-full border border-gray-200 text-gray-600 hover:border-[#55ACBF]/40 transition-colors",children:["Сортировка: ",x==="desc"?"сначала новые":"сначала старые"]})]}),t.jsxs("div",{className:"border border-gray-100 rounded-2xl divide-y divide-gray-100 max-h-[520px] overflow-y-auto",children:[v.length===0&&t.jsx("div",{className:"px-4 py-6 text-sm text-gray-500 text-center",children:"Дневники не найдены. Измените запрос поиска."}),v.map(h=>{const C=h.id===n;return t.jsx("button",{onClick:()=>J(h.id,!0),className:`w-full text-left px-4 py-4 transition-colors rounded-2xl border ${C?"border-[#55ACBF] bg-[#F7FCFD] shadow-sm":"border-transparent hover:border-[#55ACBF]/30 hover:bg-gray-50"}`,children:t.jsxs("div",{className:"space-y-1",children:[t.jsx("p",{className:"text-sm font-semibold text-gray-800",children:h.patientName}),t.jsxs("p",{className:"text-xs text-gray-500 break-all",children:["ID дневника: ",h.id]}),h.cardId&&t.jsxs("p",{className:"text-xs text-gray-500 break-all",children:["Карточка: ",h.cardId]}),t.jsxs("div",{className:"flex flex-wrap gap-1 text-[11px] text-gray-500",children:[h.owner&&t.jsxs("span",{children:["Владелец: ",h.owner.name]}),h.organization&&t.jsxs("span",{children:["Орг.: ",h.organization.name]})]})]})},h.id)})]})]}),t.jsx("div",{className:"lg:flex-1 bg-gray-50 rounded-3xl p-6 space-y-6 border border-gray-100",children:E?t.jsx(t.Fragment,{}):t.jsx("div",{className:"text-center text-sm text-gray-500 py-12",children:"Выберите дневник слева, чтобы просмотреть подробности."})})]})}),E&&g&&t.jsx("div",{className:"fixed inset-0 bg-black/40 z-50 flex items-center justify-center px-4",children:t.jsxs("div",{className:"bg-white rounded-3xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden flex flex-col",children:[t.jsxs("div",{className:"px-6 py-4 border-b border-gray-200 flex items-center justify-between gap-4",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-xs uppercase text-gray-400 mb-1",children:"Дневник здоровья"}),t.jsx("h2",{className:"text-xl font-semibold text-gray-800",children:E.patientName}),t.jsxs("div",{className:"flex flex-wrap gap-2 mt-2 text-xs text-gray-500",children:[t.jsxs("span",{children:["Дневник создан: ",So(E.createdAt)]}),E.organization?.name&&t.jsxs("span",{children:["Организация: ",E.organization.name]}),E.owner?.name&&t.jsxs("span",{children:["Владелец: ",E.owner.name]})]})]}),t.jsx("button",{type:"button",onClick:W,className:"text-gray-500 hover:text-gray-700 text-xl leading-none",children:"✕"})]}),t.jsxs("div",{className:"px-6 py-5 overflow-y-auto space-y-5",children:[t.jsxs("div",{className:"bg-gray-50 rounded-2xl p-4 space-y-2 text-sm text-gray-700",children:[t.jsx("h3",{className:"text-sm font-semibold text-gray-800",children:"Основная информация"}),t.jsxs("p",{children:[t.jsx("span",{className:"text-xs uppercase text-gray-400",children:"ID дневника: "}),t.jsx("span",{className:"break-all",children:E.id})]}),E.cardId&&t.jsxs("p",{children:[t.jsx("span",{className:"text-xs uppercase text-gray-400",children:"ID карточки: "}),t.jsx("span",{className:"break-all",children:E.cardId})]}),E.organization&&t.jsxs("p",{children:[t.jsx("span",{className:"text-xs uppercase text-gray-400",children:"Организация: "}),t.jsx("span",{children:E.organization.name})]}),E.caregiver&&t.jsxs("p",{children:[t.jsx("span",{className:"text-xs uppercase text-gray-400",children:"Сиделка: "}),t.jsx("span",{children:E.caregiver.name})]})]}),E.card&&t.jsxs("div",{className:"bg-gray-50 rounded-2xl p-4 space-y-2 text-sm text-gray-700",children:[t.jsx("h3",{className:"text-sm font-semibold text-gray-800",children:"Карточка подопечного"}),E.card.full_name&&t.jsxs("p",{children:[t.jsx("span",{className:"text-xs uppercase text-gray-400",children:"ФИО: "}),t.jsx("span",{children:E.card.full_name})]}),E.card.date_of_birth&&t.jsxs("p",{children:[t.jsx("span",{className:"text-xs uppercase text-gray-400",children:"Дата рождения: "}),t.jsx("span",{children:Ao(E.card.date_of_birth)})]}),E.card.address&&t.jsxs("p",{children:[t.jsx("span",{className:"text-xs uppercase text-gray-400",children:"Адрес: "}),t.jsx("span",{children:E.card.address})]}),(E.card.entrance||E.card.apartment)&&t.jsxs("p",{children:[t.jsx("span",{className:"text-xs uppercase text-gray-400",children:"Подъезд / квартира: "}),t.jsxs("span",{children:[E.card.entrance&&`Подъезд ${E.card.entrance}`,E.card.entrance&&E.card.apartment&&", ",E.card.apartment&&`Кв. ${E.card.apartment}`]})]}),E.card.gender&&t.jsxs("p",{children:[t.jsx("span",{className:"text-xs uppercase text-gray-400",children:"Пол: "}),t.jsx("span",{children:E.card.gender==="female"?"Женский":E.card.gender==="male"?"Мужской":"Не указан"})]}),E.card.mobility&&t.jsxs("p",{children:[t.jsx("span",{className:"text-xs uppercase text-gray-400",children:"Мобильность: "}),t.jsx("span",{children:op[E.card.mobility]||E.card.mobility})]}),t.jsxs("p",{children:[t.jsx("span",{className:"text-xs uppercase text-gray-400",children:"Домашние животные: "}),t.jsx("span",{children:E.card.has_pets?"Да":"Нет"})]}),E.card.diagnoses&&E.card.diagnoses.length>0&&t.jsxs("p",{children:[t.jsx("span",{className:"text-xs uppercase text-gray-400",children:"Диагнозы: "}),t.jsx("span",{children:E.card.diagnoses.join(", ")})]}),E.card.services&&E.card.services.length>0&&t.jsxs("p",{children:[t.jsx("span",{className:"text-xs uppercase text-gray-400",children:"Требуемые услуги: "}),t.jsx("span",{children:E.card.services.join(", ")})]}),E.card.service_wishes&&E.card.service_wishes.length>0&&t.jsxs("p",{children:[t.jsx("span",{className:"text-xs uppercase text-gray-400",children:"Пожелания по услугам: "}),t.jsx("span",{children:E.card.service_wishes.join(", ")})]})]}),P.length>0&&t.jsxs("div",{className:"bg-gray-50 rounded-2xl p-4 space-y-3 text-sm text-gray-700",children:[t.jsx("h3",{className:"text-sm font-semibold text-gray-800",children:"Последние записи"}),t.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:P.slice().sort((h,C)=>new Date(C.created_at).getTime()-new Date(h.created_at).getTime()).slice(0,10).map(h=>t.jsxs("div",{className:"border border-gray-100 rounded-2xl px-3 py-2 bg-white",children:[t.jsxs("div",{className:"flex items-center justify-between text-xs text-gray-400 mb-1",children:[t.jsx("span",{children:ip(h.metric_type)}),t.jsx("span",{children:So(h.created_at)})]}),t.jsx("p",{className:"text-sm text-gray-700 whitespace-pre-wrap break-words",children:String(h.value||"")})]},h.id))})]})]})]})})]})},Do=e=>({walk:"Прогулка",cognitive_games:"Когнитивные игры",diaper_change:"Смена подгузников",hygiene:"Гигиена",skin_moisturizing:"Увлажнение кожи",meal:"Прием пищи",medications:"Прием лекарств",vitamins:"Прием витаминов",sleep:"Сон",temperature:"Температура",blood_pressure:"Давление",breathing_rate:"Частота дыхания",pain_level:"Уровень боли",saturation:"Сатурация",blood_sugar:"Уровень сахара",urination:"Выделение мочи",defecation:"Дефекация",nausea:"Тошнота",vomiting:"Рвота",shortness_of_breath:"Одышка",itching:"Зуд",cough:"Кашель",dry_mouth:"Сухость во рту",hiccups:"Икота",taste_disturbance:"Нарушение вкуса",support_note:"Запись поддержки"})[e]||e,cp=e=>e.toLocaleDateString("ru-RU",{day:"2-digit",month:"2-digit"}),Eo=(e=7)=>{const r=[],s=new Map,a=new Date;for(let n=e-1;n>=0;n--){const i=new Date(a);i.setDate(a.getDate()-n);const o=i.toISOString().slice(0,10),c={key:o,date:i,label:cp(i),value:0};r.push(c),s.set(o,c)}return{buckets:r,map:s}},zo=({data:e,height:r=380,color:s="#0A6D83"})=>{const n={top:24,right:24,bottom:96,left:68},i=640-n.left-n.right,o=r-n.top-n.bottom,c=Math.max(...e.map(P=>P.value),1),g=e.length>1?i/(e.length-1):i,[_,y]=u.useState(null),D=e.map((P,S)=>{const U=n.left+S*g,O=n.top+(c===0?o:o-Math.max(0,Math.min(1,P.value/c))*o);return{x:U,y:O,v:P.value,label:P.label}}),w=D.length>0?`M ${D[0].x},${D[0].y} `+D.slice(1).map(P=>`L ${P.x},${P.y}`).join(" "):"",I=[0,.25,.5,.75,1].map(P=>({y:n.top+o-P*o,v:Math.round(c*P)}));return t.jsxs("div",{className:"w-full relative",children:[_&&t.jsxs("div",{className:"absolute bg-white text-xs text-gray-700 border border-gray-200 shadow-md rounded-md px-2 py-1 pointer-events-none",style:{left:`calc(${_.x/640*100}% - 40px)`,top:Math.max(0,(_.y-28)/r*100)+"%"},children:[t.jsx("div",{className:"font-medium",children:_.value}),t.jsx("div",{className:"text-gray-500",children:_.label})]}),t.jsxs("svg",{viewBox:`0 0 640 ${r}`,className:"w-full h-96",children:[t.jsx("line",{x1:n.left,y1:n.top+o,x2:n.left+i,y2:n.top+o,stroke:"#E5E7EB",strokeWidth:2}),t.jsx("line",{x1:n.left,y1:n.top,x2:n.left,y2:n.top+o,stroke:"#E5E7EB",strokeWidth:2}),I.map((P,S)=>t.jsxs("g",{children:[t.jsx("line",{x1:n.left,y1:P.y,x2:n.left+i,y2:P.y,stroke:"#E9EEF5"}),t.jsx("text",{x:n.left-14,y:P.y+10,textAnchor:"end",fontSize:"20",fontWeight:"800",fill:"#0F172A",children:P.v})]},S)),t.jsx("path",{d:w,fill:"none",stroke:s,strokeWidth:4}),D.map((P,S)=>t.jsxs("g",{children:[t.jsx("circle",{cx:P.x,cy:P.y,r:7,fill:s,className:"cursor-pointer",onClick:()=>y({x:P.x,y:P.y,label:P.label,value:P.v})}),t.jsx("text",{x:P.x,y:n.top+o+30,textAnchor:"middle",fontSize:"20",fontWeight:"800",fill:"#0F172A",children:P.label}),t.jsx("text",{x:P.x,y:n.top+o+56,textAnchor:"middle",fontSize:"20",fill:"#0F172A",children:P.v})]},S))]})]})},dp=()=>{const[e,r]=u.useState(!0),[s,a]=u.useState(7),[n,i]=u.useState({diaries:[],patientCards:[],organizations:[],userProfiles:[],clients:[],employees:[],history:[],metricValues:[]});u.useEffect(()=>{(async()=>{try{r(!0);const O=localStorage.getItem("admin_token")||"b8f56f5c-62f1-45d9-9e5a-e8bbfdadcf0f",$="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyAgCiAgICAicm9sZSI6ICJhbm9uIiwKICAgICJpc3MiOiAic3VwYWJhc2UtZGVtbyIsCiAgICAiaWF0IjogMTY0MTc2OTIwMCwKICAgICJleHAiOiAxNzk5NTM1NjAwCn0.dc_X5iR_VP_qT0zsiyj_I_OZ2T9FtRU2BBNWN8Bu4GE",p=fs("admin-support-data"),k=await fetch(`${p}?admin_token=${encodeURIComponent(O)}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${$}`,apikey:$}});if(!k.ok){const x=await k.json().catch(()=>({error:"Неизвестная ошибка"}));console.error("Ошибка загрузки данных для мониторинга:",x),r(!1);return}const f=await k.json();if(!f.success||!f.data){console.error("Неверный формат ответа от Edge Function admin-support-data"),r(!1);return}i({diaries:f.data.diaries||[],patientCards:f.data.patientCards||[],organizations:f.data.organizations||[],userProfiles:f.data.userProfiles||[],clients:f.data.clients||[],employees:f.data.employees||[],history:f.data.history||[],metricValues:f.data.metricValues||[]})}catch(O){console.error("Ошибка загрузки данных мониторинга из Supabase:",O)}finally{r(!1)}})()},[]);const o=u.useMemo(()=>n.diaries,[n.diaries]),c=u.useMemo(()=>n.patientCards,[n.patientCards]),g=u.useMemo(()=>n.organizations,[n.organizations]),_=u.useMemo(()=>n.clients,[n.clients]),y=u.useMemo(()=>n.history,[n.history]),D=u.useMemo(()=>n.metricValues,[n.metricValues]),w=u.useMemo(()=>n.userProfiles.length+n.clients.length+n.employees.length,[n.userProfiles,n.clients,n.employees]),I=u.useMemo(()=>{const{buckets:U,map:O}=Eo(s);return o.forEach($=>{const p=$?.created_at;if(!p)return;const k=new Date(p).toISOString().slice(0,10),f=O.get(k);f&&(f.value+=1)}),U},[o,s]),P=u.useMemo(()=>{const{buckets:U}=Eo(s),O=new Map;return U.forEach($=>{O.set($.key,new Set)}),y.forEach($=>{if(!$?.occurred_at||!$?.diary_id)return;const p=new Date($.occurred_at).toISOString().slice(0,10),k=O.get(p);k&&k.add(String($.diary_id))}),D.forEach($=>{if(!$?.recorded_at||!$?.diary_id)return;const p=new Date($.recorded_at).toISOString().slice(0,10),k=O.get(p);k&&k.add(String($.diary_id))}),U.forEach($=>{const p=O.get($.key);$.value=p?p.size:0}),U},[y,D,s]),S=u.useMemo(()=>{const U=o.length,O=c.length,$=w,p=g.length,k=y.length+D.length,f=new Date,x=new Date(f.getFullYear(),f.getMonth(),f.getDate()).getTime();let R=0;return y.forEach(G=>{G?.occurred_at&&new Date(G.occurred_at).getTime()>=x&&(R+=1)}),D.forEach(G=>{G?.recorded_at&&new Date(G.recorded_at).getTime()>=x&&(R+=1)}),{diariesCount:U,cardsCount:O,usersCount:$,orgCount:p,totalEntries:k,todayEntries:R,created7Days:I.reduce((G,M)=>G+M.value,0),activeDiaries7Days:P.reduce((G,M)=>G+M.value,0)}},[o,c,w,g,y,D,I,P]);return u.useMemo(()=>{const U=[];return y.forEach(O=>{O?.occurred_at&&U.push({id:`history_${O.id}`,timestamp:O.occurred_at,action:"diary_history",details:Do(O.metric_type||"support_note"),diaryId:O.diary_id})}),D.forEach(O=>{O?.recorded_at&&U.push({id:`metric_${O.id}`,timestamp:O.recorded_at,action:"metric_value",details:Do(O.metric_type),diaryId:O.diary_id})}),U.sort((O,$)=>new Date($.timestamp).getTime()-new Date(O.timestamp).getTime()).slice(0,6)},[y,D]),t.jsxs("div",{className:"space-y-8",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsx("h2",{className:"text-2xl font-bold text-gray-800",children:"Мониторинг и статистика"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{type:"button",onClick:()=>a(7),className:`px-3 py-1 rounded-full text-sm border ${s===7?"bg-[#0A6D83] text-white border-[#0A6D83]":"bg-white text-gray-700 border-gray-300"}`,children:"7 дней"}),t.jsx("button",{type:"button",onClick:()=>a(30),className:`px-3 py-1 rounded-full text-sm border ${s===30?"bg-[#0A6D83] text-white border-[#0A6D83]":"bg-white text-gray-700 border-gray-300"}`,children:"30 дней"})]})]}),t.jsx("div",{className:"grid gap-4 sm:grid-cols-2 xl:grid-cols-3",children:[{title:"Активные дневники",value:S.diariesCount},{title:"Карточки подопечных",value:S.cardsCount},{title:"Пользователи и сотрудники",value:S.usersCount},{title:"Организации",value:S.orgCount},{title:"Новых дневников за 7 дней",value:S.created7Days},{title:"Активных дневников за 7 дней",value:S.activeDiaries7Days},{title:"Записей сегодня",value:S.todayEntries}].map(U=>t.jsxs("div",{className:"bg-white border border-gray-200 rounded-3xl p-6 shadow-sm",children:[t.jsx("p",{className:"text-xs uppercase text-gray-400",children:U.title}),t.jsx("p",{className:"text-2xl font-semibold text-[#0A6D83] mt-2",children:U.value})]},U.title))}),t.jsxs("div",{className:"grid gap-4 lg:grid-cols-2",children:[t.jsxs("div",{className:"bg-white border border-gray-200 rounded-3xl p-6 shadow-sm space-y-4",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("h3",{className:"text-lg font-semibold text-gray-800",children:["Новые дневники за ",s," дней"]}),t.jsxs("span",{className:"text-xs text-gray-400",children:["Всего: ",S.created7Days]})]}),t.jsx(zo,{data:I})]}),t.jsxs("div",{className:"bg-white border border-gray-200 rounded-3xl p-6 shadow-sm space-y-4",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("h3",{className:"text-lg font-semibold text-gray-800",children:["Активные дневники за ",s," дней"]}),t.jsxs("span",{className:"text-xs text-gray-400",children:["Всего: ",S.activeDiaries7Days]})]}),t.jsx(zo,{data:P}),t.jsx("p",{className:"text-xs text-gray-500",children:"Учитываются дневники, где за день была внесена минимум одна запись (любой показатель)."})]})]}),t.jsx("div",{className:"grid gap-4 lg:grid-cols-2",children:t.jsxs("div",{className:"bg-white border border-gray-200 rounded-3xl p-6 shadow-sm space-y-3",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Топ неактивных дневников"}),t.jsxs("p",{className:"text-xs text-gray-500",children:["Дневники без записей за последние ",s," дней. Помогает выявлять риски оттока."]}),t.jsx("div",{className:"space-y-2",children:(()=>{const U=Date.now(),O=new Map;y.forEach(k=>{if(!k?.diary_id||!k?.occurred_at)return;const f=new Date(k.occurred_at).getTime(),x=String(k.diary_id);O.set(x,Math.max(O.get(x)||0,f))}),D.forEach(k=>{if(!k?.diary_id||!k?.recorded_at)return;const f=new Date(k.recorded_at).getTime(),x=String(k.diary_id);O.set(x,Math.max(O.get(x)||0,f))});const p=o.map(k=>{const f=O.get(String(k.id))||0,x=k?.created_at?new Date(k.created_at).getTime():0,R=f||x,G=R?Math.floor((U-R)/(1e3*60*60*24)):s+1;return{id:k.id,name:k.name||k.id,lastAt:f?new Date(f):null,daysInactive:G}}).filter(k=>k.daysInactive>=s).sort((k,f)=>f.daysInactive-k.daysInactive).slice(0,8);return p.length===0?t.jsx("p",{className:"text-sm text-gray-500",children:"За выбранный период нет неактивных дневников."}):p.map(k=>{const f=o.find(B=>B.id===k.id)||{},x=g.find(B=>B.id===f.organization_id),R=_.find(B=>B.id===f.client_id),G=n.userProfiles?.find(B=>B.user_id===f.owner_id||B.id===f.user_id),M=x?.name||"Без организации",L=x?.phone||x?.contact_phone||R?.phone||R?.contact_phone||G?.phone||G?.contact_phone||"—";return t.jsx("div",{className:"bg-[#F7FCFD] rounded-2xl px-4 py-3",children:t.jsxs("div",{className:"flex items-center justify-between gap-3",children:[t.jsxs("div",{className:"min-w-0",children:[t.jsx("p",{className:"text-sm text-gray-800 truncate",children:k.name}),t.jsxs("p",{className:"text-xs text-gray-500 truncate",children:["Организация: ",M]}),t.jsxs("p",{className:"text-xs text-gray-500",children:["Телефон: ",L]}),t.jsxs("p",{className:"text-xs text-gray-500",children:["Последняя активность: ",k.lastAt?k.lastAt.toLocaleDateString("ru-RU"):"не было"]})]}),t.jsxs("span",{className:"shrink-0 text-xs font-semibold text-[#8A3A0A] bg-[#FDF3E7] px-3 py-1 rounded-full",children:[k.daysInactive," дн. без записей"]})]})},k.id)})})()})]})})]})},up=()=>t.jsx(pt,{children:t.jsx(ld,{})}),mp=()=>t.jsx(pt,{children:t.jsx(ng,{})}),hp=()=>t.jsx(pt,{children:t.jsx(dg,{})}),fp=()=>t.jsx(pt,{children:t.jsx(xg,{})}),gp=()=>t.jsx(pt,{children:t.jsx(yg,{})}),pp=()=>t.jsx(pt,{children:t.jsx(_g,{})}),xp=()=>t.jsx(pt,{children:t.jsx(vg,{})});function yp(){return t.jsxs(uc,{children:[t.jsx(Te,{path:"/",element:t.jsx(dd,{})}),t.jsxs(Te,{element:t.jsx(od,{}),children:[t.jsx(Te,{path:"/login",element:t.jsx(qf,{})}),t.jsx(Te,{path:"/register",element:t.jsx(Zf,{})}),t.jsx(Te,{path:"/email-confirmation",element:t.jsx(Qf,{})}),t.jsx(Te,{path:"/client-invite",element:t.jsx(Jg,{})})]}),t.jsx(Te,{element:t.jsx(up,{}),children:t.jsx(Te,{path:"/profile/setup",element:t.jsx(ag,{})})}),t.jsx(Te,{path:"/dashboard",element:t.jsx(pt,{children:t.jsx(fg,{})})}),t.jsx(Te,{path:"/profile",element:t.jsx(mp,{})}),t.jsx(Te,{path:"/profile/edit",element:t.jsx(hp,{})}),t.jsx(Te,{path:"/profile/employees",element:t.jsx(fp,{})}),t.jsx(Te,{path:"/profile/patient-cards",element:t.jsx(gp,{})}),t.jsx(Te,{path:"/profile/patient-cards/new",element:t.jsx(pt,{children:t.jsx(La,{})})}),t.jsx(Te,{path:"/profile/patient-cards/edit",element:t.jsx(pt,{children:t.jsx(La,{})})}),t.jsx(Te,{path:"/profile/patient-cards/view",element:t.jsx(pt,{children:t.jsx(La,{})})}),t.jsx(Te,{path:"/profile/clients",element:t.jsx(pp,{})}),t.jsx(Te,{path:"/profile/invite-client",element:t.jsx(xp,{})}),t.jsx(Te,{path:"/diaries/new",element:t.jsx(pt,{children:t.jsx(jg,{})})}),t.jsx(Te,{path:"/diaries/:id",element:t.jsx(pt,{children:t.jsx(Og,{})})}),t.jsx(Te,{path:"/diaries/:id/edit-metrics",element:t.jsx(pt,{children:t.jsx(Wg,{})})}),t.jsxs(Te,{path:"/admin",element:t.jsx(Kg,{}),children:[t.jsx(Te,{index:!0,element:t.jsx(Gg,{})}),t.jsx(Te,{path:"invites",element:t.jsx(tp,{})}),t.jsx(Te,{path:"users",element:t.jsx(sp,{})}),t.jsx(Te,{path:"support",element:t.jsx(lp,{})}),t.jsx(Te,{path:"monitoring",element:t.jsx(dp,{})}),t.jsx(Te,{path:"*",element:t.jsx(Po,{to:"/admin",replace:!0})})]})]})}const bp=new Bc;xc.createRoot(document.getElementById("root")).render(t.jsx(tt.StrictMode,{children:t.jsx(mc,{children:t.jsx(Uc,{client:bp,children:t.jsx(yp,{})})})}));
